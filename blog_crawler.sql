/*
 Navicat Premium Data Transfer

 Source Server         : 127.0.0.1-3306
 Source Server Type    : MySQL
 Source Server Version : 50623
 Source Host           : localhost:3306
 Source Schema         : blog_crawler

 Target Server Type    : MySQL
 Target Server Version : 50623
 File Encoding         : 65001

 Date: 27/03/2021 11:28:37
*/

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for t_blog
-- ----------------------------
DROP TABLE IF EXISTS `t_blog`;
CREATE TABLE `t_blog`  (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `title` varchar(200) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT '博客标题',
  `content` longtext CHARACTER SET utf8 COLLATE utf8_general_ci COMMENT '博客内容',
  `summary` varchar(400) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT '摘要',
  `crawler_date` datetime(0) DEFAULT NULL COMMENT '爬取时间',
  `click_hit` int(11) DEFAULT NULL COMMENT '点击次数',
  `type_id` int(11) DEFAULT NULL COMMENT '类型id',
  `tags` varchar(200) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT '关键字',
  `or_url` varchar(1000) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT '原文地址',
  `state` int(11) DEFAULT NULL COMMENT '发布状态',
  `release_date` datetime(0) DEFAULT NULL COMMENT '发布时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 297 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- Records of t_blog
-- ----------------------------
INSERT INTO `t_blog` VALUES (229, 'Springboot + Mysql8实现读写分离', '<p>在实际的生产环境中，为了确保数据库的稳定性，我们一般会给数据库配置双机热备机制，这样在master数据库崩溃后，slave数据库可以立即切换成主数据库，通过主从复制的方式将数据从主库同步至从库，在业务代码中编写代码实现读写分离（让主数据库处理 事务性增、改、删操作，而从数据库处理查询操作）来提升数据库的并发负载能力。<br> <img src=\"http://localhost:9090/blogImages/2019/10/11/044aaff0-b8a2-4815-9264-6bf8418e84cc.jpeg\" alt=\"file\"></p> \n<p>下面我们使用最新版本的Mysql数据库（8.0.16）结合SpringBoot实现这一完整步骤（一主一从）。</p> \n<h2 id=\"安装配置mysql\">安装配置mysql</h2> \n<ul> \n <li><p>从 <code>https://dev.mysql.com/downloads/mysql/</code>页面下载mysql安装包，我这里下载的是mysql8.0.16 Linux-Generic.</p></li> \n <li>准备两台虚拟机用作安装mysql，并将下载后的文件<code>mysql-8.0.16-linux-glibc2.12-x86_64.tar.xz</code>上传至服务器/app/mysql \n  <ul> \n   <li>192.168.249.131 CENTOS7 主</li> \n   <li>192.168.249.129 CENTOS7 从</li> \n  </ul></li> \n <li>查看防火墙状态，如果启动需要先关闭防火墙</li> \n</ul> \n<pre><code>service firewalld status  ## 查看防火墙状态\nservice firewalld stop   ## 关闭防火墙</code></pre> \n<ul> \n <li><p>使用如下命令将xz文件解压成tar文件<br> <code>xz -d mysql-8.0.16-linux-glibc2.12-x86_64.tar.xz</code></p></li> \n <li><p>解压安装包<br> <code>tar -xvf mysql-8.0.16-linux-gl-ibc2.12-x86_64.tar</code></p></li> \n <li><p>在/app/mysql下建立data文件夹，用于存放数据</p></li> \n <li>创建mysql用户组和mysql用户</li> \n</ul> \n<pre><code>groupadd mysql                                  ## 创建用户组\nuseradd -g mysql -d /app/mysql mysql    ## 在用户组下创建mysql用户并授权相关目录\ngroupdel mysql&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         ## 删除用户组名（若报已存在相关用户组）\nuserdel mysql&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                         ## 删除用户（若报已存在相关用户）</code></pre> \n<ul> \n <li><p>初始化安装mysql数据库<br> <code>./mysql-8.0.16-linux-glibc2.12-x86_64/bin/mysqld --user=mysql --basedir=/app/mysql --datadir=/app/mysql/data --initialize</code></p> <pre><code>2019-07-01T02:05:52.681626Z 0 [Warning] [MY-011070] [Server] \'Disabling symbolic links using --skip-symbolic-links (or equivalent) is the default. Consider not using this option as it\' is deprecated and will be removed in a future release.\n2019-07-01T02:05:52.681694Z 0 [System] [MY-013169] [Server] /app/mysql/mysql-8.0.16-linux-glibc2.12-x86_64/bin/mysqld (mysqld 8.0.16) initializing of server in progress as process 1479\n2019-07-01T02:05:52.681726Z 0 [ERROR] [MY-010338] [Server] Can\'t find error-message file \'/app/mysql/share/errmsg.sys\'. Check error-message file location and \'lc-messages-dir\' configuration directive.\n2019-07-01T02:05:55.713747Z 5 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: xa6(H&gt;rK/r&lt;E\n2019-07-01T02:05:57.303240Z 0 [System] [MY-013170] [Server] /app/mysql/mysql-8.0.16-linux-glibc2.12-x86_64/bin/mysqld (mysqld 8.0.16) initializing of server has completed</code></pre> <p><strong><em>注意，此时mysql会生成一个默认的临时密码，如上所示，需要先保存下来然后修改</em></strong></p></li> \n <li><p>建立mysql服务并增加执行权限<br> <code>cp mysql-8.0.16-linux-glibc2.12-x86_64/support-files/mysql.server /etc/init.d/mysqld</code></p></li> \n <li><p>修改mysql配置文件 vi /etc/my.cnf 增加如下配置</p> <pre><code>[mysqld]\nport=3306\nbasedir=/app/mysql/mysql-8.0.16-linux-glibc2.12-x86_64\ndatadir=/app/mysql/data\nsocket=/tmp/mysql.sock\nsymbolic-links=0\n\n[mysqld_safe]\nlog-error=/app/mysql/data/log/error.log\npid-file=/app/mysql/data/mysql.pid\nuser=mysql\ntmpdir=/tmp\ncharacter_set_server=utf8\ndefault-storage-engine=INNODB\ninit_connect=\'SET NAMES utf8\'\n\n!includedir /etc/my.cnf.d</code></pre> <p><strong><em>如果报日志权限相关错误，请先建立对应日志文件，并给mysql用户授权</em></strong><br> <code>chown -R mysql:mysql /app/mysql/data/log/error.log</code></p></li> \n <li><p>启动mysql服务<br> <code>service mysqld start</code></p></li> \n <li><p>建立mysql客户端软连接<br> <code>ln -s /app/mysql/mysql-8.0.16-linux-glibc2.12-x86_64/bin/mysql /usr/local/bin/mysql</code></p></li> \n <li>登录mysql修改密码</li> \n</ul> \n<pre><code>mysql -uroot -p密码       ## 登录 \nALTER USER \'root\'@\'localhost\' IDENTIFIED WITH mysql_native_password BY \'000000\';</code></pre> \n<ul> \n <li>设置远程登录</li> \n</ul> \n<pre class=\"sql\"><code>use mysql;\nupdate user set host=\'%\' where user=\'root\' limit 1;\nflush privileges;</code></pre> \n<h2 id=\"配置mysql主从同步binlog\">配置mysql主从同步（binlog）</h2> \n<h3 id=\"复制原理\">复制原理</h3> \n<ul> \n <li>Master将数据改变记录到二进制日志(binary log)中，也就是配置文件log-bin指定的文件，这些记录叫做二进制日志事件(binary log events)&nbsp;</li> \n <li>Slave通过I/O线程读取Master中的binary log events并写入到它的中继日志(relay log)&nbsp;</li> \n <li>Slave重做中继日志中的事件，把中继日志中的事件信息一条一条的在本地执行一次，完成数据在本地的存储，从而实现将改变反映到它自己的数据(数据重放)</li> \n</ul> \n<h3 id=\"复制要求\">复制要求</h3> \n<ul> \n <li>主从服务器操作系统版本和位数一致&nbsp;</li> \n <li>Master和Slave数据库的版本要一致&nbsp;</li> \n <li>Master和Slave数据库中的数据要一致&nbsp;</li> \n <li>Master开启二进制日志，Master和Slave的server_id在局域网内必须唯一</li> \n</ul> \n<h3 id=\"配置步骤\">配置步骤</h3> \n<h4 id=\"主数据库192.168.249.131\">主数据库（192.168.249.131）</h4> \n<ul> \n <li>创建同步用户并授权</li> \n</ul> \n<pre><code>CREATE USER \'slave\'@\'192.168.249.129\' IDENTIFIED WITH \'mysql_native_password\' BY \'000000\';\nGRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO \'slave\'@\'192.168.249.129\';\nFLUSH PRIVILEGES;</code></pre> \n<p><strong>注意这里创建用户时需要选用<code>mysql_native_password</code>加密方式插件，否则默认会使用<code>caching_sha2_password</code>加密方式，这样在同步的时候需要使用SSL的身份进行验证，为了方便简单，我们直接采用<code>mysql_native_password</code>方式</strong></p> \n<ul> \n <li><p>修改配置/etc/my.cnf，新增如下配置，开启binlog,并重启mysql服务<br> <code>[mysqld] # 开启二进制日志功能 log-bin=mysql-bin # 设置server_id，,注意在网段内要唯一 server-id=131 #(可选配置）要同步的数据库名，要同步多个数据库，就多加几个replicate-db-db=数据库名 binlog-do-db=mydb #（可选配置）要忽略的数据库 binlog-ignore-db=mysql</code></p></li> \n <li><p>查看主服务器状态<br> <code>show master status</code><br> <img src=\"http://localhost:9090/blogImages/2019/10/11/66e0da7f-ef30-4b47-ac85-5526d3aef3a1.jpeg\" alt=\"file\"></p></li> \n</ul> \n<p><strong>注意看里面的参数，特别前面两个File和Position，在从服务器（Slave）配置主从关系会有用到的。</strong></p> \n<h4 id=\"从数据库192.168.249.129\">从数据库（192.168.249.129）</h4> \n<ul> \n <li>修改/etc/my.cnf，新增如下配置,并重启服务</li> \n</ul> \n<pre class=\"properties\"><code>[mysqld]\nserver-id=129\nlog-bin=mysql-bin\nreplicate-do-db=mydb\nreplicate-ignore-db=mysql</code></pre> \n<ul> \n <li>在slave中设置master信息，指定同步位置</li> \n</ul> \n<pre><code>stop slave;\nchange master to master_host=\'192.168.249.131\',master_user=\'slave\',master_password=\'000000\',master_log_file=\'mysql-bin.000001\',master_log_pos=155;\nstart slave;</code></pre> \n<p>参数说明：<br> master_host=\'192.168.249.131\' ## Master的IP地址<br> master_user=\'slave\' ## 用于同步数据的用户（在Master中授权的用户）<br> master_password=\'000000\' ## 同步数据用户的密码<br> master_port=3306 ## Master数据库服务的端口<br> masterlogfile=\'mysql-bin.000001\' ##指定Slave从哪个日志文件开始读复制数据（Master上执行命令的结果的File字段）<br> masterlogpos=155 ## 从哪个POSITION号开始读（Master上执行命令的结果的Position字段）<br> masterconnectretry=30 ##当重新建立主从连接时，如果连接建立失败，间隔多久后重试。单位为秒，默认设置为60秒，同步延迟调优参数。</p> \n<ul> \n <li><p>查看从服务器状态<br> <code>show slave status\\G;</code></p> <p><img src=\"http://localhost:9090/blogImages/2019/10/11/5370ea1d-1603-4d73-8e3f-a96527ec6550.jpeg\" alt=\"file\"></p></li> \n</ul> \n<p>至此数据库层面主从配置完成。</p> \n<p>## SpringBoot中配置主从读写分离<br> 在主从模式下请遵守如下规则：<br> 主数据库 只执行 <code>INSERT</code>,<code>UPDATE</code>,<code>DELETE</code> 操作<br> 从数据库 只执行<code>SELECT</code>操作</p> \n<pre><code>我们这里使用开源项目[dynamic-datasource-spring-boot-starter](https://gitee.com/baomidou/dynamic-datasource-spring-boot-starter/wikis/)作为读写分离的工具包</code></pre> \n<p>### 使用方法</p> \n<ol> \n <li>在mydb主数据库中建立一个简单数据表user，建好后从数据库会自动同步</li> \n</ol> \n<pre><code>DROP TABLE IF EXISTS `user`;\nCREATE TABLE `user` (\n`id` int(11) NOT NULL AUTO_INCREMENT,\n`account` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,\n`name` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,\n`position` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,\nPRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;</code></pre> \n<ol> \n <li>引入相关依赖</li> \n</ol> \n<pre><code>&lt;dependencies&gt;\n       &lt;dependency&gt;\n           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n           &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;\n       &lt;/dependency&gt;\n\n       &lt;dependency&gt;\n           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n           &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n       &lt;/dependency&gt;\n\n       &lt;dependency&gt;\n           &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;\n           &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;\n           &lt;version&gt;2.0.1&lt;/version&gt;\n       &lt;/dependency&gt;\n\n       &lt;dependency&gt;\n           &lt;groupId&gt;com.baomidou&lt;/groupId&gt;\n           &lt;artifactId&gt;dynamic-datasource-spring-boot-starter&lt;/artifactId&gt;\n           &lt;version&gt;2.5.5&lt;/version&gt;\n       &lt;/dependency&gt;\n\n       &lt;dependency&gt;\n           &lt;groupId&gt;mysql&lt;/groupId&gt;\n           &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;\n           &lt;version&gt;8.0.15&lt;/version&gt;\n       &lt;/dependency&gt;\n\n       &lt;dependency&gt;\n           &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n           &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n           &lt;optional&gt;true&lt;/optional&gt;\n       &lt;/dependency&gt;\n\n       &lt;dependency&gt;\n           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n           &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n           &lt;scope&gt;test&lt;/scope&gt;\n       &lt;/dependency&gt;\n\n   &lt;/dependencies&gt;</code></pre> \n<ol> \n <li>配置数据源</li> \n</ol> \n<pre><code>spring:\n  datasource:\n    dynamic:\n      primary: master #设置默认的数据源或者数据源组,默认值即为master\n      strict: false #设置严格模式,默认false不启动. 启动后再为匹配到指定数据源时候回抛出异常,不启动会使用默认数据源.\n      datasource:\n        master:\n          type: com.zaxxer.hikari.HikariDataSource\n          url: jdbc:mysql://192.168.249.131:3306/mydb?characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false\n          username: root\n          password: \'000000\'\n          driver-class-name: com.mysql.cj.jdbc.Driver\n        slave_1:\n          type: com.zaxxer.hikari.HikariDataSource\n          url: jdbc:mysql://192.168.249.129:3306/mydb?characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false\n          username: root\n          password: \'000000\'\n          driver-class-name: com.mysql.cj.jdbc.Driver</code></pre> \n<ol> \n <li>在启动类入口加入mybatis扫描包</li> \n</ol> \n<pre><code>@SpringBootApplication@MapperScan(\"com.jianzh5.dynamic.mapper\")\npublic class DynamicDatsourceBootstrap {&nbsp;&nbsp;&nbsp; \n    public static void main(String[] args) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \n        SpringApplication.run(DynamicDatsourceBootstrap.class, args);\n    }\n}</code></pre> \n<ol> \n <li>建立实体类User</li> \n</ol> \n<pre><code>@Data\npublic class User {\n    private int id;\n    private String account;\n    private String name;\n    private String position;\n}</code></pre> \n<ol> \n <li>建立mapper接口文件，新增两个方法<code>addUser(User user)</code>,<code>getById(int id)</code></li> \n</ol> \n<pre><code>public interface UserDao {\n    @Insert(\"INSERT INTO user(account, name, position) VALUES(#{account}, #{name}, #{position})\")\n    @Options(useGeneratedKeys = true,keyProperty = \"id\")\n    int addUser(User user);\n\n    @Select(\"SELECT * FROM user WHERE id = #{id}\")\n    User getById(int id);\n}</code></pre> \n<ol> \n <li>建立Service服务层相关实现</li> \n</ol> \n<pre><code>public interface UserService {\n        int addUser(User user);\n        User getById(int id);\n}\n@Service\npublic class UserServiceImpl implements UserService {\n        @Resource\n        private UserDao userDao;\n\n        @Override\n        public int addUser(User user) {\n            return userDao.addUser(user);\n        }\n        @DS(\"slave\")\n        @Override\n        public User getById(int id) {\n            return userDao.getById(id);\n        }\n}</code></pre> \n<p>由于在数据源中配置了<code>primary: master</code>,默认操作都会从主库执行，使用注解<code>@DS</code>切换数据源，此注解也可直接用于类文件上，同时存在方法注解优先于类上注解。</p> \n<ol> \n <li>编写单元测试进行测试</li> \n</ol> \n<pre><code>```\npublic class UserServiceTest extends DynamicDatsourceBootstrapTests {\n    @Autowired\n    private UserService userService;\n    @Test\n    public void testAddUser(){\n        User user = new User();\n        user.setName(\"李四\");\n        user.setAccount(\"sili\");\n        user.setPosition(\"JAVA开发工程师\");\n        int i = userService.addUser(user);\n        System.out.println(user);\n    }\n    @Test\n    public void testGetById(){\n        int id = 4;\n        User user = userService.getById(id);\n        Assert.assertEquals(\"sanzhang\",user.getAccount());\n    }\n}\n```</code></pre> \n<ol> \n <li><p>通过观察执行日志，发现读写数据库会根据@DS注解进行切换，至此Springboot集成数据库主从读写分离完成。</p> \n  <blockquote> \n   <p>本文由博客一文多发平台 <a href=\"https://openwrite.cn\">OpenWrite</a> 发布！</p> \n  </blockquote></li> \n</ol>', '在实际的生产环境中，为了确保数据库的稳定性，我们一般会给数据库配置双机热备机制，这样在master数据库崩溃后，slave数据库可以立即切换成主数据库，通过主从复制的方式将数据从主库同步至从库，在业务代码中编写代码实现读写分离（让主数据库处理 事务性增、改、删操作，而从数据库处理查询操作）来提升数据库的并发负', '2019-10-11 15:25:02', 7, 1, 'springboot mysql 读写分离', 'https://www.cnblogs.com/jianzh5/p/11654501.html', 1, '2019-10-17 17:09:59');
INSERT INTO `t_blog` VALUES (230, 'Android资源管理利器Resources和AssetManager', '<p><strong><span style=\"font-size: 16px;\">前言</span></strong>&nbsp; ：</p> \n<p>&nbsp; &nbsp; &nbsp; &nbsp;Android工程在运行的时候往往需要引用资源。使用&nbsp;<code>Resources</code>&nbsp;来获取&nbsp;<code>res</code>&nbsp;目录下的各种与设备相关的资源。而使用&nbsp;<code>AssetManager</code>&nbsp;来获取&nbsp;<code>assets</code>&nbsp;目录下的资源。</p> \n<p>&nbsp; &nbsp; &nbsp; <span style=\"color: #333333;\">&nbsp;资源包括系统资源、工程资源、第三方资源、插件资源等，分为两类：</span></p> \n<ul> \n <li>&nbsp; &nbsp; &nbsp; &nbsp;res目录下存放的可编译的资源文件，编译时，系统会自动在R.java中生成资源文件的ID，所以访问这种资源比较简单，通过在程序中调用R.id.filenam &nbsp;e即可。 &nbsp; &nbsp;</li> \n <li>&nbsp; &nbsp; &nbsp; &nbsp;assets目录下存放的原始资源文件，因为系统在编译的时候不会编译assets下的资源文件，所以我们不能通过R.id.filename的方式访问它们。那我么能不能通过该资源的绝对路径去访问它们呢？因为apk安装之后会放在/data/app/**.apk目录下，assets被绑定在apk里，以apk形式存在，并不会解压到/data/data/YourApp目录下去，所以我们无法直接获取到assets的绝对路径，因为它们根本就没有独立存在</li> \n</ul> \n<p><em><strong>&nbsp;res/raw和assets的相同点：</strong> &nbsp;</em><br><em>&nbsp; &nbsp; 1.两者目录下的文件在打包后会原封不动的保存在apk包中，不会被编译成二进制。</em><br><br><em><strong>res/raw和assets的不同点：</strong> &nbsp;&nbsp;</em><br><em>&nbsp; &nbsp;1.res/raw中的文件会被映射到R.java文件中，访问的时候直接使用资源ID即R.id.filename；&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assets文件夹下的文件不会被映射到R.java中，访问的时候需要AssetManager类。 &nbsp; &nbsp;</em><br><em>&nbsp; &nbsp;2.res/raw不可以有目录结构，而assets则可以有目录结构（在其目录下可以再建文件夹） &nbsp;&nbsp;</em><br><em>&nbsp; &nbsp;3.读取res/raw下的文件资源，通过以下方式获取输入流：</em></p> \n<p><em>&nbsp; &nbsp; &nbsp; InputStream is=getResources().openRawResource(R.id.filename);</em></p> \n<p><em>&nbsp; &nbsp; &nbsp; 读取assets下的文件资源，通过以下方式获取输入流：</em></p> \n<p><em>&nbsp; &nbsp; &nbsp; InputStream is =getResources()..getAssets().open(\"filename\");&nbsp;&nbsp;</em></p> \n<p>&nbsp;</p> \n<p>&nbsp; &nbsp; &nbsp; &nbsp;不管是什么样的资源，最终都能通过一个入口来获取，而这个入口就是Resources对象。Resources对象描述了android资源文件，例如android工程下的res、asset目录等除了.class文件的资源，我们可以认为，所有涉及到获取资源的地方，都可以使用Resources来获取。事实上我们在代码中读取asset目录下的资源时常常直接使用Assetmanager来直接获取对象的流数据，而AssetManager也是属于Resources对象的一个属性，都同时指向相同的对象。</p> \n<p>&nbsp;</p> \n<p><strong><span style=\"font-size: 16px;\">Resources解析：</span></strong></p> \n<p>1.Resources对象的几个重要成员属性：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">static</span> Resources mSystem = <span style=\"color: #0000ff;\">null</span>; <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> mSystem为一个静态的对象，代表了系统默认的资源管理。</span>\n<span style=\"color: #0000ff;\">final</span> Object mAccessLock = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Object();\n</span><span style=\"color: #0000ff;\">final</span> Configuration mTmpConfig = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Configuration();\nTypedValue mTmpValue </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> TypedValue();\n</span><span style=\"color: #0000ff;\">final</span> AssetManager mAssets; <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> mAssets指向了系统默认的实例，mAsset的创建初始化过程是在C++层做的。</span>\n<span style=\"color: #0000ff;\">private</span> <span style=\"color: #0000ff;\">final</span> Configuration mConfiguration = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Configuration();\n</span><span style=\"color: #0000ff;\">final</span> DisplayMetrics mMetrics = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> DisplayMetrics();\n</span><span style=\"color: #0000ff;\">private</span> NativePluralRules mPluralRule;</pre> \n</div> \n<p>&nbsp;</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\"> 1</span> <span style=\"color: #0000ff;\">private</span><span style=\"color: #000000;\"> Resources() {\n</span><span style=\"color: #008080;\"> 2</span>         mAssets =<span style=\"color: #000000;\"> AssetManager.getSystem();\n</span><span style=\"color: #008080;\"> 3</span>         <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> NOTE: Intentionally leaving this uninitialized (all values set\n</span><span style=\"color: #008080;\"> 4</span>         <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> to zero), so that anyone who tries to do something that requires\n</span><span style=\"color: #008080;\"> 5</span>         <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> metrics will get a very wrong value.</span>\n<span style=\"color: #008080;\"> 6</span> <span style=\"color: #000000;\">        mConfiguration.setToDefaults();\n</span><span style=\"color: #008080;\"> 7</span> <span style=\"color: #000000;\">        mMetrics.setToDefaults();\n</span><span style=\"color: #008080;\"> 8</span>         updateConfiguration(<span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\"> 9</span> <span style=\"color: #000000;\">        mAssets.ensureStringBlocks();\n</span><span style=\"color: #008080;\">10</span>     }</pre> \n</div> \n<p>&nbsp; &nbsp; &nbsp; &nbsp;我们在开发自己的应用时，是把自己需要的资源都放置到工程目录下的res文件夹下和asset文件夹下。当编译工程的时候，资源和源文件都将会打包到apk里面。运行应用的时候，Resources中AssetManager的路径默认指向了该apk的文件，如果是普通应用，一般apk文件被放置在data/app目录下，系统应用的apk包放在system/app下。</p> \n<p>&nbsp; &nbsp; &nbsp; <span style=\"color: #333333;\"><em>&nbsp;</em>所以在启动应用的时候，Resources通过Assetmanager，AssetManager再根据设定的路径查找apk中的资源，就可以正确的找到自己的资源了。</span></p> \n<p>&nbsp; &nbsp; &nbsp; &nbsp; 既然AssetManager获取资源是根据指向的路径来完成，<span style=\"color: #ff6600;\">理论上我们改变AssetManager读取的路径，就可以指定加载自己的资源</span>，事实上也是这样设计的。所以如果我们让AssetManager指向自己设定的Apk资源路径，就可以完成提取apk资源的目的了。&nbsp; &nbsp;一些动态主题包的实现原理主要是通过<span style=\"color: #ff6600;\"><code>AssetsManager.addAssetPath(String path)</code></span>&nbsp;这一接口来创建对应主题包的&nbsp;<code>Resources</code>&nbsp;对象来实现的。</p> \n<p><em id=\"__mceDel\">&nbsp;</em></p> \n<p><strong><span style=\"font-size: 16px;\">Demo：</span></strong></p> \n<p><span style=\"font-size: 14px;\">新建一个用于管理资源的类ResourcesManager，其中包含的重要属性与方法：</span></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\"> 1</span>     AssetManager mAssetManager = <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\"> 2</span>     Resources mResources = <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\"> 3</span>     LayoutInflater mLayoutInflater = <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\"> 4</span>     Theme mTheme = <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\"> 5</span>     ClassLoader mClassLoader = <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\"> 6</span>     //ResApk.apk  资源文件\n<span style=\"color: #008080;\"> 7</span>     String packageName = \"com.example.testapk\"<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\"> 8</span>     String libPath =<span style=\"color: #000000;\"> Environment.getExternalStorageDirectory().toString()\n</span><span style=\"color: #008080;\"> 9</span>             + File.separator + \"ResApk.apk\"<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">10</span>  \n<span style=\"color: #008080;\">11</span>     <span style=\"color: #0000ff;\">protected</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> initAssetManager() {\n</span><span style=\"color: #008080;\">12</span>         <span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\n</span><span style=\"color: #008080;\">13</span>             AssetManager assetManager = AssetManager.<span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\">.newInstance();\n</span><span style=\"color: #008080;\">14</span>             Method addAssetPath =<span style=\"color: #000000;\"> assetManager.getClass().getMethod(\n</span><span style=\"color: #008080;\">15</span>                     \"addAssetPath\", String.<span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\">16</span> <span style=\"color: #000000;\">            addAssetPath.invoke(assetManager, libPath);\n</span><span style=\"color: #008080;\">17</span>             mAssetManager =<span style=\"color: #000000;\"> assetManager;\n</span><span style=\"color: #008080;\">18</span>         } <span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\"> (Exception e) {\n</span><span style=\"color: #008080;\">19</span> <span style=\"color: #000000;\">            e.printStackTrace();\n</span><span style=\"color: #008080;\">20</span> <span style=\"color: #000000;\">        }\n</span><span style=\"color: #008080;\">21</span>         Resources superRes = <span style=\"color: #0000ff;\">super</span><span style=\"color: #000000;\">.getResources();\n</span><span style=\"color: #008080;\">22</span>         mResources = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Resources(mAssetManager, superRes.getDisplayMetrics(),\n</span><span style=\"color: #008080;\">23</span> <span style=\"color: #000000;\">                superRes.getConfiguration());\n</span><span style=\"color: #008080;\">24</span>     }</pre> \n</div> \n<p>mResources就指向了ResApk.apk里面的资源，通过名字就可以取得对应资源。</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\"> 1</span> <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> getDrawableId(String imgName) {\n</span><span style=\"color: #008080;\"> 2</span>         <span style=\"color: #0000ff;\">return</span> mResources.getIdentifier(imgName, \"drawable\"<span style=\"color: #000000;\">, apkPackageName);\n</span><span style=\"color: #008080;\"> 3</span> <span style=\"color: #000000;\">    }\n</span><span style=\"color: #008080;\"> 4</span>  \n<span style=\"color: #008080;\"> 5</span>     <span style=\"color: #008000;\">/**</span>\n<span style=\"color: #008080;\"> 6</span> <span style=\"color: #008000;\">     * 获取图片资源\n</span><span style=\"color: #008080;\"> 7</span> <span style=\"color: #008000;\">     * \n</span><span style=\"color: #008080;\"> 8</span> <span style=\"color: #008000;\">     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> imgName\n</span><span style=\"color: #008080;\"> 9</span> <span style=\"color: #008000;\">     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\"> drawable\n</span><span style=\"color: #008080;\">10</span>      <span style=\"color: #008000;\">*/</span>\n<span style=\"color: #008080;\">11</span>     <span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> Drawable getResApkDrawable(String imgName) {\n</span><span style=\"color: #008080;\">12</span>         <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> mResources.getDrawable(getDrawableId(imgName));\n</span><span style=\"color: #008080;\">13</span>     }</pre> \n</div> \n<p><span style=\"color: #ff6600;\">特别需要注意的是，由于每个应用的上下文对象都是不一样的，要始终记住，如果使用的不是自己资源文件，要慎用与上下文有关的功能方法。</span></p> \n<p>&nbsp; &nbsp; &nbsp;原文参考博客链接：<a href=\"https://blog.csdn.net/MeteorLuoyidong/article/details/49530839\">https://blog.csdn.net/MeteorLuoyidong/article/details/49530839</a></p> \n<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href=\"https://www.cnblogs.com/jpfss/p/9876370.html\">https://www.cnblogs.com/jpfss/p/9876370.html</a></p> \n<p>&nbsp;</p>', '前言  ： \n       Android工程在运行的时候往往需要引用资源。使用 Resources 来获取 res 目录下的各种与设备相关的资源。而使用 AssetManager 来获取 assets 目录下的资源。 \n       资源包括系统资源、工程资源、第三方资源、插件资源等，分为两类： \n \n  ', '2019-10-11 15:25:02', 4, 4, '', 'https://www.cnblogs.com/jiani/p/11654487.html', 0, NULL);
INSERT INTO `t_blog` VALUES (231, 'CSS 预处理语言之 Scss 篇', '<h3 id=\"简介\">简介</h3> \n<h4 id=\"sass-和-scss\">1. Sass 和 Scss</h4> \n<blockquote> \n <p>Sass 和 Scss 其实是同一种东西，我们平时都称之为 Sass；Scss 是 Sass 3 引入新的语法，其语法完全兼容 CSS3，并且继承了 Sass 的强大功能。也就是说，任何标准的 CSS3 样式表都是具有相同语义的有效的 Scss文件。</p> \n <p>两者之间不同之处有以下两点：</p> \n <ol> \n  <li>文件<strong>扩展名</strong>不同，Sass 是以“.sass”后缀为扩展名，而 Scss 是以“.scss”后缀为扩展名</li> \n  <li>语法书写方式不同，Sass 是以<strong>严格的缩进式</strong>语法规则来书写，<strong>不带大括号({})和分号(;)</strong>，而 SCSS 的语法书写和我们的 CSS 语法书写方式非常类似。</li> \n </ol> \n</blockquote> \n<p>示例:</p> \n<pre class=\"scss\"><code>// Sass 语法\n$w:200px; //定义变量\n$h:300px; //定义变量\nbody\n    width:$w;\n    height:$h;</code></pre> \n<pre class=\"scss\"><code>// Scss 语法\n$w:200px;\n$h:300px;\nbody{\n    width:$w;\n    height:$h;\n}</code></pre> \n<pre class=\"css\"><code>/* 编译出来的css*/\nbody{\n    width:200px;\n    height:300px;\n}</code></pre> \n<h4 id=\"sassscss-和-css\">2. Sass/Scss 和 Css</h4> \n<ul> \n <li><p>Sass 和 Css</p> \n  <blockquote> \n   <p>Sass 和 CSS 写法的确存在一定的差异，由于 Sass 是基于 Ruby 写出来，所以其延续了 Ruby 的书写规范。在书写 Sass 时<strong>不带有大括号和分号</strong>，其主要是依靠<strong>严格的缩进方式</strong>来控制的。</p> \n  </blockquote></li> \n <li><p>Scss 和 Css</p> \n  <blockquote> \n   <p>SCSS 和 CSS 写法无差别，这也是 Sass 后来越来越受大众喜欢原因之一。简单点说，把你现有的“.css”文件直接修改成“.scss”即可使用。</p> \n  </blockquote></li> \n</ul> \n<h3 id=\"安装\">安装</h3> \n<h4 id=\"mac-系统\">Mac 系统</h4> \n<h5 id=\"ruby-安装\">1. Ruby 安装</h5> \n<blockquote> \n <p>确认是否安装了Ruby，打开终端，输入 <code>ruby -v</code> .</p> \n</blockquote> \n<ul> \n <li>有 ruby 信息 -- 已安装 .</li> \n <li><p>没有 ruby 信息，使用 <code>brew install ruby</code> 安装 ruby .</p> <p>链接： <a href=\"https://www.ruby-lang.org/zh_cn/documentation/installation/#rubyinstaller\">安装 Ruby</a> .</p></li> \n</ul> \n<h5 id=\"sass-安装\">2. Sass 安装</h5> \n<blockquote> \n <p>使用 <code>sass -v</code> 查看 sass 版本号，检查是否安装了 sass .</p> \n</blockquote> \n<ul> \n <li><p>在线安装</p> \n  <ul> \n   <li>使用 <code>sudo gem install sass</code> 进行安装 sass .</li> \n  </ul></li> \n <li><p>本地安装</p> \n  <blockquote> \n   <p>由于有时候直接使用上面的命令安装会让你无法正常实现安装（网络受限原因），当碰到这种情况之时，那么安装需要特殊去处理，可以通过下面的方法来实现 Sass 的正常安装：</p> \n  </blockquote> \n  <ul> \n   <li>下载 sass 文件，链接： <a href=\"https://rubygems.org/gems/sass\">Sass 下载</a> .</li> \n  </ul></li> \n</ul> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/232b0a87-545a-46ab-9bd6-abda90e7f4e5.png\" alt=\"sass\"></p> \n<ul> \n <li><p>使用 <code>sudo gem install XXX/sass-3.7.4.gem</code> 进行安装 sass .</p> \n  <blockquote> \n   <p>XXX ：下载的 sass 文件路径。</p> \n  </blockquote></li> \n</ul> \n<h4 id=\"windows-系统\">Windows 系统</h4> \n<h5 id=\"ruby-安装-1\">1. Ruby 安装</h5> \n<ul> \n <li><p>下载 Ruby 安装包，链接： <a href=\"http://rubyinstaller.org/downloads\">Ruby 的官网</a> .</p></li> \n <li><p>安装 Ruby，将Ruby可执行文件添加到您的PATH</p> <p><img src=\"http://localhost:9090/blogImages/2019/10/11/0f433766-0cbb-4dcb-9ced-3953101cf68a.png\" alt=\"ruby-setup\"></p></li> \n <li><p>Ruby 安装完成后，在开始菜单中找到新安装的 Ruby，并启动 Ruby 的 Command 控制面板</p> <p><img src=\"http://localhost:9090/blogImages/2019/10/11/71443f14-1d04-416b-a0b2-b4f1dd4d80f5.png\" alt=\"start-ruby\"></p></li> \n</ul> \n<h5 id=\"sass-安装-1\">2. Sass 安装</h5> \n<ul> \n <li><p>在线安装</p> \n  <ul> \n   <li><p>使用 <code>gem install sass</code> 进行安装 sass .</p></li> \n   <li><p>或者：使用 <code>gem install compass</code> 通过 Compass 来安装 Sass.</p> \n    <blockquote> \n     <p>Compass 是基于 Sass 开发的一个框架。也就是说，你安装了 Compass，也就同时安装好了 Sass。</p> \n     <p>Compass 是一个成熟的、基于 Sass 开发的一个框架，这里面集成了很多写好的 mixins 和 Sass 函数。</p> \n    </blockquote></li> \n  </ul></li> \n <li><p>本地安装 (<strong>通 Mac 系统 Sass 的本地安装</strong>)</p></li> \n</ul> \n<h3 id=\"查测更新及卸载\">查测、更新及卸载</h3> \n<pre class=\"javascript\"><code>// 查看\nsass -v\n\n// 更新\ngem update sass\n\n// 卸载\ngem uninstall sass</code></pre> \n<h3 id=\"语法格式\">语法格式</h3> \n<h4 id=\"sass-语法格式\">1. Sass 语法格式</h4> \n<blockquote> \n <p>这里说的 Sass 语法是 Sass 的最初语法格式，他是通过 tab 键控制缩进的一种语法规则，而且这种缩进要求非常严格。另外其不带有任何的分号和大括号。常常把这种格式称为 Sass 老版本，其文件名以“.sass”为扩展名。</p> \n</blockquote> \n<h4 id=\"scss-语法格式\">2. Scss 语法格式</h4> \n<blockquote> \n <p>SCSS 是 Sass 的新语法格式，从外形上来判断他和 CSS 长得几乎是一模一样，代码都包裹在一对大括号里，并且末尾结束处都有一个分号。其文件名格式常常以“.scss”为扩展名。</p> \n</blockquote> \n<h4 id=\"注\">【注】：</h4> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/eff88713-fbce-4b85-8e39-3948c98d5aac.jpeg\" alt=\"sass 和 scss\"></p> \n<blockquote> \n <p>“.sass”只能使用 Sass 老语法规则（缩进规则），“.scss”使用的是 Sass 的新语法规则，也就是 SCSS 语法规则（类似 CSS 语法格式）。</p> \n</blockquote> \n<h3 id=\"编译调试\">编译调试</h3> \n<h4 id=\"sass-编译\">1. Sass 编译</h4> \n<h5 id=\"命令编译\">①、命令编译</h5> \n<blockquote> \n <p>使用电脑中的命令终端，通过输入 Sass 指令来编译 Sass</p> \n</blockquote> \n<ul> \n <li><p>单文件编译 <code>sass &lt;要编译的Sass文件路径&gt;/style.scss:&lt;要输出CSS文件路径&gt;/style.css</code> .</p> <pre class=\"javascript\"><code>// ex: 有一个 test.scss 文件需需要编译\nsass test.scss:test.css</code></pre></li> \n <li><p>多文件编译 <code>sass sass/:css/</code>.</p> \n  <blockquote> \n   <p>上面的命令表示将项目中“sass”文件夹中所有“.scss”(“.sass”)文件编译成“.css”文件，并且将这些 CSS 文件都放在项目中“css”文件夹中。</p> \n  </blockquote></li> \n <li><p>开启“<strong>watch</strong>”功能 <code>sass --watch &lt;要编译的Sass文件路径&gt;/style.scss:&lt;要输出CSS文件路径&gt;/style.css</code>.</p> <pre class=\"javascript\"><code>// 单文件\nsass --watch test.scss:test.css\n\n// 多文件\nsass --watch sass/:css/</code></pre> \n  <blockquote> \n   <p>这样只要你的代码进行任保修改，都能自动监测到代码的变化，并且给你直接编译出来：</p> \n  </blockquote></li> \n</ul> \n<h5 id=\"gui-界面工具编辑\">②、GUI 界面工具编辑</h5> \n<p>推荐：<a href=\"http://koala-app.com/\">Koala</a> .</p> \n<h5 id=\"自动化编译x\">③、自动化编译(X)</h5> \n<h4 id=\"不同样式风格的输出方法\">2. 不同样式风格的输出方法</h4> \n<h5 id=\"嵌套输出方式-nested\">①、嵌套输出方式 nested</h5> \n<pre class=\"javascript\"><code>sass --watch test.scss:test.css --style nested</code></pre> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/9d957cef-070f-486e-bb64-56e55a85bcb4.jpeg\" alt=\"--style nested\"></p> \n<h5 id=\"展开输出方式-expanded\">②、展开输出方式 expanded</h5> \n<blockquote> \n <p>输出的 CSS 样式风格和 nested 类似，只是大括号在另起一行</p> \n</blockquote> \n<pre class=\"javascript\"><code>sass --watch test.scss:test.css --style expanded</code></pre> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/a9651940-0072-42cb-9f22-c6fadb66d063.jpeg\" alt=\"--style expanded\"></p> \n<h5 id=\"紧凑输出方式-compact\">③、紧凑输出方式 compact</h5> \n<pre class=\"javascript\"><code>sass --watch test.scss:test.css --style compact</code></pre> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/240d4a9b-a8be-43c1-8c72-81dc514db01a.jpeg\" alt=\"--style compact\"></p> \n<h5 id=\"压缩输出方式-compressed\">④、压缩输出方式 compressed</h5> \n<blockquote> \n <p>压缩输出方式会去掉标准的 Sass 和 CSS 注释及空格</p> \n</blockquote> \n<pre class=\"javascript\"><code>sass --watch test.scss:test.css --style compressed</code></pre> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/2956b7b2-f6a1-4519-8175-204882b92e7d.jpeg\" alt=\"--style compressed\"></p> \n<h4 id=\"调试x\">3. 调试(X)</h4> \n<h3 id=\"基本特性\">基本特性</h3> \n<h4 id=\"基础\">基础</h4> \n<h5 id=\"变量\">1. 变量</h5> \n<blockquote> \n <p>Sass 的变量包括三个部分：</p> \n <ol> \n  <li>声明变量的符号“$”</li> \n  <li>变量名称</li> \n  <li>赋予变量的值</li> \n </ol> \n</blockquote> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/8e353d95-b037-47fc-9adb-ddd07d8408de.jpeg\" alt=\"定义变量图解\"></p> \n<ul> \n <li><p>默认变量</p> \n  <blockquote> \n   <p>值后面加上!default 。</p> \n  </blockquote> <pre class=\"scss\"><code>$color : #fff !default;</code></pre> \n  <blockquote> \n   <p>sass 的默认变量一般是用来设置默认值，然后根据需求来覆盖，覆盖的方式 - 只需要在<strong>调用</strong>该变量之前重新声明下变量即可。</p> \n  </blockquote> <p><img src=\"http://localhost:9090/blogImages/2019/10/11/661a5d10-e68c-4d4f-878b-4a0300dc4ce0.png\" alt=\"sass-var\"></p></li> \n <li><p>全局变量和局部变量</p> \n  <blockquote> \n   <p>定义全局变量(在选择器、函数、混合宏...的外面定义的变量为全局变量)。</p> \n   <p>可以简单的理解成，<strong>全局变量就是定义在元素外面的变量，而定义在元素内部的变量就是局部变量</strong> 。</p> \n  </blockquote></li> \n <li><p>全局变量的影子</p> \n  <blockquote> \n   <p>当在局部范围（选择器内、函数内、混合宏内...）声明一个已经存在于全局范围内的变量时，局部变量就成为了<strong>全局变量的影子</strong>。基本上，<strong>局部变量只会在局部范围内覆盖全局变量</strong>。</p> \n  </blockquote> <p><img src=\"http://localhost:9090/blogImages/2019/10/11/cd458bf9-6e32-4009-8a98-32749f667c4a.png\" alt=\"sass-var2\"></p></li> \n</ul> \n<h5 id=\"嵌套\">2. 嵌套</h5> \n<ul> \n <li><p>选择器嵌套</p> <p><img src=\"http://localhost:9090/blogImages/2019/10/11/9076d136-cdfe-46e1-83b4-8c6777fc9b8b.png\" alt=\"sass-qiantao\"></p></li> \n <li><p>属性嵌套</p> <p><img src=\"http://localhost:9090/blogImages/2019/10/11/e8663901-a7e0-481a-9629-5805fcdb363c.png\" alt=\"sass-qiantao-shuxing\"></p> \n  <blockquote> \n   <p><strong>避免选择器嵌套：</strong></p> \n   <ul> \n    <li>选择器嵌套最大的问题是将使最终的代码难以阅读。开发者需要花费巨大精力计算不同缩进级别下的选择器具体的表现效果。</li> \n    <li>选择器越具体则声明语句越冗长，而且对最近选择器的引用(&amp;)也越频繁。在某些时候，出现混淆选择器路径和探索下一级选择器的错误率很高，这非常不值得。</li> \n   </ul> \n  </blockquote></li> \n <li><p>伪类嵌套</p> <p><img src=\"http://localhost:9090/blogImages/2019/10/11/93d731e3-a3f5-48ca-96dd-b580111bb525.png\" alt=\"sass-var-weilei\"></p></li> \n</ul> \n<h5 id=\"混合宏\">3. 混合宏</h5> \n<blockquote> \n <p>在 Sass 中，使用“@mixin”来声明一个混合宏。<br> 使用“@include”来调用声明好的混合宏。</p> \n</blockquote> \n<ul> \n <li><p>不带参数混合宏</p> <pre class=\"scss\"><code>@mixin bdr{\n    -webkit-border-radius: 5px;\n    border-radius: 5px;\n}</code></pre> \n  <blockquote> \n   <p>@mixin 是用来声明混合宏的关键词；<br> bdr 是混合宏的名称；<br> 大括号里面是复用的样式代码。</p> \n  </blockquote></li> \n <li><p>带参数混合宏</p> \n  <blockquote> \n   <p>参数：不带值的参数、带值的参数、多个参数<br> 有一个特别的参数“<strong>…</strong>”。当混合宏传的参数过多之时，可以使用参数来替代。</p> \n  </blockquote> <pre class=\"scss\"><code>// 带值的参数\n@mixin bdr($radius:10px){\n    -webkit-border-radius: $radius;\n    border-radius: $radius;\n}</code></pre></li> \n <li><p>复杂的混合宏</p> <pre class=\"scss\"><code>@mixin box-shadow($shadow...) {\n  @if length($shadow) &gt;= 1 {\n    @include prefixer(box-shadow, $shadow);\n  } @else{\n    $shadow:0 0 4px rgba(0,0,0,.3);\n    @include prefixer(box-shadow, $shadow);\n  }\n}</code></pre> \n  <blockquote> \n   <p>这个 box-shadow 的混合宏，带有多个参数，这个时候可以使用“ … ”来替代。简单的解释一下，当 $shadow 的参数数量值大于或等于“ 1 ”时，表示有多个阴影值，反之调用默认的参数值“ 0 0 4px rgba(0,0,0,.3) ”。</p> \n  </blockquote></li> \n <li><p>调用混合宏</p> <p><img src=\"http://localhost:9090/blogImages/2019/10/11/574f0ece-b6e0-4a88-a3eb-d3c400e10157.png\" alt=\"sass-mixin\"></p></li> \n <li><p>混合宏的不足</p> \n  <blockquote> \n   <p>混合宏在实际编码中给我们带来很多方便之处，特别是对于复用重复代码块。但其最大的不足之处是会生成冗余的代码块。</p> \n  </blockquote> <p><img src=\"http://localhost:9090/blogImages/2019/10/11/b1ad4eb8-bf13-46f2-9d08-dc21955152cc.png\" alt=\"sass-mixin-buzu\"></p> \n  <blockquote> \n   <p>在调用相同的混合宏时，并不能智能的将相同的样式代码块合并在一起。这也是 Sass 的混合宏最不足之处。</p> \n  </blockquote></li> \n</ul> \n<h5 id=\"扩展继承\">4. 扩展/继承</h5> \n<blockquote> \n <p>在 Sass 中是通过关键词 “@extend”来继承已存在的类样式块，从而实现代码的继承。</p> \n</blockquote> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/7504b636-fa8e-471f-ad4b-7d9db80690e9.png\" alt=\"sass-extend\"></p> \n<blockquote> \n <p>在 Sass 中的继承，可以继承类样式块中所有样式代码，而且编译出来的 CSS 会将选择器合并在一起，形成组合选择器。</p> \n</blockquote> \n<h5 id=\"占位符\">5. 占位符</h5> \n<blockquote> \n <p>Sass 中的占位符 %placeholder 功能是一个很强大，很实用的一个功能。<br> 他可以取代以前 CSS 中的基类造成的代码冗余的情形。<br> 因为 %placeholder 声明的代码，如果不被 @extend 调用的话，不会产生任何代码。</p> \n</blockquote> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/3cb74116-d3af-4de0-a97b-5ff8c4e91cb1.png\" alt=\"sass-zhanweifu\"></p> \n<blockquote> \n <p>从编译出来的 CSS 代码可以看出，通过 @extend 调用的占位符，编译出来的代码会将相同的代码合并在一起，让你的代码变得更为干净。</p> \n</blockquote> \n<h5 id=\"混合宏-vs-继承-vs-占位符\">6. 混合宏 VS 继承 VS 占位符</h5> \n<ul> \n <li><p>Sass 中的混合宏使用</p> \n  <blockquote> \n   <p><strong>总结：</strong>编译出来的 CSS 清晰告诉了大家，他不会自动合并相同的样式代码，如果在样式文件中调用同一个混合宏，会产生多个对应的样式代码，造成代码的冗余，这也是 CSSer 无法忍受的一件事情。不过他并不是一无事处，他可以传参数。</p> \n   <p><strong>个人建议</strong>：如果你的代码块中<strong>涉及到变量</strong>，建议使用混合宏来创建相同的代码块。</p> \n  </blockquote></li> \n <li><p>Sass 中继承</p></li> \n</ul> \n<blockquote> \n <p><strong>总结：</strong>使用继承后，编译出来的 CSS 会将使用继承的代码块合并到一起，通过组合选择器的方式向大家展现。这样编译出来的代码相对于混合宏来说要干净的多，也是 CSSer 期望看到。但是他不能传变量参数。</p> \n <p><strong>个人建议</strong>：如果你的代码块<strong>不需要传任何变量参数</strong>，而且有一个基类已在文件中存在，那么建议使用 Sass 的继承。</p> \n</blockquote> \n<ul> \n <li><p>占位符</p> \n  <blockquote> \n   <p><strong>总结：</strong>编译出来的 CSS 代码和使用继承基本上是相同，只是不会在代码中生成占位符 mt 的选择器。那么占位符和继承的主要区别的，“占位符是独立定义，不调用的时候是不会在 CSS 中产生任何代码；继承是首先有一个基类存在，不管调用与不调用，基类的样式都将会出现在编译出来的 CSS 代码中。”</p> \n  </blockquote></li> \n</ul> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/88219f01-ca2a-4d3e-b747-a9cf05d0796a.jpeg\" alt=\"混合宏 VS 继承 VS 占位符\"></p> \n<h5 id=\"插值\">7. 插值</h5> \n<blockquote> \n <h1 id=\"section\">{}</h1> \n <p>可构建属性、选择器、@extend 中；<br> 不能在 Sass 变量、@include 中调用。</p> \n</blockquote> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/f87bc463-b154-4703-a498-0403be13b67b.png\" alt=\"sass-chazhi\"></p> \n<h5 id=\"注释\">8. 注释</h5> \n<ul> \n <li><p>单行注释</p> \n  <blockquote> \n   <p>类似 JavaScript 的注释方式，使用“//”</p> \n   <p>在编译出来的 CSS 中不会显示</p> \n  </blockquote></li> \n <li><p>多行注释</p> \n  <blockquote> \n   <p>类似 CSS 的注释方式，使用 ”/* ”开头，结尾使用 ”*/ ”</p> \n   <p>在编译出来的 CSS 显示</p> \n  </blockquote></li> \n</ul> \n<h4 id=\"运算\">运算</h4> \n<h5 id=\"加减\">1. 加/减</h5> \n<blockquote> \n <p>携带单位类型要一致。</p> \n</blockquote> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/97ae302b-af20-4c59-86d6-92b052b0abd6.png\" alt=\"sass-add\"></p> \n<blockquote> \n <p>in 是英寸。8in 即 8英寸。<br> 1英寸约等于 2.54厘米,1英寸大约是96像素<br> width: 20px + 8in;<br> 8in = 8 * 96px = 768px<br> 即width = 20px + 768px = 788px;</p> \n</blockquote> \n<h5 id=\"乘\">2. 乘</h5> \n<blockquote> \n <p>进行乘法运算时，两个值单位相同时，只需要为一个数值提供单位即可。</p> \n <p>乘法运算和加法、减法运算一样，在运算中有不同类型的单位时，也将会报错。</p> \n</blockquote> \n<h5 id=\"除\">3. 除</h5> \n<blockquote> \n <p>规则 通 乘法运算，有一个特殊之处：“<strong>/</strong>” 符号在 CSS 中已做为一种符号使用。因此在 Sass 中做除法运算时，直接使用 “/” 符号做为除号时，将不会生效，编译时既得不到我们需要的效果，也不会报错。</p> \n</blockquote> \n<pre class=\"scss\"><code>p {\n    font: 10px/8px;             // 纯 CSS，不是除法运算\n\n    $width: 1000px;\n    width: $width/2;            // 使用了变量，是除法运算\n\n    width: round(1.5)/2;        // 使用了函数，是除法运算\n\n    height: (500px/2);          // 使用了圆括号，是除法运算\n\n    margin-left: 5px + 8px/2px; // 使用了加（+）号，是除法运算\n}</code></pre> \n<p>编译之后</p> \n<pre class=\"css\"><code>p {\n    font: 10px/8px;\n    width: 500px;\n    height: 250px;\n    margin-left: 9px;\n}</code></pre> \n<blockquote> \n <p>如果两个值带有相同的单位值时，除法运算之后会得到一个不带单位的数值。</p> \n</blockquote> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/91b9d9c1-b2d6-4bc9-8053-84e6aba850bb.png\" alt=\"sass-chu\"></p> \n<h5 id=\"颜色运算\">4. 颜色运算</h5> \n<blockquote> \n <p>所有算数运算都支持颜色值，并且是分段运算的。也就是说，红、绿和蓝各颜色分段单独进行运算。<br> 也能将数字和颜色值 一起运算，<strong>同样也是分段运算的</strong>。</p> \n</blockquote> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/07315b14-66de-449d-8e28-8f58d82d3cb8.png\" alt=\"sass-yunsuan\"></p> \n<blockquote> \n <p>计算公式为：</p> \n <p>01 + 04 = 05、02 + 05 = 07 和 03 + 06 = 09， 并且被合成。<br> 01 * 2 = 02、02 * 2 = 04 和 03 * 2 = 06， 并且被合成。</p> \n</blockquote> \n<h5 id=\"字符运算\">5. 字符运算</h5> \n<blockquote> \n <p>在 Sass 中可以通过加法符号“+”来对字符串进行连接。</p> \n</blockquote> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/e42bbbbc-e9c1-45da-b8a7-3aa8a504a2e3.png\" alt=\"sass-zifuchuan\"></p> \n<blockquote> \n <p>除了在变量中做字符连接运算之外，还可以直接通过 +，把字符连接在一起。</p> \n</blockquote> \n<pre class=\"scss\"><code>div {\n  cursor: e + -resize;\n}\n\n// 编译之后\ndiv {\n  cursor: e-resize;\n}</code></pre> \n<blockquote> \n <p>注意，如果有引号的字符串被添加了一个没有引号的字符串 （也就是，带引号的字符串在 + 符号左侧）， 结果会是一个有引号的字符串。 同样的，如果一个没有引号的字符串被添加了一个有引号的字符串 （没有引号的字符串在 + 符号左侧）， 结果将是一个没有引号的字符串。</p> \n</blockquote> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/66dad89b-fa33-4d03-9cf3-eec85651e9bb.png\" alt=\"sass-zifuchuan2\"></p> \n<h3 id=\"附录\">附录</h3> \n<p>​ <a href=\"https://www.imooc.com/learn/311\">Sass 教程</a> .</p> \n<p>​ <a href=\"https://www.sass.hk/\">Sass 中文网</a> .</p> \n<p>​ <a href=\"http://sass.bootcss.com/\">Sass 中文文档</a> .</p>', '简介 \n1. Sass 和 Scss \n \n Sass 和 Scss 其实是同一种东西，我们平时都称之为 Sass；Scss 是 Sass 3 引入新的语法，其语法完全兼容 CSS3，并且继承了 Sass 的强大功能。也就是说，任何标准的 CSS3 样式表都是具有相同语义的有效的 Scss文件。 \n 两者之间', '2019-10-11 15:25:11', 23, 3, 'CSS 预处理', 'https://www.cnblogs.com/blog-Y/p/11654371.html', 0, NULL);
INSERT INTO `t_blog` VALUES (232, '手把手教你如何在window下将jenkins+allure集成生成的测试报告通过jenkins配置邮箱自动发送（生成测试报告就万事大吉了吗？NO，升职加薪就差这一步啦！）-04（非常详细，非常实用）', '<h2><strong>简介</strong></h2> \n<p><strong>　　</strong>上一篇生成测试报告，小伙伴们和童鞋们就又问道，测试报告已经生成了，怎么发送给相关的负责人了？小伙伴们和童鞋们不要着急，听宏哥慢慢给你道来，心急吃不了热豆腐哈。这些小伙伴们的表现还是不错的，还有表现差一点的小伙伴或者童鞋们，窃窃自喜，以为万事大吉了，NO，还差一步，不把测试报告发出去好好地在领导面前表现一番，你留着生娃过年吗？辛苦了这么久升职加薪就靠这一把了今天这篇文章宏哥就给小伙伴和童鞋们来答疑解惑了，当然了方式方法多种多样的，你可以通过邮件、QQ、微信将测试报告附件手动写邮件发送给相关负责人。这里宏哥讲解如何将测试报告自动发送给相关的负责人。</p> \n<h2>安装插件</h2> \n<p>1、安装插件：<strong>Email Extension Plugin</strong></p> \n<p>从上一篇文章想必大家都知道了如何安装插件的两种方法了吧。在这里宏哥还是选择第二种方法，建议小伙伴和童鞋们也选择这种方法。这样就不需要找那个插件文件的下载地址，版本与jenkins的兼容等等一系列奇奇怪怪的问题了。不要自己给自己挖坑，自己坑自己。当然了，有受虐倾向的除外了。呵呵和大家开玩笑，自己开心就好，想怎么样都可以。</p> \n<p>&nbsp;步骤：系统管理-插件管理-安装Email Extension插件</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/a9162115-3d9f-4bbf-b855-662db64009f6.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/25fb3e8f-e342-4f62-910b-2f5ae6ba1dc0.png\" alt=\"\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/43368c08-a1ad-4d91-9c63-c4835856286a.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;从上图可以看出，这里宏哥已经安装好了2.66的，如果需要更新的可以更新到最新的2.68。由于时间关系，宏哥这里就不做更新操作了。</p> \n<h2>配置发送邮件信息</h2> \n<p>&nbsp;1）系统管理-系统设置-Jenkins Location，这里的管理员地址要和发送人的邮箱地址一样，要不然会有问题。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/a9162115-3d9f-4bbf-b855-662db64009f6.png\" alt=\"\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/2677abeb-1d3c-469a-b741-7412d7ebe503.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/7adafa81-43cc-4818-a85c-6bdbca08d5cb.png\" alt=\"\"></p> \n<p>2）系统管理-系统设置-Extended E-mail Notification-高级，根据红框内容填写。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/a9162115-3d9f-4bbf-b855-662db64009f6.png\" alt=\"\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/2677abeb-1d3c-469a-b741-7412d7ebe503.png\" alt=\"\"></p> \n<p>Extended E-mail Notification和高级的配置如下：</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/a36023b2-77ef-4aa3-9fa8-f8705961ec7a.png\" alt=\"\"></p> \n<p>1. Override Global Settings：如果不选，该插件将使用默认的E-mail Notification通知选项。反之，您可以通过指定不同于( 默认选项)的设置来进行覆盖。</p> \n<p>2. Default Content Type：指定构建后发送邮件内容的类型，有Text和HTML两种.</p> \n<p>3. Use List-ID Email Header：为所有的邮件设置一个List-ID的邮件信头，这样你就可以在邮件客户端使用过滤。它也能阻止邮件发件人大部分的自动回复(诸如离开办公室、休假等等)。你可以使用你习惯的任何名称或者ID号，但是他们必须符合如下其中一种格式(真实的ID必须要包含在&lt;和&gt;标记里)： &lt;ci-notifications.company.org&gt; Build Notifications &lt;ci-notifications.company.org&gt; “Build Notifications” &lt;ci-notifications.company.org&gt;</p> \n<p>4. Add \'Precedence: bulk\' Email Header：设置优先级,</p> \n<p>5. Default Recipients：自定义默认电子邮件收件人列表。如果没有被项目配置覆盖,该插件会使用这个列表。您可以在项目配置使用$ DEFAULT_RECIPIENTS参数包括此默认列表，以及添加新的地址在项目级别。添加抄送：cc:电子邮件地址例如,CC:someone@somewhere.com</p> \n<p>6. Reply To List：回复列表, A comma separated list of e-mail addresses to use in the Reply-To header of the email. This value will be available as $DEFAULT_REPLYTO in the project configuration.</p> \n<p>7. Emergency reroute：如果这个字段不为空，所有的电子邮件将被单独发送到该地址（或地址列表）。</p> \n<p>8. Excluded Committers：防止邮件被邮件系统认为是垃圾邮件,邮件列表应该没有扩展的账户名(如:@domain.com),并且使用逗号分隔</p> \n<p>9. Default Subject：自定义邮件通知的默认主题名称。该选项能在邮件的主题字段中替换一些参数，这样你就可以在构建中包含指定的输出信息。</p> \n<p>10. Maximum Attachment Size：邮件最大附件大小。</p> \n<p>11. Default Content：自定义邮件通知的默认内容主体。该选项能在邮件的内容中替换一些参数，这样你就可以在构建中包含指定的输出信息。</p> \n<p>12. Default Pre-send Script：默认发送前执行的脚本（注：grooy脚本，这是我在某篇文章上看到的，不一定准确）。</p> \n<p>13. Enable Debug Mode：启用插件的调试模式。这将增加额外的日志输出，构建日志以及Jenkins的日志。在调试时是有用的，但不能用于生产。</p> \n<p>14. Enable Security：启用时，会禁用发送脚本的能力，直接进入Jenkins实例。如果用户试图访问Jenkins管理对象实例，将抛出一个安全异常。</p> \n<p>15. Content Token Reference：邮件中可以使用的变量，所有的变量都是可选的。</p> \n<p>邮件模板引用别的模板，然后自己改编的：</p> \n<p>default subject&nbsp; &nbsp; &nbsp;&nbsp;[构建通知]：${BUILD_STATUS} - ${PROJECT_NAME} - Build # ${BUILD_NUMBER} !</p> \n<p>1)模板1</p> \n<div class=\"cnblogs_code\"> \n <pre>&lt;!DOCTYPE html&gt;\r\n\r\n&lt;html lang=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">en</span><span style=\"color: #800000;\">\"</span>&gt;\r\n&lt;body leftmargin=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">8</span><span style=\"color: #800000;\">\"</span> marginwidth=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">0</span><span style=\"color: #800000;\">\"</span> topmargin=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">8</span><span style=\"color: #800000;\">\"</span> marginheight=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">4</span><span style=\"color: #800000;\">\"</span> offset=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">0</span><span style=\"color: #800000;\">\"</span>&gt;\r\n    &lt;table width=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">95%</span><span style=\"color: #800000;\">\"</span> cellpadding=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">0</span><span style=\"color: #800000;\">\"</span> cellspacing=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">0</span><span style=\"color: #800000;\">\"</span>  style=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif</span><span style=\"color: #800000;\">\"</span>&gt;\r\n        &lt;tr&gt;<span style=\"color: #000000;\">\r\n            本邮件由系统自动发出，无需回复！</span>&lt;br/&gt;<span style=\"color: #000000;\">\r\n            各位同事，大家好，以下为${PROJECT_NAME }项目构建信息</span>&lt;/br&gt;\r\n            &lt;h1&gt;&lt;center&gt;&lt;font color=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">red</span><span style=\"color: #800000;\">\"</span>&gt;allure报告在线查看or下载allure-report.zip用firefox离线查看，测试用例见附件&lt;/font&gt;&lt;center&gt;&lt;/h1&gt;\r\n        &lt;/tr&gt;\r\n        &lt;tr&gt;\r\n            &lt;td&gt;&lt;br/&gt;\r\n            &lt;b&gt;&lt;font color=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">#0B610B</span><span style=\"color: #800000;\">\"</span>&gt;项目描述：${JOB_DESCRIPTION}&lt;br&gt;&lt;/font&gt;&lt;/b&gt;\r\n            &lt;hr size=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">2</span><span style=\"color: #800000;\">\"</span> width=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">100%</span><span style=\"color: #800000;\">\"</span> align=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">center</span><span style=\"color: #800000;\">\"</span> /&gt;&lt;/td&gt;\r\n        &lt;/tr&gt;\r\n        &lt;tr&gt;\r\n            &lt;td&gt;\r\n                &lt;ul&gt;\r\n                    &lt;li&gt;项目名称 ： ${PROJECT_NAME}&lt;/li&gt;\r\n                    &lt;li&gt;构建编号 ： 第${BUILD_NUMBER}次构建&lt;/li&gt;\r\n                    &lt;li&gt;SVN 版本： ${SVN_REVISION}&lt;/li&gt;\r\n                    &lt;li&gt;触发原因： ${CAUSE}&lt;/li&gt;\r\n                    &lt;li&gt;构建状态： ${BUILD_STATUS}&lt;/li&gt;\r\n                    &lt;li&gt;构建日志： &lt;a href=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">${BUILD_URL}console</span><span style=\"color: #800000;\">\"</span>&gt;${BUILD_URL}console&lt;/a&gt;&lt;/li&gt;\r\n                    &lt;li&gt;构建  Url ： &lt;a href=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">${BUILD_URL}</span><span style=\"color: #800000;\">\"</span>&gt;${BUILD_URL}&lt;/a&gt;&lt;/li&gt;\r\n                    &lt;li&gt;工作目录 ： &lt;a href=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">${PROJECT_URL}ws</span><span style=\"color: #800000;\">\"</span>&gt;${PROJECT_URL}ws&lt;/a&gt;&lt;/li&gt;\r\n                    &lt;li&gt;项目  Url ： &lt;a href=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">${PROJECT_URL}</span><span style=\"color: #800000;\">\"</span>&gt;${PROJECT_URL}&lt;/a&gt;&lt;/li&gt;\r\n                    &lt;li&gt;系统allure测试报告：&lt;a HREF=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">${PROJECT_URL}${BUILD_NUMBER}/allure</span><span style=\"color: #800000;\">\"</span>&gt;${PROJECT_URL}${BUILD_NUMBER}/allure&lt;/a&gt;&lt;li&gt;\r\n                &lt;/ul&gt;\r\n　　　　&lt;/td&gt;\r\n        &lt;tr&gt;\r\n　　　　     &lt;td&gt;\r\n            &lt;b&gt;&lt;font color=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">#0B610B</span><span style=\"color: #800000;\">\"</span>&gt;构建日志 (最后 100行):&lt;/font&gt;&lt;/b&gt;\r\n　　　　    &lt;hr size=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">2</span><span style=\"color: #800000;\">\"</span> width=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">100%</span><span style=\"color: #800000;\">\"</span> align=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">center</span><span style=\"color: #800000;\">\"</span> /&gt;\r\n            &lt;/td&gt;\r\n        &lt;/tr&gt;\r\n        &lt;tr&gt;\r\n　          &lt;td&gt;\r\n                &lt;textarea cols=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">80</span><span style=\"color: #800000;\">\"</span> rows=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">30</span><span style=\"color: #800000;\">\"</span> <span style=\"color: #0000ff;\">readonly</span>=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">readonly</span><span style=\"color: #800000;\">\"</span> style=<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">font-family: Courier New</span><span style=\"color: #800000;\">\"</span>&gt;${BUILD_LOG, maxLines=<span style=\"color: #800080;\">100</span>}&lt;/textarea&gt;\r\n            &lt;/td&gt;\r\n        &lt;/tr&gt;<span style=\"color: #000000;\">\r\n        ${JELLY_SCRIPT}\r\n    </span>&lt;/table&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;</pre> \n</div> \n<div class=\"line number44 index43 alt1\"> \n <p>3）配置后发送测试邮件看是否成功发送。宏哥这里发送测试邮件成功如下：</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/d2c46bdf-7790-4252-8179-0d6ab48e6d33.png\" alt=\"\"></p> \n <p>到邮箱查看如下图：</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/d429889e-9a47-4462-86d4-3f6b24ecaad3.png\" alt=\"\"></p> \n <h2>配置构建后操作</h2> \n <p>jenkins-项目（需要发送邮件的任务）-配置-构建后操作-Editable Email Notification</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/180b07d3-3ea1-4691-ae96-58d44792ee57.png\" alt=\"\"></p> \n <p>&nbsp;</p> \n <p>&nbsp;</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/db0b9b84-9b67-4cbf-81c6-4754dc5ef8ba.png\" alt=\"\"></p> \n <p>点击“Advanced Settings”</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/c8d92f50-4408-4e69-a9f6-5bd853b84586.png\" alt=\"\"></p> \n <p>点击“Add Trigger”，设置邮件的触发条件：</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/21bc91ba-5e19-48b7-a681-a9ba0978d0c4.png\" alt=\"\"></p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/bed538bf-c0f3-4197-a024-157e79ff01d9.png\" alt=\"\"></p> \n <p>当插件激活后你就能编辑如下字段（只列出常用的字段）：</p> \n <p>Project Recipient List：这是一个以逗号(或者空格)分隔的收件人邮件的邮箱地址列表。允许您为每封邮件指定单独的列表。Ps：如果你想在默认收件人的基础上添加收件人：$DEFAULT_RECIPIENTS,&lt;新的收件人&gt;</p> \n <p>Default Subject：允许你配置此项目邮件的主题。</p> \n <p>Default Content：跟Default Subject的作用一样，但是是替换邮件内容。</p> \n <p>Attach Build Log：附件构建日志。</p> \n <p>Compress Build Log before sending：发送前压缩生成日志（zip格式）。</p> \n <p>Triggers条件：</p> \n <p>Failure：即时发送构建失败的邮件。如果”Still Failing”触发器已配置，而上一次构建的状态是”Failure”，那么”Still Failing”触发器将发送一封邮件来替代(它)。</p> \n <p>Unstable：即时发送构建不稳固的邮件。如果”Still Unstable”触发器已配置，而上一次构建的状态是”Unstable”，那么”Still Unstable”触发器将发送一封邮件来替代(它)。</p> \n <p>Still Failing：如果两次或两次以上连续构建的状态为”Failure”，发送该邮件。</p> \n <p><em id=\"__mceDel\"><em id=\"__mceDel\"></em></em>Success：如果构建的状态为”Successful”发送邮件。如果”Fixed”已配置，而上次构建的状态为“Failure”或“Unstable”，那么”Fixed”触发器将发送一封邮件来替代(它)。</p> \n <p>Fixed：当构建状态从“Failure”或“Unstable”变为”Successful”时发送邮件。</p> \n <p>Still Unstable：如果两次或两次以上连续构建的状态为” Unstable “，发送该邮件。Before Build：当构建开始时发送邮件。</p> \n <h2>构建生成报告，并发送邮件</h2> \n <p>1）点击“立即构建”生成测试报告，然后发送邮件到相关的负责人邮箱</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/bd0be72a-eccb-499b-a31c-cc75bcaaccb1.png\" alt=\"\"></p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/0024a4ba-2a71-421c-a63b-0cf35dd42c9b.png\" alt=\"\"></p> \n <h2>小结</h2> \n <p>1）那个邮件的主题和模板内容可以单独给项目配置，也可以统一在插件处配置。单独项目配置的会覆盖插件出的配置，如果单独项目没有配置，会默认使用插件的配置。</p> \n <p>2）可能存在发送报错501</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/d1b37d50-7d33-41bd-a9ad-1ba852a2ddcc.png\" alt=\"\" width=\"885\" height=\"331\"></p> \n <p>501解决方法：</p> \n <p>&nbsp;<img src=\"http://localhost:9090/blogImages/2019/10/11/c3da4144-f632-4de4-aad4-50e3d5649283.png\" alt=\"\" width=\"907\" height=\"161\"></p> \n <p>3）可能存在发送报错535</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/90a028ce-a06a-43ee-9a5f-435064117573.png\" alt=\"\" width=\"925\" height=\"177\"></p> \n <p>535解决方法：</p> \n <p>检查授权码是否正确</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/9b3a00c3-9db3-4e00-9afd-cd807d26125f.png\" alt=\"\" width=\"1091\" height=\"174\"></p> \n <p>4）QQ邮箱注意事项</p> \n <p>QQ邮箱开启IMAP/SMTP服务：设置--账户</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/edcc361b-1e82-438d-8089-6518b4936539.png\" alt=\"\"></p> \n <p><strong>&nbsp;QQ邮箱服务器端口号</strong></p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/a157db8a-7b70-4143-a3d8-fb584dc1ffe4.png\" alt=\"\"></p> \n <p>5）如果测试邮件发送成功，立即构建后，邮件却发送失败，将这个勾选上，在构建时查看控制台的日志，进行错误排查</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/e0a25ce3-50cc-43c7-b664-aa0ce36ea3a4.png\" alt=\"\"></p> \n <p>&nbsp;</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/b8d84977-5e3f-4f9e-b54a-6bbe339cc52a.png\" alt=\"\"></p> \n <p>&nbsp;</p> \n <p>&nbsp;</p> \n <p>&nbsp;</p> \n <p><span style=\"font-size: 18px;\"><strong><strong>您的肯定就是我进步的动力。</strong>如果你感觉还不错，就请鼓励一下吧！记得点波&nbsp;<span style=\"font-size: 18pt; color: #ff0000;\">推荐</span>&nbsp;哦！！！（点击右边的小球即可！(^__^)&nbsp;嘻嘻……）</strong></span></p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/11/5e484c38-c175-41c1-b0cc-9d1f82f07c3d.gif\" alt=\"\"></p> \n</div>', NULL, '2019-10-11 15:25:22', 4, NULL, NULL, 'https://www.cnblogs.com/du-hong/p/11647394.html', 0, NULL);
INSERT INTO `t_blog` VALUES (233, 'Java8 Stream性能如何及评测工具推荐', '<p>作为技术人员，学习新知识是基本功课。有些知识是不得不学，有些知识是学了之后如虎添翼，Java8的Stream就是兼具两者的知识。不学看不懂，学了写起代码来如虎添翼。</p> \n<p>在上篇《<a href=\"https://www.choupangxia.com/2019/10/09/java8-stream%e6%96%b0%e7%89%b9%e6%80%a7%e8%af%a6%e8%a7%a3%e5%8f%8a%e5%ae%9e%e6%88%98/\">Java8 Stream新特性详解及实战</a>》中我们介绍了Java8 Stream的基本使用方法，尝试一下是不是感觉很爽？当只用一行代码就搞定最终结果时，是不是再也不想用for循环一遍遍去迭代了。</p> \n<p>同时，你是否又看到类似《Java8 Lambda表达式和流操作如何让你的代码变慢5倍》这样的文章，那么今天就带大家通过编写测试程序来一探究竟，看看Stream的性能到底如何。同时，带大家认识一个非常不错的性能测试工具junitperf。</p> \n<h2 id=\"测试环境\">测试环境</h2> \n<p>先同步一下测试环境及工具信息：</p> \n<ul> \n <li>JDK版本：1.8.0_151。</li> \n <li>电脑配置：MacBook Pro i7，16G内存。</li> \n <li>Java测试工具：junitperf及Junit。</li> \n <li>IDE：intellij IDEA。</li> \n</ul> \n<p>在测试的过程中电脑中还开了其他很多应用，但基本上都没进行操作。</p> \n<h2 id=\"实验一基本类型迭代\">实验一：基本类型迭代</h2> \n<p>基本测试方案，先初始化一个int数组，5亿个随机数。然后从这个数组中找到最小的一个数。</p> \n<p>采用三个单元测试方法来对照参考：</p> \n<ul> \n <li>testIntFor：测试for循环执行时间；</li> \n <li>testIntStream：测试串行Stream执行时间；</li> \n <li>testIntParallelStream：测试并行Stream执行时间；</li> \n</ul> \n<p>测试程序相关代码：</p> \n<pre><code>public class StreamTest {\n\n    public static int[] arr;\n\n    @BeforeAll\n    public static void init() {\n        arr = new int[500000000];\n        randomInt(arr);\n    }\n\n    @JunitPerfConfig(duration = 10000, warmUp = 1000, reporter = {HtmlReporter.class})\n    public void testIntFor() {\n        minIntFor(arr);\n    }\n\n    @JunitPerfConfig(duration = 10000, warmUp = 1000, reporter = {HtmlReporter.class})\n    public void testIntParallelStream() {\n        minIntParallelStream(arr);\n    }\n\n    @JunitPerfConfig(duration = 10000, warmUp = 1000, reporter = {HtmlReporter.class})\n    public void testIntStream() {\n        minIntStream(arr);\n    }\n\n    private int minIntStream(int[] arr) {\n        return Arrays.stream(arr).min().getAsInt();\n    }\n\n    private int minIntParallelStream(int[] arr) {\n        return Arrays.stream(arr).parallel().min().getAsInt();\n    }\n\n    private int minIntFor(int[] arr) {\n        int min = Integer.MAX_VALUE;\n        for (int anArr : arr) {\n            if (anArr &lt; min) {\n                min = anArr;\n            }\n        }\n        return min;\n    }\n\n    private static void randomInt(int[] arr) {\n        Random r = new Random();\n        for (int i = 0; i &lt; arr.length; i++) {\n            arr[i] = r.nextInt();\n        }\n    }\n}</code></pre> \n<p>基本操作流程：通过@BeforeAll注解的init方法对数组进行随机初始化，然后再统一执行上面三个测试方法。</p> \n<p>在单元测试的方法上都有下面的注解：</p> \n<pre><code>@JunitPerfConfig(duration = 10000, warmUp = 1000, reporter = {HtmlReporter.class})</code></pre> \n<p>该注释为junitperf提供的注解，其中duration为持续执行这段代码的时间，单位毫秒；warmUp预热时间，这里预热1秒；reporter输出报表格式，这里采用HTML展示，可以更直观看到效果。</p> \n<p>好上面的一切都准备好了，剩下的就是统一执行单元测试。执行结果如下三个图。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/9413657e-f80a-47f7-8a61-809b6c717eeb.jpeg\" alt=\"image\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/8c31e47c-4cab-4bc6-a771-07aa225d80f4.jpeg\" alt=\"image\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/d5ab4caa-cf4d-470d-bf8b-8ab357ed0e20.jpeg\" alt=\"image\"></p> \n<p>针对基础类型（int）操作，结果分析：</p> \n<ul> \n <li>串行Stream的执行的确不如for循环性能高，耗时大概是for循环的2倍。</li> \n <li>并行Stream的执行性能要优于for循环，耗时大概是for循环的一半。</li> \n <li>这里没有用不同核数的机器测试，但并行Stream随着服务器核数的增加，必然更快。</li> \n</ul> \n<h2 id=\"实验二对象迭代\">实验二：对象迭代</h2> \n<p>生成一个List列表，列表中随机生成10000000个字符串，然后分别通过不同的方式计算获得最小的字符串。</p> \n<p>基本操作与实验一相同，不再贴出代码，直接看测试的效果图。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/9bb01823-f0c9-44c1-9bb3-03e29c64329c.jpeg\" alt=\"image\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/d21f1aef-c84c-40ef-9a35-22f708e8d3d6.jpeg\" alt=\"image\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/38aef1a5-c768-4931-a12a-33be7fe65e94.jpeg\" alt=\"image\"></p> \n<p>针对对象（String）操作，结果分析：</p> \n<ul> \n <li>Stream的性能与for循环已经相差不大了，耗时大概是for循环的1.25倍左右。</li> \n <li>并行Stream执行的性能要优于for循环，而且比基础类型的优势更高，耗时已经低于for循环的一半。</li> \n <li>针对不同服务器核数，Stream效率同样会更加高。</li> \n</ul> \n<h2 id=\"实验三复杂对象归约\">实验三：复杂对象归约</h2> \n<p>生成一个List列表，列表里面存放着1百万个User对象。每个对象中都包含用户名和用户某次运动的距离，同一用户可在List里包含多条运动记录。现在通过不同的方式来统计用户的总共运动了多远距离。</p> \n<p>基本测试思路一致，这里只贴出基于Stream的算法的代码，以便大家了解Stream的复杂对象归约如何使用。</p> \n<pre><code>// 串行写法\nusers.stream().collect(\n                Collectors.groupingBy(User::getUserName,\n                        Collectors.summingDouble(User::getMeters)));\n// 并行写法                     \nusers.parallelStream().collect(\n                Collectors.groupingBy(User::getUserName,\n                        Collectors.summingDouble(User::getMeters)));</code></pre> \n<p>下面看测试结果的数据：</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/813fe1ae-ffc8-408e-af33-60b1a771a1de.jpeg\" alt=\"image\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/9fe11cf8-0a02-4920-ad2e-0026229e156a.jpeg\" alt=\"image\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/d82a88d0-e730-486a-a912-e6c8bfc9ad94.jpeg\" alt=\"image\"></p> \n<p>复杂对象归约操作，结果分析：</p> \n<ul> \n <li>基于Stream的操作明显都高于for循环的效率，而且并行的效果更加明显。</li> \n <li>同样，随着服务器核数的增加，并行Stream的效率会更高。</li> \n</ul> \n<p>最后推荐一下这款用起来还不错的Java性能测试工具，GitHub地址：https://github.com/houbb/junitperf。 上面有详细的使用说明。唯一缺少的就是数据预初始化的示例，而本篇文章的示例中已经补上了这部分缺失。</p> \n<h2 id=\"小结\">小结</h2> \n<p>通过上面的几组实验对比，我们可以看到如下结论：</p> \n<ul> \n <li>针对简单的操作，比如基础类型的遍历，使用for循环性能要明显高于串行Stream操作。但Stream的并行操作随着服务器的核数增加，会优于for循环。</li> \n <li>针对复杂操作，串行Stream性能与for循环不差上下，但并行Stream的性能已经是无法匹敌了。</li> \n <li>特别是针对一个集合进行多层过滤并归约操作，无论从写法上或性能上都要明显优于for循环。</li> \n</ul> \n<p>用一句话来说就是：简单操作for循环即可，复杂操作首推Stream。</p> \n<p>现在的Stream书写简单，性能不错，如果未来JDK针对其进行优化，便同时享受了便捷和性能，何乐而不为呢。</p> \n<p>原文链接《<a href=\"https://www.choupangxia.com/2019/10/11/java8-stream%e6%80%a7%e8%83%bd%e5%a6%82%e4%bd%95%e5%8f%8a%e8%af%84%e6%b5%8b%e5%b7%a5%e5%85%b7%e6%8e%a8%e8%8d%90/\">Java8 Stream性能如何及评测工具推荐</a>》</p>', NULL, '2019-10-11 15:25:27', 4, NULL, NULL, 'https://www.cnblogs.com/secbro/p/11653574.html', 0, NULL);
INSERT INTO `t_blog` VALUES (234, '【实战】 elasticsearch 写入速度提升的案例分享', '<ul> \n <li>文章首发投稿至InfoQ,【侠梦的开发笔记】公众号，欢迎关注 \n  <ul> \n   <li><a href=\"https://www.infoq.cn/article/t7b52mbzxqkwrrdpVqD2\" class=\"uri\">https://www.infoq.cn/article/t7b52mbzxqkwrrdpVqD2</a></li> \n  </ul></li> \n</ul> \n<h5 id=\"基本配置\">基本配置</h5> \n<ul> \n <li>基本配置，5台配置为 24C 125G 17T 的主机，每台主机上搭建了一个elasticsearch节点。<br> 采用的elasticsearch集群版本为7.1.1。管理工具包括kibana和cerebro。</li> \n</ul> \n<h5 id=\"应用案例\">应用案例</h5> \n<ul> \n <li>数据来源为kafka的三个topic，主要用于实时日志数据的存储和检索，由于实时性要求，所以需要将数据快速的写入到es中。<br> 这里就分别称它们为TopicA、TopicB、TopicC吧。由于是调优写入，所以对源数据的一些基本的指标需要作出一个详细的梳理，便于后续分析。以下为三个topic的数据产生情况：</li> \n</ul> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/d97e374f-b088-4acd-bd33-fa38949ff068.jpeg\" alt=\"file\"></p> \n<h5 id=\"规划\">规划</h5> \n<table> \n <thead> \n  <tr class=\"header\"> \n   <th>Topic</th> \n   <th>报文大小</th> \n   <th>数据量预估（天）</th> \n   <th>es索引分片数规划</th> \n  </tr> \n </thead> \n <tbody> \n  <tr class=\"odd\"> \n   <td>topicA</td> \n   <td>900b</td> \n   <td>2T</td> \n   <td>30个主分片</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>topicB</td> \n   <td>800b</td> \n   <td>400G</td> \n   <td>10个主分片</td> \n  </tr> \n  <tr class=\"odd\"> \n   <td>topicC</td> \n   <td>750b</td> \n   <td>300G</td> \n   <td>10个主分片</td> \n  </tr> \n </tbody> \n</table> \n<h5 id=\"问题重现\">问题重现</h5> \n<ul> \n <li>未做任何配置的情况下，分别使用java和logstash进行数据抽取，发现效率都不高，具体问题表现在： \n  <ul> \n   <li>1、kafka数据积压严重，消费跟不上生产的速度。</li> \n   <li>2、elasticsearch集群负载很高，大量写入被拒绝。</li> \n   <li>3、java程序频繁抛出RejectionException异常。</li> \n   <li>4、主机cpu异常的高。<br> 操作系统层面及JVM的配置调整这里不再阐述，有很多关于此类的文章可以参考。<br> 我们分模块对各个部分进行调整，具体细节如下：</li> \n  </ul></li> \n</ul> \n<h5 id=\"写入程序优化\">写入程序优化</h5> \n<h6 id=\"从定数到定量\">从定数到定量</h6> \n<ul> \n <li>使用的java程序中，我们将固定条数插入改为固定大小插入，由于使用的es版本较高，直接替换成了官方推荐的BulkProcessor方式。具体指定属性如下：</li> \n</ul> \n<pre><code># 每2w条执行一次bulk插入\nbulkActions: 20000\n# 数据量达到15M后执行bulk插入\n bulkSizeMb: 15\n# 无论数据量多少，间隔20s执行一次bulk\nflushInterval: 20\n# 允许并发的bulk请求数\nconcurrentRequests: 10</code></pre> \n<ul> \n <li>这里的具体配置值，可以根据观察集群状态，来逐步增加。对于高版本的es，可以通过x-pack的监控页面观察索引速度进行相应调整，如果es版本较低，可以使用推荐的rest api进行逻辑封装。<br> 在低版本的es中，统计写入速度的思路是：写一个程序定时检查索引的数据量，来计算。如果使用python，就两行代码就能获取索引的数据总量。</li> \n</ul> \n<pre><code> call_list = es.indices.stats(index=index)\ntotal = call_list[\'indices\'][index][\'total\'][\'indexing\'][\'index_total\']。</code></pre> \n<p>也可以隔几分钟用CURL来粗略统计单个索引的数据量大小。命令如下：</p> \n<h6 id=\"查询索引文档总量\">查询索引文档总量</h6> \n<pre><code>curl -XGET -uname:pwd\n\'http://esip:port/_cat/count/index-name?v&amp;format=json&amp;pretty\'</code></pre> \n<p>###### 启动多个进程</p> \n<ul> \n <li>由于Bulkprocess是线程安全的，所以我们可以使用多线程的方式来共享一个批处理器。更好的消费方式是，启动多个消费程序进程，将其部署在不同的主机上，让多个进程中开启的多线程总数和topic的分区数相等，并且将他们设置为同一个消费组。每一个进程包含一个bulkprocess,可以提高消费和批量写入能力。同时可以避免单点问题，假如一个消费者进程挂掉，则kafka集群会重新平衡分区的消费者。少了消费者只是会影响消费速度，并不影响数据的处理。</li> \n</ul> \n<p>###### “压测”，提升批量插入条数</p> \n<ul> \n <li>通过对各个监控指标的观察，来判断是否能继续提高写入条数或增加线程数，从而达到最大吞吐量。</li> \n</ul> \n<p>###### 一、观察集群负载Load Average值</p> \n<ul> \n <li>负载值，一定程度上代表了CPU的繁忙程度，那我们如何来解读elasticsearch 监控页面的的负载值呢？如下是一个三个节点的集群，从左侧cerebo提供的界面来看，load值标红，表明es的负载可能有点高了，那么这个具体达到什么值会显示红色呢，让我们一起来研究研究。</li> \n</ul> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/5b1b43b5-b7e4-4a7a-9626-42c278007af4.jpeg\" alt=\"file\"><br> <img src=\"http://localhost:9090/blogImages/2019/10/11/92baf296-8c0e-46b5-a3ae-e1c78a492347.jpeg\" alt=\"file\"></p> \n<ul> \n <li>先从主机层面说起，linux下提供了一个uptime命令来观察主机的负载<br> <img src=\"http://localhost:9090/blogImages/2019/10/11/9ac304f1-4c0f-4a72-84f1-22371a482760.jpeg\" alt=\"file\"></li> \n <li>其中load average的三个值，分别代表主机在1分钟、5分钟、15分钟内的一个负载情况。有人可能会疑惑，26.01是代表主机的负载在26%的意思吗，从我们跑的es集群情况来看，这显然不是负载很低的表现。其实啊，在单个cpu的情况下，这个值是可以看做一个百分比的，比如负载为0.05，表明目前系统的负荷为5%。但我们的服务器一般都是多个处理器，每个处理器内部会包含多个cpu核心，所以这里负载显示的值，是和cpu的核心数有关的，如果非要用百分比来表示系统负荷的话，可以用具体的负载值 除以 服务器的总核心数，观察是否大于1。总核心数查看的命令为：</li> \n</ul> \n<pre><code>cat /proc/cpuinfo |grep -c \'model name\'</code></pre> \n<ul> \n <li>这台主机显示为24，从26的负载来看，目前处理的任务需要排队了，这就是为什么负载标红的原因。同时，这里列举一下，如何查看CPU情况</li> \n</ul> \n<pre><code>总逻辑CPU数 = 物理CPU个数 X 每颗物理CPU的核数 X 超线程数\n# 物理CPU个数（我们的服务器是2个）\ncat /proc/cpuinfo| grep \"physical id\"| sort| uniq| wc -l\n\n\n# 查看每个物理CPU中core的个数(就是核数)（6核）\ncat /proc/cpuinfo| grep \"cpu cores\"| uniq\n\n# 查看逻辑CPU的个数\ncat /proc/cpuinfo| grep \"processor\"| wc -l\n（显示24，不等于上面的cpu个数 * 每个cpu的核数，说明是开启了超线程）</code></pre> \n<p>###### 二、观察集群在 \"忙什么\"</p> \n<ul> \n <li>通过tasks api可以直观的 观察到集群在忙什么？，包括父级任务，任务的持续时间等指标。命令如下：</li> \n</ul> \n<pre><code>curl -u username:pwd ip:port/_cat/tasks/?v | more</code></pre> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/ea419657-9ae8-49ac-bf4b-fec708ee9227.jpeg\" alt=\"file\"></p> \n<ul> \n <li>上面是我把副本设置为0后截的图。理论上还应该有一个bulk[s][r] 操作。可以看到目前写入很耗时，正常情况一批bulk操作应该是毫秒级的，这也从侧面说明了es的负载很高。<br> 从task_id、parent_task_id可以看出，一个bulk操作下面分为写主分片的动作 和写副本的动作。其中：<br> indices:data/write/bulk[s][p]：s表示分片，p表示主分片。<br> indices:data/write/bulk[s][r]：s表示分片，r表示副本。</li> \n</ul> \n<h5 id=\"简易的写入流程\">简易的写入流程</h5> \n<ul> \n <li>如下是bulk请求的简易写入流程，我们知道客户端会选择一个节点发送请求，这个节点被之称为协调节点，也叫客户端节点，但是在执行之前，如果定义了预处理的pipline操作（比如写入前将key值转换，或者增加时间戳等），则此写操作会被拦截并进行对应逻辑处理。 \n  <ul> \n   <li>从图中可以看出，写入操作会现根据路由出来的规则，决定发送数据到那个分片上去，默认情况下，是通过数据的文档id来进行路由的，这能保证数据平均分配到各个节点上去，也可以自定义路由规则，具体定义方式我们在下面会讲到。</li> \n   <li>接着，请求发送到了主分片上，主分片执行成功后，会将请求再转发给相应的副本分片，在副本分片上执行成功后，这个请求才算是执行完毕，然后将执行结果返回给客户端。</li> \n   <li>可以看出多副本在写多读少的场景下，十分的消耗性能，近似的，多了几个副本就相当于重复写了几份数据。如果不考虑数据容灾，则可以适当的降低副本数量，或者去掉副本，提高写入速度。<br> 在我们的集群里面并没有用到ingest角色类型的节点，这里提出来说也是为了便于大家更好理解各个节点的角色分工。</li> \n  </ul></li> \n</ul> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/8bd2113c-8b6f-45ee-8a7f-1e69805372b3.jpeg\" alt=\"file\"></p> \n<pre><code>- 通过ES提供的API观察各个节点的热线程，api结果会显示出占用cpu高的线程，这也是我们可以优化的地方。大量写入场景下，这里一般大多数会显示：Lucene Merge Thread 或者[write]，查询命令为：</code></pre> \n<p>GET /_nodes/hot_threads</p> \n<h5 id=\"三观察集群线程池状态\">三、观察集群线程池状态</h5> \n<ul> \n <li>避免大量写入被拒绝，可以通过观察elasticsearch后台日志或是通过使用Thread pool Api来观察内部线程池的使用情况，以及相应使用的队列大小，判断是否还可以继续调整写入配置参数。</li> \n</ul> \n<pre><code>curl -uusername:pwd-XGET \"http://esip:port/_cat/thread_pool?v\" | grep write</code></pre> \n<p>写入负载高的情况下，可能会出现大量拒绝，如下：</p> \n<table> \n <thead> \n  <tr class=\"header\"> \n   <th>node-name</th> \n   <th>name</th> \n   <th>active</th> \n   <th>queue</th> \n  </tr> \n </thead> \n <tbody> \n  <tr class=\"odd\"> \n   <td>node-3</td> \n   <td>write</td> \n   <td>4</td> \n   <td>0</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>node-1</td> \n   <td>write</td> \n   <td>3</td> \n   <td>2</td> \n  </tr> \n  <tr class=\"odd\"> \n   <td>node-2</td> \n   <td>write</td> \n   <td>9</td> \n   <td>1</td> \n  </tr> \n </tbody> \n</table> \n<h5 id=\"主机部分\">主机部分</h5> \n<h6 id=\"每个目录挂载不同的磁盘\">每个目录挂载不同的磁盘</h6> \n<ul> \n <li>在data目录下，我们分出了10个子目录，分别挂载到不同的硬盘上去。这相当于做了raid0。能大大的提高写入速度。</li> \n</ul> \n<p>###### 配置多个path.data</p> \n<ul> \n <li>由于在前面我们将10个目录分别挂载到不同的硬盘上去，所以在elasticsearch.yml的path.data属性中，我们配置多个路径，让数据能高效的写入不同的目录（硬盘），需要注意的是，如果只有一个索引，它的分片在某个节点的存储目录是固定的。所以这个特性，也只有在存在多个索引的情况下，能发挥出它的作用。</li> \n</ul> \n<p>###### 一个主机启动两个节点</p> \n<ul> \n <li>es实例分配内存不会超过32G,对于主机数量固定的我们,如果125G的机器只放一个es节点，实属有点浪费，所以考虑在主机上启动两个es节点实例。<br> 配置上需要注意关注以下几点：<br> - 1、http的端口、节点间通信的trasport端口设置。<br> - 2、节点的角色分配。<br> - 3、脑裂配置对应修改。<br> - 4、path.data属性修改（重要）<br> - 5、path.logs属性修改。</li> \n</ul> \n<p>###### 修改path.data配置，使同一主机两个节点均分硬盘<br> - 这里着重说一下第4点，同一个主机启动两个实例后，我们将path.data配置从原来的10个目录改为了各自配置5个不同目录。</p> \n<pre><code>path.data: /data01/esdata,/data02/esdata,/data03/esdata\n,/data04/esdata,/data05/esdata</code></pre> \n<ul> \n <li>一方面是 能够控制分片的分配，避免太多分片分配到一台主机上的其中一个节点上。另一方面是避免两个es进程对同一磁盘进行写入。随机写造成的磁头非常频繁的大面积移动肯定比单进程的顺序写入慢，这也是我们提高写入速度的初衷。</li> \n</ul> \n<p>###### 更换ssd<br> - ssd能成倍的提高写入速度，如果使用ssd，可能就不会折腾这篇文章出来了。</p> \n<h5 id=\"elasticsearch部分\">elasticsearch部分</h5> \n<h6 id=\"节点角色的设置\">节点角色的设置</h6> \n<ul> \n <li>elasticsearch提供几种类型的节点角色设置，需要在elasticsearch.yml配置中指定。<br> 类型。<br> <img src=\"http://localhost:9090/blogImages/2019/10/11/7d180f06-7d40-40e4-9c28-c993b719527e.jpeg\" alt=\"file\"></li> \n</ul> \n<p>###### 指定索引模板<br> 可以根据需要修改，具体配置含义不再细说。</p> \n<pre><code>{\n  \"order\": 0,\n  \"index_patterns\": [\n    \"topicA*\"\n  ],\n  \"settings\": {\n    \"index\": {\n      \"refresh_interval\": \"40s\",\n      \"number_of_shards\": \"30\",\n      \"translog\": {\n        \"flush_threshold_size\": \"1024mb\",\n        \"sync_interval\": \"120s\",\n        \"durability\": \"async\"\n      },\n      \"number_of_replicas\": \"0\",\n      \"merge\": {\n        \"scheduler\": {\n          \"max_thread_count\": \"1\"\n        }\n      }\n    }\n  },\n  \"mappings\": {\n  },\n  \"aliases\": {}\n}</code></pre> \n<h6 id=\"计算分片数\">计算分片数</h6> \n<ul> \n <li>需要注意分片数量最好设置为节点数的整数倍，保证每一个主机的负载是差不多一样的，特别如果是一个主机部署多个实例的情况，更要注意这一点，否则可能遇到其他主机负载正常，就某个主机负载特别高的情况。<br> 一般我们根据每天的数据量来计算分片，保持每个分片的大小在50G以下比较合理。如果还不能满足要求，那么可能需要在索引层面通过拆分更多的索引或者通过别名+按小时 创建索引的方式来实现了。</li> \n</ul> \n<h6 id=\"控制分片均分在各个主机上\">控制分片均分在各个主机上</h6> \n<ul> \n <li>以TopicA数据的一个索引为例，共30个分片，在10个节点上分配，应该每个节点分配3个分片，一个主机上一共有6个分片才算是均衡。如果分配不是这样，可以使用cerebo或者通过命令行进行分片迁移。</li> \n</ul> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/7ef99cb2-1688-4538-a3b9-808785575e51.jpeg\" alt=\"file\"><br> <img src=\"http://localhost:9090/blogImages/2019/10/11/32e57939-c34f-44cd-8357-8ba98d690db9.jpeg\" alt=\"file\"></p> \n<pre><code>curl -X POST \"localhost:9200/_cluster/reroute?pretty\" -H \'Content-Type: application/json\' -d\'\n{\n    \"commands\" : [\n        {\n            \"move\" : {\n                \"index\" : \"test\", \"shard\" : 0,\n                \"from_node\" : \"node1\", \"to_node\" : \"node2\"\n            }\n        }\n    ]\n}</code></pre> \n<h6 id=\"配置索引缓冲区\">配置索引缓冲区</h6> \n<ul> \n <li>即是指定 indices.memory.index_buffer_size的大小，这个是一个静态变量，需要修改配置文件，重启后才能生效。<br> 参考的计算公式：indices.memory.index_buffer_size / shards_count &gt; 512MB（超过这个值索引性能并不会有太明显提高）<br> shards_count为一个节点上面的分片数量，可以配置具体指或者一个占用Es内存总值的百分比。这里我们修改成了20%（默认10%）。</li> \n</ul> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/ddc280a2-6678-48ba-96cf-15dd8f895c77.jpeg\" alt=\"file\"></p> \n<h6 id=\"路由分片\">路由分片</h6> \n<ul> \n <li>可以使用elasticsearch提供的routing特性，将数据按一定规则计算后(内部采用hash算法，把相同hash值的文档放入同一个分片中)，默认情况下是使用DocId来计算，写入到分片，查询时指定routing查询，则可以提高查询速度，避免了扫描过多的分片带来的性能开销。首先，在创建索引模板的时候，需要在mappings中增加配置,要求匹配到此索引模板的索引，必须配置routing：</li> \n</ul> \n<pre><code>\"_routing\": {      \n    \"required\": true\n  }</code></pre> \n<p>第二步、为BulkPorcess创建IndexRequest时，通过routing(java.lang.String routing) 方法指定参与计算hash的值。<br> 注意这里是具体的值，而不是字段名称。</p> \n<p>经过如上的调优配置，三个Topic数据都能正常写入，集群文档总数在170亿，33个索引，每个索引保留4天，242个分片，整体负载不高。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/5d233736-6fb9-4e77-9876-4e78dbfc9b81.jpeg\" alt=\"file\"></p> \n<h6 id=\"踩过的坑\">踩过的坑</h6> \n<h6 id=\"节点角色的设置方面\">1、节点角色的设置方面</h6> \n<ul> \n <li>如果集群中节点数量不多，并且不需要对数据进行预处理，那么其实可以放弃使用Ingest类型的节点。默认情况下所有的节点的默认设置都为true。所以我们手动将主节点和数据节点做如下设置<br> node.ingest: false</li> \n</ul> \n<p>但是需要注意一点，x-pack监控用到了这种类型的节点。会如下错误：<br> failed to flush export bulks 、no ingest node<br> 解决办法是，打开这个属性配置，或者elasticsearch.yml中指定：<br> xpack.monitoring.exporters.my_local: type:<br> xpack.monitoring.exporters.local use_ingest: false</p> \n<h6 id=\"elasticsearch-线程池相关配置参数改变\">2、elasticsearch 线程池相关配置参数改变</h6> \n<ul> \n <li>从5.0版本以后，禁止了修改各个模块线程池的类型，线程池相关配置的前缀从threadpool 变成了thread_pool.并且线程池相关配置级别上升至节点级配置，禁止通过使用API修改，因为场景是写多读少，所以我们只是增加了写队列的大小，配置为： thread_pool.write.queue_size: 1000。<br> 只能通过修改配置文件的方式修改。</li> \n</ul> \n<h6 id=\"单台主机负载过高\">3、单台主机负载过高</h6> \n<ul> \n <li>同一个主机两个节点都是数据节点，并且分片分配不均匀，导致这个主机CPU使用率在98%左右，后面通过迁移分片的方式将负载降低。</li> \n</ul> \n<h6 id=\"使用自定义的routing规则后带来的写热点问题\">4、使用自定义的routing规则后带来的写热点问题</h6> \n<ul> \n <li>比如按省份分的数据， 省份为北京的数据过多，西藏的数据很少，可能会带来写热点问题。所以合理的路由分配同样很重要。</li> \n</ul> \n<h6 id=\"数据时区差8小时问题\">5、数据时区差8小时问题</h6> \n<ul> \n <li>将业务时间转换为带时区的字符串。yyyy-MM-dd\'T\'HH:mm:ss.SSSZ</li> \n</ul> \n<h5 id=\"参考文章\">参考文章：</h5> \n<p><a href=\"http://kane-xie.github.io/2017/09/09/2017-09-09_Elasticsearch%E5%86%99%E5%85%A5%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96/\">http://kane-xie.github.io/2017/09/09/2017-09-09_Elasticsearch%E5%86%99%E5%85%A5%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96/</a><br> <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/5.0/breaking_50_settings_changes.html\" class=\"uri\">https://www.elastic.co/guide/en/elasticsearch/reference/5.0/breaking_50_settings_changes.html</a><br> <a href=\"https://elasticsearch.cn/question/1915\" class=\"uri\">https://elasticsearch.cn/question/1915</a><br> <a href=\"https://juejin.im/entry/5d0f17cce51d454d544abf7f\" class=\"uri\">https://juejin.im/entry/5d0f17cce51d454d544abf7f</a></p> \n<p>​</p> \n<blockquote> \n <p>欢迎来公众号【侠梦的开发笔记】 一起交流进步</p> \n</blockquote>', NULL, '2019-10-11 15:25:30', 4, NULL, NULL, 'https://www.cnblogs.com/hyq0823/p/11653299.html', 0, NULL);
INSERT INTO `t_blog` VALUES (235, 'Java 从入门到进阶之路（七）', '<p>在之前的文章中我们介绍了一下 java 中的对象和类，接下来我们来看一下 Java 中的方法重载。</p> \n<p>在显示生活中，我们肯定会遇到这样一个问题，那就是我们再商场买东西的时候在付账时的选择。如下</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/8c2a8f52-a376-4ab2-80b9-4d689b360098.jpeg\" alt=\"\" width=\"290\" height=\"283\"></p> \n<p>A：在收银台处设三个窗口，分别满足现金，手机，刷卡三种形式的付款。</p> \n<p>B：可以设置一个窗口，这个窗口满足以上三种付款方式。</p> \n<p>对于消费者和商场而言，B 方案无疑比 A 方案更好，商场可以减少雇佣员工和占地，消费者不必去刻意选择支付方式。</p> \n<p>在代码的世界里，以上三种支付方式其实都是程序的运行，我们可以将上面的支付方式写成一个 pay( ) 方法，</p> \n<p>但是如果我们根据类型来区分支付方法，比如 payByMoney( )，payByPhone( )，payByCard( )，要是再有其他的支付方式我们还需要增加其他方法，比如还可以使用支票付款，手机付款又可以分为支付宝，微信，云闪付等等，那么对于代码的维护性和扩展性看来说很不友好，于是乎我们就可以利用重载来解决上面的问题。</p> \n<p>&nbsp;</p> \n<p>Java 重载(overloading) 是在一个类里面，方法名字相同，而参数不同。返回类型可以相同也可以不同。</p> \n<p>每个重载的方法（或者构造函数）都必须有一个独一无二的参数类型列表。</p> \n<p>最常用的地方就是构造器的重载。</p> \n<p><strong>重载规则:</strong></p> \n<ul> \n <li>被重载的方法必须改变参数列表(参数个数或类型不一样)；</li> \n <li>被重载的方法可以改变返回类型；</li> \n <li>被重载的方法可以改变访问修饰符；</li> \n <li>被重载的方法可以声明新的或更广的检查异常；</li> \n <li>方法能够在同一个类中或者在一个子类中被重载。</li> \n <li>无法以返回值类型作为重载函数的区分标准。</li> \n</ul> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\"> 1</span> <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> HelloWorld {\r\n</span><span style=\"color: #008080;\"> 2</span>     <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> main(String[] args) {\r\n</span><span style=\"color: #008080;\"> 3</span>         Aoo aoo = <span style=\"color: #0000ff;\">new</span> Aoo(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 创建一个 Aoo 对象</span>\r\n<span style=\"color: #008080;\"> 4</span>         aoo.foo(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> foo 无参</span>\r\n<span style=\"color: #008080;\"> 5</span>         aoo.foo(123); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> foo 整型参数123</span>\r\n<span style=\"color: #008080;\"> 6</span>         aoo.foo(\"abc\"); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> foo 字符串参数zhangsan</span>\r\n<span style=\"color: #008080;\"> 7</span>         aoo.foo(\"abc\",123); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> foo 字符串+整型参数abc123</span>\r\n<span style=\"color: #008080;\"> 8</span>         aoo.foo(123,\"abc\"); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> foo foo 整型+字符串参数123abc</span>\r\n<span style=\"color: #008080;\"> 9</span> <span style=\"color: #000000;\">    }\r\n</span><span style=\"color: #008080;\">10</span> <span style=\"color: #000000;\">}\r\n</span><span style=\"color: #008080;\">11</span> \r\n<span style=\"color: #008080;\">12</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> Aoo {\r\n</span><span style=\"color: #008080;\">13</span>     <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> foo() {\r\n</span><span style=\"color: #008080;\">14</span>         System.out.println(\"foo 无参\"<span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\">15</span> <span style=\"color: #000000;\">    }\r\n</span><span style=\"color: #008080;\">16</span> \r\n<span style=\"color: #008080;\">17</span>     <span style=\"color: #0000ff;\">void</span> foo(<span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> num) {\r\n</span><span style=\"color: #008080;\">18</span>         System.out.println(\"foo 整型参数\" +<span style=\"color: #000000;\"> num);\r\n</span><span style=\"color: #008080;\">19</span> <span style=\"color: #000000;\">    }\r\n</span><span style=\"color: #008080;\">20</span> \r\n<span style=\"color: #008080;\">21</span>     <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> foo(String str) {\r\n</span><span style=\"color: #008080;\">22</span>         System.out.println(\"foo 字符串参数\" +<span style=\"color: #000000;\"> str);\r\n</span><span style=\"color: #008080;\">23</span> <span style=\"color: #000000;\">    }\r\n</span><span style=\"color: #008080;\">24</span> \r\n<span style=\"color: #008080;\">25</span>     <span style=\"color: #0000ff;\">void</span> foo(String str, <span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> num) {\r\n</span><span style=\"color: #008080;\">26</span>         System.out.println(\"foo 字符串+整型参数\" + str +<span style=\"color: #000000;\"> num);\r\n</span><span style=\"color: #008080;\">27</span> <span style=\"color: #000000;\">    }\r\n</span><span style=\"color: #008080;\">28</span> \r\n<span style=\"color: #008080;\">29</span>     <span style=\"color: #0000ff;\">void</span> foo(<span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> num, String str) {\r\n</span><span style=\"color: #008080;\">30</span>         System.out.println(\"foo 整型+字符串参数\" + num +<span style=\"color: #000000;\"> str);\r\n</span><span style=\"color: #008080;\">31</span> <span style=\"color: #000000;\">    }\r\n</span><span style=\"color: #008080;\">32</span> }</pre> \n</div> \n<p>在上面的代码中，我们定义了一个 Aoo 的类，在 Aoo 类里有一个 foo( ) 方法，我们通过向 foo( ) 内传入不同的参数，在调用时传入不同的蚕食，编译器会自动根据其参数的不同，绑定到不同的方法。这样我们就可以解决上面的支付问题，向 pay( ) 方法中传入不同的参数来判断不同的支付方式，当然支付是一个比较复杂的方法，这里就不做演示了。</p> \n<p>&nbsp;</p>', NULL, '2019-10-11 15:25:31', 4, NULL, NULL, 'https://www.cnblogs.com/weijiutao/p/11096097.html', 0, NULL);
INSERT INTO `t_blog` VALUES (236, 'SpringCache - 请求级别缓存的简易实现', '<div id=\"write\" class=\"is-node\"> \n <h2><a class=\"md-header-anchor\" name=\"前言\"></a><span>前言</span></h2> \n <p><span>在</span><a href=\"https://www.cnblogs.com/imyijie/p/6518547.html\"><span>SpringCache缓存初探</span></a><span>中我们研究了如何利用spring cache已有的几种实现快速地满足我们对于缓存的需求。这一次我们有了新的更个性化的需求，<strong>想在一个请求的生命周期里实现缓存</strong>。</span></p> \n <p><span>需求背景是：一次数据的组装需要调用多个方法，然而在这多个方法里又会调用同一个IO接口，此时多浪费了一次IO的资源。首先想到的解决方案是将这次IO接口提出来调用，然后将结果作为参数传递到多个方法中，但是这样一来，每个调用这些方法的地方都得添加额外的代码。那么第二个方案就是，我们还是分别调用，只不过将这个结果缓存起来，就像我们之前做的那样。</span></p> \n <p><span>这时候问题来了，这个数据结果我们希望尽可能实时，即使只缓存了一秒，导致在不同的请求里用了同一份数据也不太好。看来不得不自己实现一个只保持在一次请求过程中的缓存了。</span></p> \n <h2><a class=\"md-header-anchor\" name=\"方案分析\"></a><span>方案分析</span></h2> \n <p><span>要将数据缓存在一次请求周期内，那我们先得区分是什么环境下的请求，以分析我们如何存储数据。</span></p> \n <h3><a class=\"md-header-anchor\" name=\"1-web\"></a><span>1. Web</span></h3> \n <p><span>Web环境下的有个绝佳的数据存储位置 </span><code>HttpServletRequest</code><span>的</span><code>Attribute</code><span> 。调用</span><code>setAttribute</code><span>和</span><code>getAttribute</code><span>方法就能轻易地将我们的数据用key-value的形式存储在请求上，而且每次请求都自动拥有一个干净的</span><code>Request</code><span> 。想要获取到</span><code>HttpServletRequest</code><span> 也非常简单，在web请求中随时随地调用</span><code>((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest()</code><span> 即可。</span></p> \n <h3><a class=\"md-header-anchor\" name=\"2-rpc框架\"></a><span>2. RPC框架</span></h3> \n <p><span>我司所使用的rpc框架是基于finagle自研的，对外提供服务时使用线程池进行处理请求，即对于一次完整的请求，会使用同一个线程进行处理。首先想到的办法还是改动这个rpc框架服务端，增加一个可以对外暴露的、可以key-value存储的请求上下文。为了能在方便的地方获取到这个请求上下文，得将其存储在</span><code>ThreadLocal</code><span>中。 </span></p> \n <hr> \n <p><span>综合这两种环境考虑，我们最好还是实现一个统一的方案以减少维护和开发成本。Spring的</span><code>RequestContextHolder.getRequestAttributes()</code><span>其实也是使用</span><code>ThreadLocal</code><span>来实现的，那我们可以<strong>统一将数据存到</strong></span><strong><code>ThreadLocal&lt;Map&lt;Object,Object&gt;&gt;</code></strong><span><strong>，自己来维护缓存的清理</strong>。</span></p> \n <p><span>存储位置有了，接下来实现SpringCache思路就比较清晰了。 </span></p> \n <h2><a class=\"md-header-anchor\" name=\"实现springcache\"></a><span>实现SpringCache</span></h2> \n <p><span> 要实现SpringCache需要一个CacheManager，接口定义如下</span></p> \n <div class=\"CodeMirror cm-s-inner CodeMirror-wrap\" lang=\"java\"> \n  <div style=\"overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-scrollbar-filler\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-gutter-filler\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-scroll\"> \n   <div class=\"CodeMirror-sizer\" style=\"margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;\"> \n    <div style=\"position: relative; top: 0px;\"> \n     <div class=\"CodeMirror-lines\"> \n      <div style=\"position: relative; outline: none;\"> \n       <div class=\"CodeMirror-measure\"> \n        <pre><span>xxxxxxxxxx</span></pre> \n       </div> \n       <div class=\"CodeMirror-measure\">\n        &nbsp;\n       </div> \n       <div style=\"position: relative; z-index: 1;\">\n        &nbsp;\n       </div> \n       <div class=\"CodeMirror-code\"> \n        <div class=\"CodeMirror-activeline\" style=\"position: relative;\"> \n         <div class=\"CodeMirror-activeline-background CodeMirror-linebackground\">\n          &nbsp;\n         </div> \n         <div class=\"CodeMirror-gutter-background CodeMirror-activeline-gutter\" style=\"left: 0px; width: 0px;\">\n          &nbsp;\n         </div> \n         <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"><span class=\"cm-keyword\">public</span> <span class=\"cm-keyword\">interface</span> <span class=\"cm-def\">CacheManager</span> { &nbsp; &nbsp;</span></pre> \n        </div> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=\"cm-variable\">Cache</span> <span class=\"cm-variable\">getCache</span>(<span class=\"cm-variable-3\">String</span> <span class=\"cm-variable\">name</span>); </span></pre> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=\"cm-variable\">Collection</span><span class=\"cm-operator\">&lt;</span><span class=\"cm-variable-3\">String</span><span class=\"cm-operator\">&gt;</span> <span class=\"cm-variable\">getCacheNames</span>();</span></pre> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\">}</span></pre> \n       </div> \n      </div> \n     </div> \n    </div> \n   </div> \n   <div style=\"position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;\">\n    &nbsp;\n   </div> \n   <div class=\"CodeMirror-gutters\" style=\"display: none; height: 92px;\">\n    &nbsp;\n   </div> \n  </div> \n </div> \n <p><span>可以看到其实只需要实现Cache接口就行了。</span> <span>在上一篇文章中提到的</span><code>SimpleCacheManager</code><span>，它的Cache实现</span><code>ConcurrentMapCache</code><span>内部的存储是依赖</span><code>ConcurrentMap&lt;Object, Object&gt;</code><span>。我们的实现跟它非常类似，最主要的不同是我们需要使用</span><code>ThreadLocal&lt;Map&lt;Object, Object&gt;&gt;</code> <span>下面给出几处关键的实现，其他部分简单看下</span><code>ConcurrentMapCache</code><span>就能明白。</span></p> \n <h3><a class=\"md-header-anchor\" name=\"1-extends\"></a><span>1 extends</span>&nbsp;&nbsp;</h3> \n <p>我们选择不直接继承Cache而是<code>AbstractValueAdaptingCache</code>，其被大多数缓存实现所继承，它的作用主要是包装value值以区分是没有命中缓存还是缓存的null值。</p> \n <h3><a class=\"md-header-anchor\" name=\"2-store\"></a><span>2 store</span></h3> \n <div class=\"CodeMirror cm-s-inner CodeMirror-wrap\" lang=\"java\"> \n  <div style=\"overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-scrollbar-filler\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-gutter-filler\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-scroll\"> \n   <div class=\"CodeMirror-sizer\" style=\"margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;\"> \n    <div style=\"position: relative; top: 0px;\"> \n     <div class=\"CodeMirror-lines\"> \n      <div style=\"position: relative; outline: none;\"> \n       <div class=\"CodeMirror-measure\"> \n        <pre><span>xxxxxxxxxx</span></pre> \n       </div> \n       <div class=\"CodeMirror-measure\">\n        &nbsp;\n       </div> \n       <div style=\"position: relative; z-index: 1;\">\n        &nbsp;\n       </div> \n       <div class=\"CodeMirror-code\"> \n        <div class=\"CodeMirror-activeline\" style=\"position: relative;\"> \n         <div class=\"CodeMirror-activeline-background CodeMirror-linebackground\">\n          &nbsp;\n         </div> \n         <div class=\"CodeMirror-gutter-background CodeMirror-activeline-gutter\" style=\"left: 0px; width: 0px;\">\n          &nbsp;\n         </div> \n         <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"><span class=\"cm-keyword\">private</span> <span class=\"cm-keyword\">final</span> <span class=\"cm-variable\">ThreadLocal</span><span class=\"cm-operator\">&lt;</span><span class=\"cm-variable\">Map</span><span class=\"cm-operator\">&lt;</span><span class=\"cm-variable-3\">Object</span>, <span class=\"cm-variable-3\">Object</span><span class=\"cm-operator\">&gt;&gt;</span> <span class=\"cm-variable\">store</span> <span class=\"cm-operator\">=</span> <span class=\"cm-variable\">ThreadLocal</span>.<span class=\"cm-variable\">withInitial</span>(() <span class=\"cm-operator\">-&gt;</span> <span class=\"cm-keyword\">new</span> <span class=\"cm-variable\">HashMap</span><span class=\"cm-operator\">&lt;&gt;</span>(<span class=\"cm-number\">128</span>));</span></pre> \n        </div> \n       </div> \n      </div> \n     </div> \n    </div> \n   </div> \n   <div style=\"position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;\">\n    &nbsp;\n   </div> \n   <div class=\"CodeMirror-gutters\" style=\"display: none; height: 46px;\">\n    &nbsp;\n   </div> \n  </div> \n </div> \n <p><span>我们的缓存数据存储的地方，</span><code>ThreadLocal</code><span>保证缓存只会存在于这一个线程中。同时又因为只有一个线程能够访问，我们简单地使用</span><code>HashMap</code><span>即可。</span>&nbsp;</p> \n <h3><a class=\"md-header-anchor\" name=\"4-get\"></a><span>3 get</span></h3> \n <div class=\"CodeMirror cm-s-inner CodeMirror-wrap\" lang=\"java\"> \n  <div style=\"overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-scrollbar-filler\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-gutter-filler\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-scroll\"> \n   <div class=\"CodeMirror-sizer\" style=\"margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;\"> \n    <div style=\"position: relative; top: 0px;\"> \n     <div class=\"CodeMirror-lines\"> \n      <div style=\"position: relative; outline: none;\"> \n       <div class=\"CodeMirror-measure\"> \n        <pre><span>xxxxxxxxxx</span></pre> \n       </div> \n       <div class=\"CodeMirror-measure\">\n        &nbsp;\n       </div> \n       <div style=\"position: relative; z-index: 1;\">\n        &nbsp;\n       </div> \n       <div class=\"CodeMirror-code\"> \n        <div class=\"CodeMirror-activeline\" style=\"position: relative;\"> \n         <div class=\"CodeMirror-activeline-background CodeMirror-linebackground\">\n          &nbsp;\n         </div> \n         <div class=\"CodeMirror-gutter-background CodeMirror-activeline-gutter\" style=\"left: 0px; width: 0px;\">\n          &nbsp;\n         </div> \n         <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"><span class=\"cm-keyword\">public</span> <span class=\"cm-operator\">&lt;</span><span class=\"cm-variable\">T</span><span class=\"cm-operator\">&gt;</span> <span class=\"cm-variable\">T</span> <span class=\"cm-def\">get</span>(<span class=\"cm-variable-3\">Object</span> <span class=\"cm-variable\">key</span>, <span class=\"cm-variable\">Callable</span><span class=\"cm-operator\">&lt;</span><span class=\"cm-variable\">T</span><span class=\"cm-operator\">&gt;</span> <span class=\"cm-variable\">valueLoader</span>) {</span></pre> \n        </div> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp;<span class=\"cm-keyword\">return</span> (<span class=\"cm-variable\">T</span>) <span class=\"cm-variable\">fromStoreValue</span>(<span class=\"cm-keyword\">this</span>.<span class=\"cm-variable\">store</span>.<span class=\"cm-variable\">get</span>().<span class=\"cm-variable\">computeIfAbsent</span>(<span class=\"cm-variable\">key</span>, <span class=\"cm-variable\">r</span> <span class=\"cm-operator\">-&gt;</span> { &nbsp; &nbsp; &nbsp; &nbsp;</span></pre> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp; &nbsp; &nbsp;<span class=\"cm-keyword\">try</span> { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class=\"cm-keyword\">return</span> <span class=\"cm-variable\">toStoreValue</span>(<span class=\"cm-variable\">valueLoader</span>.<span class=\"cm-variable\">call</span>()); &nbsp; &nbsp; &nbsp; &nbsp;</span></pre> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp; &nbsp;  } <span class=\"cm-keyword\">catch</span> (<span class=\"cm-variable\">Throwable</span> <span class=\"cm-variable\">ex</span>) { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class=\"cm-keyword\">throw</span> <span class=\"cm-keyword\">new</span> <span class=\"cm-variable\">ValueRetrievalException</span>(<span class=\"cm-variable\">key</span>, <span class=\"cm-variable\">valueLoader</span>, <span class=\"cm-variable\">ex</span>); &nbsp; &nbsp; </span></pre> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp; &nbsp;  } &nbsp;</span></pre> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp; }));</span></pre> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> }</span>&nbsp;&nbsp;&nbsp;</pre> \n       </div> \n      </div> \n     </div> \n    </div> \n   </div> \n  </div> \n </div> \n <hr> \n <p><span>至此我们即将大功告成，只差一个步骤，</span><code>ThreadLocal</code><span>的清理：使用</span><code>AOP</code><span>实现即可。</span></p> \n <div class=\"CodeMirror cm-s-inner CodeMirror-wrap\" lang=\"java\"> \n  <div style=\"overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-scrollbar-filler\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-gutter-filler\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-scroll\"> \n   <div class=\"CodeMirror-sizer\" style=\"margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;\"> \n    <div style=\"position: relative; top: 0px;\"> \n     <div class=\"CodeMirror-lines\"> \n      <div style=\"position: relative; outline: none;\"> \n       <div class=\"CodeMirror-measure\"> \n        <pre><span>xxxxxxxxxx</span></pre> \n       </div> \n       <div class=\"CodeMirror-measure\">\n        &nbsp;\n       </div> \n       <div style=\"position: relative; z-index: 1;\">\n        &nbsp;\n       </div> \n       <div class=\"CodeMirror-code\"> \n        <div class=\"CodeMirror-activeline\" style=\"position: relative;\"> \n         <div class=\"CodeMirror-activeline-background CodeMirror-linebackground\">\n          &nbsp;\n         </div> \n         <div class=\"CodeMirror-gutter-background CodeMirror-activeline-gutter\" style=\"left: 0px; width: 0px;\">\n          &nbsp;\n         </div> \n         <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp;<span class=\"cm-meta\">@After</span>(<span class=\"cm-string\">\"bean(server)\"</span>)</span></pre> \n        </div> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp;<span class=\"cm-keyword\">public</span> <span class=\"cm-variable-3\">void</span> <span class=\"cm-def\">clearThreadCache</span>() {</span></pre> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp; &nbsp; &nbsp; &nbsp;<span class=\"cm-variable\">threadCacheManager</span>.<span class=\"cm-variable\">clear</span>();</span></pre> \n        <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"> &nbsp;  }</span></pre> \n       </div> \n      </div> \n     </div> \n    </div> \n   </div> \n   <div style=\"position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;\">\n    &nbsp;\n   </div> \n   <div class=\"CodeMirror-gutters\" style=\"display: none; height: 92px;\">\n    &nbsp;\n   </div> \n  </div> \n </div> \n <p><span>记得将Cache的</span><code>clear</code><span>方法通过我们自定义的</span><code>CacheManager</code><span>暴露出来。同时也要确保切面能覆盖每个请求的结束。</span></p> \n <h2><a class=\"md-header-anchor\" name=\"总结与扩展\"></a><span>总结与扩展</span></h2> \n <p><span>从以上一个简单的</span><code>ThreadLocalCacheManager</code><span>实现，我们对</span><code>CacheManager</code><span>又有了更多的理解。</span></p> \n <p><span>同时可能也会有更多的疑问。</span></p> \n <h3><a class=\"md-header-anchor\" name=\"1-我们实现的这些方法从方法名和逻辑上看起来都很简单那他们是如何配合使用的跟cacheable上的sync又有什么关系呢\"></a><span>1. 我们实现的这些方法，从方法名和逻辑上看起来都很简单，那他们是如何配合使用的？跟@Cacheable上的sync又有什么关系呢？</span></h3> \n <p><span>再回顾Spring Cache为我们提供的</span><code>@Cacheable</code><span>中的</span><code>sync</code><span>的注释，它提到此功能的作用是: 同步化对被注解方法的调用，使得多个线程试图调用此方法时，只有一个线程能够成功调用，其他线程直接取这次调用的返回值。同时也提到这仅仅只是个</span><code>hint</code><span>，是否真的能成还是要看缓存提供者。</span></p> \n <p><span>我们找到Spring Cache处理缓存调用的关键方法</span><code>org.springframework.cache.interceptor.CacheAspectSupport#execute(org.springframework.cache.interceptor.CacheOperationInvoker, java.lang.reflect.Method, org.springframework.cache.interceptor.CacheAspectSupport.CacheOperationContexts)</code><span> (spring-context-5.1.5.RELEASE)</span></p> \n <p><span>经过分析，当</span><code>sync = true</code><span> 时, 只会调用如下代码</span></p> \n <div class=\"CodeMirror cm-s-inner CodeMirror-wrap\" lang=\"java\"> \n  <div style=\"overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-scrollbar-filler\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-gutter-filler\">\n   &nbsp;\n  </div> \n  <div class=\"CodeMirror-scroll\"> \n   <div class=\"CodeMirror-sizer\" style=\"margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;\"> \n    <div style=\"position: relative; top: 0px;\"> \n     <div class=\"CodeMirror-lines\"> \n      <div style=\"position: relative; outline: none;\"> \n       <div class=\"CodeMirror-measure\"> \n        <pre><span>xxxxxxxxxx</span></pre> \n       </div> \n       <div class=\"CodeMirror-measure\">\n        &nbsp;\n       </div> \n       <div style=\"position: relative; z-index: 1;\">\n        &nbsp;\n       </div> \n       <div class=\"CodeMirror-code\"> \n        <div class=\"CodeMirror-activeline\" style=\"position: relative;\"> \n         <div class=\"CodeMirror-activeline-background CodeMirror-linebackground\">\n          &nbsp;\n         </div> \n         <div class=\"CodeMirror-gutter-background CodeMirror-activeline-gutter\" style=\"left: 0px; width: 0px;\">\n          &nbsp;\n         </div> \n         <pre class=\" CodeMirror-line \"><span style=\"padding-right: 0.1px;\"><span class=\"cm-keyword\">return</span> <span class=\"cm-variable\">wrapCacheValue</span>(<span class=\"cm-variable\">method</span>, <span class=\"cm-variable\">cache</span>.<span class=\"cm-variable\">get</span>(<span class=\"cm-variable\">key</span>, () <span class=\"cm-operator\">-&gt;</span> <span class=\"cm-variable\">unwrapReturnValue</span>(<span class=\"cm-variable\">invokeOperation</span>(<span class=\"cm-variable\">invoker</span>))))</span></pre> \n        </div> \n       </div> \n      </div> \n     </div> \n    </div> \n   </div> \n   <div style=\"position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;\">\n    &nbsp;\n   </div> \n   <div class=\"CodeMirror-gutters\" style=\"display: none; height: 46px;\">\n    &nbsp;\n   </div> \n  </div> \n </div> \n <p><span>即我们上文实现的</span><code>T get(Object key, Callable&lt;T&gt; valueLoader)</code><span> 方法，回头一看一切都清晰了。</span> <span>只要我们的</span><code>this.store.get().computeIfAbsent</code><span>是同步的，那这个</span><code>sync = true</code><span>就起作用了。</span> <span>当然我们这里使用的</span><code>HashMap</code><span>不支持，但是我们如果换成</span><code>ConcurrentMap</code><span>就能够实现同步化的功能。另外简单粗暴地让方法同步也是可以的（RedisCache就是这样做的）。</span></p> \n <p><span>当</span><code>sync = false</code><span>时，会组合Cache中其他的方法进行缓存的处理。逻辑较为简单清晰，自行阅读源码即可。</span></p> \n <h3><a class=\"md-header-anchor\" name=\"2-用threadlocal严格来说实现的只是线程内的缓存万一一次请求中有异步操作怎么办\"></a><span>2. 用ThreadLocal严格来说实现的只是线程内的缓存，万一一次请求中有异步操作怎么办？</span></h3> \n <p><span>异步操作分两种情况，直接创建线程或者使用线程池。对于第一种情况我们可以简单地使用</span><code>java.lang.InheritableThreadLocal</code><span> 来替代</span><code>ThreadLocal</code><span>，创建的子进程会自然而然地共享父进程的</span><code>InheritableThreadLocal</code><span>；第二种情况就相对比较复杂了，建议可以参考 </span><a href=\"\r\nhttps://github.com/alibaba/transmittable-thread-local\"> <span>alibaba/transmittable-thread-local</span></a><span> ，它实现了线程池下的</span><code>ThreadLocal</code><span>值传递功能。</span></p> \n <p>&nbsp;</p> \n</div> \n<style><!--\r\nhtml {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:\"Lucida Console\",Consolas,\"Courier\",monospace; }\r\nhtml { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }\r\nbody { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }\r\niframe { margin: auto; }\r\na.url { word-break: break-all; }\r\na:active, a:hover { outline: 0px; }\r\n.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }\r\n#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 40px; }\r\n#write.first-line-indent p { text-indent: 2em; }\r\n#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }\r\n#write.first-line-indent li { margin-left: 2em; }\r\n.for-image #write { padding-left: 8px; padding-right: 8px; }\r\nbody.typora-export { padding-left: 30px; padding-right: 30px; }\r\n.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }\r\n@media screen and (max-width: 500px) {\r\n  body.typora-export { padding-left: 0px; padding-right: 0px; }\r\n  #write { padding-left: 20px; padding-right: 20px; }\r\n  .CodeMirror-sizer { margin-left: 0px !important; }\r\n  .CodeMirror-gutters { display: none !important; }\r\n}\r\n#write li > figure:last-child { margin-bottom: 0.5rem; }\r\n#write ol, #write ul { position: relative; }\r\nimg { max-width: 100%; vertical-align: middle; }\r\nbutton, input, select, textarea { color: inherit; font: inherit; }\r\ninput[type=\"checkbox\"], input[type=\"radio\"] { line-height: normal; padding: 0px; }\r\n*, ::after, ::before { box-sizing: border-box; }\r\n#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }\r\n#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }\r\np { line-height: inherit; }\r\nh1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 2; }\r\np { orphans: 4; }\r\nh1 { font-size: 2rem; }\r\nh2 { font-size: 1.8rem; }\r\nh3 { font-size: 1.6rem; }\r\nh4 { font-size: 1.4rem; }\r\nh5 { font-size: 1.2rem; }\r\nh6 { font-size: 1rem; }\r\n.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }\r\n.hidden { display: none; }\r\n.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }\r\na { cursor: pointer; }\r\nsup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }\r\nsup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }\r\n#write input[type=\"checkbox\"] { cursor: pointer; width: inherit; height: inherit; }\r\nfigure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }\r\nfigure > table { margin: 0px !important; }\r\ntr { break-inside: avoid; break-after: auto; }\r\nthead { display: table-header-group; }\r\ntable { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }\r\ntable.md-table td { min-width: 32px; }\r\n.CodeMirror-gutters { border-right: 0px; background-color: inherit; }\r\n.CodeMirror-linenumber { user-select: none; }\r\n.CodeMirror { text-align: left; }\r\n.CodeMirror-placeholder { opacity: 0.3; }\r\n.CodeMirror pre { padding: 0px 4px; }\r\n.CodeMirror-lines { padding: 0px; }\r\ndiv.hr:focus { cursor: none; }\r\n#write pre { white-space: pre-wrap; }\r\n#write.fences-no-line-wrapping pre { white-space: pre; }\r\n#write pre.ty-contain-cm { white-space: normal; }\r\n.CodeMirror-gutters { margin-right: 4px; }\r\n.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }\r\n.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }\r\n#write .md-fences.mock-cm { white-space: pre-wrap; }\r\n.md-fences.md-fences-with-lineno { padding-left: 0px; }\r\n#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }\r\n.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }\r\n.CodeMirror-line, twitterwidget { break-inside: avoid; }\r\n.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }\r\n.footnotes + .footnotes { margin-top: 0px; }\r\n.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }\r\nli div { padding-top: 0px; }\r\nblockquote { margin: 1rem 0px; }\r\nli .mathjax-block, li p { margin: 0.5rem 0px; }\r\nli { margin: 0px; position: relative; }\r\nblockquote > :last-child { margin-bottom: 0px; }\r\nblockquote > :first-child, li > :first-child { margin-top: 0px; }\r\n.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }\r\n#write .footnote-line { white-space: pre-wrap; }\r\n@media print {\r\n  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; }\r\n  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }\r\n  .typora-export * { -webkit-print-color-adjust: exact; }\r\n  html.blink-to-pdf { font-size: 13px; }\r\n  .typora-export #write { padding-left: 32px; padding-right: 32px; padding-bottom: 0px; break-after: avoid; }\r\n  .typora-export #write::after { height: 0px; }\r\n}\r\n.footnote-line { margin-top: 0.714em; font-size: 0.7em; }\r\na img, img a { cursor: pointer; }\r\npre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }\r\np > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }\r\np > .md-image:only-child { display: inline-block; width: 100%; }\r\n#write .MathJax_Display { margin: 0.8em 0px 0px; }\r\n.md-math-block { width: 100%; }\r\n.md-math-block:not(:empty)::after { display: none; }\r\n[contenteditable=\"true\"]:active, [contenteditable=\"true\"]:focus { outline: 0px; box-shadow: none; }\r\n.md-task-list-item { position: relative; list-style-type: none; }\r\n.task-list-item.md-task-list-item { padding-left: 0px; }\r\n.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }\r\n.math { font-size: 1rem; }\r\n.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }\r\n.md-toc-content { position: relative; margin-left: 0px; }\r\n.md-toc-content::after, .md-toc::after { display: none; }\r\n.md-toc-item { display: block; color: rgb(65, 131, 196); }\r\n.md-toc-item a { text-decoration: none; }\r\n.md-toc-inner:hover { text-decoration: underline; }\r\n.md-toc-inner { display: inline-block; cursor: pointer; }\r\n.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }\r\n.md-toc-h2 .md-toc-inner { margin-left: 2em; }\r\n.md-toc-h3 .md-toc-inner { margin-left: 4em; }\r\n.md-toc-h4 .md-toc-inner { margin-left: 6em; }\r\n.md-toc-h5 .md-toc-inner { margin-left: 8em; }\r\n.md-toc-h6 .md-toc-inner { margin-left: 10em; }\r\n@media screen and (max-width: 48em) {\r\n  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }\r\n  .md-toc-h4 .md-toc-inner { margin-left: 5em; }\r\n  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }\r\n  .md-toc-h6 .md-toc-inner { margin-left: 8em; }\r\n}\r\na.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }\r\n.footnote-line a:not(.reversefootnote) { color: inherit; }\r\n.md-attr { display: none; }\r\n.md-fn-count::after { content: \".\"; }\r\ncode, pre, samp, tt { font-family: var(--monospace); }\r\nkbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }\r\n.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }\r\ncode { text-align: left; vertical-align: initial; }\r\na.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }\r\n.md-inline-math .MathJax_SVG .noError { display: none !important; }\r\n.html-for-mac .inline-math-svg .MathJax_SVG { vertical-align: 0.2px; }\r\n.md-math-block .MathJax_SVG_Display { text-align: center; margin: 0px; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; overflow-y: hidden; display: block !important; }\r\n.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }\r\n.MathJax_SVG .MJX-monospace { font-family: var(--monospace); }\r\n.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }\r\n.MathJax_SVG { display: inline; font-style: normal; font-weight: 400; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }\r\n.MathJax_SVG * { transition: none 0s ease 0s; }\r\n.MathJax_SVG_Display svg { vertical-align: middle !important; margin-bottom: 0px !important; margin-top: 0px !important; }\r\n.os-windows.monocolor-emoji .md-emoji { font-family: \"Segoe UI Symbol\", sans-serif; }\r\n.md-diagram-panel > svg { max-width: 100%; }\r\n[lang=\"mermaid\"] svg, [lang=\"flow\"] svg { max-width: 100%; height: auto; }\r\n[lang=\"mermaid\"] .node text { font-size: 1rem; }\r\ntable tr th { border-bottom: 0px; }\r\nvideo { max-width: 100%; display: block; margin: 0px auto; }\r\niframe { max-width: 100%; width: 100%; border: none; }\r\n.highlight td, .highlight tr { border: 0px; }\r\n\r\n\r\n.CodeMirror { height: auto; }\r\n.CodeMirror.cm-s-inner { background: inherit; }\r\n.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }\r\n.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }\r\n.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }\r\n.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }\r\n.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }\r\n.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }\r\n.cm-s-inner .cm-number { color: rgb(17, 102, 68); }\r\n.cm-s-inner .cm-def { color: rgb(0, 0, 255); }\r\n.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }\r\n.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }\r\n.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }\r\n.cm-s-inner .cm-string { color: rgb(170, 17, 17); }\r\n.cm-s-inner .cm-property { color: rgb(0, 0, 0); }\r\n.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }\r\n.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }\r\n.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }\r\n.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }\r\n.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }\r\n.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }\r\n.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }\r\n.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }\r\n.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }\r\n.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }\r\n.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }\r\n.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }\r\n.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }\r\n.cm-negative { color: rgb(221, 68, 68); }\r\n.cm-positive { color: rgb(34, 153, 34); }\r\n.cm-header, .cm-strong { font-weight: 700; }\r\n.cm-del { text-decoration: line-through; }\r\n.cm-em { font-style: italic; }\r\n.cm-link { text-decoration: underline; }\r\n.cm-error { color: red; }\r\n.cm-invalidchar { color: red; }\r\n.cm-constant { color: rgb(38, 139, 210); }\r\n.cm-defined { color: rgb(181, 137, 0); }\r\ndiv.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }\r\ndiv.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }\r\n.cm-s-inner .CodeMirror-activeline-background { background: inherit; }\r\n.CodeMirror { position: relative; overflow: hidden; }\r\n.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }\r\n.CodeMirror-sizer { position: relative; }\r\n.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; }\r\n.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }\r\n.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: hidden; }\r\n.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }\r\n.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }\r\n.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }\r\n.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }\r\n.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }\r\n.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }\r\n.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }\r\n.CodeMirror-lines { cursor: text; }\r\n.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }\r\n.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }\r\n.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }\r\n.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }\r\n.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }\r\n.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }\r\n.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }\r\n.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }\r\n.CodeMirror-measure pre { position: static; }\r\n.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }\r\n.CodeMirror div.CodeMirror-cursor { visibility: hidden; }\r\n.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }\r\n.cm-searching { background: rgba(255, 255, 0, 0.4); }\r\n@media print {\r\n  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }\r\n}\r\n\r\n\r\n:root { --side-bar-bg-color: #fafafa; --control-text-color: #777; }\r\nhtml { font-size: 16px; }\r\nbody { font-family: \"Open Sans\", \"Clear Sans\", \"Helvetica Neue\", Helvetica, Arial, sans-serif; color: rgb(51, 51, 51); line-height: 1.6; }\r\n#write { max-width: 860px; margin: 0px auto; padding: 30px 30px 100px; }\r\n#write > ul:first-child, #write > ol:first-child { margin-top: 30px; }\r\na { color: rgb(65, 131, 196); }\r\nh1, h2, h3, h4, h5, h6 { position: relative; margin-top: 1rem; margin-bottom: 1rem; font-weight: bold; line-height: 1.4; cursor: text; }\r\nh1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor { text-decoration: none; }\r\nh1 tt, h1 code { font-size: inherit; }\r\nh2 tt, h2 code { font-size: inherit; }\r\nh3 tt, h3 code { font-size: inherit; }\r\nh4 tt, h4 code { font-size: inherit; }\r\nh5 tt, h5 code { font-size: inherit; }\r\nh6 tt, h6 code { font-size: inherit; }\r\nh1 { padding-bottom: 0.3em; font-size: 2.25em; line-height: 1.2; border-bottom: 1px solid rgb(238, 238, 238); }\r\nh2 { padding-bottom: 0.3em; font-size: 1.75em; line-height: 1.225; border-bottom: 1px solid rgb(238, 238, 238); }\r\nh3 { font-size: 1.5em; line-height: 1.43; }\r\nh4 { font-size: 1.25em; }\r\nh5 { font-size: 1em; }\r\nh6 { font-size: 1em; color: rgb(119, 119, 119); }\r\np, blockquote, ul, ol, dl, table { margin: 0.8em 0px; }\r\nli > ol, li > ul { margin: 0px; }\r\nhr { height: 2px; padding: 0px; margin: 16px 0px; background-color: rgb(231, 231, 231); border: 0px none; overflow: hidden; box-sizing: content-box; }\r\nli p.first { display: inline-block; }\r\nul, ol { padding-left: 30px; }\r\nul:first-child, ol:first-child { margin-top: 0px; }\r\nul:last-child, ol:last-child { margin-bottom: 0px; }\r\nblockquote { border-left: 4px solid rgb(223, 226, 229); padding: 0px 15px; color: rgb(119, 119, 119); }\r\nblockquote blockquote { padding-right: 0px; }\r\ntable { padding: 0px; word-break: initial; }\r\ntable tr { border-top: 1px solid rgb(223, 226, 229); margin: 0px; padding: 0px; }\r\ntable tr:nth-child(2n), thead { background-color: rgb(248, 248, 248); }\r\ntable tr th { font-weight: bold; border-width: 1px 1px 0px; border-top-style: solid; border-right-style: solid; border-left-style: solid; border-top-color: rgb(223, 226, 229); border-right-color: rgb(223, 226, 229); border-left-color: rgb(223, 226, 229); border-image: initial; border-bottom-style: initial; border-bottom-color: initial; margin: 0px; padding: 6px 13px; }\r\ntable tr td { border: 1px solid rgb(223, 226, 229); margin: 0px; padding: 6px 13px; }\r\ntable tr th:first-child, table tr td:first-child { margin-top: 0px; }\r\ntable tr th:last-child, table tr td:last-child { margin-bottom: 0px; }\r\n.CodeMirror-lines { padding-left: 4px; }\r\n.code-tooltip { box-shadow: rgba(0, 28, 36, 0.3) 0px 1px 1px 0px; border-top: 1px solid rgb(238, 242, 242); }\r\n.md-fences, code, tt { border: 1px solid rgb(231, 234, 237); background-color: rgb(248, 248, 248); border-radius: 3px; padding: 2px 4px 0px; font-size: 0.9em; }\r\ncode { background-color: rgb(243, 244, 244); padding: 0px 2px; }\r\n.md-fences { margin-bottom: 15px; margin-top: 15px; padding-top: 8px; padding-bottom: 6px; }\r\n.md-task-list-item > input { margin-left: -1.3em; }\r\n@media print {\r\n  html { font-size: 13px; }\r\n  table, pre { break-inside: avoid; }\r\n  pre { overflow-wrap: break-word; }\r\n}\r\n.md-fences { background-color: rgb(248, 248, 248); }\r\n#write pre.md-meta-block { padding: 1rem; font-size: 85%; line-height: 1.45; background-color: rgb(247, 247, 247); border: 0px; border-radius: 3px; color: rgb(119, 119, 119); margin-top: 0px !important; }\r\n.mathjax-block > .code-tooltip { bottom: 0.375rem; }\r\n.md-mathjax-midline { background: rgb(250, 250, 250); }\r\n#write > h3.md-focus::before { left: -1.5625rem; top: 0.375rem; }\r\n#write > h4.md-focus::before { left: -1.5625rem; top: 0.285714rem; }\r\n#write > h5.md-focus::before { left: -1.5625rem; top: 0.285714rem; }\r\n#write > h6.md-focus::before { left: -1.5625rem; top: 0.285714rem; }\r\n.md-image > .md-meta { border-radius: 3px; padding: 2px 0px 0px 4px; font-size: 0.9em; color: inherit; }\r\n.md-tag { color: rgb(167, 167, 167); opacity: 1; }\r\n.md-toc { margin-top: 20px; padding-bottom: 20px; }\r\n.sidebar-tabs { border-bottom: none; }\r\n#typora-quick-open { border: 1px solid rgb(221, 221, 221); background-color: rgb(248, 248, 248); }\r\n#typora-quick-open-item { background-color: rgb(250, 250, 250); border-color: rgb(254, 254, 254) rgb(229, 229, 229) rgb(229, 229, 229) rgb(238, 238, 238); border-style: solid; border-width: 1px; }\r\n.on-focus-mode blockquote { border-left-color: rgba(85, 85, 85, 0.12); }\r\nheader, .context-menu, .megamenu-content, footer { font-family: \"Segoe UI\", Arial, sans-serif; }\r\n.file-node-content:hover .file-node-icon, .file-node-content:hover .file-node-open-state { visibility: visible; }\r\n.mac-seamless-mode #typora-sidebar { background-color: var(--side-bar-bg-color); }\r\n.md-lang { color: rgb(180, 101, 77); }\r\n.html-for-mac .context-menu { --item-hover-bg-color: #E6F0FE; }\r\n#md-notification .btn { border: 0px; }\r\n.dropdown-menu .divider { border-color: rgb(229, 229, 229); }\r\n.ty-preferences .window-content { background-color: rgb(250, 250, 250); }\r\n.ty-preferences .nav-group-item.active { color: white; background: rgb(153, 153, 153); }\r\n\r\n .typora-export li, .typora-export p, .typora-export,  .footnote-line {white-space: normal;}\r\n--></style>', NULL, '2019-10-11 15:25:31', 4, NULL, NULL, 'https://www.cnblogs.com/imyijie/p/11651679.html', 0, NULL);
INSERT INTO `t_blog` VALUES (237, '分布式系统的延时和故障容错之Spring Cloud Hystrix', '<p>本示例主要介绍 Spring Cloud 系列中的 Eureka，如何使用Hystrix熔断器容错保护我们的应用程序。</p> \n<p>在微服务架构中，系统被拆分成很多个服务单元，各个服务单元的应用通过 HTTP 相互调用、依赖，在某个服务由于网络或其他原因自身出现故障、延迟时，调用方也会出现延迟。若调用方请求不断增加，可能会形成任务积压，最终导致调用方服务瘫痪，服务不可用现象逐渐放大。</p> \n<h2 id=\"解决方案\">解决方案</h2> \n<p>Spring Cloud Hystrix 是一个专用于服务熔断处理的开源项目，实现了一系列服务保护措施，当依赖的服务方出现故障不可用时，hystrix实现服务降级、服务熔断等功能，对延迟和故障提供强大的容错能力，从而防止故障进一步扩大。</p> \n<h2 id=\"hystrix-主要作用介绍\">Hystrix 主要作用介绍</h2> \n<ul> \n <li>保护和控制底层服务的高延迟和失效对上层服务的影响。</li> \n <li>避免复杂分布式中服务失效的雪崩效应。在大型的分布式系统中，存在各种复杂的依赖关系。如果某个服务失效，很可能会对其他服务造成影响，形成连锁反应。</li> \n <li>快速失效和迅速恢复。以Spring为例，一般在实现controller的时候，都会以同步的逻辑调用依赖的服务。如果服务失效，而且没有客户端失效机制，就会导致请求长时间的阻塞。如果不能快速的发现失效，而就很难通过高可用机制或者负载均衡实现迅速的恢复。</li> \n <li>实现服务降级。这一点是从用户体验来考虑的，一个预定义默认返回会比请求卡死或者500好很多。</li> \n <li>实现了服务监控、报警和运维控制。Hystrix Dashboard和Turbine可以配合Hystrix完成这些功能。</li> \n</ul> \n<h3 id=\"hystrix-主要特性\">Hystrix 主要特性：</h3> \n<ul> \n <li><p>服务熔断</p> <p>Hystrix 会记录各个服务的请求信息，通过 成功、失败、拒绝、超时 等统计信息判断是否打开断路器，将某个服务的请求进行熔断。一段时间后切换到半开路状态，如果后面的请求正常则关闭断路器，否则继续打开断路器。</p></li> \n <li><p>服务降级</p> <p>服务降级是请求失败时的后备方法，故障时执行降级逻辑。</p></li> \n <li><p>线程隔离</p> <p>Hystrix 通过线程池实现资源的隔离，确保对某一服务的调用在出现故障时不会对其他服务造成影响。</p></li> \n</ul> \n<h2 id=\"代码实现\">代码实现</h2> \n<p>创建三个项目来完成示例，分别为：服务注册中心hystrix-eureka-server，服务提供者hystrix-service-provider，服务消费者hystrix-service-consumer</p> \n<h3 id=\"创建hystrix-eureka-server服务注册中心\">1.创建hystrix-eureka-server服务注册中心</h3> \n<h4 id=\"pom.xml配置\">pom.xml配置</h4> \n<pre class=\"xml\"><code>&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n\n    &lt;groupId&gt;com.easy&lt;/groupId&gt;\n    &lt;artifactId&gt;hystrix-eureka-server&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;packaging&gt;jar&lt;/packaging&gt;\n\n    &lt;name&gt;hystrix-eureka-server&lt;/name&gt;\n    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;\n\n    &lt;parent&gt;\n        &lt;artifactId&gt;cloud-hystrix&lt;/artifactId&gt;\n        &lt;groupId&gt;com.easy&lt;/groupId&gt;\n        &lt;version&gt;1.0.0&lt;/version&gt;\n    &lt;/parent&gt;\n\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n\n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n&lt;/project&gt;\n</code></pre> \n<h4 id=\"application.yml配置文件\">application.yml配置文件</h4> \n<pre class=\"yaml\"><code>server:\n  port: 8761\n\nspring:\n  application:\n    name: eureka-server\n\neureka:\n  instance:\n    hostname: localhost   # eureka 实例名称\n  client:\n    register-with-eureka: false # 不向注册中心注册自己\n    fetch-registry: false       # 是否检索服务\n    service-url:\n      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/  # 注册中心访问地址</code></pre> \n<h4 id=\"hystrixeurekaserverapplication.java启动类\">HystrixEurekaServerApplication.java启动类</h4> \n<pre class=\"java\"><code>package com.easy.eurekaServer;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;\n\n@EnableEurekaServer\n@SpringBootApplication\npublic class HystrixEurekaServerApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(HystrixEurekaServerApplication.class, args);\n    }\n}</code></pre> \n<h3 id=\"创建hystrix-service-provider服务提供者\">2.创建hystrix-service-provider服务提供者</h3> \n<h4 id=\"pom.xml配置-1\">pom.xml配置</h4> \n<pre class=\"xml\"><code>&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n\n    &lt;groupId&gt;com.easy&lt;/groupId&gt;\n    &lt;artifactId&gt;hystrix-service-provider&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;packaging&gt;jar&lt;/packaging&gt;\n\n    &lt;name&gt;hystrix-service-provider&lt;/name&gt;\n    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;\n\n    &lt;parent&gt;\n        &lt;artifactId&gt;cloud-hystrix&lt;/artifactId&gt;\n        &lt;groupId&gt;com.easy&lt;/groupId&gt;\n        &lt;version&gt;1.0.0&lt;/version&gt;\n    &lt;/parent&gt;\n\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n\n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n&lt;/project&gt;\n</code></pre> \n<h4 id=\"application.yml配置文件-1\">application.yml配置文件</h4> \n<pre class=\"yaml\"><code>spring:\n  application:\n    name: hystrix-service-provider\n\neureka:\n  client:\n    service-url:\n      defaultZone: http://localhost:8761/eureka/\n  # 实例一\nserver:\n  port: 8081</code></pre> \n<h4 id=\"hellocontroller.java提供一个hello接口\">HelloController.java提供一个hello接口</h4> \n<pre class=\"java\"><code>package com.easy.serviceProvider.web;\n\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class HelloController {\n\n    @GetMapping(\"hello\")\n    public String hello(@RequestParam String p1, @RequestParam String p2) throws Exception {\n//      用来测试服务超时的情况\n//      int sleepTime = new Random().nextInt(2000);\n//      System.out.println(\"hello sleep \" + sleepTime);\n//      Thread.sleep(sleepTime);\n        return \"hello, \" + p1 + \", \" + p2;\n    }\n}</code></pre> \n<h4 id=\"最后贴上启动类hystrixserviceproviderapplication.java\">最后贴上启动类HystrixServiceProviderApplication.java</h4> \n<pre class=\"java\"><code>package com.easy.serviceProvider;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.cloud.client.discovery.EnableDiscoveryClient;\n\n@EnableDiscoveryClient\n@SpringBootApplication\npublic class HystrixServiceProviderApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(HystrixServiceProviderApplication.class, args);\n    }\n}\n</code></pre> \n<h3 id=\"创建hystrix-service-consumer服务消费者\">3.创建hystrix-service-consumer服务消费者</h3> \n<h4 id=\"pom.xml配置-2\">pom.xml配置</h4> \n<pre class=\"xml\"><code>&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n\n    &lt;groupId&gt;com.easy&lt;/groupId&gt;\n    &lt;artifactId&gt;hystrix-service-consumer&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;packaging&gt;jar&lt;/packaging&gt;\n\n    &lt;name&gt;hystrix-service-consumer&lt;/name&gt;\n    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;\n\n    &lt;parent&gt;\n        &lt;artifactId&gt;cloud-hystrix&lt;/artifactId&gt;\n        &lt;groupId&gt;com.easy&lt;/groupId&gt;\n        &lt;version&gt;1.0.0&lt;/version&gt;\n    &lt;/parent&gt;\n\n    &lt;dependencies&gt;\n        &lt;!-- eureka 客户端 --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;!-- ribbon --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n\n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n&lt;/project&gt;\n</code></pre> \n<h4 id=\"application.yml配置文件-2\">application.yml配置文件</h4> \n<pre class=\"yaml\"><code>spring:\n  application:\n    name: hystrix-eureka-server\neureka:\n  client:\n    service-url:\n      defaultZone: http://localhost:8761/eureka/\n\nhystrix:\n  command:\n    default:\n      execution:\n        isolation:\n          thread:\n            timeoutInMilliseconds: 1000 # 默认超时时间</code></pre> \n<h4 id=\"相关代码\">相关代码</h4> \n<p>异常处理类NotFallbackException.java</p> \n<pre class=\"java\"><code>package com.easy.serviceConsumer.exception;\n\npublic class NotFallbackException extends Exception {\n}</code></pre> \n<p>服务层HelloService.java</p> \n<pre class=\"java\"><code>package com.easy.serviceConsumer.service;\n\nimport com.easy.serviceConsumer.exception.NotFallbackException;\nimport com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\nimport org.springframework.web.client.RestTemplate;\n\n@Service\npublic class HelloService {\n\n    @Autowired\n    RestTemplate restTemplate;\n\n    private static final String HELLO_SERVICE = \"http://hystrix-service-provider/\";\n\n    @HystrixCommand(fallbackMethod = \"helloFallback\", ignoreExceptions = {NotFallbackException.class}\n            , groupKey = \"hello\", commandKey = \"str\", threadPoolKey = \"helloStr\")\n    public String hello(String p1, String p2) {\n        return restTemplate.getForObject(HELLO_SERVICE + \"hello?p1=\" + p1 + \"&amp;p2=\" + p2, String.class);\n    }\n\n    private String helloFallback(String p1, String p2, Throwable e) {\n        System.out.println(\"class: \" + e.getClass());\n        return \"error, \" + p1 + \", \" + p2;\n    }\n}</code></pre> \n<p>控制器ConsumerController.java</p> \n<pre class=\"java\"><code>package com.easy.serviceConsumer.web;\n\nimport com.easy.serviceConsumer.service.HelloService;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class ConsumerController {\n\n    @Autowired\n    HelloService helloService;\n\n    @GetMapping(\"hello\")\n    public String hello(@RequestParam String p1, @RequestParam String p2) {\n        System.out.println(\"hello\");\n        return helloService.hello(p1, p2);\n    }\n}</code></pre> \n<h4 id=\"启动类hystrixserviceconsumerapplication.java\">4.启动类HystrixServiceConsumerApplication.java</h4> \n<pre class=\"java\"><code>package com.easy.serviceConsumer;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.cloud.client.SpringCloudApplication;\nimport org.springframework.cloud.client.loadbalancer.LoadBalanced;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.web.client.RestTemplate;\n\n@SpringCloudApplication\npublic class HystrixServiceConsumerApplication {\n\n    @Bean\n    @LoadBalanced\n    RestTemplate restTemplate() {\n        return new RestTemplate();\n    }\n\n    public static void main(String[] args) {\n        SpringApplication.run(HystrixServiceConsumerApplication.class, args);\n    }\n}</code></pre> \n<h2 id=\"使用示例\">使用示例</h2> \n<p>分别运行3个服务，HystrixEurekaServerApplication.java（服务注册中心）,HystrixServiceProviderApplication.java（服务提供者）,HystrixServiceConsumerApplication.java（服务消费者）</p> \n<ul> \n <li>1.访问 http://localhost:8080/hello?p1=a&amp;p2=b ，正常情况下响应为 hello, a, b</li> \n <li>2.关闭 hystrix-service-provider 或在 sleepTime 超过 1000ms 时，访问 http://localhost:8080/hello?p1=a&amp;p2=b，执行降级逻辑，返回 error, a, b</li> \n</ul> \n<h2 id=\"资料\">资料</h2> \n<ul> \n <li><a href=\"https://github.com/smltq/spring-boot-demo/blob/master/cloud-hystrix\">Spring Cloud Hystrix 示例源码</a></li> \n <li><a href=\"https://github.com/smltq/spring-boot-demo\">Spring Boot、Spring Cloud示例学习</a></li> \n <li><a href=\"https://github.com/Netflix/Hystrix\">Hystrix源码</a></li> \n</ul>', NULL, '2019-10-11 15:25:31', 5, NULL, NULL, 'https://www.cnblogs.com/tqlin/p/11653188.html', 0, NULL);
INSERT INTO `t_blog` VALUES (238, 'JavaScript设计模式——单例模式', '<p>　　<span style=\"font-size: 16px;\">单例模式也称为单体模式，规定一个类只有一个实例，并且提供可全局访问点；</span></p> \n<p>　　<span style=\"font-size: 16px;\">在读这篇文章之前，也许你对单例模式的概念感到模糊或者不清楚，但是其实在日常的开发中你肯定用到过单例模式；</span></p> \n<p><span style=\"font-size: 16px;\">　　JavaScript中没有类的定义，单例模式的特点是”唯一“和”全局访问“，那么我们可以联想到JavaScript中的全局对象，利用ES6的let不允许重复声明的特性，刚好符合这两个特点；是的，全局对象是最简单的单例模式；</span></p> \n<p><span style=\"font-size: 16px;\">　　</span></p> \n<div class=\"cnblogs_code\"> \n <pre>    <span style=\"color: #0000ff;\">let </span>obj =<span style=\"color: #000000;\"> {\r\n        name:</span>\"咸鱼\"<span style=\"color: #000000;\">,\r\n        getName:</span><span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(){}\r\n    }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>　　<span style=\"font-size: 16px;\">上述代码中可以知道obj就是一个单例，因为obj刚好就符合单例模式的两大特点：\"唯一\"和\"可全局访问\"；</span></p> \n<p><span style=\"font-size: 16px;\">　　但是我们并不建议这么实现单例，因为全局对象/全局变量会有一些弊端：</span></p> \n<ol> \n <li><span style=\"font-size: 16px;\">污染命名空间（容易变量名冲突）</span></li> \n <li><span style=\"font-size: 16px;\">维护时不容易管控 (搞不好就直接覆盖了)</span></li> \n</ol> \n<p><span style=\"font-size: 16px;\">　　</span></p> \n<p><span style=\"font-size: 16px;\">　　简单版单例模式：</span></p> \n<p><span style=\"font-size: 16px;\">　　　　分析：只能有一个实例，所以我们需要使用if分支来判断，如果已经存在就直接返回，如果不存在就新建一个实例；</span></p> \n<p><span style=\"font-size: 16px;\">　　　　</span></p> \n<div class=\"cnblogs_code\"> \n <pre>    let Singleton = <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(name){\r\n        </span><span style=\"color: #0000ff;\">this</span>.name =<span style=\"color: #000000;\"> name;\r\n        </span><span style=\"color: #0000ff;\">this</span>.instance = <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">; \r\n    }\r\n\r\n    Singleton.prototype.getName </span>= <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(){\r\n        console.log(</span><span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.name);\r\n    }\r\n\r\n    Singleton.getInstance </span>= <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(name){\r\n        </span><span style=\"color: #0000ff;\">if</span>(<span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.instace){\r\n            </span><span style=\"color: #0000ff;\">return</span> <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.instance; \r\n        }\r\n        </span><span style=\"color: #0000ff;\">return</span> <span style=\"color: #0000ff;\">this</span>.instance = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Singleton(name);\r\n    }\r\n\r\n    let winner </span>= Singleton.getInstance(\"winner\");   <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">winner</span>\r\n<span style=\"color: #000000;\">    console.log(winner.getName());\r\n    let sunner </span>= Singleton.getInstance(\"sunner\");   <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">winner</span>\r\n    console.log(sunner.getName())</pre> \n</div> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p><span style=\"font-size: 16px;\">&nbsp;　　上面代码中我们是通过一个变量instance的值来进行判断是否已存在实例，如果存在就直接返回this.instance，如果不存在，就新建实例并赋值给instance；</span></p> \n<p><span style=\"font-size: 16px;\">　　但是上面的代码还是存在问题，因为创建对象的操作和判断实例的操作耦合在一起，并不符合”单一职责原则“；</span></p> \n<p><span style=\"font-size: 16px;\">　　改良版：</span></p> \n<p><span style=\"font-size: 16px;\">　　　　思路：通过一个闭包，来实现判断实例的操作；</span></p> \n<p><span style=\"font-size: 16px;\">　　　　闭包警告：不理解闭包的同学请先学习闭包&nbsp;&nbsp;<a href=\"https://www.cnblogs.com/dengyao-blogs/p/11475575.html\">https://www.cnblogs.com/dengyao-blogs/p/11475575.html</a></span></p> \n<p><span style=\"font-size: 16px;\">　　　　</span></p> \n<div class=\"cnblogs_code\"> \n <pre>let CreateSingleton = (<span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(){\r\n    let instance </span>= <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\r\n    </span><span style=\"color: #0000ff;\">return</span> <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(name){\r\n        </span><span style=\"color: #0000ff;\">this</span>.name =<span style=\"color: #000000;\"> name;\r\n        </span><span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\">(instance){\r\n            </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> instance\r\n        }\r\n        </span><span style=\"color: #0000ff;\">return</span> instance = <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">;\r\n    }\r\n})()\r\n\r\n\r\nCreateSingleton.prototype.getName </span>= <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(){\r\n        console.log(</span><span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.name);\r\n}\r\n\r\nlet winner </span>= <span style=\"color: #0000ff;\">new</span> CreateSingleton(\"winner\");  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">winner</span>\r\n<span style=\"color: #000000;\">console.log(winner.getName());\r\nlet sunner </span>= <span style=\"color: #0000ff;\">new</span> CreateSingleton(\"sunner\");  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">winner</span>\r\nconsole.log(sunner.getName())</pre> \n</div> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p><span style=\"font-size: 16px;\">　　代理版单例模式：</span></p> \n<p><span style=\"font-size: 16px;\">　　　　通过代理的形式，将创建对象的操作和实例判断的操作进行解耦拆分，实现更小粒度的划分，符合”单一职责原则“；</span></p> \n<p><span style=\"font-size: 16px;\">　　</span></p> \n<div class=\"cnblogs_code\"> \n <pre>    let ProxyCreateSingleton = (<span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(){\r\n        let instance </span>= <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\r\n        </span><span style=\"color: #0000ff;\">return</span> <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(name){\r\n            </span><span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\">(instance){\r\n                </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> instance\r\n            }\r\n            </span><span style=\"color: #0000ff;\">return</span> instance = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Singlton(name);\r\n        }\r\n    })();\r\n    \r\n    let Singlton </span>= <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(name){\r\n        </span><span style=\"color: #0000ff;\">this</span>.name =<span style=\"color: #000000;\"> name;\r\n    } \r\n\r\n    Singlton.prototype.getName </span>= <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(){\r\n        console.log(</span><span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.name);\r\n    }\r\n\r\n    let winner </span>= <span style=\"color: #0000ff;\">new</span> ProxyCreateSingleton(\"winner\"<span style=\"color: #000000;\">);\r\n    console.log(winner.getName());\r\n    let sunner </span>= <span style=\"color: #0000ff;\">new</span> ProxyCreateSingleton(\"sunner\"<span style=\"color: #000000;\">);\r\n    console.log(sunner.getName());</span></pre> \n</div> \n<p><span style=\"font-size: 16px;\">　　上面的代码中，ProxyCreateSingleton()只负责判断实例，Singlton只负责创建对象和赋值；</span></p> \n<p>&nbsp;</p> \n<p><span style=\"font-size: 16px;\">　　惰性单例模式</span></p> \n<p><span style=\"font-size: 16px;\">　　　　我们经常会有这样的场景：页面多次调用都有弹窗提示，只是提示内容不一样；</span></p> \n<p><span style=\"font-size: 16px;\">　　　　这个时候我们可以立马想到是单例模式，弹窗就是单例实例，提示内容是参数传递；我们可以用惰性单例模式来实现它；</span></p> \n<p><span style=\"font-size: 16px;\">　　　　</span></p> \n<div class=\"cnblogs_code\"> \n <pre>&lt;!DOCTYPE html&gt;\r\n&lt;html lang=\"en\"&gt;\r\n&lt;head&gt;\r\n    &lt;meta charset=\"UTF-8\"&gt;\r\n    &lt;meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"&gt;\r\n    &lt;meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\"&gt;\r\n    &lt;title&gt;Document&lt;/title&gt;\r\n&lt;/head&gt;\r\n&lt;body&gt;\r\n    &lt;div id=\"loginBtn\"&gt;有梦想的咸鱼&lt;/div&gt;\r\n&lt;/body&gt;\r\n&lt;script&gt;<span style=\"color: #000000;\">\r\nlet getSingleton </span>= <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(fn) {\r\n    </span><span style=\"color: #0000ff;\">var</span><span style=\"color: #000000;\"> result;\r\n    </span><span style=\"color: #0000ff;\">return</span> <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">() {\r\n        </span><span style=\"color: #0000ff;\">return</span> result || (result = fn.apply(<span style=\"color: #0000ff;\">this</span>, arguments)); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 确定this上下文并传递参数</span>\r\n<span style=\"color: #000000;\">    }\r\n}\r\nlet createAlertMessage </span>= <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(html) {\r\n    </span><span style=\"color: #0000ff;\">var</span> div = document.createElement(\'div\'<span style=\"color: #000000;\">);\r\n    div.innerHTML </span>=<span style=\"color: #000000;\"> html;\r\n    div.style.display </span>= \'none\'<span style=\"color: #000000;\">;\r\n    document.body.appendChild(div);\r\n    </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> div;\r\n}\r\n\r\nlet createSingleAlertMessage </span>=<span style=\"color: #000000;\"> getSingleton(createAlertMessage);\r\n    document.getElementById(</span>\'loginBtn\').onclick=<span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\">(){\r\n        let alertMessage </span>= createSingleAlertMessage(\'看来真的是个咸鱼\'<span style=\"color: #000000;\">);\r\n        alertMessage.style.display </span>= \'block\'<span style=\"color: #000000;\">;\r\n    }\r\n</span>&lt;/script&gt;\r\n&lt;/html&gt;</pre> \n</div> \n<p>　　<span style=\"font-size: 16px;\">惰性单例是指的是页面开始加载的时候我们的实例是没有进行创建的，是当我们点击页面的div之后才开始创建实例（按需创建），这可以提高我们的网页性能，加快我们的页面渲染速度；</span></p> \n<p>　　</p> \n<p>&nbsp;</p>', NULL, '2019-10-11 15:25:31', 4, NULL, NULL, 'https://www.cnblogs.com/dengyao-blogs/p/11652566.html', 0, NULL);
INSERT INTO `t_blog` VALUES (239, '（八十三）c#Winform自定义控件-导航菜单（扩展）', '<h1>前提</h1> \n<p>入行已经7,8年了，一直想做一套漂亮点的自定义控件，于是就有了本系列文章。</p> \n<p>GitHub：<a href=\"https://github.com/kwwwvagaa/NetWinformControl\" target=\"_blank\">https://github.com/kwwwvagaa/NetWinformControl</a></p> \n<p>码云：<a href=\"https://gitee.com/kwwwvagaa/net_winform_custom_control.git\" target=\"_blank\">https://gitee.com/kwwwvagaa/net_winform_custom_control.git</a></p> \n<p>如果觉得写的还行，请点个 star 支持一下吧</p> \n<p>欢迎前来交流探讨： 企鹅群568015492&nbsp;<a href=\"https://shang.qq.com/wpa/qunwpa?idkey=6e08741ef16fe53bf0314c1c9e336c4f626047943a8b76bac062361bab6b4f8d\"><img title=\"企鹅群568015492\" src=\"http://localhost:9090/blogImages/2019/10/11/d5bcb60b-48f7-40c2-8887-337ebd979210.png\" alt=\"企鹅群568015492\"></a></p> \n<p>来都来了，点个<span style=\"font-family: \'Microsoft YaHei\'; font-size: 18pt; color: #ff0000;\"><strong>【推荐】</strong></span>再走吧，谢谢</p> \n<h1>NuGet</h1> \n<div class=\"cnblogs_code\"> \n <pre>Install-Package HZH_Controls</pre> \n</div> \n<h1>目录</h1> \n<p><a onclick=\"$.ajax({url: getAjaxBaseUrl() + \" charset=\"utf-8&quot;,data:\" href=\"https://www.cnblogs.com/bfyx/p/11364884.html\">https://www.cnblogs.com/bfyx/p/11364884.html</a></p> \n<h1>用处及效果</h1> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/1fca65bc-ecaa-484b-a814-857d20354972.png\" alt=\"\"></p> \n<p>以上为demo效果，你使用此控件可以实现以下弹出效果</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/475189c6-02be-403f-9fe0-4ce9c4d6e32c.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<h1>准备工作</h1> \n<p>没什么准备的</p> \n<h1>开始</h1> \n<p>添加一个类NavigationMenuItemExt 继承NavigationMenuItemBase</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\">1</span>     <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> NavigationMenuItemExt : NavigationMenuItemBase\r\n</span><span style=\"color: #008080;\">2</span> <span style=\"color: #000000;\">    {\r\n</span><span style=\"color: #008080;\">3</span>         <span style=\"color: #0000ff;\">public</span> System.Windows.Forms.Control ShowControl { <span style=\"color: #0000ff;\">get</span>; <span style=\"color: #0000ff;\">set</span><span style=\"color: #000000;\">; }\r\n</span><span style=\"color: #008080;\">4</span>     }</pre> \n</div> \n<p>添加一个用户控件UCNavigationMenuExt</p> \n<p>添加属性</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\">  1</span> <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\">  2</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Occurs when [click itemed].\r\n</span><span style=\"color: #008080;\">  3</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\">  4</span>         [Description(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">点击节点事件</span><span style=\"color: #800000;\">\"</span>), Category(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">自定义</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">)]\r\n</span><span style=\"color: #008080;\">  5</span> \r\n<span style=\"color: #008080;\">  6</span>         <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">event</span><span style=\"color: #000000;\"> EventHandler ClickItemed;\r\n</span><span style=\"color: #008080;\">  7</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\">  8</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> The select item\r\n</span><span style=\"color: #008080;\">  9</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 10</span>         <span style=\"color: #0000ff;\">private</span> NavigationMenuItemExt selectItem = <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\r\n</span><span style=\"color: #008080;\"> 11</span> \r\n<span style=\"color: #008080;\"> 12</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 13</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Gets the select item.\r\n</span><span style=\"color: #008080;\"> 14</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 15</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;value&gt;</span><span style=\"color: #008000;\">The select item.</span><span style=\"color: #808080;\">&lt;/value&gt;</span>\r\n<span style=\"color: #008080;\"> 16</span>         [Description(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">选中的节点</span><span style=\"color: #800000;\">\"</span>), Category(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">自定义</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">)]\r\n</span><span style=\"color: #008080;\"> 17</span>         <span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> NavigationMenuItemExt SelectItem\r\n</span><span style=\"color: #008080;\"> 18</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\"> 19</span>             <span style=\"color: #0000ff;\">get</span> { <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> selectItem; }\r\n</span><span style=\"color: #008080;\"> 20</span>             <span style=\"color: #0000ff;\">private</span> <span style=\"color: #0000ff;\">set</span> { selectItem =<span style=\"color: #000000;\"> value; }\r\n</span><span style=\"color: #008080;\"> 21</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\"> 22</span> \r\n<span style=\"color: #008080;\"> 23</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 24</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> The items\r\n</span><span style=\"color: #008080;\"> 25</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 26</span> <span style=\"color: #000000;\">        NavigationMenuItemExt[] items;\r\n</span><span style=\"color: #008080;\"> 27</span> \r\n<span style=\"color: #008080;\"> 28</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 29</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Gets or sets the items.\r\n</span><span style=\"color: #008080;\"> 30</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 31</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;value&gt;</span><span style=\"color: #008000;\">The items.</span><span style=\"color: #808080;\">&lt;/value&gt;</span>\r\n<span style=\"color: #008080;\"> 32</span>         [Description(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">节点列表</span><span style=\"color: #800000;\">\"</span>), Category(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">自定义</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">)]\r\n</span><span style=\"color: #008080;\"> 33</span>         <span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> NavigationMenuItemExt[] Items\r\n</span><span style=\"color: #008080;\"> 34</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\"> 35</span>             <span style=\"color: #0000ff;\">get</span> { <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> items; }\r\n</span><span style=\"color: #008080;\"> 36</span>             <span style=\"color: #0000ff;\">set</span>\r\n<span style=\"color: #008080;\"> 37</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\"> 38</span>                 items =<span style=\"color: #000000;\"> value;\r\n</span><span style=\"color: #008080;\"> 39</span> <span style=\"color: #000000;\">                ReloadMenu();\r\n</span><span style=\"color: #008080;\"> 40</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\"> 41</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\"> 42</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 43</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> The tip color\r\n</span><span style=\"color: #008080;\"> 44</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 45</span>         <span style=\"color: #0000ff;\">private</span> Color tipColor = Color.FromArgb(<span style=\"color: #800080;\">255</span>, <span style=\"color: #800080;\">87</span>, <span style=\"color: #800080;\">34</span><span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\"> 46</span> \r\n<span style=\"color: #008080;\"> 47</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 48</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Gets or sets the color of the tip.\r\n</span><span style=\"color: #008080;\"> 49</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 50</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;value&gt;</span><span style=\"color: #008000;\">The color of the tip.</span><span style=\"color: #808080;\">&lt;/value&gt;</span>\r\n<span style=\"color: #008080;\"> 51</span>         [Description(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">角标颜色</span><span style=\"color: #800000;\">\"</span>), Category(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">自定义</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">)]\r\n</span><span style=\"color: #008080;\"> 52</span>         <span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> Color TipColor\r\n</span><span style=\"color: #008080;\"> 53</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\"> 54</span>             <span style=\"color: #0000ff;\">get</span> { <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> tipColor; }\r\n</span><span style=\"color: #008080;\"> 55</span>             <span style=\"color: #0000ff;\">set</span> { tipColor =<span style=\"color: #000000;\"> value; }\r\n</span><span style=\"color: #008080;\"> 56</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\"> 57</span> \r\n<span style=\"color: #008080;\"> 58</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 59</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> 获取或设置控件的前景色。\r\n</span><span style=\"color: #008080;\"> 60</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 61</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;value&gt;</span><span style=\"color: #008000;\">The color of the fore.</span><span style=\"color: #808080;\">&lt;/value&gt;</span>\r\n<span style=\"color: #008080;\"> 62</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;PermissionSet&gt;</span>\r\n<span style=\"color: #008080;\"> 63</span>         <span style=\"color: #808080;\">///</span>   <span style=\"color: #808080;\">&lt;IPermission class=\"System.Security.Permissions.FileIOPermission, mscorlib, Version=2.0.3600.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" version=\"1\" Unrestricted=\"true\" /&gt;</span>\r\n<span style=\"color: #008080;\"> 64</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/PermissionSet&gt;</span>\r\n<span style=\"color: #008080;\"> 65</span>         <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">override</span><span style=\"color: #000000;\"> System.Drawing.Color ForeColor\r\n</span><span style=\"color: #008080;\"> 66</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\"> 67</span>             <span style=\"color: #0000ff;\">get</span>\r\n<span style=\"color: #008080;\"> 68</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\"> 69</span>                 <span style=\"color: #0000ff;\">return</span> <span style=\"color: #0000ff;\">base</span><span style=\"color: #000000;\">.ForeColor;\r\n</span><span style=\"color: #008080;\"> 70</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\"> 71</span>             <span style=\"color: #0000ff;\">set</span>\r\n<span style=\"color: #008080;\"> 72</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\"> 73</span>                 <span style=\"color: #0000ff;\">base</span>.ForeColor =<span style=\"color: #000000;\"> value;\r\n</span><span style=\"color: #008080;\"> 74</span>                 <span style=\"color: #0000ff;\">foreach</span> (Control c <span style=\"color: #0000ff;\">in</span> <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.Controls)\r\n</span><span style=\"color: #008080;\"> 75</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\"> 76</span>                     c.ForeColor =<span style=\"color: #000000;\"> value;\r\n</span><span style=\"color: #008080;\"> 77</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\"> 78</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\"> 79</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\"> 80</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 81</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> 获取或设置控件显示的文字的字体。\r\n</span><span style=\"color: #008080;\"> 82</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 83</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;value&gt;</span><span style=\"color: #008000;\">The font.</span><span style=\"color: #808080;\">&lt;/value&gt;</span>\r\n<span style=\"color: #008080;\"> 84</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;PermissionSet&gt;</span>\r\n<span style=\"color: #008080;\"> 85</span>         <span style=\"color: #808080;\">///</span>   <span style=\"color: #808080;\">&lt;IPermission class=\"System.Security.Permissions.EnvironmentPermission, mscorlib, Version=2.0.3600.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" version=\"1\" Unrestricted=\"true\" /&gt;</span>\r\n<span style=\"color: #008080;\"> 86</span>         <span style=\"color: #808080;\">///</span>   <span style=\"color: #808080;\">&lt;IPermission class=\"System.Security.Permissions.FileIOPermission, mscorlib, Version=2.0.3600.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" version=\"1\" Unrestricted=\"true\" /&gt;</span>\r\n<span style=\"color: #008080;\"> 87</span>         <span style=\"color: #808080;\">///</span>   <span style=\"color: #808080;\">&lt;IPermission class=\"System.Security.Permissions.SecurityPermission, mscorlib, Version=2.0.3600.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" version=\"1\" Flags=\"UnmanagedCode, ControlEvidence\" /&gt;</span>\r\n<span style=\"color: #008080;\"> 88</span>         <span style=\"color: #808080;\">///</span>   <span style=\"color: #808080;\">&lt;IPermission class=\"System.Diagnostics.PerformanceCounterPermission, System, Version=2.0.3600.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" version=\"1\" Unrestricted=\"true\" /&gt;</span>\r\n<span style=\"color: #008080;\"> 89</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/PermissionSet&gt;</span>\r\n<span style=\"color: #008080;\"> 90</span>         <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">override</span><span style=\"color: #000000;\"> Font Font\r\n</span><span style=\"color: #008080;\"> 91</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\"> 92</span>             <span style=\"color: #0000ff;\">get</span>\r\n<span style=\"color: #008080;\"> 93</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\"> 94</span>                 <span style=\"color: #0000ff;\">return</span> <span style=\"color: #0000ff;\">base</span><span style=\"color: #000000;\">.Font;\r\n</span><span style=\"color: #008080;\"> 95</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\"> 96</span>             <span style=\"color: #0000ff;\">set</span>\r\n<span style=\"color: #008080;\"> 97</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\"> 98</span>                 <span style=\"color: #0000ff;\">base</span>.Font =<span style=\"color: #000000;\"> value;\r\n</span><span style=\"color: #008080;\"> 99</span>                 <span style=\"color: #0000ff;\">foreach</span> (Control c <span style=\"color: #0000ff;\">in</span> <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.Controls)\r\n</span><span style=\"color: #008080;\">100</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">101</span>                     c.Font =<span style=\"color: #000000;\"> value;\r\n</span><span style=\"color: #008080;\">102</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\">103</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">104</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\">105</span> \r\n<span style=\"color: #008080;\">106</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\">107</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> The m LST anchors\r\n</span><span style=\"color: #008080;\">108</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\">109</span>         Dictionary&lt;NavigationMenuItemExt, FrmAnchor&gt; m_lstAnchors = <span style=\"color: #0000ff;\">new</span> Dictionary&lt;NavigationMenuItemExt, FrmAnchor&gt;();</pre> \n</div> \n<p>加载和绘图</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\">  1</span>  <span style=\"color: #0000ff;\">private</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> ReloadMenu()\r\n</span><span style=\"color: #008080;\">  2</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\">  3</span>             <span style=\"color: #0000ff;\">try</span>\r\n<span style=\"color: #008080;\">  4</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">  5</span>                 ControlHelper.FreezeControl(<span style=\"color: #0000ff;\">this</span>, <span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\">  6</span>                 <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.Controls.Clear();\r\n</span><span style=\"color: #008080;\">  7</span>                 <span style=\"color: #0000ff;\">if</span> (items != <span style=\"color: #0000ff;\">null</span> &amp;&amp; items.Length &gt; <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">  8</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">  9</span>                     <span style=\"color: #0000ff;\">foreach</span> (<span style=\"color: #0000ff;\">var</span> item <span style=\"color: #0000ff;\">in</span><span style=\"color: #000000;\"> items)\r\n</span><span style=\"color: #008080;\"> 10</span> <span style=\"color: #000000;\">                    {\r\n</span><span style=\"color: #008080;\"> 11</span>                         <span style=\"color: #0000ff;\">var</span> menu =<span style=\"color: #000000;\"> (NavigationMenuItemExt)item;\r\n</span><span style=\"color: #008080;\"> 12</span>                         Label lbl = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Label();\r\n</span><span style=\"color: #008080;\"> 13</span>                         lbl.AutoSize = <span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">;\r\n</span><span style=\"color: #008080;\"> 14</span>                         lbl.TextAlign =<span style=\"color: #000000;\"> ContentAlignment.MiddleCenter;\r\n</span><span style=\"color: #008080;\"> 15</span>                         lbl.Width =<span style=\"color: #000000;\"> menu.ItemWidth;\r\n</span><span style=\"color: #008080;\"> 16</span>                         lbl.Text =<span style=\"color: #000000;\"> menu.Text;\r\n</span><span style=\"color: #008080;\"> 17</span> \r\n<span style=\"color: #008080;\"> 18</span>                         lbl.Font =<span style=\"color: #000000;\"> Font;\r\n</span><span style=\"color: #008080;\"> 19</span>                         lbl.ForeColor =<span style=\"color: #000000;\"> ForeColor;\r\n</span><span style=\"color: #008080;\"> 20</span> \r\n<span style=\"color: #008080;\"> 21</span>                         lbl.Paint +=<span style=\"color: #000000;\"> lbl_Paint;\r\n</span><span style=\"color: #008080;\"> 22</span>                         lbl.MouseEnter +=<span style=\"color: #000000;\"> lbl_MouseEnter;                    \r\n</span><span style=\"color: #008080;\"> 23</span>                         lbl.Tag =<span style=\"color: #000000;\"> menu;\r\n</span><span style=\"color: #008080;\"> 24</span>                         lbl.Click +=<span style=\"color: #000000;\"> lbl_Click;\r\n</span><span style=\"color: #008080;\"> 25</span>                         <span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (menu.AnchorRight)\r\n</span><span style=\"color: #008080;\"> 26</span> <span style=\"color: #000000;\">                        {\r\n</span><span style=\"color: #008080;\"> 27</span>                             lbl.Dock =<span style=\"color: #000000;\"> DockStyle.Right;\r\n</span><span style=\"color: #008080;\"> 28</span> <span style=\"color: #000000;\">                        }\r\n</span><span style=\"color: #008080;\"> 29</span>                         <span style=\"color: #0000ff;\">else</span>\r\n<span style=\"color: #008080;\"> 30</span> <span style=\"color: #000000;\">                        {\r\n</span><span style=\"color: #008080;\"> 31</span>                             lbl.Dock =<span style=\"color: #000000;\"> DockStyle.Left;\r\n</span><span style=\"color: #008080;\"> 32</span> <span style=\"color: #000000;\">                        }\r\n</span><span style=\"color: #008080;\"> 33</span>                         <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.Controls.Add(lbl);\r\n</span><span style=\"color: #008080;\"> 34</span> \r\n<span style=\"color: #008080;\"> 35</span> <span style=\"color: #000000;\">                        lbl.BringToFront();\r\n</span><span style=\"color: #008080;\"> 36</span> <span style=\"color: #000000;\">                    }\r\n</span><span style=\"color: #008080;\"> 37</span> \r\n<span style=\"color: #008080;\"> 38</span> \r\n<span style=\"color: #008080;\"> 39</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\"> 40</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\"> 41</span>             <span style=\"color: #0000ff;\">finally</span>\r\n<span style=\"color: #008080;\"> 42</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\"> 43</span>                 ControlHelper.FreezeControl(<span style=\"color: #0000ff;\">this</span>, <span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\"> 44</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\"> 45</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\"> 46</span> \r\n<span style=\"color: #008080;\"> 47</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 48</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Handles the Click event of the lbl control.\r\n</span><span style=\"color: #008080;\"> 49</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 50</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"sender\"&gt;</span><span style=\"color: #008000;\">The source of the event.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\"> 51</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"e\"&gt;</span><span style=\"color: #008000;\">The </span><span style=\"color: #808080;\">&lt;see cref=\"EventArgs\"/&gt;</span><span style=\"color: #008000;\"> instance containing the event data.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\"> 52</span>         <span style=\"color: #0000ff;\">void</span> lbl_Click(<span style=\"color: #0000ff;\">object</span><span style=\"color: #000000;\"> sender, EventArgs e)\r\n</span><span style=\"color: #008080;\"> 53</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\"> 54</span>             Label lbl = sender <span style=\"color: #0000ff;\">as</span><span style=\"color: #000000;\"> Label;\r\n</span><span style=\"color: #008080;\"> 55</span>             <span style=\"color: #0000ff;\">if</span> (lbl.Tag != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\"> 56</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\"> 57</span>                 <span style=\"color: #0000ff;\">var</span> menu =<span style=\"color: #000000;\"> (NavigationMenuItemExt)lbl.Tag;\r\n</span><span style=\"color: #008080;\"> 58</span>                 <span style=\"color: #0000ff;\">if</span> (menu.ShowControl == <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\"> 59</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\"> 60</span>                     selectItem =<span style=\"color: #000000;\"> menu;\r\n</span><span style=\"color: #008080;\"> 61</span> \r\n<span style=\"color: #008080;\"> 62</span>                     <span style=\"color: #0000ff;\">while</span> (m_lstAnchors.Count &gt; <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\"> 63</span> <span style=\"color: #000000;\">                    {\r\n</span><span style=\"color: #008080;\"> 64</span>                         <span style=\"color: #0000ff;\">try</span>\r\n<span style=\"color: #008080;\"> 65</span> <span style=\"color: #000000;\">                        {\r\n</span><span style=\"color: #008080;\"> 66</span>                             <span style=\"color: #0000ff;\">foreach</span> (<span style=\"color: #0000ff;\">var</span> item <span style=\"color: #0000ff;\">in</span><span style=\"color: #000000;\"> m_lstAnchors)\r\n</span><span style=\"color: #008080;\"> 67</span> <span style=\"color: #000000;\">                            {\r\n</span><span style=\"color: #008080;\"> 68</span> <span style=\"color: #000000;\">                                item.Value.Hide();\r\n</span><span style=\"color: #008080;\"> 69</span> <span style=\"color: #000000;\">                            }\r\n</span><span style=\"color: #008080;\"> 70</span> <span style=\"color: #000000;\">                        }\r\n</span><span style=\"color: #008080;\"> 71</span>                         <span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\"> { }\r\n</span><span style=\"color: #008080;\"> 72</span> <span style=\"color: #000000;\">                    }\r\n</span><span style=\"color: #008080;\"> 73</span> \r\n<span style=\"color: #008080;\"> 74</span>                     <span style=\"color: #0000ff;\">if</span> (ClickItemed != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\"> 75</span> <span style=\"color: #000000;\">                    {\r\n</span><span style=\"color: #008080;\"> 76</span>                         ClickItemed(<span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">, e);\r\n</span><span style=\"color: #008080;\"> 77</span> <span style=\"color: #000000;\">                    }\r\n</span><span style=\"color: #008080;\"> 78</span> <span style=\"color: #000000;\">                }               \r\n</span><span style=\"color: #008080;\"> 79</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\"> 80</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\"> 81</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 82</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Handles the MouseEnter event of the lbl control.\r\n</span><span style=\"color: #008080;\"> 83</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 84</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"sender\"&gt;</span><span style=\"color: #008000;\">The source of the event.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\"> 85</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"e\"&gt;</span><span style=\"color: #008000;\">The </span><span style=\"color: #808080;\">&lt;see cref=\"EventArgs\" /&gt;</span><span style=\"color: #008000;\"> instance containing the event data.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\"> 86</span>         <span style=\"color: #0000ff;\">void</span> lbl_MouseEnter(<span style=\"color: #0000ff;\">object</span><span style=\"color: #000000;\"> sender, EventArgs e)\r\n</span><span style=\"color: #008080;\"> 87</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\"> 88</span>             Label lbl = sender <span style=\"color: #0000ff;\">as</span><span style=\"color: #000000;\"> Label;\r\n</span><span style=\"color: #008080;\"> 89</span>             <span style=\"color: #0000ff;\">var</span> menu = lbl.Tag <span style=\"color: #0000ff;\">as</span><span style=\"color: #000000;\"> NavigationMenuItemExt;\r\n</span><span style=\"color: #008080;\"> 90</span>             <span style=\"color: #0000ff;\">foreach</span> (<span style=\"color: #0000ff;\">var</span> item <span style=\"color: #0000ff;\">in</span><span style=\"color: #000000;\"> m_lstAnchors)\r\n</span><span style=\"color: #008080;\"> 91</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\"> 92</span> <span style=\"color: #000000;\">                m_lstAnchors[item.Key].Hide();\r\n</span><span style=\"color: #008080;\"> 93</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\"> 94</span>             <span style=\"color: #0000ff;\">if</span> (menu.ShowControl != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\"> 95</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\"> 96</span>                 <span style=\"color: #0000ff;\">if</span> (!<span style=\"color: #000000;\">m_lstAnchors.ContainsKey(menu))\r\n</span><span style=\"color: #008080;\"> 97</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\"> 98</span>                     m_lstAnchors[menu] = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> FrmAnchor(lbl, menu.ShowControl);\r\n</span><span style=\"color: #008080;\"> 99</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\">100</span> <span style=\"color: #000000;\">                m_lstAnchors[menu].Show();\r\n</span><span style=\"color: #008080;\">101</span>                 m_lstAnchors[menu].Size =<span style=\"color: #000000;\"> menu.ShowControl.Size;\r\n</span><span style=\"color: #008080;\">102</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">103</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\">104</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\">105</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Handles the Paint event of the lbl control.\r\n</span><span style=\"color: #008080;\">106</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\">107</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"sender\"&gt;</span><span style=\"color: #008000;\">The source of the event.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\">108</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"e\"&gt;</span><span style=\"color: #008000;\">The </span><span style=\"color: #808080;\">&lt;see cref=\"PaintEventArgs\" /&gt;</span><span style=\"color: #008000;\"> instance containing the event data.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\">109</span>         <span style=\"color: #0000ff;\">void</span> lbl_Paint(<span style=\"color: #0000ff;\">object</span><span style=\"color: #000000;\"> sender, PaintEventArgs e)\r\n</span><span style=\"color: #008080;\">110</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\">111</span>             Label lbl = sender <span style=\"color: #0000ff;\">as</span><span style=\"color: #000000;\"> Label;\r\n</span><span style=\"color: #008080;\">112</span>             <span style=\"color: #0000ff;\">if</span> (lbl.Tag != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">113</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">114</span>                 <span style=\"color: #0000ff;\">var</span> menu =<span style=\"color: #000000;\"> (NavigationMenuItemExt)lbl.Tag;\r\n</span><span style=\"color: #008080;\">115</span> <span style=\"color: #000000;\">                e.Graphics.SetGDIHigh();\r\n</span><span style=\"color: #008080;\">116</span> \r\n<span style=\"color: #008080;\">117</span>                 <span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (menu.ShowTip)\r\n</span><span style=\"color: #008080;\">118</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">119</span>                     <span style=\"color: #0000ff;\">if</span> (!<span style=\"color: #0000ff;\">string</span><span style=\"color: #000000;\">.IsNullOrEmpty(menu.TipText))\r\n</span><span style=\"color: #008080;\">120</span> <span style=\"color: #000000;\">                    {\r\n</span><span style=\"color: #008080;\">121</span>                         <span style=\"color: #0000ff;\">var</span> rect = <span style=\"color: #0000ff;\">new</span> Rectangle(lbl.Width - <span style=\"color: #800080;\">25</span>, lbl.Height / <span style=\"color: #800080;\">2</span> - <span style=\"color: #800080;\">10</span>, <span style=\"color: #800080;\">20</span>, <span style=\"color: #800080;\">20</span><span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\">122</span>                         <span style=\"color: #0000ff;\">var</span> path = rect.CreateRoundedRectanglePath(<span style=\"color: #800080;\">5</span><span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\">123</span>                         e.Graphics.FillPath(<span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SolidBrush(tipColor), path);\r\n</span><span style=\"color: #008080;\">124</span>                         e.Graphics.DrawString(menu.TipText, <span style=\"color: #0000ff;\">new</span> Font(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">微软雅黑</span><span style=\"color: #800000;\">\"</span>, 8f), <span style=\"color: #0000ff;\">new</span> SolidBrush(Color.White), rect, <span style=\"color: #0000ff;\">new</span> StringFormat() { Alignment = StringAlignment.Center, LineAlignment =<span style=\"color: #000000;\"> StringAlignment.Center });\r\n</span><span style=\"color: #008080;\">125</span> <span style=\"color: #000000;\">                    }\r\n</span><span style=\"color: #008080;\">126</span>                     <span style=\"color: #0000ff;\">else</span>\r\n<span style=\"color: #008080;\">127</span> <span style=\"color: #000000;\">                    {\r\n</span><span style=\"color: #008080;\">128</span>                         e.Graphics.FillEllipse(<span style=\"color: #0000ff;\">new</span> SolidBrush(tipColor), <span style=\"color: #0000ff;\">new</span> Rectangle(lbl.Width - <span style=\"color: #800080;\">20</span>, lbl.Height / <span style=\"color: #800080;\">2</span> - <span style=\"color: #800080;\">10</span>, <span style=\"color: #800080;\">10</span>, <span style=\"color: #800080;\">10</span><span style=\"color: #000000;\">));\r\n</span><span style=\"color: #008080;\">129</span> <span style=\"color: #000000;\">                    }\r\n</span><span style=\"color: #008080;\">130</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\">131</span>                 <span style=\"color: #0000ff;\">if</span> (menu.Icon != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">132</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">133</span>                     e.Graphics.DrawImage(menu.Icon, <span style=\"color: #0000ff;\">new</span> Rectangle(<span style=\"color: #800080;\">1</span>, (lbl.Height - <span style=\"color: #800080;\">25</span>) / <span style=\"color: #800080;\">2</span>, <span style=\"color: #800080;\">25</span>, <span style=\"color: #800080;\">25</span>), <span style=\"color: #800080;\">0</span>, <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">, menu.Icon.Width, menu.Icon.Height, GraphicsUnit.Pixel);\r\n</span><span style=\"color: #008080;\">134</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\">135</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">136</span>         }</pre> \n</div> \n<p>全部代码</p> \n<div class=\"cnblogs_code\" onclick=\"cnblogs_code_show(\'7d615770-6af7-4b5f-b632-52d981a7a72e\')\">\n <img id=\"code_img_closed_7d615770-6af7-4b5f-b632-52d981a7a72e\" class=\"code_img_closed\" src=\"http://localhost:9090/blogImages/2019/10/11/c6233773-8cc4-478b-8675-a5dcb07947df.gif\" alt=\"\">\n <img id=\"code_img_opened_7d615770-6af7-4b5f-b632-52d981a7a72e\" class=\"code_img_opened\" style=\"display: none;\" onclick=\"cnblogs_code_hide(\'7d615770-6af7-4b5f-b632-52d981a7a72e\',event)\" src=\"http://localhost:9090/blogImages/2019/10/11/1a1aa074-e003-4909-8720-960205992a68.gif\" alt=\"\"> \n <div id=\"cnblogs_code_open_7d615770-6af7-4b5f-b632-52d981a7a72e\" class=\"cnblogs_code_hide\"> \n  <pre><span style=\"color: #008080;\">  1</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> ***********************************************************************\r\n</span><span style=\"color: #008080;\">  2</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Assembly         : HZH_Controls\r\n</span><span style=\"color: #008080;\">  3</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Created          : 2019-10-11\r\n</span><span style=\"color: #008080;\">  4</span> <span style=\"color: #008000;\">//</span>\r\n<span style=\"color: #008080;\">  5</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> ***********************************************************************\r\n</span><span style=\"color: #008080;\">  6</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> &lt;copyright file=\"UCNavigationMenuExt.cs\"&gt;\r\n</span><span style=\"color: #008080;\">  7</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">     Copyright by Huang Zhenghui(黄正辉) All, QQ group:568015492 QQ:623128629 Email:623128629@qq.com\r\n</span><span style=\"color: #008080;\">  8</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> &lt;/copyright&gt;\r\n</span><span style=\"color: #008080;\">  9</span> <span style=\"color: #008000;\">//</span>\r\n<span style=\"color: #008080;\"> 10</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Blog: </span><span style=\"color: #008000; text-decoration: underline;\">https://www.cnblogs.com/bfyx</span>\r\n<span style=\"color: #008080;\"> 11</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> GitHub：</span><span style=\"color: #008000; text-decoration: underline;\">https://github.com/kwwwvagaa/NetWinformControl</span>\r\n<span style=\"color: #008080;\"> 12</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> gitee：</span><span style=\"color: #008000; text-decoration: underline;\">https://gitee.com/kwwwvagaa/net_winform_custom_control.git</span>\r\n<span style=\"color: #008080;\"> 13</span> <span style=\"color: #008000;\">//</span>\r\n<span style=\"color: #008080;\"> 14</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> If you use this code, please keep this note.\r\n</span><span style=\"color: #008080;\"> 15</span> <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> ***********************************************************************</span>\r\n<span style=\"color: #008080;\"> 16</span> <span style=\"color: #0000ff;\">using</span><span style=\"color: #000000;\"> System;\r\n</span><span style=\"color: #008080;\"> 17</span> <span style=\"color: #0000ff;\">using</span><span style=\"color: #000000;\"> System.Collections.Generic;\r\n</span><span style=\"color: #008080;\"> 18</span> <span style=\"color: #0000ff;\">using</span><span style=\"color: #000000;\"> System.ComponentModel;\r\n</span><span style=\"color: #008080;\"> 19</span> <span style=\"color: #0000ff;\">using</span><span style=\"color: #000000;\"> System.Drawing;\r\n</span><span style=\"color: #008080;\"> 20</span> <span style=\"color: #0000ff;\">using</span><span style=\"color: #000000;\"> System.Data;\r\n</span><span style=\"color: #008080;\"> 21</span> <span style=\"color: #0000ff;\">using</span><span style=\"color: #000000;\"> System.Linq;\r\n</span><span style=\"color: #008080;\"> 22</span> <span style=\"color: #0000ff;\">using</span><span style=\"color: #000000;\"> System.Text;\r\n</span><span style=\"color: #008080;\"> 23</span> <span style=\"color: #0000ff;\">using</span><span style=\"color: #000000;\"> System.Windows.Forms;\r\n</span><span style=\"color: #008080;\"> 24</span> <span style=\"color: #0000ff;\">using</span><span style=\"color: #000000;\"> HZH_Controls.Forms;\r\n</span><span style=\"color: #008080;\"> 25</span> \r\n<span style=\"color: #008080;\"> 26</span> <span style=\"color: #0000ff;\">namespace</span><span style=\"color: #000000;\"> HZH_Controls.Controls\r\n</span><span style=\"color: #008080;\"> 27</span> <span style=\"color: #000000;\">{\r\n</span><span style=\"color: #008080;\"> 28</span>     <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 29</span>     <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Class UCNavigationMenuExt.\r\n</span><span style=\"color: #008080;\"> 30</span>     <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Implements the </span><span style=\"color: #808080;\">&lt;see cref=\"System.Windows.Forms.UserControl\" /&gt;</span>\r\n<span style=\"color: #008080;\"> 31</span>     <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 32</span>     <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;seealso cref=\"System.Windows.Forms.UserControl\" /&gt;</span>\r\n<span style=\"color: #008080;\"> 33</span>     [DefaultEvent(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">ClickItemed</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">)]\r\n</span><span style=\"color: #008080;\"> 34</span>     <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">partial</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> UCNavigationMenuExt : UserControl\r\n</span><span style=\"color: #008080;\"> 35</span> <span style=\"color: #000000;\">    {\r\n</span><span style=\"color: #008080;\"> 36</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 37</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Occurs when [click itemed].\r\n</span><span style=\"color: #008080;\"> 38</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 39</span>         [Description(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">点击节点事件</span><span style=\"color: #800000;\">\"</span>), Category(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">自定义</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">)]\r\n</span><span style=\"color: #008080;\"> 40</span> \r\n<span style=\"color: #008080;\"> 41</span>         <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">event</span><span style=\"color: #000000;\"> EventHandler ClickItemed;\r\n</span><span style=\"color: #008080;\"> 42</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 43</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> The select item\r\n</span><span style=\"color: #008080;\"> 44</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 45</span>         <span style=\"color: #0000ff;\">private</span> NavigationMenuItemExt selectItem = <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\r\n</span><span style=\"color: #008080;\"> 46</span> \r\n<span style=\"color: #008080;\"> 47</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 48</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Gets the select item.\r\n</span><span style=\"color: #008080;\"> 49</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 50</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;value&gt;</span><span style=\"color: #008000;\">The select item.</span><span style=\"color: #808080;\">&lt;/value&gt;</span>\r\n<span style=\"color: #008080;\"> 51</span>         [Description(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">选中的节点</span><span style=\"color: #800000;\">\"</span>), Category(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">自定义</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">)]\r\n</span><span style=\"color: #008080;\"> 52</span>         <span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> NavigationMenuItemExt SelectItem\r\n</span><span style=\"color: #008080;\"> 53</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\"> 54</span>             <span style=\"color: #0000ff;\">get</span> { <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> selectItem; }\r\n</span><span style=\"color: #008080;\"> 55</span>             <span style=\"color: #0000ff;\">private</span> <span style=\"color: #0000ff;\">set</span> { selectItem =<span style=\"color: #000000;\"> value; }\r\n</span><span style=\"color: #008080;\"> 56</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\"> 57</span> \r\n<span style=\"color: #008080;\"> 58</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 59</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> The items\r\n</span><span style=\"color: #008080;\"> 60</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 61</span> <span style=\"color: #000000;\">        NavigationMenuItemExt[] items;\r\n</span><span style=\"color: #008080;\"> 62</span> \r\n<span style=\"color: #008080;\"> 63</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 64</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Gets or sets the items.\r\n</span><span style=\"color: #008080;\"> 65</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 66</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;value&gt;</span><span style=\"color: #008000;\">The items.</span><span style=\"color: #808080;\">&lt;/value&gt;</span>\r\n<span style=\"color: #008080;\"> 67</span>         [Description(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">节点列表</span><span style=\"color: #800000;\">\"</span>), Category(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">自定义</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">)]\r\n</span><span style=\"color: #008080;\"> 68</span>         <span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> NavigationMenuItemExt[] Items\r\n</span><span style=\"color: #008080;\"> 69</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\"> 70</span>             <span style=\"color: #0000ff;\">get</span> { <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> items; }\r\n</span><span style=\"color: #008080;\"> 71</span>             <span style=\"color: #0000ff;\">set</span>\r\n<span style=\"color: #008080;\"> 72</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\"> 73</span>                 items =<span style=\"color: #000000;\"> value;\r\n</span><span style=\"color: #008080;\"> 74</span> <span style=\"color: #000000;\">                ReloadMenu();\r\n</span><span style=\"color: #008080;\"> 75</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\"> 76</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\"> 77</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 78</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> The tip color\r\n</span><span style=\"color: #008080;\"> 79</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 80</span>         <span style=\"color: #0000ff;\">private</span> Color tipColor = Color.FromArgb(<span style=\"color: #800080;\">255</span>, <span style=\"color: #800080;\">87</span>, <span style=\"color: #800080;\">34</span><span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\"> 81</span> \r\n<span style=\"color: #008080;\"> 82</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 83</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Gets or sets the color of the tip.\r\n</span><span style=\"color: #008080;\"> 84</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 85</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;value&gt;</span><span style=\"color: #008000;\">The color of the tip.</span><span style=\"color: #808080;\">&lt;/value&gt;</span>\r\n<span style=\"color: #008080;\"> 86</span>         [Description(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">角标颜色</span><span style=\"color: #800000;\">\"</span>), Category(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">自定义</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">)]\r\n</span><span style=\"color: #008080;\"> 87</span>         <span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> Color TipColor\r\n</span><span style=\"color: #008080;\"> 88</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\"> 89</span>             <span style=\"color: #0000ff;\">get</span> { <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> tipColor; }\r\n</span><span style=\"color: #008080;\"> 90</span>             <span style=\"color: #0000ff;\">set</span> { tipColor =<span style=\"color: #000000;\"> value; }\r\n</span><span style=\"color: #008080;\"> 91</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\"> 92</span> \r\n<span style=\"color: #008080;\"> 93</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\"> 94</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> 获取或设置控件的前景色。\r\n</span><span style=\"color: #008080;\"> 95</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\"> 96</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;value&gt;</span><span style=\"color: #008000;\">The color of the fore.</span><span style=\"color: #808080;\">&lt;/value&gt;</span>\r\n<span style=\"color: #008080;\"> 97</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;PermissionSet&gt;</span>\r\n<span style=\"color: #008080;\"> 98</span>         <span style=\"color: #808080;\">///</span>   <span style=\"color: #808080;\">&lt;IPermission class=\"System.Security.Permissions.FileIOPermission, mscorlib, Version=2.0.3600.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" version=\"1\" Unrestricted=\"true\" /&gt;</span>\r\n<span style=\"color: #008080;\"> 99</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/PermissionSet&gt;</span>\r\n<span style=\"color: #008080;\">100</span>         <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">override</span><span style=\"color: #000000;\"> System.Drawing.Color ForeColor\r\n</span><span style=\"color: #008080;\">101</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\">102</span>             <span style=\"color: #0000ff;\">get</span>\r\n<span style=\"color: #008080;\">103</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">104</span>                 <span style=\"color: #0000ff;\">return</span> <span style=\"color: #0000ff;\">base</span><span style=\"color: #000000;\">.ForeColor;\r\n</span><span style=\"color: #008080;\">105</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">106</span>             <span style=\"color: #0000ff;\">set</span>\r\n<span style=\"color: #008080;\">107</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">108</span>                 <span style=\"color: #0000ff;\">base</span>.ForeColor =<span style=\"color: #000000;\"> value;\r\n</span><span style=\"color: #008080;\">109</span>                 <span style=\"color: #0000ff;\">foreach</span> (Control c <span style=\"color: #0000ff;\">in</span> <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.Controls)\r\n</span><span style=\"color: #008080;\">110</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">111</span>                     c.ForeColor =<span style=\"color: #000000;\"> value;\r\n</span><span style=\"color: #008080;\">112</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\">113</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">114</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\">115</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\">116</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> 获取或设置控件显示的文字的字体。\r\n</span><span style=\"color: #008080;\">117</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\">118</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;value&gt;</span><span style=\"color: #008000;\">The font.</span><span style=\"color: #808080;\">&lt;/value&gt;</span>\r\n<span style=\"color: #008080;\">119</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;PermissionSet&gt;</span>\r\n<span style=\"color: #008080;\">120</span>         <span style=\"color: #808080;\">///</span>   <span style=\"color: #808080;\">&lt;IPermission class=\"System.Security.Permissions.EnvironmentPermission, mscorlib, Version=2.0.3600.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" version=\"1\" Unrestricted=\"true\" /&gt;</span>\r\n<span style=\"color: #008080;\">121</span>         <span style=\"color: #808080;\">///</span>   <span style=\"color: #808080;\">&lt;IPermission class=\"System.Security.Permissions.FileIOPermission, mscorlib, Version=2.0.3600.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" version=\"1\" Unrestricted=\"true\" /&gt;</span>\r\n<span style=\"color: #008080;\">122</span>         <span style=\"color: #808080;\">///</span>   <span style=\"color: #808080;\">&lt;IPermission class=\"System.Security.Permissions.SecurityPermission, mscorlib, Version=2.0.3600.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" version=\"1\" Flags=\"UnmanagedCode, ControlEvidence\" /&gt;</span>\r\n<span style=\"color: #008080;\">123</span>         <span style=\"color: #808080;\">///</span>   <span style=\"color: #808080;\">&lt;IPermission class=\"System.Diagnostics.PerformanceCounterPermission, System, Version=2.0.3600.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" version=\"1\" Unrestricted=\"true\" /&gt;</span>\r\n<span style=\"color: #008080;\">124</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/PermissionSet&gt;</span>\r\n<span style=\"color: #008080;\">125</span>         <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">override</span><span style=\"color: #000000;\"> Font Font\r\n</span><span style=\"color: #008080;\">126</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\">127</span>             <span style=\"color: #0000ff;\">get</span>\r\n<span style=\"color: #008080;\">128</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">129</span>                 <span style=\"color: #0000ff;\">return</span> <span style=\"color: #0000ff;\">base</span><span style=\"color: #000000;\">.Font;\r\n</span><span style=\"color: #008080;\">130</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">131</span>             <span style=\"color: #0000ff;\">set</span>\r\n<span style=\"color: #008080;\">132</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">133</span>                 <span style=\"color: #0000ff;\">base</span>.Font =<span style=\"color: #000000;\"> value;\r\n</span><span style=\"color: #008080;\">134</span>                 <span style=\"color: #0000ff;\">foreach</span> (Control c <span style=\"color: #0000ff;\">in</span> <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.Controls)\r\n</span><span style=\"color: #008080;\">135</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">136</span>                     c.Font =<span style=\"color: #000000;\"> value;\r\n</span><span style=\"color: #008080;\">137</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\">138</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">139</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\">140</span> \r\n<span style=\"color: #008080;\">141</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\">142</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> The m LST anchors\r\n</span><span style=\"color: #008080;\">143</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\">144</span>         Dictionary&lt;NavigationMenuItemExt, FrmAnchor&gt; m_lstAnchors = <span style=\"color: #0000ff;\">new</span> Dictionary&lt;NavigationMenuItemExt, FrmAnchor&gt;<span style=\"color: #000000;\">();\r\n</span><span style=\"color: #008080;\">145</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\">146</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Initializes a new instance of the </span><span style=\"color: #808080;\">&lt;see cref=\"UCNavigationMenuExt\"/&gt;</span><span style=\"color: #008000;\"> class.\r\n</span><span style=\"color: #008080;\">147</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\">148</span>         <span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> UCNavigationMenuExt()\r\n</span><span style=\"color: #008080;\">149</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\">150</span> <span style=\"color: #000000;\">            InitializeComponent();\r\n</span><span style=\"color: #008080;\">151</span>             items = <span style=\"color: #0000ff;\">new</span> NavigationMenuItemExt[<span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">];\r\n</span><span style=\"color: #008080;\">152</span>             <span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (ControlHelper.IsDesignMode())\r\n</span><span style=\"color: #008080;\">153</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">154</span>                 items = <span style=\"color: #0000ff;\">new</span> NavigationMenuItemExt[<span style=\"color: #800080;\">4</span><span style=\"color: #000000;\">];\r\n</span><span style=\"color: #008080;\">155</span>                 <span style=\"color: #0000ff;\">for</span> (<span style=\"color: #0000ff;\">int</span> i = <span style=\"color: #800080;\">0</span>; i &lt; <span style=\"color: #800080;\">4</span>; i++<span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">156</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">157</span>                     items[i] = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> NavigationMenuItemExt()\r\n</span><span style=\"color: #008080;\">158</span> <span style=\"color: #000000;\">                    {\r\n</span><span style=\"color: #008080;\">159</span>                         Text = <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">菜单</span><span style=\"color: #800000;\">\"</span> + (i + <span style=\"color: #800080;\">1</span><span style=\"color: #000000;\">),\r\n</span><span style=\"color: #008080;\">160</span>                         AnchorRight = i &gt;= <span style=\"color: #800080;\">2</span>\r\n<span style=\"color: #008080;\">161</span> <span style=\"color: #000000;\">                    };\r\n</span><span style=\"color: #008080;\">162</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\">163</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">164</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\">165</span> \r\n<span style=\"color: #008080;\">166</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\">167</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Reloads the menu.\r\n</span><span style=\"color: #008080;\">168</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\">169</span>         <span style=\"color: #0000ff;\">private</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> ReloadMenu()\r\n</span><span style=\"color: #008080;\">170</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\">171</span>             <span style=\"color: #0000ff;\">try</span>\r\n<span style=\"color: #008080;\">172</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">173</span>                 ControlHelper.FreezeControl(<span style=\"color: #0000ff;\">this</span>, <span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\">174</span>                 <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.Controls.Clear();\r\n</span><span style=\"color: #008080;\">175</span>                 <span style=\"color: #0000ff;\">if</span> (items != <span style=\"color: #0000ff;\">null</span> &amp;&amp; items.Length &gt; <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">176</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">177</span>                     <span style=\"color: #0000ff;\">foreach</span> (<span style=\"color: #0000ff;\">var</span> item <span style=\"color: #0000ff;\">in</span><span style=\"color: #000000;\"> items)\r\n</span><span style=\"color: #008080;\">178</span> <span style=\"color: #000000;\">                    {\r\n</span><span style=\"color: #008080;\">179</span>                         <span style=\"color: #0000ff;\">var</span> menu =<span style=\"color: #000000;\"> (NavigationMenuItemExt)item;\r\n</span><span style=\"color: #008080;\">180</span>                         Label lbl = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Label();\r\n</span><span style=\"color: #008080;\">181</span>                         lbl.AutoSize = <span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">;\r\n</span><span style=\"color: #008080;\">182</span>                         lbl.TextAlign =<span style=\"color: #000000;\"> ContentAlignment.MiddleCenter;\r\n</span><span style=\"color: #008080;\">183</span>                         lbl.Width =<span style=\"color: #000000;\"> menu.ItemWidth;\r\n</span><span style=\"color: #008080;\">184</span>                         lbl.Text =<span style=\"color: #000000;\"> menu.Text;\r\n</span><span style=\"color: #008080;\">185</span> \r\n<span style=\"color: #008080;\">186</span>                         lbl.Font =<span style=\"color: #000000;\"> Font;\r\n</span><span style=\"color: #008080;\">187</span>                         lbl.ForeColor =<span style=\"color: #000000;\"> ForeColor;\r\n</span><span style=\"color: #008080;\">188</span> \r\n<span style=\"color: #008080;\">189</span>                         lbl.Paint +=<span style=\"color: #000000;\"> lbl_Paint;\r\n</span><span style=\"color: #008080;\">190</span>                         lbl.MouseEnter +=<span style=\"color: #000000;\"> lbl_MouseEnter;                    \r\n</span><span style=\"color: #008080;\">191</span>                         lbl.Tag =<span style=\"color: #000000;\"> menu;\r\n</span><span style=\"color: #008080;\">192</span>                         lbl.Click +=<span style=\"color: #000000;\"> lbl_Click;\r\n</span><span style=\"color: #008080;\">193</span>                         <span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (menu.AnchorRight)\r\n</span><span style=\"color: #008080;\">194</span> <span style=\"color: #000000;\">                        {\r\n</span><span style=\"color: #008080;\">195</span>                             lbl.Dock =<span style=\"color: #000000;\"> DockStyle.Right;\r\n</span><span style=\"color: #008080;\">196</span> <span style=\"color: #000000;\">                        }\r\n</span><span style=\"color: #008080;\">197</span>                         <span style=\"color: #0000ff;\">else</span>\r\n<span style=\"color: #008080;\">198</span> <span style=\"color: #000000;\">                        {\r\n</span><span style=\"color: #008080;\">199</span>                             lbl.Dock =<span style=\"color: #000000;\"> DockStyle.Left;\r\n</span><span style=\"color: #008080;\">200</span> <span style=\"color: #000000;\">                        }\r\n</span><span style=\"color: #008080;\">201</span>                         <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.Controls.Add(lbl);\r\n</span><span style=\"color: #008080;\">202</span> \r\n<span style=\"color: #008080;\">203</span> <span style=\"color: #000000;\">                        lbl.BringToFront();\r\n</span><span style=\"color: #008080;\">204</span> <span style=\"color: #000000;\">                    }\r\n</span><span style=\"color: #008080;\">205</span> \r\n<span style=\"color: #008080;\">206</span> \r\n<span style=\"color: #008080;\">207</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\">208</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">209</span>             <span style=\"color: #0000ff;\">finally</span>\r\n<span style=\"color: #008080;\">210</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">211</span>                 ControlHelper.FreezeControl(<span style=\"color: #0000ff;\">this</span>, <span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\">212</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">213</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\">214</span> \r\n<span style=\"color: #008080;\">215</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\">216</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Handles the Click event of the lbl control.\r\n</span><span style=\"color: #008080;\">217</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\">218</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"sender\"&gt;</span><span style=\"color: #008000;\">The source of the event.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\">219</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"e\"&gt;</span><span style=\"color: #008000;\">The </span><span style=\"color: #808080;\">&lt;see cref=\"EventArgs\"/&gt;</span><span style=\"color: #008000;\"> instance containing the event data.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\">220</span>         <span style=\"color: #0000ff;\">void</span> lbl_Click(<span style=\"color: #0000ff;\">object</span><span style=\"color: #000000;\"> sender, EventArgs e)\r\n</span><span style=\"color: #008080;\">221</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\">222</span>             Label lbl = sender <span style=\"color: #0000ff;\">as</span><span style=\"color: #000000;\"> Label;\r\n</span><span style=\"color: #008080;\">223</span>             <span style=\"color: #0000ff;\">if</span> (lbl.Tag != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">224</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">225</span>                 <span style=\"color: #0000ff;\">var</span> menu =<span style=\"color: #000000;\"> (NavigationMenuItemExt)lbl.Tag;\r\n</span><span style=\"color: #008080;\">226</span>                 <span style=\"color: #0000ff;\">if</span> (menu.ShowControl == <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">227</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">228</span>                     selectItem =<span style=\"color: #000000;\"> menu;\r\n</span><span style=\"color: #008080;\">229</span> \r\n<span style=\"color: #008080;\">230</span>                     <span style=\"color: #0000ff;\">while</span> (m_lstAnchors.Count &gt; <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">231</span> <span style=\"color: #000000;\">                    {\r\n</span><span style=\"color: #008080;\">232</span>                         <span style=\"color: #0000ff;\">try</span>\r\n<span style=\"color: #008080;\">233</span> <span style=\"color: #000000;\">                        {\r\n</span><span style=\"color: #008080;\">234</span>                             <span style=\"color: #0000ff;\">foreach</span> (<span style=\"color: #0000ff;\">var</span> item <span style=\"color: #0000ff;\">in</span><span style=\"color: #000000;\"> m_lstAnchors)\r\n</span><span style=\"color: #008080;\">235</span> <span style=\"color: #000000;\">                            {\r\n</span><span style=\"color: #008080;\">236</span> <span style=\"color: #000000;\">                                item.Value.Hide();\r\n</span><span style=\"color: #008080;\">237</span> <span style=\"color: #000000;\">                            }\r\n</span><span style=\"color: #008080;\">238</span> <span style=\"color: #000000;\">                        }\r\n</span><span style=\"color: #008080;\">239</span>                         <span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\"> { }\r\n</span><span style=\"color: #008080;\">240</span> <span style=\"color: #000000;\">                    }\r\n</span><span style=\"color: #008080;\">241</span> \r\n<span style=\"color: #008080;\">242</span>                     <span style=\"color: #0000ff;\">if</span> (ClickItemed != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">243</span> <span style=\"color: #000000;\">                    {\r\n</span><span style=\"color: #008080;\">244</span>                         ClickItemed(<span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">, e);\r\n</span><span style=\"color: #008080;\">245</span> <span style=\"color: #000000;\">                    }\r\n</span><span style=\"color: #008080;\">246</span> <span style=\"color: #000000;\">                }               \r\n</span><span style=\"color: #008080;\">247</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">248</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\">249</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\">250</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Handles the MouseEnter event of the lbl control.\r\n</span><span style=\"color: #008080;\">251</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\">252</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"sender\"&gt;</span><span style=\"color: #008000;\">The source of the event.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\">253</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"e\"&gt;</span><span style=\"color: #008000;\">The </span><span style=\"color: #808080;\">&lt;see cref=\"EventArgs\" /&gt;</span><span style=\"color: #008000;\"> instance containing the event data.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\">254</span>         <span style=\"color: #0000ff;\">void</span> lbl_MouseEnter(<span style=\"color: #0000ff;\">object</span><span style=\"color: #000000;\"> sender, EventArgs e)\r\n</span><span style=\"color: #008080;\">255</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\">256</span>             Label lbl = sender <span style=\"color: #0000ff;\">as</span><span style=\"color: #000000;\"> Label;\r\n</span><span style=\"color: #008080;\">257</span>             <span style=\"color: #0000ff;\">var</span> menu = lbl.Tag <span style=\"color: #0000ff;\">as</span><span style=\"color: #000000;\"> NavigationMenuItemExt;\r\n</span><span style=\"color: #008080;\">258</span>             <span style=\"color: #0000ff;\">foreach</span> (<span style=\"color: #0000ff;\">var</span> item <span style=\"color: #0000ff;\">in</span><span style=\"color: #000000;\"> m_lstAnchors)\r\n</span><span style=\"color: #008080;\">259</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">260</span> <span style=\"color: #000000;\">                m_lstAnchors[item.Key].Hide();\r\n</span><span style=\"color: #008080;\">261</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">262</span>             <span style=\"color: #0000ff;\">if</span> (menu.ShowControl != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">263</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">264</span>                 <span style=\"color: #0000ff;\">if</span> (!<span style=\"color: #000000;\">m_lstAnchors.ContainsKey(menu))\r\n</span><span style=\"color: #008080;\">265</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">266</span>                     m_lstAnchors[menu] = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> FrmAnchor(lbl, menu.ShowControl);\r\n</span><span style=\"color: #008080;\">267</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\">268</span> <span style=\"color: #000000;\">                m_lstAnchors[menu].Show();\r\n</span><span style=\"color: #008080;\">269</span>                 m_lstAnchors[menu].Size =<span style=\"color: #000000;\"> menu.ShowControl.Size;\r\n</span><span style=\"color: #008080;\">270</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">271</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\">272</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;summary&gt;</span>\r\n<span style=\"color: #008080;\">273</span>         <span style=\"color: #808080;\">///</span><span style=\"color: #008000;\"> Handles the Paint event of the lbl control.\r\n</span><span style=\"color: #008080;\">274</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;/summary&gt;</span>\r\n<span style=\"color: #008080;\">275</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"sender\"&gt;</span><span style=\"color: #008000;\">The source of the event.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\">276</span>         <span style=\"color: #808080;\">///</span> <span style=\"color: #808080;\">&lt;param name=\"e\"&gt;</span><span style=\"color: #008000;\">The </span><span style=\"color: #808080;\">&lt;see cref=\"PaintEventArgs\" /&gt;</span><span style=\"color: #008000;\"> instance containing the event data.</span><span style=\"color: #808080;\">&lt;/param&gt;</span>\r\n<span style=\"color: #008080;\">277</span>         <span style=\"color: #0000ff;\">void</span> lbl_Paint(<span style=\"color: #0000ff;\">object</span><span style=\"color: #000000;\"> sender, PaintEventArgs e)\r\n</span><span style=\"color: #008080;\">278</span> <span style=\"color: #000000;\">        {\r\n</span><span style=\"color: #008080;\">279</span>             Label lbl = sender <span style=\"color: #0000ff;\">as</span><span style=\"color: #000000;\"> Label;\r\n</span><span style=\"color: #008080;\">280</span>             <span style=\"color: #0000ff;\">if</span> (lbl.Tag != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">281</span> <span style=\"color: #000000;\">            {\r\n</span><span style=\"color: #008080;\">282</span>                 <span style=\"color: #0000ff;\">var</span> menu =<span style=\"color: #000000;\"> (NavigationMenuItemExt)lbl.Tag;\r\n</span><span style=\"color: #008080;\">283</span> <span style=\"color: #000000;\">                e.Graphics.SetGDIHigh();\r\n</span><span style=\"color: #008080;\">284</span> \r\n<span style=\"color: #008080;\">285</span>                 <span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (menu.ShowTip)\r\n</span><span style=\"color: #008080;\">286</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">287</span>                     <span style=\"color: #0000ff;\">if</span> (!<span style=\"color: #0000ff;\">string</span><span style=\"color: #000000;\">.IsNullOrEmpty(menu.TipText))\r\n</span><span style=\"color: #008080;\">288</span> <span style=\"color: #000000;\">                    {\r\n</span><span style=\"color: #008080;\">289</span>                         <span style=\"color: #0000ff;\">var</span> rect = <span style=\"color: #0000ff;\">new</span> Rectangle(lbl.Width - <span style=\"color: #800080;\">25</span>, lbl.Height / <span style=\"color: #800080;\">2</span> - <span style=\"color: #800080;\">10</span>, <span style=\"color: #800080;\">20</span>, <span style=\"color: #800080;\">20</span><span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\">290</span>                         <span style=\"color: #0000ff;\">var</span> path = rect.CreateRoundedRectanglePath(<span style=\"color: #800080;\">5</span><span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\">291</span>                         e.Graphics.FillPath(<span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SolidBrush(tipColor), path);\r\n</span><span style=\"color: #008080;\">292</span>                         e.Graphics.DrawString(menu.TipText, <span style=\"color: #0000ff;\">new</span> Font(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">微软雅黑</span><span style=\"color: #800000;\">\"</span>, 8f), <span style=\"color: #0000ff;\">new</span> SolidBrush(Color.White), rect, <span style=\"color: #0000ff;\">new</span> StringFormat() { Alignment = StringAlignment.Center, LineAlignment =<span style=\"color: #000000;\"> StringAlignment.Center });\r\n</span><span style=\"color: #008080;\">293</span> <span style=\"color: #000000;\">                    }\r\n</span><span style=\"color: #008080;\">294</span>                     <span style=\"color: #0000ff;\">else</span>\r\n<span style=\"color: #008080;\">295</span> <span style=\"color: #000000;\">                    {\r\n</span><span style=\"color: #008080;\">296</span>                         e.Graphics.FillEllipse(<span style=\"color: #0000ff;\">new</span> SolidBrush(tipColor), <span style=\"color: #0000ff;\">new</span> Rectangle(lbl.Width - <span style=\"color: #800080;\">20</span>, lbl.Height / <span style=\"color: #800080;\">2</span> - <span style=\"color: #800080;\">10</span>, <span style=\"color: #800080;\">10</span>, <span style=\"color: #800080;\">10</span><span style=\"color: #000000;\">));\r\n</span><span style=\"color: #008080;\">297</span> <span style=\"color: #000000;\">                    }\r\n</span><span style=\"color: #008080;\">298</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\">299</span>                 <span style=\"color: #0000ff;\">if</span> (menu.Icon != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)\r\n</span><span style=\"color: #008080;\">300</span> <span style=\"color: #000000;\">                {\r\n</span><span style=\"color: #008080;\">301</span>                     e.Graphics.DrawImage(menu.Icon, <span style=\"color: #0000ff;\">new</span> Rectangle(<span style=\"color: #800080;\">1</span>, (lbl.Height - <span style=\"color: #800080;\">25</span>) / <span style=\"color: #800080;\">2</span>, <span style=\"color: #800080;\">25</span>, <span style=\"color: #800080;\">25</span>), <span style=\"color: #800080;\">0</span>, <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">, menu.Icon.Width, menu.Icon.Height, GraphicsUnit.Pixel);\r\n</span><span style=\"color: #008080;\">302</span> <span style=\"color: #000000;\">                }\r\n</span><span style=\"color: #008080;\">303</span> <span style=\"color: #000000;\">            }\r\n</span><span style=\"color: #008080;\">304</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\">305</span> <span style=\"color: #000000;\">    }\r\n</span><span style=\"color: #008080;\">306</span> }</pre> \n </div> \n <span class=\"cnblogs_code_collapse\">View Code</span>\n</div> \n<p>&nbsp;</p> \n<h1>最后的话</h1> \n<p>如果你喜欢的话，请到&nbsp;<a href=\"https://gitee.com/kwwwvagaa/net_winform_custom_control\">https://gitee.com/kwwwvagaa/net_winform_custom_control</a>&nbsp;点个星星吧</p>', NULL, '2019-10-11 15:25:33', 4, NULL, NULL, 'https://www.cnblogs.com/bfyx/p/11653011.html', 0, NULL);
INSERT INTO `t_blog` VALUES (240, 'Flask上下文管理机制流程（源码剖析）', '<h2 id=\"flask请求上下文管理\">Flask请求上下文管理</h2> \n<h3 id=\"偏函数\">1 偏函数</h3> \n<ul> \n <li><p>partial 使用该方式可以生成一个新函数</p> <pre class=\"python\"><code>from functools import partial\n\ndef mod( n, m ):\n  return n % m\n\nmod_by_100 = partial( mod, 100 )  # 100传给n\n\nprint mod( 100, 7 )  # 2\nprint mod_by_100( 7 )  # 2</code></pre></li> \n</ul> \n<h3 id=\"线程安全\">2 线程安全</h3> \n<pre class=\"python\"><code>import time\nfrom threading import local\n\nclass Foo(local): \n# 继承local,保证线程安全,也保证了处理速度,threading.local()这个方法的特点用来保存一个全局变量，但是这个全局变量只有在当前线程才能访问，\n    num = 0\n    \nfoo = Foo()\ndef add(i):\n    foo.num =i\n    time.sleep(0.5)\n    print(foo.num)\n\nfrom threading import Thread\nfor i in range(20):\n    task = Thread(target=add,args=(i,))\n    task.start()\n    </code></pre> \n<h3 id=\"请求上下文\">3 请求上下文</h3> \n<h4 id=\"flask请求上文\">3.1 Flask请求上文</h4> \n<ol> \n <li>当请求进来时,app(), Flask实例化对象app**执行__call__**</li> \n</ol> \n<pre class=\"python\"><code>def __call__(self, environ, start_response):\n    \"\"\"The WSGI server calls the Flask application object as the\n        WSGI application. This calls :meth:`wsgi_app` which can be\n        wrapped to applying middleware.\"\"\"\n    return self.wsgi_app(environ, start_response)</code></pre> \n<ol> \n <li><p>执行wsgi_app 得到 一个 <strong>RequestContext的对象 ctx (封装了request以及session)</strong></p> <pre><code>ctx = self.request_context(environ)</code></pre> <pre class=\"python\"><code>class RequestContext(object):\n    #此时的self是RequestContext对象 --&gt;ctx 中封装了request/session\n    def __init__(self, app, environ, request=None):\n        self.app = app      #app = Flask对象\n        if request is None:\n            #请求的原始信息通过request_class后此时request已经存在,request.methods等\n            request = app.request_class(environ)\n        self.request = request\n        self.url_adapter = app.create_url_adapter(self.request)\n        self.flashes = None\n        self.session = None</code></pre></li> \n <li><p>ctx 执行 ctx.push():</p> <pre class=\"python\"><code>ctx = self.request_context(environ)\n        error = None\n        try:\n            try:\n                ctx.push()\n                response = self.full_dispatch_request()\n            except Exception as e:\n                error = e\n                response = self.handle_exception(e)</code></pre></li> \n <li><p>RequestContext对象的push方法</p> <pre class=\"python\"><code>def push(self):\n        # _request_ctx_stack = LocalStack()一个LocalStack对象\n        # _request_ctx_stack._local = LocalStack()._loacl = {\"__storage__\":{},\"__ident_func__\":get_ident}\n        top = _request_ctx_stack.top\n        #top =None\n        if top is not None and top.preserved:\n            top.pop(top._preserved_exc)\n</code></pre> \n  <ul> \n   <li><strong>_ request_ctx_stack</strong>是一个<strong>LocalStack</strong>对象 ,<strong>LocalStack()._local是一个Local对象 即Local()</strong></li> \n  </ul> <pre class=\"python\"><code>class LocalStack(object):\n    def __init__(self):\n        self._local = Local()\n        #self._loacl = {\"__storage__\":{},\"__ident_func__\":get_ident}</code></pre> \n  <ul> \n   <li>_request_ctx_stack中top方法,返回None (想哭,但是没有眼泪,这个方法,琢磨了半个小时)</li> \n  </ul></li> \n <li><p>Local对象经过初始化得到的字典值</p> <pre class=\"python\"><code>class Local(object):\n    #限定键槽,当前只能由两个属性值__storage__,__ident_func__\n    __slots__ = (\'__storage__\', \'__ident_func__\')\n\n    def __init__(self):\n        object.__setattr__(self, \'__storage__\', {})\n        object.__setattr__(self, \'__ident_func__\', get_ident)\n\n        # {\"__storage__\":{},\"__ident_func__\":get_ident}  #此时get_dient 是个没有执行的函数,内存地址</code></pre> \n  <ul> \n   <li>_request_ctx_stack中top方法,返回None (第二次不会上当)</li> \n  </ul> <pre class=\"python\"><code>@property\n    def top(self):\n        \"\"\"The topmost item on the stack.  If the stack is empty,\n        `None` is returned.\n        \"\"\"\n        try:\n            # self._local 即Local对象调用__getattr__方法\n            #在下文时候Local对象{\"__storage__\":{8080:{stack:rv=[ctx-&gt;request/session]}},\"__ident_func__\":get_ident}\n            # [ctx-&gt;request/session]\n            return self._local.stack[-1]\n            #得到ctx对象\n        except (AttributeError, IndexError):\n            return None</code></pre></li> \n <li><p>_request_ctx_stack 对象执行push方法</p> <pre class=\"python\"><code>_request_ctx_stack.push(self)  #当前的self为ctx</code></pre> <pre class=\"python\"><code>def push(self, obj):\n        #此时的self是LocalStack对象, obj为ctx\n        \"\"\"Pushes a new item to the stack\"\"\"\n        # self._local = {\"__storage__\":{},\"__ident_func__\":get_ident}\n        #找不到返回值是None\n        rv = getattr(self._local, \'stack\', None)\n        if rv is None:\n            #由于.stack后面有等号,执行的时候Local()对象的__setattr__方法\n            #实际上是地址的赋值,此时stack和rv都指向空列表\n            self._local.stack = rv = []\n            #{\"__storage__\":{8080:{stack:rv=[]}},\"__ident_func__\":get_ident}\n        rv.append(obj)\n        # {\"__storage__\":{8080:{stack:rv=[ctx-&gt;request/session]}},\"__ident_func__\":get_ident}\n        # 应用上下文时候{\"__storage__\":{8080:{stack:rv=[app_ctx-&gt;(app/g)]}},\"__ident_func__\":get_ident}\n        return rv\n        #rv=[ctx-&gt;request/session]</code></pre> <pre class=\"python\"><code>def __setattr__(self, name, value):\n        #name=stack   value=rv=[]\n        #self是Local对象 {\"__storage__\":{},\"__ident_func__\":get_ident}\n        ident = self.__ident_func__() #执行get_ident函数获取当前线程id 8080\n        storage = self.__storage__  #storge ={8080:{stack:rv=[]}}\n        try:\n            storage[ident][name] = value\n        except KeyError:\n            storage[ident] = {name: value}   #storage={}\n\n         # {\"__storage__\":{8080:{stack:rv=[]}},\"__ident_func__\":get_ident}</code></pre> \n  <ul> \n   <li>执行完push方法 请求上文结束:</li> \n  </ul> <pre class=\"python\"><code>#当请求进来,第一件事就是要把当前这个请求在我服务器上的线程开辟一个空间(线程对应的空间,必须含有stack对应一个列表存放ctx(request/session)\n# {\"__storage__\":{8080:{stack:rv=[ctx-&gt;request/session]}},\"__ident_func__\":get_ident}</code></pre></li> \n</ol> \n<h4 id=\"flask请求下文\">3.3.2Flask请求下文</h4> \n<ol> \n <li><p>导入request开始使用,在request中</p> <pre class=\"python\"><code>#此时request是一个函数包裹一个偏函数   LocalProxy()是一个代理\n#当前的request是一个LocalProxy()  request.method  执行__getattr__方法\nrequest = LocalProxy(\n    partial(_lookup_req_object, \'request\')   #return request对象\n)</code></pre></li> \n <li><p>在偏函数中 将request传入到 _lookup_req_object中: 此时<strong>得到一个request对象</strong></p> <pre class=\"python\"><code>def _lookup_req_object(name):\n    # _request_ctx_stack是LocalStack对象\n    top = _request_ctx_stack.top\n    #下文[ctx-&gt;request/session]\n    if top is None:\n        raise RuntimeError(_request_ctx_err_msg)\n    #此时的name是request,从ctx对象中找出request对象\n    return getattr(top, name)</code></pre> <p>...</p> <pre class=\"python\"><code>@property\n    def top(self):\n        \"\"\"The topmost item on the stack.  If the stack is empty,\n        `None` is returned.\n        \"\"\"\n        try:\n            # self._local 即Local对象调用__getattr__方法\n            #在下文时候Local对象{\"__storage__\":{8080:{stack:rv=[ctx-&gt;request/session]}},\"__ident_func__\":get_ident}\n            # [ctx-&gt;request/session]\n            return self._local.stack[-1]\n            #得到ctx对象\n        except (AttributeError, IndexError):\n            return None</code></pre> \n  <ul> \n   <li>此时的top不是None已经存在值 (0.0)</li> \n  </ul></li> \n <li><p>partial(_lookup_req_object, \'request\') 这一层执行完得到一个reauest对象,将偏函数传入到LocalProxy中</p> <pre class=\"python\"><code>@implements_bool\nclass LocalProxy(object):\n    __slots__ = (\'__local\', \'__dict__\', \'__name__\', \'__wrapped__\')\n\n    def __init__(self, local, name=None):\n        #local是request偏函数\n        object.__setattr__(self, \'_LocalProxy__local\', local)   #__local = request偏函数\n        object.__setattr__(self, \'__name__\', name)\n        #当前偏函数可以执行而且判断loacl中是否有 __release_local__  ==&gt;这句话成立\n        if callable(local) and not hasattr(local, \'__release_local__\'):\n            # \"local\" is a callable that is not an instance of Local or\n            # LocalManager: mark it as a wrapped function.\n            object.__setattr__(self, \'__wrapped__\', local)  #__warpped__还是local偏函数</code></pre></li> \n <li><p>当前的request是一个LocalProxy() request.method 执行LocalProxy中的__getattr__方法</p> <pre class=\"python\"><code>    def __getattr__(self, name): # name是method(举例)\n        if name == \'__members__\':\n            return dir(self._get_current_object())\n        #此时self._get_current_object()是经过_local 执行后得到的request对象,从request对象中去取出method\n        return getattr(self._get_current_object(), name)</code></pre> <p>...</p> <pre class=\"python\"><code>def _get_current_object(self):\n        #self._local是偏函数\n        if not hasattr(self.__local, \'__release_local__\'):\n            #执行偏函数,返回request对象\n            return self.__local()\n        try:\n            return getattr(self.__local, self.__name__)\n        except AttributeError:\n            raise RuntimeError(\'no object bound to %s\' % self.__name__)</code></pre></li> \n</ol> \n<h4 id=\"小结\">3.3.3小结</h4> \n<p>由此看来,falsk上下文管理可以分为三个阶段：</p> \n<ol> \n <li>请求上文 -&gt;<br> 当请求进来,第一件事就是要把当前这个请求在服务器上的线程开辟一个空间(线程对应的空间,必须含有stack对应一个列表存放ctx(request/session),具体--&gt;:将request，session封装在 RequestContext类中<br> app，g封装在AppContext类中,并通过LocalStack将requestcontext和appcontext放入Local类中<br> 在local类中,以线程ID号作为key的字典,</li> \n <li>请求下文：<br> 通过localproxy---&gt;偏函数---&gt;localstack---&gt;local取值</li> \n <li>\'请求响应时\'：--&gt;要将上下文管理中的数据清除<br> 先执行save.session()再各自执行pop(),将local中的数据清除</li> \n</ol> \n<p><strong>详细看源码</strong></p> \n<h3 id=\"应用上下文\">3.4 应用上下文</h3> \n<ul> \n <li><p><strong>执行wsgi_app方法</strong></p> <pre class=\"python\"><code>   #ctx为一个RequestContext的对象,参数为environ\n        ctx = self.request_context(environ)\n        error = None\n        try:\n            try:\n                ctx.push()\n                response = self.full_dispatch_request()\n            except Exception as e:\n                error = e\n                response = self.handle_exception(e)</code></pre></li> \n <li><p>执行push方法,_app_ctx_stack 同样是LocalStck对象,初始化时候top为None</p> <pre class=\"python\"><code>    def push(self):\n        app_ctx = _app_ctx_stack.top\n        #app_ctx = None\n        if app_ctx is None or app_ctx.app != self.app:\n            app_ctx = self.app.app_context()   #app_context是AppContext对象  与RequestContenx一样,知识序列化出app和g\n            app_ctx.push()\n            # 应用上文时候{\"__storage__\":{8080:{stack:rv=[app_ctx-&gt;(app/g)]}},\"__ident_func__\":get_ident}\n            self._implicit_app_ctx_stack.append(app_ctx)\n        else:\n            self._implicit_app_ctx_stack.append(None)</code></pre> \n  <ul> \n   <li>执行app_ctx.push 进而 **_app_ctx_stack.push**</li> \n  </ul> <pre class=\"python\"><code>   def push(self):\n        \"\"\"Binds the app context to the current context.\"\"\"\n        self._refcnt += 1\n        if hasattr(sys, \'exc_clear\'):\n            sys.exc_clear()\n            #将AppContext存在LocalStack对象中\n        _app_ctx_stack.push(self)\n        appcontext_pushed.send(self.app)</code></pre> <pre class=\"python\"><code>    def push(self, obj):\n        #此时的self是LocalStack对象, obj为ctx\n        \"\"\"Pushes a new item to the stack\"\"\"\n        # self._local = {\"__storage__\":{},\"__ident_func__\":get_ident}\n        #找不到返回值是None\n        rv = getattr(self._local, \'stack\', None)\n        if rv is None:\n            #由于.stack后面有等号,执行的时候Local()对象的__setattr__方法\n            #实际上是地址的赋值,此时stack和rv都指向改空列表\n            self._local.stack = rv = []\n            #{\"__storage__\":{8080:{stack:rv=[]}},\"__ident_func__\":get_ident}\n        rv.append(obj)\n        # {\"__storage__\":{8080:{stack:rv=[ctx-&gt;request/session]}},\"__ident_func__\":get_ident}\n        # 应用上下文时候{\"__storage__\":{8080:{stack:rv=[app_ctx-&gt;(app/g)]}},\"__ident_func__\":get_ident}\n        return rv\n        #rv=[ctx-&gt;request/session]</code></pre> <p>到此,push完毕,应用上文结束,应用下文在离线脚本时候使用,另外:在global.py中</p></li> \n</ul> \n<pre class=\"python\"><code>def _find_app():\n    top = _app_ctx_stack.top    #得到app_ctx(app / g)\n    if top is None:\n        raise RuntimeError(_app_ctx_err_msg)\n    return top.app  #返回一个app即flask对象 只不过此时的flask对象 是公共的,与初始化的相同\n    # 但是是独立出来已经被配置好的Flask对象\n\n# LocalStack是 针对当前这个线程对独立的Flask_app进行修改, 不影响现在运行的app  =&gt;离线脚本\n#但是这个app 在请求结束后会从LocalStack中通过 __delattr__ 删除\n\n\n# context locals\n_request_ctx_stack = LocalStack()  #LocalStark = self._loacl = {\"__storage__\":{},\"__ident_func__\":get_ident}\n_app_ctx_stack = LocalStack()\ncurrent_app = LocalProxy(_find_app)   # current_app可以点 .run |  .route 等</code></pre>', NULL, '2019-10-11 15:25:33', 4, NULL, NULL, 'https://www.cnblogs.com/bigox/p/11652859.html', 0, NULL);
INSERT INTO `t_blog` VALUES (241, 'spring5 源码深度解析----- AOP目标方法和增强方法的执行（100%理解AOP）', '<p>上一篇博文中我们讲了代理类的生成，这一篇主要讲解剩下的部分，当代理类调用时，目标方法和代理方法是如何执行的,我们还是接着上篇的ReflectiveMethodInvocation类Proceed方法来看</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">public</span> Object proceed() <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> Throwable {\r\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 首先，判断是不是所有的interceptor（也可以想像成advisor）都被执行完了。\r\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 判断的方法是看currentInterceptorIndex这个变量的值，增加到Interceptor总个数这个数值没有，\r\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 如果到了，就执行被代理方法(invokeJoinpoint())；如果没到，就继续执行Interceptor。</span>\r\n    <span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">this</span>.currentInterceptorIndex == <span style=\"color: #0000ff;\">this</span>.interceptorsAndDynamicMethodMatchers.size() - 1<span style=\"color: #000000;\">) {\r\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> invokeJoinpoint();\r\n    }\r\n\r\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 如果Interceptor没有被全部执行完，就取出要执行的Interceptor，并执行。\r\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> currentInterceptorIndex先自增</span>\r\n     Object interceptorOrInterceptionAdvice = <span style=\"color: #0000ff;\">this</span>.interceptorsAndDynamicMethodMatchers.get(++<span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.currentInterceptorIndex);\r\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 如果Interceptor是PointCut类型</span>\r\n    <span style=\"color: #0000ff;\">if</span> (interceptorOrInterceptionAdvice <span style=\"color: #0000ff;\">instanceof</span><span style=\"color: #000000;\"> InterceptorAndDynamicMethodMatcher) {\r\n        InterceptorAndDynamicMethodMatcher dm </span>=<span style=\"color: #000000;\"> (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 如果当前方法符合Interceptor的PointCut限制，就执行Interceptor</span>\r\n        <span style=\"color: #0000ff;\">if</span> (dm.methodMatcher.matches(<span style=\"color: #0000ff;\">this</span>.method, <span style=\"color: #0000ff;\">this</span>.targetClass, <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.arguments)) {\r\n        　　 </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 这里将this当变量传进去，这是非常重要的一点</span>\r\n            <span style=\"color: #0000ff;\">return</span> dm.interceptor.invoke(<span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">);\r\n        }\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 如果不符合，就跳过当前Interceptor，执行下一个Interceptor</span>\r\n        <span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\r\n            </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> proceed();\r\n        }\r\n    }\r\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 如果Interceptor不是PointCut类型，就直接执行Interceptor里面的增强。</span>\r\n    <span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\r\n        </span><span style=\"color: #0000ff;\">return</span> ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(<span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">);\r\n    }\r\n}</span></pre> \n</div> \n<p>我们先来看一张方法调用顺序图</p> \n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"http://localhost:9090/blogImages/2019/10/11/5153dbea-cf37-468e-8510-cf8f70806271.png\" alt=\"\" width=\"1083\" height=\"611\"></p> \n<p>我们看到链中的顺序是AspectJAfterThrowingAdvice、AfterReturningAdviceInterceptor、AspectJAfterAdvice、MethodBeforeAdviceInterceptor，这些拦截器是按顺序执行的，那我们来看看第一个拦截器AspectJAfterThrowingAdvice中的invoke方法</p> \n<h2><strong>AspectJAfterThrowingAdvice</strong></h2> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\"> 1</span> <span style=\"color: #000000;\">@Override\r\n</span><span style=\"color: #008080;\"> 2</span> <span style=\"color: #0000ff;\">public</span> Object invoke(MethodInvocation mi) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> Throwable {\r\n</span><span style=\"color: #008080;\"> 3</span>     <span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\r\n</span><span style=\"color: #008080;\"> 4</span>         <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">直接调用MethodInvocation的proceed方法\r\n</span><span style=\"color: #008080;\"> 5</span>         <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">从proceed()方法中我们知道dm.interceptor.invoke(this)传过来的参数就是ReflectiveMethodInvocation执行器本身\r\n</span><span style=\"color: #008080;\"> 6</span>         <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">这里又直接调用了ReflectiveMethodInvocation的proceed()方法</span>\r\n<span style=\"color: #008080;\"> 7</span>         <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> mi.proceed();\r\n</span><span style=\"color: #008080;\"> 8</span> <span style=\"color: #000000;\">    }\r\n</span><span style=\"color: #008080;\"> 9</span>     <span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\"> (Throwable ex) {\r\n</span><span style=\"color: #008080;\">10</span>         <span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (shouldInvokeOnThrowing(ex)) {\r\n</span><span style=\"color: #008080;\">11</span>             invokeAdviceMethod(getJoinPointMatch(), <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">, ex);\r\n</span><span style=\"color: #008080;\">12</span> <span style=\"color: #000000;\">        }\r\n</span><span style=\"color: #008080;\">13</span>         <span style=\"color: #0000ff;\">throw</span><span style=\"color: #000000;\"> ex;\r\n</span><span style=\"color: #008080;\">14</span> <span style=\"color: #000000;\">    }\r\n</span><span style=\"color: #008080;\">15</span> }</pre> \n</div> \n<p>第一个拦截器AspectJAfterThrowingAdvice的invoke方法中，直接调用mi.proceed();，从proceed()方法中我们知道dm.interceptor.invoke(this)传过来的参数就是ReflectiveMethodInvocation执行器本身，所以又会执行proceed()方法，拦截器下标currentInterceptorIndex自增，获取下一个拦截器AfterReturningAdviceInterceptor，并调用拦截器中的invoke方法,，此时第一个拦截器在invoke()方法的第七行卡住了，接下来我们看第二个拦截器的执行</p> \n<h2><strong>AfterReturningAdviceInterceptor</strong></h2> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\">1</span> <span style=\"color: #000000;\">@Override\r\n</span><span style=\"color: #008080;\">2</span> <span style=\"color: #0000ff;\">public</span> Object invoke(MethodInvocation mi) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> Throwable {\r\n</span><span style=\"color: #008080;\">3</span>     <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">直接调用MethodInvocation的proceed方法</span>\r\n<span style=\"color: #008080;\">4</span>     Object retVal =<span style=\"color: #000000;\"> mi.proceed();\r\n</span><span style=\"color: #008080;\">5</span>     <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.advice.afterReturning(retVal, mi.getMethod(), mi.getArguments(), mi.getThis());\r\n</span><span style=\"color: #008080;\">6</span>     <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> retVal;\r\n</span><span style=\"color: #008080;\">7</span> }</pre> \n</div> \n<p>AfterReturningAdviceInterceptor还是直接调用mi.proceed()，又回到了ReflectiveMethodInvocation的proceed()方法中，此时AfterReturningAdviceInterceptor方法卡在第四行，接着回到ReflectiveMethodInvocation的proceed()方法中，拦截器下标currentInterceptorIndex自增，获取下一个拦截器AspectJAfterAdvice，并调用AspectJAfterAdvice中的invoke方法</p> \n<h2><strong>AspectJAfterAdvice</strong></h2> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\"> 1</span> <span style=\"color: #000000;\">@Override\r\n</span><span style=\"color: #008080;\"> 2</span> <span style=\"color: #0000ff;\">public</span> Object invoke(MethodInvocation mi) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> Throwable {\r\n</span><span style=\"color: #008080;\"> 3</span>     <span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\r\n</span><span style=\"color: #008080;\"> 4</span>         <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">直接调用MethodInvocation的proceed方法</span>\r\n<span style=\"color: #008080;\"> 5</span>         <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> mi.proceed();\r\n</span><span style=\"color: #008080;\"> 6</span> <span style=\"color: #000000;\">    }\r\n</span><span style=\"color: #008080;\"> 7</span>     <span style=\"color: #0000ff;\">finally</span><span style=\"color: #000000;\"> {\r\n</span><span style=\"color: #008080;\"> 8</span>         invokeAdviceMethod(getJoinPointMatch(), <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\r\n</span><span style=\"color: #008080;\"> 9</span> <span style=\"color: #000000;\">    }\r\n</span><span style=\"color: #008080;\">10</span> }</pre> \n</div> \n<p>AspectJAfterAdvice还是直接调用mi.proceed()，又回到了ReflectiveMethodInvocation的proceed()方法中，此时<strong>AspectJAfterAdvice</strong>方法卡在第五行，接着回到ReflectiveMethodInvocation的proceed()方法中，拦截器下标currentInterceptorIndex自增，获取下一个拦截器MethodBeforeAdviceInterceptor，并调用MethodBeforeAdviceInterceptor中的invoke方法</p> \n<h2><strong>MethodBeforeAdviceInterceptor</strong></h2> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\">1</span> <span style=\"color: #000000;\">@Override\r\n</span><span style=\"color: #008080;\">2</span> <span style=\"color: #0000ff;\">public</span> Object invoke(MethodInvocation mi) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> Throwable {\r\n</span><span style=\"color: #008080;\">3</span>     <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">终于开始做事了，调用增强器的before方法，明显是通过反射的方式调用\r\n</span><span style=\"color: #008080;\">4</span>     <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">到这里增强方法before的业务逻辑执行</span>\r\n<span style=\"color: #008080;\">5</span>     <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.advice.before(mi.getMethod(), mi.getArguments(), mi.getThis());\r\n</span><span style=\"color: #008080;\">6</span>     <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">又调用了调用MethodInvocation的proceed方法</span>\r\n<span style=\"color: #008080;\">7</span>     <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> mi.proceed();\r\n</span><span style=\"color: #008080;\">8</span> }</pre> \n</div> \n<p>第5行代码终于通过反射调用了切面里面的before方法，接着又调用mi.proceed()，我们知道这是最后一个拦截器了，此时this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1应该为true了，那么就会执行 return invokeJoinpoint();，也就是执行bean中的目标方法，接着我们来看看目标方法的执行</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #000000;\">@Nullable\r\n</span><span style=\"color: #0000ff;\">protected</span> Object invokeJoinpoint() <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> Throwable {\r\n    </span><span style=\"color: #0000ff;\">return</span> AopUtils.invokeJoinpointUsingReflection(<span style=\"color: #0000ff;\">this</span>.target, <span style=\"color: #0000ff;\">this</span>.method, <span style=\"color: #0000ff;\">this</span><span style=\"color: #000000;\">.arguments);\r\n}\r\n\r\n    @Nullable\r\n</span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">static</span><span style=\"color: #000000;\"> Object invokeJoinpointUsingReflection(@Nullable Object target, Method method, Object[] args)\r\n        </span><span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> Throwable {\r\n\r\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Use reflection to invoke the method.</span>\r\n    <span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\r\n        ReflectionUtils.makeAccessible(method);\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">直接通过反射调用目标bean中的method</span>\r\n        <strong><span style=\"color: #0000ff;\">return</span></strong><span style=\"color: #000000;\"><strong> method.invoke(target, args);</strong>\r\n    }\r\n    </span><span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\"> (InvocationTargetException ex) {\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Invoked method threw a checked exception.\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> We must rethrow it. The client won\'t see the interceptor.</span>\r\n        <span style=\"color: #0000ff;\">throw</span><span style=\"color: #000000;\"> ex.getTargetException();\r\n    }\r\n    </span><span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\"> (IllegalArgumentException ex) {\r\n        </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> AopInvocationException(\"AOP configuration seems to be invalid: tried calling method [\" +<span style=\"color: #000000;\">\r\n                method </span>+ \"] on target [\" + target + \"]\"<span style=\"color: #000000;\">, ex);\r\n    }\r\n    </span><span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\"> (IllegalAccessException ex) {\r\n        </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> AopInvocationException(\"Could not access method [\" + method + \"]\"<span style=\"color: #000000;\">, ex);\r\n    }\r\n}</span></pre> \n</div> \n<p>before方法执行完后，就通过反射的方式执行目标bean中的method，并且返回结果，接下来我们想想程序该怎么执行呢？</p> \n<p><strong>1&nbsp;、MethodBeforeAdviceInterceptor执行完了后，开始退栈,<strong>AspectJAfterAdvice中invoke卡在第5行的代码继续往下执行,&nbsp;我们看到在AspectJAfterAdvice的invoke方法中的finally中第8行有这样一句话 invokeAdviceMethod(getJoinPointMatch(), null, null);，就是通过反射调用AfterAdvice的方法，意思是切面类中的 @After方法不管怎样都会执行，因为在finally中</strong></strong></p> \n<p><strong><strong>&nbsp;2、AspectJAfterAdvice中invoke方法发执行完后，也开始退栈，接着就到了AfterReturningAdviceInterceptor的invoke方法的第4行开始恢复，但是此时如果目标bean和前面增强器中出现了异常，此时AfterReturningAdviceInterceptor中第5行代码就不会执行了，直接退栈；如果没有出现异常，则执行第5行，也就是通过反射执行切面类中@AfterReturning注解的方法，然后退栈</strong></strong></p> \n<p><strong><strong>3、AfterReturningAdviceInterceptor退栈后，就到了AspectJAfterThrowingAdvice拦截器，此拦截器中invoke方法的第7行开始恢复，我们看到在 catch (Throwable ex) { 代码中，也就是第11行 invokeAdviceMethod(getJoinPointMatch(), null, ex);，如果目标bean的method或者前面的增强方法中出现了异常，则会被这里的catch捕获，也是通过反射的方式执行@AfterThrowing注解的方法，然后退栈</strong></strong></p> \n<h2>总结</h2> \n<p>这个代理类调用过程，我们可以看到是一个递归的调用过程，通过ReflectiveMethodInvocation类中Proceed方法递归调用，顺序执行拦截器链中AspectJAfterThrowingAdvice、AfterReturningAdviceInterceptor、AspectJAfterAdvice、MethodBeforeAdviceInterceptor这几个拦截器，在拦截器中反射调用增强方法</p> \n<p><strong>&nbsp;</strong></p> \n<p>&nbsp;</p>', NULL, '2019-10-11 15:25:33', 5, NULL, NULL, 'https://www.cnblogs.com/java-chen-hao/p/11593064.html', 0, NULL);
INSERT INTO `t_blog` VALUES (242, '基于动态代理的WebAPI/RPC/webSocket框架,一套接口定义,多个通讯方式', '<p>API/RPC/webSocket三个看起来好像没啥相同的地方,在开发时,服务端,客户端实现代码也大不一样</p> \n<p>最近整理了一下,通过动态代理的形式,整合了这些开发,都通过统一的接口约束,服务端实现和客户端调用</p> \n<p>基于这样的形式,WebAPI/RPC/webSocket只需要定义一套接口,就能达到通用的效果</p> \n<p>&nbsp;</p> \n<p>&nbsp;<strong>示例接口约束</strong></p> \n<div class=\"cnblogs_code\"> \n <pre>    <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> TestObj\r\n    {\r\n        </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">string</span> Name { <span style=\"color: #0000ff;\">get</span>; <span style=\"color: #0000ff;\">set</span><span style=\"color: #000000;\">; }\r\n    }\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">interface</span><span style=\"color: #000000;\"> ITestService\r\n    {\r\n        </span><span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> Login();\r\n        </span><span style=\"color: #0000ff;\">bool</span> Test1(<span style=\"color: #0000ff;\">int</span> a,<span style=\"color: #0000ff;\">int</span>? b,<span style=\"color: #0000ff;\">out</span> <span style=\"color: #0000ff;\">string</span><span style=\"color: #000000;\"> error);\r\n        TestObj Test2(TestObj obj);\r\n    }\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> TestService : AbsService, ITestService\r\n    {\r\n        [LoginPoint]\r\n        </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> Login()\r\n        {\r\n            SaveSession(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">hubro</span><span style=\"color: #800000;\">\"</span>, <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">7777777777</span><span style=\"color: #800000;\">\"</span>, <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">test</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\r\n        }\r\n\r\n        </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">bool</span> Test1(<span style=\"color: #0000ff;\">int</span> a, <span style=\"color: #0000ff;\">int</span>? b, <span style=\"color: #0000ff;\">out</span> <span style=\"color: #0000ff;\">string</span><span style=\"color: #000000;\"> error)\r\n        {\r\n            </span><span style=\"color: #0000ff;\">var</span> user =<span style=\"color: #000000;\"> CurrentUserName;\r\n            </span><span style=\"color: #0000ff;\">var</span> tag =<span style=\"color: #000000;\"> CurrentUserTag;\r\n\r\n            error </span>= <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">out error</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">;\r\n            Console.WriteLine(a);\r\n            Console.WriteLine(b);\r\n            </span><span style=\"color: #0000ff;\">return</span> <span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">;\r\n        }\r\n\r\n        </span><span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> TestObj Test2(TestObj obj)\r\n        {\r\n            Console.WriteLine(obj.ToJson());\r\n            </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> obj;\r\n        }\r\n    }</span></pre> \n</div> \n<p>上面是一个标准接口和接口实现,并继承了AbsService,</p> \n<p>Login方法标注了LoginPoint特性,表示登录切入点,调用此接口时首先得调用此方法,方法内SaveSession存储登录状态</p> \n<p>Test1方法内使用了CurrentUserName,以获取登录方法保存的Session</p> \n<p><strong>特点:</strong></p> \n<ul> \n <li>通过接口约束服务端和客户端调用,参数定义透明化,out也支持</li> \n <li>真正的方法远程调用,任意参数类型,个数</li> \n <li>集成登录认证逻辑,自定义登录认证过程,也可以自定义Session实现</li> \n <li>集成简单数据签名,不用费心数据安全问题</li> \n</ul> \n<p><strong>技术实现:</strong></p> \n<ul> \n <li>Dynamitey实现接口类型代理</li> \n <li>DotNetty实现TCP通讯</li> \n <li>对象二进制序列化</li> \n</ul> \n<h2>RPC调用</h2> \n<p><strong>服务端</strong></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">var</span> server = <span style=\"color: #0000ff;\">new</span> ServerCreater().CreatetRPC(<span style=\"color: #800080;\">805</span><span style=\"color: #000000;\">);\r\n            server.CheckSign();\r\n            server.SetSessionManage(</span><span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SessionManage());\r\n            server.Register</span>&lt;ITestService, TestService&gt;<span style=\"color: #000000;\">();\r\n            server.Start();</span></pre> \n</div> \n<p>CreateRPC是一个扩展方法,引用CRL.RPC获取</p> \n<p>SetSessionManage,自定义Session存储,默认是内存里</p> \n<p>CheckSign 处理请求时,进行参数签名验证</p> \n<p><strong>客户端接口调用</strong></p> \n<div class=\"cnblogs_Highlighter\"> \n <pre class=\"brush:csharp;gutter:true;\">var clientConnect = new RPCClientConnect(\"127.0.0.1\", 805);\r\n            clientConnect.UseSign();\r\n            var service = clientConnect.GetClient&lt;ITestService&gt;();\r\n        label1:\r\n            service.Login();\r\n            Console.WriteLine(\"loginOk\");\r\n            int? a = 1;\r\n            string error;\r\n            service.Test1(1, a, out error);\r\n            Console.WriteLine(\"error:\" + error);\r\n            var obj2 = service.Test2(new TestObj() { Name = \"test\" });\r\n            Console.WriteLine(\"obj2:\" + obj2.ToJson());\r\n            Console.ReadLine();\r\n            goto label1;\r\n</pre> \n</div> \n<p>　　</p> \n<p>客户端先调用login方法进行登录,并记录服务端返回的token</p> \n<p>Test1方法将token回传给服务器以验证登录状态,并进行远程调用</p> \n<p>当调用了UseSign方法,就会对提交的参数进行签名,签名KEY为登录后服务端返回的TOKEN,服务端同样按此对签名进行比较　</p> \n<p>&nbsp;</p> \n<h2>动态webApi</h2> \n<p>同样基于上文结构,接口定义就不粘贴了</p> \n<p><strong>服务端定义</strong></p> \n<div class=\"cnblogs_Highlighter\"> \n <pre class=\"brush:csharp;gutter:true;\">var server = new ServerCreater().CreatetApi();\r\n            server.CheckSign();\r\n            server.SetSessionManage(new SessionManage());\r\n            server.Register&lt;ITestService, TestService&gt;();\r\n            var listener = new ServerListener();\r\n            //listener.Start(\"http://localhost:809/\");//自定义监听\r\n</pre> \n</div> \n<p>　</p> \n<p>如果宿主是.NET网站 在web.config增加处理module</p> \n<div class=\"cnblogs_Highlighter\"> \n <pre class=\"brush:csharp;gutter:true;\">&lt;system.webServer&gt;\r\n    &lt;modules&gt;\r\n      &lt;add name=\"DynamicModule\" type=\"CRL.DynamicWebApi.DynamicModule\" /&gt;\r\n    &lt;/modules&gt;\r\n  &lt;/system.webServer&gt;\r\n</pre> \n</div> \n<p>　　</p> \n<p>如果是单独程序,启动ServerListener即可</p> \n<p><strong>客户端调用</strong></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">var</span> clientConnect = <span style=\"color: #0000ff;\">new</span> CRL.DynamicWebApi.ApiClientConnect(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">http://localhost:53065</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\r\n            </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">var clientConnect = new CRL.DynamicWebApi.ApiClientConnect(\"</span><span style=\"color: #008000; text-decoration: underline;\">http://localhost</span><span style=\"color: #008000;\">:8022\");</span>\r\n<span style=\"color: #000000;\">            clientConnect.UseSign();\r\n            </span><span style=\"color: #0000ff;\">var</span> service = clientConnect.GetClient&lt;ITestService&gt;<span style=\"color: #000000;\">();\r\n        \r\n        label1:\r\n            service.Login();\r\n            Console.WriteLine(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">loginOk</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\r\n            </span><span style=\"color: #0000ff;\">int</span>? a = <span style=\"color: #800080;\">1</span><span style=\"color: #000000;\">;\r\n            </span><span style=\"color: #0000ff;\">string</span><span style=\"color: #000000;\"> error;\r\n            service.Test1(</span><span style=\"color: #800080;\">1</span>, a, <span style=\"color: #0000ff;\">out</span><span style=\"color: #000000;\"> error);\r\n            Console.WriteLine(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">error:</span><span style=\"color: #800000;\">\"</span> +<span style=\"color: #000000;\"> error);\r\n            </span><span style=\"color: #0000ff;\">var</span> obj2 = service.Test2(<span style=\"color: #0000ff;\">new</span> TestObj() { Name = <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">test</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\"> });\r\n            Console.WriteLine(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">obj2:</span><span style=\"color: #800000;\">\"</span> +<span style=\"color: #000000;\"> obj2.ToJson());\r\n            Console.ReadLine();\r\n            </span><span style=\"color: #0000ff;\">goto</span> label1;</pre> \n</div> \n<p>&nbsp;</p> \n<h2>WebSocket</h2> \n<p>WebSocket是一个比较特殊的方式,常用来做双工通讯的方式,客户端能往服务端发送数,服务端也能往客户端发送据</p> \n<p>除去服务端往客户端发数据,也可以采用接口调用的形式实现,在这里,服务端往客户端发送数据,客户端采用了订阅的方式</p> \n<p><strong>服务端实现</strong></p> \n<div class=\"cnblogs_Highlighter\"> \n <pre class=\"brush:csharp;gutter:true;\">var server = new ServerCreater().CreatetWebSocket(8015);\r\n            server.CheckSign();\r\n            server.SetSessionManage(new SessionManage());\r\n            server.Register&lt;ITestService, TestService&gt;();\r\n            server.Start();\r\n            new CRL.Core.ThreadWork().Start(\"send\", () =&gt;\r\n            {\r\n                var socket = server.GetServer() as CRL.WebSocket.WebSocketServer;\r\n                socket.SendMessage(\"hubro\", new socketMsg() { name = DateTime.Now.ToString() }, out string error);\r\n                Console.WriteLine(\"send msg\");\r\n                return true;\r\n            }, 10);\r\n</pre> \n</div> \n<p>　　</p> \n<p>上面演示代码,服务端开启了一个线程,定时往客户端\"hubro\"发送数据&nbsp;socket.SendMessage</p> \n<p><strong>客户端实现</strong></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">var</span> clientConnect = <span style=\"color: #0000ff;\">new</span> CRL.WebSocket.WebSocketClientConnect(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">127.0.0.1</span><span style=\"color: #800000;\">\"</span>, <span style=\"color: #800080;\">8015</span><span style=\"color: #000000;\">);\r\n            clientConnect.UseSign();\r\n            clientConnect.SubscribeMessage</span>&lt;socketMsg&gt;((obj) =&gt;<span style=\"color: #000000;\">\r\n            {\r\n                Console.WriteLine(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">OnMessage:</span><span style=\"color: #800000;\">\"</span> +<span style=\"color: #000000;\"> obj.ToJson());\r\n            });\r\n            clientConnect.StartPing();\r\n            </span><span style=\"color: #0000ff;\">var</span> service = clientConnect.GetClient&lt;ITestService&gt;<span style=\"color: #000000;\">();\r\n        label1:\r\n\r\n            service.Login();\r\n            Console.WriteLine(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">loginOk</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\r\n            </span><span style=\"color: #0000ff;\">int</span>? a = <span style=\"color: #800080;\">1</span><span style=\"color: #000000;\">;\r\n            </span><span style=\"color: #0000ff;\">string</span><span style=\"color: #000000;\"> error;\r\n            service.Test1(</span><span style=\"color: #800080;\">1</span>, a, <span style=\"color: #0000ff;\">out</span><span style=\"color: #000000;\"> error);\r\n            Console.WriteLine(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">error:</span><span style=\"color: #800000;\">\"</span> +<span style=\"color: #000000;\"> error);\r\n            </span><span style=\"color: #0000ff;\">var</span> obj2 = service.Test2(<span style=\"color: #0000ff;\">new</span> TestObj() { Name = <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">test</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\"> });\r\n            Console.WriteLine(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">obj2:</span><span style=\"color: #800000;\">\"</span> +<span style=\"color: #000000;\"> obj2.ToJson());\r\n            Console.ReadLine();\r\n            </span><span style=\"color: #0000ff;\">goto</span> label1;</pre> \n</div> \n<p>clientConnect.SubscribeMessage就是订阅消息了,通过订阅的方式,处理服务端发送的数据</p> \n<p>&nbsp;</p> \n<p>可以看到以上各种形式,服务端实现和客户端调用基本相同,定义的接口能重复使用,做接口通讯效果杠杠的</p> \n<p>具体实现方式和细节功能参见源码和demo,已经开源,请自行下载</p> \n<h2>源码地址:</h2> \n<p><strong>CRL:</strong></p> \n<p><a href=\"https://github.com/hubro-xx/CRL5\">https://github.com/hubro-xx/CRL5</a></p> \n<p><strong>RCP:</strong></p> \n<p>https://github.com/hubro-xx/CRL5/tree/master/RPC</p> \n<p><strong>WebAPI:</strong></p> \n<p>https://github.com/hubro-xx/CRL5/tree/master/DynamicWebApi</p> \n<p><strong>WebSocket:</strong></p> \n<p>https://github.com/hubro-xx/CRL5/tree/master/WebSocket</p>', NULL, '2019-10-11 15:25:34', 4, NULL, NULL, 'https://www.cnblogs.com/hubro/p/11652687.html', 0, NULL);
INSERT INTO `t_blog` VALUES (243, '从零开始入门 K8s | 可观测性：你的应用健康吗？', '<p>作者 | 莫源&nbsp;阿里巴巴技术专家</p> \n<h2 id=\"一需求来源\"><strong>一、需求来源</strong></h2> \n<p>首先来看一下，整个需求的来源：当把应用迁移到 Kubernetes 之后，要如何去保障应用的健康与稳定呢？其实很简单，可以从两个方面来进行增强：</p> \n<ol> \n <li>首先是提高应用的可观测性；</li> \n <li>第二是提高应用的可恢复能力。</li> \n</ol> \n<p>从可观测性上来讲，可以在三个方面来去做增强：</p> \n<ol> \n <li>首先是应用的健康状态上面，可以实时地进行观测；</li> \n <li>第二个是可以获取应用的资源使用情况；</li> \n <li>第三个是可以拿到应用的实时日志，进行问题的诊断与分析。</li> \n</ol> \n<p>当出现了问题之后，首先要做的事情是要降低影响的范围，进行问题的调试与诊断。最后当出现问题的时候，理想的状况是：可以通过和 K8s 集成的自愈机制进行完整的恢复。</p> \n<h2 id=\"二liveness-与-readiness\"><strong>二、Liveness 与 Readiness</strong></h2> \n<p>本小节为大家介绍 Liveness probe 和 eadiness probe。</p> \n<h3 id=\"应用健康状态-初识-liveness-与-readiness\">应用健康状态-初识 Liveness 与 Readiness</h3> \n<p>Liveness probe 也叫就绪指针，用来判断一个 pod 是否处在就绪状态。当一个 pod 处在就绪状态的时候，它才能够对外提供相应的服务，也就是说接入层的流量才能打到相应的 pod。当这个 pod 不处在就绪状态的时候，接入层会把相应的流量从这个 pod 上面进行摘除。</p> \n<p>来看一下简单的一个例子：</p> \n<p>如下图其实就是一个 Readiness 就绪的一个例子：</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/9ba81c2d-9d69-47ed-9751-2e0da2826ad3.octet-stream\" alt=\"1\"></p> \n<p>当这个 pod 指针判断一直处在失败状态的时候，其实接入层的流量不会打到现在这个 pod 上。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/70a8febd-5646-454c-9a8e-bd8f5104d228.octet-stream\" alt=\"2\"></p> \n<p>当这个 pod 的状态从 FAIL 的状态转换成 success 的状态时，它才能够真实地承载这个流量。<br>&nbsp;<br>Liveness 指针也是类似的，它是存活指针，用来判断一个 pod 是否处在存活状态。当一个 pod 处在不存活状态的时候，会出现什么事情呢？</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/c2484ccb-17df-4d5e-9a39-b08c268a5c70.octet-stream\" alt=\"3\"></p> \n<p>这个时候会由上层的判断机制来判断这个 pod 是否需要被重新拉起。那如果上层配置的重启策略是 restart always 的话，那么此时这个 pod 会直接被重新拉起。</p> \n<h3 id=\"应用健康状态-使用方式\">应用健康状态-使用方式</h3> \n<p>接下来看一下 Liveness 指针和 Readiness 指针的具体的用法。</p> \n<h4 id=\"探测方式\">探测方式</h4> \n<p>Liveness 指针和 Readiness 指针支持三种不同的探测方式：</p> \n<ol> \n <li>第一种是 httpGet。它是通过发送 http Get 请求来进行判断的，当返回码是 200-399 之间的状态码时，标识这个应用是健康的；</li> \n <li>第二种探测方式是 Exec。它是通过执行容器中的一个命令来判断当前的服务是否是正常的，当命令行的返回结果是 0，则标识容器是健康的；</li> \n <li>第三种探测方式是 tcpSocket 。它是通过探测容器的 IP 和 Port 进行 TCP 健康检查，如果这个 TCP 的链接能够正常被建立，那么标识当前这个容器是健康的。</li> \n</ol> \n<h4 id=\"探测结果\">探测结果</h4> \n<p>从探测结果来讲主要分为三种：</p> \n<ul> \n <li>第一种是 success，当状态是 success 的时候，表示 container 通过了健康检查，也就是 Liveness probe 或 Readiness probe 是正常的一个状态；</li> \n <li>第二种是 Failure，Failure 表示的是这个 container 没有通过健康检查，如果没有通过健康检查的话，那么此时就会进行相应的一个处理，那在 Readiness 处理的一个方式就是通过 service。service 层将没有通过 Readiness 的 pod 进行摘除，而 Liveness 就是将这个 pod 进行重新拉起，或者是删除。</li> \n <li>第三种状态是 Unknown，Unknown 是表示说当前的执行的机制没有进行完整的一个执行，可能是因为类似像超时或者像一些脚本没有及时返回，那么此时 Readiness-probe 或 Liveness-probe 会不做任何的一个操作，会等待下一次的机制来进行检验。</li> \n</ul> \n<p>那在 kubelet 里面有一个叫 ProbeManager 的组件，这个组件里面会包含 Liveness-probe 或 Readiness-probe，这两个 probe 会将相应的 Liveness 诊断和 Readiness 诊断作用在 pod 之上，来实现一个具体的判断。</p> \n<h3 id=\"应用健康状态-pod-probe-spec\">应用健康状态-Pod Probe Spec</h3> \n<p>下面介绍这三种方式不同的检测方式的一个 yaml 文件的使用。</p> \n<p>首先先看一下 exec，exec 的使用其实非常简单。如下图所示，大家可以看到这是一个 Liveness probe，它里面配置了一个 exec 的一个诊断。接下来，它又配置了一个 command 的字段，这个 command 字段里面通过 cat 一个具体的文件来判断当前 Liveness probe 的状态，当这个文件里面返回的结果是 0 时，或者说这个命令返回是 0 时，它会认为此时这个 pod 是处在健康的一个状态。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/7be130bd-1426-4461-b457-35ca39b01ad6.octet-stream\" alt=\"4\"></p> \n<p>那再来看一下这个 httpGet，httpGet 里面有一个字段是路径，第二个字段是 port，第三个是 headers。这个地方有时需要通过类似像 header 头的一个机制做 health 的一个判断时，需要配置这个 header，通常情况下，可能只需要通过 health 和 port 的方式就可以了。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/a186e665-d2bc-4222-9369-723959ea0eb4.octet-stream\" alt=\"5\"></p> \n<p>第三种是 tcpSocket，tcpSocket 的使用方式其实也比较简单，你只需要设置一个检测的端口，像这个例子里面使用的是 8080 端口，当这个 8080 端口 tcp connect 审核正常被建立的时候，那 tecSocket，Probe 会认为是健康的一个状态。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/e1d6b00e-64c9-4f22-8a82-110075e566d4.octet-stream\" alt=\"6\"></p> \n<p>此外还有如下的五个参数，是 Global 的参数。</p> \n<ul> \n <li>第一个参数叫 initialDelaySeconds，它表示的是说这个 pod 启动延迟多久进行一次检查，比如说现在有一个 Java 的应用，它启动的时间可能会比较长，因为涉及到 jvm 的启动，包括 Java 自身 jar 的加载。所以前期，可能有一段时间是没有办法被检测的，而这个时间又是可预期的，那这时可能要设置一下 initialDelaySeconds；</li> \n</ul> \n<p>&nbsp;</p> \n<ul> \n <li>第二个是 periodSeconds，它表示的是检测的时间间隔，正常默认的这个值是 10 秒；</li> \n</ul> \n<p>&nbsp;</p> \n<ul> \n <li>第三个字段是 timeoutSeconds，它表示的是检测的超时时间，当超时时间之内没有检测成功，那它会认为是失败的一个状态；</li> \n</ul> \n<p>&nbsp;</p> \n<ul> \n <li>第四个是 successThreshold，它表示的是：当这个 pod 从探测失败到再一次判断探测成功，所需要的阈值次数，默认情况下是 1 次，表示原本是失败的，那接下来探测这一次成功了，就会认为这个 pod 是处在一个探针状态正常的一个状态；</li> \n</ul> \n<p>&nbsp;</p> \n<ul> \n <li>最后一个参数是 failureThreshold，它表示的是探测失败的重试次数，默认值是 3，表示的是当从一个健康的状态连续探测 3 次失败，那此时会判断当前这个pod的状态处在一个失败的状态。</li> \n</ul> \n<h3 id=\"应用健康状态-liveness-与-readiness-总结\">应用健康状态-Liveness 与 Readiness 总结</h3> \n<p>接下来对 Liveness 指针和 Readiness 指针进行一个简单的总结。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/fbf72c02-cb0e-43db-a60b-6e639f9597d6.octet-stream\" alt=\"7\"></p> \n<h4 id=\"介绍\">介绍</h4> \n<p>Liveness 指针是存活指针，它用来判断容器是否存活、判断 pod 是否 running。如果 Liveness 指针判断容器不健康，此时会通过 kubelet 杀掉相应的 pod，并根据重启策略来判断是否重启这个容器。如果默认不配置 Liveness 指针，则默认情况下认为它这个探测默认返回是成功的。</p> \n<p>Readiness 指针用来判断这个容器是否启动完成，即 pod 的 condition 是否 ready。如果探测的一个结果是不成功，那么此时它会从 pod 上 Endpoint 上移除，也就是说从接入层上面会把前一个 pod 进行摘除，直到下一次判断成功，这个 pod 才会再次挂到相应的 endpoint 之上。</p> \n<h4 id=\"检测失败\">检测失败</h4> \n<p>对于检测失败上面来讲 Liveness 指针是直接杀掉这个 pod，而 Readiness 指针是切掉 endpoint 到这个 pod 之间的关联关系，也就是说它把这个流量从这个 pod 上面进行切掉。</p> \n<h4 id=\"适用场景\">适用场景</h4> \n<p>Liveness 指针适用场景是支持那些可以重新拉起的应用，而 Readiness 指针主要应对的是启动之后无法立即对外提供服务的这些应用。</p> \n<h4 id=\"注意事项\">注意事项</h4> \n<p>在使用 Liveness 指针和 Readiness 指针的时候有一些注意事项。因为不论是 Liveness 指针还是 Readiness 指针都需要配置合适的探测方式，以免被误操作。</p> \n<ul> \n <li><p>第一个是调大超时的阈值，因为在容器里面执行一个 shell 脚本，它的执行时长是非常长的，平时在一台 ecs 或者在一台 vm 上执行，可能 3 秒钟返回的一个脚本在容器里面需要 30 秒钟。所以这个时间是需要在容器里面事先进行一个判断的，那如果可以调大超时阈值的方式，来防止由于容器压力比较大的时候出现偶发的超时；</p></li> \n <li><p>第二个是调整判断的一个次数，3 次的默认值其实在比较短周期的判断周期之下，不一定是最佳实践，适当调整一下判断的次数也是一个比较好的方式；</p></li> \n <li><p>第三个是 exec，如果是使用 shell 脚本的这个判断，调用时间会比较长，比较建议大家可以使用类似像一些编译性的脚本 Golang 或者一些 C 语言、C++ 编译出来的这个二进制的 binary 进行判断，那这种通常会比 shell 脚本的执行效率高 30% 到 50%；</p></li> \n <li><p>第四个是如果使用 tcpSocket 方式进行判断的时候，如果遇到了 TLS 的服务，那可能会造成后边 TLS 里面有很多这种未健全的 tcp connection，那这个时候需要自己对业务场景上来判断，这种的链接是否会对业务造成影响。</p></li> \n</ul> \n<p>&nbsp;</p> \n<h2 id=\"三问题诊断\"><strong>三、问题诊断</strong></h2> \n<p>接下来给大家讲解一下在 K8s 中常见的问题诊断。</p> \n<h3 id=\"应用故障排查-了解状态机制\">应用故障排查-了解状态机制</h3> \n<p>首先要了解一下 K8s 中的一个设计理念，就是这个状态机制。因为 K8s 是整个的一个设计是面向状态机的，它里面通过 yaml 的方式来定义的是一个期望到达的一个状态，而真正这个 yaml 在执行过程中会由各种各样的 controller来负责整体的状态之间的一个转换。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/fa4c394a-0aa0-4d73-9eef-b125a9ec8c03.octet-stream\" alt=\"8\"><br> <img src=\"http://localhost:9090/blogImages/2019/10/11/c949401b-7104-496a-95c2-5435dc72709c.octet-stream\" alt=\"9\"></p> \n<p>比如说上面的图，实际上是一个 Pod 的一个生命周期。刚开始它处在一个 pending 的状态，那接下来可能会转换到类似像 running，也可能转换到 Unknown，甚至可以转换到 failed。然后，当 running 执行了一段时间之后，它可以转换到类似像 successded 或者是 failed，然后当出现在 unknown 这个状态时，可能由于一些状态的恢复，它会重新恢复到 running 或者 successded 或者是 failed 。</p> \n<p>其实 K8s 整体的一个状态就是基于这种类似像状态机的一个机制进行转换的，而不同状态之间的转化都会在相应的 K8s对象上面留下来类似像 Status 或者像 Conditions 的一些字段来进行表示。</p> \n<p>像下面这张图其实表示的就是说在一个 Pod 上面一些状态位的一些展现。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/6802f388-311c-4332-9790-9a0cd14dcabd.octet-stream\" alt=\"10\"></p> \n<p>比如说在 Pod 上面有一个字段叫 Status，这个 Status 表示的是 Pod 的一个聚合状态，在这个里面，这个聚合状态处在一个 pending 状态。</p> \n<p>然后再往下看，因为一个 pod 里面有多个 container，每个 container 上面又会有一个字段叫 State，然后 State 的状态表示当前这个 container 的一个聚合状态。那在这个例子里面，这个聚合状态处在的是 waiting 的状态，那具体的原因是因为什么呢？是因为它的镜像没有拉下来，所以处在 waiting 的状态，是在等待这个镜像拉取。然后这个 ready 的部分呢，目前是 false，因为它这个进行目前没有拉取下来，所以这个 pod 不能够正常对外服务，所以此时 ready 的状态是未知的，定义为 false。如果上层的 endpoint 发现底层这个 ready 不是 true 的话，那么此时这个服务是没有办法对外服务的。</p> \n<p>再往下是 condition，condition 这个机制表示是说：在 K8s 里面有很多这种比较小的这个状态，而这个状态之间的聚合会变成上层的这个 Status。那在这个例子里面有几个状态，第一个是 Initialized，表示是不是已经初始化完成？那在这个例子里面已经是初始化完成的，那它走的是第二个阶段，是在这个 ready 的状态。因为上面几个 container 没有拉取下来相应的镜像，所以 ready 的状态是 false。</p> \n<p>然后再往下可以看到这个 container 是否 ready，这里可以看到是 false，而这个状态是 PodScheduled，表示说当前这个 pod 是否是处在一个已经被调度的状态，它已经 bound 在现在这个 node 之上了，所以这个状态也是 true。</p> \n<p>那可以通过相应的 condition 是 true 还是 false 来判断整体上方的这个状态是否是正常的一个状态。而在 K8s 里面不同的状态之间的这个转换都会发生相应的事件，而事件分为两种： 一种叫做 normal 的事件，一种是 warning 事件。大家可以看见在这第一条的事件是有个 normal 事件，然后它相应的 reason 是 scheduler，表示说这个 pod 已经被默认的调度器调度到相应的一个节点之上，然后这个节点是 cn-beijing192.168.3.167 这个节点之上。</p> \n<p>再接下来，又是一个 normal 的事件，表示说当前的这个镜像在 pull 相应的这个 image。然后再往下是一个 warning 事件，这个 warning 事件表示说 pull 这个镜像失败了。</p> \n<p>以此类推，这个地方表示的一个状态就是说在 K8s 里面这个状态机制之间这个状态转换会产生相应的事件，而这个事件又通过类似像 normal 或者是 warning 的方式进行暴露。开发者可以通过类似像通过这个事件的机制，可以通过上层 condition Status 相应的一系列的这个字段来判断当前这个应用的具体的状态以及进行一系列的诊断。</p> \n<h3 id=\"应用故障排查-常见应用异常\">应用故障排查-常见应用异常</h3> \n<p>本小节介绍一下常见应用的一些异常。首先是 pod 上面，pod 上面可能会停留几个常见的状态。</p> \n<h4 id=\"pod-停留在-pending\">Pod 停留在 Pending</h4> \n<p>第一个就是 pending 状态，pending 表示调度器没有进行介入。此时可以通过 kubectl describe pod 来查看相应的事件，如果由于资源或者说端口占用，或者是由于 node selector 造成 pod 无法调度的时候，可以在相应的事件里面看到相应的结果，这个结果里面会表示说有多少个不满足的 node，有多少是因为 CPU 不满足，有多少是由于 node 不满足，有多少是由于&nbsp;tag&nbsp;打标造成的不满足。</p> \n<h4 id=\"pod-停留在-waiting\">Pod 停留在 waiting</h4> \n<p>那第二个状态就是 pod 可能会停留在 waiting 的状态，pod 的 states 处在 waiting 的时候，通常表示说这个 pod 的镜像没有正常拉取，原因可能是由于这个镜像是私有镜像，但是没有配置 Pod secret；那第二种是说可能由于这个镜像地址是不存在的，造成这个镜像拉取不下来；还有一个是说这个镜像可能是一个公网的镜像，造成镜像的拉取失败。</p> \n<h4 id=\"pod-不断被拉取并且可以看到-crashing\">Pod 不断被拉取并且可以看到 crashing</h4> \n<p>第三种是 pod 不断被拉起，而且可以看到类似像 backoff 。这个通常表示说 pod 已经被调度完成了，但是启动失败，那这个时候通常要关注的应该是这个应用自身的一个状态，并不是说配置是否正确、权限是否正确，此时需要查看的应该是 pod 的具体日志。</p> \n<h4 id=\"pod-处在-runing-但是没有正常工作\">Pod 处在 Runing 但是没有正常工作</h4> \n<p>第四种 pod 处在 running 状态，但是没有正常对外服务。那此时比较常见的一个点就可能是由于一些非常细碎的配置，类似像有一些字段可能拼写错误，造成了 yaml 下发下去了，但是有一段没有正常地生效，从而使得这个 pod 处在 running 的状态没有对外服务，那此时可以通过 apply-validate-f pod.yaml 的方式来进行判断当前 yaml 是否是正常的，如果 yaml 没有问题，那么接下来可能要诊断配置的端口是否是正常的，以及 Liveness 或 Readiness 是否已经配置正确。</p> \n<h4 id=\"service-无法正常的工作\">Service 无法正常的工作</h4> \n<p>最后一种就是 service 无法正常工作的时候，该怎么去判断呢？那比较常见的 service 出现问题的时候，是自己的使用上面出现了问题。因为 service 和底层的 pod 之间的关联关系是通过 selector 的方式来匹配的，也就是说 pod 上面配置了一些 label，然后 service 通过 match label 的方式和这个 pod 进行相互关联。如果这个 label 配置的有问题，可能会造成这个 service 无法找到后面的 endpoint，从而造成相应的 service 没有办法对外提供服务，那如果 service 出现异常的时候，第一个要看的是这个 service 后面是不是有一个真正的 endpoint，其次来看这个 endpoint 是否可以对外提供正常的服务。</p> \n<h2 id=\"四应用远程调试\"><strong>四、应用远程调试</strong></h2> \n<p>本节讲解的是在 K8s 里面如何进行应用的远程调试，远程调试主要分为 pod 的远程调试以及 service 的远程调试。还有就是针对一些性能优化的远程调试。</p> \n<h3 id=\"应用远程调试---pod-远程调试\">应用远程调试 - Pod 远程调试</h3> \n<p>首先把一个应用部署到集群里面的时候，发现问题的时候，需要进行快速验证，或者说修改的时候，可能需要类似像登陆进这个容器来进行一些诊断。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/9d84c3ad-8dda-4412-a3aa-16ef58699926.octet-stream\" alt=\"11\"></p> \n<p>比如说可以通过 exec 的方式进入一个 pod。像这条命令里面，通过 kubectl exec-it pod-name 后面再填写一个相应的命令，比如说 /bin/bash，表示希望到这个 pod 里面进入一个交互式的一个 bash。然后在 bash 里面可以做一些相应的命令，比如说修改一些配置，通过 supervisor 去重新拉起这个应用，都是可以的。</p> \n<p>那如果指定这一个 pod 里面可能包含着多个 container，这个时候该怎么办呢？怎么通过 pod 来指定 container 呢？其实这个时候有一个参数叫做 -c，如上图下方的命令所示。-c 后面是一个 container-name，可以通过 pod 在指定 -c 到这个 container-name，具体指定要进入哪个 container，后面再跟上相应的具体的命令，通过这种方式来实现一个多容器的命令的一个进入，从而实现多容器的一个远程调试。</p> \n<h3 id=\"应用远程调试---servic-远程调试\">应用远程调试 - Servic 远程调试</h3> \n<p>那么 service 的远程调试该怎么做呢？service 的远程调试其实分为两个部分：</p> \n<ul> \n <li>第一个部分是说我想将一个服务暴露到远程的一个集群之内，让远程集群内的一些应用来去调用本地的一个服务，这是一条反向的一个链路；</li> \n <li>还有一种方式是我想让这个本地服务能够去调远程的服务，那么这是一条正向的链路。</li> \n</ul> \n<p>在反向列入上面有这样一个开源组件，叫做 Telepresence，它可以将本地的应用代理到远程集群中的一个 service 上面，使用它的方式非常简单。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/a43e323c-1428-47a7-bc91-e9ebbdd1a4e3.octet-stream\" alt=\"12\"></p> \n<p>首先先将 Telepresence 的一个 Proxy 应用部署到远程的 K8s 集群里面。然后将远程单一个 deployment swap 到本地的一个 application，使用的命令就是 Telepresence-swap-deployment 然后以及远程的 DEPLOYMENT_NAME。通过这种方式就可以将本地一个 application 代理到远程的 service 之上、可以将应用在远程集群里面进行本地调试，这个有兴趣的同学可以到 GitHub 上面来看一下这个插件的使用的方式。</p> \n<p>第二个是如果本地应用需要调用远程集群的服务时候，可以通过 port-forward 的方式将远程的应用调用到本地的端口之上。比如说现在远程的里面有一个 API server，这个 API server 提供了一些端口，本地在调试 Code 时候，想要直接调用这个 API server，那么这时，比较简单的一个方式就是通过 port-forward 的方式。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/d226a5fd-43b9-45a8-ae48-5102180cadf4.octet-stream\" alt=\"13\"></p> \n<p>它的使用方式是 kubectl port-forward，然后 service 加上远程的 service name，再加上相应的 namespace，后面还可以加上一些额外的参数，比如说端口的一个映射，通过这种机制就可以把远程的一个应用代理到本地的端口之上，此时通过访问本地端口就可以访问远程的服务。</p> \n<h3 id=\"开源的调试工具---kubectl-debug\">开源的调试工具 - kubectl-debug</h3> \n<p>最后再给大家介绍一个开源的调试工具，它也是 kubectl 的一个插件，叫 kubectl-debug。我们知道在 K8s 里面，底层的容器 runtime 比较常见的就是类似像 docker 或者是 containerd，不论是 docker 还是 containerd，它们使用的一个机制都是基于 Linux namespace 的一个方式进行虚拟化和隔离的。</p> \n<p>通常情况下 ，并不会在镜像里面带特别多的调试工具，类似像 netstat telnet 等等这些 ，因为这个会造成应用整体非常冗余。那么如果想要调试的时候该怎么做呢？其实这个时候就可以依赖类似于像 kubectl-debug 这样一个工具。<br>&nbsp;<br> kubectl-debug 这个工具是依赖于 Linux namespace 的方式来去做的，它可以 datash 一个 Linux namespace 到一个额外的 container，然后在这个 container 里面执行任何的 debug 动作，其实和直接去 debug 这个 Linux namespace 是一致的。这里有一个简单的操作，给大家来介绍一下：</p> \n<p>这个地方其实已经安装好了 kubectl-debug，它是 kubectl 的一个插件。所以这个时候，你可以直接通过 kubectl-debug 这条命令来去诊断远程的一个 pod。像这个例子里面，当执行 debug 的时候，实际上它首先会先拉取一些镜像，这个镜像里面实际上会默认带一些诊断的工具。当这个镜像启用的时候，它会把这个 debug container 进行启动。与此同时会把这个 container 和相应的你要诊断的这个 container 的 namespace 进行挂靠，也就说此时这个 container 和你是同 namespace 的，类似像网络站，或者是类似像内核的一些参数，其实都可以在这个 debug container 里面实时地进行查看。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/4323e0be-8346-479a-915c-28ec719909e2.octet-stream\" alt=\"14\"></p> \n<p>像这个例子里面，去查看类似像 hostname、进程、netstat 等等，这些其实都是和这个需要 debug 的 pod 是在同一个环境里面的，所以你之前这三条命令可以看到里面相关的信息。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/6d600b35-3c76-4bf6-9fd0-a00307179d3e.octet-stream\" alt=\"15\"></p> \n<p>如果此时进行 logout 的话，相当于会把相应的这个 debug pod 杀掉，然后进行退出，此时对应用实际上是没有任何的影响的。那么通过这种方式可以不介入到容器里面，就可以实现相应的一个诊断。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/9f8918ee-8a82-4450-97e3-ec4730716686.octet-stream\" alt=\"16\"></p> \n<p>此外它还支持额外的一些机制，比如说我给设定一些 image，然后类似像这里面安装了的是 htop，然后开发者可以通过这个机制来定义自己需要的这个命令行的工具，并且通过这种 image 的方式设置进来。那么这个时候就可以通过这种机制来调试远程的一个 pod。</p> \n<h1 id=\"本节总结\"><strong>本节总结</strong></h1> \n<ul> \n <li><p>关于 Liveness 和 Readiness 的指针。Liveness probe 就是保活指针，它是用来看 pod 是否存活的，而 Readiness probe 是就绪指针，它是判断这个 pod 是否就绪的，如果就绪了，就可以对外提供服务。这个就是 Liveness 和 Readiness 需要记住的部分；</p></li> \n <li><p>应用诊断的三个步骤：首先 describe 相应的一个状态；然后提供状态来排查具体的一个诊断方向；最后来查看相应对象的一个 event 获取更详细的一个信息；</p></li> \n <li><p>提供 pod 一个日志来定位应用的自身的一个状态；</p></li> \n <li><p>远程调试的一个策略，如果想把本地的应用代理到远程集群，此时可以通过 Telepresence 这样的工具来实现，如果想把远程的应用代理到本地，然后在本地进行调用或者是调试，可以用类似像 port-forward 这种机制来实现。</p></li> \n</ul> \n<blockquote> \n <p><strong>“ 阿里巴巴云原生微信公众号（ID：Alicloudnative）关注微服务、Serverless、容器、Service Mesh等技术领域、聚焦云原生流行技术趋势、云原生大规模的落地实践，做最懂云原生开发者的技术公众号。”</strong></p> \n</blockquote>', '作者 | 莫源 阿里巴巴技术专家 \n一、需求来源 \n首先来看一下，整个需求的来源：当把应用迁移到 Kubernetes 之后，要如何去保障应用的健康与稳定呢？其实很简单，可以从两个方面来进行增强： \n \n 首先是提高应用的可观测性； \n 第二是提高应用的可恢复能力。 \n \n从可观测性上来讲，可以在三个方面来去', '2019-10-11 15:25:47', 7, 1, '', 'https://www.cnblogs.com/alisystemsoftware/p/11652536.html', 1, '2019-10-17 17:10:04');
INSERT INTO `t_blog` VALUES (244, '如何决定使用 HashMap 还是 TreeMap？', '<p><strong>问：</strong><strong>如何决定使用 HashMap 还是 TreeMap？</strong></p> \n<h3>介绍</h3> \n<p><code>TreeMap&lt;K,V&gt;</code>的Key值是要求实现<code>java.lang.Comparable</code>，所以迭代的时候TreeMap默认是按照Key值升序排序的；TreeMap的实现是基于红黑树结构。适用于按自然顺序或自定义顺序遍历键（key）。</p> \n<p><code>HashMap&lt;K,V&gt;</code>的Key值实现散列<code>hashCode()</code>，分布是散列的、均匀的，不支持排序；数据结构主要是桶(数组)，链表或红黑树。适用于在Map中插入、删除和定位元素。</p> \n<h3>结论</h3> \n<p>如果你需要得到一个有序的结果时就应该使用TreeMap（因为HashMap中元素的排列顺序是不固定的）。除此之外，由于HashMap有更好的性能，所以大多不需要排序的时候我们会使用HashMap。</p> \n<h3>拓展</h3> \n<p><strong>1、HashMap 和 TreeMap 的实现</strong></p> \n<p><strong>HashMap：</strong>基于哈希表实现。使用HashMap要求添加的键类明确定义了<code>hashCode()</code>和<code>equals()</code>[可以重写<code>hashCode()</code>和<code>equals()</code>]，为了优化HashMap空间的使用，您可以调优初始容量和负载因子。</p> \n<ul class=\"list-paddingleft-2\"> \n <li>HashMap(): 构建一个空的哈希映像</li> \n <li>HashMap(Map m): 构建一个哈希映像，并且添加映像m的所有映射</li> \n <li>HashMap(int initialCapacity): 构建一个拥有特定容量的空的哈希映像</li> \n <li>HashMap(int initialCapacity, float loadFactor): 构建一个拥有特定容量和加载因子的空的哈希映像</li> \n</ul> \n<p><strong>TreeMap：</strong>基于红黑树实现。TreeMap没有调优选项，因为该树总处于平衡状态。</p> \n<ul class=\"list-paddingleft-2\"> \n <li>TreeMap()：构建一个空的映像树</li> \n <li>TreeMap(Map m): 构建一个映像树，并且添加映像m中所有元素</li> \n <li>TreeMap(Comparator c): 构建一个映像树，并且使用特定的比较器对关键字进行排序</li> \n <li>TreeMap(SortedMap s): 构建一个映像树，添加映像树s中所有映射，并且使用与有序映像s相同的比较器排序</li> \n</ul> \n<p><strong>2、HashMap 和 TreeMap 都是非线程安全</strong></p> \n<p>HashMap继承AbstractMap抽象类，TreeMap继承自SortedMap接口。</p> \n<p><strong>AbstractMap抽象类：</strong>覆盖了equals()和hashCode()方法以确保两个相等映射返回相同的哈希码。如果两个映射大小相等、包含同样的键且每个键在这两个映射中对应的值都相同，则这两个映射相等。映射的哈希码是映射元素哈希码的总和，其中每个元素是Map.Entry接口的一个实现。因此，不论映射内部顺序如何，两个相等映射会报告相同的哈希码。</p> \n<p><strong>SortedMap接口：</strong>它用来保持键的有序顺序。SortedMap接口为映像的视图(子集)，包括两个端点提供了访问方法。除了排序是作用于映射的键以外，处理SortedMap和处理SortedSet一样。添加到SortedMap实现类的元素必须实现Comparable接口，否则您必须给它的构造函数提供一个Comparator接口的实现。TreeMap类是它的唯一一个实现。</p> \n<p><strong>3、TreeMap中默认是按照升序进行排序的，如何让他降序</strong></p> \n<p>通过自定义的比较器来实现</p> \n<p>定义一个比较器类，实现Comparator接口，重写compare方法，有两个参数，这两个参数通过调用compareTo进行比较，而compareTo默认规则是：</p> \n<blockquote> \n <ul class=\"list-paddingleft-2\"> \n  <li>如果参数字符串等于此字符串，则返回 0 值；</li> \n  <li>如果此字符串小于字符串参数，则返回一个小于 0 的值；</li> \n  <li>如果此字符串大于字符串参数，则返回一个大于 0 的值。</li> \n </ul> \n</blockquote> \n<p>自定义比较器时，在返回时多添加了个负号，就将比较的结果以相反的形式返回，代码如下：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">class</span> MyComparator <span style=\"color: #0000ff;\">implements</span><span style=\"color: #000000;\"> Comparator{\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> compare(Object o1, Object o2) {\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> TODO Auto-generated method stub</span>\n        String param1 =<span style=\"color: #000000;\"> (String)o1;\n        String param2 </span>=<span style=\"color: #000000;\"> (String)o2;\n        </span><span style=\"color: #0000ff;\">return</span> -<span style=\"color: #000000;\">param1.compareTo(param2);\n    }   \n}</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>之后，通过MyComparator类初始化一个比较器实例，将其作为参数传进TreeMap的构造方法中：</p> \n<div class=\"cnblogs_code\"> \n <pre>MyComparator comparator = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> MyComparator();\n\nMap</span>&lt;String,String&gt; map = <span style=\"color: #0000ff;\">new</span> TreeMap&lt;String,String&gt;(comparator);</pre> \n</div> \n<p>&nbsp;</p> \n<p>这样，我们就可以使用自定义的比较器实现降序了</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> MapTest {\n\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> main(String[] args) {\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">初始化自定义比较器</span>\n        MyComparator comparator = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> MyComparator();\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">初始化一个map集合</span>\n        Map&lt;String,String&gt; map = <span style=\"color: #0000ff;\">new</span> TreeMap&lt;String,String&gt;<span style=\"color: #000000;\">(comparator);\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">存入数据</span>\n        map.put(\"a\", \"a\"<span style=\"color: #000000;\">);\n        map.put(</span>\"b\", \"b\"<span style=\"color: #000000;\">);\n        map.put(</span>\"f\", \"f\"<span style=\"color: #000000;\">);\n        map.put(</span>\"d\", \"d\"<span style=\"color: #000000;\">);\n        map.put(</span>\"c\", \"c\"<span style=\"color: #000000;\">);\n        map.put(</span>\"g\", \"g\"<span style=\"color: #000000;\">);\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">遍历输出</span>\n        Iterator iterator =<span style=\"color: #000000;\"> map.keySet().iterator();\n        </span><span style=\"color: #0000ff;\">while</span><span style=\"color: #000000;\">(iterator.hasNext()){\n            String key </span>=<span style=\"color: #000000;\"> (String)iterator.next();\n            System.out.println(map.get(key));\n        }\n    }\n\n    </span><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">class</span> MyComparator <span style=\"color: #0000ff;\">implements</span><span style=\"color: #000000;\"> Comparator{\n\n        @Override\n        </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> compare(Object o1, Object o2) {\n            </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> TODO Auto-generated method stub</span>\n            String param1 =<span style=\"color: #000000;\"> (String)o1;\n            String param2 </span>=<span style=\"color: #000000;\"> (String)o2;\n            </span><span style=\"color: #0000ff;\">return</span> -<span style=\"color: #000000;\">param1.compareTo(param2);\n        }\n\n    }\n\n}</span></pre> \n</div> \n<p>&nbsp;</p>', '问：如何决定使用 HashMap 还是 TreeMap？ \n介绍 \nTreeMap<K,V>的Key值是要求实现java.lang.Comparable，所以迭代的时候TreeMap默认是按照Key值升序排序的；TreeMap的实现是基于红黑树结构。适用于按自然顺序或自定义顺序遍历键（key）。 \nHashM', '2019-10-11 15:25:47', 7, 1, 'HashMap TreeMap', 'https://www.cnblogs.com/javazhiyin/p/11652526.html', 1, '2019-10-17 17:10:05');
INSERT INTO `t_blog` VALUES (245, '为什么我们需要知道“函数式编程”？', '<h1><span style=\"color: #3366ff;\">说在前面</span></h1> \n<p>注意，本文所讨论的函数式编程，并不等同于函数式编程“语言”，而是这么一个思想和概念，相信看到最后你或许能够明白这句话。</p> \n<p>&nbsp;</p> \n<h1><span style=\"color: #3366ff;\">问题</span></h1> \n<p>首先是关于计算机领域需要知道的一些事情，那就是硬件。</p> \n<p>由于硬件发展已经快要到达物理极限了，也就是说摩尔定律已经慢慢开始失效，由于我并不是硬件相关的专家，所以也无法确定这是不是真的，但我们假设这就是真的。</p> \n<p>摩尔定律失效过后会带来什么影响呢？那就是我们编写的程序再也无法像以前那样，只要等上18月还是多久（这个不是重点），就可以让我们的处理能力或是性能提升一倍。</p> \n<p>所以，当硬件的发展慢慢放缓，而我们业务规模增长超过单机极限后，唯一的办法就是将程序分布到不同的计算机上面运行，通过多个计算机来水平提升我们的处理能力。</p> \n<p>&nbsp;</p> \n<h1><span style=\"color: #3366ff;\">状态的一致性</span></h1> \n<p>当我们把程序放到多个计算机上运行，形成集群，其中多个节点如果同时访问、修改同一个状态，就会造成数据一致性问题，这也是分布式程序为什么这么难写的原因之一。</p> \n<p>同样的事情其实发生在我们在编写多线程应用程序的时候，当我们在使用命令式或者面向对象语言的时候，我们可以直接对状态进行修改，比如有一个变量，我们随时可以给他赋值。</p> \n<p>当然如果在任意时刻，只有一个线程能够访问和修改这个变量，这就没有问题。</p> \n<p>但是别忘了其他线程也能够访问这个变量，当多个线程同时读取、修改变量的时候，如果没有任何的保护措施（比如锁），那么就有可能会出现状态被错误的读取和计算，甚至是被覆盖。</p> \n<p>所以：</p> \n<ul> \n <li>多线程访问的是变量。</li> \n <li>分布式集群访问的是数据库或者缓存。</li> \n</ul> \n<p>有什么区别呢？除了存放的位置不一样，基本上遇到的问题是一样的，那就是必须要协调和控制好，并发所带来的状态一致性问题（<span style=\"color: #ff6600;\">无论是变量、还是数据库、缓存，我统称它们为状态</span>）。</p> \n<p>我们的程序拥有对状态的完全控制权，在任何时候任何地方都能够修改状态，可以想象，如果我们没有对状态进行有效的管理的话，就很容易造成混乱，维护性大大降低。</p> \n<p>其实就跟咱们一开始学编程的时候喜欢使用全局变量一样，但是现在的问题更棘手。</p> \n<p>如果说全局变量的影响是平面的，我们只需要线性的去梳理修改这些状态代码的先后顺序就能够解决BUG的话。</p> \n<p>那么加上并发竞争，这个影响就是3D的，排查BUG以及组织程序的复杂程度整整被提高了一个维度，因为空间与时间不再是一一对应的关系了。</p> \n<p>我之前写的好几篇文章，几乎都是跟分布式以及一致性相关的主题，现在本文又提到了这些问题，很多重复的内容我就不赘述了，有兴趣的可以翻翻我之前的文章。</p> \n<p>关于硬件，我留下一个问题给有兴趣的小伙伴，那就是为什么显卡的计算能力大大超过了CPU？</p> \n<p>&nbsp;</p> \n<h1><span style=\"color: #3366ff;\">函数式编程当中的纯函数</span></h1> \n<p>难道就没有一个行之有效的办法来解决这些令人棘手的问题吗？</p> \n<p>如果你经常阅读博客或者关注最新的技术文章和框架的话，你会发现，很多框架都开始慢慢支持以及完善从“同步”发展到“异步”的这个过程中了。</p> \n<h2><span style=\"color: #3ab882;\">什么是同步？</span></h2> \n<p>我们每天正在编写的代码是符合人脑思维顺序的，从上到下依次执行，比如x = 2，然后x = x * x，很容易就得出最后x == 4的结论。</p> \n<p>其中x就是一个变量，可能储存在CPU的寄存器当中，也可能储存在堆内存中，但这不是重点，它们都在同一个计算机上。</p> \n<p>同步就是依次执行，按照我们所编写代码的顺序逐步执行完所有的代码，我们利用分支判断以及循环语句来控制执行的线路，依赖的是之前被计算好的状态变量。</p> \n<h2><span style=\"color: #3ab882;\">什么是异步？</span></h2> \n<p>同步的缺陷很明显，由于是严格按照先后顺序执行代码的，这也是我们预期的方式。</p> \n<p>但是一旦涉及到IO操作，比如文件、网络，整个程序的运行就会被阻塞，因此多线程可以帮助我们，将阻塞的操作与当前的流程分离开来，等读取完后再去执行相关的操作。</p> \n<p>我们可以通过回调或者事件的方式来异步的进行处理，所谓异步，简单粗暴的理解就是我们调用了一个函数，他不会立马得到结果，而同步就可以得到结果，哪怕时间再长，我们也等（阻塞）。</p> \n<p>可以想象异步增加了代码的复杂程度，因为本来同步是直接返回结果的，异步就需要我们在另一个处理单元等待唤醒然后继续操作。</p> \n<p>另外，同步的代码只能在一个CPU当中执行，而多线程异步则可以利用计算机上面其他的CPU，使其并行执行提高效率。</p> \n<p>&nbsp;</p> \n<p>想象一下如果我们有一个函数，它不会修改任何状态，仅仅是对参数进行计算，然后返回计算结果，然后我们将这个函数分布到不同的计算机上去执行，是不是就能不受制于单台计算机天花板的影响了呢？</p> \n<p>由于这个函数不会修改任何状态，不会有任何的副作用，所以它可以在任何地方执行而不需要依赖其他的条件，这种函数被称之为纯函数。</p> \n<p>纯函数就像是一个可以被随时移动到不同地方去执行的单元。</p> \n<p>因此，纯函数就可以被当做一个异步等待唤醒的处理器，我们不知道它会在什么时候被执行，但我们可以放心，因为它不会导致副作用，也不需要依赖其他的前置条件。</p> \n<p>你或许注意到了本文所讲的内容其实就是Actor模型，没错，你可以认为每一个Actor就是一个个纯函数。</p> \n<p>但无论如何，你是自由的，你可以在actor执行单元里面做任何事情，但是请记住纯函数不得引发任何的外部状态修改，这是原则也是根本，因为我们不想要副作用。</p> \n<p>所以在纯函数式编程“语言”里面，根本就没有赋值操作，不过是描述对输入进行处理，然后返回结果而已，这能够让我们少犯一些错误。</p> \n<p>现在，处理器我们有了（纯函数），它可以被当做异步处理单元在任何计算机上面执行，那么状态呢？</p> \n<p>&nbsp;</p> \n<h1><span style=\"color: #3366ff;\">命令式vs声明式</span></h1> \n<p>注意我并不会介绍函数式编程的所有特性，有关这方面的资料我相信已经存在了。</p> \n<p>什么是命令式？什么又是声明式？</p> \n<p>举个例子，还记得你为什么用Spring吗？最基本的就是因为你需要依赖注入。</p> \n<p>我只需要声明一个Bean他需要依赖哪些类型的实例，Spring会为我们找到并且传入，这就是声明式，而如果你自己进行实例化操作，那么你需要去找到这些依赖，这就是命令式。</p> \n<blockquote> \n <p>Don’t call us, we’ll call you.</p> \n</blockquote> \n<p>&nbsp;</p> \n<p>由于纯函数不会修改状态，他只是简单的输入（参数）-&gt; 计算 -&gt; 输出（返回）IO单元，因此也就没有了赋值操作。</p> \n<p>如果说传统编程是对状态进行操作（修改），那么函数式编程语言就恰好相反，它不会修改状态，它只是描述计算的过程。</p> \n<p>因此，传统的编程对状态的修改是命令式的，函数式编程对状态的修改则是描述声明式的。</p> \n<p>如果无法理解这句话，想想Java8里面的Stream API以及Lambda表达式吧，分解过后的状态转换、过滤、收集以声明的方式进行调用，更加直观方便，而且可以并行执行而无需修改其余代码。</p> \n<p>实现函数式编程的具体语言、虚拟机执行环境以及框架，将会负责状态的维护，以及编排分布你的纯函数，在某一个地方某一个时间被激活执行。</p> \n<p>不要认为我所讲的只是函数式编程“语言”，实际上只要遵循相关的规则，使用框架也是一样的，重要的是这些规则概念背后所代表的意义。</p> \n<p>就像那句话怎么说来着？</p> \n<blockquote> \n <p>就算是使用C语言，我们也能够进行面向对象编程。但如果不懂面向对象，就算使用Java、C++，那也跟使用C语言没有区别。</p> \n <p>或许我们会使用这些高级语言的功能特性，但是却无法理解为什么需要这些特性，我们只是按照语言的规范来实现我们的需求。</p> \n <p>本末倒置的一个后果就是，我们依赖特定的编程语言而非依赖我们的思维以及经验。</p> \n</blockquote> \n<p>Erlang、Lisp、Scala、Akka、Vert.x、Reactor、RxJava等等等等，不管是语言、框架或者工具库，都能帮助我们减少进行异步编程所要的工作量，但你或许会问：这有什么用呢？为什么我们需要异步呢？</p> \n<p>答案就是，我们需要开发分布式应用程序，它们能够在不同的计算机上面运行，形成集群以提供大规模的并发应用服务，<span style=\"color: #ff6600;\">但同时，我们也需要完全利用好每一台计算机上的资源。</span></p> \n<p>因此，我们需要将资源的控制交给这些框架，交给它们背后所支撑的理论与实践，这样我们就能够站在巨人的肩膀上。</p> \n<p>&nbsp;</p> \n<h1><span style=\"color: #3366ff;\">但函数式编程不是银弹</span></h1> \n<p>因为跨网络的优化以及状态的管理，因此跟业务场景相关的偏好设定仍然无法被忽略。</p> \n<p>我们需要根据我们自己的情况来进行组织，只有这样才能最大化的避免由于当前计算机体系架构所固有的缺陷而引发的问题，以最小的代价换取利用资源。</p> \n<p>函数式编程能够让我们放弃一些权力，来换取规则下的和平，但它终究不过是一种工具，如果我们能够在适当的场景利用好这个工具，就能够使我们的工作更加有效。</p> \n<p>采用任何技术都无法脱离对原始业务的洞悉，只有这样，我们才能够构建出最佳匹配的应用程序服务。</p> \n<p>脱离应用场景的使用，不仅会使得后期维护成本上升，还会使得架构的演化遭遇巨大的挑战，除非你真的明白在做什么，否则我们可能永远也无法得到有效的改善。</p> \n<p>&nbsp;</p> \n<h1><span style=\"color: #3366ff;\">最后</span></h1> \n<p>如果我们遵循函数式编程的一些规范约束，就能够减少一些错误，因为正是由于这些规范约束的存在，才使得我们避免陷入泥潭而无法自拔。</p> \n<p>越来越多的框架都开始支持以及完善异步编程，就像Spring 5所推出的WebFlux，使用Reactor（<a href=\"https://projectreactor.io/\">https://projectreactor.io</a>）作为基础支撑，带来的就是全异步化的声明式编程范式。</p> \n<p>再例如Vert.X（<a href=\"https://vertx.io/\">https://vertx.io</a>）这个让人用的上瘾的强大工具，当你浏览了越来越多的新开源项目，或者是已经存在的开源项目开始慢慢过渡的转变趋势。</p> \n<p>你会发现，很多知识概念都是通用且可以互相转换的，异步、分布式、非阻塞、事件驱动、反应式等等…</p> \n<p>而这些就是面向未来的编程知识，无论使用何种语言、框架或者工具库。</p> \n<p>&nbsp;</p>', '说在前面 \n注意，本文所讨论的函数式编程，并不等同于函数式编程“语言”，而是这么一个思想和概念，相信看到最后你或许能够明白这句话。 \n  \n问题 \n首先是关于计算机领域需要知道的一些事情，那就是硬件。 \n由于硬件发展已经快要到达物理极限了，也就是说摩尔定律已经慢慢开始失效，由于我并不是硬件相关的专家，所以也无', '2019-10-11 15:25:47', 4, 1, '函数式', 'https://www.cnblogs.com/xingxueliao/p/11649873.html', 0, NULL);
INSERT INTO `t_blog` VALUES (246, 'robotframework框架 - seleniumLibrary 关键字解读-全攻略', '<p class=\"md-end-block md-p\"><span class=\"md-plain md-expand\">在robotframework当中，要实现web自动化，则需要使用SeleniumLibrary这个库。</span></p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">目前版本中，有180+关键字。随着版本的更新，关键字的个数和名字也会有所变动。</span></p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">在网上没有找到较为全面的关于这个库的关键字介绍，所以此篇文章作为一个汇总，列举常用的关键字。</span></p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h3 class=\"md-end-block md-heading\"><span class=\"md-plain\">1、SeleniumLibrary的安装：</span></h3> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">前提：已安装好python环境并配置好环境变量。然后在命令行当中，运行以下命令：</span></p> \n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span><span class=\"cm-variable\">pip <span class=\"cm-variable\">install <span class=\"cm-operator\">--<span class=\"cm-variable\">upgrade <span class=\"cm-variable\">robotframework<span class=\"cm-operator\">-<span class=\"cm-variable\">seleniumlibrary</span></span></span></span></span></span></span></span></pre> \n<p class=\"md-end-block md-p\"><img src=\"http://localhost:9090/blogImages/2019/10/11/d6065cb3-33f4-497f-b85b-7b5ec2383498.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h3 class=\"md-end-block md-heading\"><span class=\"md-plain\">2、SeleniumLibrary结构、和Selenium的关系 </span></h3> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">SeleniumLibrary是一个python第三方库(存放在python安装目录下的Lib/site-packages/SeleniumLibrary)。它的结构如下，其中keywords目录下存放的是关键字。</span></p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">在源码中，是分门别类的来存放关键字。包括alert弹框、表格/select/iframe等元素操作、等待、窗口等。</span></p> \n<p class=\"md-end-block md-p\"><img src=\"http://localhost:9090/blogImages/2019/10/11/c6ea1d32-45fa-4686-b825-cd82c62e774e.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">SeleniumLibrary的源代码中，很多地方都直接使用了selenium的API来封装网页的操作，可以说是在selenium之上，封装了更多的元素操作关键字，提供给robot框架的使用者。毕竟有现成的“轮子”，就没有必要再重新造了。</span></p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">比如上图中elment.py当中的鼠标操作。在selenium当中，ActionChains类是用来专门实现鼠标操作的。</span></p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">以元素双击操作为例，如果使用python+selenium库来实现双击操作，需要以下代码：</span></p> \n<p class=\"md-end-block md-p\"><img src=\"http://localhost:9090/blogImages/2019/10/11/f51ab2c3-14b3-45c4-b125-34f32b8997ae.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">在SeleniumLibrary当中，关键字<span><strong><span class=\"md-html-inline\">double click element</span></strong><span class=\"md-plain\"> 就将元素和鼠标双击操作封装在一起。只要传入元素定位即可(如下图所示)。</span></span></span></p> \n<p class=\"md-end-block md-p\"><img src=\"http://localhost:9090/blogImages/2019/10/11/d7ab0b19-69f2-4fba-a2c4-4c696c7dc6bb.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h3 class=\"md-end-block md-heading\"><span class=\"md-plain\">3、SeleniumLibrary关键字分类解读</span></h3> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h4 class=\"md-end-block md-heading\"><span class=\"md-plain\">1) 引入SeleniunLibrary库时，初始化参数</span></h4> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">SeleniumLibrary在robotframework当中，引入时会将SeleniumLibrary这个类初始化。</span></p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">初始化的参数是对所有关键字生效的。</span></p> \n<p class=\"md-end-block md-p\"><img src=\"http://localhost:9090/blogImages/2019/10/11/d19e4769-b90a-43ec-9a87-e4f48c272b08.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p class=\"md-end-block md-p\"><span><strong>Timeout：</strong><span class=\"md-plain\">等待超时时间。关键字当中有timeout参数的，都使用此处的默认值，5秒。</span></span></p> \n<p class=\"md-end-block md-p\"><span><strong>Implicit wait:</strong><span class=\"md-plain\"> 隐性等待时长。0.0表示没有隐性等待。</span></span></p> \n<p class=\"md-end-block md-p\"><span><strong>run on failure:</strong><span class=\"md-plain\"> 关键字运行失败时的动作。Capture Page Screenshot是截取页面图片的关键字。表示运行失败时，自动截取当前网页图片， 即失败时自动截图功能。</span></span></p> \n<p class=\"md-end-block md-p\"><span><strong>Screenshot root directory:</strong><span class=\"md-plain\"> 截取的网页图片存放路径 。None表示不指定路径 ，默认与输出文件同目录。</span></span></p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">我们在robot当中引入SeleniumLibrary时，可以修改默认参数值。比如修改默认timeout为15s</span></p> \n<p class=\"md-end-block md-p\"><img src=\"http://localhost:9090/blogImages/2019/10/11/f5e3c235-ae90-4af1-bb1d-0f2be0dab41c.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h4 class=\"md-end-block md-heading\"><span class=\"md-plain\">2）元素定位语法：</span></h4> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">在web自动化当中，有8大定位方式。无论用什么样的语言/框架，定位方式都是通用的。</span></p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">在robot框架当中，定位语法有以下2种表达方式：</span></p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">1) 定位策略:定位表达式(比如 id:kw)</span></p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">2) 定位策略=定位表达式(比如 id=kw)</span></p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">在robot当中，除了8大定位方式以外，还额外扩展了几种，整体的定位方式如下(摘抄自官方文档)：</span></p> \n<table class=\"md-table\"> \n <thead> \n  <tr class=\"md-end-block\">\n   <th><span class=\"td-span\"><span class=\"md-plain\">定位策略</span></span></th>\n   <th><span class=\"td-span\"><span class=\"md-plain\">匹配方式</span></span></th>\n   <th><span class=\"td-span\"><span class=\"md-plain\">定位示例</span></span></th>\n  </tr> \n </thead> \n <tbody> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">id</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">元素的id属性</span></span></td> \n   <td><span class=\"td-span\"><span><code>id:example</code></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">name</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">元素的name属性</span></span></td> \n   <td><span class=\"td-span\"><span><code>name:example</code></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">identifier</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">元素的id或者name属性</span></span></td> \n   <td><span class=\"td-span\"><span><code>identifier:example</code></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">class</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">元素的class属性</span></span></td> \n   <td><span class=\"td-span\"><span><code>class:example</code></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">tag</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">元素的标签名称</span></span></td> \n   <td><span class=\"td-span\"><span><code>tag:div</code></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">xpath</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">xpath定位表达式</span></span></td> \n   <td><span class=\"td-span\"><span><code>xpath://div[@id=\"example\"]</code></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">css</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">css selector定位表达式</span></span></td> \n   <td><span class=\"td-span\"><span><code>css:div#example</code></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">dom</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">DOM表达式</span></span></td> \n   <td><span class=\"td-span\"><span><code>dom:document.images[5]</code></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">link</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">精确匹配链接元素的文本内容</span></span></td> \n   <td><span class=\"td-span\"><span><code>link:The example</code></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">partial link</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">部分匹配链接元素的文本内容</span></span></td> \n   <td><span class=\"td-span\"><span><code>partial link:he ex</code></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">jquery</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">jQuery表达式</span></span></td> \n   <td><span class=\"td-span\"><span><code>jquery:div.example</code></span></span></td> \n  </tr> \n </tbody> \n</table> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">示例：</span></p> \n<table class=\"md-table\"> \n <thead> \n  <tr class=\"md-end-block\">\n   <th><span class=\"td-span\"><span class=\"md-link\"><a href=\"https://robotframework.org/SeleniumLibrary/SeleniumLibrary.html#Click%20Element\"><span class=\"md-plain\">Click Element</span></a></span></span></th>\n   <th><span class=\"td-span\"><span class=\"md-plain\">id:foo</span></span></th>\n   <th><span class=\"td-span\"><span class=\"md-block-like\"><span class=\"md-blockmeta\"># <span class=\"md-header-span\"><span class=\"md-plain\">点击id为foo的元素。</span></span></span></span></span></th>\n  </tr> \n </thead> \n <tbody> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\" md-link\"><a href=\"https://robotframework.org/SeleniumLibrary/SeleniumLibrary.html#Click%20Element\"><span class=\"md-plain\">Click Element</span></a></span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">css:div#foo h1</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-block-like\"><span class=\"md-blockmeta\"># <span class=\"md-header-span\"><span class=\"md-plain\">点击 id为foo的div元素后代当中的h1元素</span></span></span></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\" md-link\"><a href=\"https://robotframework.org/SeleniumLibrary/SeleniumLibrary.html#Click%20Element\"><span class=\"md-plain\">Click Element</span></a></span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">xpath=//div[@id=\"foo\"]//h1</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-block-like\"><span class=\"md-blockmeta\"># <span class=\"md-header-span\"><span class=\"md-plain\">同上一个。</span></span></span></span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-link\"><a href=\"https://robotframework.org/SeleniumLibrary/SeleniumLibrary.html#Click%20Element\"><span class=\"md-plain\">Click Element</span></a></span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">//*[contains(text(), \"example\")]</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-block-like\"><span class=\"md-blockmeta\"># <span class=\"md-header-span\"><span class=\"md-plain\">点击 文本内容包含example的元素</span></span></span></span></span></td> \n  </tr> \n </tbody> \n</table> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">注意：xpath定位表达式可省略前缀：xpath。</span></p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h4 class=\"md-end-block md-heading\"><span class=\"md-plain\">3）浏览器和窗口操作关键字</span></h4> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<table class=\"md-table\"> \n <thead> \n  <tr class=\"md-end-block\">\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字名称</span></span></th>\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字说明</span></span></th>\n  </tr> \n </thead> \n <tbody> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">open browser</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">打开浏览器并访问系统地址。url:网站地址,browser:浏览器类型。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">close browser</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">关闭浏览器。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">maximize browser window</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">当前窗口最大化。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get window size</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取当前窗口的大小</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">set window size</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">设置窗口大小。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get window handles</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取浏览器中，所有窗口的句柄。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">switch window</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">切换窗口。可根据窗口的句柄、标题、名称等切换。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get window names</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取浏览器，所有窗口的名称。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get window titles</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取所有窗口的标题。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get locations</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取所有窗口的url。</span></span></td> \n  </tr> \n </tbody> \n</table> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h4 class=\"md-end-block md-heading\"><span class=\"md-plain\">4）元素通用操作关键字(包含鼠标/键盘操作)：</span></h4> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<table class=\"md-table\"> \n <thead> \n  <tr class=\"md-end-block\">\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字名称</span></span></th>\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字说明</span></span></th>\n  </tr> \n </thead> \n <tbody> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">click ement</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">点击元素。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">input text</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">在元素中输入文本值。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get element attribute</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取元素的某一个属性值。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get element size</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取元素的大小。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get value</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取元素的value属性值。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get text</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取元素的文本内容</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">clear element text</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">清除元素的文本值。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get webelement</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取一个元素对象。WebElment对象。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get webelements</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取匹配的所有元素对象。WebElment对象。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">set focus to element</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">元素获取焦点。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">double click element</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">双击元素</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">scroll element into view</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">滚动元素到可见区域</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">drag and drop</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">将一个元素拖拽到另一个元素区域中。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">mouse over</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">鼠标悬浮在元素上</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">press keys</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">键盘按键操作。</span></span></td> \n  </tr> \n </tbody> \n</table> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h4 class=\"md-end-block md-heading\"><span class=\"md-plain\">5）select/frame/alert/表格等操作关键字：</span></h4> \n<table class=\"md-table\"> \n <thead> \n  <tr class=\"md-end-block\">\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字名称</span></span></th>\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字说明</span></span></th>\n  </tr> \n </thead> \n <tbody> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get list items</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">select/option元素中，获取所有的options选项。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">select from list by index</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">select/option元素中，根据下标来选择option选项</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">select from list by value</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">select/option元素中，根据value属性来选择option选项</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">select from list by label</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">select/option元素中，根据文本内容来选择option选项</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">select frame</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">切换到指定的iframe当中。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">unselect frame</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">退出iframe，切换到默认的html页面中。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">handle alert</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">关闭alert弹出框。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">input text into alert</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">输入文本到alert弹框中，并关闭alert弹出框。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">choose file</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">在上传文件的输入框中(input元素的type为file)输入文本地址。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">get table cell</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">获取表格的单元格值。行号和列号起始值为1.包含表头和表尾所对应的行。</span></span></td> \n  </tr> \n </tbody> \n</table> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h4 class=\"md-end-block md-heading\"><span class=\"md-plain\">6）元素等待关键字</span></h4> \n<h4 class=\"md-end-block md-heading\"><span class=\"md-plain\"> (关键字中包含wait的, timeout参数默认为seleniumlibrary初始化值，默认为5秒)：</span></h4> \n<table class=\"md-table\"> \n <thead> \n  <tr class=\"md-end-block\">\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字名称</span></span></th>\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字说明</span></span></th>\n  </tr> \n </thead> \n <tbody> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">wait for condition</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">等待条件成立：条件为js表达式，表达式的结果要为布尔值。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">wait until element is visible</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">等待指定的元素可见</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">wait until element is not visible</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">等待指定的元素不可见</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">wait until element is enabled</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">等待指定的元素可用</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">wait until element contains</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">等待指定的元素 包含 指定的文本内容</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">wait until element does not contain</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">等待指定的元素 不包含 指定的文本内容</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">wait until page contains element</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">等待页面 包含指定的元素</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">wait until page contains element</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">等待页面 不包含指定的元素</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">wait until page contains</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">等待页面 包含指定的文本内容</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">wait until page does not contain</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">等待页面 不包含指定的文本内容</span></span></td> \n  </tr> \n </tbody> \n</table> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h4 class=\"md-end-block md-heading\"><span class=\"md-plain\">7）断言关键字(关键字中包含should的均是)：</span></h4> \n<table class=\"md-table\"> \n <thead> \n  <tr class=\"md-end-block\">\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字名称</span></span></th>\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字说明</span></span></th>\n  </tr> \n </thead> \n <tbody> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">page should contain element</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">页面应当 包含指定的元素</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">page should not contain element</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">页面应当 不包含指定的元素</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">locator should match x times</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">元素定位表达式应该匹配 指定 次数</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">element should be visible</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">指定的元素 应当可见</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">element should not be visible</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">指定的元素 应当不可见</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">element should be enabled</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">指定的元素 应当可用</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">element should be disabled</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">指定的元素 应当不可用</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">element text should be</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">指定元素的文本内容 应当是 指定内容</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">element text should not be</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">指定元素的文本内容 应当不是 指定内容</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">element should be focused</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">指定的元素 应当为焦点状态</span></span></td> \n  </tr> \n </tbody> \n</table> \n<p class=\"md-end-block md-p\"><span class=\"md-plain\">还有很多其它断言的关键字，不一一列举。</span></p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h4 class=\"md-end-block md-heading\"><span class=\"md-plain\">8）截屏类关键字：</span></h4> \n<table class=\"md-table\"> \n <thead> \n  <tr class=\"md-end-block\">\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字名称</span></span></th>\n   <th><span class=\"td-span\"><span class=\"md-plain\">关键字说明</span></span></th>\n  </tr> \n </thead> \n <tbody> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">capture page screenshot</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">截取当前页面图片。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">capture element screenshot</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">截取指定元素的图片。</span></span></td> \n  </tr> \n  <tr class=\"md-end-block\"> \n   <td><span class=\"td-span\"><span class=\"md-plain\">set screenshot directory</span></span></td> \n   <td><span class=\"td-span\"><span class=\"md-plain\">设置截图存储目录。</span></span></td> \n  </tr> \n </tbody> \n</table> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<p class=\"md-end-block md-p\">&nbsp;</p> \n<h3 class=\"md-end-block md-heading md-focus\"><span class=\"md-plain md-expand\">4、robot - web自动化使用示例</span></h3> \n<p class=\"md-end-block md-p\"><img src=\"http://localhost:9090/blogImages/2019/10/11/1654ced6-6933-4f86-8793-3c243443ea8c.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p><span class=\"md-image md-img-loaded\" data-src=\"/Users/liyuan/Library/Application%20Support/typora-user-images/image-20190925164945539.png\">&nbsp;</span></p>', '在robotframework当中，要实现web自动化，则需要使用SeleniumLibrary这个库。 \n目前版本中，有180+关键字。随着版本的更新，关键字的个数和名字也会有所变动。 \n在网上没有找到较为全面的关于这个库的关键字介绍，所以此篇文章作为一个汇总，列举常用的关键字。 \n  \n1、Seleniu', '2019-10-11 15:25:57', 4, 3, '', 'https://www.cnblogs.com/Simple-Small/p/11586012.html', 0, NULL);
INSERT INTO `t_blog` VALUES (247, 'python语言程序设计基础（嵩天）第二章课后习题', '<p><strong><span style=\"font-size: 18pt;\">p56:</span></strong></p> \n<p><span style=\"font-size: 18px;\"><strong>*2.1</strong></span></p> \n<p><strong>实例1的修改。改造实例代</strong>码1.1，采用e<strong>val（input（&lt;提示内容&gt;））替换现有输入部分，并使输出的温度值为整数。<br></strong></p> \n<p><strong>源代码：</strong></p> \n<p><strong>　　</strong>TempStr=input(\"请输入符号：\")<br>　　x=eval(input(\"请输入温度值：\"))<br>　　if TempStr in [\'F\',\'f\']:<br>&nbsp;&nbsp; &nbsp;　　C=(x-32)/1.8<br>&nbsp;&nbsp; &nbsp;　　print(\"转换后的温度是{:.2f}C\".format(C))<br>　　elif TempStr in [\'C\',\'c\']:<br>&nbsp;&nbsp; &nbsp;　　F=1.8*x+32<br>&nbsp;&nbsp; &nbsp;　　print(\"转换后的温度是{:.2f}F\".format(F))<br>　　else:<br>&nbsp;&nbsp; &nbsp;　　print(\"输入格式错误！\")</p> \n<p><strong>&nbsp;运行结果：</strong></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/73957802-3589-489c-9f27-a67f9f9301de.png\" alt=\"\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/8a49c130-57bc-4de6-a8d7-6c52cd3bd1ea.png\" alt=\"\"></p> \n<p><strong><br><span style=\"font-size: 18px;\"><strong>*2.2</strong></span>汇率兑换程序。按照温度转换程序的设计思路，按照1美元=6人民币汇率编写一个美元和人民币的双向兑换程序</strong></p> \n<p><strong>源代码：</strong></p> \n<p>　　TempStr=input(\"请输入币种符号(y(yuan)/d(dollar))：\")<br>　　x=eval(input(\"请输入面额值：\"))<br>　　if TempStr in [\'Y\',\'y\']:<br>&nbsp;&nbsp; 　　&nbsp;C=x/6<br>&nbsp;&nbsp; &nbsp;　　print(\"转换后是{:.2f}美元\".format(C))<br>　　elif TempStr in [\'D\',\'d\']:<br>&nbsp;&nbsp; &nbsp;　　F=x*6<br>&nbsp;&nbsp; &nbsp;　　print(\"转换后是{:.2f}人民币\".format(F))<br>　　else:<br>&nbsp;&nbsp; &nbsp;　　print(\"输入格式错误！\")</p> \n<p>&nbsp;</p> \n<p><strong>运行结果：</strong></p> \n<p><strong><img src=\"http://localhost:9090/blogImages/2019/10/11/39f68814-82ab-4105-8d30-e95b3aa4c2a0.png\" alt=\"\"></strong></p> \n<p><strong><img src=\"http://localhost:9090/blogImages/2019/10/11/7a5d25e0-5af2-4b42-98fa-33ceee8a59fe.png\" alt=\"\"></strong></p> \n<p>&nbsp;</p>', 'p56: \n*2.1 \n实例1的修改。改造实例代码1.1，采用eval（input（<提示内容>））替换现有输入部分，并使输出的温度值为整数。 \n源代码： \n　　TempStr=input(\"请输入符号：\")　　x=eval(input(\"请输入温度值：\"))　　if TempStr in [\'F\',\'f\']', '2019-10-11 15:26:01', 7, 4, 'python 设计基础', 'https://www.cnblogs.com/wswyy/p/11654515.html', 1, '2019-10-17 17:09:53');
INSERT INTO `t_blog` VALUES (249, '【Java基础】让编码问题不再困惑你', '<div class=\"toc\"> \n <p class=\"toc-title\">目录</p> \n <div class=\"toc-list\"> \n  <ul> \n   <li><a href=\"#ascii编码\">1. ASCII编码</a></li> \n   <li><a href=\"#unicode编码\">2. Unicode编码</a></li> \n   <li><a href=\"#utf-8编码\">3. UTF-8编码</a></li> \n   <li><a href=\"#utf8utf16和utf32之间的区别\">4. UTF8、UTF16和UTF32之间的区别</a></li> \n   <li><a href=\"#gbkgb2312和gb18030之间的区别\">5. GBK、GB2312和GB18030之间的区别</a></li> \n   <li><a href=\"#java中的编码问题\">6. Java中的编码问题</a></li> \n   <li><a href=\"#乱码问题分析\">8. 乱码问题分析</a></li> \n   <li><a href=\"#参考\">9. 参考</a></li> \n  </ul> \n </div> \n</div> \n<hr> \n<blockquote> \n <p>如果你是一个生活在2003年的程序员，却不了解字符、字符集、编码和Unicode这些基础知识。那你可要小心了，要是被我抓到你，我会让你在潜水艇里剥六个月洋葱来惩罚你。 --来源网络</p> \n</blockquote> \n<hr> \n<h3 id=\"ascii编码\">1. ASCII编码</h3> \n<p>上个世纪60年代，美国制定了一套字符编码，对英语字符与二进制位之间的关系，做了统一规定。这被称为ASCII码，一直沿用至今。ASCII码一共规定了128个字符的编码，比如空格\"SPACE\"是32（二进制00100000），大写的字母A是65（二进制01000001）。这128个符号（包括32个不能打印出来的控制符号），只占用了一个字节的后面7位，最前面的1位统一规定为0。0~31 是控制字符如换行回车删除等，32~126 是打印字符，可以通过键盘输入并且能够显示出来。</p> \n<p>英语用128个符号编码就够了，但是用来表示其他语言，128个符号是不够的。比如，在法语中，字母上方有注音符号，它就无法用ASCII码表示。于是，一些欧洲国家就决定，利用字节中闲置的最高位编入新的符号。比如，法语中的é的编码为130（二进制10000010）。这样一来，这些欧洲国家使用的编码体系，可以表示最多256个符号。</p> \n<p>但是，这里又出现了新的问题。不同的国家有不同的字母，因此，哪怕它们都使用256个符号的编码方式，代表的字母却不一样。比如，130在法语编码中代表了é，在希伯来语编码中却代表了字母Gimel (ג)，在俄语编码中又会代表另一个符号。但是不管怎样，所有这些编码方式中，0—127表示的符号是一样的，不一样的只是128—255的这一段。</p> \n<p>至于亚洲国家的文字，使用的符号就更多了，汉字就多达10万左右。一个字节只能表示256种符号，肯定是不够的，就必须使用多个字节表达一个符号。比如，简体中文常见的编码方式是GB2312，使用两个字节表示一个汉字，所以理论上最多可以表示65536个符号。</p> \n<h3 id=\"unicode编码\">2. Unicode编码</h3> \n<p>可以想象，如果有一种编码，将世界上所有的符号都纳入其中。每一个符号都给予一个独一无二的编码，那么就不会出现上面的问题。Unicode编码就是这样一种编码。</p> \n<p>Unicode是一个很大的字符集合，现在的规模可以容纳100多万个符号。每个符号的编码都不一样，比如，U+0639表示阿拉伯字母Ain，U+0041表示英语的大写字母A，U+4E25表示汉字“严”。</p> \n<p><strong>需要注意的是，Unicode只是一个符号集，它只规定了符号的二进制代码，却没有规定这个二进制代码应该如何存储</strong>。这就造成了两个问题：</p> \n<ul> \n <li>第一个问题是，如何才能区别unicode和ascii？计算机怎么知道三个字节表示一个符号，而不是分别表示三个符号呢？</li> \n <li>第二个问题是，我们已经知道，英文字母只用一个字节表示就够了，如果unicode统一规定，每个符号用三个或四个字节表示，那么每个英文字母前都必然有二到三个字节是0，这对于存储来说是极大的浪费，文本文件的大小会因此大出二三倍，这是无法接受的。</li> \n</ul> \n<p>记住，Unicode只是一个用来映射字符和数字的标准。它对支持字符的数量没有限制，也不要求字符必须占两个、三个或者其它任意数量的字节。Unicode字符是怎样被编码成内存中的字节这是另外的话题，它是被UTF(Unicode Transformation Formats)定义的。</p> \n<h3 id=\"utf-8编码\">3. UTF-8编码</h3> \n<p>互联网的普及，强烈要求出现一种统一的编码方式。UTF-8就是在互联网上使用最广的一种unicode的实现方式。其他实现方式还包括UTF-16和UTF-32，不过在互联网上基本不用。重复一遍，这里的关系是，UTF-8是Unicode的实现方式之一。</p> \n<p>UTF-8（8-bit Unicode Transformation Format）是一种针对Unicode的可变长度字符编码，又称万国码。由Ken Thompson于1992年创建。现在已经标准化为RFC 3629。UTF-8用1到4个字节编码Unicode字符。用在网页上可以统一页面显示中文简体繁体及其它语言（如英文，日文，韩文）。</p> \n<p><strong>UTF-8最大的一个特点，就是它是一种变长的编码方式。它可以使用1~4个字节表示一个符号，根据不同的符号而变化字节长度（UTF-8编码可以容纳2^21个字符，总共200多万个字符）。</strong></p> \n<p>UTF-8的编码规则很简单，只有二条：</p> \n<ol> \n <li><p>对于单字节的符号，字节的第一位设为0，后面7位为这个符号的unicode码。因此对于英语字母，UTF-8编码和ASCII码是相同的。</p></li> \n <li><p>对于n字节的符号（n&gt;1），第一个字节的前n位都设为1，第n+1位设为0，后面字节的前两位一律设为10。剩下的没有提及的二进制位，全部为这个符号的unicode码。</p></li> \n</ol> \n<p>下表总结了编码规则，字母x表示可用编码的位。</p> \n<blockquote> \n <p>Unicode符号范围 | UTF-8编码方式<br> UTF字节数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (十六进制) | （二进制）<br> --------------------+---------------------------------------------一个字节 0000 0000-0000 007F | 0xxxxxxx<br> 两个字节 0000 0080-0000 07FF | 110xxxxx 10xxxxxx<br> 三个字节 0000 0800-0000 FFFF | 1110xxxx 10xxxxxx 10xxxxxx<br> 四个字节 0001 0000-0010 FFFF | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</p> \n</blockquote> \n<p>下面， 还是以汉字“严”为例，演示如何实现UTF-8编码。</p> \n<p>已知“严”的unicode是4E25（100111000100101），根据上表，可以发现4E25处在第三行的范围内（0000 0800-0000 FFFF），因此“严”的UTF-8编码需要三个字节，即格式是“1110xxxx 10xxxxxx 10xxxxxx”。然后，从“严”的最后一个二进制位开始，依次从后向前填入格式中的x，多出的位补0。这样就得到了，“严”的UTF-8编码是“11100100 10111000 10100101”，转换成十六进制就是E4B8A5。</p> \n<h3 id=\"utf8utf16和utf32之间的区别\">4. UTF8、UTF16和UTF32之间的区别</h3> \n<p>首先我们要确定一个概念就是Unicode是一个字符集，这个字符集世界上所有的字符定义了一个唯一编码。其仅仅规定了每个符号的二进制代码，没有制定细化的存储规则。UTF-8、UTF-16、UTF-32才是Unicode的存储格式定义。（拿一个通信中的列子做个对比，一个信号（类比成Unicode编码指），通过不同的编码方式，会被编码成不同的高低信号）</p> \n<h4 id=\"ucs-2和ucs-4\">4.1 UCS-2和UCS-4</h4> \n<p>Unicode是为整合全世界的所有语言文字而诞生的。任何文字在Unicode中都对应一个值，&nbsp;这个值称为代码点（code point）。代码点的值通常写成 U+ABCD 的格式。而文字和代码点之间的对应关系就是UCS-2（Universal Character Set coded in 2 octets）。顾名思义，UCS-2是用两个字节来表示代码点，其取值范围为 U+0000～U+FFFF。</p> \n<p>为了能表示更多的文字，人们又提出了UCS-4，即用四个字节表示代码点。它的范围为 U+00000000～U+7FFFFFFF，其中 U+00000000～U+0000FFFF和UCS-2是一样的。</p> \n<p>要注意，UCS-2和UCS-4只规定了代码点和文字之间的对应关系，并没有规定代码点在计算机中如何存储。规定存储方式的称为UTF（Unicode Transformation Format），其中应用较多的就是UTF-16和UTF-8了。</p> \n<h4 id=\"utf-16\">4.2 UTF-16</h4> \n<p>UTF-16由RFC2781规定，它使用两个字节来表示一个代码点。不难猜到，UTF-16是完全对应于UCS-2的，即把UCS-2规定的代码点通过Big Endian或Little Endian方式直接保存下来。UTF-16包括三种：UTF-16，UTF-16BE（Big Endian），UTF-16LE（Little Endian）。UTF-16BE和UTF-16LE不难理解，而UTF-16就需要通过在文件开头以名为BOM（Byte Order Mark）的字符来表明文件是Big Endian还是Little Endian。BOM为U+FEFF这个字符。其实BOM是个小聪明的想法。由于UCS-2没有定义U+FEFF，因此只要出现 FF FE 或者 FE FF 这样的字节序列，就可以认为它是U+FEFF，并且可以判断出是Big Endian还是Little Endian。</p> \n<blockquote> \n <p>BOM（Byte Order Mark）用来放在文档的开头告诉阅读器该文档的字节序。UTF-8不需要BOM来表明字节顺序，但可以用BOM来表明编码方式。字符\"ZERO WIDTH NO-BREAK SPACE\"的UTF-8编码是EF BB BF。所以如果接收者收到以EF BB BF开头的字节流，就知道这是UTF-8编码了。UTF-16才需要加bom。因为它是按unicode顺序编码，在BMP范围内是二字节，需要识别是大或小字节序。<br> &nbsp;</p> \n</blockquote> \n<blockquote> \n <p><strong>低字节序(Little Endian)和高字节序(Big Endian)</strong><br> 低字节序和高字节序只是一个关于在内存中存储和读取一段字节（被称作words）的约定。这意味着当你让计算机用UTF-16把字母A（占两个字节）存在内存中时，使用哪种字节序方案决定了你把第一个字节放在第二个字节的前面还是后面。这么说有点不太容易懂，让我们来看一个例子：当你使用UTF-16存下某段内容时，在不同的系统中它的后半部分可能是这样的：<br> 00 68&nbsp;00 65&nbsp;00 6C&nbsp;00 6C&nbsp;00 6F（高字节序，高位字节被存在前面）<br> 68 00&nbsp;65 00&nbsp;6C 00&nbsp;6C 00&nbsp;6F 00（低字节序，低位字节被存在前面）</p> \n <p>字节序方案只是一个微处理器架构设计者的偏好问题，例如，Intel使用低字节序，Motorola使用高字节序。</p> \n</blockquote> \n<p>举个例子。“ABC”这三个字符用各种方式编码后的结果如下：</p> \n<table> \n <thead> \n  <tr class=\"header\"> \n   <th>编码类型</th> \n   <th>码值</th> \n  </tr> \n </thead> \n <tbody> \n  <tr class=\"odd\"> \n   <td>UTF-16BE</td> \n   <td>00 41 00 42 00 43</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>UTF-16LE</td> \n   <td>41 00 42 00 43 00</td> \n  </tr> \n  <tr class=\"odd\"> \n   <td>UTF-16(Big Endian)</td> \n   <td>FE FF 00 41 00 42 00 43</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>UTF-16(Little Endian)</td> \n   <td>FF FE 41 00 42 00 43 00</td> \n  </tr> \n  <tr class=\"odd\"> \n   <td>UTF-16(不带BOM)</td> \n   <td>00 41 00 42 00 43</td> \n  </tr> \n </tbody> \n</table> \n<h4 id=\"utf-32\">4.3 UTF-32</h4> \n<p>UTF-32用四个字节表示代码点，这样就可以完全表示UCS-4的所有代码点，而无需像UTF-16那样使用复杂的算法。&nbsp;与UTF-16类似，UTF-32也包括UTF-32、UTF-32BE、UTF-32LE三种编码，UTF-32也同样需要BOM字符。</p> \n<h4 id=\"文本编辑器怎么知道文本的编码\">4.4 文本编辑器怎么知道文本的编码</h4> \n<p>当一个软件打开一个文本时，它要做的第一件事是决定这个文本究竟是使用哪种字符集的哪种编码保存的。软件一般采用三种方式来决定文本的字符集和编码： &nbsp; &nbsp;&nbsp;</p> \n<ol> \n <li><p>检测文件头标识（BOM）</p> <p>EF &nbsp; BB &nbsp; BF &nbsp; UTF-8 &nbsp; &nbsp;&nbsp;&nbsp;<br> FE &nbsp; FF &nbsp; UTF-16/UCS-2, &nbsp; big &nbsp; endian &nbsp; &nbsp;&nbsp;&nbsp;<br> FF &nbsp; FE &nbsp; UTF-16/UCS-2, &nbsp; little &nbsp; endian &nbsp; &nbsp;&nbsp;&nbsp;<br> FF &nbsp; FE &nbsp; 00 &nbsp; 00 &nbsp; UTF-32/UCS-4, &nbsp; little &nbsp; endian. &nbsp; &nbsp;&nbsp;&nbsp;<br> 00 &nbsp; 00 &nbsp; FE &nbsp; FF &nbsp; UTF-32/UCS-4, &nbsp; big-endian.</p></li> \n <li><p>软件自己根据编码规则猜测当前文件的编码</p></li> \n <li><p>提示用户自己输入当前文件的编码</p></li> \n</ol> \n<h3 id=\"gbkgb2312和gb18030之间的区别\">5. GBK、GB2312和GB18030之间的区别</h3> \n<p>GB2312是对ASCll码的扩展，占用两个字节。一个小于127的字符的意义与原来相同，但两个大于127的字符连在一起时，就表示一个汉字，前面的一个字节（他称之为高字节）从0xA1用到0xF7，后面一个字节（低字节）从0xA1到0xFE，这样我们就可以组合出大约7000多个简体汉字了。在这些编码里，我们还把数学符号、罗马希腊的字母、日文的假名们都编进去了，连在 ASCII 里本来就有的数字、标点、字母都统统重新编了两个字节长的编码，这就是常说的\"全角\"字符，而原来在127号以下的那些就叫\"半角\"字符了。</p> \n<p>GB2312能表示的字符还是不够用，于是GBK出现了。GBK是对GB1212的扩展，也是占用2个字节，GBK不再要求低字节一定是127号之后的内码，只要第一个字节是大于127就固定表示这是一个汉字的开始，不管后面跟的是不是扩展字符集里的内容。结果扩展之后的编码方案被称为 GBK 标准，GBK 包括了 GB2312 的所有内容，同时又增加了近20000个新的汉字（包括繁体字）和符号。</p> \n<p>GB18030采用变长编码，可以是1个字节、2个字节和4个字节。是对GB2312和GBK的扩展，完全兼容两者。</p> \n<p>经过上面介绍，我们可以看出Unicode是一个世界标准，针对世界上所有语言符号制定编码表，而GBK、GB2312等则主要是针对中国的字符进行编码。</p> \n<h3 id=\"java中的编码问题\">6. Java中的编码问题</h3> \n<p>我们知道涉及到编码的地方一般都在字符到字节或者字节到字符的转换上，而需要这种转换的场景主要是在 I/O 的时候，这个 I/O 包括磁盘 I/O&nbsp;和网络 I/O。而大部分 I/O 引起的乱码都是网络 I/O。</p> \n<p><strong>用户从浏览器端发起一个 HTTP 请求，需要存在编码的地方是 URL、Cookie、Parameter。服务器端接受到 HTTP 请求后要解析 HTTP 协议，其中 URI、Cookie 和 POST 表单参数需要解码，服务器端可能还需要读取数据库中的数据，本地或网络中其它地方的文本文件，这些数据都可能存在编码问题，当 Servlet 处理完所有请求的数据后，需要将这些数据再编码通过 Socket 发送到用户请求的浏览器里，再经过浏览器解码成为文本</strong>。这些过程如下图所示：</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/adfa702c-5f30-455e-9475-5f9466c4702c.png\"></p> \n<p>如上图所示一次 HTTP 请求设计到很多地方需要编解码，它们编解码的规则是什么？下面将会重点阐述一下：</p> \n<p><strong>URL 的编解码</strong><br> 用户提交一个 URL，这个 URL 中可能存在中文，因此需要编码，如何对这个 URL 进行编码？根据什么规则来编码？有如何来解码？如下图一个 URL：</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/a2760dcf-85f2-4d52-ad98-a48c7c8646b9.png\"></p> \n<p>Port 对应在 Tomcat 的 \n <connector port=\"8080\"></connector> 中配置，而 Context Path 在 \n <context path=\"/examples\"></context> 中配置，Servlet Path 在 Web 应用的 web.xml 中的</p> \n<pre class=\"xml\"><code>    &lt;servlet-mapping&gt; \n            &lt;servlet-name&gt;junshanExample&lt;/servlet-name&gt; \n            &lt;url-pattern&gt;/servlets/servlet/*&lt;/url-pattern&gt; \n     &lt;/servlet-mapping&gt; </code></pre> \n<p>\n <url-pattern>\n   中配置，PathInfo 是我们请求的具体的 Servlet，QueryString 是要传递的参数，注意这里是在浏览器里直接输入 URL 所以是通过 Get 方法请求的，如果是 POST 方法请求的话，QueryString 将通过表单方式提交到服务器端，这个将在后面再介绍。\n </url-pattern></p> \n<p>上图中 PathInfo 和 QueryString 出现了中文，当我们在浏览器中直接输入这个 URL 时，在浏览器端和服务端会如何编码和解析这个 URL 呢？为了验证浏览器是怎么编码 URL 的我们选择 FireFox 浏览器并通过 HTTPFox 插件观察我们请求的 URL 的实际的内容，以下是 URL：HTTP://localhost:8080/examples/servlets/servlet/君山?author= 君山 在中文 FireFox3.6.12 的测试结果:</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/11/32c4db07-6ca2-469d-880a-87bfd5c16033.png\"></p> \n<p>君山的编码结果分别是：e5 90 9b e5 b1 b1，be fd c9 bd，查阅上一届的编码可知，PathInfo 是 UTF-8 编码而 QueryString 是经过 GBK 编码，至于为什么会有“%”？查阅 URL 的编码规范 RFC3986 可知浏览器编码 URL 是将非 ASCII 字符按照某种编码格式编码成 16 进制数字然后将每个 16 进制表示的字节前加上“%”，所以最终的 URL 就成了上图的格式了。</p> \n<p>从上面测试结果可知浏览器对 PathInfo 和 QueryString 的编码是不一样的，不同浏览器对 PathInfo 也可能不一样，这就对服务器的解码造成很大的困难，下面我们以 Tomcat 为例看一下，Tomcat 接受到这个 URL 是如何解码的。</p> \n<pre class=\"java\"><code>protected void convertURI(MessageBytes uri, Request request) \n throws Exception { \n        ByteChunk bc = uri.getByteChunk(); \n        int length = bc.getLength(); \n        CharChunk cc = uri.getCharChunk(); \n        cc.allocate(length, -1); \n        String enc = connector.getURIEncoding(); \n        if (enc != null) { \n            B2CConverter conv = request.getURIConverter(); \n            try { \n                if (conv == null) { \n                    conv = new B2CConverter(enc); \n                    request.setURIConverter(conv); \n                } \n            } catch (IOException e) {...} \n            if (conv != null) { \n                try { \n                    conv.convert(bc, cc, cc.getBuffer().length - \n cc.getEnd()); \n                    uri.setChars(cc.getBuffer(), cc.getStart(), \n cc.getLength()); \n                    return; \n                } catch (IOException e) {...} \n            } \n        } \n        // Default encoding: fast conversion \n        byte[] bbuf = bc.getBuffer(); \n        char[] cbuf = cc.getBuffer(); \n        int start = bc.getStart(); \n        for (int i = 0; i &lt; length; i++) { \n            cbuf[i] = (char) (bbuf[i + start] &amp; 0xff); \n        } \n        uri.setChars(cbuf, 0, length); \n }</code></pre> \n<p>从上面的代码中可以知道对 URL 的 URI 部分进行解码的字符集是在connector的 \n <connector uriencoding=\"”UTF-8”/\">\n   中定义的，如果没有定义，那么将以默认编码 ISO-8859-1 解析。所以如果有中文 URL 时最好把 URIEncoding 设置成 UTF-8 编码。\n </connector></p> \n<p>QueryString 又如何解析？ GET 方式 HTTP 请求的 QueryString 与 POST 方式 HTTP 请求的表单参数都是作为 Parameters 保存，都是通过 request.getParameter 获取参数值。对它们的解码是在 request.getParameter 方法第一次被调用时进行的。request.getParameter 方法被调用时将会调用 org.apache.catalina.connector.Request 的 parseParameters 方法。这个方法将会对 GET 和 POST 方式传递的参数进行解码，但是它们的解码字符集有可能不一样。POST 表单的解码将在后面介绍，QueryString 的解码字符集是在哪定义的呢？它本身是通过 HTTP 的 Header 传到服务端的，并且也在 URL 中，是否和 URI 的解码字符集一样呢？从前面浏览器对 PathInfo 和 QueryString 的编码采取不同的编码格式不同可以猜测到解码字符集肯定也不会是一致的。的确是这样 QueryString 的解码字符集要么是 Header 中 ContentType 中定义的 Charset 要么就是默认的 ISO-8859-1，要使用 ContentType 中定义的编码就要设置 connector 的 \n <connector uriencoding=\"”UTF-8”\" usebodyencodingforuri=\"”true”/\">\n   中的 useBodyEncodingForURI 设置为 true。这个配置项的名字有点让人产生混淆，它并不是对整个 URI 都采用 BodyEncoding 进行解码而仅仅是对 QueryString 使用 BodyEncoding 解码，这一点还要特别注意。\n </connector></p> \n<p>从上面的 URL 编码和解码过程来看，比较复杂，而且编码和解码并不是我们在应用程序中能完全控制的，所以在我们的应用程序中应该尽量避免在 URL 中使用非 ASCII 字符，不然很可能会碰到乱码问题，当然在我们的服务器端最好设置 \n <connector></connector> 中的 URIEncoding 和 useBodyEncodingForURI 两个参数。</p> \n<p><strong>HTTP Header 的编解码</strong><br> 当客户端发起一个 HTTP 请求除了上面的 URL 外还可能会在 Header 中传递其它参数如 Cookie、redirectPath 等，这些用户设置的值很可能也会存在编码问题，Tomcat 对它们又是怎么解码的呢？</p> \n<p>对 Header 中的项进行解码也是在调用 request.getHeader 是进行的，如果请求的 Header 项没有解码则调用 MessageBytes 的 toString 方法，这个方法将从 byte 到 char 的转化使用的默认编码也是 ISO-8859-1，而我们也不能设置 Header 的其它解码格式，所以如果你设置 Header 中有非 ASCII 字符解码肯定会有乱码。</p> \n<p>我们在添加 Header 时也是同样的道理，不要在 Header 中传递非 ASCII 字符，如果一定要传递的话，我们可以先将这些字符用 org.apache.catalina.util.URLEncoder 编码然后再添加到 Header 中，这样在浏览器到服务器的传递过程中就不会丢失信息了，如果我们要访问这些项时再按照相应的字符集解码就好了。</p> \n<p><strong>POST 表单的编解码</strong><br> 在前面提到了 POST 表单提交的参数的解码是在第一次调用 request.getParameter 发生的，POST 表单参数传递方式与 QueryString 不同，它是通过 HTTP 的 BODY 传递到服务端的。当我们在页面上点击 submit 按钮时浏览器首先将根据 ContentType 的 Charset 编码格式对表单填的参数进行编码然后提交到服务器端，在服务器端同样也是用 ContentType 中字符集进行解码。所以通过 POST 表单提交的参数一般不会出现问题，而且这个字符集编码是我们自己设置的，可以通过 request.setCharacterEncoding(charset) 来设置。</p> \n<p>另外针对 multipart/form-data 类型的参数，也就是上传的文件编码同样也是使用 ContentType 定义的字符集编码，值得注意的地方是上传文件是用字节流的方式传输到服务器的本地临时目录，这个过程并没有涉及到字符编码，而真正编码是在将文件内容添加到 parameters 中，如果用这个编码不能编码时将会用默认编码 ISO-8859-1 来编码。</p> \n<p><strong>HTTP BODY 的编解码</strong><br> 当用户请求的资源已经成功获取后，这些内容将通过 Response 返回给客户端浏览器，这个过程先要经过编码再到浏览器进行解码。这个过程的编解码字符集可以通过 response.setCharacterEncoding 来设置，它将会覆盖 request.getCharacterEncoding 的值，并且通过 Header 的 Content-Type 返回客户端，浏览器接受到返回的 socket 流时将通过 Content-Type 的 charset 来解码，如果返回的 HTTP Header 中 Content-Type 没有设置 charset，那么浏览器将根据 Html 的 \n <meta http-equiv=\"Content-Type\" content=\"text/html; charset=GBK\"> 中的 charset 来解码。如果也没有定义的话，那么浏览器将使用默认的编码来解码。</p> \n<p><strong>其他需要注意编码的地方</strong><br> 除了 URL 和参数编码问题外，在服务端还有很多地方可能存在编码，如可能需要读取 xml、velocity 模版引擎、JSP 或者从数据库读取数据等。</p> \n<p>xml 文件可以通过设置头来制定编码格式</p> \n<pre class=\"xml\"><code>    &lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt; </code></pre> \n<p>Velocity 模版设置编码格式：</p> \n<pre class=\"xml\"><code>services.VelocityService.input.encoding=UTF-8 </code></pre> \n<p>JSP 设置编码格式：</p> \n<pre class=\"xml\"><code>&lt;%@page contentType=\"text/html; charset=UTF-8\"%&gt;</code></pre> \n<p>访问数据库都是通过客户端 JDBC 驱动来完成，用 JDBC 来存取数据要和数据的内置编码保持一致，可以通过设置 JDBC URL 来制定如&nbsp;MySQL：</p> \n<pre class=\"xml\"><code>url=\"jdbc:mysql://localhost:3306/DB?useUnicode=true&amp;characterEncoding=GBK\"</code></pre> \n<h3 id=\"乱码问题分析\">8. 乱码问题分析</h3> \n<p>下面看一下，当我们碰到一些乱码时，应该怎么处理这些问题？出现乱码问题唯一的原因都是在 char 到 byte 或 byte 到 char 转换中编码和解码的字符集不一致导致的，由于往往一次操作涉及到多次编解码，所以出现乱码时很难查找到底是哪个环节出现了问题。根据自己的经验，往往从最源头开始一步步查原因是最快的。</p> \n<h3 id=\"参考\">9. 参考</h3> \n<p><a href=\"https://www.cnblogs.com/maohuidong/p/8044568.html\">编码博客</a></p> \n<p>为什么Java最多只能标识65535个字符</p> \n<p>Unicode本身只是一个标准，不是具体实现，并没有限定字节数。目前用于实用的 Unicode 版本对应于 UCS-2，使用16位的编码空间，因此最大能表示65535个字符。Unicode是发展的，6万个确实不够，事实上现在的Unicode已经支持超过10万个字符（第10万个于2005年被采纳，为马来亚拉姆语。当前的Unicode版本为6.3，2013年9月30日制定。Java中使用的仍是UCS-2。</p>', ' \n 目录 \n  \n   \n   1. ASCII编码 \n   2. Unicode编码 \n   3. UTF-8编码 \n   4. UTF8、UTF16和UTF32之间的区别 \n   5. GBK、GB2312和GB18030之间的区别 \n   6. Java中的编码问题 \n   8. 乱码问题分析 \n  ', '2019-10-12 15:13:56', 8, 1, 'java', 'https://www.cnblogs.com/54chensongxia/p/11650841.html', 1, '2019-10-17 17:09:46');
INSERT INTO `t_blog` VALUES (250, 'Android4.4 RIL软件框架', '<p><span style=\"font-size: 15px;\">&nbsp; &nbsp; <strong><span style=\"font-size: 14pt;\">本</span></strong>文主要对android4.4 RIL的telephony与modem的命令交互流程进行分析，当然本文不是重点介绍telephony。</span><br><span style=\"font-size: 15px;\">telephony涉及具体业务逻辑内容比较多，包括sim、dail、sms、network等等，以后会针对这些内容学习分析。</span></p> \n<p><span style=\"font-size: 15px;\">RIL在Android体系中的位置：</span></p> \n<p style=\"margin-left: 30px;\"><img src=\"http://localhost:9090/blogImages/2019/10/17/2c3c657d-7177-47a5-9e4f-73a60d3f3222.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p><span style=\"font-size: 15px;\">(A) 应用层发起访问modem的请求</span></p> \n<p><span style=\"font-size: 15px;\">(B) RILD进程</span></p> \n<p>&nbsp;</p> \n<p><span style=\"font-size: 14pt;\"><strong>(A) 应用层发起访问modem的请求</strong></span></p> \n<p style=\"margin-left: 30px;\">&nbsp; &nbsp; &nbsp; &nbsp;frameworks/opt/telephony/src/java/com/android/internal/telephony/RIL.java中的类RIL，提供了一系<br> 列的接口给上层应用调用，以访问modem。当然这些接口并不是直接给APP使用，而是由framework中sim、dail、<br> sms、network等相关服务调用。<br> 如: 以查询SIM卡状态getIccCardStatus()为例，该API为UiccController模块所调用：</p> \n<p style=\"margin-left: 30px;\"> 完整的SIM卡请求log:<br> <em>10-11 12:21:43.630 D/RILJ ( 1833): [3653]&gt; GET_SIM_STATUS</em><br><em> 10-11 12:21:43.630 D/RILC ( 1286): [0005]&gt; GET_SIM_STATUS </em><br><em> 10-11 12:21:43.630 D/RILC ( 1286): onRequest: GET_SIM_STATUS</em><br><em> 10-11 12:21:43.630 D/ATC ( 1286): AT&gt; AT+CPIN?</em><br><em> 10-11 12:21:43.640 D/ATC ( 1286): AT&lt; +CPIN: READY</em><br><em> 10-11 12:21:43.640 D/ATC ( 1286): AT&lt; OK</em><br><em> 10-11 12:21:43.640 D/RILC ( 1286): [0005]&lt; GET_SIM_STATUS {[app_type=1,app_state=5,perso_substate=2,aid_ptr=(null),app_label_ptr=(null),pin1_replaced=0,pin1=0,pin2=0],}</em><br><em> 10-11 12:21:43.640 D/RILJ ( 1833): [3653]&lt; GET_SIM_STATUS IccCardState {CARDSTATE_PRESENT,PINSTATE_UNKNOWN,num_apps=1,gsm_id=0{APPTYPE_SIM,APPSTATE_READY},cdma_id=8,ims_id=8}</em><br> <br> 发起请求：</p> \n<p><span style=\"font-size: 15px;\">&nbsp; &nbsp; &nbsp; &nbsp;<em>frameworks/opt/telephony/src/java/com/android/internal/telephony/RIL.java</em></span></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #000000;\">@Override                                                                                                                            \n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\">                                                                                                                          \n    getIccCardStatus(Message result) {                                                                                                   \n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">Note: This RIL request has not been renamed to ICC,                                                                            \n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">       but this request is also valid for SIM and RUIM                                                                         </span>\n        RILRequest rr = RILRequest.obtain(RIL_REQUEST_GET_SIM_STATUS, result);             <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 获取一个RILRequest </span><span style=\"color: #008000;\">*/</span>                                                       \n                                                                                                                                         \n        <span style=\"color: #0000ff;\">if</span> (RILJ_LOGD) riljLog(rr.serialString() + <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">&gt; </span><span style=\"color: #800000;\">\"</span> + requestToString(rr.mRequest));   <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 参考log：[3653]&gt; GET_SIM_STATUS </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                              \n                                                                                                                                         \n        send(rr);                                                                          </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 发送请求 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                                                                                                     \n    }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p><span style=\"font-size: 15px;\">&nbsp; &nbsp; &nbsp; &nbsp;RILRequest.obtain是从内存池获取一个RILRequest实例，并初始化：</span></p> \n<p><span style=\"font-size: 15px;\">&nbsp; &nbsp; &nbsp; &nbsp;<em>frameworks/opt/telephony/src/java/com/android/internal/telephony/RIL.java</em></span></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> RILRequest {\n            </span><span style=\"color: #0000ff;\">static</span> final String LOG_TAG = <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">RilRequest</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">;\n            \n            ... ...\n            \n            </span><span style=\"color: #0000ff;\">static</span> RILRequest obtain(<span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> request, Message result) {\n                RILRequest rr </span>= <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;                                                                                                            \n                                                                                                                                                 \n                synchronized(sPoolSync) {   </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 从内存池中取出一个RILRequest对象</span><span style=\"color: #008000;\">*/</span>                                                                \n                    <span style=\"color: #0000ff;\">if</span> (sPool != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">) {                                                                                                         \n                        rr </span>=<span style=\"color: #000000;\"> sPool;                                                                                                              \n                        sPool </span>=<span style=\"color: #000000;\"> rr.mNext;                                                                                                        \n                        rr.mNext </span>= <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;                                                                                                         \n                        sPoolSize</span>--<span style=\"color: #000000;\">;                                                                                                             \n                    }                                                                                                                            \n                }                                                                                                                                \n                                                                                                                                                 \n                </span><span style=\"color: #0000ff;\">if</span> (rr == <span style=\"color: #0000ff;\">null</span>) {           <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 如果内存池中没有，则实例化一个 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                                                 \n                    rr </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> RILRequest();                                                                                                       \n                }                                                                                                                                \n                                                                                                                                                 \n                rr.mSerial </span>= sNextSerial.getAndIncrement();   <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 获取串号，并且+1 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                                             \n                                                                                                                                                 \n                rr.mRequest </span>= request;      <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 对应RIL_REQUEST_*请求 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                                                          \n                rr.mResult </span>=<span style=\"color: #000000;\"> result;                                                                                                             \n                rr.mParcel </span>= Parcel.obtain();   <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 初始化一个Parcel，用于封包以发送给底层RILD </span><span style=\"color: #008000;\">*/</span>                                                 \n                                                                                                                                                 \n                <span style=\"color: #0000ff;\">if</span> (result != <span style=\"color: #0000ff;\">null</span> &amp;&amp; result.getTarget() == <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">) {                                                                              \n                    </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> NullPointerException(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">Message target must not be null</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);                                                           \n                }                                                                                                                                \n                                                                                                                                                 \n                </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> first elements in any RIL Parcel                                                                                              </span>\n                rr.mParcel.writeInt(request);   <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 每个RIL Parcel最开始也最基本的两个元素 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                                     \n                rr.mParcel.writeInt(rr.mSerial);\n\n                </span><span style=\"color: #0000ff;\">return</span> rr;                  <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 返回这个从内存池中获取的实例 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            }\n            \n            ... ...\n            \n            String\n            serialString() {\n                </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">Cheesy way to do %04d</span>\n                StringBuilder sb = <span style=\"color: #0000ff;\">new</span> StringBuilder(<span style=\"color: #800080;\">8</span>);   <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 创建一个StringBuilder实例用于操作字符串 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                String sn;\n\n                </span><span style=\"color: #0000ff;\">long</span> adjustedSerial = (((<span style=\"color: #0000ff;\">long</span>)mSerial) - Integer.MIN_VALUE)%<span style=\"color: #800080;\">10000</span><span style=\"color: #000000;\">;\n\n                sn </span>= Long.toString(adjustedSerial);        <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 把数值转换成字符串 </span><span style=\"color: #008000;\">*/</span>\n\n                <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">sb.append(\"J[\");</span>\n                sb.append(<span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">[</span><span style=\"color: #800000;\">\'</span><span style=\"color: #000000;\">);\n                </span><span style=\"color: #0000ff;\">for</span> (<span style=\"color: #0000ff;\">int</span> i = <span style=\"color: #800080;\">0</span>, s = sn.length() ; i &lt; <span style=\"color: #800080;\">4</span> - s; i++<span style=\"color: #000000;\">) {\n                    sb.append(</span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">0</span><span style=\"color: #800000;\">\'</span><span style=\"color: #000000;\">);\n                }\n\n                sb.append(sn);\n                sb.append(</span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">]</span><span style=\"color: #800000;\">\'</span><span style=\"color: #000000;\">);\n                </span><span style=\"color: #0000ff;\">return</span> sb.toString();                      <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 转换出来的字符串格式: [xxxx] </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            }\n            \n            ... ...\n    }  </span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">send(rr)发送请求到服务端：<br> <em>frameworks/opt/telephony/src/java/com/android/internal/telephony/RIL.java</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">private</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\">\n    send(RILRequest rr) {                                                                                                                \n        Message msg;                                                                                                                     \n        \n        ... ...                                                                                                                              \n        \n        msg </span>= mSender.obtainMessage(EVENT_SEND, rr); <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 发送EVENT_SEND时间，时间参数为RILRequest </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                      \n        \n        acquireWakeLock();                           </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 获取wakelock，禁止进入休眠 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                                    \n        \n        msg.sendToTarget();                          </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> message从handler类获取，从而可以直接向该handler对象发送消息。target就是创建message的handler </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n    } </span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">&nbsp; &nbsp; &nbsp; &nbsp; 实际上telephony无法直接与modem通讯，由于每个厂商的modem都不一样，modem存在于系统中的方式<br> 也不一样，如：有的CPU芯片厂商的modem是以一个CP核的方式集成在基带上（高通、展讯等），有的CPU芯<br> 片（Exynos 4412等）需要通过串口/USB外接modem模块，如：BC72 LTE模块等。<br> send(rr)向RILD发送请求，这里涉及一个进程间通信问题，而且Java侧与C++侧的进程通讯，当然这里并没<br> 有用Android开发的朋友都熟悉的Bind，而是socket。<br> telephony/Java侧RIL命令交互的处理，暂且称为RILJ。<br> RILJ作为socket的客户端，RILD（rild进程）作为服务端，后面会分析rild进程。<br> <br> socket客户端的创建：</p> \n<p>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em>frameworks/opt/telephony/src/java/com/android/internal/telephony/RIL.java</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">public</span> RIL(Context context, <span style=\"color: #0000ff;\">int</span> preferredNetworkType, <span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> cdmaSubscription) {                                                        \n        ... ...\n                                                                                                                                     \n        mSenderThread </span>= <span style=\"color: #0000ff;\">new</span> HandlerThread(\"RILSender\");               <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 创建RILSender线程 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                                                             \n        mSenderThread.start();                                                                                                           \n                                                                                                                                         \n        Looper looper </span>=<span style=\"color: #000000;\"> mSenderThread.getLooper();                                                                                       \n        mSender </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> RILSender(looper);                                                                                                 \n                                                                                                                                         \n        ConnectivityManager cm </span>=<span style=\"color: #000000;\"> (ConnectivityManager)context.getSystemService(                                                          \n                Context.CONNECTIVITY_SERVICE);                                                                                           \n        </span><span style=\"color: #0000ff;\">if</span> (cm.isNetworkSupported(ConnectivityManager.TYPE_MOBILE) == <span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">) {                                                           \n            riljLog(</span>\"Not starting RILReceiver: wifi-only\"<span style=\"color: #000000;\">);                                                                              \n        } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {                                                                                                                         \n            riljLog(</span>\"Starting RILReceiver\"<span style=\"color: #000000;\">);                                                                                             \n            mReceiver </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> RILReceiver();                                                                                               \n            mReceiverThread </span>= <span style=\"color: #0000ff;\">new</span> Thread(mReceiver, \"RILReceiver\");   <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 创建RILReceiver线程 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            mReceiverThread.start();  \n            \n            ... ...   \n        }\n        \n        ... ...\n    }\n    \n    </span><span style=\"color: #0000ff;\">class</span> RILReceiver <span style=\"color: #0000ff;\">implements</span><span style=\"color: #000000;\"> Runnable {                                                                                              \n        </span><span style=\"color: #0000ff;\">byte</span><span style=\"color: #000000;\">[] buffer;                                                                                                                   \n        \n        RILReceiver() {                                                     </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 构造时，分配一个数组 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                   \n            buffer </span>= <span style=\"color: #0000ff;\">new</span> <span style=\"color: #0000ff;\">byte</span><span style=\"color: #000000;\">[RIL_MAX_COMMAND_BYTES];                                                                                    \n        }                                                                                                                                \n        \n        @Override\n        </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\">                                                         \n        run() {                                                             </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 循环读取从RILD返回或主动上报的数据 </span><span style=\"color: #008000;\">*/</span>                     \n            <span style=\"color: #0000ff;\">int</span> retryCount = 0<span style=\"color: #000000;\">;                                                                                                          \n            \n            </span><span style=\"color: #0000ff;\">try</span> {<span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (;;) { \n                LocalSocket s </span>= <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;                                                                                                    \n                LocalSocketAddress l;                                                                                                    \n                \n                </span><span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> { \n                    s </span>= <span style=\"color: #0000ff;\">new</span> LocalSocket();                                  <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 创建一个socket客户端 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                   \n                    l </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> LocalSocketAddress(SOCKET_NAME_RIL,\n                            LocalSocketAddress.Namespace.RESERVED);         \n                    s.connect(l);                                           </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 连接服务器 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">  \n                }\n                \n                ... ...\n            }\n            \n            ... ... \n            \n            </span><span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\n                InputStream is </span>= mSocket.getInputStream();                    <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 循环读取socket的数据 </span><span style=\"color: #008000;\">*/</span>\n\n                <span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (;;) {\n                    Parcel p;\n\n                    length </span>= readRilMessage(is, buffer);                      <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 解析socket数据 </span><span style=\"color: #008000;\">*/</span>\n\n                    <span style=\"color: #0000ff;\">if</span> (length &lt; 0<span style=\"color: #000000;\">) {\n                        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> End-of-stream reached</span>\n                        <span style=\"color: #0000ff;\">break</span><span style=\"color: #000000;\">;\n                    }\n\n                    p </span>= Parcel.obtain();                                      <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 获取一个Parcel </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                    p.unmarshall(buffer, </span>0, length);                          <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 读取出来的就是之前序列化的byte数组，所以要进行一个反序列化操作 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                    p.setDataPosition(</span>0);                                     <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 从buffer转换到Parcel之后，需要将指针手动指向到最初的位置 </span><span style=\"color: #008000;\">*/</span>\n\n                    <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">Rlog.v(RILJ_LOG_TAG, \"Read packet: \" + length + \" bytes\");</span>\n<span style=\"color: #000000;\">\n                    processResponse(p);\n                    p.recycle();                                              </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 数据处理完后，需要回收Parcel的内存 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                }\n            }\n            \n            ... ...\n    }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">&nbsp; &nbsp; &nbsp; &nbsp; RILReceiver线程创建socket客户端，连接服务端，然后进入等待服务端的processResponse消息处理循环，RILJ<br> 接收到RILD回复的response返回RIL请求的发起者，以getIccCardStatus(Message result)为例，processResponse(p)<br> 会把DRILD的response返回给UiccController<br> <br> <em>frameworks/opt/telephony/src/java/com/android/internal/telephony/RIL.java</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">private</span> <span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">int</span> readRilMessage(InputStream is, <span style=\"color: #0000ff;\">byte</span><span style=\"color: #000000;\">[] buffer)\n            </span><span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> countRead;\n        </span><span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> offset;\n        </span><span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> remaining;\n        </span><span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> messageLength;\n\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> First, read in the length of the message</span>\n        offset = 0<span style=\"color: #000000;\">;\n        remaining </span>= 4<span style=\"color: #000000;\">;\n        </span><span style=\"color: #0000ff;\">do</span><span style=\"color: #000000;\"> {\n            countRead </span>= is.read(buffer, offset, remaining);                   <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 读出消息的4字节长度 </span><span style=\"color: #008000;\">*/</span>\n\n            <span style=\"color: #0000ff;\">if</span> (countRead &lt; 0<span style=\"color: #000000;\"> ) {\n                Rlog.e(RILJ_LOG_TAG, </span>\"Hit EOS reading message length\"<span style=\"color: #000000;\">);\n                </span><span style=\"color: #0000ff;\">return</span> -1<span style=\"color: #000000;\">;\n            }\n\n            offset </span>+=<span style=\"color: #000000;\"> countRead;\n            remaining </span>-=<span style=\"color: #000000;\"> countRead;\n        } </span><span style=\"color: #0000ff;\">while</span> (remaining &gt; 0<span style=\"color: #000000;\">);\n\n        messageLength </span>= ((buffer[0] &amp; 0xff) &lt;&lt; 24)                            <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 获取长度 </span><span style=\"color: #008000;\">*/</span>\n                | ((buffer[1] &amp; 0xff) &lt;&lt; 16<span style=\"color: #000000;\">)\n                </span>| ((buffer[2] &amp; 0xff) &lt;&lt; 8<span style=\"color: #000000;\">)\n                </span>| (buffer[3] &amp; 0xff<span style=\"color: #000000;\">);\n\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Then, re-use the buffer and read in the message itself</span>\n        offset = 0<span style=\"color: #000000;\">;\n        remaining </span>=<span style=\"color: #000000;\"> messageLength;\n        </span><span style=\"color: #0000ff;\">do</span><span style=\"color: #000000;\"> {\n            countRead </span>= is.read(buffer, offset, remaining);                   <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 读取剩余的数据 </span><span style=\"color: #008000;\">*/</span>\n\n            <span style=\"color: #0000ff;\">if</span> (countRead &lt; 0<span style=\"color: #000000;\"> ) {\n                Rlog.e(RILJ_LOG_TAG, </span>\"Hit EOS reading message.  messageLength=\" +<span style=\"color: #000000;\"> messageLength\n                        </span>+ \" remaining=\" +<span style=\"color: #000000;\"> remaining);\n                </span><span style=\"color: #0000ff;\">return</span> -1<span style=\"color: #000000;\">;\n            }\n\n            offset </span>+=<span style=\"color: #000000;\"> countRead;\n            remaining </span>-=<span style=\"color: #000000;\"> countRead;\n        } </span><span style=\"color: #0000ff;\">while</span> (remaining &gt; 0<span style=\"color: #000000;\">);\n\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> messageLength;\n    }\n\n    </span><span style=\"color: #0000ff;\">private</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\">\n    processResponse (Parcel p) {\n        </span><span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> type;\n\n        type </span>= p.readInt();                          <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 从RILD返回的数据第一个字节，表示请求的返回类型:RESPONSE_UNSOLICITED/RESPONSE_SOLICITED </span><span style=\"color: #008000;\">*/</span>\n\n        <span style=\"color: #0000ff;\">if</span> (type ==<span style=\"color: #000000;\"> RESPONSE_UNSOLICITED) {\n            processUnsolicited (p);                  </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 主动上报 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n        } </span><span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (type ==<span style=\"color: #000000;\"> RESPONSE_SOLICITED) {\n            RILRequest rr </span>= processSolicited (p);    <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 普通请求对应的同步上报 </span><span style=\"color: #008000;\">*/</span>\n            <span style=\"color: #0000ff;\">if</span> (rr != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">) {\n                rr.release();                        </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 释放对应的RILRequest内存和wakelock </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                decrementWakeLock();\n            }\n        }\n    }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">&nbsp; &nbsp; &nbsp; &nbsp; RILD的response一般有两种，一种是RILJ普通请求,RILD对RILJ请求的response (RESPONSE_SOLICITED)，另一种是RILD主动上报的<br> response (RESPONSE_UNSOLICITED), processResponse (Parcel p)分别对这两种情况的response进行处理。<br> <br> <em>frameworks/opt/telephony/src/java/com/android/internal/telephony/RIL.java</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">private</span><span style=\"color: #000000;\"> RILRequest\n    processSolicited (Parcel p) {\n        </span><span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> serial, error;\n        </span><span style=\"color: #0000ff;\">boolean</span> found = <span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">;\n\n        serial </span>= p.readInt();                          <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 串号，也就是token </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n        error </span>= p.readInt();                           <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 错误码 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n        RILRequest rr;\n\n        rr </span>= findAndRemoveRequestFromList(serial);     <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 根据taken取出对应的RILRequest </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n        ... ...\n             </span>*/\n            <span style=\"color: #0000ff;\">case</span> RIL_REQUEST_GET_SIM_STATUS: ret =  responseIccCardStatus(p); <span style=\"color: #0000ff;\">break</span><span style=\"color: #000000;\">;\n\n        ... ...\n        \n            </span><span style=\"color: #0000ff;\">if</span> (rr.mResult != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">) {\n                AsyncResult.forMessage(rr.mResult, ret, </span><span style=\"color: #0000ff;\">null</span>);        <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 把rr.mResult存到AsyncResult.userObj,并把rr.mResult.obj转换为AsyncResult </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                rr.mResult.sendToTarget();                            </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> msg发送到对应的target(Handler) </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            }\n            \n        ... ...    \n    }   \n    \n    </span><span style=\"color: #0000ff;\">private</span><span style=\"color: #000000;\"> Object\n    responseIccCardStatus(Parcel p) {\n        IccCardApplicationStatus appStatus;\n        \n        ... ...\n        \n        appStatus </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> IccCardApplicationStatus();\n        \n        ... ...\n\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> cardStatus;\n    }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">&nbsp; &nbsp; &nbsp; &nbsp; 回到刚才send(rr)，send(rr)并不是直接发送到socket服务端RILD，而是通过一个Message发送到RILSender线程，<br> 在handleMessage中，把请求发到socket服务端RILD。</p> \n<p style=\"margin-left: 30px;\"><em>frameworks/opt/telephony/src/java/com/android/internal/telephony/RIL.java</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">class</span> RILSender <span style=\"color: #0000ff;\">extends</span> Handler <span style=\"color: #0000ff;\">implements</span> Runnable {            <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 继承Handler，实现Runnable </span><span style=\"color: #008000;\">*/</span>                                                         \n        <span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> RILSender(Looper looper) {                                                                                                                    \n            </span><span style=\"color: #0000ff;\">super</span><span style=\"color: #000000;\">(looper);                                                                                                                                   \n        }                                                                                                                                                    \n        \n        ... ...                                                                                                                                                                                                                                                                                                        \n        \n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">***** Handler implementation                                                                                                                       </span>\n        @Override <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> \n        handleMessage(Message msg) {                                 </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 继承Handler的handleMessage </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            RILRequest rr </span>= (RILRequest)(msg.obj);                   <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> Maessage中携带的RILRequest对象 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                                    \n            RILRequest req </span>= <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;                                                                                                                           \n            \n            </span><span style=\"color: #0000ff;\">switch</span><span style=\"color: #000000;\"> (msg.what) {\n                </span><span style=\"color: #0000ff;\">case</span> EVENT_SEND:                                     <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 发送RIL请求事件 </span><span style=\"color: #008000;\">*/</span>                                                                   \n                    <span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\n                        LocalSocket s;                                                                                                                       \n                        \n                        s </span>= mSocket;                                 <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> RILReceiver中创建的用于与RILD通讯的socket </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                                         \n                        \n                        ... ...                                                                                                                                  \n                        \n                        </span><span style=\"color: #0000ff;\">synchronized</span> (mRequestList) {                <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 多线程保护操作mRequestList </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                            mRequestList.append(rr.mSerial, rr);     </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 把接受到的RILRequest和对应的串号，存到mRequestList数据 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">                            \n                        }                                                                                                                                    \n\n                        </span><span style=\"color: #0000ff;\">byte</span><span style=\"color: #000000;\">[] data;\n                        data </span>= rr.mParcel.marshall();                <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 把Parcel中的数据转换为byte数据 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                        rr.mParcel.recycle();                        </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> Parcel的内存回收 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                        rr.mParcel </span>= <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\n\n                        ... ...\n\n                        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> parcel length in big endian</span>\n                        dataLength[0] = dataLength[1] = 0;           <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> RIL请求包的大小为4个字节 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                        dataLength[</span>2] = (<span style=\"color: #0000ff;\">byte</span>)((data.length &gt;&gt; 8) &amp; 0xff<span style=\"color: #000000;\">);\n                        dataLength[</span>3] = (<span style=\"color: #0000ff;\">byte</span>)((data.length) &amp; 0xff<span style=\"color: #000000;\">);\n\n                        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">Rlog.v(RILJ_LOG_TAG, \"writing packet: \" + data.length + \" bytes\");</span>\n<span style=\"color: #000000;\">\n                        s.getOutputStream().write(dataLength);       </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 把包大小和包数据发送出去 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                        s.getOutputStream().write(data);\n                    } </span><span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\"> (IOException ex) {\n                        Rlog.e(RILJ_LOG_TAG, </span>\"IOException\"<span style=\"color: #000000;\">, ex);\n                        req </span>= findAndRemoveRequestFromList(rr.mSerial);    <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 如果出现异常，则把串号对应的RILRequest从mRequestList中删除 </span><span style=\"color: #008000;\">*/</span>\n                        <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> make sure this request has not already been handled,\n                        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> eg, if RILReceiver cleared the list.</span>\n                        <span style=\"color: #0000ff;\">if</span> (req != <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">) {\n                            rr.onError(RADIO_NOT_AVAILABLE, </span><span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n                            rr.release();\n                            decrementWakeLock();\n                        }\n                    } \n                    \n                    ... ...\n            }\n        }\n    } </span></pre> \n</div> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p><span style=\"font-size: 14pt;\"><strong>(B) RILD进程</strong></span></p> \n<p style=\"margin-left: 30px;\">&nbsp; &nbsp; &nbsp; &nbsp; RILD作为一个独立的进程，telephony与modem之间的通讯通道。抽象出一些接口以适配不同的modem厂商，无需关心具体的<br> 硬件操作，或者以哪种形式存存在于系统(modem作为CP集成于CPU或CPU通过串口/USB连接，如: BC72 LTE模块)。因为这些接口<br> 由厂商去实现具体的硬件操作细节，这些接口都在libreference-ril中，在Android中使用BC72 LTE模块，只要移植<br> libreference-ril就行。<br> <br> <strong>1. RILD的启动</strong><br> RILD有init进程直接启动，启动后就监听RILJ客户端，等待RILJ连接请求。<br> <em>device/samsung/smdk4x12/conf/init.smdk4x12.rc</em></p> \n<div class=\"cnblogs_code\"> \n <pre>service ril-daemon /system/bin/rild -l /system/lib/libreference-<span style=\"color: #000000;\">ril.so\n    </span><span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> main\n    socket rild stream </span>660<span style=\"color: #000000;\"> root radio\n    socket rild</span>-debug stream 660<span style=\"color: #000000;\"> radio system\n    user root</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;hardware/ril/rild/rild.c为RILD进程入口：</p> \n<p>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em>hardware/ril/rild/rild.c</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">int</span> main(<span style=\"color: #0000ff;\">int</span> argc, <span style=\"color: #0000ff;\">char</span> **<span style=\"color: #000000;\">argv)\n        {\n            ... ...\n            \n            dlHandle </span>= dlopen(rilLibPath, RTLD_NOW);    <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 打开/system/lib/libreference-ril.so </span><span style=\"color: #008000;\">*/</span>\n\n            <span style=\"color: #0000ff;\">if</span> (dlHandle ==<span style=\"color: #000000;\"> NULL) {\n                RLOGE(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">dlopen failed: %s</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">, dlerror());\n                exit(</span>-<span style=\"color: #800080;\">1</span><span style=\"color: #000000;\">);\n            }\n\n            RIL_startEventLoop();                       </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 创建eventLoop线程, 在ril_event_loop()中监听多路IO的事件，如主动唤醒事件(pipe)、RILJ的请求等 </span><span style=\"color: #008000;\">*/</span>\n\n            <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 获取/system/lib/libreference-ril.so中RIL_Init函数指针 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            rilInit </span>= (<span style=\"color: #0000ff;\">const</span> RIL_RadioFunctions *(*)(<span style=\"color: #0000ff;\">const</span> <span style=\"color: #0000ff;\">struct</span> RIL_Env *, <span style=\"color: #0000ff;\">int</span>, <span style=\"color: #0000ff;\">char</span> **))dlsym(dlHandle, <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">RIL_Init</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\n            </span><span style=\"color: #0000ff;\">if</span> (rilInit ==<span style=\"color: #000000;\"> NULL) {\n                RLOGE(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">RIL_Init not defined or exported in %s\\n</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">, rilLibPath);\n                exit(</span>-<span style=\"color: #800080;\">1</span><span style=\"color: #000000;\">);\n            }\n\n            </span><span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (hasLibArgs) {\n                rilArgv </span>= argv + i - <span style=\"color: #800080;\">1</span><span style=\"color: #000000;\">;\n                argc </span>= argc -i + <span style=\"color: #800080;\">1</span><span style=\"color: #000000;\">;\n            } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n                </span><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">char</span> *<span style=\"color: #000000;\"> newArgv[MAX_LIB_ARGS];\n                </span><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">char</span><span style=\"color: #000000;\"> args[PROPERTY_VALUE_MAX];\n                rilArgv </span>=<span style=\"color: #000000;\"> newArgv;\n                property_get(LIB_ARGS_PROPERTY, args, </span><span style=\"color: #800000;\">\"\"</span><span style=\"color: #000000;\">);\n                argc </span>=<span style=\"color: #000000;\"> make_argv(args, rilArgv);\n            }\n\n            </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Make sure there\'s a reasonable argv[0]</span>\n            rilArgv[<span style=\"color: #800080;\">0</span>] = argv[<span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">];\n\n            funcs </span>= rilInit(&amp;s_rilEnv, argc, rilArgv);          <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 初始化Vender RIL </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            RIL_register(funcs);                                </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 注册RIL </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            \n            ... ...\n        }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\"><em>hardware/ril/libril/ril.cpp</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">extern</span> <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">C</span><span style=\"color: #800000;\">\"</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\">\n        RIL_startEventLoop(</span><span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\">) {\n            \n            ... ...\n            \n            ret </span>= pthread_create(&amp;s_tid_dispatch, &amp;attr, eventLoop, NULL);        <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 创建eventLoop线程 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            ... ...\n        }\n        \n        </span><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span> *<span style=\"color: #000000;\">\n        eventLoop(</span><span style=\"color: #0000ff;\">void</span> *<span style=\"color: #000000;\">param) {\n            </span><span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> ret;\n            </span><span style=\"color: #0000ff;\">int</span> filedes[<span style=\"color: #800080;\">2</span><span style=\"color: #000000;\">];\n\n            ril_event_init();                                 </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 初始化事件链表，timer_list，pending_list, watch_table </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            pthread_mutex_lock(</span>&amp;<span style=\"color: #000000;\">s_startupMutex);\n\n            s_started </span>= <span style=\"color: #800080;\">1</span><span style=\"color: #000000;\">;\n            pthread_cond_broadcast(</span>&amp;<span style=\"color: #000000;\">s_startupCond);\n\n            pthread_mutex_unlock(</span>&amp;<span style=\"color: #000000;\">s_startupMutex);\n\n            ret </span>= pipe(filedes);                              <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 创建一个pipe，用于每次添加一个新事件时，唤醒selet()返回，更新fd_set使select监听新的事件 </span><span style=\"color: #008000;\">*/</span>\n\n            <span style=\"color: #0000ff;\">if</span> (ret &lt; <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">) {\n                RLOGE(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">Error in pipe() errno:%d</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">, errno);\n                </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> NULL;\n            }\n\n            s_fdWakeupRead </span>= filedes[<span style=\"color: #800080;\">0</span>];                      <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> filedes[0]用于读pipe， filedes[1]用于写pipe </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            s_fdWakeupWrite </span>= filedes[<span style=\"color: #800080;\">1</span><span style=\"color: #000000;\">];\n\n            fcntl(s_fdWakeupRead, F_SETFL, O_NONBLOCK);       </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 以非阻塞的方式读pipe </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            ril_event_set (</span>&amp;s_wakeupfd_event, s_fdWakeupRead, <span style=\"color: #0000ff;\">true</span>,    <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 读pipe描述符绑定到s_wakeupfd_event事件，指定回调processWakeupCallback </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                        processWakeupCallback, NULL);\n\n            rilEventAddWakeup (</span>&amp;s_wakeupfd_event);            <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 添加s_wakeupfd_event事件到watch_table,更新readFds集合，使select监听该事件，并触发该事件 </span><span style=\"color: #008000;\">*/</span>\n\n            <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Only returns on error</span>\n            ril_event_loop();                                 <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 进入多路IO事件监听循环 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            RLOGE (</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">error in event_loop_base errno:%d</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">, errno);\n            </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> kill self to restart on error</span>\n            kill(<span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">, SIGKILL);\n\n            </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> NULL;\n        }            </span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">&nbsp; &nbsp; &nbsp; &nbsp; main函数主要启动eventLoop线程，在ril_event_loop()中监听多路IO的事件，如主动唤醒事件(pipe)、RILJ的请求等，<br> 注册vendor RIL接口（libreference-ril）<br>&nbsp; &nbsp; &nbsp; &nbsp; 注意这里pipe的主要作用是唤醒select返回，因为每次动态的添加一个事件，都要更新readFds集合，方便select监听<br> 集合中新的IO。<br>&nbsp; &nbsp; &nbsp; &nbsp; rilEventAddWakeup()添加新事件后，都会触发select返回<br> <br> <em>hardware/ril/libril/ril.cpp</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span> rilEventAddWakeup(<span style=\"color: #0000ff;\">struct</span> ril_event *<span style=\"color: #000000;\">ev) {\n            ril_event_add(ev);       </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 添加事件 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            triggerEvLoop();         </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 触发事件, 每添加一个事件，都通过写pipe唤醒select，以更新多路IO集合，使能够监听该事件 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n        }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\"><em>hardware/ril/libril/ril_event.cpp</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">void</span> ril_event_add(<span style=\"color: #0000ff;\">struct</span> ril_event *<span style=\"color: #000000;\"> ev)\n        {   \n            dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ +ril_event_add ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\n            MUTEX_ACQUIRE();\n            </span><span style=\"color: #0000ff;\">for</span> (<span style=\"color: #0000ff;\">int</span> i = <span style=\"color: #800080;\">0</span>; i &lt; MAX_FD_EVENTS; i++<span style=\"color: #000000;\">) {\n                </span><span style=\"color: #0000ff;\">if</span> (watch_table[i] ==<span style=\"color: #000000;\"> NULL) {\n                    watch_table[i] </span>= ev;                  <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 将新事件添加到watch_table </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                    ev</span>-&gt;index =<span style=\"color: #000000;\"> i;\n                    dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ added at %d ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">, i);\n                    dump_event(ev);\n                    FD_SET(ev</span>-&gt;fd, &amp;readFds);             <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 更新readFds集合 </span><span style=\"color: #008000;\">*/</span>\n                    <span style=\"color: #0000ff;\">if</span> (ev-&gt;fd &gt;= nfds) nfds = ev-&gt;fd+<span style=\"color: #800080;\">1</span>;  <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 更新nfds </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                    dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ nfds = %d ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">, nfds);\n                    </span><span style=\"color: #0000ff;\">break</span><span style=\"color: #000000;\">;\n                }                                 \n            }       \n            MUTEX_RELEASE();\n            dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ -ril_event_add ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\n        }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">&nbsp;<em>hardware/ril/libril/ril.cpp</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> triggerEvLoop() {\n            </span><span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> ret;\n            </span><span style=\"color: #0000ff;\">if</span> (!<span style=\"color: #000000;\">pthread_equal(pthread_self(), s_tid_dispatch)) {\n                </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> trigger event loop to wakeup. No reason to do this,\n                 * if we\'re in the event loop thread </span><span style=\"color: #008000;\">*/</span>\n                 <span style=\"color: #0000ff;\">do</span><span style=\"color: #000000;\"> {\n                    ret </span>= write (s_fdWakeupWrite, <span style=\"color: #800000;\">\"</span> <span style=\"color: #800000;\">\"</span>, <span style=\"color: #800080;\">1</span>);        <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 向pipe写入一个\" \"，以唤醒select </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                 } </span><span style=\"color: #0000ff;\">while</span> (ret &lt; <span style=\"color: #800080;\">0</span> &amp;&amp; errno ==<span style=\"color: #000000;\"> EINTR);\n            }\n        } </span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">在ril_event_loop()接收到事件或socket客户端RILJ发过来的请求后，firePending()根据事件请求，调用相应的处理函数<br> <em>hardware/ril/libril/ril_event.cpp</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> ril_event_loop()\n        {\n            </span><span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> n;\n            fd_set rfds;\n            </span><span style=\"color: #0000ff;\">struct</span><span style=\"color: #000000;\"> timeval tv;\n            </span><span style=\"color: #0000ff;\">struct</span> timeval *<span style=\"color: #000000;\"> ptv;\n\n\n            </span><span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (;;) {\n\n                </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> make local copy of read fd_set</span>\n                memcpy(&amp;rfds, &amp;readFds, <span style=\"color: #0000ff;\">sizeof</span><span style=\"color: #000000;\">(fd_set));\n                </span><span style=\"color: #0000ff;\">if</span> (-<span style=\"color: #800080;\">1</span> == calcNextTimeout(&amp;tv)) {                        <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 计算timer_list链表中每个事件对应的超时时间 </span><span style=\"color: #008000;\">*/</span>\n                    <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> no pending timers; block indefinitely</span>\n                    dlog(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ no timers; blocking indefinitely ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\n                    ptv </span>=<span style=\"color: #000000;\"> NULL;\n                } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n                    dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ blocking for %ds + %dus ~~~~</span><span style=\"color: #800000;\">\"</span>, (<span style=\"color: #0000ff;\">int</span>)tv.tv_sec, (<span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\">)tv.tv_usec);\n                    ptv </span>= &amp;<span style=\"color: #000000;\">tv;\n                }\n                printReadies(</span>&amp;<span style=\"color: #000000;\">rfds);\n                n </span>= <span style=\"color: #0000ff;\">select</span>(nfds, &amp;rfds, NULL, NULL, ptv);                <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 等待readFds集合中的事件唤醒 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                printReadies(</span>&amp;<span style=\"color: #000000;\">rfds);\n                dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ %d events fired ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">, n);\n                </span><span style=\"color: #0000ff;\">if</span> (n &lt; <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">) {\n                    </span><span style=\"color: #0000ff;\">if</span> (errno == EINTR) <span style=\"color: #0000ff;\">continue</span><span style=\"color: #000000;\">;\n\n                    RLOGE(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">ril_event: select error (%d)</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">, errno);\n                    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> bail?</span>\n                    <span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\">;\n                }\n\n                </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Check for timeouts</span>\n                processTimeouts();                                       <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 检查timer_list链表中是否有事件已经超时 </span><span style=\"color: #008000;\">*/</span>\n                <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Check for read-ready</span>\n                processReadReadies(&amp;rfds, n);                            <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 从watch_table中取出监听到的事件, 并添加到pending_list链表 </span><span style=\"color: #008000;\">*/</span>\n                <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Fire away</span>\n                firePending();                                           <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 从pending_list依次取出事件,并执行该事件的回调 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            }\n        }\n        \n        </span><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> processTimeouts()\n        {\n            dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ +processTimeouts ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\n            MUTEX_ACQUIRE();\n            </span><span style=\"color: #0000ff;\">struct</span><span style=\"color: #000000;\"> timeval now;\n            </span><span style=\"color: #0000ff;\">struct</span> ril_event * tev =<span style=\"color: #000000;\"> timer_list.next;\n            </span><span style=\"color: #0000ff;\">struct</span> ril_event *<span style=\"color: #000000;\"> next;\n\n            getNow(</span>&amp;<span style=\"color: #000000;\">now);\n            </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> walk list, see if now &gt;= ev-&gt;timeout for any events</span>\n            <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 检查timer_list链表中是否有事件已经超时 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ Looking for timers &lt;= %ds + %dus ~~~~</span><span style=\"color: #800000;\">\"</span>, (<span style=\"color: #0000ff;\">int</span>)now.tv_sec, (<span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\">)now.tv_usec);\n            </span><span style=\"color: #0000ff;\">while</span> ((tev != &amp;timer_list) &amp;&amp; (timercmp(&amp;now, &amp;tev-&gt;timeout, &gt;<span style=\"color: #000000;\">))) {\n                </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Timer expired</span>\n                dlog(<span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ firing timer ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\n                next </span>= tev-&gt;<span style=\"color: #000000;\">next;\n                removeFromList(tev);               </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 将该超时移出链表 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                addToList(tev, </span>&amp;pending_list);     <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 并且将该超时添加到pending链表 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                tev </span>= next;                        <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 指针指向下一个超时 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            }\n            MUTEX_RELEASE();\n            dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ -processTimeouts ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\n        }\n        \n        </span><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span> processReadReadies(fd_set * rfds, <span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> n)\n        {\n            dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ +processReadReadies (%d) ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">, n);\n            MUTEX_ACQUIRE();\n\n            </span><span style=\"color: #0000ff;\">for</span> (<span style=\"color: #0000ff;\">int</span> i = <span style=\"color: #800080;\">0</span>; (i &lt; MAX_FD_EVENTS) &amp;&amp; (n &gt; <span style=\"color: #800080;\">0</span>); i++<span style=\"color: #000000;\">) {\n                </span><span style=\"color: #0000ff;\">struct</span> ril_event * rev =<span style=\"color: #000000;\"> watch_table[i];\n                </span><span style=\"color: #0000ff;\">if</span> (rev != NULL &amp;&amp; FD_ISSET(rev-&gt;fd, rfds)) {        <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 从watch_table中取出监听到的事件 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                    addToList(rev, </span>&amp;pending_list);                   <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 并把该事件加入pending_list链表 </span><span style=\"color: #008000;\">*/</span>\n                    <span style=\"color: #0000ff;\">if</span> (rev-&gt;persist == <span style=\"color: #0000ff;\">false</span>) {                     <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 如果该事件不需要处理，则移出removeWatch </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                        removeWatch(rev, i);\n                    }\n                    n</span>--<span style=\"color: #000000;\">;\n                }\n            }\n\n            MUTEX_RELEASE();\n            dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ -processReadReadies (%d) ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">, n);\n        }\n        \n        </span><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> firePending()\n        {\n            dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ +firePending ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\n            </span><span style=\"color: #0000ff;\">struct</span> ril_event * ev =<span style=\"color: #000000;\"> pending_list.next;\n            </span><span style=\"color: #0000ff;\">while</span> (ev != &amp;pending_list) {                            <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 从pending_list依次取出事件 </span><span style=\"color: #008000;\">*/</span>\n                <span style=\"color: #0000ff;\">struct</span> ril_event * next = ev-&gt;<span style=\"color: #000000;\">next;\n                removeFromList(ev);\n                ev</span>-&gt;func(ev-&gt;fd, <span style=\"color: #800080;\">0</span>, ev-&gt;param);                      <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 并执行该事件的回调 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                ev </span>=<span style=\"color: #000000;\"> next;\n            }\n            dlog(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">~~~~ -firePending ~~~~</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\n        }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">&nbsp; &nbsp; &nbsp; &nbsp; 上面分析了RIL_startEventLoop()的事件流程，简单总结就是根据事件调用该事件的处理函数。<br> 到这里还没说到怎样创建socket服务端的，回到mian()，funcs = rilInit(&amp;s_rilEnv, argc, rilArgv);<br> 初始化了libreference-ril,RIL_register(funcs);注册了厂商须实现的相关接口，创建socket服务端的，<br> 并监听客户端连接，一旦连接，则开始等待读取客户端发过来的请求。</p> \n<p style=\"margin-left: 30px;\"><em>hardware/ril/libril/ril.cpp</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">extern</span> <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">C</span><span style=\"color: #800000;\">\"</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\">\n    RIL_register (</span><span style=\"color: #0000ff;\">const</span> RIL_RadioFunctions *<span style=\"color: #000000;\">callbacks) {\n    \n        ... ...\n        \n        s_fdListen </span>= android_get_control_socket(SOCKET_NAME_RIL);               <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 创建socket服务端，用于与RILJ通信 </span><span style=\"color: #008000;\">*/</span>\n            <span style=\"color: #0000ff;\">if</span> (s_fdListen &lt; <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">) {\n                RLOGE(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">Failed to get socket \'</span><span style=\"color: #800000;\">\"</span> SOCKET_NAME_RIL <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\n                exit(</span>-<span style=\"color: #800080;\">1</span><span style=\"color: #000000;\">);\n            }\n\n            ret </span>= listen(s_fdListen, <span style=\"color: #800080;\">4</span>);                                            <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 监听RILJ </span><span style=\"color: #008000;\">*/</span>\n\n            <span style=\"color: #0000ff;\">if</span> (ret &lt; <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">) {\n                RLOGE(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">Failed to listen on control socket \'%d\': %s</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">,\n                     s_fdListen, strerror(errno));\n                exit(</span>-<span style=\"color: #800080;\">1</span><span style=\"color: #000000;\">);\n            }\n\n            </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> note: non-persistent so we can accept only one connection at a time </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            ril_event_set (</span>&amp;s_listen_event, s_fdListen, <span style=\"color: #0000ff;\">false</span>,                      <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 设置一个监听事件s_listen_event，一旦与RILJ建立连 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                        listenCallback, NULL);                                      </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 则进入listenCallback，等待读取RILJ发送数据 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            rilEventAddWakeup (</span>&amp;s_listen_event);                                    <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 添加s_listen_event到watch_table, 唤醒select </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            \n            ... ...\n        }\n        \n        </span><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span> listenCallback (<span style=\"color: #0000ff;\">int</span> fd, <span style=\"color: #0000ff;\">short</span> flags, <span style=\"color: #0000ff;\">void</span> *<span style=\"color: #000000;\">param) {\n\n            ... ...\n            \n            s_fdCommand </span>= accept(s_fdListen, (sockaddr *) &amp;peeraddr, &amp;socklen);          <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 接受RILJ客户端的连接 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            ... ...\n            \n            err </span>= getsockopt(s_fdCommand, SOL_SOCKET, SO_PEERCRED, &amp;creds, &amp;<span style=\"color: #000000;\">szCreds);\n            \n            ret </span>= fcntl(s_fdCommand, F_SETFL, O_NONBLOCK);                                <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 非阻塞方式读写socket </span><span style=\"color: #008000;\">*/</span>\n\n            <span style=\"color: #0000ff;\">if</span> (ret &lt; <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">) {\n                RLOGE (</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">Error setting O_NONBLOCK errno:%d</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">, errno);\n            }\n\n            RLOGI(</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">libril: new connection</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">);\n\n            p_rs </span>= record_stream_new(s_fdCommand, MAX_COMMAND_BYTES);                     <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 创建一个stream用于缓存读socket的数据 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            ril_event_set (</span>&amp;s_commands_event, s_fdCommand, <span style=\"color: #800080;\">1</span>,                             <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 设置s_commands_event，processCommandsCallback循环读取socket的数据 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                processCommandsCallback, p_rs);\n\n            rilEventAddWakeup (</span>&amp;s_commands_event);                                        <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 添加s_commands_event事件，唤醒select </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            onNewCommandConnect();                                                        </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 通知RILJ已建立连接 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n      }\n\n    </span><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span> processCommandsCallback(<span style=\"color: #0000ff;\">int</span> fd, <span style=\"color: #0000ff;\">short</span> flags, <span style=\"color: #0000ff;\">void</span> *<span style=\"color: #000000;\">param) {\n            \n            ... ...\n            \n            </span><span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (;;) {\n                </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> loop until EAGAIN/EINTR, end of stream, or other error </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                ret </span>= record_stream_get_next(p_rs, &amp;p_record, &amp;recordlen);        <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 循环从数据流中读取socket数据 </span><span style=\"color: #008000;\">*/</span>\n\n                <span style=\"color: #0000ff;\">if</span> (ret == <span style=\"color: #800080;\">0</span> &amp;&amp; p_record ==<span style=\"color: #000000;\"> NULL) {\n                    </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> end-of-stream </span><span style=\"color: #008000;\">*/</span>\n                    <span style=\"color: #0000ff;\">break</span><span style=\"color: #000000;\">;\n                } </span><span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (ret &lt; <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">) {\n                    </span><span style=\"color: #0000ff;\">break</span><span style=\"color: #000000;\">;\n                } </span><span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (ret == <span style=\"color: #800080;\">0</span>) { <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> &amp;&amp; p_record != NULL </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                    processCommandBuffer(p_record, recordlen);                    </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 对接受到的数据进行组包，下发给vender ril，即libreference-ril.so </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n                }\n            }\n        }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">&nbsp; &nbsp; &nbsp; &nbsp; processCommandBuffer(p_record, recordlen)对接收到的数据进行组包，下发给vender ril，即libreference-ril.so，<br> 然后就脱离了RILD的控制了，libreference-ril.so主要是厂商对RILD控制modem接口的实现。<br> <br> <em>hardware/ril/libril/ril.cpp</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\">\n        processCommandBuffer(</span><span style=\"color: #0000ff;\">void</span> *<span style=\"color: #000000;\">buffer, size_t buflen) {\n\n            ... ...\n\n            p.setData((uint8_t </span>*) buffer, buflen);                    <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 把接受到的数据填装到parcel </span><span style=\"color: #008000;\">*/</span>\n\n            <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> status checked at end</span>\n            status = p.readInt32(&amp;request);                           <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 解析request </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            status </span>= p.readInt32 (&amp;token);                            <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 解析token，RILJ中的serial </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            ... ...\n            \n                pRI </span>= (RequestInfo *)calloc(<span style=\"color: #800080;\">1</span>, <span style=\"color: #0000ff;\">sizeof</span>(RequestInfo));      <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 分配一个RequestInfo，用于发送请求给vendor ril </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            pRI</span>-&gt;token = token;                                       <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 设置token </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            pRI</span>-&gt;pCI = &amp;(s_commands[request]);                        <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 设置请求 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            ret </span>= pthread_mutex_lock(&amp;<span style=\"color: #000000;\">s_pendingRequestsMutex);\n            assert (ret </span>== <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">);\n\n            pRI</span>-&gt;p_next = s_pendingRequests;                          <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 添加到s_pendingRequests请求链表中 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n            s_pendingRequests </span>=<span style=\"color: #000000;\"> pRI;\n\n            ret </span>= pthread_mutex_unlock(&amp;<span style=\"color: #000000;\">s_pendingRequestsMutex);\n            assert (ret </span>== <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">);\n\n        </span><span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\">    sLastDispatchedToken = token; </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            pRI</span>-&gt;pCI-&gt;dispatchFunction(p, pRI);                       <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 执行事件回调，到这里开始进入vender ril了 </span><span style=\"color: #008000;\">*/</span>\n\n            <span style=\"color: #0000ff;\">return</span> <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">;\n        }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">我们仍然以获取SIM卡状态为例，pRI-&gt;pCI-&gt;dispatchFunction(p, pRI)对应调用了dispatchVoid()<br> <em>hardware/ril/libril/ril.cpp</em></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\">                                                                                                                                                  \n        dispatchVoid (Parcel</span>&amp; p, RequestInfo *<span style=\"color: #000000;\">pRI) {                                                                                                                 \n            clearPrintBuf;                                                                                                                                           \n            printRequest(pRI</span>-&gt;token, pRI-&gt;pCI-&gt;<span style=\"color: #000000;\">requestNumber);                                                                                                       \n            s_callbacks.onRequest(pRI</span>-&gt;pCI-&gt;requestNumber, NULL, <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">, pRI);                                                                                            \n        } </span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">&nbsp; &nbsp; &nbsp; &nbsp; s_callbacks.onRequest(pRI-&gt;pCI-&gt;requestNumber, NULL, 0, pRI); 调用的就是libreference-ril.c中的onRequest()函数。<br> <br>&nbsp; &nbsp; &nbsp; &nbsp; 以上分析了RILD对RILJ下发的请求处理流程，下面接着分析RILD返回response给RILJ的流程。分两种情况，一种对请求的响应，<br> 另一种是主动上报。<br>&nbsp; &nbsp; &nbsp; &nbsp; libreference-ril对请求处理完毕后，调用RIL_onRequestComplete回复RILJ该请求的处理结果。<br> <br> <em>hardware/ril/libril/ril.cpp</em></p> \n<div class=\"cnblogs_code\"> \n <pre>RIL_onRequestComplete(RIL_Token t, RIL_Errno e, <span style=\"color: #0000ff;\">void</span> *<span style=\"color: #000000;\">response, size_t responselen) {  \n          \n          ... ...\n                  p.writeInt32 (RESPONSE_SOLICITED);                                                                                                                   \n        p.writeInt32 (pRI</span>-&gt;<span style=\"color: #000000;\">token);\n        errorOffset </span>=<span style=\"color: #000000;\"> p.dataPosition();                                                                                                                      \n        \n        p.writeInt32 (e);                                                                                                                                    \n        \n        </span><span style=\"color: #0000ff;\">if</span> (response !=<span style=\"color: #000000;\"> NULL) {\n            </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> there is a response payload, no matter success or not.</span>\n            ret = pRI-&gt;pCI-&gt;<span style=\"color: #000000;\">responseFunction(p, response, responselen); \n            \n            ... ...\n        }\n        \n        ... ...\n      \n          sendResponse(p);\n          \n          ... ...\n      }\n      \n      </span><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\">\n        sendResponse (Parcel </span>&amp;<span style=\"color: #000000;\">p) {\n            printResponse;\n            </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> sendResponseRaw(p.data(), p.dataSize());\n        }\n\n    </span><span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\">\n        sendResponseRaw (</span><span style=\"color: #0000ff;\">const</span> <span style=\"color: #0000ff;\">void</span> *<span style=\"color: #000000;\">data, size_t dataSize) {\n            ... ...\n\n            ret </span>= blockingWrite(fd, (<span style=\"color: #0000ff;\">void</span> *)&amp;header, <span style=\"color: #0000ff;\">sizeof</span>(header));     <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 先写4字节数据长度 </span><span style=\"color: #008000;\">*/</span>\n\n            <span style=\"color: #0000ff;\">if</span> (ret &lt; <span style=\"color: #800080;\">0</span><span style=\"color: #000000;\">) {\n                pthread_mutex_unlock(</span>&amp;<span style=\"color: #000000;\">s_writeMutex);\n                </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> ret;\n            }\n\n            ret </span>= blockingWrite(fd, data, dataSize);                      <span style=\"color: #008000;\">/*</span><span style=\"color: #008000;\"> 再写数据 </span><span style=\"color: #008000;\">*/</span><span style=\"color: #000000;\">\n\n            ... ...\n        }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p style=\"margin-left: 30px;\">&nbsp; &nbsp; &nbsp; &nbsp; 最终是通过sendResponseRaw()直接通过写socket回复RILJ。对于主动上报的处理是类似的，也是通过sendResponseRaw()<br> 上报给RILJ。可以参考RIL_onUnsolicitedResponse()函数。<br> <br>&nbsp; &nbsp; &nbsp; &nbsp; 到此，RILJ与RILD之间的通信流程已经分析完，后续分析libreference-ril。libreference-ril中先关接口的实现方式，每个modem厂商都不一样。<br> BC72是通过串口/USB发送AT的方式控制，实现通话、短信、上网等功能。<br> </p> \n<p style=\"margin-left: 30px;\">&nbsp;</p> \n<p style=\"margin-left: 30px;\">谢谢！</p> \n<p>&nbsp;</p>', '    本文主要对android4.4 RIL的telephony与modem的命令交互流程进行分析，当然本文不是重点介绍telephony。telephony涉及具体业务逻辑内容比较多，包括sim、dail、sms、network等等，以后会针对这些内容学习分析。 \nRIL在Android体系中的位置： \n', '2019-10-17 17:37:02', 4, 5, 'Android 安卓 RIL', 'https://www.cnblogs.com/hackfun/p/11693444.html', 1, '2019-10-17 17:42:38');
INSERT INTO `t_blog` VALUES (251, 'Springboot2.x + ShardingSphere 实现分库分表', '<p>之前一篇文章中我们讲了基于Mysql8的读写分离(文末有链接)，这次来说说分库分表的实现过程。</p> \n<h2 id=\"概念解析\">概念解析</h2> \n<h3 id=\"垂直分片\">垂直分片</h3> \n<p>按照业务拆分的方式称为垂直分片，又称为纵向拆分，它的核心理念是专库专用。 在拆分之前，一个数据库由多个数据表构成，每个表对应着不同的业务。而拆分之后，则是按照业务将表进行归类，分布到不同的数据库中，从而将压力分散至不同的数据库。 下图展示了根据业务需要，将用户表和订单表垂直分片到不同的数据库的方案。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/9fa2aca0-fa84-42b6-8d31-c9b49bffe649.jpeg\" alt=\"file\"></p> \n<p>垂直分片往往需要对架构和设计进行调整。通常来讲，是来不及应对互联网业务需求快速变化的；而且，它也并无法真正的解决单点瓶颈。 垂直拆分可以缓解数据量和访问量带来的问题，但无法根治。如果垂直拆分之后，表中的数据量依然超过单节点所能承载的阈值，则需要水平分片来进一步处理。</p> \n<h3 id=\"水平分片\">水平分片</h3> \n<p>水平分片又称为横向拆分。 相对于垂直分片，它不再将数据根据业务逻辑分类，而是通过某个字段（或某几个字段），根据某种规则将数据分散至多个库或表中，每个分片仅包含数据的一部分。 例如：根据主键分片，偶数主键的记录放入0库（或表），奇数主键的记录放入1库（或表），如下图所示。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/c5212494-5a98-44e7-8252-c5937c1379fe.jpeg\" alt=\"file\"></p> \n<p>水平分片从理论上突破了单机数据量处理的瓶颈，并且扩展相对自由，是分库分表的标准解决方案。</p> \n<h2 id=\"开发准备\">开发准备</h2> \n<p>分库分表常用的组件就是shardingsphere，目前已经是apache顶级项目，这次我们使用springboot2.1.9 + shardingsphere4.0.0-RC2（均为最新版本）来完成分库分表的操作。</p> \n<p>假设有一张订单表，我们需要将它分成2个库，每个库三张表，根据id字段取模确定最终数据的位置，数据库环境配置如下：</p> \n<ul> \n <li>172.31.0.129 \n  <ul> \n   <li>blog \n    <ul> \n     <li>t_order_0</li> \n     <li>t_order_1</li> \n     <li>t_order_2</li> \n    </ul></li> \n  </ul></li> \n <li>172.31.0.131 \n  <ul> \n   <li>blog \n    <ul> \n     <li>t_order_0</li> \n     <li>t_order_1</li> \n     <li>t_order_2</li> \n    </ul></li> \n  </ul></li> \n</ul> \n<p>三张表的逻辑表为t_order，大家可以根据建表语句准备好其他所有数据表。</p> \n<pre class=\"sql\"><code>DROP TABLE IF EXISTS `t_order_0;\nCREATE TABLE `t_order_0` (\n  `id` bigint(20) NOT NULL,\n  `name` varchar(255) DEFAULT NULL COMMENT \'名称\',\n  `type` varchar(255) DEFAULT NULL COMMENT \'类型\',\n  `gmt_create` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \'创建时间\',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;</code></pre> \n<p><strong>注意，千万不能将主键的生成规则设置成自增长，需要按照一定规则来生成主键，这里使用shardingsphere中的SNOWFLAKE俗称雪花算法来生成主键</strong></p> \n<h2 id=\"代码实现\">代码实现</h2> \n<ul> \n <li>修改pom.xml,引入相关组件</li> \n</ul> \n<pre class=\"xml\"><code>&lt;properties&gt;\n        &lt;java.version&gt;1.8&lt;/java.version&gt;\n        &lt;mybatis-plus.version&gt;3.1.1&lt;/mybatis-plus.version&gt;\n        &lt;sharding-sphere.version&gt;4.0.0-RC2&lt;/sharding-sphere.version&gt;\n    &lt;/properties&gt;\n\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;\n            &lt;version&gt;2.0.1&lt;/version&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;mysql&lt;/groupId&gt;\n            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;\n            &lt;version&gt;8.0.15&lt;/version&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;\n            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;\n            &lt;version&gt;${mybatis-plus.version}&lt;/version&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;\n            &lt;artifactId&gt;sharding-jdbc-spring-boot-starter&lt;/artifactId&gt;\n            &lt;version&gt;${sharding-sphere.version}&lt;/version&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;\n            &lt;artifactId&gt;sharding-jdbc-spring-namespace&lt;/artifactId&gt;\n            &lt;version&gt;${sharding-sphere.version}&lt;/version&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n            &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n            &lt;optional&gt;true&lt;/optional&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n\n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;</code></pre> \n<ul> \n <li>配置mysql-plus</li> \n</ul> \n<pre><code>    @Configuration\n    @MapperScan(\"com.github.jianzh5.blog.mapper\")\n    public class MybatisPlusConfig {\n\n            /**\n             * 攻击 SQL 阻断解析器\n             */\n            @Bean\n            public PaginationInterceptor paginationInterceptor(){\n                    PaginationInterceptor paginationInterceptor = new PaginationInterceptor();\n                    List&lt;ISqlParser&gt; sqlParserList = new ArrayList&lt;&gt;();\n                    sqlParserList.add(new BlockAttackSqlParser());\n\n                    paginationInterceptor.setSqlParserList(sqlParserList);\n                    return new PaginationInterceptor();\n            }\n\n\n            /**\n             * SQL执行效率插件\n             */\n            @Bean\n            // @Profile({\"dev\",\"test\"})\n            public PerformanceInterceptor performanceInterceptor() {\n                    return new PerformanceInterceptor();\n            }\n    }</code></pre> \n<ul> \n <li>编写实体类Order</li> \n</ul> \n<pre><code>    @Data\n    @TableName(\"t_order\")\n    public class Order {\n            private Long id;\n\n            private String name;\n\n            private String type;\n\n            private Date gmtCreate;\n\n    }</code></pre> \n<ul> \n <li>编写DAO层,OrderMapper</li> \n</ul> \n<pre class=\"java\"><code>    /**\n     * 订单Dao层\n     */\n    public interface OrderMapper extends BaseMapper&lt;Order&gt; {\n\n    }</code></pre> \n<ul> \n <li>编写接口及接口实现</li> \n</ul> \n<pre class=\"java\"><code>    public interface OrderService extends IService&lt;Order&gt; {\n\n    }\n\n    /**\n     * 订单实现层\n     * @author jianzh5\n     * @date 2019/10/15 17:05\n     */\n    @Service\n    public class OrderServiceImpl extends ServiceImpl&lt;OrderMapper, Order&gt; implements OrderService {\n\n    }</code></pre> \n<ul> \n <li>配置文件（配置说明见备注）</li> \n</ul> \n<pre><code>    server.port=8080\n\n    # 配置ds0 和ds1两个数据源\n    spring.shardingsphere.datasource.names = ds0,ds1\n\n    #ds0 配置\n    spring.shardingsphere.datasource.ds0.type = com.zaxxer.hikari.HikariDataSource\n    spring.shardingsphere.datasource.ds0.driver-class-name = com.mysql.cj.jdbc.Driver\n    spring.shardingsphere.datasource.ds0.jdbc-url = jdbc:mysql://192.168.249.129:3306/blog?characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false\n    spring.shardingsphere.datasource.ds0.username = root\n    spring.shardingsphere.datasource.ds0.password = 000000\n\n    #ds1 配置\n    spring.shardingsphere.datasource.ds1.type = com.zaxxer.hikari.HikariDataSource\n    spring.shardingsphere.datasource.ds1.driver-class-name = com.mysql.cj.jdbc.Driver\n    spring.shardingsphere.datasource.ds1.jdbc-url = jdbc:mysql://192.168.249.131:3306/blog?characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false\n    spring.shardingsphere.datasource.ds1.username = root\n    spring.shardingsphere.datasource.ds1.password = 000000\n\n    # 分库策略 根据id取模确定数据进哪个数据库\n    spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column = id\n    spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression = ds$-&gt;{id % 2}\n\n    # 具体分表策略\n    # 节点 ds0.t_order_0,ds0.t_order_1,ds1.t_order_0,ds1.t_order_1\n    spring.shardingsphere.sharding.tables.t_order.actual-data-nodes = ds$-&gt;{0..1}.t_order_$-&gt;{0..2}\n    # 分表字段id\n    spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.sharding-column = id\n    # 分表策略 根据id取模,确定数据最终落在那个表中\n    spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.algorithm-expression = t_order_$-&gt;{id % 3}\n\n\n    # 使用SNOWFLAKE算法生成主键\n    spring.shardingsphere.sharding.tables.t_order.key-generator.column = id\n    spring.shardingsphere.sharding.tables.t_order.key-generator.type = SNOWFLAKE\n\n    #spring.shardingsphere.sharding.binding-tables=t_order\n\n    spring.shardingsphere.props.sql.show = true</code></pre> \n<ul> \n <li>编写单元测试，查看结果是否正确</li> \n</ul> \n<pre class=\"java\"><code>    public class OrderServiceImplTest extends BlogApplicationTests {\n        @Autowired\n        private OrderService orderService;\n\n\n        @Test\n        public void testSave(){\n            for (int i = 0 ; i&lt; 100 ; i++){\n                Order order = new Order();\n                order.setName(\"电脑\"+i);\n                order.setType(\"办公\");\n                orderService.save(order);\n            }\n        }\n\n        @Test\n        public void testGetById(){\n            long id = 1184489163202789377L;\n            Order order  = orderService.getById(id);\n            System.out.println(order.toString());\n        }\n    }</code></pre> \n<ul> \n <li><p>在数据表中查看数据，确认数据正常插入<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/0cc9c13c-ee51-4e76-99a1-248b313a6d70.jpeg\" alt=\"file\"></p></li> \n <li><p>至此分库分表开发完成</p></li> \n</ul> \n<p><strong>往期回顾</strong></p> \n<blockquote> \n <p><a href=\"https://mp.weixin.qq.com/s?__biz=Mzg3NjE0ODM2NA==&amp;mid=2247483762&amp;idx=1&amp;sn=330793a96c6ec09a05d41fec23c20d24&amp;chksm=cf37e291f8406b87e893714573b670f7b3d11f0b650b88f2b8507cff7b263162af05aa98e115&amp;scene=0&amp;xtrack=1&amp;key=2a4ff15fdd8463466a8a40f50f7a26d494172ee4c2f08a0e6b200e2a3b269af6c1edd17ef923adb9b39896c1d9653fcdf4d7601db5fff24ae4542b99baeed7aad4355bedcf0087a42791d3c2d21660ec&amp;ascene=1&amp;uin=MTQ4ODgxOTEyOA%3D%3D&amp;devicetype=Windows+10&amp;version=62070141&amp;lang=zh_CN&amp;pass_ticket=XIjojDGcywX0Q%2BkYQyTCcThNvN6IBG2diTO64EKVIwJ0STB%2ByfnOGvGfjJgRsIy4\">SpringBoot+Mysql8实现读写分离</a></p> \n</blockquote> \n<blockquote> \n <p>欢迎关注我的个人公众号：JAVA日知录</p> \n</blockquote>', NULL, '2019-10-17 17:37:03', 0, NULL, NULL, 'https://www.cnblogs.com/jianzh5/p/11693418.html', 0, NULL);
INSERT INTO `t_blog` VALUES (252, 'nextjs：如何将静态资源发布到 CDN', '<p>nextjs 是基于 react 的服务端同构指出框架，在使用的过程中也多多少少遇到过几个问题，其中最大的问题就是静态资源的发布了。</p> \n<h3 id=\"如何基于文件内容进行-hash-命名\">1. 如何基于文件内容进行 hash 命名</h3> \n<blockquote> \n <p>Next.js uses a constant generated at build time to identify which version of your application is being served. This can cause problems in multi-server deployments when next build is ran on every server. In order to keep a static build id between builds you can provide the generateBuildId function:</p> \n</blockquote> \n<p>按照官网上的说法，每次发布都会生成新的 hash 路径，即使当前没有任何的变动。例如某次发布的路径是<code>/_next/static/tZonUgEY-GPCEExGbFapL/pages/index.js</code>，那么下次的 hash 必然不是这个值。这样导致的一个问题是：如果在多台机器上发布并 build 时，会导致每次 build 产生的值不同。如果想固定某个值或者使用某个值，一个是可以先 build 完成后后再分发，或者，可以在<code>next.config.js</code>中自定义<code>generateBuildId</code>：</p> \n<pre class=\"javascript\"><code>// 来自官网上的例子\n// next.config.js\nmodule.exports = {\n    generateBuildId: async () =&gt; {\n        return \'my-build-id\';\n    }\n};</code></pre> \n<p>npm 上也有提供相应的安装包，可以使用当前 git 提交的 hash 值作为 buildId：<a href=\"https://www.npmjs.com/package/next-build-id\">next-build-id</a>。</p> \n<p>可是这种存在的一个问题就是：即使文件没有发生变动，或者我只修改了首页的代码，发布完成后，pages 下所有的资源都需要重新加载，有用户建议使用内容的 hash 值作为每个资源的路径，但官方好像好像不太情愿，说实现起来比较困难，详情可以看这个 issue: <a href=\"https://github.com/zeit/next.js/issues/6303\">use content hash in pages chunk name</a>。在这条 issue 中，有用户自己实现一个插件，不过我还没用过，有兴趣的同学可以尝试下。</p> \n<h3 id=\"路径的拼接规则\">2. 路径的拼接规则</h3> \n<p>静态资源上传到 CDN，这是存在目前存在的最大的问题，虽然在<code>next.config.js</code>中可以配置<code>assetPrefix</code>字段，但实际使用起来还是非常困难。</p> \n<p>打包后的 js 和 css，引用路由均为<code>/_next/static</code>开头：</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/f572093c-cc3b-4b5f-a22a-ed0bab285205.png\" alt=\"nextjs中静态资源上传到CDN\"></p> \n<p>如图片中所示，带有 data-next-page 属性的，实际上访问的是.next/server/static/[hash]/pages/_app.js；不带这个属性的，访问的路径是.next/static/runtime/webpack-[hash].js</p> \n<p>我们以 2019/09/16 提交的 nextjs 源码为例：<a href=\"https://github.com/zeit/next.js/blob/fe7c7342c7d6ba91c5802b01cf24b60da9f3d065/packages/next/pages/_document.tsx\">pages_document</a>，里面有全局脱水数据的注入，页面相关的 js 和静态资源的 js 的拼接：</p> \n<pre class=\"javascript\"><code>// 页面相关的js\n// assetPrefix为我们在next.config.js中配置的前缀\n// ${buildId}即为每次打包生成的hash值，在本地环境下值为development\n// _devOnlyInvalidateCacheQueryString: 变动的时间戳，正式环境中为空, _devOnlyInvalidateCacheQueryString: process.env.NODE_ENV !== \'production\' ? \'?ts=\' + Date.now() : \'\'\nsrc={assetPrefix + encodeURI(`/_next/static/${buildId}/pages${getPageFile(page)}`) + _devOnlyInvalidateCacheQueryString}\n\n// 静态资源的js\nsrc={`${assetPrefix}/_next/${file}${_devOnlyInvalidateCacheQueryString}`}</code></pre> \n<p>全局脱水数据的注入</p> \n<pre class=\"jsx\"><code>&lt;script\n    id=\"__NEXT_DATA__\"\n    type=\"application/json\"\n    nonce={this.props.nonce}\n    crossOrigin={this.props.crossOrigin || process.crossOrigin}\n    dangerouslySetInnerHTML={{\n        __html: NextScript.getInlineScriptSource(this.context._documentProps)\n    }}\n    data-ampdevmode\n/&gt;</code></pre> \n<p>上面的页面编译后的路径是<code>.next/server/static/{hash}/pages/_document.js</code>，这些 js 读取的路径是分别由 2 个 json 文件控制的。</p> \n<ul> \n <li><code>sever/pages-manifest.json</code>：加载页面相关的 js，nextjs 是服务端渲染+客户端渲染两种方式，刷新页面时使用的服务端渲染（使用<code>server/static/{hash}/pages/</code>中的文件），切换路由时使用的是客户端渲染（使用<code>static/{hash}/pages/</code>中的文件），这里加载的 js，是用于在路由切换时使用客户端渲染的方式；</li> \n <li><code>static/build-manifest.json</code>：加载静态资源的 js，使用<code>static/</code>里除 hash 路径外的资源；</li> \n</ul> \n<p>我们了解这些，主要是为了理解 js 的路径是怎样拼接完成的。</p> \n<h3 id=\"如何发布静态资源到-cdn\">3. 如何发布静态资源到 CDN</h3> \n<p>静态资源发布到 CDN 其实很简单，只要把<code>.next/static</code>下目录的资源上传上去即可。最困难的是如何替换代码中的路径。把这个目录下的静态文件上传到 CDN 后，生成的地址会变成：</p> \n<pre class=\"html\"><code>&lt;!-- 假设我们的CDN地址是 http://static.qq.com --&gt;\n&lt;script src=\"http://static.qq.com/runtime/webpack-4b444dab214c6491079c.js\"&gt;&lt;/script&gt;</code></pre> \n<p>从第 2 部分中能看到，代码中使用<code>assetPrefix</code>作为静态资源的前缀时，只是单纯的拼接到了最前面而已，拼接后的地址是：</p> \n<pre class=\"html\"><code>&lt;script src=\"http://static.qq.com/_next/static/runtime/webpack-4b444dab214c6491079c.js\"&gt;&lt;/script&gt;</code></pre> \n<p>中间多出了<code>/_next/static</code>的路径，最后的结果是页面需要加载的资源和上传的资源路径不一致，就会各种 404。这里我的解决方案很简单粗暴，读取编译后的文件，然后执行 node 程序，将里面的字符替换掉：</p> \n<pre class=\"javascript\"><code>const fs = require(\'fs\');\n\n// 获取文件夹中所有的文件\nfunction readDirAll(path) {\n    // 获取字符串的最后一个字符\n    var getLastCode = function(str) {\n        return str.substr(str.length - 1, 1);\n    };\n\n    var result = []; // 存储获取到的文件\n    var stats = fs.statSync(path); // 获取当前文件的状态\n    if (stats.isFile()) {\n        result.push(path);\n    } else if (stats.isDirectory()) {\n        // 若当前路径是文件夹，则获取路径下所有的信息，并循环\n        var files = fs.readdirSync(path);\n\n        for (var i = 0, len = files.length; i &lt; len; i++) {\n            var item = files[i],\n                itempath =\n                    getLastCode(path) == \'/\' ? path + item : path + \'/\' + item; // 拼接路径\n            var st = fs.statSync(itempath);\n\n            if (st.isFile()) {\n                result.push(itempath);\n            } else if (st.isDirectory() &amp;&amp; item !== \'cache\') {\n                // 当前是文件夹，则递归检索，将递归获取到的文件列表与当前result进行拼接\n                var s = readDirAll(itempath);\n                result = result.concat(s);\n            }\n        }\n    }\n    return result;\n}\n\nconst list = readDirAll(\'.next\');\n\nlist.forEach(file =&gt; {\n    let data = fs.readFileSync(file, \'utf8\');\n\n    if (file.indexOf(\'_document.js\') &gt; -1) {\n        data = data\n            .replace(/\\/_next\\//g, \'/\')\n            .replace(/static\\/\" \\+ buildId/g, \'\" + buildId\');\n        fs.writeFileSync(file, data);\n        console.log(file, \'success\');\n    } else if (file.indexOf(\'build-manifest.json\') &gt; -1) {\n        data = data.replace(/static\\//g, \'\');\n        fs.writeFileSync(file, data);\n        console.log(file, \'success\');\n    } else if (data.indexOf(\'/_next/static\') &gt; -1) {\n        data = data.replace(/\\/_next\\/static\\//g, \'/\');\n        fs.writeFileSync(file, data);\n        console.log(file, \'success\');\n    }\n});</code></pre> \n<p>这样就能就可以保证项目的 CDN 地址和真正上传的地址是一致的了。</p> \n<p>欢迎访问蚊子的前端博客： <a href=\"https://www.xiabingbao.com\" class=\"uri\">https://www.xiabingbao.com</a><br> 欢迎关注蚊子的公众号：<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/25920a07-5bc8-422f-a19b-e88e2f54ed36.png\" alt=\"蚊子的前端公众号\"></p>', NULL, '2019-10-17 17:37:05', 0, NULL, NULL, 'https://www.cnblogs.com/xumengxuan/p/11693381.html', 0, NULL);
INSERT INTO `t_blog` VALUES (253, 'Elasticsearch Java API 很全的整理', '<p>Elasticsearch 的API 分为 REST Client API（http请求形式）以及 transportClient API两种。相比来说transportClient API效率更高，transportClient 是通过Elasticsearch内部RPC的形式进行请求的，连接可以是一个长连接，相当于是把客户端的请求当成</p> \n<p>Elasticsearch 集群的一个节点。但是从Elasticsearch 7 后就会移除transportClient 。主要原因是transportClient 难以向下兼容版本。</p> \n<p>本文中所有的讲解和操作都是基于jdk 1.8 和elasticsearch 6.2.4版本。</p> \n<p><em>备注：本文参考了很多Elasticsearch 的官方文档以及部l网络资料做的综合整理。</em></p> \n<p><strong><span style=\"font-size: 18pt;\">一、High REST Client</span></strong></p> \n<p>High Client 基于 Low Client， 主要目的是暴露一些 API，这些 API 可以接受请求对象为参数，返回响应对象，而对请求和响应细节的处理都是由 client 自动完成的。</p> \n<p>API 在调用时都可以是同步或者异步两种形式<br>同步 API 会导致阻塞，一直等待数据返回<br>异步 API 在命名上会加上 async 后缀，需要有一个 listener 作为参数，等这个请求返回结果或者发生错误时，这个 listener 就会被调用，listener主要是解决自动回调的问题，有点像安卓 开发里面的listener监听回调。</p> \n<p>Elasticsearch REST APi 官方 地址：https://www.elastic.co/guide/en/elasticsearch/reference/6.2/index.html</p> \n<p><strong>Maven 依赖</strong></p> \n<p> &lt;dependency&gt;<br> &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;<br> &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt;<br> &lt;version&gt;6.2.4&lt;/version&gt;<br> &lt;/dependency&gt;<br> &lt;dependency&gt;<br> &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;<br> &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;<br> &lt;version&gt;6.2.4&lt;/version&gt;<br> &lt;/dependency&gt;</p> \n<p><span style=\"font-size: 15px;\"><strong>client初始化：</strong></span></p> \n<p><span style=\"font-size: 12px;\"><strong>RestHighLevelClient 实例依赖 REST low-level client builder</strong></span></p> \n<div class=\"cnblogs_code\"> \n <pre>public class ElasticSearchClient {<br>    private String[] hostsAndPorts;<br><br>    public ElasticSearchClient(String[] hostsAndPorts) {<br>        this.hostsAndPorts = hostsAndPorts;<br>    }</pre> \n <pre><span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> RestHighLevelClient getClient() {\n        RestHighLevelClient client </span>= <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\n        List</span>&lt;HttpHost&gt; httpHosts = <span style=\"color: #0000ff;\">new</span> ArrayList&lt;HttpHost&gt;<span style=\"color: #000000;\">();\n        </span><span style=\"color: #0000ff;\">if</span> (hostsAndPorts.length &gt; 0<span style=\"color: #000000;\">) {\n            </span><span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (String hostsAndPort : hostsAndPorts) {\n                String[] hp </span>= hostsAndPort.split(\":\"<span style=\"color: #000000;\">);\n                httpHosts.add(</span><span style=\"color: #0000ff;\">new</span> HttpHost(hp[0], Integer.valueOf(hp[1]), \"http\"<span style=\"color: #000000;\">));\n            }\n            client </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> RestHighLevelClient(\n                    RestClient.builder(httpHosts.toArray(</span><span style=\"color: #0000ff;\">new</span> HttpHost[0<span style=\"color: #000000;\">])));\n        } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n            client </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> RestHighLevelClient(\n                    RestClient.builder(</span><span style=\"color: #0000ff;\">new</span> HttpHost(\"127.0.0.1\", 9200, \"http\"<span style=\"color: #000000;\">)));\n        }\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> client;\n    }<br>}</span></pre> \n</div> \n<p>&nbsp;</p> \n<p><strong>文档 API（High level rest 客户端支持下面的 文档(Document) API）：</strong></p> \n<ul> \n <li>单文档 API：</li> \n <li>index API</li> \n <li>Get API</li> \n <li>Delete API</li> \n <li>Update API</li> \n <li>多文档 API：</li> \n <li>Bulk API</li> \n <li>Multi-Get API</li> \n</ul> \n<p><strong>1、Index API：</strong><br><strong>IndexRequest：</strong><br>封装好的参考方法：</p> \n<div class=\"cnblogs_Highlighter\"> \n <pre class=\"brush:java;gutter:true;\">private IndexRequest getIndexRequest(String index, String indexType, String docId, Map&lt;String, Object&gt; dataMap) {\n        IndexRequest indexRequest = null;\n        if (null == index || null == indexType) {\n            throw new ElasticsearchException(\"index or indexType must not be null\");\n        }\n        if (null == docId) {\n            indexRequest = new IndexRequest(index, indexType);\n        } else {\n            indexRequest = new IndexRequest(index, indexType, docId);\n        }\n        return indexRequest;\n    }\n\n    /**\n     * 同步执行索引\n     *\n     * @param index\n     * @param indexType\n     * @param docId\n     * @param dataMap\n     * @throws IOException\n     */\n    public IndexResponse execIndex(String index, String indexType, String docId, Map&lt;String, Object&gt; dataMap) throws IOException {\n        return getClient().index(getIndexRequest(index, indexType, docId, dataMap).source(dataMap));\n    }\n\n    /**\n     * 异步执行\n     *\n     * @param index\n     * @param indexType\n     * @param docId\n     * @param dataMap\n     * @param indexResponseActionListener\n     * @throws IOException\n     */\n    public void asyncExecIndex(String index, String indexType, String docId, Map&lt;String, Object&gt; dataMap, ActionListener&lt;IndexResponse&gt; indexResponseActionListener) throws IOException {\n        getClient().indexAsync(getIndexRequest(index, indexType, docId, dataMap).source(dataMap), indexResponseActionListener);\n    }\n</pre> \n</div> \n<p><strong>API解释：　</strong>　</p> \n<p>&nbsp;</p> \n<div class=\"cnblogs_code\"> \n <pre>IndexRequest request = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> IndexRequest(\n        </span>\"posts\",  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 索引 Index</span>\n        \"doc\",  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Type </span>\n        \"1\");  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 文档 Document Id </span>\nString jsonString = \"{\" +\n        \"\\\"user\\\":\\\"kimchy\\\",\" +\n        \"\\\"postDate\\\":\\\"2013-01-30\\\",\" +\n        \"\\\"message\\\":\\\"trying out Elasticsearch\\\"\" +\n        \"}\"<span style=\"color: #000000;\">;\nrequest.source(jsonString, XContentType.JSON); </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 文档源格式为 json string</span></pre> \n</div> \n<p><strong>Document Source</strong><br><strong>document source 可以是下面的格式</strong></p> \n<p>Map类型的输入：</p> \n<div class=\"cnblogs_code\"> \n <pre>Map&lt;String, Object&gt; jsonMap = <span style=\"color: #0000ff;\">new</span> HashMap&lt;&gt;<span style=\"color: #000000;\">();\njsonMap.put(</span>\"user\", \"kimchy\"<span style=\"color: #000000;\">);\njsonMap.put(</span>\"postDate\", <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Date());\njsonMap.put(</span>\"message\", \"trying out Elasticsearch\"<span style=\"color: #000000;\">);\nIndexRequest indexRequest </span>= <span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">)\n        .source(jsonMap);  </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 会自动将 Map 转换为 JSON 格式</span></pre> \n</div> \n<p>XContentBuilder : 这是 Document Source 提供的帮助类，专门用来产生 json 格式的数据：</p> \n<div class=\"cnblogs_code\"> \n <pre>XContentBuilder builder =<span style=\"color: #000000;\"> XContentFactory.jsonBuilder();\nbuilder.startObject();\n{\n    builder.field(</span>\"user\", \"kimchy\"<span style=\"color: #000000;\">);\n    builder.timeField(</span>\"postDate\", <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Date());\n    builder.field(</span>\"message\", \"trying out Elasticsearch\"<span style=\"color: #000000;\">);\n}\nbuilder.endObject();\nIndexRequest indexRequest </span>= <span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">)\n        .source(builder);</span></pre> \n</div> \n<p>Object 键对：</p> \n<div class=\"cnblogs_code\"> \n <pre>IndexRequest indexRequest = <span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">)\n        .source(</span>\"user\", \"kimchy\"<span style=\"color: #000000;\">,\n                </span>\"postDate\", <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Date(),\n                </span>\"message\", \"trying out Elasticsearch\"); </pre> \n</div> \n<p>同步索引：</p> \n<div class=\"cnblogs_code\"> \n <pre>IndexResponse indexResponse = client.index(request);</pre> \n</div> \n<p>异步索引：异步执行函数需要添加 listener, 而对于 index 而言，这个 listener 的类型就是 ActionListener</p> \n<div class=\"cnblogs_code\"> \n <pre>client.indexAsync(request, listener); </pre> \n</div> \n<p>异步方法执行后会立刻返回，在索引操作执行完成后，ActionListener 就会被回调:</p> \n<p>执行成功，调用 onResponse 函数<br>执行失败，调用 onFailure 函数</p> \n<div class=\"cnblogs_code\"> \n <pre>ActionListener&lt;IndexResponse&gt; listener = <span style=\"color: #0000ff;\">new</span> ActionListener&lt;IndexResponse&gt;<span style=\"color: #000000;\">() {\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onResponse(IndexResponse indexResponse) {\n        \n    }\n\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onFailure(Exception e) {\n        \n    }\n};</span></pre> \n</div> \n<p>IndexResponse：<br>不管是同步回调还是异步回调，如果调用成功，都会返回 IndexRespose 对象。&nbsp;</p> \n<div class=\"cnblogs_code\"> \n <pre>String index =<span style=\"color: #000000;\"> indexResponse.getIndex();\nString type </span>=<span style=\"color: #000000;\"> indexResponse.getType();\nString id </span>=<span style=\"color: #000000;\"> indexResponse.getId();\n</span><span style=\"color: #0000ff;\">long</span> version =<span style=\"color: #000000;\"> indexResponse.getVersion();\n</span><span style=\"color: #0000ff;\">if</span> (indexResponse.getResult() ==<span style=\"color: #000000;\"> DocWriteResponse.Result.CREATED) {\n   </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 文档第一次创建 </span>\n} <span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (indexResponse.getResult() ==<span style=\"color: #000000;\"> DocWriteResponse.Result.UPDATED) {\n   </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 文档之前已存在，当前是重写</span>\n<span style=\"color: #000000;\">}\nReplicationResponse.ShardInfo shardInfo </span>=<span style=\"color: #000000;\"> indexResponse.getShardInfo();\n</span><span style=\"color: #0000ff;\">if</span> (shardInfo.getTotal() !=<span style=\"color: #000000;\"> shardInfo.getSuccessful()) {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 成功的分片数量少于总分片数量 </span>\n<span style=\"color: #000000;\">}\n</span><span style=\"color: #0000ff;\">if</span> (shardInfo.getFailed() &gt; 0<span style=\"color: #000000;\">) {\n    </span><span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (ReplicationResponse.ShardInfo.Failure failure : shardInfo.getFailures()) {\n        String reason </span>= failure.reason();  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 处理潜在的失败信息</span>\n<span style=\"color: #000000;\">    }\n}</span></pre> \n</div> \n<p>在索引时有版本冲突的话，会抛出 ElasticsearchException</p> \n<div class=\"cnblogs_code\"> \n <pre>IndexRequest request = <span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">)\n        .source(</span>\"field\", \"value\"<span style=\"color: #000000;\">)\n        .version(</span>1); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 这里是文档版本号</span>\n<span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\n    IndexResponse response </span>=<span style=\"color: #000000;\"> client.index(request);\n} </span><span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\">(ElasticsearchException e) {\n    </span><span style=\"color: #0000ff;\">if</span> (e.status() ==<span style=\"color: #000000;\"> RestStatus.CONFLICT) {\n       </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 冲突了 </span>\n<span style=\"color: #000000;\">    }\n}</span></pre> \n</div> \n<p>如果将 opType 设置为 create, 而且如果索引的文档与已存在的文档在 index, type 和 id 上均相同，也会抛出冲突异常。</p> \n<div class=\"cnblogs_code\"> \n <pre>IndexRequest request = <span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">)\n        .source(</span>\"field\", \"value\"<span style=\"color: #000000;\">)\n        .opType(DocWriteRequest.OpType.CREATE);\n</span><span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\n    IndexResponse response </span>=<span style=\"color: #000000;\"> client.index(request);\n} </span><span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\">(ElasticsearchException e) {\n    </span><span style=\"color: #0000ff;\">if</span> (e.status() ==<span style=\"color: #000000;\"> RestStatus.CONFLICT) {\n        \n    }\n}</span></pre> \n</div> \n<p><strong>2、GET API</strong><br><strong>GET 请求</strong><br>每个 GET 请求都必须需传入下面 3 个参数：</p> \n<ul> \n <li>Index</li> \n <li>Type</li> \n <li>Document id</li> \n</ul> \n<div class=\"cnblogs_code\"> \n <pre>GetRequest getRequest = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> GetRequest(\n        </span>\"posts\"<span style=\"color: #000000;\">, \n        </span>\"doc\"<span style=\"color: #000000;\">,  \n        </span>\"1\");  </pre> \n</div> \n<p>可选参数<br>下面的参数都是可选的, 里面的选项并不完整，如要获取完整的属性，请参考 官方文档</p> \n<p>不获取源数据，默认是获取的</p> \n<div class=\"cnblogs_code\"> \n <pre>request.fetchSourceContext(FetchSourceContext.DO_NOT_FETCH_SOURCE); </pre> \n</div> \n<p>配置返回数据中包含指定字段</p> \n<div class=\"cnblogs_code\"> \n <pre>String[] includes = <span style=\"color: #0000ff;\">new</span> String[]{\"message\", \"*Date\"<span style=\"color: #000000;\">};\nString[] excludes </span>=<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\nFetchSourceContext fetchSourceContext </span>=\n        <span style=\"color: #0000ff;\">new</span> FetchSourceContext(<span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">, includes, excludes);\nrequest.fetchSourceContext(fetchSourceContext); </span></pre> \n</div> \n<p>配置返回数据中排除指定字段</p> \n<div class=\"cnblogs_code\"> \n <pre>String[] includes =<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\nString[] excludes </span>= <span style=\"color: #0000ff;\">new</span> String[]{\"message\"<span style=\"color: #000000;\">};\nFetchSourceContext fetchSourceContext </span>=\n        <span style=\"color: #0000ff;\">new</span> FetchSourceContext(<span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">, includes, excludes);\nrequest.fetchSourceContext(fetchSourceContext); </span></pre> \n</div> \n<p>实时 默认为 true</p> \n<div class=\"cnblogs_code\"> \n <pre>request.realtime(<span style=\"color: #0000ff;\">false</span>);</pre> \n</div> \n<p>版本</p> \n<div class=\"cnblogs_code\"> \n <pre>request.version(2); </pre> \n</div> \n<p>版本类型</p> \n<div class=\"cnblogs_code\"> \n <pre>request.versionType(VersionType.EXTERNAL);</pre> \n</div> \n<p>同步执行</p> \n<div class=\"cnblogs_code\"> \n <pre>GetResponse getResponse = client.get(getRequest);</pre> \n</div> \n<p>异步执行<br>此部分与 index 相似, 只有一点不同， 返回类型为 GetResponse</p> \n<p><strong>Get Response</strong><br>返回的 GetResponse 对象包含要请求的文档数据（包含元数据和字段）</p> \n<p>&nbsp;</p> \n<div class=\"cnblogs_code\"> \n <pre>String index =<span style=\"color: #000000;\"> getResponse.getIndex();\nString type </span>=<span style=\"color: #000000;\"> getResponse.getType();\nString id </span>=<span style=\"color: #000000;\"> getResponse.getId();\n</span><span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (getResponse.isExists()) {\n    </span><span style=\"color: #0000ff;\">long</span> version =<span style=\"color: #000000;\"> getResponse.getVersion();\n    String sourceAsString </span>= getResponse.getSourceAsString(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> string 形式   </span>\n    Map&lt;String, Object&gt; sourceAsMap = getResponse.getSourceAsMap(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> map </span>\n    <span style=\"color: #0000ff;\">byte</span>[] sourceAsBytes = getResponse.getSourceAsBytes(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 字节形式 </span>\n} <span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n   </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 没有发现请求的文档 </span>\n}</pre> \n</div> \n<p>在请求中如果包含特定的文档版本，如果与已存在的文档版本不匹配, 就会出现冲突</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\n    GetRequest request </span>= <span style=\"color: #0000ff;\">new</span> GetRequest(\"posts\", \"doc\", \"1\").version(2<span style=\"color: #000000;\">);\n    GetResponse getResponse </span>=<span style=\"color: #000000;\"> client.get(request);\n} </span><span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\"> (ElasticsearchException exception) {\n    </span><span style=\"color: #0000ff;\">if</span> (exception.status() ==<span style=\"color: #000000;\"> RestStatus.CONFLICT) {\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 版本冲突        </span>\n<span style=\"color: #000000;\">    }\n}</span></pre> \n</div> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #000000;\">封装好的参考方法：\n  </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> includes  返回需要包含的字段，可以传入空\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> excludes  返回需要不包含的字段，可以传入为空\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> excludes  version\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> excludes  versionType\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n\n    <span style=\"color: #0000ff;\">public</span> GetResponse getRequest(String index, String indexType, String docId, String[] includes, String[] excludes, Integer version, VersionType versionType) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> == includes || includes.length == 0<span style=\"color: #000000;\">) {\n            includes </span>=<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> == excludes || excludes.length == 0<span style=\"color: #000000;\">) {\n            excludes </span>=<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\n        }\n        GetRequest getRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> GetRequest(index, indexType, docId);\n        FetchSourceContext fetchSourceContext </span>= <span style=\"color: #0000ff;\">new</span> FetchSourceContext(<span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">, includes, excludes);\n        getRequest.realtime(</span><span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">);\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> version) {\n            getRequest.version(version);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> versionType) {\n            getRequest.versionType(versionType);\n        }\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().get(getRequest.fetchSourceContext(fetchSourceContext));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> includes\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> excludes\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n\n    <span style=\"color: #0000ff;\">public</span> GetResponse getRequest(String index, String indexType, String docId, String[] includes, String[] excludes) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span> getRequest(index, indexType, docId, includes, excludes, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> GetResponse getRequest(String index, String indexType, String docId) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        GetRequest getRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> GetRequest(index, indexType, docId);\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().get(getRequest);\n    }</span></pre> \n</div> \n<p><strong>3、Exists API</strong></p> \n<p>如果文档存在 Exists API 返回 true, 否则返回 fasle。</p> \n<p><strong>Exists Request</strong></p> \n<p>GetRequest 用法和 Get API 差不多，两个对象的可选参数是相同的。由于 exists() 方法只返回 true 或者 false， 建议将获取 _source 以及任何存储字段的值关闭，尽量使请求轻量级。</p> \n<div class=\"cnblogs_code\"> \n <pre>GetRequest getRequest = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> GetRequest(\n    </span>\"posts\",  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Index</span>\n    \"doc\",    <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Type</span>\n    \"1\");     <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Document id</span>\ngetRequest.fetchSourceContext(<span style=\"color: #0000ff;\">new</span> FetchSourceContext(<span style=\"color: #0000ff;\">false</span>));  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 禁用 _source 字段</span>\ngetRequest.storedFields(\"_none_\"); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 禁止存储任何字段   </span></pre> \n</div> \n<p>同步请求</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">boolean</span> exists = client.exists(getRequest);</pre> \n</div> \n<p>异步请求<br>异步请求与 Index API 相似，此处不赘述，只粘贴代码。如需详细了解，请参阅官方地址</p> \n<div class=\"cnblogs_code\"> \n <pre>ActionListener&lt;Boolean&gt; listener = <span style=\"color: #0000ff;\">new</span> ActionListener&lt;Boolean&gt;<span style=\"color: #000000;\">() {\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onResponse(Boolean exists) {\n        \n    }\n\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onFailure(Exception e) {\n        \n    }\n};\n\nclient.existsAsync(getRequest, listener); </span></pre> \n</div> \n<p>封装的参考方法：</p> \n<div class=\"cnblogs_code\"> \n <pre>   <span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> Boolean existDoc(String index, String indexType, String docId) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        GetRequest getRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> GetRequest(index, indexType, docId);\n        getRequest.fetchSourceContext(</span><span style=\"color: #0000ff;\">new</span> FetchSourceContext(<span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">));\n        getRequest.storedFields(</span>\"_none_\"<span style=\"color: #000000;\">);\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().exists(getRequest);\n    }</span></pre> \n</div> \n<p><strong>4、Delete API</strong></p> \n<p><strong>Delete Request</strong><br>DeleteRequest 必须传入下面参数</p> \n<div class=\"cnblogs_code\"> \n <pre>DeleteRequest request = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> DeleteRequest(\n        </span>\"posts\",   <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> index </span>\n        \"doc\",     <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> doc</span>\n        \"1\");      <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> document id</span></pre> \n</div> \n<p>可选参数<br>超时时间</p> \n<div class=\"cnblogs_code\"> \n <pre>request.timeout(TimeValue.timeValueMinutes(2<span style=\"color: #000000;\">)); \nrequest.timeout(</span>\"2m\"); </pre> \n</div> \n<p>刷新策略</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #000000;\">request.setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL); \nrequest.setRefreshPolicy(</span>\"wait_for\");    </pre> \n</div> \n<p>版本</p> \n<div class=\"cnblogs_code\"> \n <pre>request.version(2); </pre> \n</div> \n<p>版本类型</p> \n<div class=\"cnblogs_code\"> \n <pre>request.versionType(VersionType.EXTERNAL); </pre> \n</div> \n<div class=\"cnblogs_code\"> \n <pre>同步执行<br>DeleteResponse deleteResponse = client.delete(request);</pre> \n</div> \n<p>异步执行</p> \n<div class=\"cnblogs_code\"> \n <pre>ActionListener&lt;DeleteResponse&gt; listener = <span style=\"color: #0000ff;\">new</span> ActionListener&lt;DeleteResponse&gt;<span style=\"color: #000000;\">() {\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onResponse(DeleteResponse deleteResponse) {\n        \n    }\n\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onFailure(Exception e) {\n        \n    }\n};<br></span></pre> \n <p><br>client.deleteAsync(request, listener);<br>Delete Response</p> \n <pre><span style=\"color: #000000;\">&nbsp;</span></pre> \n</div> \n<p>DeleteResponse 可以检索执行操作的信息</p> \n<div class=\"cnblogs_code\"> \n <pre>String index =<span style=\"color: #000000;\"> deleteResponse.getIndex();\nString type </span>=<span style=\"color: #000000;\"> deleteResponse.getType();\nString id </span>=<span style=\"color: #000000;\"> deleteResponse.getId();\n</span><span style=\"color: #0000ff;\">long</span> version =<span style=\"color: #000000;\"> deleteResponse.getVersion();\nReplicationResponse.ShardInfo shardInfo </span>=<span style=\"color: #000000;\"> deleteResponse.getShardInfo();\n</span><span style=\"color: #0000ff;\">if</span> (shardInfo.getTotal() !=<span style=\"color: #000000;\"> shardInfo.getSuccessful()) {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 成功分片数目小于总分片</span>\n<span style=\"color: #000000;\">}\n</span><span style=\"color: #0000ff;\">if</span> (shardInfo.getFailed() &gt; 0<span style=\"color: #000000;\">) {\n    </span><span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (ReplicationResponse.ShardInfo.Failure failure : shardInfo.getFailures()) {\n        String reason </span>= failure.reason(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 处理潜在失败</span>\n<span style=\"color: #000000;\">    }\n}</span></pre> \n</div> \n<p>也可以来检查文档是否存在</p> \n<div class=\"cnblogs_code\"> \n <pre>DeleteRequest request = <span style=\"color: #0000ff;\">new</span> DeleteRequest(\"posts\", \"doc\", \"does_not_exist\"<span style=\"color: #000000;\">);\nDeleteResponse deleteResponse </span>=<span style=\"color: #000000;\"> client.delete(request);\n</span><span style=\"color: #0000ff;\">if</span> (deleteResponse.getResult() ==<span style=\"color: #000000;\"> DocWriteResponse.Result.NOT_FOUND) {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 文档不存在</span>\n<span style=\"color: #000000;\">}\n版本冲突时也会抛出 `ElasticsearchException\n\n</span><span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\n    DeleteRequest request </span>= <span style=\"color: #0000ff;\">new</span> DeleteRequest(\"posts\", \"doc\", \"1\").version(2<span style=\"color: #000000;\">);\n    DeleteResponse deleteResponse </span>=<span style=\"color: #000000;\"> client.delete(request);\n} </span><span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\"> (ElasticsearchException exception) {\n    </span><span style=\"color: #0000ff;\">if</span> (exception.status() ==<span style=\"color: #000000;\"> RestStatus.CONFLICT) {\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 版本冲突</span>\n<span style=\"color: #000000;\">    }\n}</span></pre> \n</div> \n<p>封装好的参考方法：</p> \n<div class=\"cnblogs_code\"> \n <pre>  <span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> timeValue\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> refreshPolicy\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> version\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> versionType\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> DeleteResponse deleteDoc(String index, String indexType, String docId, TimeValue timeValue, WriteRequest.RefreshPolicy refreshPolicy, Integer version, VersionType versionType) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        DeleteRequest deleteRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> DeleteRequest(index, indexType, docId);\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> timeValue) {\n            deleteRequest.timeout(timeValue);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> refreshPolicy) {\n            deleteRequest.setRefreshPolicy(refreshPolicy);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> version) {\n            deleteRequest.version(version);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> versionType) {\n            deleteRequest.versionType(versionType);\n        }\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().delete(deleteRequest);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> DeleteResponse deleteDoc(String index, String indexType, String docId) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span> deleteDoc(index, indexType, docId, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n    }</span></pre> \n</div> \n<p><strong>5、Update API</strong></p> \n<p><strong>Update Request</strong><em id=\"__mceDel\"><br></em>UpdateRequest 的必需参数如下</p> \n<div class=\"cnblogs_code\"> \n <pre>UpdateRequest request = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> UpdateRequest(\n        </span>\"posts\",  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> Index</span>\n        \"doc\",  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 类型</span>\n        \"1\");   <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 文档 Id</span></pre> \n</div> \n<p><strong>使用脚本更新</strong></p> \n<p>部分文档更新：<br>在更新部分文档时，已存在文档与部分文档会合并。</p> \n<p>部分文档可以有以下形式：</p> \n<p>JSON 格式：</p> \n<div class=\"cnblogs_code\"> \n <pre>UpdateRequest request = <span style=\"color: #0000ff;\">new</span> UpdateRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">);\nString jsonString </span>= \"{\" +\n        \"\\\"updated\\\":\\\"2017-01-01\\\",\" +\n        \"\\\"reason\\\":\\\"daily update\\\"\" +\n        \"}\"<span style=\"color: #000000;\">;\nrequest.doc(jsonString, XContentType.JSON); </span></pre> \n</div> \n<p>Map 格式：</p> \n<div class=\"cnblogs_code\"> \n <pre>Map&lt;String, Object&gt; jsonMap = <span style=\"color: #0000ff;\">new</span> HashMap&lt;&gt;<span style=\"color: #000000;\">();\njsonMap.put(</span>\"updated\", <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Date());\njsonMap.put(</span>\"reason\", \"daily update\"<span style=\"color: #000000;\">);\nUpdateRequest request </span>= <span style=\"color: #0000ff;\">new</span> UpdateRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">)\n        .doc(jsonMap); </span></pre> \n</div> \n<p>XContentBuilder 对象：</p> \n<div class=\"cnblogs_code\"> \n <pre>XContentBuilder builder =<span style=\"color: #000000;\"> XContentFactory.jsonBuilder();\nbuilder.startObject();\n{\n    builder.timeField(</span>\"updated\", <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Date());\n    builder.field(</span>\"reason\", \"daily update\"<span style=\"color: #000000;\">);\n}\nbuilder.endObject();\nUpdateRequest request </span>= <span style=\"color: #0000ff;\">new</span> UpdateRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">)\n        .doc(builder);  \nObject key</span>-<span style=\"color: #000000;\">pairs\n\nUpdateRequest request </span>= <span style=\"color: #0000ff;\">new</span> UpdateRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">)\n        .doc(</span>\"updated\", <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Date(),\n             </span>\"reason\", \"daily update\"); </pre> \n</div> \n<p>Upserts：如果文档不存在，可以使用 upserts 方法将文档以新文档的方式创建。</p> \n<div class=\"cnblogs_code\"> \n <pre>UpdateRequest request = <span style=\"color: #0000ff;\">new</span> UpdateRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">)\n        .doc(</span>\"updated\", <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Date(),\n             </span>\"reason\", \"daily update\"); </pre> \n</div> \n<p>upserts 方法支持的文档格式与 update 方法相同。</p> \n<p>可选参数：<br>超时时间</p> \n<div class=\"cnblogs_code\"> \n <pre>request.timeout(TimeValue.timeValueSeconds(1<span style=\"color: #000000;\">)); \nrequest.timeout(</span>\"1s\"); </pre> \n</div> \n<p>刷新策略</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #000000;\">request.setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL); \nrequest.setRefreshPolicy(</span>\"wait_for\");  </pre> \n</div> \n<p>冲突后重试次数</p> \n<div class=\"cnblogs_code\"> \n <pre>request.retryOnConflict(3);</pre> \n</div> \n<p>获取数据源，默认是开启的</p> \n<div class=\"cnblogs_code\"> \n <pre>request.fetchSource(<span style=\"color: #0000ff;\">true</span>); </pre> \n</div> \n<p>包括特定字段</p> \n<div class=\"cnblogs_code\"> \n <pre>String[] includes = <span style=\"color: #0000ff;\">new</span> String[]{\"updated\", \"r*\"<span style=\"color: #000000;\">};\nString[] excludes </span>=<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\nrequest.fetchSource(</span><span style=\"color: #0000ff;\">new</span> FetchSourceContext(<span style=\"color: #0000ff;\">true</span>, includes, excludes)); </pre> \n</div> \n<p>排除特定字段</p> \n<div class=\"cnblogs_code\"> \n <pre>String[] includes =<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\nString[] excludes </span>= <span style=\"color: #0000ff;\">new</span> String[]{\"updated\"<span style=\"color: #000000;\">};\nrequest.fetchSource(</span><span style=\"color: #0000ff;\">new</span> FetchSourceContext(<span style=\"color: #0000ff;\">true</span>, includes, excludes)); </pre> \n</div> \n<p>指定版本</p> \n<div class=\"cnblogs_code\"> \n <pre>request.version(2); </pre> \n</div> \n<p>禁用 noop detection</p> \n<div class=\"cnblogs_code\"> \n <pre>request.scriptedUpsert(<span style=\"color: #0000ff;\">true</span>); </pre> \n</div> \n<p>&nbsp;</p> \n<p>设置如果更新的文档不存在，就必须要创建一个</p> \n<div class=\"cnblogs_code\"> \n <pre>request.docAsUpsert(<span style=\"color: #0000ff;\">true</span>); </pre> \n</div> \n<p>同步执行</p> \n<div class=\"cnblogs_code\"> \n <pre>UpdateResponse updateResponse = client.update(request);</pre> \n</div> \n<p>异步执行</p> \n<div class=\"cnblogs_code\"> \n <pre>ActionListener&lt;UpdateResponse&gt; listener = <span style=\"color: #0000ff;\">new</span> ActionListener&lt;UpdateResponse&gt;<span style=\"color: #000000;\">() {\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onResponse(UpdateResponse updateResponse) {\n        \n    }\n\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onFailure(Exception e) {\n        \n    }\n};\n\nclient.updateAsync(request, listener); </span></pre> \n</div> \n<p><strong>Update Response</strong></p> \n<div class=\"cnblogs_code\"> \n <pre>String index =<span style=\"color: #000000;\"> updateResponse.getIndex();\nString type </span>=<span style=\"color: #000000;\"> updateResponse.getType();\nString id </span>=<span style=\"color: #000000;\"> updateResponse.getId();\n</span><span style=\"color: #0000ff;\">long</span> version =<span style=\"color: #000000;\"> updateResponse.getVersion();\n</span><span style=\"color: #0000ff;\">if</span> (updateResponse.getResult() ==<span style=\"color: #000000;\"> DocWriteResponse.Result.CREATED) {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 文档已创建</span>\n} <span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (updateResponse.getResult() ==<span style=\"color: #000000;\"> DocWriteResponse.Result.UPDATED) {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 文档已更新</span>\n} <span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (updateResponse.getResult() ==<span style=\"color: #000000;\"> DocWriteResponse.Result.DELETED) {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 文档已删除</span>\n} <span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (updateResponse.getResult() ==<span style=\"color: #000000;\"> DocWriteResponse.Result.NOOP) {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 文档不受更新的影响</span>\n}</pre> \n</div> \n<p>如果在 UpdateRequest 中使能了获取源数据，响应中则包含了更新后的源文档信息。</p> \n<div class=\"cnblogs_code\"> \n <pre>GetResult result =<span style=\"color: #000000;\"> updateResponse.getGetResult(); \n</span><span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (result.isExists()) {\n    String sourceAsString </span>= result.sourceAsString();  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 将获取的文档以 string 格式输出</span>\n    Map&lt;String, Object&gt; sourceAsMap = result.sourceAsMap(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 以 Map 格式输出</span>\n    <span style=\"color: #0000ff;\">byte</span>[] sourceAsBytes = result.source();  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 字节形式</span>\n} <span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 默认情况下，不会返回文档源数据</span>\n}</pre> \n</div> \n<p>也可以检测是否分片失败</p> \n<div class=\"cnblogs_code\"> \n <pre>ReplicationResponse.ShardInfo shardInfo =<span style=\"color: #000000;\"> updateResponse.getShardInfo();\n</span><span style=\"color: #0000ff;\">if</span> (shardInfo.getTotal() !=<span style=\"color: #000000;\"> shardInfo.getSuccessful()) {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 成功的分片数量小于总分片数量</span>\n<span style=\"color: #000000;\">}\n</span><span style=\"color: #0000ff;\">if</span> (shardInfo.getFailed() &gt; 0<span style=\"color: #000000;\">) {\n    </span><span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (ReplicationResponse.ShardInfo.Failure failure : shardInfo.getFailures()) {\n        String reason </span>= failure.reason(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 得到分片失败的原因</span>\n<span style=\"color: #000000;\">    }\n}</span></pre> \n</div> \n<p>如果在执行 UpdateRequest 时，文档不存在，响应中会包含 404 状态码，而且会抛出 ElasticsearchException 。</p> \n<div class=\"cnblogs_code\"> \n <pre>UpdateRequest request = <span style=\"color: #0000ff;\">new</span> UpdateRequest(\"posts\", \"type\", \"does_not_exist\"<span style=\"color: #000000;\">)\n        .doc(</span>\"field\", \"value\"<span style=\"color: #000000;\">);\n</span><span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\n    UpdateResponse updateResponse </span>=<span style=\"color: #000000;\"> client.update(request);\n} </span><span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\"> (ElasticsearchException e) {\n    </span><span style=\"color: #0000ff;\">if</span> (e.status() ==<span style=\"color: #000000;\"> RestStatus.NOT_FOUND) {\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 处理文档不存在的情况</span>\n<span style=\"color: #000000;\">    }\n}</span></pre> \n</div> \n<p>如果版本冲突，也会抛出 ElasticsearchException</p> \n<div class=\"cnblogs_code\"> \n <pre>UpdateRequest request = <span style=\"color: #0000ff;\">new</span> UpdateRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">)\n        .doc(</span>\"field\", \"value\"<span style=\"color: #000000;\">)\n        .version(</span>1<span style=\"color: #000000;\">);\n</span><span style=\"color: #0000ff;\">try</span><span style=\"color: #000000;\"> {\n    UpdateResponse updateResponse </span>=<span style=\"color: #000000;\"> client.update(request);\n} </span><span style=\"color: #0000ff;\">catch</span><span style=\"color: #000000;\">(ElasticsearchException e) {\n    </span><span style=\"color: #0000ff;\">if</span> (e.status() ==<span style=\"color: #000000;\"> RestStatus.CONFLICT) {\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 处理版本冲突的情况</span>\n<span style=\"color: #000000;\">    }\n}</span></pre> \n</div> \n<p>封装好的参考方法：</p> \n<div class=\"cnblogs_code\"> \n <pre>   <span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> dataMap\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> timeValue\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> refreshPolicy\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> version\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> versionType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docAsUpsert\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> includes\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> excludes\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> UpdateResponse updateDoc(String index, String indexType, String docId, Map&lt;String, Object&gt; dataMap, TimeValue timeValue, WriteRequest.RefreshPolicy refreshPolicy, Integer version, VersionType versionType, Boolean docAsUpsert, String[] includes, String[] excludes) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        UpdateRequest updateRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> UpdateRequest(index, indexType, docId);\n        updateRequest.doc(dataMap);\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> timeValue) {\n            updateRequest.timeout(timeValue);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> refreshPolicy) {\n            updateRequest.setRefreshPolicy(refreshPolicy);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> version) {\n            updateRequest.version(version);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> versionType) {\n            updateRequest.versionType(versionType);\n        }\n        updateRequest.docAsUpsert(docAsUpsert);\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">冲突时重试的次数</span>\n        updateRequest.retryOnConflict(3<span style=\"color: #000000;\">);\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> == includes &amp;&amp; <span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> excludes) {\n            </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().update(updateRequest);\n        } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n            </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> == includes || includes.length == 0<span style=\"color: #000000;\">) {\n                includes </span>=<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\n            }\n            </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> == excludes || excludes.length == 0<span style=\"color: #000000;\">) {\n                excludes </span>=<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\n            }\n            </span><span style=\"color: #0000ff;\">return</span> getClient().update(updateRequest.fetchSource(<span style=\"color: #0000ff;\">new</span> FetchSourceContext(<span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">, includes, excludes)));\n        }\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 更新时不存在就插入\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> dataMap\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> UpdateResponse upDdateocAsUpsert(String index, String indexType, String docId, Map&lt;String, Object&gt; dataMap) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span> updateDoc(index, indexType, docId, dataMap, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">true</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 存在才更新\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> dataMap\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> UpdateResponse updateDoc(String index, String indexType, String docId, Map&lt;String, Object&gt; dataMap) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span> updateDoc(index, indexType, docId, dataMap, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">false</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n    }</span></pre> \n</div> \n<p>&nbsp;</p> \n<p><strong>6、Bulk API 批量处理</strong></p> \n<p><strong>批量请求</strong><br>使用 BulkRequest 可以在一次请求中执行多个索引，更新和删除的操作。</p> \n<div class=\"cnblogs_code\"> \n <pre>BulkRequest request = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> BulkRequest();  \nrequest.add(</span><span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">)  \n        .source(XContentType.JSON,</span>\"field\", \"foo\")); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 将第一个 IndexRequest 添加到批量请求中</span>\nrequest.add(<span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"2\"<span style=\"color: #000000;\">)  \n        .source(XContentType.JSON,</span>\"field\", \"bar\")); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 第二个</span>\nrequest.add(<span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"3\"<span style=\"color: #000000;\">)  \n        .source(XContentType.JSON,</span>\"field\", \"baz\")); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 第三个</span></pre> \n</div> \n<p>在同一个 BulkRequest 也可以添加不同的操作类型</p> \n<div class=\"cnblogs_code\"> \n <pre>BulkRequest request = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> BulkRequest();\nrequest.add(</span><span style=\"color: #0000ff;\">new</span> DeleteRequest(\"posts\", \"doc\", \"3\"<span style=\"color: #000000;\">)); \nrequest.add(</span><span style=\"color: #0000ff;\">new</span> UpdateRequest(\"posts\", \"doc\", \"2\"<span style=\"color: #000000;\">) \n        .doc(XContentType.JSON,</span>\"other\", \"test\"<span style=\"color: #000000;\">));\nrequest.add(</span><span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"4\"<span style=\"color: #000000;\">)  \n        .source(XContentType.JSON,</span>\"field\", \"baz\"));</pre> \n</div> \n<p>可选参数<br>超时时间</p> \n<div class=\"cnblogs_code\"> \n <pre>request.timeout(TimeValue.timeValueMinutes(2<span style=\"color: #000000;\">)); \nrequest.timeout(</span>\"2m\"); </pre> \n</div> \n<p>刷新策略</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #000000;\">request.setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL); \nrequest.setRefreshPolicy(</span>\"wait_for\"); </pre> \n</div> \n<p>设置在批量操作前必须有几个分片处于激活状态</p> \n<p>&nbsp;</p> \n<div class=\"cnblogs_code\"> \n <pre>request.waitForActiveShards(2<span style=\"color: #000000;\">); \nrequest.waitForActiveShards(ActiveShardCount.ALL);  </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 全部分片都处于激活状态</span>\nrequest.waitForActiveShards(ActiveShardCount.DEFAULT);  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 默认</span>\nrequest.waitForActiveShards(ActiveShardCount.ONE);  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 一个</span></pre> \n</div> \n<p>同步请求</p> \n<div class=\"cnblogs_code\"> \n <pre>BulkResponse bulkResponse = client.bulk(request);</pre> \n</div> \n<p>异步请求</p> \n<div class=\"cnblogs_code\"> \n <pre>ActionListener&lt;BulkResponse&gt; listener = <span style=\"color: #0000ff;\">new</span> ActionListener&lt;BulkResponse&gt;<span style=\"color: #000000;\">() {\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onResponse(BulkResponse bulkResponse) {\n        \n    }\n\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onFailure(Exception e) {\n        \n    }\n};\n\nclient.bulkAsync(request, listener); </span></pre> \n</div> \n<p><strong>Bulk Response</strong><br>BulkResponse 中包含执行操作后的信息，并允许对每个操作结果迭代。</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">for</span> (BulkItemResponse bulkItemResponse : bulkResponse) { <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 遍历所有的操作结果</span>\n    DocWriteResponse itemResponse = bulkItemResponse.getResponse(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 获取操作结果的响应，可以是  IndexResponse, UpdateResponse or DeleteResponse, 它们都可以惭怍是 DocWriteResponse 实例</span>\n\n    <span style=\"color: #0000ff;\">if</span> (bulkItemResponse.getOpType() ==<span style=\"color: #000000;\"> DocWriteRequest.OpType.INDEX\n            </span>|| bulkItemResponse.getOpType() ==<span style=\"color: #000000;\"> DocWriteRequest.OpType.CREATE) { \n        IndexResponse indexResponse </span>= (IndexResponse) itemResponse; <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> index 操作后的响应结果</span>\n<span style=\"color: #000000;\">\n    } </span><span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (bulkItemResponse.getOpType() ==<span style=\"color: #000000;\"> DocWriteRequest.OpType.UPDATE) { \n        UpdateResponse updateResponse </span>= (UpdateResponse) itemResponse; <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> update 操作后的响应结果</span>\n<span style=\"color: #000000;\">\n    } </span><span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (bulkItemResponse.getOpType() ==<span style=\"color: #000000;\"> DocWriteRequest.OpType.DELETE) { \n        DeleteResponse deleteResponse </span>= (DeleteResponse) itemResponse; <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> delete 操作后的响应结果</span>\n<span style=\"color: #000000;\">    }\n}</span></pre> \n</div> \n<p>此外，批量响应还有一个非常便捷的方法来检测是否有一个或多个操作失败</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (bulkResponse.hasFailures()) { \n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 表示至少有一个操作失败</span>\n}</pre> \n</div> \n<p>在这种情况下，我们要遍历所有的操作结果，检查是否是失败的操作，并获取对应的失败信息</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (BulkItemResponse bulkItemResponse : bulkResponse) {\n    </span><span style=\"color: #0000ff;\">if</span> (bulkItemResponse.isFailed()) { <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 检测给定的操作是否失败</span>\n        BulkItemResponse.Failure failure = bulkItemResponse.getFailure(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 获取失败信息</span>\n<span style=\"color: #000000;\">\n    }\n}</span></pre> \n</div> \n<p><strong>Bulk Processor</strong><br>BulkProcessor 是为了简化 Bulk API 的操作提供的一个工具类，要执行操作，就需要下面组件</p> \n<p>RestHighLevelClient 用来执行 BulkRequest 并获取 BulkResponse`<br>BulkProcessor.Listener 对 BulkRequest 执行前后以及失败时监听<br>BulkProcessor.builder 方法用来构建一个新的BulkProcessor</p> \n<div class=\"cnblogs_code\"> \n <pre>BulkProcessor.Listener listener = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> BulkProcessor.Listener() { \n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span> beforeBulk(<span style=\"color: #0000ff;\">long</span><span style=\"color: #000000;\"> executionId, BulkRequest request) {\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 在每个 BulkRequest 执行前调用</span>\n<span style=\"color: #000000;\">    }\n\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span> afterBulk(<span style=\"color: #0000ff;\">long</span><span style=\"color: #000000;\"> executionId, BulkRequest request,\n            BulkResponse response) {\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 在每个 BulkRequest 执行后调用</span>\n<span style=\"color: #000000;\">    }\n\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span> afterBulk(<span style=\"color: #0000ff;\">long</span><span style=\"color: #000000;\"> executionId, BulkRequest request, Throwable failure) {\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 失败时调用</span>\n<span style=\"color: #000000;\">    }\n};</span></pre> \n</div> \n<p>BulkProcessor.Builder 提供了多个方法来配置 BulkProcessor<br>如何来处理请求的执行。</p> \n<div class=\"cnblogs_code\"> \n <pre>BulkProcessor.Builder builder =<span style=\"color: #000000;\"> BulkProcessor.builder(client::bulkAsync, listener);\nbuilder.setBulkActions(</span>500); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 指定多少操作时，就会刷新一次</span>\nbuilder.setBulkSize(<span style=\"color: #0000ff;\">new</span> ByteSizeValue(1L<span style=\"color: #000000;\">, ByteSizeUnit.MB)); \nbuilder.setConcurrentRequests(</span>0);  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 指定多大容量，就会刷新一次</span>\nbuilder.setFlushInterval(TimeValue.timeValueSeconds(10L)); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 允许并发执行的数量 </span>\n<span style=\"color: #000000;\">builder.setBackoffPolicy(BackoffPolicy\n        .constantBackoff(TimeValue.timeValueSeconds(</span>1L), 3<span style=\"color: #000000;\">)); \nBulkProcessor 创建后，各种请求就可以添加进去：\n\nIndexRequest one </span>= <span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"1\"<span style=\"color: #000000;\">).\n        source(XContentType.JSON, </span>\"title\"<span style=\"color: #000000;\">,\n                </span>\"In which order are my Elasticsearch queries executed?\"<span style=\"color: #000000;\">);\nIndexRequest two </span>= <span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"2\"<span style=\"color: #000000;\">)\n        .source(XContentType.JSON, </span>\"title\"<span style=\"color: #000000;\">,\n                </span>\"Current status and upcoming changes in Elasticsearch\"<span style=\"color: #000000;\">);\nIndexRequest three </span>= <span style=\"color: #0000ff;\">new</span> IndexRequest(\"posts\", \"doc\", \"3\"<span style=\"color: #000000;\">)\n        .source(XContentType.JSON, </span>\"title\"<span style=\"color: #000000;\">,\n                </span>\"The Future of Federated Search in Elasticsearch\"<span style=\"color: #000000;\">);\n\nbulkProcessor.add(one);\nbulkProcessor.add(two);\nbulkProcessor.add(three);</span></pre> \n</div> \n<p>BulkProcessor 执行时，会对每个 bulk request调用 BulkProcessor.Listener ， listener 提供了下面方法来访问 BulkRequest 和 BulkResponse:</p> \n<div class=\"cnblogs_code\"> \n <pre>BulkProcessor.Listener listener = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> BulkProcessor.Listener() {\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span> beforeBulk(<span style=\"color: #0000ff;\">long</span><span style=\"color: #000000;\"> executionId, BulkRequest request) {\n        </span><span style=\"color: #0000ff;\">int</span> numberOfActions = request.numberOfActions(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 在执行前获取操作的数量</span>\n        logger.debug(\"Executing bulk [{}] with {} requests\"<span style=\"color: #000000;\">,\n                executionId, numberOfActions);\n    }\n\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span> afterBulk(<span style=\"color: #0000ff;\">long</span><span style=\"color: #000000;\"> executionId, BulkRequest request,\n            BulkResponse response) {\n        </span><span style=\"color: #0000ff;\">if</span> (response.hasFailures()) { <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 执行后查看响应中是否包含失败的操作</span>\n            logger.warn(\"Bulk [{}] executed with failures\"<span style=\"color: #000000;\">, executionId);\n        } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n            logger.debug(</span>\"Bulk [{}] completed in {} milliseconds\"<span style=\"color: #000000;\">,\n                    executionId, response.getTook().getMillis());\n        }\n    }\n\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span> afterBulk(<span style=\"color: #0000ff;\">long</span><span style=\"color: #000000;\"> executionId, BulkRequest request, Throwable failure) {\n        logger.error(</span>\"Failed to execute bulk\", failure); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 请求失败时打印信息</span>\n<span style=\"color: #000000;\">    }\n};</span></pre> \n</div> \n<p>请求添加到 BulkProcessor ， 它的实例可以使用下面两种方法关闭请求。</p> \n<p>awaitClose() 在请求返回后或等待一定时间关闭</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">boolean</span> terminated = bulkProcessor.awaitClose(30L, TimeUnit.SECONDS); </pre> \n</div> \n<p>close() 立刻关闭</p> \n<div class=\"cnblogs_code\"> \n <pre>bulkProcessor.close();</pre> \n</div> \n<p>两个方法都会在关闭前对处理器中的请求进行刷新，并避免新的请求添加进去。</p> \n<p>封装好的参考方法：</p> \n<div class=\"cnblogs_code\"> \n <pre>    <span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 批量操作\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexBeanList\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> timeValue\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> refreshPolicy\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> BulkResponse bulkRequest(List&lt;IndexBean&gt; indexBeanList, TimeValue timeValue, WriteRequest.RefreshPolicy refreshPolicy) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        BulkRequest bulkRequest </span>=<span style=\"color: #000000;\"> getBulkRequest(indexBeanList);\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> timeValue) {\n            bulkRequest.timeout(timeValue);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> refreshPolicy) {\n            bulkRequest.setRefreshPolicy(refreshPolicy);\n        }\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().bulk(bulkRequest);\n    }\n\n    </span><span style=\"color: #0000ff;\">private</span> BulkRequest getBulkRequest(List&lt;IndexBean&gt;<span style=\"color: #000000;\"> indexBeanList) {\n        BulkRequest bulkRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> BulkRequest();\n        indexBeanList.forEach(indexBean </span>-&gt;<span style=\"color: #000000;\"> {\n            </span><span style=\"color: #0000ff;\">if</span> (\"1\"<span style=\"color: #000000;\">.equals(indexBean.getOperateType())) {\n                bulkRequest.add(</span><span style=\"color: #0000ff;\">null</span> != indexBean.getDocId() ? <span style=\"color: #0000ff;\">new</span> IndexRequest(indexBean.getIndex(), indexBean.getIndexType(), indexBean.getDocId()) : <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> IndexRequest(indexBean.getIndex(), indexBean.getIndexType()));\n            } </span><span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (\"2\"<span style=\"color: #000000;\">.equals(indexBean.getOperateType())) {\n                </span><span style=\"color: #0000ff;\">if</span> ((<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> indexBean.getDocId())) {\n                    </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"update action docId must not be null\"<span style=\"color: #000000;\">);\n                }\n                bulkRequest.add(</span><span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> UpdateRequest(indexBean.getIndex(), indexBean.getIndexType(), indexBean.getDocId()));\n            } </span><span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (\"3\"<span style=\"color: #000000;\">.equals(indexBean.getOperateType())) {\n                </span><span style=\"color: #0000ff;\">if</span> ((<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> indexBean.getDocId())) {\n                    </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"delete action docId must not be null\"<span style=\"color: #000000;\">);\n                }\n                bulkRequest.add(</span><span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> DeleteRequest(indexBean.getIndex(), indexBean.getIndexType(), indexBean.getDocId()));\n            } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n                </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"OperateType\" + indexBean.getOperateType() + \"is not support\"<span style=\"color: #000000;\">);\n            }\n        });\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> bulkRequest;\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 批量操作\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexBeanList\n     * </span><span style=\"color: #808080;\">@return</span>\n     <span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> BulkResponse bulkRequest(List&lt;IndexBean&gt; indexBeanList) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span> bulkRequest(indexBeanList, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 批量异步操作\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexBeanList\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> bulkResponseActionListener\n     </span><span style=\"color: #008000;\">*/</span>\n\n    <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span> AsyncBulkRequest(List&lt;IndexBean&gt; indexBeanList, ActionListener&lt;BulkResponse&gt;<span style=\"color: #000000;\"> bulkResponseActionListener) {\n        getClient().bulkAsync(getBulkRequest(indexBeanList), bulkResponseActionListener);\n    }</span></pre> \n</div> \n<p><strong>7、Search APIs：</strong></p> \n<p>Java High Level REST Client 支持下面的 Search API：</p> \n<ul> \n <li>Search API</li> \n <li>Search Scroll API</li> \n <li>Clear Scroll API</li> \n <li>Multi-Search API</li> \n <li>Ranking Evaluation API</li> \n</ul> \n<p><strong>Search API</strong><br>Search Request<br>searchRequest 用来完成和搜索文档，聚合，建议等相关的任何操作同时也提供了各种方式来完成对查询结果的高亮操作。</p> \n<p>最基本的查询操作如下</p> \n<div class=\"cnblogs_code\"> \n <pre>SearchRequest searchRequest = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SearchRequest(); \nSearchSourceBuilder searchSourceBuilder </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SearchSourceBuilder(); \nsearchSourceBuilder.query(QueryBuilders.matchAllQuery()); </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 添加 match_all 查询</span>\nsearchRequest.source(searchSourceBuilder); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 将 SearchSourceBuilder  添加到 SeachRequest 中</span></pre> \n</div> \n<p>可选参数</p> \n<div class=\"cnblogs_code\"> \n <pre>SearchRequest searchRequest = <span style=\"color: #0000ff;\">new</span> SearchRequest(\"posts\");  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 设置搜索的 index</span>\nsearchRequest.types(\"doc\");  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 设置搜索的 type</span></pre> \n</div> \n<p>除了配置 index 和 type 外，还有一些其他的可选参数</p> \n<div class=\"cnblogs_code\"> \n <pre>searchRequest.routing(\"routing\"); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 设置 routing 参数</span>\nsearchRequest.preference(\"_local\");  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 配置搜索时偏爱使用本地分片，默认是使用随机分片</span></pre> \n</div> \n<p><strong>什么是 routing 参数?</strong><br>当索引一个文档的时候，文档会被存储在一个主分片上。在存储时一般都会有多个主分片。Elasticsearch 如何知道一个文档应该放置在哪个分片呢？这个过程是根据下面的这个公式来决定的：</p> \n<p>shard = hash(routing) % number_of_primary_shards<br>routing 是一个可变值，默认是文档的 _id ,也可以设置成一个自定义的值<br>number_of_primary_shards 是主分片数量<br>所有的文档 API 都接受一个叫做 routing 的路由参数，通过这个参数我们可以自定义文档到分片的映射。一个自定义的路由参数可以用来确保所有相关的文档——例如所有属于同一个用户的文档——都被存储到同一个分片中。</p> \n<p>使用 SearchSourceBuilder<br>对搜索行为的配置可以使用 SearchSourceBuilder 来完成，来看一个实例</p> \n<div class=\"cnblogs_code\"> \n <pre>SearchSourceBuilder sourceBuilder = <span style=\"color: #0000ff;\">new</span> SearchSourceBuilder();  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 默认配置</span>\nsourceBuilder.query(QueryBuilders.termQuery(\"user\", \"kimchy\")); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 设置搜索，可以是任何类型的 QueryBuilder</span>\nsourceBuilder.from(0); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 起始 index</span>\nsourceBuilder.size(5); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 大小 size</span>\nsourceBuilder.timeout(<span style=\"color: #0000ff;\">new</span> TimeValue(60, TimeUnit.SECONDS)); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 设置搜索的超时时间</span></pre> \n</div> \n<p>设置完成后，就可以添加到 SearchRequest 中。</p> \n<div class=\"cnblogs_code\"> \n <pre>SearchRequest searchRequest = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SearchRequest();\nsearchRequest.source(sourceBuilder);</span></pre> \n</div> \n<p>构建查询条件<br>查询请求是通过使用 QueryBuilder 对象来完成的，并且支持 Query DSL。</p> \n<p>DSL (domain-specific language) 领域特定语言，是指专注于某个应用程序领域的计算机语言。</p> \n<p>可以使用构造函数来创建 QueryBuilder</p> \n<div class=\"cnblogs_code\"> \n <pre>MatchQueryBuilder matchQueryBuilder = <span style=\"color: #0000ff;\">new</span> MatchQueryBuilder(\"user\", \"kimchy\"); </pre> \n</div> \n<p>QueryBuilder 创建后，就可以调用方法来配置它的查询选项：</p> \n<div class=\"cnblogs_code\"> \n <pre>matchQueryBuilder.fuzziness(Fuzziness.AUTO);  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 模糊查询</span>\nmatchQueryBuilder.prefixLength(3); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 前缀查询的长度</span>\nmatchQueryBuilder.maxExpansions(10); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> max expansion 选项，用来控制模糊查询</span></pre> \n</div> \n<p>也可以使用QueryBuilders 工具类来创建 QueryBuilder 对象。这个类提供了函数式编程风格的各种方法用来快速创建 QueryBuilder 对象。</p> \n<div class=\"cnblogs_code\"> \n <pre>QueryBuilder matchQueryBuilder = QueryBuilders.matchQuery(\"user\", \"kimchy\"<span style=\"color: #000000;\">)\n                                        .fuzziness(Fuzziness.AUTO)\n                                                .prefixLength(</span>3<span style=\"color: #000000;\">)\n                                                .maxExpansions(</span>10);</pre> \n</div> \n<p>fuzzy-matching 拼写错误时的匹配：</p> \n<p>好的全文检索不应该是完全相同的限定逻辑，相反，可以扩大范围来包括可能的匹配，从而根据相关性得分将更好的匹配放在前面。</p> \n<p>例如，搜索 quick brown fox 时会匹配一个包含 fast brown foxes 的文档</p> \n<p>不论什么方式创建的 QueryBuilder ，最后都需要添加到 `SearchSourceBuilder 中</p> \n<div class=\"cnblogs_code\"> \n <pre>searchSourceBuilder.query(matchQueryBuilder);</pre> \n</div> \n<p>构建查询 文档中提供了一个丰富的查询列表，里面包含各种查询对应的QueryBuilder 对象以及QueryBuilder helper 方法，大家可以去参考。</p> \n<p>关于构建查询的内容会在下篇文章中讲解，敬请期待。</p> \n<p>指定排序<br>SearchSourceBuilder 允许添加一个或多个SortBuilder 实例。这里包含 4 种特殊的实现, (Field-, Score-, GeoDistance- 和 ScriptSortBuilder)</p> \n<div class=\"cnblogs_code\"> \n <pre>sourceBuilder.sort(<span style=\"color: #0000ff;\">new</span> ScoreSortBuilder().order(SortOrder.DESC)); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 根据分数 _score 降序排列 (默认行为)</span>\nsourceBuilder.sort(<span style=\"color: #0000ff;\">new</span> FieldSortBuilder(\"_uid\").order(SortOrder.ASC));  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 根据 id 降序排列</span></pre> \n</div> \n<p>过滤数据源<br>默认情况下，查询请求会返回文档的内容 _source ,当然我们也可以配置它。例如，禁止对 _source 的获取</p> \n<div class=\"cnblogs_code\"> \n <pre>sourceBuilder.fetchSource(<span style=\"color: #0000ff;\">false</span>);</pre> \n</div> \n<p>也可以使用通配符模式以更细的粒度包含或排除特定的字段：</p> \n<div class=\"cnblogs_code\"> \n <pre>String[] includeFields = <span style=\"color: #0000ff;\">new</span> String[] {\"title\", \"user\", \"innerObject.*\"<span style=\"color: #000000;\">};\nString[] excludeFields </span>= <span style=\"color: #0000ff;\">new</span> String[] {\"_type\"<span style=\"color: #000000;\">};\nsourceBuilder.fetchSource(includeFields, excludeFields);</span></pre> \n</div> \n<p>高亮请求<br>可以通过在 SearchSourceBuilder 上设置 HighlightBuilder 完成对结果的高亮，而且可以配置不同的字段具有不同的高亮行为。</p> \n<div class=\"cnblogs_code\"> \n <pre>SearchSourceBuilder searchSourceBuilder = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SearchSourceBuilder();\nHighlightBuilder highlightBuilder </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> HighlightBuilder(); \nHighlightBuilder.Field highlightTitle </span>=\n        <span style=\"color: #0000ff;\">new</span> HighlightBuilder.Field(\"title\"); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> title 字段高亮</span>\nhighlightTitle.highlighterType(\"unified\");  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 配置高亮类型</span>\nhighlightBuilder.field(highlightTitle);  <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 添加到 builder</span>\nHighlightBuilder.Field highlightUser = <span style=\"color: #0000ff;\">new</span> HighlightBuilder.Field(\"user\"<span style=\"color: #000000;\">);\nhighlightBuilder.field(highlightUser);\nsearchSourceBuilder.highlighter(highlightBuilder);</span></pre> \n</div> \n<p>聚合请求<br>要实现聚合请求分两步</p> \n<p>创建合适的 `AggregationBuilder<br>作为参数配置在 `SearchSourceBuilder 上</p> \n<div class=\"cnblogs_code\"> \n <pre>SearchSourceBuilder searchSourceBuilder = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SearchSourceBuilder();\nTermsAggregationBuilder aggregation </span>= AggregationBuilders.terms(\"by_company\"<span style=\"color: #000000;\">)\n        .field(</span>\"company.keyword\"<span style=\"color: #000000;\">);\naggregation.subAggregation(AggregationBuilders.avg(</span>\"average_age\"<span style=\"color: #000000;\">)\n        .field(</span>\"age\"<span style=\"color: #000000;\">));\nsearchSourceBuilder.aggregation(aggregation);</span></pre> \n</div> \n<p>建议请求 Requesting Suggestions</p> \n<p>SuggestionBuilder 实现类是由 SuggestBuilders 工厂类来创建的。</p> \n<div class=\"cnblogs_code\"> \n <pre>SearchSourceBuilder searchSourceBuilder = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SearchSourceBuilder();\nSuggestionBuilder termSuggestionBuilder </span>=<span style=\"color: #000000;\">\n    SuggestBuilders.termSuggestion(</span>\"user\").text(\"kmichy\"<span style=\"color: #000000;\">); \nSuggestBuilder suggestBuilder </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SuggestBuilder();\nsuggestBuilder.addSuggestion(</span>\"suggest_user\"<span style=\"color: #000000;\">, termSuggestionBuilder); \nsearchSourceBuilder.suggest(suggestBuilder);</span></pre> \n</div> \n<p>对请求和聚合分析<br>分析 API 可用来对一个特定的查询操作中的请求和聚合进行分析，此时要将SearchSourceBuilder 的 profile标志位设置为 true</p> \n<div class=\"cnblogs_code\"> \n <pre>SearchSourceBuilder searchSourceBuilder = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SearchSourceBuilder();\nsearchSourceBuilder.profile(</span><span style=\"color: #0000ff;\">true</span>);</pre> \n</div> \n<p>只要 SearchRequest 执行完成，对应的 SearchResponse 响应中就会包含 分析结果</p> \n<p>同步执行<br>同步执行是阻塞式的，只有结果返回后才能继续执行。</p> \n<div class=\"cnblogs_code\"> \n <pre>SearchResponse searchResponse = client.search(searchRequest);</pre> \n</div> \n<p>异步执行<br>异步执行使用的是 listener 对结果进行处理。</p> \n<div class=\"cnblogs_code\"> \n <pre>ActionListener&lt;SearchResponse&gt; listener = <span style=\"color: #0000ff;\">new</span> ActionListener&lt;SearchResponse&gt;<span style=\"color: #000000;\">() {\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onResponse(SearchResponse searchResponse) {\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 查询成功</span>\n<span style=\"color: #000000;\">    }\n\n    @Override\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> onFailure(Exception e) {\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 查询失败</span>\n<span style=\"color: #000000;\">    }\n};</span></pre> \n</div> \n<p><strong>SearchResponse</strong></p> \n<p>查询执行完成后，会返回 SearchResponse 对象，并在对象中包含查询执行的细节和符合条件的文档集合。</p> \n<p>归纳一下， SerchResponse 包含的信息如下</p> \n<p>请求本身的信息，如 HTTP 状态码，执行时间，或者请求是否超时</p> \n<div class=\"cnblogs_code\"> \n <pre>RestStatus status = searchResponse.status(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> HTTP 状态码</span>\nTimeValue took = searchResponse.getTook(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 查询占用的时间</span>\nBoolean terminatedEarly = searchResponse.isTerminatedEarly(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 是否由于 SearchSourceBuilder 中设置 terminateAfter 而过早终止</span>\n<span style=\"color: #0000ff;\">boolean</span> timedOut = searchResponse.isTimedOut(); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 是否超时</span></pre> \n</div> \n<p>查询影响的分片数量的统计信息，成功和失败的分片</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">int</span> totalShards =<span style=\"color: #000000;\"> searchResponse.getTotalShards();\n</span><span style=\"color: #0000ff;\">int</span> successfulShards =<span style=\"color: #000000;\"> searchResponse.getSuccessfulShards();\n</span><span style=\"color: #0000ff;\">int</span> failedShards =<span style=\"color: #000000;\"> searchResponse.getFailedShards();\n</span><span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (ShardSearchFailure failure : searchResponse.getShardFailures()) {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> failures should be handled here</span>\n}</pre> \n</div> \n<p>检索 SearchHits<br>要访问返回的文档，首先要在响应中获取其中的 SearchHits</p> \n<div class=\"cnblogs_code\"> \n <pre>SearchHits hits = searchResponse.getHits();</pre> \n</div> \n<p>SearchHits 中包含了所有命中的全局信息，如查询命中的数量或者最大分值：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">long</span> totalHits =<span style=\"color: #000000;\"> hits.getTotalHits();\n</span><span style=\"color: #0000ff;\">float</span> maxScore = hits.getMaxScore();</pre> \n</div> \n<p>查询的结果嵌套在 SearchHits 中，可以通过遍历循环获取</p> \n<div class=\"cnblogs_code\"> \n <pre>SearchHit[] searchHits =<span style=\"color: #000000;\"> hits.getHits();\n</span><span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (SearchHit hit : searchHits) {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> do something with the SearchHit</span>\n}</pre> \n</div> \n<div class=\"cnblogs_code\"> \n <pre>SearchHit 提供了如 index ， type， docId 和每个命中查询的分数</pre> \n</div> \n<div class=\"cnblogs_code\"> \n <pre>String index =<span style=\"color: #000000;\"> hit.getIndex();\nString type </span>=<span style=\"color: #000000;\"> hit.getType();\nString id </span>=<span style=\"color: #000000;\"> hit.getId();\n</span><span style=\"color: #0000ff;\">float</span> score = hit.getScore();</pre> \n</div> \n<p>而且，还可以获取到文档的源数据，以 JSON-String 形式或者 key-value map 对的形式。在 map 中，字段可以是普通类型，或者是列表类型，嵌套对象。</p> \n<div class=\"cnblogs_code\"> \n <pre>String sourceAsString =<span style=\"color: #000000;\"> hit.getSourceAsString();\nMap</span>&lt;String, Object&gt; sourceAsMap =<span style=\"color: #000000;\"> hit.getSourceAsMap();\nString documentTitle </span>= (String) sourceAsMap.get(\"title\"<span style=\"color: #000000;\">);\nList</span>&lt;Object&gt; users = (List&lt;Object&gt;) sourceAsMap.get(\"user\"<span style=\"color: #000000;\">);\nMap</span>&lt;String, Object&gt; innerObject =<span style=\"color: #000000;\">\n        (Map</span>&lt;String, Object&gt;) sourceAsMap.get(\"innerObject\");</pre> \n</div> \n<p><strong>Search API 查询关系</strong><br>上面的 QueryBuilder ， SearchSourceBuilder 和 SearchRequest 之间都是嵌套关系， 可以参考下图：</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/25380c27-e41c-4312-8387-cf0fc962a8e6.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p><strong>8、全文查询 Full Text Queries</strong></p> \n<p><strong>什么是全文查询？</strong><br>像使用 match 或者 query_string 这样的高层查询都属于全文查询，</p> \n<p>查询 日期（date） 或整数（integer） 字段，会将查询字符串分别作为日期或整数对待。<br>查询一个（ not_analyzed ）未分析的精确值字符串字段，会将整个查询字符串作为单个词项对待。<br>查询一个（ analyzed ）已分析的全文字段，会先将查询字符串传递到一个合适的分析器，然后生成一个供查询的词项列表<br>组成了词项列表，后面就会对每个词项逐一执行底层查询，将查询结果合并，并且为每个文档生成最终的相关度评分。</p> \n<p><strong>Match</strong><br>match 查询的单个词的步骤是什么？<br>检查字段类型，查看字段是 analyzed, not_analyzed<br>分析查询字符串，如果只有一个单词项， match 查询在执行时就会是单个底层的 term 查询<br>查找匹配的文档，会在倒排索引中查找匹配文档，然后获取一组包含该项的文档<br>为每个文档评分<br>构建 Match 查询<br>match 查询可以接受 text/numeric/dates 格式的参数，分析，并构建一个查询。</p> \n<div class=\"cnblogs_code\"> \n <pre>GET /<span style=\"color: #000000;\">_search\n{\n    </span>\"query\"<span style=\"color: #000000;\">: {\n        </span>\"match\"<span style=\"color: #000000;\"> : {\n            </span>\"message\" : \"this is a test\"<span style=\"color: #000000;\">\n        }\n    }\n}</span></pre> \n</div> \n<p>上面的实例中 message 是一个字段名。</p> \n<p>对应的 QueryBuilder class : MatchQueryBuilder</p> \n<p>具体方法 : QueryBuilders.matchQuery()</p> \n<p><strong><em>全文查询 API 列表</em></strong></p> \n<table> \n <thead> \n  <tr class=\"header\">\n   <th>Search Query</th>\n   <th>QueryBuilder Class</th>\n   <th>Method in QueryBuilders</th>\n  </tr> \n </thead> \n <tbody> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-match-query.html\">Match</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/MatchQueryBuilder.html\">MatchQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#matchQuery-java.lang.String-java.lang.Object-\">QueryBuilders.matchQuery()</a></td> \n  </tr> \n  <tr class=\"even\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-match-query-phrase.html\">Match Phrase</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/MatchPhraseQueryBuilder.html\">MatchPhraseQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#matchPhraseQuery-java.lang.String-java.lang.Object-\">QueryBuilders.matchPhraseQuery()</a></td> \n  </tr> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-match-query-phrase-prefix.html\">Match Phrase Prefix</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/MatchPhrasePrefixQueryBuilder.html\">MatchPhrasePrefixQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#matchPhrasePrefixQuery-java.lang.String-java.lang.Object-\">QueryBuilders.matchPhrasePrefixQuery()</a></td> \n  </tr> \n  <tr class=\"even\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-multi-match-query.html\">Multi Match</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/MultiMatchQueryBuilder.html\">MultiMatchQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#multiMatchQuery-java.lang.Object-java.lang.String%E2%80%A6-\">QueryBuilders.multiMatchQuery()</a></td> \n  </tr> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-common-terms-query.html\">Common Terms</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/CommonTermsQueryBuilder.html\">CommonTermsQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#commonTermsQuery-java.lang.String-java.lang.Object-\">QueryBuilders.commonTermsQuery()</a></td> \n  </tr> \n  <tr class=\"even\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-query-string-query.html\">Query String</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryStringQueryBuilder.html\">QueryStringQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#queryStringQuery-java.lang.String-\">QueryBuilders.queryStringQuery()</a></td> \n  </tr> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-simple-query-string-query.html\">Simple Query String</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/SimpleQueryStringBuilder.html\">SimpleQueryStringBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#simpleQueryStringQuery-java.lang.String-\">QueryBuilders.simpleQueryStringQuery()</a></td> \n  </tr> \n </tbody> \n</table> \n<p><strong>基于词项的查询</strong><br>这种类型的查询不需要分析，它们是对单个词项操作，只是在倒排索引中查找准确的词项（精确匹配）并且使用 TF/IDF 算法为每个包含词项的文档计算相关度评分 _score。</p> \n<p><strong>Term</strong><br>term 查询可用作精确值匹配，精确值的类型则可以是数字，时间，布尔类型，或者是那些 not_analyzed 的字符串。</p> \n<p>对应的 QueryBuilder class 是TermQueryBuilder</p> \n<p>具体方法是 QueryBuilders.termQuery()</p> \n<p><strong>Terms</strong><br>terms 查询允许指定多个值进行匹配。如果这个字段包含了指定值中的任何一个值，就表示该文档满足条件。</p> \n<p>对应的 QueryBuilder class 是 TermsQueryBuilder</p> \n<p>具体方法是 QueryBuilders.termsQuery()</p> \n<p><strong>Wildcard</strong><br>wildcard 通配符查询是一种底层基于词的查询，它允许指定匹配的正则表达式。而且它使用的是标准的 shell 通配符查询：</p> \n<p>? 匹配任意字符<br>* 匹配 0 个或多个字符<br>wildcard 需要扫描倒排索引中的词列表才能找到所有匹配的词，然后依次获取每个词相关的文档 ID。</p> \n<p>由于通配符和正则表达式只能在查询时才能完成，因此查询效率会比较低，在需要高性能的场合，应当谨慎使用。</p> \n<p>对应的 QueryBuilder class 是 WildcardQueryBuilder</p> \n<p>具体方法是 QueryBuilders.wildcardQuery()</p> \n<p><strong><em>基于词项 API 列表</em></strong></p> \n<table> \n <thead> \n  <tr class=\"header\">\n   <th>Search Query</th>\n   <th>QueryBuilder Class</th>\n   <th>Method in QueryBuilders</th>\n  </tr> \n </thead> \n <tbody> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-term-query.html\">Term</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/TermQueryBuilder.html\">TermQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#termQuery-java.lang.String-java.lang.String-\">QueryBuilders.termQuery()</a></td> \n  </tr> \n  <tr class=\"even\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-terms-query.html\">Terms</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/TermsQueryBuilder.html\">TermsQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#termsQuery-java.lang.String-java.util.Collection-\">QueryBuilders.termsQuery()</a></td> \n  </tr> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-range-query.html\">Range</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/RangeQueryBuilder.html\">RangeQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#rangeQuery-java.lang.String-\">QueryBuilders.rangeQuery()</a></td> \n  </tr> \n  <tr class=\"even\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-exists-query.html\">Exists</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/ExistsQueryBuilder.html\">ExistsQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#existsQuery-java.lang.String-\">QueryBuilders.existsQuery()</a></td> \n  </tr> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-prefix-query.html\">Prefix</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/PrefixQueryBuilder.html\">PrefixQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#prefixQuery-java.lang.String-java.lang.String-\">QueryBuilders.prefixQuery()</a></td> \n  </tr> \n  <tr class=\"even\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-wildcard-query.html\">Wildcard</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/WildcardQueryBuilder.html\">WildcardQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#wildcardQuery-java.lang.String-java.lang.String-\">QueryBuilders.wildcardQuery()</a></td> \n  </tr> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-regexp-query.html\">Regexp</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/RegexpQueryBuilder.html\">RegexpQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#regexpQuery-java.lang.String-java.lang.String-\">QueryBuilders.regexpQuery()</a></td> \n  </tr> \n  <tr class=\"even\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-fuzzy-query.html\">Fuzzy</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/FuzzyQueryBuilder.html\">FuzzyQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#fuzzyQuery-java.lang.String-java.lang.String-\">QueryBuilders.fuzzyQuery()</a></td> \n  </tr> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-type-query.html\">Type</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/TypeQueryBuilder.html\">TypeQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#typeQuery-java.lang.String-\">QueryBuilders.typeQuery()</a></td> \n  </tr> \n  <tr class=\"even\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-ids-query.html\">Ids</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/IdsQueryBuilder.html\">IdsQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#idsQuery--\">QueryBuilders.idsQuery()</a></td> \n  </tr> \n </tbody> \n</table> \n<p><strong>复合查询</strong><br><strong>什么是复合查询？</strong><br>复合查询会将其他的复合查询或者叶查询包裹起来，以嵌套的形式展示和执行，得到的结果也是对各个子查询结果和分数的合并。可以分为下面几种：</p> \n<p><strong>constant_score query</strong></p> \n<p>经常用在使用 filter 的场合，所有匹配的文档分数都是一个不变的常量</p> \n<p><strong>bool query</strong></p> \n<p>可以将多个叶查询和组合查询再组合起来，可接受的参数如下</p> \n<p>must : 文档必须匹配这些条件才能被包含进来<br>must_not 文档必须不匹配才能被包含进来<br>should 如果满足其中的任何语句，都会增加分数；即使不满足，也没有影响<br>filter 以过滤模式进行，不评分，但是必须匹配<br>dis_max query</p> \n<p>叫做分离最大化查询，它会将任何与查询匹配的文档都作为结果返回，但是只是将其中最佳匹配的评分作为最终的评分返回。</p> \n<p><strong>function_score query</strong></p> \n<p>允许为每个与主查询匹配的文档应用一个函数，可用来改变甚至替换原始的评分</p> \n<p><strong>boosting query</strong></p> \n<p>用来控制（提高或降低）复合查询中子查询的权重。</p> \n<table> \n <thead> \n  <tr class=\"header\">\n   <th>Search Query</th>\n   <th>QueryBuilder Class</th>\n   <th>Method in QueryBuilders</th>\n  </tr> \n </thead> \n <tbody> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-constant-score-query.html\">Constant Score</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/ConstantScoreQueryBuilder.html\">ConstantScoreQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#constantScoreQuery-org.elasticsearch.index.query.QueryBuilder-\">QueryBuilders.constantScoreQuery()</a></td> \n  </tr> \n  <tr class=\"even\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-bool-query.html\">Bool</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/BoolQueryBuilder.html\">BoolQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#boolQuery--\">QueryBuilders.boolQuery()</a></td> \n  </tr> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-dis-max-query.html\">Dis Max</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/DisMaxQueryBuilder.html\">DisMaxQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#disMaxQuery--\">QueryBuilders.disMaxQuery()</a></td> \n  </tr> \n  <tr class=\"even\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-function-score-query.html\">Function Score</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/functionscore/FunctionScoreQueryBuilder.html\">FunctionScoreQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#functionScoreQuery-org.elasticsearch.index.query.functionscore.FunctionScoreQueryBuilder.FilterFunctionBuilder:A-\">QueryBuilders.functionScoreQuery()</a></td> \n  </tr> \n  <tr class=\"odd\"> \n   <td><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-boosting-query.html\">Boosting</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/BoostingQueryBuilder.html\">BoostingQueryBuilder</a></td> \n   <td><a href=\"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/6.3.2/org/elasticsearch/index/query/QueryBuilders.html#boostingQuery-org.elasticsearch.index.query.QueryBuilder-org.elasticsearch.index.query.QueryBuilder-\">QueryBuilders.boostingQuery()</a></td> \n  </tr> \n </tbody> \n</table> \n<p><strong>特殊查询</strong><br><strong>Wrapper Query</strong><br>这里比较重要的一个是 Wrapper Query，是说可以接受任何其他 base64 编码的字符串作为子查询。</p> \n<p>主要应用场合就是在 Rest High-Level REST client 中接受 json 字符串作为参数。比如使用 gson 等 json 库将要查询的语句拼接好，直接塞到 Wrapper Query 中查询就可以了，非常方便。</p> \n<p>Wrapper Query 对应的 QueryBuilder class 是WrapperQueryBuilder</p> \n<p>具体方法是 QueryBuilders.wrapperQuery()</p> \n<p><strong>9、关于&nbsp;REST Client的完整工具类代码</strong></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> IndexBean {\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">index name</span>\n    <span style=\"color: #0000ff;\">private</span><span style=\"color: #000000;\"> String index;\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">index type</span>\n    <span style=\"color: #0000ff;\">private</span><span style=\"color: #000000;\"> String indexType;\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">index doc id</span>\n    <span style=\"color: #0000ff;\">private</span><span style=\"color: #000000;\"> String docId;\n    </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 1 IndexRequest 2 UpdateRequest  3 DeleteRequest</span>\n    <span style=\"color: #0000ff;\">private</span><span style=\"color: #000000;\"> String operateType;\n\n    </span><span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> String getOperateType() {\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> operateType;\n    }\n\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> setOperateType(String operateType) {\n        </span><span style=\"color: #0000ff;\">this</span>.operateType =<span style=\"color: #000000;\"> operateType;\n    }\n\n    </span><span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> String getIndex() {\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> index;\n    }\n\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> setIndex(String index) {\n        </span><span style=\"color: #0000ff;\">this</span>.index =<span style=\"color: #000000;\"> index;\n    }\n\n    </span><span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> String getIndexType() {\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> indexType;\n    }\n\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> setIndexType(String indexType) {\n        </span><span style=\"color: #0000ff;\">this</span>.indexType =<span style=\"color: #000000;\"> indexType;\n    }\n\n    </span><span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> String getDocId() {\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> docId;\n    }\n\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> setDocId(String docId) {\n        </span><span style=\"color: #0000ff;\">this</span>.docId =<span style=\"color: #000000;\"> docId;\n    }\n}</span></pre> \n</div> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n * 自定义的es异常类\n </span><span style=\"color: #008000;\">*/</span>\n<span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span> ElasticsearchException <span style=\"color: #0000ff;\">extends</span><span style=\"color: #000000;\"> RuntimeException {\n    </span><span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> ElasticsearchException(String s, Exception e) {\n        </span><span style=\"color: #0000ff;\">super</span><span style=\"color: #000000;\">(s, e);\n    }\n    </span><span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> ElasticsearchException(String s){\n        </span><span style=\"color: #0000ff;\">super</span><span style=\"color: #000000;\">(s);\n    }\n}</span></pre> \n</div> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.apache.http.HttpHost;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.ActionListener;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.bulk.BulkRequest;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.bulk.BulkResponse;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.delete.DeleteRequest;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.delete.DeleteResponse;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.get.GetRequest;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.get.GetResponse;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.index.IndexRequest;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.index.IndexResponse;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.search.SearchRequest;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.search.SearchResponse;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.support.WriteRequest;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.update.UpdateRequest;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.action.update.UpdateResponse;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.client.RestClient;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.client.RestHighLevelClient;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.common.Strings;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.common.unit.TimeValue;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.index.VersionType;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.index.query.MatchQueryBuilder;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.index.query.TermQueryBuilder;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.search.builder.SearchSourceBuilder;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.search.fetch.subphase.FetchSourceContext;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.elasticsearch.search.sort.SortBuilder;\n\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> java.io.IOException;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> java.util.ArrayList;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> java.util.List;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> java.util.Map;\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> java.util.concurrent.TimeUnit;\n\n</span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n * es操作\n *  \n </span><span style=\"color: #008000;\">*/</span>\n<span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> ElasticSearchClient {\n    </span><span style=\"color: #0000ff;\">private</span><span style=\"color: #000000;\"> String[] hostsAndPorts;\n\n    </span><span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> ElasticSearchClient(String[] hostsAndPorts) {\n        </span><span style=\"color: #0000ff;\">this</span>.hostsAndPorts =<span style=\"color: #000000;\"> hostsAndPorts;\n    }\n\n    </span><span style=\"color: #0000ff;\">public</span><span style=\"color: #000000;\"> RestHighLevelClient getClient() {\n        RestHighLevelClient client </span>= <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\n        List</span>&lt;HttpHost&gt; httpHosts = <span style=\"color: #0000ff;\">new</span> ArrayList&lt;HttpHost&gt;<span style=\"color: #000000;\">();\n        </span><span style=\"color: #0000ff;\">if</span> (hostsAndPorts.length &gt; 0<span style=\"color: #000000;\">) {\n            </span><span style=\"color: #0000ff;\">for</span><span style=\"color: #000000;\"> (String hostsAndPort : hostsAndPorts) {\n                String[] hp </span>= hostsAndPort.split(\":\"<span style=\"color: #000000;\">);\n                httpHosts.add(</span><span style=\"color: #0000ff;\">new</span> HttpHost(hp[0], Integer.valueOf(hp[1]), \"http\"<span style=\"color: #000000;\">));\n            }\n            client </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> RestHighLevelClient(\n                    RestClient.builder(httpHosts.toArray(</span><span style=\"color: #0000ff;\">new</span> HttpHost[0<span style=\"color: #000000;\">])));\n        } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n            client </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> RestHighLevelClient(\n                    RestClient.builder(</span><span style=\"color: #0000ff;\">new</span> HttpHost(\"127.0.0.1\", 9200, \"http\"<span style=\"color: #000000;\">)));\n        }\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> client;\n    }\n\n    </span><span style=\"color: #0000ff;\">private</span> IndexRequest getIndexRequest(String index, String indexType, String docId, Map&lt;String, Object&gt;<span style=\"color: #000000;\"> dataMap) {\n        IndexRequest indexRequest </span>= <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">;\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> == index || <span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> indexType) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"index or indexType must not be null\"<span style=\"color: #000000;\">);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> docId) {\n            indexRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> IndexRequest(index, indexType);\n        } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n            indexRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> IndexRequest(index, indexType, docId);\n        }\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> indexRequest;\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 同步执行索引\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> dataMap\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> IndexResponse execIndex(String index, String indexType, String docId, Map&lt;String, Object&gt; dataMap) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().index(getIndexRequest(index, indexType, docId, dataMap).source(dataMap));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 异步执行\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> dataMap\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexResponseActionListener\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span> asyncExecIndex(String index, String indexType, String docId, Map&lt;String, Object&gt; dataMap, ActionListener&lt;IndexResponse&gt; indexResponseActionListener) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        getClient().indexAsync(getIndexRequest(index, indexType, docId, dataMap).source(dataMap), indexResponseActionListener);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> includes  返回需要包含的字段，可以传入空\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> excludes  返回需要不包含的字段，可以传入为空\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> excludes  version\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> excludes  versionType\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n\n    <span style=\"color: #0000ff;\">public</span> GetResponse getRequest(String index, String indexType, String docId, String[] includes, String[] excludes, Integer version, VersionType versionType) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> == includes || includes.length == 0<span style=\"color: #000000;\">) {\n            includes </span>=<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> == excludes || excludes.length == 0<span style=\"color: #000000;\">) {\n            excludes </span>=<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\n        }\n        GetRequest getRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> GetRequest(index, indexType, docId);\n        FetchSourceContext fetchSourceContext </span>= <span style=\"color: #0000ff;\">new</span> FetchSourceContext(<span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">, includes, excludes);\n        getRequest.realtime(</span><span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">);\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> version) {\n            getRequest.version(version);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> versionType) {\n            getRequest.versionType(versionType);\n        }\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().get(getRequest.fetchSourceContext(fetchSourceContext));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> includes\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> excludes\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n\n    <span style=\"color: #0000ff;\">public</span> GetResponse getRequest(String index, String indexType, String docId, String[] includes, String[] excludes) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span> getRequest(index, indexType, docId, includes, excludes, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> GetResponse getRequest(String index, String indexType, String docId) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        GetRequest getRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> GetRequest(index, indexType, docId);\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().get(getRequest);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> Boolean existDoc(String index, String indexType, String docId) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        GetRequest getRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> GetRequest(index, indexType, docId);\n        getRequest.fetchSourceContext(</span><span style=\"color: #0000ff;\">new</span> FetchSourceContext(<span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">));\n        getRequest.storedFields(</span>\"_none_\"<span style=\"color: #000000;\">);\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().exists(getRequest);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> timeValue\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> refreshPolicy\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> version\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> versionType\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> DeleteResponse deleteDoc(String index, String indexType, String docId, TimeValue timeValue, WriteRequest.RefreshPolicy refreshPolicy, Integer version, VersionType versionType) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        DeleteRequest deleteRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> DeleteRequest(index, indexType, docId);\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> timeValue) {\n            deleteRequest.timeout(timeValue);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> refreshPolicy) {\n            deleteRequest.setRefreshPolicy(refreshPolicy);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> version) {\n            deleteRequest.version(version);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> versionType) {\n            deleteRequest.versionType(versionType);\n        }\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().delete(deleteRequest);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> DeleteResponse deleteDoc(String index, String indexType, String docId) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span> deleteDoc(index, indexType, docId, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> dataMap\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> timeValue\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> refreshPolicy\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> version\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> versionType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docAsUpsert\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> includes\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> excludes\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> UpdateResponse updateDoc(String index, String indexType, String docId, Map&lt;String, Object&gt; dataMap, TimeValue timeValue, WriteRequest.RefreshPolicy refreshPolicy, Integer version, VersionType versionType, Boolean docAsUpsert, String[] includes, String[] excludes) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        UpdateRequest updateRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> UpdateRequest(index, indexType, docId);\n        updateRequest.doc(dataMap);\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> timeValue) {\n            updateRequest.timeout(timeValue);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> refreshPolicy) {\n            updateRequest.setRefreshPolicy(refreshPolicy);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> version) {\n            updateRequest.version(version);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> versionType) {\n            updateRequest.versionType(versionType);\n        }\n        updateRequest.docAsUpsert(docAsUpsert);\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">冲突时重试的次数</span>\n        updateRequest.retryOnConflict(3<span style=\"color: #000000;\">);\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> == includes &amp;&amp; <span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> excludes) {\n            </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().update(updateRequest);\n        } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n            </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> == includes || includes.length == 0<span style=\"color: #000000;\">) {\n                includes </span>=<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\n            }\n            </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> == excludes || excludes.length == 0<span style=\"color: #000000;\">) {\n                excludes </span>=<span style=\"color: #000000;\"> Strings.EMPTY_ARRAY;\n            }\n            </span><span style=\"color: #0000ff;\">return</span> getClient().update(updateRequest.fetchSource(<span style=\"color: #0000ff;\">new</span> FetchSourceContext(<span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">, includes, excludes)));\n        }\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 更新时不存在就插入\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> dataMap\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> UpdateResponse upDdateocAsUpsert(String index, String indexType, String docId, Map&lt;String, Object&gt; dataMap) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span> updateDoc(index, indexType, docId, dataMap, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">true</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 存在才更新\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> docId\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> dataMap\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> UpdateResponse updateDoc(String index, String indexType, String docId, Map&lt;String, Object&gt; dataMap) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span> updateDoc(index, indexType, docId, dataMap, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">false</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 批量操作\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexBeanList\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> timeValue\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> refreshPolicy\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> BulkResponse bulkRequest(List&lt;IndexBean&gt; indexBeanList, TimeValue timeValue, WriteRequest.RefreshPolicy refreshPolicy) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        BulkRequest bulkRequest </span>=<span style=\"color: #000000;\"> getBulkRequest(indexBeanList);\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> timeValue) {\n            bulkRequest.timeout(timeValue);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> refreshPolicy) {\n            bulkRequest.setRefreshPolicy(refreshPolicy);\n        }\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().bulk(bulkRequest);\n    }\n\n    </span><span style=\"color: #0000ff;\">private</span> BulkRequest getBulkRequest(List&lt;IndexBean&gt;<span style=\"color: #000000;\"> indexBeanList) {\n        BulkRequest bulkRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> BulkRequest();\n        indexBeanList.forEach(indexBean </span>-&gt;<span style=\"color: #000000;\"> {\n            </span><span style=\"color: #0000ff;\">if</span> (\"1\"<span style=\"color: #000000;\">.equals(indexBean.getOperateType())) {\n                bulkRequest.add(</span><span style=\"color: #0000ff;\">null</span> != indexBean.getDocId() ? <span style=\"color: #0000ff;\">new</span> IndexRequest(indexBean.getIndex(), indexBean.getIndexType(), indexBean.getDocId()) : <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> IndexRequest(indexBean.getIndex(), indexBean.getIndexType()));\n            } </span><span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (\"2\"<span style=\"color: #000000;\">.equals(indexBean.getOperateType())) {\n                </span><span style=\"color: #0000ff;\">if</span> ((<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> indexBean.getDocId())) {\n                    </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"update action docId must not be null\"<span style=\"color: #000000;\">);\n                }\n                bulkRequest.add(</span><span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> UpdateRequest(indexBean.getIndex(), indexBean.getIndexType(), indexBean.getDocId()));\n            } </span><span style=\"color: #0000ff;\">else</span> <span style=\"color: #0000ff;\">if</span> (\"3\"<span style=\"color: #000000;\">.equals(indexBean.getOperateType())) {\n                </span><span style=\"color: #0000ff;\">if</span> ((<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> indexBean.getDocId())) {\n                    </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"delete action docId must not be null\"<span style=\"color: #000000;\">);\n                }\n                bulkRequest.add(</span><span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> DeleteRequest(indexBean.getIndex(), indexBean.getIndexType(), indexBean.getDocId()));\n            } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n                </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"OperateType\" + indexBean.getOperateType() + \"is not support\"<span style=\"color: #000000;\">);\n            }\n        });\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> bulkRequest;\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 批量操作\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexBeanList\n     * </span><span style=\"color: #808080;\">@return</span>\n     <span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> BulkResponse bulkRequest(List&lt;IndexBean&gt; indexBeanList) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span> bulkRequest(indexBeanList, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 批量异步操作\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexBeanList\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> bulkResponseActionListener\n     </span><span style=\"color: #008000;\">*/</span>\n\n    <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span> AsyncBulkRequest(List&lt;IndexBean&gt; indexBeanList, ActionListener&lt;BulkResponse&gt;<span style=\"color: #000000;\"> bulkResponseActionListener) {\n        getClient().bulkAsync(getBulkRequest(indexBeanList), bulkResponseActionListener);\n    }\n\n\n    </span><span style=\"color: #0000ff;\">private</span><span style=\"color: #000000;\"> SearchRequest getSearchRequest(String index, String indexType) {\n        SearchRequest searchRequest;\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> index) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"index name must not be null\"<span style=\"color: #000000;\">);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> indexType) {\n            searchRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SearchRequest(index, indexType);\n        } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n            searchRequest </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SearchRequest(index);\n        }\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> searchRequest;\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> SearchResponse searchRequest(String index, String indexType) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> getClient().search(getSearchRequest(index, indexType));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> termQueryBuilder\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> SearchResponse searchRequest(String index, String indexType, Integer from, Integer size, TermQueryBuilder termQueryBuilder) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">return</span> getClient().search(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, termQueryBuilder, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">)));\n    }\n\n    </span><span style=\"color: #0000ff;\">private</span><span style=\"color: #000000;\"> SearchSourceBuilder getSearchSourceBuilder(String index, String indexType, Integer from, Integer size, TermQueryBuilder termQueryBuilder, String sortField, SortBuilder sortBuilder, Boolean fetchSource) {\n        SearchSourceBuilder searchSourceBuilder </span>= <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> SearchSourceBuilder();\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> termQueryBuilder) {\n            searchSourceBuilder.query(termQueryBuilder);\n        }\n        searchSourceBuilder.from(from);\n        searchSourceBuilder.size(size);\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> sortField) {\n            searchSourceBuilder.sort(sortField);\n        }\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> sortBuilder) {\n            searchSourceBuilder.sort(sortBuilder);\n        }\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">设置超时时间</span>\n        searchSourceBuilder.timeout(<span style=\"color: #0000ff;\">new</span> TimeValue(120<span style=\"color: #000000;\">, TimeUnit.SECONDS));\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> !=<span style=\"color: #000000;\"> fetchSource) {\n            searchSourceBuilder.fetchSource(fetchSource);\n        }\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> searchSourceBuilder;\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> termQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> matchQueryBuilder\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> SearchResponse searchRequest(String index, String indexType, Integer from, Integer size, TermQueryBuilder termQueryBuilder, MatchQueryBuilder matchQueryBuilder) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> matchQueryBuilder) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"matchQueryBuilder is null\"<span style=\"color: #000000;\">);\n        }\n        </span><span style=\"color: #0000ff;\">return</span> getClient().search(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, termQueryBuilder, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">).query(matchQueryBuilder)));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> matchQueryBuilder\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> SearchResponse searchRequest(String index, String indexType, Integer from, Integer size, MatchQueryBuilder matchQueryBuilder) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> matchQueryBuilder) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"matchQueryBuilder is null\"<span style=\"color: #000000;\">);\n        }\n        </span><span style=\"color: #0000ff;\">return</span> getClient().search(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">).query(matchQueryBuilder)));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> matchQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> sortField\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> SearchResponse searchRequest(String index, String indexType, Integer from, Integer size, MatchQueryBuilder matchQueryBuilder, String sortField) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> matchQueryBuilder) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"matchQueryBuilder is null\"<span style=\"color: #000000;\">);\n        }\n        </span><span style=\"color: #0000ff;\">return</span> getClient().search(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, <span style=\"color: #0000ff;\">null</span>, sortField, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">).query(matchQueryBuilder)));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> matchQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> sortField\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> fetchSource\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> SearchResponse searchRequest(String index, String indexType, Integer from, Integer size, MatchQueryBuilder matchQueryBuilder, String sortField, Boolean fetchSource) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> matchQueryBuilder) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"matchQueryBuilder is null\"<span style=\"color: #000000;\">);\n        }\n        </span><span style=\"color: #0000ff;\">return</span> getClient().search(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, <span style=\"color: #0000ff;\">null</span>, sortField, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">, fetchSource).query(matchQueryBuilder)));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> matchQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> sortBuilder\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> SearchResponse searchRequest(String index, String indexType, Integer from, Integer size, MatchQueryBuilder matchQueryBuilder, SortBuilder sortBuilder) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> matchQueryBuilder) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"matchQueryBuilder is null\"<span style=\"color: #000000;\">);\n        }\n        </span><span style=\"color: #0000ff;\">return</span> getClient().search(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span>, sortBuilder, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">).query(matchQueryBuilder)));\n    }\n\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 支持排序\n     *\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> termQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> matchQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> sortField\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> SearchResponse searchRequest(String index, String indexType, Integer from, Integer size, TermQueryBuilder termQueryBuilder, MatchQueryBuilder matchQueryBuilder, String sortField) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> matchQueryBuilder) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"matchQueryBuilder is null\"<span style=\"color: #000000;\">);\n        }\n        </span><span style=\"color: #0000ff;\">return</span> getClient().search(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, termQueryBuilder, sortField, <span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">).query(matchQueryBuilder)));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> termQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> matchQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> sortBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> fetchSource       开关\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> SearchResponse searchRequest(String index, String indexType, Integer from, Integer size, TermQueryBuilder termQueryBuilder, MatchQueryBuilder matchQueryBuilder, SortBuilder sortBuilder, Boolean fetchSource) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> matchQueryBuilder) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"matchQueryBuilder is null\"<span style=\"color: #000000;\">);\n        }\n        </span><span style=\"color: #0000ff;\">return</span> getClient().search(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, termQueryBuilder, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">, sortBuilder, fetchSource).query(matchQueryBuilder)));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> termQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> matchQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> sortBuilder\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> SearchResponse searchRequest(String index, String indexType, Integer from, Integer size, TermQueryBuilder termQueryBuilder, MatchQueryBuilder matchQueryBuilder, SortBuilder sortBuilder) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> matchQueryBuilder) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"matchQueryBuilder is null\"<span style=\"color: #000000;\">);\n        }\n        </span><span style=\"color: #0000ff;\">return</span> getClient().search(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, termQueryBuilder, <span style=\"color: #0000ff;\">null</span>, sortBuilder, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">).query(matchQueryBuilder)));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> termQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> matchQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> sortField\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> fetchSource\n     * </span><span style=\"color: #808080;\">@return</span><span style=\"color: #008000;\">\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> SearchResponse searchRequest(String index, String indexType, Integer from, Integer size, TermQueryBuilder termQueryBuilder, MatchQueryBuilder matchQueryBuilder, String sortField, Boolean fetchSource) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> matchQueryBuilder) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"matchQueryBuilder is null\"<span style=\"color: #000000;\">);\n        }\n        </span><span style=\"color: #0000ff;\">return</span> getClient().search(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, termQueryBuilder, sortField, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">, fetchSource).query(matchQueryBuilder)));\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 异步操作\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> termQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> matchQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> sortBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> listener\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n\n    <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span> asyncSearchRequest(String index, String indexType, Integer from, Integer size, TermQueryBuilder termQueryBuilder, MatchQueryBuilder matchQueryBuilder, SortBuilder sortBuilder,ActionListener&lt;SearchResponse&gt; listener) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> matchQueryBuilder) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"matchQueryBuilder is null\"<span style=\"color: #000000;\">);\n        }\n        getClient().searchAsync(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, termQueryBuilder, </span><span style=\"color: #0000ff;\">null</span>, sortBuilder, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">).query(matchQueryBuilder)),listener);\n    }\n\n    </span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\n     * 异步操作\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> index\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> indexType\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> from\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> size\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> termQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> matchQueryBuilder\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> sortField\n     * </span><span style=\"color: #808080;\">@param</span><span style=\"color: #008000;\"> listener\n     * </span><span style=\"color: #808080;\">@throws</span><span style=\"color: #008000;\"> IOException\n     </span><span style=\"color: #008000;\">*/</span>\n    <span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span> asyncSearchRequest(String index, String indexType, Integer from, Integer size, TermQueryBuilder termQueryBuilder, MatchQueryBuilder matchQueryBuilder, String sortField,ActionListener&lt;SearchResponse&gt; listener) <span style=\"color: #0000ff;\">throws</span><span style=\"color: #000000;\"> IOException {\n        </span><span style=\"color: #0000ff;\">if</span> (<span style=\"color: #0000ff;\">null</span> ==<span style=\"color: #000000;\"> matchQueryBuilder) {\n            </span><span style=\"color: #0000ff;\">throw</span> <span style=\"color: #0000ff;\">new</span> ElasticsearchException(\"matchQueryBuilder is null\"<span style=\"color: #000000;\">);\n        }\n        getClient().searchAsync(getSearchRequest(index, indexType).source(getSearchSourceBuilder(index, indexType, from, size, termQueryBuilder, sortField, </span><span style=\"color: #0000ff;\">null</span>, <span style=\"color: #0000ff;\">null</span><span style=\"color: #000000;\">).query(matchQueryBuilder)),listener);\n    }\n<span style=\"font-size: 14pt;\">}</span></span></pre> \n</div> \n<p><span style=\"font-size: 18pt;\"><strong>二、transportClient API</strong></span></p> \n<p><span style=\"font-size: 18px;\">未完待续，近期继续整理</span></p> \n<p>&nbsp;</p>', 'Elasticsearch 的API 分为 REST Client API（http请求形式）以及 transportClient API两种。相比来说transportClient API效率更高，transportClient 是通过Elasticsearch内部RPC的形式进行请求的，连接可以是一个长连', '2019-10-17 17:37:06', 5, 6, 'ES', 'https://www.cnblogs.com/laoqing/p/11693144.html', 1, '2020-05-26 11:38:13');
INSERT INTO `t_blog` VALUES (254, 'Java读源码之LockSupport', '<h2 id=\"前言\">前言</h2> \n<blockquote> \n <p>JDK版本: 1.8</p> \n</blockquote> \n<h3 id=\"作用\">作用</h3> \n<p>LockSupport类主要提供了park和unpark两个native方法，用于阻塞和唤醒线程。注释中有这么一段：</p> \n<p><strong>这个类是为拥有更高级别抽象的并发类服务的，开发中我们不会用到这个类</strong></p> \n<p>既然只是native方法，开发中也用不到，那么还有必要去看么？</p> \n<p>了解LockSupport可以帮助我们更好理解并发，而且大家熟悉的并发中最核心的AQS类中也大量的使用了LockSupport，所以还是有必要看一看的，至少熟悉其中的概念。</p> \n<h3 id=\"为什么需要locksupport\">为什么需要LockSupport</h3> \n<p>已经知道了这个类就是阻塞唤醒，Object.wait和Object.notify，Thread.suspend和Thread.resume这两对方法也是类似效果，那么还有必要去看么？？？</p> \n<h4 id=\"thread.suspend和thread.resume为什么被弃用\">Thread.suspend和Thread.resume为什么被弃用</h4> \n<ul> \n <li>suspend将线程挂起，从运行状态阻塞状态，但是并不释放所占用的锁</li> \n <li>suspend方法至少已经满足互斥，不可剥夺两个死锁的条件了</li> \n <li>resume将线程解除挂起，从阻塞状态到运行状态，通常是等待其他任务完成， 请求与保持条件也成立了</li> \n <li>最后只差 循环等待条件 就死锁了，这实在太危险了，一不小心就容易死锁，而且死锁的问题是很难排查的</li> \n</ul> \n<h4 id=\"object.wait和object.notify存在什么问题\">Object.wait和Object.notify存在什么问题</h4> \n<ul> \n <li>不满足条件时我们需要在代码中保证拿到锁才能调用，把线程放到等待队列中</li> \n <li>notify是从等待池中随机放一个线程出来，当需要唤醒特定线程时，只能notifyAll</li> \n</ul> \n<p>LockSupport会有上面的问题么，又有哪些特点呢，让我们进入源码</p> \n<h2 id=\"源码\">源码</h2> \n<h3 id=\"类声明和属性\">类声明和属性</h3> \n<pre class=\"java\"><code>package java.util.concurrent.locks;\n\npublic class LockSupport {\n    // 工具类，ban掉构造\n    private LockSupport() {}\n    \n    private static final sun.misc.Unsafe UNSAFE;\n    // parkBlocker的内存偏移量\n    private static final long parkBlockerOffset;\n    private static final long SEED;\n    private static final long PROBE;\n    private static final long SECONDARY;\n    static {\n        try {\n            UNSAFE = sun.misc.Unsafe.getUnsafe();\n            Class&lt;?&gt; tk = Thread.class;\n            // 反射拿到Thread类中的parkBlocker属性，然后获取其在内存中的偏移量\n            parkBlockerOffset = UNSAFE.objectFieldOffset\n                (tk.getDeclaredField(\"parkBlocker\"));\n            SEED = UNSAFE.objectFieldOffset\n                (tk.getDeclaredField(\"threadLocalRandomSeed\"));\n            PROBE = UNSAFE.objectFieldOffset\n                (tk.getDeclaredField(\"threadLocalRandomProbe\"));\n            SECONDARY = UNSAFE.objectFieldOffset\n                (tk.getDeclaredField(\"threadLocalRandomSecondarySeed\"));\n        } catch (Exception ex) { throw new Error(ex); }\n    }\n\n}</code></pre> \n<h3 id=\"park\">park()</h3> \n<pre class=\"java\"><code>// 最简单的方式，但是不推荐\npublic static void park() {\n    /**\n     * 将当前线程挂起，是通过二元信号量，获取许可证实现的，拿到许可证后才执行挂起\n     * 不是基于对象的监视器锁，所以不需要显示的同步\n     * 如果超时了，被中断了或者unpark了就会return并且释放许可证\n     * 需要注意的是和wait一样也会因为JVM内部未知原因return，所以我们如果使用也需要放在循环内\n     * 第一个参数 flase代表纳秒级别超时控制，此级别下第二个参数timeout为0代表无限等待\n     * 第一个参数 true代表毫秒级别超时控制，此级别下第二个参数timeout为0会立即返回\n     */ \n    UNSAFE.park(false, 0L);\n}\n\n// 推荐方式，blocker是个辅助对象，用于跟踪许可证的获取，以及定位一些阻塞问题，一般情况park(this)就行\npublic static void park(Object blocker) {\n    Thread t = Thread.currentThread();\n    // 标记对于当前线程t，blocker正在获取许可证，出问题通过getBlocker方法去定位\n    setBlocker(t, blocker);\n    UNSAFE.park(false, 0L);\n    // park操作return了，标记许可证已经释放\n    setBlocker(t, null);\n}\n\nprivate static void setBlocker(Thread t, Object arg) {\n    // 通过偏移量，把给当前线程t的parkBlocker属性赋值为arg\n    UNSAFE.putObject(t, parkBlockerOffset, arg);\n}</code></pre> \n<p>相信大家已经基本了解park操作了，LockSupport还给我们提供了其他功能</p> \n<pre class=\"java\"><code>// 推荐，纳秒级别timeout后return\npublic static void parkNanos(Object blocker, long nanos) {\n    if (nanos &gt; 0) {\n        Thread t = Thread.currentThread();\n        setBlocker(t, blocker);\n        UNSAFE.park(false, nanos);\n        setBlocker(t, null);\n    }\n}\n\n// 推荐，毫秒级别timeout后return\npublic static void parkUntil(Object blocker, long deadline) {\n    Thread t = Thread.currentThread();\n    setBlocker(t, blocker);\n    UNSAFE.park(true, deadline);\n    setBlocker(t, null);\n}\n\n// 不推荐，纳秒级别timeout后return\npublic static void parkNanos(long nanos) {\n    if (nanos &gt; 0)\n        UNSAFE.park(false, nanos);\n}\n\n// 不推荐，毫秒级别timeout后return\npublic static void parkUntil(long deadline) {\n    UNSAFE.park(true, deadline);\n}</code></pre> \n<h3 id=\"unpark\">unpark</h3> \n<pre class=\"java\"><code>public static void unpark(Thread thread) {\n    if (thread != null)     \n        //释放线程thread的许可证，如果已经是释放状态那就什么都不会发生，因为总共就1个许可，所以unpark可以先于park执行没有任务问题\n        UNSAFE.unpark(thread);\n}</code></pre> \n<h3 id=\"其他方法\">其他方法</h3> \n<pre class=\"java\"><code>// 由于包权限问题从ThreadLocalRandom类中copy过来的，用于生成随机数种子\nstatic final int nextSecondarySeed() {\n    int r;\n    Thread t = Thread.currentThread();\n    if ((r = UNSAFE.getInt(t, SECONDARY)) != 0) {\n        r ^= r &lt;&lt; 13;   // xorshift\n        r ^= r &gt;&gt;&gt; 17;\n        r ^= r &lt;&lt; 5;\n    }\n    else if ((r = java.util.concurrent.ThreadLocalRandom.current().nextInt()) == 0)\n        r = 1; // avoid zero\n    UNSAFE.putInt(t, SECONDARY, r);\n    return r;\n}</code></pre> \n<h2 id=\"实践\">实践</h2> \n<pre class=\"java\"><code>public class LockSupportTest {\n    \n    public static void main(String[] args) {\n        AtomicBoolean flag = new AtomicBoolean(true);\n        Thread thread = new Thread(() -&gt; {\n            Thread curr = Thread.currentThread();\n            System.out.println(\"线程1 即将被阻塞\");\n            while (flag.get()) {\n                LockSupport.park(curr);\n                System.out.println(\"线程1 复活\");\n            }\n            System.out.println(\"线程1 结束使命\");\n        });\n        thread.start();\n\n        new Thread(() -&gt; {\n            System.out.println(\"唤醒线程1\");\n            flag.compareAndSet(true, false);\n            LockSupport.unpark(thread);\n        }).start();\n    }\n    \n    /**\n     * 输出：\n     * 线程1 即将被阻塞\n     * 唤醒线程1\n     * 线程1 复活\n     * 线程1 结束使命\n     */\n}\n\n</code></pre>', NULL, '2019-10-17 17:37:06', 0, NULL, NULL, 'https://www.cnblogs.com/freshchen/p/11692952.html', 0, NULL);
INSERT INTO `t_blog` VALUES (255, '浏览器的同源策略和跨域详解（内含故事解析）', '<h3 id=\"前言\">前言</h3> \n<p>去年这个时候有写过一篇文章叫<a href=\"https://www.cnblogs.com/Juaoie/p/9786313.html\">《ajax中的json和jsonp详解》</a>，写这个文章是因为我朋友学习前端刚好遇到了这个问题，但是就在昨天，他在学习java的时候又遇到同样的问题，看来我又要操作一波了。（实则我就他这一个朋友）(๑￫ܫ￩)</p> \n<h6 id=\"提纲内容\">提纲内容</h6> \n<ul> \n <li>重述一遍何为同源策略(因为之前讲过)</li> \n <li>跨域的三种方式</li> \n <li>剖析CORS方式跨域（重点）</li> \n <li>故事解析（次重点）</li> \n</ul> \n<h3 id=\"何为同源策略\">何为同源策略</h3> \n<p>同源策略就是协议相同、域名相同、端口相同相同的网页才能资源互通。<br> 简单的来说，分为三个，我访问淘宝网站，再访问京东网站，这两者资源肯定不能互通是吧。<br> 1、也就是cookie和LocalStorage、IndexDB等无法互通。<br> 2、DOM无法获取<br> 3、AJAX 请求在浏览器端有跨域限制</p> \n<p>也就是说几乎所有的请求都会跨域，why？主要还不是因为很多公司为了解决web访问对后台造成压力，都会把web服务器和后台接口服务器分到不同的域中，前后端不分离除外，另一个原因是前端开发人员调用后台测试，测试服务器在后台，web却运行在自己电脑上。一个是localhost，一个是对应测试服务器的域名。</p> \n<h3 id=\"跨域的三种方式\">跨域的三种方式</h3> \n<ul> \n <li><a href=\"https://www.cnblogs.com/Juaoie/p/9786313.html\">JSONP方式</a></li> \n <li>CORS方式</li> \n <li>代理请求方式</li> \n</ul> \n<h3 id=\"剖析cors方式跨域\">剖析CORS方式跨域</h3> \n<p>CORS是一个W3C标准，全称是\"跨域资源共享\"（Cross-origin resource sharing）</p> \n<p>CORS可以理解为后端配置一些东西，主动同意哪些不同域名可以请求我的接口，从而实现跨域请求的问题，（对了，提示一下，jsonp虽然简单好用，但是只能实现get请求，所以比较单一。但是jsonp可以适用于所有浏览器，CORS对ie只适用于ie10及以上，对其他浏览器都是支持的。）</p> \n<p>先上一张图（后面你会回来看的）</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/e56e7af9-8c44-46fd-922d-b1e2ec029908.png\"></p> \n<!--more--> \n<p>浏览器将cors请求分为两类，简单请求和非简单请求，阮一峰在<a href=\"http://www.ruanyifeng.com/blog/2016/04/cors.html\">跨域资源共享 CORS 详解</a>一文中作了很详细的区分，满足一下两大条件就是简单请求，否则就是非简单请求。如下：</p> \n<pre><code>1、请求方法是以下三种方法之一：\n* HEAD\n* GET\n* POST\n2、HTTP的头信息不超出以下几种字段：\n* Accept\n* Accept-Language\n* Content-Language\n* Last-Event-ID\n* Content-Type：只限于三个值application/x-www-form-urlencoded、multipart/form-data、text/plain</code></pre> \n<h4 id=\"简单请求按钮我朋友写的就是简单请求但是服务器并没有做cors配置请求如下\">简单请求按钮（我朋友写的就是简单请求，但是服务器并没有做cors配置），请求如下：</h4> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/38231c21-2eef-4cde-8d4e-9d29c27e7263.png\"></p> \n<p>如第一张图的执行流程，会在请求头增加Origin字段为\"http ://localhost\"到后端，后端去检测Origin信息，此时检查的请求头部有没有自定义的，那么问题来了。<br> 1、为毛要再次检查请求头？因为你前端信息为不可信信息，别人可以伪造浏览器请求加入Origin信息，并且自定义请求头。<br> 2、自定义请求头有哪些定义有哪些？</p> \n<ul> \n <li><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept\">Accept</a>:用来告知（服务器）客户端可以处理的内容类型</li> \n <li><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Language\">Accept-Language</a>:允许客户端声明它可以理解的自然语言，以及优先选择的区域方言</li> \n <li><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Language\">Content-Language</a>:是一个 entity header （实体消息首部），用来说明访问者希望采用的语言或语言组合，这样的话用户就可以根据自己偏好的语言来定制不同的内容</li> \n <li><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type\">Content-Type</a>实体头部用于指示资源的MIME类型 media type（不属于简单请求的三个的任何一个）</li> \n <li>DPR</li> \n <li>Downlink</li> \n <li>Save-Data</li> \n <li>Viewport-Width</li> \n <li>Width</li> \n</ul> \n<p>他调这个接口的时候并没有自定义头部，只有设置了Content-Type为application/x-www-form-urlencoded，但是这并不影响，所以现在到了判断是否符合要求的位置，什么符合要求呢？但是当然是跨源资源共享验证，但是他后台并没有配置任何的跨域访问，所以所有的跨域请求多会被拒绝门外，但是信息是正常返回的，只不过返回头里面没有加Access-Control-Allow-Origin这个字段，如图一所示。<br> 这是时候会发生什么情况呢？截两张图就知道了。<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/b8ffd9ac-b119-4f3f-b939-0754b990d472.png\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/558f5ccf-6dbf-4ee4-9599-6bcc692eb8e3.png\"></p> \n<p>what？<br> 浏览器确实收到消息，但是他就是不给你，并且告诉你，你小子跨域了，并且服务器不同意你的跨域请求，所以就直接抛一个错误给你，你自己看着办吧！</p> \n<h4 id=\"非简单请求步骤就多了一步\">非简单请求步骤就多了一步</h4> \n<p>在不满足简单请求的情况之下（就是非简单请求），此时，如图一所示，并不直接发送请求，而是发送一个OPTIONS预检请求（所以下次看到OPTIONS请求的时候就知道这其实是一个前菜，好戏在后头呢。嘻嘻），后台也是去做一个跨源资源共享验证，他这里没有配置，当然不成功，所以还是正常返回，这次返回头里不仅不给返回Access-Control-Allow-Origin，而且不会有任何响应主体（如果你不配置的话），这也就是为啥后来他胡乱配置一通后发现post请求竟然变成OPTIONS请求了，然后不传数据还不给返回数据的原因。请求视图如下：<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/1c783206-634a-4ebd-a38f-92bf8afc6c7d.png\"></p> \n<p>(细心了小伙伴会发现多了两个字段，一看就明白，不用解释了。嘻嘻)</p> \n<h4 id=\"怕他看不懂所以这里也用一个小故事稍微解析一下子\">怕他看不懂，所以这里也用一个小故事稍微解析一下子</h4> \n<p>首先来建立三个角色，小明（请求代码，也可以说是开发者）、课代表（浏览器）、老师（服务器）</p> \n<ul> \n <li><p>简单请求：<br> 小明（请求代码）做了一份试卷（请求包）交给课代表（浏览器），课代表分析得出，这是一份简单试卷（简单请求），然后写上这是这是一班的试卷（加上Origin字段），并且告诉老师这是一份简单试卷，老师（服务器）拿到试卷后，就开始阅读。<br> 首先看这个题（请求头部），是不是简单的试卷，毕竟课代表说的话不可信。<br> 如果不简单就直接丢了，如果是简单试卷就再看看课代表写的是几班的试卷。<br> 老师说我只改一班和三班的试卷（跨源资源共享验证），刚好这是一班的试卷，所以就改完直接还给课代表了，课代表发现没有异样就直接给小明了。<br> 如果这不巧是二班的试卷，老师还是把试卷给改出来（服务器返回正常的结果），但是同时在试卷上加上一句话，“我是一班和三班的老师，以后不要发二班的试卷给我了（返回头中没有Access-Control-Allow-Origin字段）”。<br> 课代表大发雷霆，不仅不把试卷（服务器正常结果）给小明，还警告小明（抛出错误）。</p></li> \n <li><p>非简答请求：<br> 小明（请求代码）做了一份试卷（请求包）交给课代表（浏览器），课代表分析得出，这是一份很难的试卷（非简单请求），然后课代表写一封信（OPTIONS请求，里面写上这是一班的试卷）给老师。<br> 老师收到这封信，老师改一班和三班的试卷，所以就批改这封信（后台设置返回的信息，不设置是没有返回主体的），ok，没问题，请把试卷给我（返回头中有Access-Control-Allow-Origin字段）。<br> 然后课代表发现信没有异样，后面的流程就像批改简单试卷流程一样了。<br> 如果，课代表发送的信里写这的是“这是二班的试卷”，那么，老师还是会批改这封信，然后正常返回这封信。关键是老师又加上那句话“我是一班和三班的老师，以后不要发二班的试卷给我了（返回头中没有Access-Control-Allow-Origin字段）”，所以，试卷根本就没有发给老师。</p></li> \n <li><p>注意<br> 简单请求是只有一次请求的，非简单请求是两次请求。然后一切都透彻了啊！</p></li> \n</ul>', NULL, '2019-10-17 17:37:07', 0, NULL, NULL, 'https://www.cnblogs.com/Juaoie/p/11692819.html', 0, NULL);
INSERT INTO `t_blog` VALUES (256, 'Java 操作Word表格——创建嵌套表格、添加/复制表格行或列、设置表格是否禁止跨页断行', '<p>本文将对如何在Java程序中操作Word表格作进一步介绍。操作要点包括</p> \n<ul> \n <li>如何在Word中创建嵌套表格、</li> \n <li>对已有表格添加行或者列</li> \n <li>复制已有表格中的指定行或者列</li> \n <li>对跨页的表格可设置是否禁止跨页断行</li> \n</ul> \n<p>&nbsp;创建表格，包括添加数据、插入表格、合并单元格、设置表格样式、单元格居中、单元格背景色，单元格字体样式等设置，可参考这篇<span style=\"color: #0000ff;\"><a href=\"https://www.cnblogs.com/Yesi/p/10937812.html\" target=\"_blank\"><span style=\"color: #0000ff;\">文章</span></a></span>里的内容。</p> \n<hr> \n<p>&nbsp;</p> \n<h3><strong>使用工具：<span style=\"color: #008000;\">Free Spire.Doc for Java （免费版）</span></strong></h3> \n<p>Jar文件可通过官网<span style=\"color: #3366ff;\"><a href=\"https://www.e-iceblue.cn/Introduce/Free-Spire-Doc-JAVA.html\" target=\"_blank\"><span style=\"color: #3366ff;\">下载jar</span></a></span>文件包，下载后，解压文件，将lib文件夹下的Spire.Doc.jar导入Java程序；也可以在maven项目中通过<span style=\"color: #3366ff;\"><a href=\"http://repo.e-iceblue.com/nexus/content/groups/public/e-iceblue/\" target=\"_blank\"><span style=\"color: #3366ff;\">maven</span></a></span>仓库<span style=\"color: #3366ff;\"><a href=\"https://www.e-iceblue.cn/licensing/install-spirepdf-for-java-from-maven-repository.html\" target=\"_blank\"><span style=\"color: #3366ff;\">安装导入</span></a></span>。</p> \n<hr> \n<p>&nbsp;</p> \n<h3>【添加Word嵌套表格】</h3> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">import</span> com.spire.doc.*<span style=\"color: #000000;\">;\r\n</span><span style=\"color: #0000ff;\">import</span> com.spire.doc.documents.*<span style=\"color: #000000;\">;\r\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> com.spire.doc.fields.TextRange;\r\n\r\n\r\n</span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> NestedTable {\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> main(String[]args){\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">加载测试文档</span>\r\n        Document doc = <span style=\"color: #0000ff;\">new</span> Document(\"sample.docx\"<span style=\"color: #000000;\">);\r\n        \r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">获取指定表格中的单元格，并设置行高、列宽</span>\r\nSection sec = doc.getSections().get(0<span style=\"color: #000000;\">);\r\n        Table table </span>= sec.getTables().get(0<span style=\"color: #000000;\">);\r\n        table.getRows().get(</span>0<span style=\"color: #000000;\">).setHeight(120f);\r\n        table.getRows().get(</span>0).getCells().get(0).setWidth(380<span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">添加嵌套表格到指定单元格</span>\r\n        Table nestedtable = table.get(0,0).addTable(<span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">);\r\n        nestedtable.getTableFormat().setHorizontalAlignment(RowAlignment.Center);</span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">设置嵌套表格在单元格中的对齐方式</span>\r\n        nestedtable.resetCells(4,4);<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">指定嵌套表格行数、列数</span>\r\n        nestedtable.autoFit(AutoFitBehaviorType.Auto_Fit_To_Contents);<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">设置嵌套表格内容自适应方法\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">声明表格数组内容</span>\r\n        String[][] data =<span style=\"color: #000000;\">{\r\n                </span><span style=\"color: #0000ff;\">new</span> String[]{\"编号\",\"产区\",\"最新型号\",\"生产日期\"<span style=\"color: #000000;\">,},\r\n                </span><span style=\"color: #0000ff;\">new</span> String[]{\"1\",\"A\",\"V2.2.0\",\"2019-06-21\"<span style=\"color: #000000;\">},\r\n                </span><span style=\"color: #0000ff;\">new</span> String[]{\"2\",\"B\",\"V2.6.1\",\"2019-06-18\"<span style=\"color: #000000;\">},\r\n                </span><span style=\"color: #0000ff;\">new</span> String[]{\"3\",\"C\",\"V2.6.2\",\"2019-06-14\"<span style=\"color: #000000;\">},\r\n        };\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">填充数组内容到嵌套表格</span>\r\n        <span style=\"color: #0000ff;\">for</span> (<span style=\"color: #0000ff;\">int</span> i = 0; i &lt; data.length; i++<span style=\"color: #000000;\">) {\r\n            TableRow dataRow </span>=<span style=\"color: #000000;\"> nestedtable.getRows().get(i);\r\n            dataRow.getCells().get(i).setWidth(</span>160<span style=\"color: #000000;\">);\r\n            dataRow.setHeight(</span>25<span style=\"color: #000000;\">);\r\n            dataRow.setHeightType(TableRowHeightType.Exactly);\r\n            </span><span style=\"color: #0000ff;\">for</span> (<span style=\"color: #0000ff;\">int</span> j = 0; j &lt; data[i].length; j++<span style=\"color: #000000;\">) {\r\n                dataRow.getCells().get(j).getCellFormat().setVerticalAlignment(VerticalAlignment.Middle);\r\n                TextRange range </span>=<span style=\"color: #000000;\"> dataRow.getCells().get(j).addParagraph().appendText(data[i][j]);\r\n                range.getCharacterFormat().setFontName(</span>\"楷体\"<span style=\"color: #000000;\">);\r\n                range.getCharacterFormat().setFontSize(11f);\r\n                range.getOwnerParagraph().getFormat().setHorizontalAlignment(HorizontalAlignment.Center);\r\n            }\r\n        }\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">保存文档</span>\r\n        doc.saveToFile(\"nesedtable1.docx\"<span style=\"color: #000000;\">,FileFormat.Docx_2010);\r\n    }\r\n}</span></pre> \n</div> \n<p>嵌套表格效果：</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/641da6e0-49b4-41fa-b003-ba9f9676593f.png\" alt=\"\"></p> \n<h3>&nbsp;</h3> \n<h3>【在Word表格中添加行或者列】</h3> \n<p><strong>&nbsp; &nbsp; &nbsp;1. 添加行</strong></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">import</span> com.spire.doc.*<span style=\"color: #000000;\">;\r\n\r\n</span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> AddRow {\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> main(String[] args){\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">加载测试文档</span>\r\n        Document doc = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Document();\r\n        doc.loadFromFile(</span>\"sample.docx\"<span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">获取表格</span>\r\n        Section section = doc.getSections().get(0<span style=\"color: #000000;\">);\r\n        Table table </span>= section.getTables().get(0<span style=\"color: #000000;\">);\r\n\r\n        table.addRow();</span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">默认在表格最下方插入一行\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">table.getRows().insert(2,table.addRow());</span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">在表格中第3行插入一行\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">table.addRow(4);</span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">默认在表格最下方添加4个单元格\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">table.addRow(true,2);</span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">带格式在最后一行添加2个单元格\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">table.addRow(false,2);</span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">不带格式在最后一行添加2个单元格\r\n\r\n</span><span style=\"color: #008000;\">        //</span><span style=\"color: #008000;\">保存文档</span>\r\n        doc.saveToFile(\"addrow.docx\"<span style=\"color: #000000;\">,FileFormat.Docx_2013);\r\n        doc.dispose();\r\n    }\r\n}</span></pre> \n</div> \n<p>表格行添加效果:</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/cf1ac36c-03d8-4482-9c45-8505cec083e8.png\" alt=\"\"></p> \n<p><strong><span style=\"color: #000000;\">&nbsp; &nbsp; &nbsp;2. 添加列</span></strong></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">import</span> com.spire.doc.*<span style=\"color: #000000;\">;\r\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> com.spire.doc.documents.BorderStyle;\r\n\r\n</span><span style=\"color: #0000ff;\">import</span> java.awt.*<span style=\"color: #000000;\">;\r\n\r\n</span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> AddColumn {\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> main(String[] args){\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">加载测试文档</span>\r\n        Document doc = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Document();\r\n        doc.loadFromFile(</span>\"sample.docx\"<span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">获取表格</span>\r\n        Section section = doc.getSections().get(0<span style=\"color: #000000;\">);\r\n        Table table </span>= section.getTables().get(0<span style=\"color: #000000;\">);\r\n\r\n</span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">获取表格单元格宽度及类型</span>\r\n        <span style=\"color: #0000ff;\">float</span> width = table.get(0,0<span style=\"color: #000000;\">).getWidth();\r\n        CellWidthType type </span>= table.get(0,0<span style=\"color: #000000;\">).getCellWidthType();\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">遍历表格每一行</span>\r\n        <span style=\"color: #0000ff;\">for</span> (<span style=\"color: #0000ff;\">int</span> i = 0; i &lt; table.getRows().getCount(); i++<span style=\"color: #000000;\">) {\r\n            TableRow row </span>= table.getRows().get(i);<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">获取表格每一行</span>\r\n            Color color = row.getCells().get(0).getCellFormat().getBackColor();<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">获取表格单元格背景色\r\n            </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">基于表格每行，在最后添加一个单元格，并设置单元格格式</span>\r\n            TableCell cell = row.addCell(<span style=\"color: #0000ff;\">true</span>);<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">默认在最后一列添加单元格</span>\r\n<span style=\"color: #000000;\">            cell.setWidth(width);\r\n            cell.setCellWidthType(type);\r\n            cell.getCellFormat().getBorders().setBorderType(BorderStyle.Single);\r\n            cell.getCellFormat().setBackColor(color);\r\n            </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">如需在指定位置插入列，基于以上代码并增加下面一行代码即可\r\n            </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">row.getCells().insert(2,cell);</span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">插入一列作为第三列</span>\r\n<span style=\"color: #000000;\">        }\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">保存文档</span>\r\n        doc.saveToFile(\"addcolumn.docx\"<span style=\"color: #000000;\">, FileFormat.Docx_2013);\r\n        doc.dispose();\r\n    }\r\n}</span></pre> \n</div> \n<p>表格列添加效果：</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/1526face-f9d5-4562-805a-ddc221e4bb2e.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<h3>【复制Word表格中的行或者列】</h3> \n<h4>&nbsp; &nbsp; 1. 复制行</h4> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">import</span> com.spire.doc.*<span style=\"color: #000000;\">;\r\n\r\n</span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> CopyRow {\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> main(String[] args) {\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">加载测试文档</span>\r\n        Document doc = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Document();\r\n        doc.loadFromFile(</span>\"test.docx\"<span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">获取表格</span>\r\n        Section section = doc.getSections().get(0<span style=\"color: #000000;\">);\r\n        Table table </span>=section.getTables().get(0<span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">复制第三行，并将复制后的行插入到表格作为第五行</span>\r\n        TableRow row = table.getRows().get(2<span style=\"color: #000000;\">).deepClone();\r\n        table.getRows().insert(</span>4<span style=\"color: #000000;\">,row);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">保存文档</span>\r\n        doc.saveToFile(\"CopyRow.docx\"<span style=\"color: #000000;\">,FileFormat.Docx_2013);\r\n        doc.dispose();\r\n    }\r\n}</span></pre> \n</div> \n<p>表格行复制效果：</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/7f2b13f0-cf82-473e-a8c3-4ec94130517a.png\" alt=\"\"></p> \n<p><strong>&nbsp; &nbsp; &nbsp; 2. 复制列</strong></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">import</span> com.spire.doc.*<span style=\"color: #000000;\">;\r\n\r\n</span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> CopyColumn {\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> main(String[] args) {\r\n       </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">加载测试文档</span>\r\n        Document doc = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> Document();\r\n        doc.loadFromFile(</span>\"test.docx\"<span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">获取表格</span>\r\n        Section section = doc.getSections().get(0<span style=\"color: #000000;\">);\r\n        Table table </span>=section.getTables().get(0<span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">遍历表格每行</span>\r\n        <span style=\"color: #0000ff;\">for</span> (<span style=\"color: #0000ff;\">int</span> i = 0; i &lt; table.getRows().getCount(); i++<span style=\"color: #000000;\">) {\r\n            </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">复制表格中每行的最后一个单元格，复制</span>\r\n            TableRow row =<span style=\"color: #000000;\"> table.getRows().get(i);\r\n            TableCell cell </span>=<span style=\"color: #000000;\"> (TableCell) row.getCells().getLastItem().deepClone();\r\n            </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">row.getCells().add(cell);</span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">默认在每行最后添加复制后的单元格</span>\r\n            row.getCells().insert(2,cell);<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">在指定位置插入复制后的单元格</span>\r\n<span style=\"color: #000000;\">        }\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">保存文档</span>\r\n        doc.saveToFile(\"CopyColumn1.docx\"<span style=\"color: #000000;\">,FileFormat.Docx_2013);\r\n        doc.dispose();\r\n    }\r\n}</span></pre> \n</div> \n<p>表格列复制效果：</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/04600caf-8d19-4660-8d39-bc11c7b092c5.png\" alt=\"\"></p> \n<p>&nbsp;</p> \n<h3>【设置Word表格是否禁止跨页断行】</h3> \n<p>这里通过两种方式来设置防止表格跨页出现断行的效果，供参考。</p> \n<p><strong>&nbsp; 1.</strong>&nbsp;<strong>设置属性禁止跨页断行</strong></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">import</span> com.spire.doc.*<span style=\"color: #000000;\">;\r\n\r\n</span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> PreventPagebreak {\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> main(String[]args){\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">加载测试文档</span>\r\n        Document doc= <span style=\"color: #0000ff;\">new</span> Document(\"test.docx\"<span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">获取表格</span>\r\n        Table table = doc.getSections().get(0).getTables().get(0<span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">设置表格是否分页断行</span>\r\n        table.getTableFormat().isBreakAcrossPages(<span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">保存文档</span>\r\n        doc.saveToFile(\"result.docx\"<span style=\"color: #000000;\">,FileFormat.Docx_2013);\r\n    }\r\n}</span></pre> \n</div> \n<p><strong>&nbsp; &nbsp; 2. 保持表格内容在同一页面</strong></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #0000ff;\">import</span> com.spire.doc.*<span style=\"color: #000000;\">;\r\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> com.spire.doc.documents.Paragraph;\r\n\r\n</span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> PreventPagebreak {\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">static</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> main(String[]args){\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">加载测试文档</span>\r\n        Document doc= <span style=\"color: #0000ff;\">new</span> Document(\"test.docx\"<span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">获取表格</span>\r\n        Table table = doc.getSections().get(0).getTables().get(0<span style=\"color: #000000;\">);\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">遍历表格单元格</span>\r\n        <span style=\"color: #0000ff;\">for</span> (<span style=\"color: #0000ff;\">int</span> i = 0;i&lt; table.getRows().getCount();i++<span style=\"color: #000000;\">) {\r\n            TableRow rows </span>=<span style=\"color: #000000;\"> table.getRows().get(i);\r\n            </span><span style=\"color: #0000ff;\">for</span> (<span style=\"color: #0000ff;\">int</span> j = 0; j&lt; rows.getCells().getCount(); j++<span style=\"color: #000000;\">){\r\n                </span><span style=\"color: #0000ff;\">for</span> (<span style=\"color: #0000ff;\">int</span> z= 0; z &lt; rows.getCells().get(j).getParagraphs().getCount();z++<span style=\"color: #000000;\">){\r\n                    Paragraph p </span>=<span style=\"color: #000000;\"> rows.getCells().get(j).getParagraphs().get(z);\r\n                    p.getFormat().setKeepFollow(</span><span style=\"color: #0000ff;\">true</span>);<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">设置表格内容在同一页显示</span>\r\n<span style=\"color: #000000;\">                }\r\n            }\r\n        }\r\n\r\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">保存文档</span>\r\n        doc.saveToFile(\"result1.docx\"<span style=\"color: #000000;\">,FileFormat.Docx_2013);\r\n    }\r\n}</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>（本文完）</p> \n<p>转载请注明出处！！</p>', NULL, '2019-10-17 17:37:09', 0, NULL, NULL, 'https://www.cnblogs.com/Yesi/p/11691132.html', 0, NULL);
INSERT INTO `t_blog` VALUES (257, 'stm32填坑之旅一 - stm32f103c8t6点亮板载贴片蓝色LED', '<p>转载请注明：<a href=\"https://www.cnblogs.com/rockyf/p/11691622.html\" class=\"uri\">https://www.cnblogs.com/rockyf/p/11691622.html</a></p> \n<h1 id=\"开篇\">开篇</h1> \n<p>开篇一定要精彩，不然路人不理睬！下述是笔者作为arm小白的填坑之旅<br> 没错，这个之前一直从事软件开发的笔者，开始搞硬件了，当然仅仅是数电！模电需要有很扎实的电路基础，而笔者有的只有“扎实”的逻辑基础。<br> 那为什么笔者要开始搞硬件呢？<br> 其实早在大学期间，笔者所在专业（计算机科学与技术）中就有一门课就专门讲了硬件-软件的连接以及实现，只怪当初没有好好学，只是心中有那么个印象，就是时钟驱动逻辑电路去处理每一个指令然后完成整个逻辑（当然，这个印象很重要，在arm中，时钟就是它的心脏！）。<br> 毕业后若干年，物联网行业开始兴起，于是手痒痒了，仅凭这一印象，开始入手了人生中的第一块板子——树莓派3B，用来做了一些小玩意儿，但那都是在linux的基础上做的，和软件开发没什么区别，于是乎，这块树莓派至今都在吃灰。<br> 第二块板子便是arduino，比树莓派稍微有点难度了，没有OS，且ram也只有几百KB，做了几个demo后，发现太依赖arduino的环境了，也不是C开发，并没有真正接触底层，于是这块arduino跟树莓派正在一起吃灰中。<br> 笔者的主开发语言是js，出于对脚本语言的熟练，我偶然间发现了NodeMCU这个东西，发现是块可以用lua脚本写逻辑的板子，甚是欢喜，后来还烧录了espruino固件和micropython固件，把玩了许久后终于还是去吃灰了！<br> 看来IoT行业并没有那么简单，于是收收心搞主业了！直到上个月手头没啥业务了，又开始手痒痒，查阅了avr和arm的利弊后，最终选择了arm，毕竟大佬的意见是想挑战就选arm（其实arduino板就是使用了avr架构的atmega芯片）！于是开始某宝之路。</p> \n<h1 id=\"选材1-stm32f103c8t6\">选材#1 STM32f103c8t6</h1> \n<p>笔者作为arm初学者，不能上来就搞大货（比如xx开发套件，xx集成开发板），一是贵，二是没必要。再三某宝后，最终选定了stm32最便宜的板子STM32f103c8t6，是国产的板子，应该是st授权过的板子，然后各种仿制。<br> 笔者入的是块黑色板子，如下图：<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/351659c4-6de5-466a-9fa9-bb2949e01c08.png\"><br> 这块板子对于初学者来说太实惠了，RMB11，65536b(64kb)的flash和20480b(20kb)的sram，完全够用了，还有一个microUSB口，舒服！<br> 当然，某宝上还有其他各种颜色的板子，电路排布略有不同，但功能都不尽相同。</p> \n<h1 id=\"踩坑1-烧录\">踩坑#1 烧录</h1> \n<p>兴致勃勃地拿了快递，兴致勃勃地拆了快递，兴致勃勃地拿USB线连接到了电脑，尴尬的是毫无反应，USB信息里也没有任何st字样的项，于是开始查阅各种资料才发现，stm32f103x的microUSB口是用作电源和DFU烧录用的，于是又查了DFU的资料，发现stm32f103x并没有烧录dfu的支持固件，所以不能用DFU烧录，所以还是要其他烧录方式！</p> \n<h1 id=\"选材2-st-link-v2\">选材#2 st-link v2</h1> \n<p>在采坑#1后，我查到了stm32的另外两种烧录方式：JTag和st-link，JTag在某宝上的价格要几十块，而st-link则是10块上下，但是JTag比st-link要好用，于是果断选了st-link，便宜和爱折腾才是王道（一位图拉丁人说）。<br> 于是在某宝上又入了一个st-link v2，RMB10.5。</p> \n<h1 id=\"踩坑2-跑起来了\">踩坑#2 跑起来了</h1> \n<p>拿到st-link后，才意识到stm板子上的引脚没有焊接，于是就把swd引脚和跳线引脚给焊接上了。<br> 然后照着板子上的swd的引脚说明，连接到st-link对应的引脚！<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/c3a3d751-b716-4643-ac76-e09a99ee9f46.png\"><br> 完美，一插上，板子上的贴片蓝色LED就开始闪烁起来了（据说蓝灯闪烁是出场时候烧录的测试程序，说明板子是正常工作的）。</p> \n<h1 id=\"踩坑3-开发环境搭建\">踩坑#3 开发环境搭建</h1> \n<p>在查阅资料的时候，发现大大多数开发者用的操作系统要么是Windows要么就是Linux的，而笔者用的macOS，又一个大坑渐渐浮现，我直接填一下吧。<br> 需要材料：</p> \n<ol> \n <li>安装<a href=\"https://www.st.com/zh/development-tools/stm32cubemx.html\">STM32CubeMX</a></li> \n <li>安装<a href=\"https://brew.sh/\">homebrew</a></li> \n <li>安装stlink命令行工具：brew install stlink</li> \n <li>安装open-ocd命令行工具：brew install openocd</li> \n <li>安装<a href=\"https://www.jetbrains.com/clion/\">Clion2019</a>，笔者比较喜欢jetbrains系列的IDE。记住，一定要安装新版本，老板没有适配和安装Embedded MCU Development plugin，这个插件能简化很多操作！</li> \n</ol> \n<p>然后就可以愉快地玩耍了！<br> 打开clion，新建一个项目，选嵌入式stm32的那个<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/7daa0397-9ec1-464d-a6bf-f8c869d9d278.png\"><br> 创建项目后，会自动打开STM32CubeMX，或者手动打开项目中的ioc文件，在编辑区会有一个链接能打开STM32CubeMX。<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/9861ee0f-e101-4ac4-83cd-034d361d6d32.png\"><br> 它默认创建的是STM32f030f4px的芯片，在下面的操作中修改芯片<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/e93e244a-b7d3-4200-997a-c0e129072bcd.png\"><br> 然后在project manager中修改<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/d295273d-a414-4b7b-b5c5-4024cf38fc97.png\"><br> 路径修改了一次就不能修改了哦！最后点击右上角的generate code。<br> 返回clion后，就会同步文件，发现代码都生成了，点击编译，居然毫不费力地成功了，甚是欢喜！<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/bc95130b-da07-4031-b637-53fe8c2eab9e.png\"><br> 然后烧录，点击运行，clion居然报错了<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/5f2ae17c-6c80-4719-bcb8-5ef407a1ca8e.png\"><br> 原来是编辑器板子的配置文件没有选定，需要再run/debug configuration中配置<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/f2b7466d-8c20-4afc-992f-9eaa8323abb2.png\"><br> <img src=\"http://localhost:9090/blogImages/2019/10/17/1b8cc08e-36d4-46f2-8726-f2b9cc36de3d.png\"><br> 这时，笔者找遍了整个列表都没找到stm32f103字样的项，于是去各种查阅，网上说并没有stm32f1discovery的项，这个low-level的板子太杂了，需要用board/st_nucleo_f103rb.cfg才行。<br> 然后再点击运行，嘿，居然一堆红色的文子，看得头皮发麻<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/e866311e-bd25-4e62-8c12-b6e9dc0f26af.png\"><br> 然后又是各种查阅，原来要修改board/st_nucleo_f103rb.cfg的配置</p> \n<ul> \n <li>把接口改成stlink-v2，原来是stlink-v2-1，笔者买的是stlink-v2，如果你买的是v2-1，那这个不用修改</li> \n <li>把最后一行注释掉 #reset_config srst_only</li> \n</ul> \n<p>再运行，嘿，蓝灯居然不闪了，估计是烧录成功了，因为红色文子里没有什么错误信息了。<br> 然后开始看项目结构，根据笔者的经验，用户逻辑的入口肯定是类似src，main之类字样的文件中的，果然，在Src/main.c中找到了入口。<br> 里面有很多注释，主要是用于STM32CubeMX生成代码所标记的，不要乱改这些注释，否则会对代码生成产生影响的，你需要修改的就USER CODE字样注释范围内。<br> 果然找到了蓝灯不闪烁的原因了，原来是main方法里的while里是空的，导致没有对蓝灯没有做任何处理，蓝灯默认是灭的。<br> 于是开始查阅stm32有关GPIO的文档，可以使用hal库来操作</p> \n<pre class=\"c\"><code>  while (1)\n  {\n    /* USER CODE END WHILE */\n\n    /* USER CODE BEGIN 3 */\n\n    HAL_GPIO_TogglePin(GPIOB, GPIO_PIN_12);\n    HAL_Delay(100);\n  }</code></pre> \n<p>HAL_GPIO_TogglePin方法是切换io口的状态，第一个参数是io口的集合，第二个参数是具体集合中那个口。那为什么是GPIOB和GPIO_PIN_12呢？</p> \n<h1 id=\"采坑4-gpio\">采坑#4 GPIO</h1> \n<p>STM32f103c8t6板载的蓝色LED肯定是能修改的，或者是有其他用途的。经仔细查阅某宝的那个详情后，找到了它的电路图<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/92c4b374-0d79-4bd6-ba8e-454af9697ad8.png\"><br> 在图中，找到了两个LED灯，一个是红色LED，是接地的，常亮状态，指示通电状态。蓝色LED则是接入到了PB12，意思就是可以通过PB12的口来控制这个蓝灯，于是，推断一下就是GPIOB和GPIO_PIN_12这两个参数了（其实是通过多次敲代码，在只能提示候选列表中找到的）。<br> HAL_Delay自然就是延时等待多少毫秒的作用了！<br> 代码修改好了，再运行，吧唧，没反应，蓝灯没有闪也没有亮，咋回事？预期应该是狂闪的呀！</p> \n<h1 id=\"采坑5-hal库和rcc库\">采坑#5 hal库和rcc库</h1> \n<p>为什么操作GPIO没有反应呢？依旧是查阅资料，网上说需要配置GPIO，不然用不了，然后给出了很多代码，粘贴进来后，都是语法错误，什么RCC没有找到之类的错误，应该是库没有引入进来导致的，想include rcc库，结果在项目中找不到rcc库，于是又是一番查阅。<br> 笔者这个时候就在想，我用的hal库，会不会rcc也是类似hal的库呢，果然不是！hal中也有rcc的部分实现，所以只是用hal库应该没什么问题。<br> 然后就搁置了一段时间！</p> \n<h1 id=\"采坑6-调试\">采坑#6 调试</h1> \n<p>我想想看，能不能用调试功能，因为st-link仿真器是有调试功能，于是又开始捣腾！<br> 奈何怎么调试没用，GDB调试器始终无法连接st-link：<code>Error: init mode failed (unable to connect to the target)</code>。但是在HAL_Init()上的断点就能断到，每次都是HAL_Init()过不去，然后一步一步跟踪进去调试，发现在__HAL_AFIO_REMAP_SWJ_NOJTAG这个方法过不去了，再升入就不行了，于是按照__HAL_AFIO_REMAP_SWJ_NOJTAG关键词阅资料发现，stm的调试是需要在STM32CubeMX中配置的，配置点在：SYS&gt;Debug中<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/285d6f5b-7ff3-48c7-b955-8a551587471e.png\"><br> 默认是No Debug，选择Serial Wire后generate code一次再编译就能开启调试了！简直完美！</p> \n<h1 id=\"采坑7-引脚配置\">采坑#7 引脚配置</h1> \n<p>但是调试发现，代码很完美啊（其实心里也没有底，还是查了其他文档，怀疑板载的蓝色LED并不是PB12）。<br> 偶然间想起来，在STM32CubeMX中配置调试的时候，好像在右侧的芯片引脚图看到了PB这个口子，果然，在芯片引脚图上找到了PB12，甚是欢喜啊！<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/c702f7cb-7fdd-426d-afc0-569600c9b991.png\"><br> 然后把PB12的引脚设置成GPIO_OUTPUT，然后generate code，再运行，终于，蓝灯开始闪烁啦，舒服！<br> 仔细查阅main.c，会发现，其实在配置引脚后，生成的代码的MX_GPIO_Init中多了一些代码，这些代码就是配置引脚用的！</p> \n<h1 id=\"完结\">完结</h1> \n<p>至此，板载蓝色LED终于闪烁了，达成了目标！<br> 其实，在整个填坑过程中，不止上述的那些步骤，还有其他很多坑，比如：</p> \n<ul> \n <li>stlink命令行工具怎么都打印不出stm板子的信息，甚至把stlink的源码clone下来，调试看了log，果然不是stlink的问题！最后在其issue中找到了答案，原来通过swd连接st-link的时候，需要将boot0置1，就是要把boot0的跳线帽连接右侧，boot1随意<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/81579179-264c-495d-b6fa-fbc9ba090cfe.png\"><br> 包括烧录程序，首次连接都需要上图的连接，否则会报初始化失败的错误！</li> \n <li>clion无法调试c的项目，查找后原来是笔者升级了macOS catalina 10.15版本，导致GDB调试器出错无法调试，升级到最新版本即可！</li> \n <li>为什么要把#reset_config srst_only这行注释掉呢，因为对于STM32f103这样的的low-level的板子，并不支持reset，所以怎么都不能重置板子，在烧录成功，st-link会自动重置板子，所以依旧能达到重置板子的效果！</li> \n <li>……想不起来了</li> \n</ul> \n<h1 id=\"心得\">心得</h1> \n<p>写博怎么不写心得呢！<br> 世上本来并没有坑，只是完成教程太少，便有了坑！<br> 其实在整个填坑过程中，最多的是查阅资料和尝试，身边没有朋友学过或正在从事相关的工作。</p> \n<ul> \n <li>查阅资料就是baidu+google，双剑合璧，baidu查中文，google查英文，几乎都能找到！</li> \n <li>STM32f103c8t6这块板子的flash据说有10w次的擦写寿命，所以几乎完全用不完，多尝试，多失败，才能达到最终的成功！</li> \n</ul> \n<h1 id=\"以上\">以上</h1>', NULL, '2019-10-17 17:37:35', 0, NULL, NULL, 'https://www.cnblogs.com/rockyf/p/11691622.html', 0, NULL);
INSERT INTO `t_blog` VALUES (258, '无人机基于Matlab/Simulink的模型开发(连载一）', '<p>“一切可以被控制的对象，都需要被数学量化”</p> \n<p>这是笔者从事多年研发工作得出的道理，无论是车辆控制，机器人控制，飞机控制，还是无人机控制，所有和机械运动相关的控制，如果不能被很好的数学量化，那么将不会被很好的控制。</p> \n<p>因为工作需要，笔者曾拜访过很多无人机研发公司，高校和研究所。发现大多数无人机研发公司的研发手段，相较于国外，还很初级。基本都是嵌入式开发居多，侧重于驱动的修改，飞行逻辑的修改。我认为这算不上是严格的无人机开发。因为大多数公司，都没有给被控对象(无人机)，建立完整的数学模型。只是利用开源的框架，调整控制参数，没有完整的测试流程和测试指标。这样研发出来的飞机一致性很差，每一架飞机的飞行状态都不统一，完全不能满足于工业应用的场景。2018/2019年倒闭的无人机公司，大多数都是存在这种情况。</p> \n<p>不乏有些原本从事互联网软件开发的公司，转行从事无人机开发。在运动控制领域，和互联网软件开发的不同。有的时候互联网软件开发，不需要建立被控对象的数学模型。秉承设计模式，软件架构设计，协作编程，大规模软件集中测试，上线。在无人系统开发中，软件构架设计也是必不可少的，但是在测试的环节，如果没有建立数学模型，测试无从谈起，因为一般的真机测试，代价，效率和测试密集程度远远达不到要求。因为一个BUG会导致飞机坠毁，而任何一个新系统，往往存在大量的BUG。</p> \n<p>而在已经成熟工业界，比如汽车，飞机制造，电力电子，航天等领域大量采用了基于Matlab基于Simulink的模型开发手段。</p> \n<p>我们阿木实验室提供如下的课程体系和打包工具：</p> \n<p>课程将全面，细致地讲解如何基于模型(Simulink)的方法设计一套功能强大的飞控系统。本课程由多位一线资深飞控工程师设计，结合多年的基于模型的飞控开发经验，给大家提供最先进，最前沿的飞控开发体验。</p> \n<h2>概述</h2> \n<p>基于模型的开发将省去繁琐的代码编写步骤，只需要拖动几个模块，就像搭积木一般，轻松搭建您自己的飞控算法。飞控开发人员可以将更多的精力放在算法本身，而不需要过多关注代码实现的细节，这样将大大加快开发的效率，减少在代码编写过程中产生的错误。同时，基于模型的开发具有优秀的代码复用性。也就是说，已经设计好的功能模块，只需要简单的复制粘贴，就能轻松地应用到其它任何地方，免去了代码移植过程的繁琐。</p> \n<p>基于模型的开发另外一个强大的优势即在于“一次试验，多次仿真”的目的。结合Simulink强大的开环和闭环仿真系统，只需采集一次数据，便可通过仿真再现在真实世界中的实际表现。通过修改模型算法或参数，可以进行在线的数据仿真和调试，大大简化调试的难度。</p> \n<h3>系统接口与总线设计</h3> \n<p>在我们设计控制系统之前，首先要做的就是定义系统的输入/输出接口。在Simulink中，接口一般都是以总线的方式进行定义。可以将总线理解为C语言中的结构体，当把Simulink模型自动生成C代码后，也可以看到总线最终是用结构体来进行实现的。</p> \n<p>对于内环的姿态环控制器来说，输入总线设计如下：</p> \n<p><strong>Command_Bus</strong></p> \n<figure>\n <table> \n  <thead> \n   <tr>\n    <th style=\"text-align:center;\">Element</th>\n    <th style=\"text-align:center;\">Type</th>\n    <th style=\"text-align:center;\">Unit</th>\n    <th style=\"text-align:center;\">Meaning</th>\n   </tr>\n  </thead> \n  <tbody>\n   <tr>\n    <td style=\"text-align:center;\">reset</td>\n    <td style=\"text-align:center;\">uint8</td>\n    <td style=\"text-align:center;\">[0,1]</td>\n    <td style=\"text-align:center;\">为1复位控制器</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">mode</td>\n    <td style=\"text-align:center;\">uint8</td>\n    <td style=\"text-align:center;\">[0,1]</td>\n    <td style=\"text-align:center;\">0:角度控制，1:角速度控制</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">base_th</td>\n    <td style=\"text-align:center;\">int16</td>\n    <td style=\"text-align:center;\">0~1000</td>\n    <td style=\"text-align:center;\">姿态环基础油门</td>\n   </tr>\n  </tbody> \n </table>\n</figure> \n<p><strong>Reference_Bus</strong></p> \n<figure>\n <table> \n  <thead> \n   <tr>\n    <th style=\"text-align:center;\">Element</th>\n    <th style=\"text-align:center;\">Type</th>\n    <th style=\"text-align:center;\">Unit</th>\n    <th style=\"text-align:center;\">Meaning</th>\n   </tr>\n  </thead> \n  <tbody>\n   <tr>\n    <td style=\"text-align:center;\">phi_ref_rad</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad</td>\n    <td style=\"text-align:center;\">目标roll</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">theta_ref_rad</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad</td>\n    <td style=\"text-align:center;\">目标pitch</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">psi_ref_rad</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad</td>\n    <td style=\"text-align:center;\">目标yaw</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">p_ref_radDs</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad/s</td>\n    <td style=\"text-align:center;\">目标roll角速度</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">q_ref_radDs</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad/s</td>\n    <td style=\"text-align:center;\">目标pitch角速度</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">r_ref_radDs</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad/s</td>\n    <td style=\"text-align:center;\">目标yaw角速度</td>\n   </tr>\n  </tbody> \n </table>\n</figure> \n<p><strong>States_Bus</strong></p> \n<figure>\n <table> \n  <thead> \n   <tr>\n    <th style=\"text-align:center;\">Element</th>\n    <th style=\"text-align:center;\">Type</th>\n    <th style=\"text-align:center;\">Unit</th>\n    <th style=\"text-align:center;\">Meaning</th>\n   </tr>\n  </thead> \n  <tbody>\n   <tr>\n    <td style=\"text-align:center;\">phi_rad</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad</td>\n    <td style=\"text-align:center;\">roll当前值</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">theta_rad</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad</td>\n    <td style=\"text-align:center;\">pitch当前值</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">psi_rad</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad</td>\n    <td style=\"text-align:center;\">yaw当前值</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">p_radDs</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad/s</td>\n    <td style=\"text-align:center;\">roll角速度当前值</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">q_radDs</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad/s</td>\n    <td style=\"text-align:center;\">pitch角速度当前值</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">r_radDs</td>\n    <td style=\"text-align:center;\">single</td>\n    <td style=\"text-align:center;\">rad/s</td>\n    <td style=\"text-align:center;\">yaw角速度当前值</td>\n   </tr>\n  </tbody> \n </table>\n</figure> \n<p>输入接口总共有三个总线，分别是<strong>Command_Bus</strong>，<strong>Reference_Bus</strong>和<strong>States_Bus</strong>。其中Command_Bus是控制总线，用来对控制系统进行一些设置，如模式设置，复位等。Reference_Bus和States_Bus是目标信号总线和状态信号总线，可以理解为控制器的目标值和当前值。控制器的目的就是通过控制来使得当前值尽可能收敛到目标值。</p> \n<p>输入接口设计完了，接下来是输出接口。输出接口相比输入要简单很多，无非就是多路pwm指令输出。这里我们预留6个pwm输出接口，即最多可以支持6轴的控制，当面，也可以根据自己的需要，来进行修改。</p> \n<p><strong>Control_Out_Bus</strong></p> \n<figure>\n <table> \n  <thead> \n   <tr>\n    <th style=\"text-align:center;\">Element</th>\n    <th style=\"text-align:center;\">Type</th>\n    <th style=\"text-align:center;\">Unit</th>\n    <th style=\"text-align:center;\">Meaning</th>\n   </tr>\n  </thead> \n  <tbody>\n   <tr>\n    <td style=\"text-align:center;\">pwm1</td>\n    <td style=\"text-align:center;\">uin16</td>\n    <td style=\"text-align:center;\">1000~2000</td>\n    <td style=\"text-align:center;\">电机1 pwm信号</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">pwm2</td>\n    <td style=\"text-align:center;\">uin16</td>\n    <td style=\"text-align:center;\">1000~2000</td>\n    <td style=\"text-align:center;\">电机2 pwm信号</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">pwm3</td>\n    <td style=\"text-align:center;\">uin16</td>\n    <td style=\"text-align:center;\">1000~2000</td>\n    <td style=\"text-align:center;\">电机3 pwm信号</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">pwm4</td>\n    <td style=\"text-align:center;\">uin16</td>\n    <td style=\"text-align:center;\">1000~2000</td>\n    <td style=\"text-align:center;\">电机4 pwm信号</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">pwm5</td>\n    <td style=\"text-align:center;\">uin16</td>\n    <td style=\"text-align:center;\">1000~2000</td>\n    <td style=\"text-align:center;\">电机5 pwm信号</td>\n   </tr>\n   <tr>\n    <td style=\"text-align:center;\">pwm6</td>\n    <td style=\"text-align:center;\">uin16</td>\n    <td style=\"text-align:center;\">1000~2000</td>\n    <td style=\"text-align:center;\">电机6 pwm信号</td>\n   </tr>\n  </tbody> \n </table>\n</figure> \n<p>好了，现在接口都定义好了，那么下一步的问题就是如何在Simulink里面来实现这些接口定义了。</p> \n<p>其实，在Simulink中实现这些接口定义很简单。Simulink提供了一个Bus Editor的工具，只需要进行简单配置就可以定义任何你需要的接口或者总线了。</p> \n<p>下面一步一步地讲解一下总线的定义方法：</p> \n<ul> \n <li><p>首先打开控制模型，点击Edit-&gt;Bus Editor <img src=\"http://localhost:9090/blogImages/2019/10/17/de955990-63a0-4aab-a5b6-b86b8431a2d7.octet-stream\" referrerpolicy=\"no-referrer\" alt=\"bus_editor_1\"></p> </li> \n <li><p>这里我之前已经配置过了，所以能看到我已经定义过的总线。但是如果是自己第一次进行设计的话，这里应该是空的。可以点击如红色圈圈所示的add bus来添加Bus信号，这里我们总共需要添加4个Bus。三个输入总线和一个输出总线。Bus添加好后，在最右边的Property，修改Bus的名称。添加好Bus之后，我们下面就需要往Bus里面添加Element，即总线的元素。首先选定一个Bus,然后点击蓝色圈圈圈出的add element选项，即可添加元素。 <img src=\"http://localhost:9090/blogImages/2019/10/17/5b19f6cf-dd4a-4f95-83ab-961b89703499.octet-stream\" referrerpolicy=\"no-referrer\" alt=\"bus_editor_2\"></p> </li> \n <li><pre><code>\n</code></pre> </li> \n <li><p>然后需要对Element进行配置。如图所示，我们一般只需要对Name，Data Type和Dimension三个选项进行配置即可。Dimension为变量的维度，如果我们的element需要配置为向量或者矩阵，那么就需要对Dimension进行配置。 <img src=\"http://localhost:9090/blogImages/2019/10/17/7d82a38c-02ad-4983-a9ed-7e9ac298819f.octet-stream\" referrerpolicy=\"no-referrer\" alt=\"bus_editor_3\"></p> </li> \n <li><p>配置完成后，需要点击File-&gt;Export to File来将Bus的配置保存成.m还活着.mat文件。因为Bus的定义都是保存在工作空间的。当你下次打开matlab的时候，工作空间都是会被清除的，所以我们需要将我们的Bus定义保存成文件，这样，当下次打开matlab的时候，只需要load一下我们的.mat/.m文件，就能将我们定义的Bus再load进工作空间。</p> </li> \n</ul> \n<blockquote> \n <p>微信公众号关注《阿木实验室》获取更多无人机开发测评信息，关注《阿木社区》获取更多学习课程信息。<br> 社区论坛地址：bbs.amovauto.com 参与讨论。</p> \n</blockquote>', NULL, '2019-10-17 17:37:36', 0, NULL, NULL, 'https://www.cnblogs.com/amovlab/p/11692723.html', 0, NULL);
INSERT INTO `t_blog` VALUES (259, 'Java自动化测试框架-02 - TestNG之理论到实践 - 纸上得来终觉浅，绝知此事要躬行（详细教程）', '<h2><strong>理论</strong></h2> \n<p>TestNG，即Testing, NextGeneration，下一代测试技术，是一套根据JUnit 和NUnit思想而构建的利用注释来强化测试功能的一个测试框架，即可以用来做单元测试，也可以用来做集成测试。<br>因为TestNG是从Junit的思想构建而来，所以TestNG具备junit等所不具备的多重功能。而且TestNG目前的使用比较广泛，google的一个selenium自动化项目组即采用的是selenium rc的java 接口+ testNG结合的方式。<br>写一个测试通常分为三步：<br>1.编写测试业务逻辑，并且在你的代码中插入 TestNG annotations 。<br>2.在 testng.xml 或 build.xml 添加你的测试信息。例如类名，希望运行的组等等<br>3.运行TestNG.<br>文档中会使用到如下的概念：<br>1.一套测试（suite）由一个XML文件所表示。它能够包含一个或者多个测试，&lt;suite&gt; 标记来定义。<br>2.test由&lt;test&gt;标记来表示一个测试，并且可以包含一个或者多个TestNG类。<br>3.TestNG 类是包含至少一个TestNG annotation的java类，由&lt;class&gt;标签描述并包含一个或多个测试方法。<br>4.测试方法，就是一个普通的Java方法，在由@Test标记。<br>testNG.xml<br>testNG的运行需要一个配置文件，默认为testng.xml，其描述了要运行哪些测试等配置。<br>编写testNG.xml如果没有书写提示，给在头部引入<br>&lt;!DOCTYPE suite PUBLIC \"--//beust.com//testng//testng 1.0//EN\" \"http://beust.com/testng/testng-1.0.dtd\" &gt;就会有提示了</p> \n<h2>实践</h2> \n<div> \n <div> \n  <div>\n   <strong>testng.xml是testNG的配置文件，以xml格式记录测试文件，项目创建成功后并没有自动创建testng.xml文件，需要自己添加，添加步骤如下：</strong>\n  </div> \n  <div>\n   1)在eclipse中创建项目，如下图\n  </div> \n  <div>\n   <img src=\"http://localhost:9090/blogImages/2019/10/17/219bbb68-c769-4014-970c-d88a31578e48.png\" alt=\"\"> \n   <p>&nbsp;</p> \n   <p>2)选择项目，右击 弹出菜单并选择菜单：【TestNG】-【Convert to TestNG】如下图</p> \n   <p><img src=\"http://localhost:9090/blogImages/2019/10/17/e627ede1-4e0c-4a07-83a4-623c248ca2db.png\" alt=\"\"></p> \n   <p>&nbsp;</p> \n   <p>3)勾选 Generate test.xml，并设置testng.xml相关信息，如下图</p> \n   <p><img src=\"http://localhost:9090/blogImages/2019/10/17/64a69965-b30d-43b8-82e4-d36ac00a496d.png\" alt=\"\"></p> \n   <p>&nbsp;</p> \n   <p>&nbsp;4）设置好testng.xml相关信息后 可以点击 【next】or【Finish】按钮进入下一步，下面是点击【next后的界面】</p> \n   <p><img src=\"http://localhost:9090/blogImages/2019/10/17/f2b6ad80-bcac-426b-aaf3-9db3611e8228.png\" alt=\"\"></p> \n   <p>&nbsp;</p> \n   <p>&nbsp;5）再点击【finish】按钮，testng.xml文件创建成功，可在主界面看到</p> \n   <p><img src=\"http://localhost:9090/blogImages/2019/10/17/85173ec6-5e1d-41af-a967-e79c686eaa3e.png\" alt=\"\"></p> \n   <p>&nbsp;</p> \n   <p>6）双击 testng.xml文件 可对文件内容进行编辑</p> \n   <p><img src=\"http://localhost:9090/blogImages/2019/10/17/5ad6aaeb-142b-48ad-93a2-064f05305cae.png\" alt=\"\"></p> \n   <p>7）testng.xml文件编辑完毕，选择该文件、右击可运行测试类 如下</p> \n   <p><img src=\"http://localhost:9090/blogImages/2019/10/17/8ddcfe04-58cf-43d1-8eab-5b38b323c160.png\" alt=\"\"></p> \n   <p>注意：TestNG使用的是 正则表达式，而不是通配符。注意这二者的区别</p> \n  </div> \n </div> \n <div>\n  例如：\"anything\" 是匹配于 \".*\" -- 点和星号 -- 而不是星号 \"*\"\n  <br> \n  <div class=\"cnblogs_code\"> \n   <pre><span style=\"color: #0000ff;\">&lt;?</span><span style=\"color: #ff00ff;\">xml version=\"1.0\" encoding=\"UTF-8\"</span><span style=\"color: #0000ff;\">?&gt;</span>\r\n<span style=\"color: #0000ff;\">&lt;!</span><span style=\"color: #ff00ff;\">DOCTYPE suite SYSTEM \"http://testng.org/testng-1.0.dtd\"</span><span style=\"color: #0000ff;\">&gt;</span>\r\n<span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">suite </span><span style=\"color: #ff0000;\">name</span><span style=\"color: #0000ff;\">=\"Suite\"</span><span style=\"color: #0000ff;\">&gt;</span>\r\n  <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">test </span><span style=\"color: #ff0000;\">name</span><span style=\"color: #0000ff;\">=\"Test\"</span><span style=\"color: #0000ff;\">&gt;</span>\r\n    <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">classes</span><span style=\"color: #0000ff;\">&gt;</span>\r\n      <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">class </span><span style=\"color: #ff0000;\">name</span><span style=\"color: #0000ff;\">=\"hongge.NewTest\"</span><span style=\"color: #0000ff;\">/&gt;</span>\r\n    <span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">classes</span><span style=\"color: #0000ff;\">&gt;</span>\r\n  <span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">test</span><span style=\"color: #0000ff;\">&gt;</span> <span style=\"color: #008000;\">&lt;!--</span><span style=\"color: #008000;\"> Test </span><span style=\"color: #008000;\">--&gt;</span>\r\n<span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">suite</span><span style=\"color: #0000ff;\">&gt;</span> <span style=\"color: #008000;\">&lt;!--</span><span style=\"color: #008000;\"> Suite </span><span style=\"color: #008000;\">--&gt;</span></pre> \n  </div> \n </div> \n</div> \n<div>\n <img src=\"http://localhost:9090/blogImages/2019/10/17/e1b16559-2211-499d-ba89-d29bb2d291f0.html; charset=UTF-8\" alt=\"\">\n</div> \n<div> \n <div>\n  Groups\n </div> \n <div>\n  testNG可以将各个method存放在不同的group里面，然后运行的时候可以指定要运行的group。Group指定的方式如下：\n </div> \n <div> \n  <div class=\"dp-highlighter bg_java\"> \n   <div class=\"bar\"> \n    <div class=\"tools\"> \n     <div class=\"cnblogs_code\"> \n      <pre>@Test(groups = {\"fast\", \"unit\", \"database\"<span style=\"color: #000000;\"> })\r\n</span><span style=\"color: #0000ff;\">public</span> voidrowShouldBeInserted() {}</pre> \n     </div> \n    </div> \n   </div> \n  </div> \n </div> \n <div>\n  &nbsp;\n </div> \n <h2><strong>实例</strong></h2> \n <div>\n  1.创建测试实例加法类TestSum\n </div> \n <div>\n  <img src=\"http://localhost:9090/blogImages/2019/10/17/b6b01a78-b97a-4098-9495-a4381f887563.png\" alt=\"\"> \n  <p>&nbsp;</p> \n  <p>2.参考代码</p> \n  <div class=\"cnblogs_code\"> \n   <pre><span style=\"color: #0000ff;\">package</span><span style=\"color: #000000;\"> hongge;\r\n\r\n</span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\r\n * </span><span style=\"color: #808080;\">@author</span><span style=\"color: #008000;\"> 北京-宏哥\r\n * \r\n * java自动化测试交流群：694280102\r\n *\r\n * Java自动化测试框架-02 - TestNG之理论实践篇\r\n * \r\n * 2019年10月17日\r\n </span><span style=\"color: #008000;\">*/</span>\r\n<span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> TestSum {\r\n    </span><span style=\"color: #0000ff;\">private</span> <span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> mytestsum;\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">int</span> add(<span style=\"color: #0000ff;\">int</span> num1,<span style=\"color: #0000ff;\">int</span><span style=\"color: #000000;\"> num2){\r\n        mytestsum </span>= num1 +<span style=\"color: #000000;\"> num2;\r\n        </span><span style=\"color: #0000ff;\">return</span><span style=\"color: #000000;\"> mytestsum;\r\n    }\r\n\r\n}</span></pre> \n  </div> \n  <p>&nbsp;</p> \n </div> \n <div>\n  <img src=\"http://localhost:9090/blogImages/2019/10/17/a9db1d0e-fa8d-4d5e-bf82-e399514d064c.html; charset=UTF-8\" alt=\"\">\n  <br>3.按照一开始的步骤创建TestNG测试业务逻辑类：NewTest\n </div> \n <div>\n  <img src=\"http://localhost:9090/blogImages/2019/10/17/ec8d8ce0-b07f-4ebc-a25e-56e307729ef6.png\" alt=\"\"> \n  <p>&nbsp;</p> \n  <p>4.参考代码：</p> \n  <div class=\"cnblogs_code\"> \n   <pre><span style=\"color: #0000ff;\">package</span><span style=\"color: #000000;\"> hongge;\r\n\r\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> org.testng.annotations.Test;\r\n</span><span style=\"color: #0000ff;\">import</span> <span style=\"color: #0000ff;\">static</span><span style=\"color: #000000;\"> org.testng.Assert.assertEquals;\r\n</span><span style=\"color: #0000ff;\">import</span><span style=\"color: #000000;\"> hongge.TestSum;\r\n\r\n</span><span style=\"color: #008000;\">/**</span><span style=\"color: #008000;\">\r\n * </span><span style=\"color: #808080;\">@author</span><span style=\"color: #008000;\"> 北京-宏哥\r\n * \r\n * java自动化测试交流群：694280102\r\n *\r\n * Java自动化测试框架-01 - TestNG之入门篇\r\n *\r\n * 2019年10月17日\r\n </span><span style=\"color: #008000;\">*/</span>\r\n<span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">class</span><span style=\"color: #000000;\"> NewTest {\r\n    </span><span style=\"color: #0000ff;\">private</span> TestSum newSum = <span style=\"color: #0000ff;\">new</span><span style=\"color: #000000;\"> TestSum();\r\n \r\n    @Test(groups </span>= { \"t1\", \"t2\"<span style=\"color: #000000;\"> })\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> f() {\r\n        </span><span style=\"color: #0000ff;\">int</span> mysum = newSum.add(1, 2<span style=\"color: #000000;\">);\r\n        assertEquals(</span>3, mysum, \"Right\"<span style=\"color: #000000;\">);\r\n        System.out.println(</span>\"运行f1方法\"<span style=\"color: #000000;\">);\r\n    }\r\n \r\n    @Test(groups </span>= { \"t2\"<span style=\"color: #000000;\"> })\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> f2() {\r\n        </span><span style=\"color: #0000ff;\">int</span> mysum = newSum.add(2, 2<span style=\"color: #000000;\">);\r\n        assertEquals(</span>3, mysum, \"Right\");<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\"> 错误的用例</span>\r\n        System.out.println(\"运行f2方法\"<span style=\"color: #000000;\">);\r\n    }\r\n \r\n    @Test(groups </span>= { \"t1\"<span style=\"color: #000000;\"> })\r\n    </span><span style=\"color: #0000ff;\">public</span> <span style=\"color: #0000ff;\">void</span><span style=\"color: #000000;\"> f3() {\r\n        </span><span style=\"color: #0000ff;\">int</span> mysum = newSum.add(1, 2<span style=\"color: #000000;\">);\r\n        assertEquals(</span>3, mysum, \"Right\"<span style=\"color: #000000;\">);\r\n        System.out.println(</span>\"运行f3方法\"<span style=\"color: #000000;\">);\r\n    }\r\n}</span></pre> \n  </div> \n </div> \n <div>\n  5.修改testNG.xml\n </div> \n <div> \n  <div class=\"cnblogs_code\"> \n   <pre><span style=\"color: #0000ff;\">&lt;?</span><span style=\"color: #ff00ff;\">xml version=\"1.0\" encoding=\"UTF-8\"</span><span style=\"color: #0000ff;\">?&gt;</span>\r\n<span style=\"color: #0000ff;\">&lt;!</span><span style=\"color: #ff00ff;\">DOCTYPE suite SYSTEM \"http://testng.org/testng-1.0.dtd\"</span><span style=\"color: #0000ff;\">&gt;</span>\r\n<span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">suite </span><span style=\"color: #ff0000;\">name</span><span style=\"color: #0000ff;\">=\"Suite\"</span><span style=\"color: #0000ff;\">&gt;</span>\r\n  <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">test </span><span style=\"color: #ff0000;\">name</span><span style=\"color: #0000ff;\">=\"Test\"</span><span style=\"color: #0000ff;\">&gt;</span>\r\n      <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">groups</span><span style=\"color: #0000ff;\">&gt;</span>\r\n        <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">run</span><span style=\"color: #0000ff;\">&gt;</span>\r\n            <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">include </span><span style=\"color: #ff0000;\">name </span><span style=\"color: #0000ff;\">=\"t1\"</span><span style=\"color: #0000ff;\">/&gt;</span>\r\n        <span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">run</span><span style=\"color: #0000ff;\">&gt;</span>\r\n    <span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">groups</span><span style=\"color: #0000ff;\">&gt;</span>\r\n    <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">classes</span><span style=\"color: #0000ff;\">&gt;</span>\r\n      <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">class </span><span style=\"color: #ff0000;\">name</span><span style=\"color: #0000ff;\">=\"hongge.NewTest\"</span><span style=\"color: #0000ff;\">/&gt;</span>\r\n    <span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">classes</span><span style=\"color: #0000ff;\">&gt;</span>\r\n  <span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">test</span><span style=\"color: #0000ff;\">&gt;</span> <span style=\"color: #008000;\">&lt;!--</span><span style=\"color: #008000;\"> Test </span><span style=\"color: #008000;\">--&gt;</span>\r\n<span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">suite</span><span style=\"color: #0000ff;\">&gt;</span> <span style=\"color: #008000;\">&lt;!--</span><span style=\"color: #008000;\"> Suite </span><span style=\"color: #008000;\">--&gt;</span></pre> \n  </div> \n  <p>6.右键点击testng.xml，选择run as-&gt; testNG suite：</p> \n  <p><img src=\"http://localhost:9090/blogImages/2019/10/17/9f4c6365-4cb4-41ae-b993-62da01ae0189.png\" alt=\"\"></p> \n  <p>&nbsp;</p> \n  <p>7.console输出结果：</p> \n  <p><img src=\"http://localhost:9090/blogImages/2019/10/17/1324b216-9875-4de2-adb9-76e90162e833.png\" alt=\"\"></p> \n  <p>&nbsp;</p> \n  <p>8.从上图我们清楚地可以看到：当运行t1测试组时，就仅仅运行f()和f3()方法。</p> \n </div> \n</div> \n<div>\n <img src=\"http://localhost:9090/blogImages/2019/10/17/41d8253e-8abf-4b53-a713-1123e87c9a07.html; charset=UTF-8\" alt=\"\">\n</div> \n<div>\n <img src=\"http://localhost:9090/blogImages/2019/10/17/fa44a42c-1547-4ad9-9f3b-5787e8887ddf.html; charset=UTF-8\" alt=\"\">\n <br>9.修改testNG.xml运行t2测试组，\n</div> \n<div>\n 修改XML文件：\n</div> \n<div> \n <div class=\"cnblogs_code\"> \n  <pre><span style=\"color: #0000ff;\">&lt;?</span><span style=\"color: #ff00ff;\">xml version=\"1.0\" encoding=\"UTF-8\"</span><span style=\"color: #0000ff;\">?&gt;</span>\r\n<span style=\"color: #0000ff;\">&lt;!</span><span style=\"color: #ff00ff;\">DOCTYPE suite SYSTEM \"http://testng.org/testng-1.0.dtd\"</span><span style=\"color: #0000ff;\">&gt;</span>\r\n<span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">suite </span><span style=\"color: #ff0000;\">name</span><span style=\"color: #0000ff;\">=\"Suite\"</span><span style=\"color: #0000ff;\">&gt;</span>\r\n  <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">test </span><span style=\"color: #ff0000;\">name</span><span style=\"color: #0000ff;\">=\"Test\"</span><span style=\"color: #0000ff;\">&gt;</span>\r\n      <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">groups</span><span style=\"color: #0000ff;\">&gt;</span>\r\n        <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">run</span><span style=\"color: #0000ff;\">&gt;</span>\r\n            <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">include </span><span style=\"color: #ff0000;\">name </span><span style=\"color: #0000ff;\">=\"t2\"</span><span style=\"color: #0000ff;\">/&gt;</span>\r\n        <span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">run</span><span style=\"color: #0000ff;\">&gt;</span>\r\n    <span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">groups</span><span style=\"color: #0000ff;\">&gt;</span>\r\n    <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">classes</span><span style=\"color: #0000ff;\">&gt;</span>\r\n      <span style=\"color: #0000ff;\">&lt;</span><span style=\"color: #800000;\">class </span><span style=\"color: #ff0000;\">name</span><span style=\"color: #0000ff;\">=\"hongge.NewTest\"</span><span style=\"color: #0000ff;\">/&gt;</span>\r\n    <span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">classes</span><span style=\"color: #0000ff;\">&gt;</span>\r\n  <span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">test</span><span style=\"color: #0000ff;\">&gt;</span> <span style=\"color: #008000;\">&lt;!--</span><span style=\"color: #008000;\"> Test </span><span style=\"color: #008000;\">--&gt;</span>\r\n<span style=\"color: #0000ff;\">&lt;/</span><span style=\"color: #800000;\">suite</span><span style=\"color: #0000ff;\">&gt;</span> <span style=\"color: #008000;\">&lt;!--</span><span style=\"color: #008000;\"> Suite </span><span style=\"color: #008000;\">--&gt;</span></pre> \n </div> \n <p>console结果：</p> \n</div> \n<div>\n <img src=\"http://localhost:9090/blogImages/2019/10/17/c2412eff-7805-405f-a23e-681abff04cc7.png\" alt=\"\"> \n <p>&nbsp;</p> \n <p>&nbsp;</p> \n</div> \n<div>\n 10.其中f2()方法故意留个错误，我们看下出现bug的情况：期望是4，但是不是3.\n</div> \n<div>\n <img src=\"http://localhost:9090/blogImages/2019/10/17/7db5f1c3-2790-45b2-8165-fdbc7c3ea077.png\" alt=\"\"> \n <p>11.哎呀！脑阔短路了，看测试报告不是更加直观啊，现在分享的就是它，请看下边吧：</p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/17/84d68552-fe04-4dfc-83c7-7d60e186e113.png\" alt=\"\"></p> \n <h2>小结</h2> \n <p><strong>额外知识：在java代码中，@Test(groups={\"t1\",\"t2\"})可以在大括号里指定多个组，中间用逗号分开就行。在testng.xml中<code>&lt;run&gt;</code>标签下还可以书写<code>&lt;exclude name=\"abc\"/&gt;</code>标签，表示不执行属于abc组的用例。</strong></p> \n <p><strong>好了，今天就分享到这里！！！</strong></p> \n</div> \n<div>\n &nbsp;\n</div> \n<div>\n &nbsp;\n</div> \n<div>\n &nbsp;\n</div> \n<div> \n <p><strong>个人公众号&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<strong>微信群</strong>&nbsp;（微信群已满100，可以加宏哥的微信拉你进群，请备注：进群）&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</strong></p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/17/9861e8f5-11d7-489c-b794-f340d2c4ca97.png\" alt=\"\" width=\"158\" height=\"158\">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src=\"http://localhost:9090/blogImages/2019/10/17/decbef7c-a87c-42aa-8b68-45a233812c81.png\" alt=\"\" width=\"182\" height=\"182\"></p> \n <p><span style=\"font-size: 18px;\"><strong><strong>您的肯定就是我进步的动力。</strong>如果你感觉还不错，就请鼓励一下吧！记得点波&nbsp;<span style=\"font-size: 18pt; color: #ff0000;\">推荐</span>&nbsp;哦！！！（点击右边的小球即可！(^__^)&nbsp;嘻嘻……）</strong></span></p> \n <p><img src=\"http://localhost:9090/blogImages/2019/10/17/14d81b9c-296c-41a2-85a7-4cf34e5e3065.gif\" alt=\"\"></p> \n</div> \n<div>\n <img src=\"http://localhost:9090/blogImages/2019/10/17/71422b1f-dee9-4524-a62e-7a1205472087.html; charset=UTF-8\" alt=\"\">\n</div>', NULL, '2019-10-17 17:37:52', 0, NULL, NULL, 'https://www.cnblogs.com/du-hong/p/11690388.html', 0, NULL);
INSERT INTO `t_blog` VALUES (260, '【WPF on .NET Core 3.0】 Stylet演示项目 - 简易图书管理系统(1)', '<p>.NET Core 3.0已经发布了,除了一大堆令人激动的功能以外,也增加了对WPF的正式支持, 那么WPF在.NET Core 3.0下的开发体验如何呢?</p> \n<p>本文利用了Stylet框架开发.NET Core 3.0上的WPF应用程序.关于Stylet框架, 可能大家比较陌生, 它是一个轻量级(但是非常优秀!)的WPF框架, 最近也更新了对.NET Core 3.0的支持, 关于Stylet的介绍可以浏览我之前的一篇博文: <a href=\"https://www.cnblogs.com/waku/p/6879809.html\">ViewModel从未如此清爽 - 轻量级WPF MVVM框架Stylet</a>.本文也包含了使用MVVM和Stylet的一些最佳实践.</p> \n<blockquote> \n <p>为了简单起见, 示例项目主要演示了使用Stylet开发WPF应用程序中常用的功能,如绑定,窗口弹出,表单验证等.没有使用数据库,也不包含如用户认证管理等一般的业务功能.</p> \n</blockquote> \n<p>项目全部代码都利用.NET的最新技术栈完成, 包括:</p> \n<ul> \n <li>VS2019</li> \n <li>.NET Core 3.0</li> \n <li>C# 8</li> \n</ul> \n<p>文中也会对其中的一些新特性做出说明.</p> \n<p>下面就来跟随我体会一下这个船新的版本吧!</p> \n<h1 id=\"前期准备\">前期准备</h1> \n<ul> \n <li>VS2019 16.3.2</li> \n <li>.NET Core SDK 3.0.100</li> \n <li><p>安装stylet模板</p> <p>打开cmd或powershell运行以下命令(确保.NET Core 3.0的SDK已安装):</p> \n  <blockquote> \n   <p>dotnet new -i Stylet.Templates</p> \n  </blockquote></li> \n <li><p>创建一个Stylet工程</p> \n  <blockquote> \n   <p>dotnet new stylet -o StyletBookStore</p> \n  </blockquote> <p>这样一个使用Stylet的WPF应用程序就创建好了!</p></li> \n</ul> \n<p>VS2019打开StyletBookStore.csproj, 直接按F5运行:</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/25ffdcad-ff26-4eda-8dff-8750cbcaa9a6.png\"></p> \n<p>OK. 感觉不错!</p> \n<h1 id=\"增加登录功能\">增加登录功能</h1> \n<p>虽然是个演示项目,但是我们还是需要登录界面的:), Stylet中一个界面至少需要两部分: \"ViewModel\"和\"View\". 我们来分别实现它们.</p> \n<h2 id=\"viewmodel\">ViewModel</h2> \n<p>在Pages文件夹下创建一个名为<code>LoginViewModel.cs</code>的类,用来实现登录的界面逻辑.并输入以下代码:</p> \n<pre class=\"c#\"><code>public class LoginViewModel : Screen\n{\n    /// &lt;summary&gt;\n    /// 用户名\n    /// &lt;/summary&gt;\n    public string UserName { get; set; } \n\n    /// &lt;summary&gt;\n    /// 密码\n    /// &lt;/summary&gt;\n    public string Password { get; set; }\n\n    /// &lt;summary&gt;\n    /// 登录\n    /// &lt;/summary&gt;\n    public void Login()\n    {\n        // 在这实现登录逻辑\n    }\n\n    /// &lt;summary&gt;\n    /// 登录的防护属性\n    /// &lt;/summary&gt;\n    public bool CanLogin =&gt; !string.IsNullOrEmpty(UserName) &amp;&amp;\n                            !string.IsNullOrEmpty(Password);\n}</code></pre> \n<ul> \n <li>该类继承了<code>Stylet.Screen</code>, 这是Stylet中一个常用的ViewModel基类.</li> \n <li>定义了两个public属性, 分别代表用户名和密码.</li> \n <li>定义了一个名为<code>Login</code>的方法,用来实现登录的逻辑.我们会在稍后实现它.</li> \n <li><p>定义了一个名为<code>CanLogin</code>的防护属性, 用来检查<code>Login</code>方法是否可以运行. 只有当用户名和密码都输入时,才允许运行登录方法.</p> \n  <blockquote> \n   <p>防护属性(Guard Properties)是Stylet的一个功能, 是一个返回布尔型的只读属性. 属性名的命名约定为Can + <em>防护的方法名</em>. 更多信息请浏览<a href=\"https://github.com/canton7/Stylet/wiki/Actions#guard-properties\">Guard Properties</a>.</p> \n  </blockquote></li> \n</ul> \n<h2 id=\"启用可空引用类型\">启用可空引用类型</h2> \n<p>下面我们试用一下C#8中新增加的特性: 可空引用类型.</p> \n<blockquote> \n <p>使用可空引用类型可在编译时就检查潜在的空引用问题.关于可空引用类型,请参考我之前翻译的一篇文章<a href=\"https://www.cnblogs.com/waku/p/10094691.html\">初试C# 8.0</a>中\"可空的引用类型\"章节.</p> \n</blockquote> \n<p>右键点击<code>StyletBookStore</code>工程,选择\"Edit Project File\":</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/c95b2d5f-cde8-48ab-9ec9-086b14e23efb.png\"></p> \n<p>在打开的StyletBookStore.csproj文件中增加一行配置:</p> \n<pre class=\"xml\"><code>&lt;Project Sdk=\"Microsoft.NET.Sdk.WindowsDesktop\"&gt;\n\n&lt;PropertyGroup&gt;\n    &lt;OutputType&gt;WinExe&lt;/OutputType&gt;\n    &lt;TargetFramework&gt;netcoreapp3.0&lt;/TargetFramework&gt;\n    &lt;RootNamespace&gt;StyletBookStore&lt;/RootNamespace&gt;\n    &lt;UseWPF&gt;true&lt;/UseWPF&gt;\n    &lt;Nullable&gt;enable&lt;/Nullable&gt;  &lt;!-- 启用可空引用类型 --&gt;\n&lt;/PropertyGroup&gt;\n\n...\n\n&lt;/Project&gt;</code></pre> \n<p>在启用可空引用类型后,再次编译工程会出现两个警告:</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/51d761dd-e6d4-405e-915b-9b5249ed8a28.png\"></p> \n<p>警告我们<code>UserName</code>和<code>Password</code>未初始化. 可能在之后的使用中出现空引用异常.解决办法有两个:</p> \n<ol> \n <li><p>为属性设置初始值</p> <pre class=\"c#\"><code>public string UserName { get; set; } = String.Empty;\npublic string Password { get; set; } = String.Empty;</code></pre> <p>为用户名和密码设置初始值: 空字符串</p></li> \n <li><p>将属性声明为可空类型</p> <pre class=\"c#\"><code>public string? UserName { get; set; }\npublic string? Password { get; set; }</code></pre> <p>使用?标识用户名和密码是可空类型</p></li> \n</ol> \n<p>这里我们使用第1种方法,将用户名和密码初始化为空字符串.再次编译,警告就消失了.</p> \n<h2 id=\"view\">View</h2> \n<p>在Pages文件夹下创建一个为名<code>LoginView.xaml</code>的文件,用来定义登录的UI. 其中主要的代码如下:</p> \n<pre class=\"xml\"><code>&lt;Window \n    ...\n    d:DataContext=\"{d:DesignInstance pages:LoginViewModel}\" \n    &gt;\n&lt;Grid&gt;\n    ...\n    &lt;TextBlock Grid.Row=\"0\" Grid.Column=\"0\" Text=\"用户名\" Margin=\"5\" VerticalAlignment=\"Center\" HorizontalAlignment=\"Right\"&gt;&lt;/TextBlock&gt;\n    &lt;TextBlock Grid.Row=\"1\" Grid.Column=\"0\" Text=\"密码\" Margin=\"5\" VerticalAlignment=\"Center\" HorizontalAlignment=\"Right\"&gt;&lt;/TextBlock&gt;\n    &lt;TextBox Grid.Row=\"0\" Grid.Column=\"1\" Margin=\"5\" Text=\"{Binding UserName, UpdateSourceTrigger=PropertyChanged}\"&gt;&lt;/TextBox&gt;\n    &lt;PasswordBox Grid.Row=\"1\" Grid.Column=\"1\" Margin=\"5\" wpf:PasswordHelper.Attach=\"True\" wpf:PasswordHelper.Password=\"{Binding Path=Password,Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}\"&gt;&lt;/PasswordBox&gt;\n    &lt;Button Grid.Row=\"2\" Grid.Column=\"0\" Grid.ColumnSpan=\"2\" Content=\"登录\" Margin=\"5\" Padding=\"15 5 15 5\" Command=\"{s:Action Login}\"&gt;&lt;/Button&gt;\n&lt;/Grid&gt;\n&lt;/Window&gt;</code></pre> \n<ul> \n <li>使用<code>d:DataContext=\"{d:DesignInstance ...}\"</code>为XAML设置设计时的数据源, 以在编写XAML时获得智能提示.</li> \n <li>出于安全性考虑, WPF中密码框不支持绑定.这里为了简单起见,使用了一个扩展的附加属性类<code>PasswordHelper</code>,用来实现Password的绑定.具体代码请浏览<a href=\"https://github.com/wakuflair/MyBlogDemoCode/blob/master/StyletBookStore/WPF/PasswordHelper.cs\">PasswordHelper</a></li> \n <li>使用<code>{s:Action Login}</code>将登录按钮的Command绑定到<code>Login</code>方法中, 这样按下登录按钮就会执行ViewModel中的Login方法. 这是Stylet提供的功能, 名为Action. 更多信息请浏览<a href=\"https://github.com/canton7/Stylet/wiki/Actions#actions-and-methods\">Actions and Methods</a></li> \n</ul> \n<h2 id=\"hotreload\">HotReload</h2> \n<p>VS2019为XAML增加了一个便利功能HotReload, 该功能可允许开发者在应用程序运行时修改XAML代码,并立即看到修改后的效果:</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/f248437f-fb82-41cd-b0b2-198048083a64.gif\"></p> \n<p>这样我们在设计UI时会方便很多:)</p> \n<h2 id=\"实现登录逻辑\">实现登录逻辑</h2> \n<p>修改<code>Login</code>方法,实现登录功能:</p> \n<pre class=\"c#\"><code>        /// &lt;summary&gt;\n        /// 登录\n        /// &lt;/summary&gt;\n        public void Login()\n        {\n            // 设计的非常健壮的用户验证机制:)\n            if (UserName != \"waku\" || Password != \"123\")\n            {\n                _windowManager.ShowMessageBox(\"用户名或密码不正确\", \"登录失败\", MessageBoxButton.OK, MessageBoxImage.Exclamation);\n                return;\n            }\n\n            RequestClose(true);\n        }</code></pre> \n<ul> \n <li><p>当用户输入的用户名和密码不符合我们非常<strong>健壮</strong>的验证规则时,弹出错误信息.</p> <p>这里使用了<code>WindowManager.ShowMessageBox</code>来显示消息对话框, <code>WindowManager</code>是Stylet提供的功能, 专门用来管理窗口的显示.</p> <p>为了使用<code>WindowManager</code>, 在ViewModel中声明一个<code>IWindowManager</code>接口类型的成员变量,并使用Stylet内置的IoC功能将它的实例通过构造方法注入进去.</p> <pre class=\"c#\"><code>    private readonly IWindowManager _windowManager;\n    public LoginViewModel(IWindowManager windowManager)\n    {\n        _windowManager = windowManager;\n    }</code></pre> <p>这样就可在ViewModel中使用WindowManager了</p> \n  <blockquote> \n   <p>也许你更习惯使用<code>MessageBox.Show</code>来显示消息对话框, 但这么做你的ViewModel就和UI组件耦合在一起了,而这是违反MVVM设计模式的. 想象一下你需要为你的ViewModel编写测试代码时, 因为其中使用了<code>MessageBox.Show</code>, 那么在测试中处理与UI组件的交互就变成了很困难的事. 而使用Stylet中的<code>WindowManager</code>,你可以在测试中Mock它的接口<code>IWindowManager</code>来模拟消息框的行为.</p> \n  </blockquote></li> \n <li><p>验证通过后,我们使用<code>RequestClose(true)</code>通知Stylet关闭Login窗口,并返回结果<code>true</code>.</p></li> \n</ul> \n<p>至此我们的登录ViewModel就完成了, 完整的代码如下:</p> \n<pre class=\"c#\"><code>using System;\nusing System.Windows;\nusing Stylet;\n\nnamespace StyletBookStore.Pages\n{\n    public class LoginViewModel : Screen\n    {\n        private readonly IWindowManager _windowManager;\n\n        /// &lt;summary&gt;\n        /// 用户名\n        /// &lt;/summary&gt;\n        public string UserName { get; set; } = String.Empty;\n\n        /// &lt;summary&gt;\n        /// 密码\n        /// &lt;/summary&gt;\n        public string Password { get; set; } = String.Empty;\n\n        public LoginViewModel(IWindowManager windowManager)\n        {\n            _windowManager = windowManager;\n        }\n\n        /// &lt;summary&gt;\n        /// 登录\n        /// &lt;/summary&gt;\n        public void Login()\n        {\n            // 设计的非常安全的用户验证机制:)\n            if (UserName != \"waku\" || Password != \"123\")\n            {\n                _windowManager.ShowMessageBox(\"用户名或密码不正确\", \"登录失败\", MessageBoxButton.OK, MessageBoxImage.Exclamation);\n                return;\n            }\n\n            RequestClose(true);\n        }\n\n        /// &lt;summary&gt;\n        /// 登录的防护属性\n        /// &lt;/summary&gt;\n        public bool CanLogin =&gt; !string.IsNullOrEmpty(UserName) &amp;&amp; !string.IsNullOrEmpty(Password);\n    }\n}</code></pre> \n<p>此时工程结构应该是这样的:</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/7dfec851-cb0a-47eb-80ef-2189f1d5b24a.png\"></p> \n<h2 id=\"显示登录窗口\">显示登录窗口</h2> \n<p>我们已经准备好登录窗口了, 但是如何显示它呢? 还记得Stylet为我们准备好的<code>ShellView</code>和<code>ShellViewModel</code>吗? 它们就是负责程序的主窗口的,就从它们入手.</p> \n<p>按以往的经验, 可能在<code>ShellView.xaml.cs</code>中写下这样的代码:</p> \n<pre class=\"c#\"><code>    public ShellView()\n    {\n        InitializeComponent();\n        Loaded += OnLoaded;\n    }\n    private void OnLoaded(object sender, RoutedEventArgs e)\n    {\n        var window = new LoginView();\n        window.ShowDialog();\n    }</code></pre> \n<p>实际上这也是违反MVVM的, 因为我们直接操作了视图, 正确的做法是以ViewModel为中心, 由ViewModel来驱动各视图的显示.</p> \n<blockquote> \n <p>实际上你可以直接从工程中删除所有的.xaml.cs文件, Stylet不需要它们!</p> \n</blockquote> \n<p>我们来看看使用Stylet该如何实现.</p> \n<p>在<code>ShellViewModel</code>类中增加<code>OnViewLoaded</code>的重写方法:</p> \n<pre class=\"c#\"><code>    protected override void OnViewLoaded()\n    {\n        var loginViewModel = _container.Get&lt;LoginViewModel&gt;();\n        var result = _windowManager.ShowDialog(loginViewModel);\n        if (result != true)\n        {\n            RequestClose();\n        }\n    }</code></pre> \n<ul> \n <li>OnViewLoaded方法是基类<code>Screen</code>中定义的一个方法, 当ViewModel绑定的View加载完成后会调用该方法.</li> \n <li>使用<code>Container.Get</code>方法获取<code>LoginViewModel</code>的实例.<code>Container</code>是Stylet中IoC的容器, 通过它的<code>Get</code>方法我们可以取得所有注册到IoC中类的实例.</li> \n <li>然后调用<code>WindowManager.ShowDialog</code>, 并将<code>LoginViewModel</code>实例做为参数传递进去.Stylet就会为我们显示子窗口了.</li> \n <li>当登录窗口关闭后, 判断窗口的返回值如果不是true, 代表登录失败. 这里和登录一样,我们仍然调用<code>RequestClose</code>进行关闭操作, 但是因为Shell是主窗口, 该窗口关闭后整个应用程序也随之退出了.</li> \n</ul> \n<p>为了使用<code>Container</code>和<code>WindowManager</code>, 我们同样在构造方法中将其注入,并使用类成员变量来接收它们:</p> \n<pre class=\"c#\"><code>    private readonly IContainer _container;\n    private readonly IWindowManager _windowManager;\n\n    public ShellViewModel(IContainer container, IWindowManager windowManager)\n    {\n        _container = container;\n        _windowManager = windowManager;\n    }</code></pre> \n<p>这与在登录中注入<code>WindowManager</code>基本类似, 就不再解释了.</p> \n<blockquote> \n <p>注入<code>Container</code>并使用<code>Get</code>方法, 被称为\"服务定位模式\"(Service Locator Pattern), 对于它是否也违反了MVVM有很多争议. Stylet的WIKI上对此也有<a href=\"https://github.com/canton7/Stylet/wiki/StyletIoC-Factories\">讨论和解决办法</a>. 但是我个人很喜欢这种方式.</p> \n</blockquote> \n<p>完整的<code>ShellViewModel</code>类代码如下:</p> \n<pre class=\"c#\"><code>using Stylet;\nusing StyletIoC;\n\nnamespace StyletBookStore.Pages\n{\n    public class ShellViewModel : Screen\n    {\n        private readonly IContainer _container;\n        private readonly IWindowManager _windowManager;\n\n        public ShellViewModel(IContainer container, IWindowManager windowManager)\n        {\n            _container = container;\n            _windowManager = windowManager;\n        }\n\n        protected override void OnViewLoaded()\n        {\n            var loginViewModel = _container.Get&lt;LoginViewModel&gt;();\n            var result = _windowManager.ShowDialog(loginViewModel);\n            if (result != true)\n            {\n                RequestClose();\n            }\n        }\n    }\n}</code></pre> \n<h2 id=\"运行\">运行</h2> \n<p>好了, 我们的第一个功能 - \"登录\"就已经完成了, 编译运行应用程序:</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/35a00b2e-0402-4296-b0cd-53ca51a05283.png\"></p> \n<p>我们需要确认以下4个功能点:</p> \n<ul> \n <li>当\"用户名\"或\"密码\"为空时, 是不允许登录的(\"登录\"按钮处于禁用状态).</li> \n <li>用户名输入\"waku\", 并且密码输入\"123\", 点击\"登录\"按钮, 登录窗口关闭, 回到主窗口.</li> \n <li>否则显示\"用户名或密码不正确\"的消息框.</li> \n <li>点击登录窗口右上角的\"X\"按钮,整个应用程序退出.</li> \n</ul> \n<p>需要确认的功能点很少, 所以我们手动确认也可很快完成, 但是对于复杂一些的应用程序, 手动确认就很麻烦了, 而且在频繁的迭代过程中, 回归测试也很必要. 所以下一篇文章中我们会学习如何为ViewModel编写单元测试代码.</p> \n<p>本篇到此为止, 希望朋友们能多多留言. 源码托管在<a href=\"https://github.com/wakuflair/MyBlogDemoCode/tree/master/StyletBookStore\">GITHUB</a>上.</p> \n<p>Happy Coding~</p>', NULL, '2019-10-17 17:37:54', 1, NULL, NULL, 'https://www.cnblogs.com/waku/p/11692434.html', 0, NULL);
INSERT INTO `t_blog` VALUES (261, '从机器学习到深度学习资料整理', '<p style=\"text-align: center;\"><strong><span style=\"font-size: 18px;\">从机器学习到深度学习资料整理</span></strong></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 15px;\">　　<span style=\"font-size: 16px;\">在过去的大半年中，博主一直在进行人工智能相关知识的自学。由于人工智能最近两年的火热，从网上能够找到非常多的资料，包括：MOOC、博客等，博主也花费了很多的时间从众多的资源中找到了一条“从入门到进阶”的学习之路。在此，博主根据自己的学习体验，将所用到的资料汇总在本片博文中。由于博主目前的研究对象主要是图像，因此在材料选择的过程中会重点关注图像方面的知识，但是博主在下文中所推荐的资料中也涵盖了关于文本、语音处理的内容，读者可以根据自己的需要选择性阅读。</span></span></p> \n<p style=\"text-align: left;\"><strong><span style=\"font-size: 16px;\">一、入门资料</span></strong></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　（1）吴恩达《机器学习》（网易云课堂）</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　入门学习的首选，课程全面介绍了机器学习的基础知识，很少涉及到高深的理论或者证明，通过学习这个课程可以帮助初学者快速掌握机器学习的经典算法，并且获得对机器学习相关技术的全面认识。吴老师在授课的时候使用的是matlab（octave），并且课程还有相应的练习（可在网络上面找到）。所配套的练习通过指导编程实践一步步地教初学者完成课程中相关的算法，完成该练习可进一步加深学习者对机器学习基础知识的认识。博主感觉该课程非常适合作为初学者的首选课程。</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　（2）斯坦福大学 <a href=\"http://cs231n.github.io/\" target=\"_blank\">CS231 Convolutional Neural Networks for Visual Recognition</a>&nbsp;课程</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　由斯坦福大学李飞飞课题组开设的关于深度学习（主要是图像方面）的课程。尽管该课程最终的目的主要是介绍卷积神经网络的，但是在课程内容的前大半会详细地介绍并且解读一些机器学习的基础内容，例如：cross-entropy loss， stochastic gradient descent，backpropagation和各种响应函数等，这些内容是对吴恩达老师教学内容的巨大补充，需要仔细阅读并且掌握。其中，博主尤其认为好好研究一下梯度下降法，领会该算法的运算过程是十分重要的，博主的这一篇<a href=\"https://www.cnblogs.com/AlgrithmsRookie/p/11442235.html\" target=\"_blank\">博客</a>或许能够对读者有些许帮助。该课程的视频内容好像可以在B站上面找到，而且也随课程配套了相应的编程练习（以python为编程语言）。</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　（2）吴恩达《卷积神经网络》（网易云课堂）</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　对于需要从事图像相关算法研究的读者，肯定无法绕开卷积神经网络。吴恩达老师在网易云课堂的微专业中提供了一个专门针对卷积神经网络的课程。该课程和《机器学习》课程的讲授风格十分类似，非常适合对卷积神经网络没有太多背景知识的读者学习。另外，上述第二个课程的后半部分也有专门针对卷积神经网络的内容，可以搭配本课程的内容一起学习。</span></p> \n<p style=\"text-align: left;\"><strong><span style=\"font-size: 16px;\">二、实践资料</span></strong></p> \n<p style=\"text-align: left;\"><strong><span style=\"font-size: 16px;\">　　</span></strong><span style=\"font-size: 16px;\">经过对上述内容的学习之后，我相信读者对深度学习的基础内容就有了一个初步的掌握，接下来就可以通过一些自主的编程实践来内化所学到的知识，使得它们成为自己的傍身技能。接下来博主就介绍两部分别针Tensorflow和Keras应用的书籍。</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　（1）Learning Tensorflow: A Guide to Building Deep Learning System(by Tom Hope, Yehezkel S.Resheff &amp; Itay Lieder)</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　Tensorflow是目前最广为应用的深度学习框架，大量的深度学习算法都应用到了该框架，也因此是从事相关工作人员所必须掌握的框架之一。博主所推荐的这本书好像是谷歌公司的研发人员所编著的，书中的内容主要介绍了Tensorflow框架的安装，基本组成及如何在不同的深度学习任务中应用该框架。对每一部分的内容，书中配备了很详细的代码供读者参考，非常利于学习者的实践操作，而且本书中还对一些模型的基础知识进行了回顾，这些内容能够很好地帮助学习者将基础概念与实践操作结合起来。</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　（2）Deep Learning with Python(by Francois Chollet)</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　这本书所介绍的框架是Keras，这是一个建立在Tensorflow上的高级深度学习库（目前已经是Tensorflow官方的高级接口），相较于Tensorflow，应用该框架建模更为简洁、直观，而且提供了丰富的函数供研发人员使用。博主所推荐的这本书是Keras库的第一版的作者所写的，书中的内容涵盖了从机器学习到深度学习应用的全部内容，并且提供了大量的代码示例，这本书在博主看来既是一本全面回顾机器学习到深度学习发展脉络和基础知识的教材，也是一本应用Keras库的参考指南。</span></p> \n<p style=\"text-align: left;\"><strong><span style=\"font-size: 16px;\">三、理论进阶</span></strong></p> \n<p style=\"text-align: left;\"><strong><span style=\"font-size: 16px;\">　　</span></strong><span style=\"font-size: 16px;\">相较于上述所推荐的内容\"知其然，而不知其所以然“的特点，这一部分所推荐的资料会聚焦于机器学习和深度学习更为理论化的一面，博主主要推荐的两本材料为：《统计学习方法》和线上图书《Deep Learning》</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　（1）《统计学习方法》 李航著</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　李航老师的这本书关注的是机器学习的理论剖析，对机器学习的基本元素、常见算法，进行了数学上的定义、分析和推演，通过对这些内容的学习，我觉得会让读者对这些算法有更为深刻的认识。从博主自己目前阅读体验来看，感觉很有难度，需要较为扎实的数学功底才能够明白老师在书中所讲解的内容。</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　（2）<a href=\"http://www.deeplearningbook.org/\" target=\"_blank\">《Deep Learning》</a>（by&nbsp;</span><span style=\"font-size: 16px;\">Ian Goodfellow and Yoshua Bengio and Aaron Courville</span><span style=\"font-size: 16px;\">）</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　这是一本线上的图书，兼顾深度学习内容的广度和深度，涵盖了十分丰富的学习内容。其中第一部分概括性地讲解了学习者所必备的基础知识，包括：线性代数、概率论与信息论等，读者可以根据这部分内容的指引查漏补缺。第二部分则介绍了目前已经非常成熟的深度学习技术，包括：神经网络、卷积神经网络、序列信号处理等。第三部分则介绍了目前还处于积极研究的深度学习领域，包括特征学习等等。书中的很多内容都有非常详细的理论探讨和数学推导，博主感觉是一本非常难啃的书。</span></p> \n<p style=\"text-align: left;\"><span style=\"font-size: 16px;\">　　最后，博主给大家提供两个网站链接：<a href=\"https://booksc.xyz/\" target=\"_blank\">链接1</a>和<a href=\"https://www.jiumodiary.com/\" target=\"_blank\">链接2</a>，大家可以在其中找到非常丰富的免费学习资料。最后祝大家学习愉快，早日成为领域大牛！<a href=\"https://booksc.xyz/\" target=\"_blank\"><br></a></span></p> \n<p style=\"text-align: left;\"><span style=\"color: #3366ff;\"><strong><span style=\"font-size: 16px;\">##本文为博主原创内容，转摘请注明出处。</span></strong></span></p>', NULL, '2019-10-17 17:37:54', 0, NULL, NULL, 'https://www.cnblogs.com/AlgrithmsRookie/p/11692444.html', 0, NULL);
INSERT INTO `t_blog` VALUES (262, 'MyBatis拦截器自定义分页插件实现', '<p><code>MyBaits</code>是一个开源的优秀的持久层框架，SQL语句与代码分离，面向配置的编程，良好支持复杂数据映射，动态SQL;<code>MyBatis</code> 是支持定制化 SQL、存储过程以及高级映射的优秀的持久层框架。MyBatis 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。MyBatis 可以对配置和原生Map使用简单的 XML 或注解，将接口和 Java 的 POJOs(Plain Old Java Objects,普通的 Java对象)映射成数据库中的记录。<br> 通常使用<code>MyBatis</code>时使用以下几种形式进行分页:</p> \n<ol> \n <li>逻辑分页：RowBounds</li> \n <li><p>物理分页: 在SQL里面使用LIMIT或者使用第三方插件（PageHelper等）</p> <h4 id=\"环境及介绍\">环境及介绍</h4> 导入核心依赖:</li> \n</ol> \n<pre class=\"xml\"><code> &lt;!-- SpringBoot MyBatis starter --&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;\n    &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;\n    &lt;version&gt;1.2.2&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n    &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n&lt;/dependency&gt;</code></pre> \n<p>搭建环境步骤可以参考：<a href=\"https://www.cnblogs.com/SimpleWu/p/9798146.html\">SpringBoot企业中常用starter</a><br> 本次主要实现一个接口<code>org.apache.ibatis.plugin.Interceptor</code>,在接口中有3个方法为:</p> \n<pre class=\"java\"><code>Object intercept(Invocation invocation) throws Throwable;\n\nObject plugin(Object target);\n\nvoid setProperties(Properties properties);</code></pre> \n<ol> \n <li>intercept 方法是主要拦截执行方法。</li> \n <li>plugin 方法是决定当前对象是否需要生成代理对象。</li> \n <li><p>setProperties 设置运行时mybatis核心配置参数方法。<br> Mybatis的拦截器实现机制,使用的是<code>JDK</code>的<code>InvocationHandler</code>,当我们调用<code>ParameterHandler,ResultSetHandler,StatementHandler,Executor</code>的对象的时候,实际上使用的是<code>Plugin</code>这个代理类的对象,这个类实现了InvocationHandler接口。<br> 当我们调用<code>ParameterHandler,ResultSetHandler,StatementHandler,Executor</code>的对象的时候,<br> 实际上使用的是<code>Plugin</code>这个代理类的对象,这个类实现了<code>InvocationHandler</code>接口。</p> <h4 id=\"自定义分页实现\">自定义分页实现</h4> 创建<code>Pager</code>实体对象，用来进行分页，实体内容如下:</li> \n</ol> \n<pre class=\"java\"><code>@Data\n@ToString\npublic class Pager {\n    /*当前页*/\n    private int page;\n    /*每页大小*/\n    private int size;\n    /*总记录*/\n    private long total;\n    /*总页数*/\n    private int totalPage;\n    /*自定义分页sql*/\n    private String customSQL;\n    /*分页执行时长*/\n    private long executeTime;\n}</code></pre> \n<p>这里<code>customSQL</code>变量为自定义分页SQL,很多时候以为sql过于复杂关联了N张表，获取了N个字段会造成查询时间过于缓慢，加入这个字段主要是为了在一些复杂的SQL中不暴力使用默认的分页数量统计，可以自己根据SQL去除不需要的字段，已经不需要的表连接后的SQL来执行分页数量的统计。<br> 定义分页处理接口<code>PagerHandler</code>，内容如下:</p> \n<pre class=\"java\"><code>public interface PagerHandler {\n    /**\n     * 获取sql执行参数\n     * @param boundSql\n     * @return\n     */\n    public Pager getPager(BoundSql boundSql);\n\n    /**\n     * 执行分页\n     *\n     * @param pager\n     * @param boundSql\n     * @param connection\n     * @param metaObject\n     * @return\n     * @throws SQLException\n     */\n    public Pager executer(Pager pager, BoundSql boundSql, Connection connection, MetaObject metaObject) throws SQLException;\n}</code></pre> \n<p>创建MyBats拦截器实现分页<code>PagerMyBatisInterceptor</code>,该类实现接口<code>org.apache.ibatis.plugin.Interceptor</code>和我们自己定义的<code>PagerHandler</code>，重写接口中方法。<br> 我们还需要告诉MyBatis具体在什么地点进行拦截，使用<code>@Intercepts</code>来标注：</p> \n<pre class=\"java\"><code>@Intercepts(value = {\n        @Signature(type = StatementHandler.class, method = \"prepare\", args = {Connection.class, Integer.class})})</code></pre> \n<p>主要拦截<code>StatementHandler</code>中<code>prepare</code>编译参数方法该方法需要传入参数类型为<code>Connection.class, Integer.class</code>，在<code>MyBatis 3.4.1</code>版本下参数只有一个<code>Connection</code><br> 在类中定义一些常量:</p> \n<pre class=\"java\"><code>private final Logger log = LoggerFactory.getLogger(PagerMyBatisInterceptor.class);\n\nprivate final int CONNECTION_INDEX = 0; //连接参数索引\n\nprivate final DefaultReflectorFactory DEFAULT_REFLECTOR_FACTORY = new DefaultReflectorFactory();//默认反射工厂\n\nprivate final String DELEGATE_MAPPED_STATEMENT = \"delegate.mappedStatement\";//反射值获取路径\n\nprivate final String DELEGATE_PARAMETER_HANDLER = \"delegate.parameterHandler\";//反射值获取路径</code></pre> \n<p>具体拦截器内容:</p> \n<pre class=\"java\"><code>@Component\n@Intercepts(value = {\n        @Signature(type = StatementHandler.class, method = \"prepare\", args = {Connection.class, Integer.class})})\npublic class PagerMyBatisInterceptor implements PagerHandler, Interceptor {\n\n    private final Logger log = LoggerFactory.getLogger(PagerMyBatisInterceptor.class);\n\n    private final int CONNECTION_INDEX = 0;\n\n    private final DefaultReflectorFactory DEFAULT_REFLECTOR_FACTORY = new DefaultReflectorFactory();\n\n    private final String DELEGATE_MAPPED_STATEMENT = \"delegate.mappedStatement\";\n\n    private final String DELEGATE_PARAMETER_HANDLER = \"delegate.parameterHandler\";\n\n    @Override\n    public Object intercept(Invocation invocation) throws Throwable {\n        Object[] args = invocation.getArgs();\n        //数据库连接\n        Connection connection = (Connection) args[CONNECTION_INDEX];\n        //负责处理Mybatis与JDBC之间Statement的交互\n        StatementHandler statementHandler = (StatementHandler) invocation.getTarget();\n        //MetaObject是Mybatis提供的一个用于方便、优雅访问对象属性的对象，通过它可以简化代码、不需要try/catch各种reflect异常，同时它支持对JavaBean、Collection、Map三种类型对象的操作。\n        MetaObject metaObject = MetaObject.forObject(statementHandler, SystemMetaObject.DEFAULT_OBJECT_FACTORY,\n                SystemMetaObject.DEFAULT_OBJECT_WRAPPER_FACTORY, DEFAULT_REFLECTOR_FACTORY);\n        //MappedStatement表示的是XML中的一个SQL\n        MappedStatement mappedStatement = (MappedStatement) metaObject.getValue(DELEGATE_MAPPED_STATEMENT);\n        //SqlCommandType代表SQL类型\n        SqlCommandType sqlCommandType = mappedStatement.getSqlCommandType();\n        //BoundSql则是其保存Sql语句的对象\n        BoundSql boundSql = statementHandler.getBoundSql();\n        //分页对象\n        Pager pager = getPager(boundSql);\n        if (sqlCommandType.compareTo(SqlCommandType.SELECT) == 0 &amp;&amp; pager != null) {\n            executer(pager, boundSql, connection, metaObject);\n            //执行查询\n            int left = (pager.getPage() - 1) * pager.getSize();\n            int right = pager.getSize();\n            String rewriteSql = boundSql.getSql() + \" LIMIT \" + left + \",\" + right;\n            metaObject.setValue(\"boundSql.sql\", rewriteSql);\n        }\n        long startTime = System.currentTimeMillis();\n        Object proceed = invocation.proceed();\n        long endTime = System.currentTimeMillis();\n        log.info(\"SQL TYPE [{}] , SQL EXECUTE TIME [{}] SQL:\\n{}\", sqlCommandType, startTime - endTime, boundSql.getSql().toUpperCase());\n        return proceed;\n    }\n\n    @Override\n    public Object plugin(Object target) {\n        return Plugin.wrap(target, this);\n    }\n\n    @Override\n    public void setProperties(Properties properties) {\n        //TODO 设置mybatis参数\n    }\n\n    @Override\n    public Pager getPager(BoundSql boundSql) {\n        Object parameterObject = boundSql.getParameterObject();\n        if (parameterObject instanceof Pager) {\n            return (Pager) parameterObject;\n        } else if (parameterObject instanceof Map) {\n            Map&lt;String, Object&gt; paramMap = (Map&lt;String, Object&gt;) parameterObject;\n            Iterator&lt;String&gt; keys = paramMap.keySet().iterator();\n            while (keys.hasNext()) {\n                String key = keys.next();\n                Object obj = paramMap.get(key);\n                if (obj instanceof Pager) {\n                    return (Pager) obj;\n                }\n            }\n\n        }\n        return null;\n    }\n\n    @Override\n    public Pager executer(Pager pager, BoundSql boundSql, Connection connection, MetaObject metaObject) throws SQLException {\n        if (pager.getPage() == 0) {\n            pager.setPage(0);\n        }\n        if (pager.getSize() == 0) {\n            pager.setSize(0);\n        }\n        if (pager.getCustomSQL() == null) {\n            //如果自己没有定义分页SQL,那么使用默认暴力分页\n            pager.setCustomSQL(\"SELECT COUNT(1) FROM (\" + boundSql.getSql() + \" ) tmp_table\");\n        }\n        // 预编译\n        PreparedStatement prepareStatement = connection.prepareStatement(pager.getCustomSQL());\n        // 预编译执行\n        ParameterHandler parameterHandler = (ParameterHandler) metaObject.getValue(DELEGATE_PARAMETER_HANDLER);\n        parameterHandler.setParameters(prepareStatement); // 给sql语句设置参数\n        long startTime = System.currentTimeMillis();\n        ResultSet resultSet = prepareStatement.executeQuery();\n        long endTime = System.currentTimeMillis();\n        log.info(\"sql execute time {} sql:\\n{}\", startTime - endTime, pager.getCustomSQL().toUpperCase());\n        if (resultSet.next()) {\n            long total = (long) resultSet.getObject(1);// 总记录数量\n            int totalPageNum = (int) ((total + pager.getSize() - 1) / pager.getSize());\n            pager.setTotal(total);\n            pager.setTotalPage(totalPageNum);\n            pager.setExecuteTime(startTime - endTime);\n        }\n        return pager;\n    }\n}</code></pre> \n<p>通过方法<code>getPager</code>获取到pager对象,如果是Map参数那么就优先第一个通过引用的传递在<code>BoundSql</code>对象中获取到,然后执行分页获取里面的值进行计算,通过引用对象返回总记录数，总页数等。<br> 在SpringBoot中如果需要使拦截器生效只需要在类型使用<code>@Component</code>将该类交给<code>Spring IOC</code>管理即可,至于拦截器顺序如：<br> 有拦截器 <code>PagerMyBatisInterceptor</code> 与 <code>OneInterceptor</code> ,想要分页拦截器作为第二个拦截器只需要在类上标注<code>@ConditionalOnBean(OneInterceptor)</code>即可,在第一个拦截器实例化后再实例化第二个拦截器.</p> \n<h4 id=\"pager使用方式\">Pager使用方式</h4> \n<pre class=\"java\"><code> List&lt;Map&lt;String, Object&gt;&gt; selectUser(Pager pager);\n List&lt;Map&lt;String, Object&gt;&gt; selectUser(Map&lt;String,Object&gt; paramMap);</code></pre> \n<p>创建一个Pager对象传入即可。<br> 本文源码地址:https://github.com/450255266/open-doubi/tree/master/spring-boot/custom-mybatis-pager</p>', NULL, '2019-10-17 17:37:55', 0, NULL, NULL, 'https://www.cnblogs.com/SimpleWu/p/11692424.html', 0, NULL);
INSERT INTO `t_blog` VALUES (263, '初次进入职场如何工作与学习', '<ul> \n <li><a href=\"#prepare\">心理准备</a></li> \n <li><a href=\"#work\">如何工作</a> \n  <ul> \n   <li><a href=\"#rule\">遵守职场规则</a></li> \n   <li><a href=\"#result\">坚持结果导向</a></li> \n  </ul></li> \n <li><a href=\"#study\">如何学习</a> \n  <ul> \n   <li><a href=\"#teacher\">三人行必有我师</a></li> \n   <li><a href=\"#stack\">公司的技术栈</a></li> \n   <li><a href=\"#department\">跨部门取经</a></li> \n   <li><a href=\"#guihua\">确定职业规划</a></li> \n  </ul></li> \n</ul> \n<p>  每年毕业季，大量的毕业生参加工作，成为真正的职场人士。有的同学在学校里参加学生活动，或者实习经历很丰富，在职场的表现就很好。但是有的同学，由于性格或者其他种种原因，在职场里显得迟钝和平庸。首先，我们要接受自己的现状，不抱怨不放弃，然后认清自己的缺点，用正确的方法改进。怎么样才能更好的工作和学习，获得领导与同事的赏识，获得各方面的提升呢？此文献给初入职场的毕业生以及当年懵懂的老程序员们。</p> \n<h3 id=\"心理准备\"><a name=\"prepare\">心理准备</a></h3> \n<p>  相比复杂多元的社会，学校是比较单纯和宽松的环境，许多同学在玩耍中就度过了四年，缺乏足够的社会活动和心理抗压能力。在进入企业后，要做好这些心理准备：</p> \n<ul> \n <li>任务完成的不好，将会收到批评。</li> \n <li>重复做简单低价值的事，感到失落。</li> \n <li>交不到合适的朋友，感到孤独。</li> \n <li>与上级相处不和睦，不受待见。</li> \n</ul> \n<p>产生这些常见的负面情绪，是因为还保留着“学生心理”：</p> \n<ul> \n <li>我想被安排好，按大学课程表那样按部就班。</li> \n <li>我想被照顾好，想大学室友那样温暖贴心。</li> \n</ul> \n<p>企业是以盈利为目的，高度强调效率与协作的组织，上级可以指挥你教训你，而不能安排你的人生，正确的道路要自己探索。在企业我们都是螺丝钉，没人时时刻刻在乎螺丝钉的情绪。</p> \n<h3 id=\"如何工作\"><a name=\"work\">如何工作</a></h3> \n<h4 id=\"遵守职场规则\"><a name=\"rule\">遵守职场规则</a></h4> \n<ul> \n <li>遵守公司的各项规章制度，譬如文档规范、代码规范。</li> \n <li>尊重各级领导和同事，至少要做好表面功夫。</li> \n <li>不贬低或者诋毁同事，不说公司的坏话。</li> \n <li>多和异性同事交流，尤其是漂亮单身的。</li> \n</ul> \n<h4 id=\"坚持结果导向\"><a name=\"result\">坚持结果导向</a></h4> \n<ul> \n <li>分配的任务一定保质保量完成，哪怕是加班。</li> \n <li>答应同事的事情一定要做到，譬如帮他改数据。</li> \n <li>KPI再荒谬也要认真对待，公司按KPI得分发奖金。</li> \n</ul> \n<h3 id=\"如何学习\"><a name=\"study\">如何学习</a></h3> \n<h4 id=\"三人行必有我师\"><a name=\"teacher\">三人行必有我师</a></h4> \n<ul> \n <li>看看公司的技术WIKI，学习过往的项目经验和写文档的技巧。</li> \n <li>向上级领导学习，学习他的沟通技巧和思维方式。</li> \n <li>向优秀的同事学习，学习他的编码能力和排错能力。</li> \n</ul> \n<h4 id=\"公司的技术栈\"><a name=\"stack\">公司的技术栈</a></h4> \n<p>  初次接触公司的项目，先弄清楚它实现了哪些重要需求，在公司业务栈中所处的位置。然后理清整个系统的技术栈，用到哪些开发语言和中间件、运维工具，最后画出系统架构图。有一些公司的WIKI上也许已经有了架构图，但是自己画一遍才能更好的理解。画图的过程中，你也许会有当上了架构师指点江山的感觉。</p> \n<h4 id=\"跨部门取经\"><a name=\"department\">跨部门取经</a></h4> \n<p>  如果你是后端开发工程师，不应该鄙视前端部门，应该跨部门取经，积极向他们学习。目前的项目多是前后端分离开发，如果你对前端的工作完全不了解，如何更好为他们提供接口呢？许多性能优化的方案，其实不一定局限在某一端，而是前后端都能实施。掌握一些前端知识，让你的思路更宽阔。最重要的是，有一些前端同学是漂亮的女孩子，近水楼台的道理还需多说吗？</p> \n<h4 id=\"确定职业规划\"><a name=\"guihua\">确定职业规划</a></h4> \n<p>  尽早尽早确定职业规划，这是无数IT人的头发和泪水换来的教训。一般来说，中大型公司会提供管理和技术两个晋升方向。要依照自己的性格和爱好，确定职业规划。如果你性格开朗、善于发言等等，可以选择技术管理；如果你性格内敛、酷爱技术，那就选择架构师等技术方向；如果你家里有一栋楼收租，无所谓方向。</p>', NULL, '2019-10-17 17:37:55', 0, NULL, NULL, 'https://www.cnblogs.com/xiaoyangjia/p/11691889.html', 0, NULL);
INSERT INTO `t_blog` VALUES (264, '从零开始入门 K8s | Kubernetes 网络概念及策略控制', '<p>作者 |&nbsp;阿里巴巴高级技术专家&nbsp; 叶磊</p> \n<h1 id=\"一kubernetes-基本网络模型\"><strong>一、Kubernetes 基本网络模型</strong></h1> \n<p>本文来介绍一下 Kubernetes 对网络模型的一些想法。大家知道 Kubernetes 对于网络具体实现方案，没有什么限制，也没有给出特别好的参考案例。Kubernetes 对一个容器网络是否合格做出了限制，也就是 Kubernetes 的容器网络模型。可以把它归结为约法三章和四大目标。</p> \n<ul> \n <li>约法三章的意思是：在评价一个容器网络或者设计容器网络的时候，它的准入条件。它需要满足哪三条？ 才能认为它是一个合格的网络方案。</li> \n <li>四大目标意思是在设计这个网络的拓扑，设计网络的具体功能的实现的时候，要去想清楚，能不能达成连通性等这几大指标。</li> \n</ul> \n<h2 id=\"约法三章\"><strong>约法三章</strong></h2> \n<p>先来看下约法三章：</p> \n<ul> \n <li>第一条：任意两个 pod 之间其实是可以直接通信的，无需经过显式地使用 NAT 来接收数据和地址的转换；</li> \n <li>第二条：node 与 pod 之间是可以直接通信的，无需使用明显的地址转换；</li> \n <li>第三条：pod 看到自己的 IP 跟别人看见它所用的IP是一样的，中间不能经过转换。</li> \n</ul> \n<p>后文中会讲一下我个人的理解，为什么 Kubernetes 对容器网络会有一些看起来武断的模型和要求。</p> \n<h2 id=\"四大目标\"><strong>四大目标</strong></h2> \n<p>四大目标其实是在设计一个 K8s 的系统为外部世界提供服务的时候，从网络的角度要想清楚，外部世界如何一步一步连接到容器内部的应用？</p> \n<ul> \n <li><strong>外部世界和 service 之间是怎么通信的？</strong>就是有一个互联网或者是公司外部的一个用户，怎么用到 service？service 特指 K8s 里面的服务概念。</li> \n <li><strong>service 如何与它后端的 pod 通讯？</strong></li> \n <li><strong>pod 和 pod 之间调用是怎么做到通信的？</strong></li> \n <li><strong>最后就是 pod 内部容器与容器之间的通信？</strong></li> \n</ul> \n<p>最终要达到目标，就是外部世界可以连接到最里面，对容器提供服务。</p> \n<h2 id=\"对基本约束的解释\">对基本约束的解释</h2> \n<p>对基本约束，可以做出这样一些解读：因为容器的网络发展复杂性就在于它其实是寄生在 Host 网络之上的。从这个角度讲，可以把容器网络方案大体分为&nbsp;<strong>Underlay/Overlay&nbsp;</strong>两大派别：</p> \n<ul> \n <li>Underlay 的标准是它与 Host 网络是同层的，从外在可见的一个特征就是它是不是使用了 Host 网络同样的网段、输入输出基础设备、容器的&nbsp;IP 地址是不是需要与 Host 网络取得协同（来自同一个中心分配或统一划分）。这就是 Underlay；</li> \n <li>Overlay 不一样的地方就在于它并不需要从 Host 网络的 IPM 的管理的组件去申请 IP，一般来说，它只需要跟 Host 网络不冲突，这个 IP 可以自由分配的。</li> \n</ul> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/532f000f-c4cb-4c34-a201-449bf081fe84.jpeg\" alt=\"file\"><br> 为什么社区会提出 perPodperIP 这种简单武断的模型呢？我个人是觉得这样为后面的 service 管理一些服务的跟踪性能监控，带来了非常多的好处。因为一个 IP 一贯到底，对 case 或者各种不大的事情都会有很大的好处。</p> \n<h1 id=\"二netns-探秘\"><strong>二、Netns 探秘</strong></h1> \n<h2 id=\"netns-究竟实现了什么\">Netns 究竟实现了什么</h2> \n<p>下面简单讲一下，Network Namespace 里面能网络实现的内核基础。狭义上来说 runC 容器技术是不依赖于任何硬件的，它的执行基础就是它的内核里面，进程的内核代表就是&nbsp;task，它如果不需要隔离，那么用的是主机的空间（ namespace），并不需要特别设置的空间隔离数据结构（ nsproxy-namespace proxy）。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/6534b02a-dc1e-4787-a1f3-004437c81845.jpeg\" alt=\"file\"></p> \n<p>相反，如果一个独立的网络 proxy，或者 mount proxy，里面就要填上真正的私有数据。它可以看到的数据结构如上图所示。</p> \n<p>从感官上来看一个隔离的网络空间，它会拥有自己的网卡或者说是网络设备。网卡可能是虚拟的，也可能是物理网卡，它会拥有自己的 IP 地址、IP 表和路由表、拥有自己的协议栈状态。这里面特指就是 TCP/Ip协议栈，它会有自己的status，会有自己的 iptables、ipvs。</p> \n<p>从整个感官上来讲，这就相当于拥有了一个完全独立的网络，它与主机网络是隔离的。当然协议栈的代码还是公用的，只是数据结构不相同。</p> \n<h2 id=\"pod-与-netns-的关系\">Pod 与 Netns 的关系</h2> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/5d1a96f1-8d48-44fd-ad82-754d54f1f886.jpeg\" alt=\"file\"></p> \n<p>这张图可以清晰表明 pod 里 Netns 的关系，每个 pod 都有着独立的网络空间，pod net container 会共享这个网络空间。一般 K8s 会推荐选用 Loopback 接口，在 pod net container 之间进行通信，而所有的 container 通过 pod 的 IP 对外提供服务。另外对于宿主机上的 Root Netns，可以把它看做一个特殊的网络空间，只不过它的&nbsp;Pid&nbsp;是1。</p> \n<h1 id=\"三主流网络方案简介\"><strong>三、主流网络方案简介</strong></h1> \n<h2 id=\"典型的容器网络实现方案\">典型的容器网络实现方案</h2> \n<p>接下来简单介绍一下典型的容器网络实现方案。容器网络方案可能是 K8s 里最为百花齐放的一个领域，它有着各种各样的实现。容器网络的复杂性，其实在于它需要跟底层 Iass 层的网络做协调、需要在性能跟 IP 分配的灵活性上做一些选择，这个方案是多种多样的。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/2054f406-72c2-4d5a-ba67-5677267c188c.jpeg\" alt=\"file\"></p> \n<p>下面简单介绍几个比较主要的方案：分别是 Flannel、Calico、Canal ，最后是 WeaveNet，中间的大多数方案都是采用了跟 Calico 类似的策略路由的方法。</p> \n<ul> \n <li><strong>Flannel&nbsp;</strong>是一个比较大一统的方案，它提供了多种的网络 backend。不同的 backend 实现了不同的拓扑，它可以覆盖多种场景；</li> \n <li><strong>Calico&nbsp;</strong>主要是采用了策略路由，节点之间采用 BGP 的协议，去进行路由的同步。它的特点是功能比较丰富，尤其是对 Network Point 支持比较好，大家都知道 Calico 对底层网络的要求，一般是需要 mac 地址能够直通，不能跨二层域；</li> \n <li>当然也有一些社区的同学会把 Flannel 的优点和 Calico 的优点做一些集成。我们称之为嫁接型的创新项目&nbsp;<strong>Cilium</strong>；</li> \n <li>最后讲一下&nbsp;<strong>WeaveNet</strong>，如果大家在使用中需要对数据做一些加密，可以选择用 WeaveNet，它的动态方案可以实现比较好的加密。</li> \n</ul> \n<h2 id=\"flannel-方案\">Flannel 方案</h2> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/0a90dfba-9717-438b-a9a9-13225750ec4a.jpeg\" alt=\"file\"></p> \n<p>Flannel 方案是目前使用最为普遍的。如上图所示，可以看到一个典型的容器网方案。它首先要解决的是 container 的包如何到达 Host，这里采用的是加一个 Bridge 的方式。它的 backend 其实是独立的，也就是说这个包如何离开 Host，是采用哪种封装方式，还是不需要封装，都是可选择的。</p> \n<p>现在来介绍三种主要的 backend：</p> \n<ul> \n <li>一种是用户态的 udp，这种是最早期的实现；</li> \n <li>然后是内核的 Vxlan，这两种都算是 overlay 的方案。Vxlan 的性能会比较好一点，但是它对内核的版本是有要求的，需要内核支持 Vxlan 的特性功能；</li> \n <li>如果你的集群规模不够大，又处于同一个二层域，也可以选择采用 host-gw 的方式。这种方式的 backend 基本上是由一段广播路由规则来启动的，性能比较高。</li> \n</ul> \n<h1 id=\"四network-policy-的用处\"><strong>四、Network Policy 的用处</strong></h1> \n<h2 id=\"network-policy-基本概念\">Network Policy 基本概念</h2> \n<p>下面介绍一下 Network Policy 的概念。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/8bd782d1-f657-4f2d-9e2e-d260be7cc12c.jpeg\" alt=\"file\"></p> \n<p>刚才提到了 Kubernetes 网络的基本模型是需要 pod 之间全互联，这个将带来一些问题：可能在一个 K8s 集群里，有一些调用链之间是不会直接调用的。比如说两个部门之间，那么我希望 A 部门不要去探视到 B 部门的服务，这个时候就可以用到策略的概念。</p> \n<p>基本上它的想法是这样的：它采用各种选择器（标签或 namespace），找到一组 pod，或者找到相当于通讯的两端，然后通过流的特征描述来决定它们之间是不是可以联通，可以理解为一个白名单的机制。</p> \n<p>在使用 Network Policy 之前，如上图所示要注意 apiserver 需要打开一下这几个开关。另一个更重要的是我们选用的网络插件需要支持 Network Policy 的落地。大家要知道，Network Policy 只是 K8s 提供的一种对象，并没有内置组件做落地实施，需要取决于你选择的容器网络方案对这个标准的支持与否及完备程度，如果你选择 Flannel 之类，它并没有真正去落地这个 Policy，那么你试了这个也没有什么用。</p> \n<h2 id=\"配置实例\">配置实例</h2> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/5e55075c-4985-4bb4-8deb-b53796a3151d.jpeg\" alt=\"file\"></p> \n<p>接下来讲一个配置的实例，或者说在设计一个 Network Policy 的时候要做哪些事情？我个人觉得需要决定三件事：</p> \n<ul> \n <li>第一件事是控制对象，就像这个实例里面 spec 的部分。spec 里面通过 podSelector 或者 namespace 的 selector，可以选择做特定的一组 pod 来接受我们的控制；</li> \n <li>第二个就是对流向考虑清楚，需要控制入方向还是出方向？还是两个方向都要控制？</li> \n <li>最重要的就是第三部分，如果要对选择出来的方向加上控制对象来对它流进行描述，具体哪一些 stream 可以放进来，或者放出去？类比这个流特征的五元组，可以通过一些选择器来决定哪一些可以作为我的远端，这是对象的选择；也可以通过 IPBlock 这种机制来得到对哪些 IP 是可以放行的；最后就是哪些协议或哪些端口。其实流特征综合起来就是一个五元组，会把特定的能够接受的流选择出来 。</li> \n</ul> \n<h1 id=\"本文总结\">本文总结</h1> \n<p>本文内容到这里就结束了，我们简单总结一下：</p> \n<ul> \n <li><p>在 pod 的容器网络中核心概念就是 IP，IP 就是每个 pod 对外通讯的地址基础，必须内外一致，符合 K8s 的模型特征；</p></li> \n <li><p>那么在介绍网络方案的时候，影响容器网络性能最关键的就是拓扑。要能够理解你的包端到端是怎么联通的，中间怎么从 container 到达 Host，Host 出了 container 是要封装还是解封装？还是通过策略路由？最终到达对端是怎么解出来的？</p></li> \n <li><p>容器网络选择和设计选择。如果你并不清楚你的外部网络，或者你需要一个普适性最强的方案，假设说你对 mac 是否直连不太清楚、对外部路由器的路由表能否控制也不太清楚，那么你可以选择 Flannel 利用 Vxlan 作为 backend 的这种方案。如果你确信你的网络是 2 层可直连的，你可以进行选用 Calico 或者 Flannel-Hostgw 作为一个 backend；</p></li> \n <li><p>最后就是对 Network Policy，在运维和使用的时候，它是一个很强大的工具，可以实现对进出流的精确控制。实现的方法我们也介绍了，要想清楚你要控制谁，然后你的流要怎么去定义。</p></li> \n</ul> \n<h1 id=\"五思考时间\"><strong>五、思考时间</strong></h1> \n<p>最后留一些思考，大家可以想一想：</p> \n<ol> \n <li><p>为什么接口标准化 CNI 化了，但是容器网络却没有一个很标准的实现，内置在 K8s 里面？</p></li> \n <li><p>Network Policy 为什么没有一个标准的 controller 或者一个标准的实现，而是交给这个容器网络的 owner 来提供？</p></li> \n <li><p>有没有可能完全不用网络设备来实现容器网络呢？考虑到现在有 RDMA 等有别于 TCP/IP 的这种方案。</p></li> \n <li><p>在运维过程中网络问题比较多、也比较难排查，那么值不值得做一个开源工具，让它可以友好的展示从 container 到 Host 之间、Host 到 Host 之间，或者说封装及解封装之间，各个阶段的网络情况，有没有出现问题，能够快速的定位。据我所知应该现在是没有这样的工具的。</p></li> \n</ol> \n<p>以上就是我对 K8s 容器网络的基本概念、以及 Network Policy 的一些介绍。</p> \n<blockquote> \n <p>“ 阿里巴巴云原生微信公众号（ID：Alicloudnative）关注微服务、Serverless、容器、Service Mesh等技术领域、聚焦云原生流行技术趋势、云原生大规模的落地实践，做最懂云原生开发者的技术公众号。”</p> \n</blockquote>', NULL, '2019-10-17 17:37:57', 0, NULL, NULL, 'https://www.cnblogs.com/alisystemsoftware/p/11692339.html', 0, NULL);
INSERT INTO `t_blog` VALUES (265, 'Spring Boot 2.X(八)：Spring AOP 实现简单的日志切面', '<h2 id=\"aop\">AOP</h2> \n<h3 id=\"什么是-aop\">1.什么是 AOP ？</h3> \n<p>AOP 的全称为 Aspect Oriented Programming，译为面向切面编程，是通过预编译方式和运行期动态代理实现核心业务逻辑之外的横切行为的统一维护的一种技术。AOP 是面向对象编程（OOP）的补充和扩展。<br> 利用 AOP 可以对业务逻辑各部分进行隔离，从而达到降低模块之间的耦合度，并将那些影响多个类的公共行为封装到一个可重用模块，从而到达提高程序的复用性，同时提高了开发效率，提高了系统的可操作性和可维护性。</p> \n<h3 id=\"为什么要用-aop\">2.为什么要用 AOP ？</h3> \n<p>在实际的 Web 项目开发中，我们常常需要对各个层面实现日志记录，性能统计，安全控制，事务处理，异常处理等等功能。如果我们对每个层面的每个类都独立编写这部分代码，那久而久之代码将变得很难维护，所以我们把这些功能从业务逻辑代码中分离出来，聚合在一起维护，而且我们能灵活地选择何处需要使用这些代码。</p> \n<h3 id=\"aop-的核心概念\">3.AOP 的核心概念</h3> \n<table> \n <thead> \n  <tr class=\"header\"> \n   <th>名词</th> \n   <th>概念</th> \n   <th>理解</th> \n  </tr> \n </thead> \n <tbody> \n  <tr class=\"odd\"> \n   <td>通知（Advice）</td> \n   <td>拦截到连接点之后所要执行的代码，通知分为前置、后置、异常、最终、环绕通知五类</td> \n   <td>我们要实现的功能，如日志记录，性能统计，安全控制，事务处理，异常处理等等，说明什么时候要干什么</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>连接点（Joint Point）</td> \n   <td>被拦截到的点，如被拦截的方法、对类成员的访问以及异常处理程序块的执行等等，自身还能嵌套其他的 Joint Point</td> \n   <td>Spring 允许你用通知的地方，方法有关的前前后后（包括抛出异常）</td> \n  </tr> \n  <tr class=\"odd\"> \n   <td>切入点（Pointcut）</td> \n   <td>对连接点进行拦截的定义</td> \n   <td>指定通知到哪个方法，说明在哪干</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>切面（Aspect）</td> \n   <td>切面类的定义，里面包含了切入点（Pointcut）和通知（Advice）的定义</td> \n   <td>切面就是通知和切入点的结合</td> \n  </tr> \n  <tr class=\"odd\"> \n   <td>目标对象（Target Object）</td> \n   <td>切入点选择的对象，也就是需要被通知的对象；由于 Spring AOP 通过代理模式实现，所以该对象永远是被代理对象</td> \n   <td>业务逻辑本身</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>织入（Weaving）</td> \n   <td>把切面应用到目标对象从而创建出 AOP 代理对象的过程。织入可以在编译期、类装载期、运行期进行，而 Spring 采用在运行期完成</td> \n   <td>切点定义了哪些连接点会得到通知</td> \n  </tr> \n  <tr class=\"odd\"> \n   <td>引入（Introduction ）</td> \n   <td>可以在运行期为类动态添加方法和字段，Spring 允许引入新的接口到所有目标对象</td> \n   <td>引入就是在一个接口/类的基础上引入新的接口增强功能</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>AOP 代理（AOP Proxy ）</td> \n   <td>Spring AOP 可以使用 JDK 动态代理或者 CGLIB 代理，前者基于接口，后者基于类</td> \n   <td>通过代理来对目标对象应用切面</td> \n  </tr> \n </tbody> \n</table> \n<h2 id=\"spring-aop\">Spring AOP</h2> \n<h3 id=\"简介\">1.简介</h3> \n<p>AOP 是 Spring 框架中的一个核心内容。在 Spring 中，AOP 代理可以用 JDK 动态代理或者 CGLIB 代理 CglibAopProxy 实现。Spring 中 AOP 代理由 Spring 的 IOC 容器负责生成和管理，其依赖关系也由 IOC 容器负责管理。</p> \n<h3 id=\"相关注解\">2.相关注解</h3> \n<table> \n <thead> \n  <tr class=\"header\"> \n   <th>注解</th> \n   <th>说明</th> \n  </tr> \n </thead> \n <tbody> \n  <tr class=\"odd\"> \n   <td>@Aspect</td> \n   <td>将一个 java 类定义为切面类</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>@Pointcut</td> \n   <td>定义一个切入点，可以是一个规则表达式，比如下例中某个 package 下的所有函数，也可以是一个注解等</td> \n  </tr> \n  <tr class=\"odd\"> \n   <td>@Before</td> \n   <td>在切入点开始处切入内容</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>@After</td> \n   <td>在切入点结尾处切入内容</td> \n  </tr> \n  <tr class=\"odd\"> \n   <td>@AfterReturning</td> \n   <td>在切入点 return 内容之后处理逻辑</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>@Around</td> \n   <td>在切入点前后切入内容，并自己控制何时执行切入点自身的内容</td> \n  </tr> \n  <tr class=\"odd\"> \n   <td>@AfterThrowing</td> \n   <td>用来处理当切入内容部分抛出异常之后的处理逻辑</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>@Order(100)</td> \n   <td>AOP 切面执行顺序， @Before 数值越小越先执行，@After 和 @AfterReturning 数值越大越先执行</td> \n  </tr> \n </tbody> \n</table> \n<p>其中 @Before、@After、@AfterReturning、@Around、@AfterThrowing 都属于通知（Advice）。</p> \n<h2 id=\"利用-aop-实现-web-日志处理\">利用 AOP 实现 Web 日志处理</h2> \n<h3 id=\"构建项目\">1.构建项目</h3> \n<h3 id=\"添加依赖\">2.添加依赖</h3> \n<pre class=\"xml\"><code>&lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;!-- 热部署模块 --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;\n            &lt;optional&gt;true&lt;/optional&gt; &lt;!-- 这个需要为 true 热部署才有效 --&gt;\n        &lt;/dependency&gt;\n        &lt;!-- Spring AOP --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;</code></pre> \n<h3 id=\"web-日志注解\">3.Web 日志注解</h3> \n<pre class=\"java\"><code>@Documented\n@Retention(RetentionPolicy.RUNTIME)\n@Target(ElementType.METHOD)\npublic @interface ControllerWebLog {\n     String name();//所调用接口的名称\n     boolean intoDb() default false;//标识该条操作日志是否需要持久化存储\n}\n</code></pre> \n<h3 id=\"实现切面逻辑\">4.实现切面逻辑</h3> \n<pre class=\"java\"><code>@Aspect\n@Component\n@Order(100)\npublic class WebLogAspect {\n\n    private static final Logger logger = LoggerFactory.getLogger(WebLogAspect.class);\n\n    private ThreadLocal&lt;Map&lt;String, Object&gt;&gt; threadLocal = new ThreadLocal&lt;Map&lt;String, Object&gt;&gt;();\n\n    /**\n     * 横切点\n     */\n    @Pointcut(\"execution(public * cn.zwqh.springboot.controller..*.*(..))\")\n    public void webLog() {\n    }\n    /**\n     * 接收请求，并记录数据\n     * @param joinPoint\n     * @param controllerWebLog\n     */\n    @Before(value = \"webLog()&amp;&amp; @annotation(controllerWebLog)\")\n    public void doBefore(JoinPoint joinPoint, ControllerWebLog controllerWebLog) {\n        // 接收到请求\n        RequestAttributes ra = RequestContextHolder.getRequestAttributes();\n        ServletRequestAttributes sra = (ServletRequestAttributes) ra;\n        HttpServletRequest request = sra.getRequest();\n        // 记录请求内容，threadInfo存储所有内容\n        Map&lt;String, Object&gt; threadInfo = new HashMap&lt;&gt;();\n        logger.info(\"URL : \" + request.getRequestURL());\n        threadInfo.put(\"url\", request.getRequestURL());\n        logger.info(\"URI : \" + request.getRequestURI());\n        threadInfo.put(\"uri\", request.getRequestURI());\n        logger.info(\"HTTP_METHOD : \" + request.getMethod());\n        threadInfo.put(\"httpMethod\", request.getMethod());\n        logger.info(\"REMOTE_ADDR : \" + request.getRemoteAddr());\n        threadInfo.put(\"ip\", request.getRemoteAddr());\n        logger.info(\"CLASS_METHOD : \" + joinPoint.getSignature().getDeclaringTypeName() + \".\"\n                + joinPoint.getSignature().getName());\n        threadInfo.put(\"classMethod\",\n                joinPoint.getSignature().getDeclaringTypeName() + \".\" + joinPoint.getSignature().getName());\n        logger.info(\"ARGS : \" + Arrays.toString(joinPoint.getArgs()));\n        threadInfo.put(\"args\", Arrays.toString(joinPoint.getArgs()));\n        logger.info(\"USER_AGENT\"+request.getHeader(\"User-Agent\"));\n        threadInfo.put(\"userAgent\", request.getHeader(\"User-Agent\"));\n        logger.info(\"执行方法：\" + controllerWebLog.name());\n        threadInfo.put(\"methodName\", controllerWebLog.name());\n        threadLocal.set(threadInfo);\n    }\n    /**\n     * 执行成功后处理\n     * @param controllerWebLog\n     * @param ret\n     * @throws Throwable\n     */\n    @AfterReturning(value = \"webLog()&amp;&amp; @annotation(controllerWebLog)\", returning = \"ret\")\n    public void doAfterReturning(ControllerWebLog controllerWebLog, Object ret) throws Throwable {\n        Map&lt;String, Object&gt; threadInfo = threadLocal.get();\n        threadInfo.put(\"result\", ret);\n        if (controllerWebLog.intoDb()) {\n            //插入数据库操作\n            //insertResult(threadInfo);\n        }\n        // 处理完请求，返回内容\n        logger.info(\"RESPONSE : \" + ret);\n    }\n    /**\n     * 获取执行时间\n     * @param proceedingJoinPoint\n     * @return\n     * @throws Throwable\n     */\n    @Around(value = \"webLog()\")\n    public Object doAround(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {\n        long startTime = System.currentTimeMillis();\n        Object ob = proceedingJoinPoint.proceed();\n        Map&lt;String, Object&gt; threadInfo = threadLocal.get();\n        Long takeTime = System.currentTimeMillis() - startTime;\n        threadInfo.put(\"takeTime\", takeTime);\n        logger.info(\"耗时：\" + takeTime);\n        threadLocal.set(threadInfo);\n        return ob;\n    }\n    /**\n     * 异常处理\n     * @param throwable\n     */\n    @AfterThrowing(value = \"webLog()\", throwing = \"throwable\")\n    public void doAfterThrowing(Throwable throwable) {\n        RequestAttributes ra = RequestContextHolder.getRequestAttributes();\n\n        ServletRequestAttributes sra = (ServletRequestAttributes) ra;\n\n        HttpServletRequest request = sra.getRequest();\n        // 异常信息\n        logger.error(\"{}接口调用异常，异常信息{}\", request.getRequestURI(), throwable);\n    }\n\n}\n</code></pre> \n<h3 id=\"测试接口\">5.测试接口</h3> \n<pre class=\"java\"><code>@RestController\n@RequestMapping(\"/user\")\npublic class UserController {\n\n    @GetMapping(\"/getOne\")\n    @ControllerWebLog(name = \"查询\", intoDb = true)\n    public String getOne(Long id, String name) {\n\n        return \"1234\";\n    }\n}</code></pre> \n<h3 id=\"运行测试\">6.运行测试</h3> \n<p>浏览器请求：http://127.0.0.1:8080/user/getOne?id=1&amp;name=zwqh ，可以看到后台日志输出：<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/84f52da8-4d2c-4172-8253-bd48ed25504a.jpeg\"></p> \n<h2 id=\"小结\">小结</h2> \n<p>日志记录只是一个简单的示例，而 Spring AOP 的应用让整个系统变的更加有条不紊，在其他场景应用也很强大。<br> 它帮助我们降低模块间耦合度，提高程序复用性，提高开发效率，提高系统可做性和可维护性。</p> \n<h2 id=\"示例代码\">示例代码</h2> \n<p><a href=\"https://github.com/zwqh1992/Spring-Boot-2.X/tree/master/spring-boot-aop-weblog\" title=\"github\">github</a></p> \n<p><a href=\"https://gitee.com/zwqh/Spring-Boot-2.X/tree/master/spring-boot-aop-weblog\" title=\"码云\">码云</a></p> \n<p>非特殊说明，本文版权归 <a href=\"https://www.zwqh.top\" title=\"朝雾轻寒\">朝雾轻寒</a> 所有，转载请注明出处.</p> \n<p>原文标题：Spring Boot 2.X(八)：Spring AOP 实现简单的日志切面</p> \n<p>原文地址：<a href=\"https://www.zwqh.top/article/info/14\" class=\"uri\">https://www.zwqh.top/article/info/14</a></p> \n<p>如果文章对您有帮助，请扫码关注下我的公众号，文章持续更新中...</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/2e2c4a81-383f-44c4-9b68-7ab5b20c8933.jpeg\"></p>', NULL, '2019-10-17 17:37:58', 0, NULL, NULL, 'https://www.cnblogs.com/zwqh/p/11692295.html', 0, NULL);
INSERT INTO `t_blog` VALUES (267, '6.InfluxDB-InfluxQL基础语法教程--GROUP BY子句', '<p>本文翻译自官网，官网地址：(<a href=\"https://docs.influxdata.com/influxdb/v1.7/query_language/data_exploration/\" class=\"uri\">https://docs.influxdata.com/influxdb/v1.7/query_language/data_exploration/</a>)</p> \n<p>GROUP BY子句通过用户自己制定的tags set或time区间，来将查询结果进行分组。</p> \n<h2 id=\"一group-by-tags\">一、GROUP BY tags</h2> \n<p>GROUP BY \n <tag>\n   通过用户指定的tag set，来对查询结果进行分组。\n  <br> 语法：\n </tag></p> \n<pre class=\"sql\"><code>SELECT_clause FROM_clause [WHERE_clause]\nGROUP BY [* | &lt;tag_key&gt;[,&lt;tag_key]]</code></pre> \n<table> \n <thead> \n  <tr class=\"header\"> \n   <th>GROUP BY子句</th> \n   <th>意义</th> \n  </tr> \n </thead> \n <tbody> \n  <tr class=\"odd\"> \n   <td>GROUP BY *</td> \n   <td>使用所有tag对查询结果进行分组</td> \n  </tr> \n  <tr class=\"even\"> \n   <td>GROUP BY &lt;tag_key&gt;</td> \n   <td>使用指定tag对查询结果进行分组</td> \n  </tr> \n  <tr class=\"odd\"> \n   <td>GROUP BY &lt;tag_key&gt;,&lt;tag_key&gt;</td> \n   <td>使用指定的多个tag对查询结果进行分组，其中tag之间的顺序是无关的。</td> \n  </tr> \n </tbody> \n</table> \n<p><strong>注</strong> ：如果在sql中同时存在WHERE子句和GROUP BY子句，则GROUP BY子句一定要在WHERE子句之后！</p> \n<p>Other supported features: <a href=\"https://docs.influxdata.com/influxdb/v1.7/query_language/data_exploration/#regular-expressions\">Regular Expressions</a></p> \n<hr> \n<h4 id=\"group-by-tags-示例sql\">GROUP BY tags 示例sql</h4> \n<ol> \n <li><p>Group query results by a single tag<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/234637f4-e4cf-4bb8-b8df-ca09fda8fb18.png\"><br> 上面的sql使用了MEAN函数，来对h2o_feet这个measurement中的location这个tag进行分组求平均值。<br> 注：在InfluxDB中，<font color=\"Red\" size=\"2\">0纪元1970-01-01T00:00:00Z</font>这个时间经常被用来表示timestamp的NULL值。如果你的查询中没有显示指定返回一个timestamp，比如上面在调用聚合函数时，就没有指定时间区间，因此InfluxDB最后返回0纪元来作为timestamp。</p></li> \n <li><p>Group query results by more than one tag<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/8e0b8964-23cb-4913-80d5-5f2f3639b9fc.png\"></p></li> \n <li><p>Group query results by all tags<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/5ea78d93-b272-452b-8e96-6ea4414d26bc.png\"></p></li> \n</ol> \n<hr> \n<h2 id=\"二基础group-by-time-intervals\">二、基础GROUP BY time intervals</h2> \n<p>GROUP BY time() 查询会将查询结果按照用户指定的时间区间来进行分组。<br> 语法：</p> \n<pre class=\"sql\"><code>SELECT &lt;function&gt;(&lt;field_key&gt;) FROM_clause\nWHERE &lt;time_range&gt;\nGROUP BY time(&lt;time_interval&gt;),[tag_key] [fill(&lt;fill_option&gt;)]</code></pre> \n<p>基本的 GROUP BY time() 查询用法需要在SELECT子句中调用相关函数，并且在WHERE子句中调用time时间区间。</p> \n<ul> \n <li>time(time_interval)<br> 在GROUP BY time()子句中的time_interval是个连续的时间区间，该时间区间决定了InfluxDB如何通过时间来对查询结果进行分组。比如，如果time_interval为5m，那么它会将查询结果分为5分钟一组（如果在WHERE子句中指定了time区间，那么就是将WHERE中指定的time区间划分为没5分钟一组）。</li> \n <li><p>fill(&lt;fill_option&gt;)<br> fill(&lt;fill_option&gt;) 是可选的。它可以填充那些没有数据的时间区间的值。 从 [GROUP BY time intervals and fill() ] (<a href=\"https://docs.influxdata.com/influxdb/v1.7/query_language/data_exploration/#group-by-time-intervals-and-fill\" class=\"uri\">https://docs.influxdata.com/influxdb/v1.7/query_language/data_exploration/#group-by-time-intervals-and-fill</a>) 部分可查看到关于这部分的更多信息。</p> <p>注：基本的GROUP BY time()查询通过当前InfluxDB数据库的预设时间边界来确定每个时间间隔中包含的原始数据和查询返回的时间戳。</p></li> \n</ul> \n<hr> \n<h4 id=\"基本用法示例sql\">基本用法示例sql</h4> \n<p>先看一个WHERE查询<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/aa3fee9d-77b4-4903-995c-e7ef50aacb49.png\"></p> \n<p>下面的GROUP BY time(time_interval)示例是在上面的sql基础上进行改进的，sql为：</p> \n<pre class=\"sql\"><code>SELECT COUNT(\"water_level\") FROM \"h2o_feet\"\nWHERE \"location\"=\'coyote_creek\'\n    AND time &gt;= \'2015-08-18T00:00:00Z\'\n    AND time &lt;= \'2015-08-18T00:30:00Z\'\nGROUP BY time(12m)</code></pre> \n<p>查询结果：<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/b11ff2bd-f957-4803-b40b-007739745d99.png\"><br> 该sql将h2o_feet表中tag=“coyote_creek”，且在\'2015-08-18T00:00:00Z\'和\'2015-08-18T00:30:00Z\'时间区间内的数据查询出来，并对其划分为每12分钟一组，对water_level值进行count计算。<br> <strong>注意</strong>：在查询结果中，时间区间是左闭右开的。拿第一行查询结果数据来说，2015-08-18T00:00:00Z表示的时间区间是[2015-08-18T00:00:00, 2015-08-18T00:12:00Z )</p> \n<hr> \n<h3 id=\"常见问题\">常见问题</h3> \n<p><strong>问题</strong>：查询结果中有预期之外的时间区间和值。<br> 在基本用法中，GROUP BY time()查询通过当前InfluxDB数据库的预设时间边界来确定每个时间间隔中包含的原始数据和查询返回的时间戳，这有可能会导致预期之外的结果值。<br> 比如，通过如下sql:</p> \n<pre class=\"sql\"><code>SELECT \"water_level\" FROM \"h2o_feet\"\nWHERE \"location\"=\'coyote_creek\'\n    AND time &gt;= \'2015-08-18T00:00:00Z\'\n    AND time &lt;= \'2015-08-18T00:18:00Z\'</code></pre> \n<p>我们查询到原始数据如下所示：<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/157b96aa-6296-4b2f-ab3e-0c5d280b240d.png\"></p> \n<p>在接下来的查询中，我们通过WHERE子句，指定查询12分钟内的数据，并通过GROUP BY子句，将查询结果按12分钟的时间区间进行分组。</p> \n<pre class=\"sql\"><code>SELECT COUNT(\"water_level\") FROM \"h2o_feet\"\nWHERE \"location\"=\'coyote_creek\'\n    AND time &gt;= \'2015-08-18T00:06:00Z\'\n    AND time &lt; \'2015-08-18T00:18:00Z\'\nGROUP BY time(12m)</code></pre> \n<p>按照预想，因为查询的是12分钟内的数据，并且group by时是按照12分钟来进行分组的，所以最后的查询结果应该只有一行而已。然后实际的查询结果却有两行：<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/0f8bc899-b440-4d3d-8ce9-99314675fad6.png\"></p> \n<p><strong>解释</strong> ：<br> influxdb使用预设的整数时间边界来作为GROUP BY的时间间隔，这些间隔独立于WHERE子句中的任何时间条件。在计算结果时，所有返回的数据都必须出现在WHERE查询的显式时间范围内，但当按间隔作为GROUP BY分组时是基于预设的时间边界。<br> （这里翻译的不好，下面是原版英文：<br> InfluxDB uses preset round-number time boundaries for GROUP BY intervals that are independent of any time conditions in the WHERE clause. When it calculates the results, all returned data must occur within the query’s explicit time range but the GROUP BY intervals will be based on the preset time boundaries.<br> ）</p> \n<p>高级的GROUP BY time()语法允许用户自定义预设时间边界的开始时间。在高级语法小节的示例sql3中，将展示这种用法，它查询的结果如下：<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/884701be-8ff9-4c38-ba2f-6e413ba0951d.png\"></p> \n<hr> \n<h2 id=\"三高级group-by-time-语法\">三、高级GROUP BY time() 语法</h2> \n<p>语法如下：</p> \n<pre class=\"sql\"><code>SELECT &lt;function&gt;(&lt;field_key&gt;)\nFROM_clause\nWHERE &lt;time_range&gt;\nGROUP BY time(&lt;time_interval&gt;,&lt;offset_interval&gt;),[tag_key] [fill(&lt;fill_option&gt;)]</code></pre> \n<p>在GROUP BY time()高级语法中，需要在SELECT子句中调用InfluxDB的函数，并在WHERE子句中指定时间区间。并且需要注意到的是，GROUP BY子句必须在WHERE子句之后！</p> \n<ul> \n <li><p>time(time_interval,offset_interval)<br> 在GROUP BY time()子句中的通过time_interval和offset_interval来表示一个连续的时间区间，该时间区间决定了InfluxDB如何通过时间来对查询结果进行分组。比如，如果时间区间为5m，那么它会将查询结果分为5分钟一组（如果在WHERE子句中指定了time区间，那么就是将WHERE中指定的time区间划分为没5分钟一组）。<br> offset_interval是持续时间文本。它向前或向后移动InfluxDB数据库的预设时间边界。offset_interval可以为正或负。</p></li> \n <li><p>fill(&lt;fill_option&gt;)<br> fill(&lt;fill_option&gt;)是可选的。 它可以填充那些没有数据的时间区间的值。 从 GROUP BY time intervals and fill() 部分可查看到关于这部分的更多信息。</p> <p><strong>注</strong>：高级 GROUP BY time() 语法依赖于time_interval、offset_interval、以及 InfluxDB 数据库的预设时间边界来确定每组内的数据条数、以及查询结果的时间戳。</p></li> \n</ul> \n<hr> \n<h3 id=\"高级用法示例sql\">高级用法示例sql</h3> \n<p>先看如下查询sql</p> \n<pre class=\"sql\"><code>SELECT \"water_level\" FROM \"h2o_feet\"\nWHERE \"location\"=\'coyote_creek\'\n    AND time &gt;= \'2015-08-18T00:00:00Z\'\n    AND time &lt;= \'2015-08-18T00:54:00Z\'</code></pre> \n<p>查询结果：<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/6bd8b4d7-b822-4b65-8383-5299fd9e7d8d.png\"><br> 接下来将使用上面的样例数据的子集来进行演示。以下sql将按照每18m对数据进行进组，并将预设的时间界限前移。</p> \n<pre class=\"sql\"><code>ELECT MEAN(\"water_level\") FROM \"h2o_feet\"\nWHERE \"location\"=\'coyote_creek\'\n    AND time &gt;= \'2015-08-18T00:06:00Z\'\n    AND time &lt;= \'2015-08-18T00:54:00Z\'\nGROUP BY time(18m,6m)</code></pre> \n<p>查询结果：<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/80ce3ab2-fe12-403d-8198-8d8e808c64c1.png\"><br> 可见上面sql将查询结果按照每18m为一组进行了分组，并且将预设的时间界限偏移了6分钟。<br> 注意，对于没有offset_interval的group by time()，它的查询结果的时间边界和返回的时间戳遵循influxdb数据库的预设时间边界。下面我们看offset_interval的group by time()的查询结果：</p> \n<pre class=\"sql\"><code>SELECT MEAN(\"water_level\") FROM \"h2o_feet\"\nWHERE \"location\"=\'coyote_creek\'\n    AND time &gt;= \'2015-08-18T00:06:00Z\'\n    AND time &lt;= \'2015-08-18T00:54:00Z\'\nGROUP BY time(18m)</code></pre> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/82dc64ab-bc52-4061-b124-9a3f6fcc24a6.png\"><br> 再看如下sql：</p> \n<pre class=\"sql\"><code>SELECT MEAN(\"water_level\") FROM \"h2o_feet\"\nWHERE \"location\"=\'coyote_creek\'\n    AND time &gt;= \'2015-08-18T00:06:00Z\'\n    AND time &lt;= \'2015-08-18T00:54:00Z\'\nGROUP BY time(18m,-12m);</code></pre> \n<p>查询结果<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/ca6b831b-722c-4353-b274-bd3c8dc178ad.png\"><br> <strong>注</strong> ：该sql使用的是time(18m,-12m)，offset_interval是负数，它的查询结果跟使用time(18m,6m)是一样的。<font color=\"Red\" size=\"2\">因此在决定正负偏移间隔时，请随意选择最直观的选项。</font></p> \n<hr> \n<h5 id=\"group-by-time-intervals-and-fill\">GROUP BY time intervals and fill()</h5> \n<p>Fill() 可以填充那些没有数据的时间区间的值。<br> 语法：</p> \n<pre class=\"sql\"><code>SELECT &lt;function&gt;(&lt;field_key&gt;) FROM_clause\nWHERE &lt;time_range&gt;\nGROUP BY time(time_interval,[&lt;offset_interval])[,tag_key] [fill(&lt;fill_option&gt;)]</code></pre> \n<p>默认情况下，在GROUP BY time()查询结果中，若某个时间区间没有数据，则该时间区间对应的值为null。通过fill()，就可以填充那些没有数据的时间区间的值。<br> 需要注意的是，fill()必须出现在GROUP BY子句的最后。</p> \n<blockquote> \n <p>Fill选项</p> \n</blockquote> \n<ol> \n <li>任何数学数值<br> 使用给定的数学数值进行填充</li> \n <li>linear<br> 为没有数据值的时间区间线性插入数值，使得插入之后的数值，跟其他本来就有数据的区间的值成线性。（这里翻译的不是很好，看示例就能明白了）</li> \n <li>none<br> 若某个时间区间内没有数据，则在查询结果中该区间对应的时间戳将不显示出来</li> \n <li>null<br> 没有值的区间，显示为null。这也是默认的选项。</li> \n <li>previous<br> 用前一个区间的数值来填充当前没有数据的区间的值。</li> \n</ol> \n<h3 id=\"示例\">示例：</h3> \n<ol> \n <li><p>fill(100)<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/2012abbf-ecd4-45ce-8883-f730f6292c54.png\"></p></li> \n <li><p>fill(linear)<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/6ebdf55c-6ad7-4a76-b1ed-4d074c15a168.png\"></p></li> \n <li><p>fill(none)<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/5daaf8c6-b27c-46e2-8204-2ed5b39bb7a9.png\"></p></li> \n <li><p>fill(null)<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/7a1deef5-8425-41bb-ac04-16b053e87257.png\"></p></li> \n <li><p>fill(previous)<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/288930b1-2c19-4d31-a2b5-0f7e4ab92448.png\"></p></li> \n</ol> \n<hr>', NULL, '2019-10-17 17:38:03', 0, NULL, NULL, 'https://www.cnblogs.com/suhaha/p/11692281.html', 0, NULL);
INSERT INTO `t_blog` VALUES (268, '带你涨姿势的认识一下 Kafka', '<h1 id=\"kafka-基本概述\">Kafka 基本概述</h1> \n<h2 id=\"什么是-kafka\">什么是 Kafka</h2> \n<p><code>Kafka</code> 是一个分布式流式平台，它有三个关键能力</p> \n<ol> \n <li>订阅发布记录流，它类似于企业中的<code>消息队列</code> 或 <code>企业消息传递系统</code></li> \n <li>以容错的方式存储记录流</li> \n <li>实时记录流</li> \n</ol> \n<h3 id=\"kafka-的应用\">Kafka 的应用</h3> \n<ol> \n <li>作为消息系统</li> \n <li>作为存储系统</li> \n <li>作为流处理器</li> \n</ol> \n<p>Kafka 可以建立流数据管道，可靠性的在系统或应用之间获取数据。</p> \n<p>建立流式应用传输和响应数据。</p> \n<h3 id=\"kafka-作为消息系统\">Kafka 作为消息系统</h3> \n<p>Kafka 作为消息系统，它有三个基本组件</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/c02e8114-0157-4bf5-8237-25112c8aa10e.jpeg\" alt=\"file\"></p> \n<ul> \n <li>Producer : 发布消息的客户端</li> \n <li>Broker：一个从生产者接受并存储消息的客户端</li> \n <li>Consumer : 消费者从 Broker 中读取消息</li> \n</ul> \n<p>在大型系统中，会需要和很多子系统做交互，也需要消息传递，在诸如此类系统中，你会找到源系统（消息发送方）和 目的系统（消息接收方）。为了在这样的消息系统中传输数据，你需要有合适的数据管道</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/06ad4ccd-c2fe-4f3b-8b11-77874bed6111.jpeg\" alt=\"file\"></p> \n<p>这种数据的交互看起来就很混乱，如果我们使用消息传递系统，那么系统就会变得更加简单和整洁</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/c5b76d50-c2b3-4de0-86f1-8abd6d6b9577.jpeg\" alt=\"file\"></p> \n<ul> \n <li>Kafka 运行在一个或多个数据中心的服务器上作为集群运行</li> \n <li>Kafka 集群存储消息记录的目录被称为 <code>topics</code></li> \n <li>每一条消息记录包含三个要素：<strong>键（key）、值（value）、时间戳（Timestamp）</strong></li> \n</ul> \n<h3 id=\"核心-api\">核心 API</h3> \n<p>Kafka 有四个核心API，它们分别是</p> \n<ul> \n <li>Producer API，它允许应用程序向一个或多个 topics 上发送消息记录</li> \n <li>Consumer API，允许应用程序订阅一个或多个 topics 并处理为其生成的记录流</li> \n <li>Streams API，它允许应用程序作为流处理器，从一个或多个主题中消费输入流并为其生成输出流，有效的将输入流转换为输出流。</li> \n <li>Connector API，它允许构建和运行将 Kafka 主题连接到现有应用程序或数据系统的可用生产者和消费者。例如，关系数据库的连接器可能会捕获对表的所有更改</li> \n</ul> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/ccd11859-0cad-4de5-93a0-dfe2cc7ddbe3.jpeg\" alt=\"file\"></p> \n<h2 id=\"kafka-基本概念\">Kafka 基本概念</h2> \n<p>Kafka 作为一个高度可扩展可容错的消息系统，它有很多基本概念，下面就来认识一下这些 Kafka 专属的概念</p> \n<h3 id=\"topic\">topic</h3> \n<p>Topic 被称为主题，在 kafka 中，使用一个类别属性来划分消息的所属类，划分消息的这个类称为 topic。topic 相当于消息的分配标签，是一个逻辑概念。主题好比是数据库的表，或者文件系统中的文件夹。</p> \n<h3 id=\"partition\">partition</h3> \n<p>partition 译为分区，topic 中的消息被分割为一个或多个的 partition，它是一个物理概念，对应到系统上的就是一个或若干个目录，一个分区就是一个 <code>提交日志</code>。消息以追加的形式写入分区，先后以顺序的方式读取。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/673ec2d8-b32b-48ab-bddb-53dd8c1f1895.jpeg\" alt=\"file\"></p> \n<blockquote> \n <p>注意：由于一个主题包含无数个分区，因此无法保证在整个 topic 中有序，但是单个 Partition 分区可以保证有序。消息被迫加写入每个分区的尾部。Kafka 通过分区来实现数据冗余和伸缩性</p> \n</blockquote> \n<p>分区可以分布在不同的服务器上，也就是说，一个主题可以跨越多个服务器，以此来提供比单个服务器更强大的性能。</p> \n<h3 id=\"segment\">segment</h3> \n<p>Segment 被译为段，将 Partition 进一步细分为若干个 segment，每个 segment 文件的大小相等。</p> \n<h3 id=\"broker\">broker</h3> \n<p>Kafka 集群包含一个或多个服务器，每个 Kafka 中服务器被称为 broker。broker 接收来自生产者的消息，为消息设置偏移量，并提交消息到磁盘保存。broker 为消费者提供服务，对读取分区的请求作出响应，返回已经提交到磁盘上的消息。</p> \n<p>broker 是集群的组成部分，每个集群中都会有一个 broker 同时充当了 <code>集群控制器(Leader)</code>的角色，它是由集群中的活跃成员选举出来的。每个集群中的成员都有可能充当 Leader，Leader 负责管理工作，包括将分区分配给 broker 和监控 broker。集群中，一个分区从属于一个 Leader，但是一个分区可以分配给多个 broker（非Leader），这时候会发生分区复制。这种复制的机制为分区提供了消息冗余，如果一个 broker 失效，那么其他活跃用户会重新选举一个 Leader 接管。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/12f0db4d-f8e3-4a90-af57-e0c9ba0f7234.jpeg\" alt=\"file\"></p> \n<h3 id=\"producer\">producer</h3> \n<p>生产者，即消息的发布者，其会将某 topic 的消息发布到相应的 partition 中。生产者在默认情况下把消息均衡地分布到主题的所有分区上，而并不关心特定消息会被写到哪个分区。不过，在某些情况下，生产者会把消息直接写到指定的分区。</p> \n<h3 id=\"consumer\">consumer</h3> \n<p>消费者，即消息的使用者，一个消费者可以消费多个 topic 的消息，对于某一个 topic 的消息，其只会消费同一个 partition 中的消息</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/e7bb2df2-a5d2-4033-b5ac-7c0777ae6e2c.jpeg\" alt=\"file\"></p> \n<p>在了解完 Kafka 的基本概念之后，我们通过搭建 Kafka 集群来进一步深刻认识一下 Kafka。</p> \n<h2 id=\"确保安装环境\">确保安装环境</h2> \n<h3 id=\"安装-java-环境\">安装 Java 环境</h3> \n<p>在安装 Kafka 之前，先确保Linux 环境上是否有 Java 环境，使用 <code>java -version</code> 命令查看 Java 版本，推荐使用Jdk 1.8 ，如果没有安装 Java 环境的话，可以按照这篇文章进行安装（<a href=\"https://www.cnblogs.com/zs-notes/p/8535275.html\" class=\"uri\">https://www.cnblogs.com/zs-notes/p/8535275.html</a>）</p> \n<h3 id=\"安装-zookeeper-环境\">安装 Zookeeper 环境</h3> \n<p>Kafka 的底层使用 Zookeeper 储存元数据，确保一致性，所以安装 Kafka 前需要先安装 Zookeeper，Kafka 的发行版自带了 Zookeeper ，可以直接使用脚本来启动，不过安装一个 Zookeeper 也不费劲</p> \n<h4 id=\"zookeeper-单机搭建\">Zookeeper 单机搭建</h4> \n<p>Zookeeper 单机搭建比较简单，直接从 <a href=\"https://www.apache.org/dyn/closer.cgi/zookeeper/\" class=\"uri\">https://www.apache.org/dyn/closer.cgi/zookeeper/</a> 官网下载一个稳定版本的 Zookeeper ，这里我使用的是 <code>3.4.10</code>，下载完成后，在 Linux 系统中的 <code>/usr/local</code> 目录下创建 zookeeper 文件夹，使用<code>xftp</code> 工具(xftp 和 xshell 工具都可以在官网 <a href=\"https://www.netsarang.com/zh/xshell/\" class=\"uri\">https://www.netsarang.com/zh/xshell/</a> 申请免费的家庭版)把下载好的 zookeeper 压缩包放到 /usr/local/zookeeper 目录下。</p> \n<p>如果下载的是一个 tar.gz 包的话，直接使用 <code>tar -zxvf zookeeper-3.4.10.tar.gz</code>解压即可</p> \n<p>如果下载的是 zip 包的话，还要检查一下 Linux 中是否有 unzip 工具，如果没有的话，使用 <code>yum install unzip</code> 安装 zip 解压工具，完成后使用 <code>unzip zookeeper-3.4.10.zip</code> 解压即可。</p> \n<p>解压完成后，cd 到 <code>/usr/local/zookeeper/zookeeper-3.4.10</code> ，创建一个 data 文件夹，然后进入到 conf 文件夹下，使用 <code>mv zoo_sample.cfg zoo.cfg</code> 进行重命名操作</p> \n<p>然后使用 vi 打开 zoo.cfg ，更改一下<code>dataDir = /usr/local/zookeeper/zookeeper-3.4.10/data</code> ，保存。</p> \n<p>进入bin目录，启动服务输入命令<code>./zkServer.sh start</code> 输出下面内容表示搭建成功<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/31a74fef-8988-4db7-b84f-e8964061a050.jpeg\" alt=\"file\"></p> \n<p>关闭服务输入命令，<code>./zkServer.sh stop</code></p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/abcac0f0-ec37-455b-b88a-f0d790693bd7.jpeg\" alt=\"file\"></p> \n<p>使用 <code>./zkServer.sh status</code> 可以查看状态信息。</p> \n<h4 id=\"zookeeper-集群搭建\">Zookeeper 集群搭建</h4> \n<h4 id=\"准备条件\">准备条件</h4> \n<p>准备条件：需要三个服务器，这里我使用了CentOS7 并安装了三个虚拟机，并为各自的虚拟机分配了<code>1GB</code>的内存，在每个 <code>/usr/local/</code> 下面新建 zookeeper 文件夹，把 zookeeper 的压缩包挪过来，解压，完成后会有 zookeeper-3.4.10 文件夹，进入到文件夹，新建两个文件夹，分别是 <code>data</code> 和<code>log</code>文件夹</p> \n<blockquote> \n <p>注：上一节单机搭建中已经创建了一个data 文件夹，就不需要重新创建了，直接新建一个 log 文件夹，对另外两个新增的服务需要新建这两个文件夹。</p> \n</blockquote> \n<h4 id=\"设置集群\">设置集群</h4> \n<p>新建完成后，需要编辑 conf/zoo.cfg 文件，三个文件的内容如下</p> \n<pre class=\"properties\"><code>tickTime=2000\ninitLimit=10\nsyncLimit=5\ndataDir=/usr/local/zookeeper/zookeeper-3.4.10/data\ndataLogDir=/usr/local/zookeeper/zookeeper-3.4.10/log\nclientPort=12181\nserver.1=192.168.1.7:12888:13888\nserver.2=192.168.1.8:12888:13888\nserver.3=192.168.1.9:12888:13888</code></pre> \n<p>server.1 中的这个 1 表示的是服务器的标识也可以是其他数字，表示这是第几号服务器，这个标识要和下面我们配置的 <code>myid</code> 的标识一致可以。</p> \n<p><code>192.168.1.7:12888:13888</code> 为集群中的 ip 地址，第一个端口表示的是 master 与 slave 之间的通信接口，默认是 2888，第二个端口是leader选举的端口，集群刚启动的时候选举或者leader挂掉之后进行新的选举的端口，默认是 3888</p> \n<p><strong>现在对上面的配置文件进行解释</strong></p> \n<p><code>tickTime</code>: 这个时间是作为 Zookeeper 服务器之间或客户端与服务器之间<code>维持心跳</code>的时间间隔，也就是每个 tickTime 时间就会发送一个心跳。</p> \n<p><code>initLimit</code>：这个配置项是用来配置 Zookeeper 接受客户端（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 5个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 5*2000=10 秒</p> \n<p><code>syncLimit</code>: 这个配置项标识 Leader 与Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是5*2000=10秒</p> \n<p><code>dataDir</code>: 快照日志的存储路径</p> \n<p><code>dataLogDir</code>: 事务日志的存储路径，如果不配置这个那么事务日志会默认存储到dataDir指定的目录，这样会严重影响zk的性能，当zk吞吐量较大的时候，产生的事务日志、快照日志太多</p> \n<p><code>clientPort</code>: 这个端口就是客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求。</p> \n<h4 id=\"创建-myid-文件\">创建 myid 文件</h4> \n<p>在了解完其配置文件后，现在来创建每个集群节点的 myid ，我们上面说过，这个 myid 就是 <code>server.1</code> 的这个 1 ，类似的，需要为集群中的每个服务都指定标识，使用 <code>echo</code> 命令进行创建</p> \n<pre class=\"properties\"><code># server.1\necho \"1\" &gt; /usr/local/zookeeper/zookeeper-3.4.10/data/myid\n# server.2\necho \"2\" &gt; /usr/local/zookeeper/zookeeper-3.4.10/data/myid\n# server.3\necho \"3\" &gt; /usr/local/zookeeper/zookeeper-3.4.10/data/myid</code></pre> \n<h4 id=\"启动服务并测试\">启动服务并测试</h4> \n<p>配置完成，为每个 zk 服务启动并测试，我在 windows 电脑的测试结果如下</p> \n<p><strong>启动服务（每台都需要执行）</strong></p> \n<pre class=\"properties\"><code>cd /usr/local/zookeeper/zookeeper-3.4.10/bin\n./zkServer.sh start</code></pre> \n<p><strong>检查服务状态</strong></p> \n<p>使用 <code>./zkServer.sh status</code> 命令检查服务状态</p> \n<p>192.168.1.7 --- follower</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/3b090668-6ad6-47cd-b665-dde8268f106f.jpeg\" alt=\"file\"></p> \n<p>192.168.1.8 --- leader</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/6f1bf273-6721-449e-a79b-c7dae85d8257.jpeg\" alt=\"file\"></p> \n<p>192.168.1.9 --- follower</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/96df9a6d-726f-4cbd-9060-9b23ad5a3743.jpeg\" alt=\"file\"></p> \n<p>zk集群一般只有一个leader，多个follower，主一般是相应客户端的读写请求，而从主同步数据，当主挂掉之后就会从follower里投票选举一个leader出来。</p> \n<h2 id=\"kafka-集群搭建\">Kafka 集群搭建</h2> \n<h3 id=\"准备条件-1\">准备条件</h3> \n<ul> \n <li>搭建好的 Zookeeper 集群</li> \n <li>Kafka 压缩包 （<a href=\"https://www.apache.org/dyn/closer.cgi?path=/kafka/2.3.0/kafka_2.12-2.3.0.tgz\" class=\"uri\">https://www.apache.org/dyn/closer.cgi?path=/kafka/2.3.0/kafka_2.12-2.3.0.tgz</a>）</li> \n</ul> \n<p>在 <code>/usr/local</code> 下新建 <code>kafka</code> 文件夹，然后把下载完成的 tar.gz 包移到 /usr/local/kafka 目录下，使用 <code>tar -zxvf 压缩包</code> 进行解压，解压完成后，进入到 kafka_2.12-2.3.0 目录下，新建 log 文件夹，进入到 config 目录下</p> \n<p>我们可以看到有很多 properties 配置文件，这里主要关注 <code>server.properties</code> 这个文件即可。</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/62f7a4d6-ef73-400c-aec7-4c3dc90a1500.jpeg\" alt=\"file\"></p> \n<p>kafka 启动方式有两种，一种是使用 kafka 自带的 zookeeper 配置文件来启动（可以按照官网来进行启动，并使用单个服务多个节点来模拟集群http://kafka.apache.org/quickstart#quickstart_multibroker），一种是通过使用独立的zk集群来启动，这里推荐使用第二种方式，使用 zk 集群来启动</p> \n<h3 id=\"修改配置项\">修改配置项</h3> \n<p>需要为<code>每个服务</code>都修改一下配置项，也就是<code>server.properties</code>， 需要更新和添加的内容有</p> \n<pre class=\"properties\"><code>broker.id=0 //初始是0，每个 server 的broker.id 都应该设置为不一样的，就和 myid 一样 我的三个服务分别设置的是 1,2,3\nlog.dirs=/usr/local/kafka/kafka_2.12-2.3.0/log\n\n#在log.retention.hours=168 下面新增下面三项\nmessage.max.byte=5242880\ndefault.replication.factor=2\nreplica.fetch.max.bytes=5242880\n\n#设置zookeeper的连接端口\nzookeeper.connect=192.168.1.7:2181,192.168.1.8:2181,192.168.1.9:2181</code></pre> \n<p>配置项的含义</p> \n<pre class=\"properties\"><code>broker.id=0  #当前机器在集群中的唯一标识，和zookeeper的myid性质一样\nport=9092 #当前kafka对外提供服务的端口默认是9092\nhost.name=192.168.1.7 #这个参数默认是关闭的，在0.8.1有个bug，DNS解析问题，失败率的问题。\nnum.network.threads=3 #这个是borker进行网络处理的线程数\nnum.io.threads=8 #这个是borker进行I/O处理的线程数\nlog.dirs=/usr/local/kafka/kafka_2.12-2.3.0/log #消息存放的目录，这个目录可以配置为“，”逗号分割的表达式，上面的num.io.threads要大于这个目录的个数这个目录，如果配置多个目录，新创建的topic他把消息持久化的地方是，当前以逗号分割的目录中，那个分区数最少就放那一个\nsocket.send.buffer.bytes=102400 #发送缓冲区buffer大小，数据不是一下子就发送的，先回存储到缓冲区了到达一定的大小后在发送，能提高性能\nsocket.receive.buffer.bytes=102400 #kafka接收缓冲区大小，当数据到达一定大小后在序列化到磁盘\nsocket.request.max.bytes=104857600 #这个参数是向kafka请求消息或者向kafka发送消息的请请求的最大数，这个值不能超过java的堆栈大小\nnum.partitions=1 #默认的分区数，一个topic默认1个分区数\nlog.retention.hours=168 #默认消息的最大持久化时间，168小时，7天\nmessage.max.byte=5242880  #消息保存的最大值5M\ndefault.replication.factor=2  #kafka保存消息的副本数，如果一个副本失效了，另一个还可以继续提供服务\nreplica.fetch.max.bytes=5242880  #取消息的最大直接数\nlog.segment.bytes=1073741824 #这个参数是：因为kafka的消息是以追加的形式落地到文件，当超过这个值的时候，kafka会新起一个文件\nlog.retention.check.interval.ms=300000 #每隔300000毫秒去检查上面配置的log失效时间（log.retention.hours=168 ），到目录查看是否有过期的消息如果有，删除\nlog.cleaner.enable=false #是否启用log压缩，一般不用启用，启用的话可以提高性能\nzookeeper.connect=192.168.1.7:2181,192.168.1.8:2181,192.168.1.9:2181 #设置zookeeper的连接端口</code></pre> \n<h3 id=\"启动-kafka-集群并测试\">启动 Kafka 集群并测试</h3> \n<ul> \n <li>启动服务，进入到 <code>/usr/local/kafka/kafka_2.12-2.3.0/bin</code> 目录下</li> \n</ul> \n<pre class=\"properties\"><code># 启动后台进程\n./kafka-server-start.sh -daemon ../config/server.properties</code></pre> \n<ul> \n <li>检查服务是否启动</li> \n</ul> \n<pre class=\"properties\"><code># 执行命令 jps\n6201 QuorumPeerMain\n7035 Jps\n6972 Kafka</code></pre> \n<ul> \n <li>kafka 已经启动</li> \n <li>创建 Topic 来验证是否创建成功</li> \n</ul> \n<pre class=\"properties\"><code># cd .. 往回退一层 到 /usr/local/kafka/kafka_2.12-2.3.0 目录下\nbin/kafka-topics.sh --create --zookeeper 192.168.1.7:2181 --replication-factor 2 --partitions 1 --topic cxuan</code></pre> \n<p>对上面的解释</p> \n<blockquote> \n <p>--replication-factor 2 复制两份</p> \n <p>--partitions 1 创建1个分区</p> \n <p>--topic 创建主题</p> \n</blockquote> \n<p>查看我们的主题是否出创建成功</p> \n<pre class=\"properties\"><code>bin/kafka-topics.sh --list --zookeeper 192.168.1.7:2181</code></pre> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/4c3f923e-7dfa-4dda-9456-002c15259e77.jpeg\" alt=\"file\"></p> \n<blockquote> \n <p>启动一个服务就能把集群启动起来</p> \n</blockquote> \n<p><strong>在一台机器上创建一个发布者</strong></p> \n<pre class=\"properties\"><code># 创建一个broker，发布者\n./kafka-console-producer.sh --broker-list 192.168.1.7:9092 --topic cxuantopic</code></pre> \n<p><strong>在一台服务器上创建一个订阅者</strong></p> \n<pre class=\"properties\"><code># 创建一个consumer， 消费者\nbin/kafka-console-consumer.sh --bootstrap-server 192.168.1.7:9092 --topic cxuantopic --from-beginning</code></pre> \n<blockquote> \n <p>注意：这里使用 --zookeeper 的话可能出现 <code>zookeeper is not a recognized option</code> 的错误，这是因为 kafka 版本太高，需要使用 <code>--bootstrap-server</code> 指令</p> \n</blockquote> \n<p><strong>测试结果</strong></p> \n<p>发布</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/58ca5c5c-0080-49a6-a1b1-4514470726fe.jpeg\" alt=\"file\"></p> \n<p>消费</p> \n<p><img src=\"http://localhost:9090/blogImages/2019/10/17/2edbaea3-e91b-438e-90c8-525c68780e5e.jpeg\" alt=\"file\"></p> \n<h3 id=\"其他命令\">其他命令</h3> \n<p>显示 topic</p> \n<pre class=\"properties\"><code>bin/kafka-topics.sh --list --zookeeper 192.168.1.7:2181\n\n# 显示\ncxuantopic</code></pre> \n<p>查看 topic 状态</p> \n<pre class=\"properties\"><code>bin/kafka-topics.sh --describe --zookeeper 192.168.1.7:2181 --topic cxuantopic\n\n# 下面是显示的详细信息\nTopic:cxuantopic PartitionCount:1 ReplicationFactor:2 Configs:\nTopic: cxuantopic Partition: 0 Leader: 1 Replicas: 1,2 Isr: 1,2\n\n# 分区为为1  复制因子为2   主题 cxuantopic 的分区为0 \n# Replicas: 0,1   复制的为1，2</code></pre> \n<p><code>Leader</code> 负责给定分区的所有读取和写入的节点，每个节点都会通过随机选择成为 leader。</p> \n<p><code>Replicas</code> 是为该分区复制日志的节点列表，无论它们是 Leader 还是当前处于活动状态。</p> \n<p><code>Isr</code> 是同步副本的集合。它是副本列表的子集，当前仍处于活动状态并追随Leader。</p> \n<p>至此，kafka 集群搭建完毕。</p> \n<h3 id=\"验证多节点接收数据\">验证多节点接收数据</h3> \n<p>刚刚我们都使用的是 相同的ip 服务，下面使用其他集群中的节点，验证是否能够接受到服务</p> \n<p>在另外两个节点上使用</p> \n<pre class=\"properties\"><code>bin/kafka-console-consumer.sh --bootstrap-server 192.168.1.7:9092 --topic cxuantopic --from-beginning</code></pre> \n<p>然后再使用 broker 进行消息发送，经测试三个节点都可以接受到消息。</p> \n<h2 id=\"配置详解\">配置详解</h2> \n<p>在搭建 Kafka 的时候我们简单介绍了一下 <code>server.properties</code> 中配置的含义，现在我们来详细介绍一下参数的配置和概念</p> \n<h3 id=\"常规配置\">常规配置</h3> \n<p>这些参数是 kafka 中最基本的配置</p> \n<ul> \n <li>broker.id</li> \n</ul> \n<p>每个 broker 都需要有一个标识符，使用 broker.id 来表示。它的默认值是 0，它可以被设置成其他任意整数，在集群中需要保证每个节点的 broker.id 都是唯一的。</p> \n<ul> \n <li>port</li> \n</ul> \n<p>如果使用配置样本来启动 kafka ，它会监听 9092 端口，修改 port 配置参数可以把它设置成其他任意可用的端口。</p> \n<ul> \n <li>zookeeper.connect</li> \n</ul> \n<p>用于保存 broker 元数据的地址是通过 zookeeper.connect 来指定。 localhost:2181 表示运行在本地 2181 端口。该配置参数是用逗号分隔的一组 hostname:port/path 列表，每一部分含义如下：</p> \n<p>hostname 是 zookeeper 服务器的服务名或 IP 地址</p> \n<p>port 是 zookeeper 连接的端口</p> \n<p>/path 是可选的 zookeeper 路径，作为 Kafka 集群的 chroot 环境。如果不指定，默认使用跟路径</p> \n<ul> \n <li>log.dirs</li> \n</ul> \n<p>Kafka 把消息都保存在磁盘上，存放这些日志片段的目录都是通过 <code>log.dirs</code> 来指定的。它是一组用逗号分隔的本地文件系统路径。如果指定了多个路径，那么 broker 会根据 \"最少使用\" 原则，把同一分区的日志片段保存到同一路径下。要注意，broker 会向拥有最少数目分区的路径新增分区，而不是向拥有最小磁盘空间的路径新增分区。</p> \n<ul> \n <li>num.recovery.threads.per.data.dir</li> \n</ul> \n<p>对于如下 3 种情况，Kafka 会使用可配置的线程池来处理日志片段</p> \n<p>服务器正常启动，用于打开每个分区的日志片段；</p> \n<p>服务器崩溃后启动，用于检查和截断每个分区的日志片段；</p> \n<p>服务器正常关闭，用于关闭日志片段</p> \n<p>默认情况下，每个日志目录只使用一个线程。因为这些线程只是在服务器启动和关闭时会用到，所以完全可以设置大量的线程来达到井行操作的目的。特别是对于包含大量分区的服务器来说，一旦发生崩愤，在进行恢复时使用井行操作可能会省下数小时的时间。设置此参数时需要注意，所配置的数字对应的是 log.dirs 指定的单个日志目录。也就是说，如果 num.recovery.threads.per.data.dir 被设为 8，并且 log.dir 指定了 3 个路径，那么总共需要 24 个线程。</p> \n<ul> \n <li>auto.create.topics.enable</li> \n</ul> \n<p>默认情况下，Kafka 会在如下 3 种情况下创建主题</p> \n<p>当一个生产者开始往主题写入消息时</p> \n<p>当一个消费者开始从主题读取消息时</p> \n<p>当任意一个客户向主题发送元数据请求时</p> \n<ul> \n <li>delete.topic.enable</li> \n</ul> \n<p>如果你想要删除一个主题，你可以使用主题管理工具。默认情况下，是不允许删除主题的，delete.topic.enable 的默认值是 false 因此你不能随意删除主题。这是对生产环境的合理性保护，但是在开发环境和测试环境，是可以允许你删除主题的，所以，如果你想要删除主题，需要把 delete.topic.enable 设为 true。</p> \n<h3 id=\"主题默认配置\">主题默认配置</h3> \n<p>Kafka 为新创建的主题提供了很多默认配置参数，下面就来一起认识一下这些参数</p> \n<ul> \n <li>num.partitions</li> \n</ul> \n<p>num.partitions 参数指定了新创建的主题需要包含多少个分区。如果启用了主题自动创建功能（该功能是默认启用的），主题分区的个数就是该参数指定的值。该参数的默认值是 1。要注意，我们可以增加主题分区的个数，但不能减少分区的个数。</p> \n<ul> \n <li>default.replication.factor</li> \n</ul> \n<p>这个参数比较简单，它表示 kafka保存消息的副本数，如果一个副本失效了，另一个还可以继续提供服务default.replication.factor 的默认值为1，这个参数在你启用了主题自动创建功能后有效。</p> \n<ul> \n <li>log.retention.ms</li> \n</ul> \n<p>Kafka 通常根据时间来决定数据可以保留多久。默认使用 log.retention.hours 参数来配置时间，默认是 168 个小时，也就是一周。除此之外，还有两个参数 log.retention.minutes 和 log.retentiion.ms 。这三个参数作用是一样的，都是决定消息多久以后被删除，推荐使用 log.retention.ms。</p> \n<ul> \n <li>log.retention.bytes</li> \n</ul> \n<p>另一种保留消息的方式是判断消息是否过期。它的值通过参数 <code>log.retention.bytes</code> 来指定，作用在每一个分区上。也就是说，如果有一个包含 8 个分区的主题，并且 log.retention.bytes 被设置为 1GB，那么这个主题最多可以保留 8GB 数据。所以，当主题的分区个数增加时，整个主题可以保留的数据也随之增加。</p> \n<ul> \n <li>log.segment.bytes</li> \n</ul> \n<p>上述的日志都是作用在日志片段上，而不是作用在单个消息上。当消息到达 broker 时，它们被追加到分区的当前日志片段上，当日志片段大小到达 log.segment.bytes 指定上限（默认为 1GB）时，当前日志片段就会被关闭，一个新的日志片段被打开。如果一个日志片段被关闭，就开始等待过期。这个参数的值越小，就越会频繁的关闭和分配新文件，从而降低磁盘写入的整体效率。</p> \n<ul> \n <li>log.segment.ms</li> \n</ul> \n<p>上面提到日志片段经关闭后需等待过期，那么 <code>log.segment.ms</code> 这个参数就是指定日志多长时间被关闭的参数和，log.segment.ms 和 log.retention.bytes 也不存在互斥问题。日志片段会在大小或时间到达上限时被关闭，就看哪个条件先得到满足。</p> \n<ul> \n <li>message.max.bytes</li> \n</ul> \n<p>broker 通过设置 <code>message.max.bytes</code> 参数来限制单个消息的大小，默认是 1000 000， 也就是 1MB，如果生产者尝试发送的消息超过这个大小，不仅消息不会被接收，还会收到 broker 返回的错误消息。跟其他与字节相关的配置参数一样，该参数指的是压缩后的消息大小，也就是说，只要压缩后的消息小于 mesage.max.bytes，那么消息的实际大小可以大于这个值</p> \n<p>这个值对性能有显著的影响。值越大，那么负责处理网络连接和请求的线程就需要花越多的时间来处理这些请求。它还会增加磁盘写入块的大小，从而影响 IO 吞吐量。</p> \n<p>文章参考：</p> \n<p><a href=\"https://www.cnblogs.com/luotianshuai/p/5206662.html\">Kafka【第一篇】Kafka集群搭建</a></p> \n<p><a href=\"https://juejin.im/post/5ba792f5e51d450e9e44184d\" class=\"uri\">https://juejin.im/post/5ba792f5e51d450e9e44184d</a></p> \n<p><a href=\"https://blog.csdn.net/k393393/article/details/93099276\" class=\"uri\">https://blog.csdn.net/k393393/article/details/93099276</a></p> \n<p>《Kafka权威指南》</p> \n<p><a href=\"https://www.learningjournal.guru/courses/kafka/kafka-foundation-training/broker-configurations/\" class=\"uri\">https://www.learningjournal.guru/courses/kafka/kafka-foundation-training/broker-configurations/</a></p> \n<p>下面为自己做个宣传，欢迎关注公众号 <code>Java建设者</code>，号主是Java技术栈，热爱技术，喜欢阅读，热衷于分享和总结，希望能把每一篇好文章分享给成长道路上的你。<br> 关注公众号回复 <code>002</code> 领取为你特意准备的大礼包，你一定会喜欢并收藏的。<br> <img src=\"http://localhost:9090/blogImages/2019/10/17/e3c5cba1-d666-4953-9a0f-acb66f759e34.jpeg\" alt=\"file\"></p> \n<blockquote> \n <p>本文由博客一文多发平台 <a href=\"https://openwrite.cn?from=article_bottom\">OpenWrite</a> 发布！</p><p><br></p><p><img src=\"http://localhost:9090/blogImages/2019/11/29/21d40512-5b5b-4f8a-9fec-3e1e01aa4d20.png\" alt=\"undefined\"><br></p> \n</blockquote>', 'Kafka 基本概述 \n什么是 Kafka \nKafka 是一个分布式流式平台，它有三个关键能力 \n \n 订阅发布记录流，它类似于企业中的消息队列 或 企业消息传递系统 \n 以容错的方式存储记录流 \n 实时记录流 \n \nKafka 的应用 \n \n 作为消息系统 \n 作为存储系统 \n 作为流处理器 \n \nKaf', '2019-10-17 17:38:07', 6, 6, 'Kafka 大数据', 'https://www.cnblogs.com/cxuanBlog/p/11691953.html', 1, '2020-08-06 15:20:32');
INSERT INTO `t_blog` VALUES (269, '机器学习 | 详解GBDT梯度提升树原理，看完再也不怕面试了', '<p>本文始发于个人公众号：TechFlow，原创不易，求个关注</p> \n<br> \n<section id=\"nice\" data-tool=\"mdnice编辑器\" data-website=\"https://www.mdnice.com\" style=\"font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \'PingFang SC\', Cambria, Cochin, Georgia, Times, \'Times New Roman\', serif;\">\n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">今天是<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">机器学习专题</strong>的第30篇文章，我们今天来聊一个机器学习时代可以说是最厉害的模型——GBDT。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">虽然文无第一武无第二，在机器学习领域并没有什么最厉害的模型这一说。但在深度学习兴起和流行之前，GBDT的确是<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">公认效果最出色的几个模型</strong>之一。虽然现在已经号称进入了深度学习以及人工智能时代，但是GBDT也没有落伍，它依然在很多的场景和公司当中被广泛使用。也是面试当中经常会问到的模型之一。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">遗憾的是市面上关于GBDT的资料虽然不少，但是很少有人把其中的核心精髓介绍清楚的。新手在初学的时候往往会被”<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">梯度</strong>“，”<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">残差</strong>“等这些令人费解的概念给困惑住，耽误了算法原理的学习和理解。但其实GBDT整体的原理还是比较直观和简单的，只要我们找对了方法，抓住了核心，我相信对于绝大多数人来说，应该都不会问题。</p> \n <h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; padding: 0px; font-weight: bold; font-size: 22px; border-bottom: 2px solid rgb(89,89,89); margin-bottom: 30px; color: rgb(89,89,89);\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; display: inline-block; border-bottom: 2px solid rgb(89,89,89);\">GBDT基础概念</span><span class=\"suffix\"></span></h2> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">GBDT的英文原文是Gradient Boosting Decision Tree，即<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">梯度提升决策树</strong>。从它的英文表述我们可以看出来，GBDT的基础还是决策树。决策树我们在之前的文章当中曾经有过详细的讨论，我们这里就不再赘述了。在GBDT当中用到的主要是决策树的CART算法，在CART算法当中，我们每次都会选择一个特征并且寻找一个阈值进行二分。将样本根据阈值分成小于等于阈值的以及大于阈值的两个部分，在CART树当中，同一个特征可以重复使用，其他类似的ID3和C4.5都没有这个性质。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">另外一个关键词是Boosting，Boosting表示一种<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">集成模型的训练方法</strong>，我们之前在介绍AdaBoost模型的时候曾经提到过。它最大的特点就是会训练多个模型，通过不断地迭代来降低整体模型的偏差。比如在Adaboost模型当中，会设置多个弱分类器，根据这些分类器的表现我们会给与它们不同的权值。通过这种设计尽可能让效果好的分类器拥有高权重，从而保证模型的拟合能力。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">但GBDT的Boosting方法与众不同，它是一个由多棵CART决策回归树构成的<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">加法模型</strong>。我们可以简单理解成最后整个模型的预测结果是所有回归树预测结果的和，理解了这一点对于后面理解梯度和残差非常重要。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">我们可以试着写一下GBDT的预测公式：</p> \n <span class=\"span-block-equation\" style=\"cursor:pointer\" data-tool=\"mdnice编辑器\">\n  <section class=\"block-equation\" role=\"presentation\" data-formula=\"f_M(x) = \\sum_{i=1}^MT(x, \\theta_i)\n\" data-formula-type=\"block-equation\" style=\"display: block; text-align: center; overflow: auto; display: block; -webkit-overflow-scrolling: touch; position: relative;\">\n   <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -1733 8839 2978.9\" aria-hidden=\"true\" style=\"-webkit-overflow-scrolling: touch; vertical-align: -2.819ex; width: 19.998ex; height: 6.74ex; max-width: 300% !important;\">\n    <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n     <g data-mml-node=\"math\">\n      <g data-mml-node=\"msub\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n        <path data-c=\"4D\" d=\"M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z\" />\n       </g>\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(1283.2, 0)\">\n       <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n      </g>\n      <g data-mml-node=\"mi\" transform=\"translate(1672.2, 0)\">\n       <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(2244.2, 0)\">\n       <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(2910.9, 0)\">\n       <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n      </g>\n      <g data-mml-node=\"munderover\" transform=\"translate(3966.7, 0)\">\n       <g data-mml-node=\"mo\">\n        <path data-c=\"2211\" d=\"M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z\" />\n       </g>\n       <g data-mml-node=\"TeXAtom\" transform=\"translate(148.2, -1087.9) scale(0.707)\" data-mjx-texclass=\"ORD\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n        </g>\n        <g data-mml-node=\"mo\" transform=\"translate(345, 0)\">\n         <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n        </g>\n        <g data-mml-node=\"mn\" transform=\"translate(1123, 0)\">\n         <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n        </g>\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(350.4, 1150) scale(0.707)\">\n        <path data-c=\"4D\" d=\"M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z\" />\n       </g>\n      </g>\n      <g data-mml-node=\"mi\" transform=\"translate(5577.4, 0)\">\n       <path data-c=\"54\" d=\"M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(6281.4, 0)\">\n       <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n      </g>\n      <g data-mml-node=\"mi\" transform=\"translate(6670.4, 0)\">\n       <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(7242.4, 0)\">\n       <path data-c=\"2C\" d=\"M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z\" />\n      </g>\n      <g data-mml-node=\"msub\" transform=\"translate(7687.1, 0)\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"3B8\" d=\"M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(469, -150) scale(0.707)\">\n        <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n       </g>\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(8450, 0)\">\n       <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n      </g>\n     </g>\n    </g>\n   </svg>\n  </section></span> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">公式中的M表示CART树的个数，<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"T(x, \\theta_i)\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -750 3261.6 1000\" aria-hidden=\"true\" style=\"vertical-align: -0.566ex; width: 7.379ex; height: 2.262ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"54\" d=\"M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z\" />\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(704, 0)\">\n        <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(1093, 0)\">\n        <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(1665, 0)\">\n        <path data-c=\"2C\" d=\"M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z\" />\n       </g>\n       <g data-mml-node=\"msub\" transform=\"translate(2109.7, 0)\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"3B8\" d=\"M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(469, -150) scale(0.707)\">\n         <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n        </g>\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(2872.6, 0)\">\n        <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n       </g>\n      </g>\n     </g>\n    </svg></span></span>表示第i棵回归树对于样本的预测结果，其中的<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"\\theta\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -705 469 715\" aria-hidden=\"true\" style=\"vertical-align: -0.023ex; width: 1.061ex; height: 1.618ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"3B8\" d=\"M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z\" />\n       </g>\n      </g>\n     </g>\n    </svg></span></span>表示每一棵回归树当中的参数。所以整个过程就和我刚才说的一样，GBDT模型最后的结果是<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">所有回归树预测结果的加和</strong>。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">但是这就有了一个问题，如果是回归问题那还好说，如果是分类问题那怎么办？难道分类结果也能加和吗？</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">其实也是可以的，我们知道在逻辑回归当中，我们用到的公式是<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"\\hat{y}=\\frac{1}{1 + e^{-\\theta x}}\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -864.9 4507.2 1372.1\" aria-hidden=\"true\" style=\"vertical-align: -1.147ex; width: 10.197ex; height: 3.104ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"TeXAtom\" data-mjx-texclass=\"ORD\">\n        <g data-mml-node=\"mover\">\n         <g data-mml-node=\"mi\" transform=\"translate(5, 0)\">\n          <path data-c=\"79\" d=\"M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(55.6, -29)\">\n          <path data-c=\"5E\" d=\"M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z\" />\n         </g>\n        </g>\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(833.4, 0)\">\n        <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n       </g>\n       <g data-mml-node=\"mfrac\" transform=\"translate(1889.2, 0)\">\n        <g data-mml-node=\"mn\" transform=\"translate(1132.2, 394) scale(0.707)\">\n         <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n        </g>\n        <g data-mml-node=\"mrow\" transform=\"translate(220, -449.2) scale(0.707)\">\n         <g data-mml-node=\"mn\">\n          <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(500, 0)\">\n          <path data-c=\"2B\" d=\"M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z\" />\n         </g>\n         <g data-mml-node=\"msup\" transform=\"translate(1278, 0)\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"65\" d=\"M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(466, 363) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mo\">\n            <path data-c=\"2212\" d=\"M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(778, 0)\">\n            <path data-c=\"3B8\" d=\"M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(1247, 0)\">\n            <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n           </g>\n          </g>\n         </g>\n        </g>\n        <rect width=\"2378\" height=\"60\" x=\"120\" y=\"220\" />\n       </g>\n      </g>\n     </g>\n    </svg></span></span>，这个式子的结果表示样本的类别是1的概率。我们当然不能直接来拟合这个概率，但是我们可以<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">用加和的方式来拟合<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"\\theta x\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n     <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -705 1041 716\" aria-hidden=\"true\" style=\"vertical-align: -0.025ex; width: 2.355ex; height: 1.62ex;\">\n      <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n       <g data-mml-node=\"math\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"3B8\" d=\"M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(469, 0)\">\n         <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n        </g>\n       </g>\n      </g>\n     </svg></span></span>的结果</strong>，这样我们就间接得到了概率。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">今天的文章当中我们主要先来讲解回归问题，因为它的公式和理解最直观简单。分类的问题我们将会放到下一篇文章当中，因此这里稍作了解即可。</p> \n <h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; padding: 0px; font-weight: bold; font-size: 22px; border-bottom: 2px solid rgb(89,89,89); margin-bottom: 30px; color: rgb(89,89,89);\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; display: inline-block; border-bottom: 2px solid rgb(89,89,89);\">梯度和残差</span><span class=\"suffix\"></span></h2> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">下面我们要介绍到梯度和残差的概念了，我们先来回顾一下线性回归当中梯度下降的用法。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">在线性回归当中我们使用梯度下降法是为了<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">寻找最佳的参数</strong>，使得损失函数最小。实际上目前绝大多数的模型都是这么做的，计算梯度的目的是为了调整参数。但是GBDT不同，<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">计算梯度是为了下一轮的迭代</strong>，这句话非常关键，一定要理解。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">我们来举个例子，假设我们用线性回归<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"y = \\theta x + b\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -705 4516 910\" aria-hidden=\"true\" style=\"vertical-align: -0.464ex; width: 10.217ex; height: 2.059ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"79\" d=\"M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(767.8, 0)\">\n        <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(1823.6, 0)\">\n        <path data-c=\"3B8\" d=\"M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(2292.6, 0)\">\n        <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(3086.8, 0)\">\n        <path data-c=\"2B\" d=\"M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(4087, 0)\">\n        <path data-c=\"62\" d=\"M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z\" />\n       </g>\n      </g>\n     </g>\n    </svg></span></span>拟合一个值，这里的目标y是20。我们当前的<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"\\theta\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -705 469 715\" aria-hidden=\"true\" style=\"vertical-align: -0.023ex; width: 1.061ex; height: 1.618ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"3B8\" d=\"M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z\" />\n       </g>\n      </g>\n     </g>\n    </svg></span></span>得到的<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"\\hat{y}\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -765 555.6 970\" aria-hidden=\"true\" style=\"vertical-align: -0.464ex; width: 1.257ex; height: 2.195ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"TeXAtom\" data-mjx-texclass=\"ORD\">\n        <g data-mml-node=\"mover\">\n         <g data-mml-node=\"mi\" transform=\"translate(5, 0)\">\n          <path data-c=\"79\" d=\"M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(55.6, -29)\">\n          <path data-c=\"5E\" d=\"M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z\" />\n         </g>\n        </g>\n       </g>\n      </g>\n     </g>\n    </svg></span></span>是10，那么我们应该计算梯度来调整参数<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"\\theta\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -705 469 715\" aria-hidden=\"true\" style=\"vertical-align: -0.023ex; width: 1.061ex; height: 1.618ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"3B8\" d=\"M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z\" />\n       </g>\n      </g>\n     </g>\n    </svg></span></span>，明显应该将它调大一些从而降低偏差。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">但是GBDT不是这么干的，同样假设我们第一棵回归树得到的结果也是10，和真实结果相差了10，我们一样来计算梯度。在回归问题当中，我们通常使用<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">均方差MSE</strong>作为损失函数，那么我们可以来算一下这个函数的梯度。我们先写出损失函数的公式：</p> \n <span class=\"span-block-equation\" style=\"cursor:pointer\" data-tool=\"mdnice编辑器\">\n  <section class=\"block-equation\" role=\"presentation\" data-formula=\"L = \\frac{1}{2}(y_i - f(x_i))^2\n\" data-formula-type=\"block-equation\" style=\"display: block; text-align: center; overflow: auto; display: block; -webkit-overflow-scrolling: touch; position: relative;\">\n   <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -1342 8336.5 2028\" aria-hidden=\"true\" style=\"-webkit-overflow-scrolling: touch; vertical-align: -1.552ex; width: 18.861ex; height: 4.588ex; max-width: 300% !important;\">\n    <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n     <g data-mml-node=\"math\">\n      <g data-mml-node=\"mi\">\n       <path data-c=\"4C\" d=\"M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(958.8, 0)\">\n       <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n      </g>\n      <g data-mml-node=\"mfrac\" transform=\"translate(2014.6, 0)\">\n       <g data-mml-node=\"mn\" transform=\"translate(220, 676)\">\n        <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n       </g>\n       <g data-mml-node=\"mn\" transform=\"translate(220, -686)\">\n        <path data-c=\"32\" d=\"M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z\" />\n       </g>\n       <rect width=\"700\" height=\"60\" x=\"120\" y=\"220\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(2954.6, 0)\">\n       <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n      </g>\n      <g data-mml-node=\"msub\" transform=\"translate(3343.6, 0)\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"79\" d=\"M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n        <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n       </g>\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(4349.7, 0)\">\n       <path data-c=\"2212\" d=\"M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z\" />\n      </g>\n      <g data-mml-node=\"mi\" transform=\"translate(5350, 0)\">\n       <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(5900, 0)\">\n       <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n      </g>\n      <g data-mml-node=\"msub\" transform=\"translate(6289, 0)\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(572, -150) scale(0.707)\">\n        <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n       </g>\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(7154.9, 0)\">\n       <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n      </g>\n      <g data-mml-node=\"msup\" transform=\"translate(7543.9, 0)\">\n       <g data-mml-node=\"mo\">\n        <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n       </g>\n       <g data-mml-node=\"mn\" transform=\"translate(389, 413) scale(0.707)\">\n        <path data-c=\"32\" d=\"M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z\" />\n       </g>\n      </g>\n     </g>\n    </g>\n   </svg>\n  </section></span> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">L关于<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"f(x_i)\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -750 2194 1000\" aria-hidden=\"true\" style=\"vertical-align: -0.566ex; width: 4.964ex; height: 2.262ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(550, 0)\">\n        <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n       </g>\n       <g data-mml-node=\"msub\" transform=\"translate(939, 0)\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(572, -150) scale(0.707)\">\n         <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n        </g>\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(1805, 0)\">\n        <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n       </g>\n      </g>\n     </g>\n    </svg></span></span>的负梯度值刚好等于<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"y_i - f(x_i)\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -750 4200.3 1000\" aria-hidden=\"true\" style=\"vertical-align: -0.566ex; width: 9.503ex; height: 2.262ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"msub\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"79\" d=\"M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n         <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n        </g>\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(1006.2, 0)\">\n        <path data-c=\"2212\" d=\"M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(2006.4, 0)\">\n        <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(2556.4, 0)\">\n        <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n       </g>\n       <g data-mml-node=\"msub\" transform=\"translate(2945.4, 0)\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(572, -150) scale(0.707)\">\n         <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n        </g>\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(3811.3, 0)\">\n        <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n       </g>\n      </g>\n     </g>\n    </svg></span></span>，看起来<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">刚好是我们要预测的目标值减去之前模型预测的结果</strong>。这个值也就是我们常说的残差。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">我们用<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"r_{mi}\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -442 1365.8 599.8\" aria-hidden=\"true\" style=\"vertical-align: -0.357ex; width: 3.09ex; height: 1.357ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"msub\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"72\" d=\"M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n        </g>\n        <g data-mml-node=\"TeXAtom\" transform=\"translate(451, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n         <g data-mml-node=\"mi\">\n          <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n          <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n         </g>\n        </g>\n       </g>\n      </g>\n     </g>\n    </svg></span></span>表示第m棵回归树对于样本i的训练目标，它的公式为：</p> \n <span class=\"span-block-equation\" style=\"cursor:pointer\" data-tool=\"mdnice编辑器\">\n  <section class=\"block-equation\" role=\"presentation\" data-formula=\"r_{mi} = y_i - f(x_i)\n\" data-formula-type=\"block-equation\" style=\"display: block; text-align: center; overflow: auto; display: block; -webkit-overflow-scrolling: touch; position: relative;\">\n   <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -750 6899.7 1000\" aria-hidden=\"true\" style=\"-webkit-overflow-scrolling: touch; vertical-align: -0.566ex; width: 15.61ex; height: 2.262ex; max-width: 300% !important;\">\n    <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n     <g data-mml-node=\"math\">\n      <g data-mml-node=\"msub\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"72\" d=\"M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n       </g>\n       <g data-mml-node=\"TeXAtom\" transform=\"translate(451, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n         <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n        </g>\n       </g>\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(1643.6, 0)\">\n       <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n      </g>\n      <g data-mml-node=\"msub\" transform=\"translate(2699.3, 0)\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"79\" d=\"M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n        <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n       </g>\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(3705.5, 0)\">\n       <path data-c=\"2212\" d=\"M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z\" />\n      </g>\n      <g data-mml-node=\"mi\" transform=\"translate(4705.7, 0)\">\n       <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(5255.7, 0)\">\n       <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n      </g>\n      <g data-mml-node=\"msub\" transform=\"translate(5644.7, 0)\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(572, -150) scale(0.707)\">\n        <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n       </g>\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(6510.7, 0)\">\n       <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n      </g>\n     </g>\n    </g>\n   </svg>\n  </section></span> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">从直观上来讲究很简单了，我们要预测的结果是20，第一棵树预测了10，相差还剩10，于是我们用第二棵树来逼近。第二棵树预测了5，相差变成了5，我们继续创建第三棵树……</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">一直到我们已经逼近到了非常接近小于我们设定的阈值的时候，或者子树的数量达到了上限，这个时候模型的训练就停止了。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">这里要注意，<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">不能把残差简单理解成目标值和<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"f(x_i)\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n     <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -750 2194 1000\" aria-hidden=\"true\" style=\"vertical-align: -0.566ex; width: 4.964ex; height: 2.262ex;\">\n      <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n       <g data-mml-node=\"math\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n        </g>\n        <g data-mml-node=\"mo\" transform=\"translate(550, 0)\">\n         <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n        </g>\n        <g data-mml-node=\"msub\" transform=\"translate(939, 0)\">\n         <g data-mml-node=\"mi\">\n          <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(572, -150) scale(0.707)\">\n          <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n         </g>\n        </g>\n        <g data-mml-node=\"mo\" transform=\"translate(1805, 0)\">\n         <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n        </g>\n       </g>\n      </g>\n     </svg></span></span>的差值</strong>，它本质是由损失函数计算负梯度得到的。</p> \n <h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; padding: 0px; font-weight: bold; font-size: 22px; border-bottom: 2px solid rgb(89,89,89); margin-bottom: 30px; color: rgb(89,89,89);\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; display: inline-block; border-bottom: 2px solid rgb(89,89,89);\">训练过程</span><span class=\"suffix\"></span></h2> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">我们再把模型训练的整个过程给整理一下，把所有的细节串联起来。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">首先我们先明确几个参数，M表示决策树的数量。<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"f_m(x_i)\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -750 2804.8 1000\" aria-hidden=\"true\" style=\"vertical-align: -0.566ex; width: 6.346ex; height: 2.262ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"msub\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n         <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n        </g>\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(1160.8, 0)\">\n        <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n       </g>\n       <g data-mml-node=\"msub\" transform=\"translate(1549.8, 0)\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(572, -150) scale(0.707)\">\n         <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n        </g>\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(2415.8, 0)\">\n        <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n       </g>\n      </g>\n     </g>\n    </svg></span></span>表示第m轮训练之后的整体，<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"f_m(x_i)\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -750 2804.8 1000\" aria-hidden=\"true\" style=\"vertical-align: -0.566ex; width: 6.346ex; height: 2.262ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"msub\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n         <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n        </g>\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(1160.8, 0)\">\n        <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n       </g>\n       <g data-mml-node=\"msub\" transform=\"translate(1549.8, 0)\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(572, -150) scale(0.707)\">\n         <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n        </g>\n       </g>\n       <g data-mml-node=\"mo\" transform=\"translate(2415.8, 0)\">\n        <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n       </g>\n      </g>\n     </g>\n    </svg></span></span>即为最终输出的GBDT模型。</p> \n <ol data-tool=\"mdnice编辑器\" style=\"margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;\"> \n  <li>\n   <section style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;\">\n    <p style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">初始化</p> \n    <p style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">首先，我们创建第一棵回归树即<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"f_1(x)\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n       <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -750 2243.6 1000\" aria-hidden=\"true\" style=\"vertical-align: -0.566ex; width: 5.076ex; height: 2.262ex;\">\n        <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n         <g data-mml-node=\"math\">\n          <g data-mml-node=\"msub\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n           </g>\n           <g data-mml-node=\"mn\" transform=\"translate(490, -150) scale(0.707)\">\n            <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n           </g>\n          </g>\n          <g data-mml-node=\"mo\" transform=\"translate(893.6, 0)\">\n           <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(1282.6, 0)\">\n           <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n          </g>\n          <g data-mml-node=\"mo\" transform=\"translate(1854.6, 0)\">\n           <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n          </g>\n         </g>\n        </g>\n       </svg></span></span>，在回归问题当中，它是直接用回归树拟合目标值的结果，所以：</p> \n    <span class=\"span-block-equation\" style=\"cursor:pointer\">\n     <section class=\"block-equation\" role=\"presentation\" data-formula=\"f_1(x) = \\mathop{\\arg\\min}_{c} \\ \\ \\ \\sum_{i=1}^NL(y_i, c)\n\" data-formula-type=\"block-equation\" style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; color: rgb(1,1,1); font-weight: 500; display: block; text-align: center; overflow: auto; display: block; -webkit-overflow-scrolling: touch; position: relative;\">\n      <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -1733 12617.4 2978.9\" aria-hidden=\"true\" style=\"-webkit-overflow-scrolling: touch; vertical-align: -2.819ex; width: 28.546ex; height: 6.74ex; max-width: 300% !important;\">\n       <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n        <g data-mml-node=\"math\">\n         <g data-mml-node=\"msub\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n          </g>\n          <g data-mml-node=\"mn\" transform=\"translate(490, -150) scale(0.707)\">\n           <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(893.6, 0)\">\n          <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(1282.6, 0)\">\n          <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(1854.6, 0)\">\n          <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(2521.3, 0)\">\n          <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n         </g>\n         <g data-mml-node=\"munder\" transform=\"translate(3577.1, 0)\">\n          <g data-mml-node=\"TeXAtom\" data-mjx-texclass=\"OP\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"61\" d=\"M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z\" />\n            <path data-c=\"72\" d=\"M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z\" transform=\"translate(500, 0)\" />\n            <path data-c=\"67\" d=\"M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z\" transform=\"translate(892, 0)\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(1392, 0)\">\n            <path data-c=\"2061\" d=\"\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(1558.7, 0)\">\n            <path data-c=\"6D\" d=\"M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z\" />\n            <path data-c=\"69\" d=\"M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z\" transform=\"translate(833, 0)\" />\n            <path data-c=\"6E\" d=\"M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z\" transform=\"translate(1111, 0)\" />\n           </g>\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(1459.7, -806) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"63\" d=\"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z\" />\n           </g>\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(6802.8, 0)\">\n          <path data-c=\"2061\" d=\"\" />\n         </g>\n         <g data-mml-node=\"mtext\" transform=\"translate(6969.4, 0)\">\n          <path data-c=\"A0\" d=\"\" />\n         </g>\n         <g data-mml-node=\"mtext\" transform=\"translate(7219.4, 0)\">\n          <path data-c=\"A0\" d=\"\" />\n         </g>\n         <g data-mml-node=\"mtext\" transform=\"translate(7469.4, 0)\">\n          <path data-c=\"A0\" d=\"\" />\n         </g>\n         <g data-mml-node=\"munderover\" transform=\"translate(7886.1, 0)\">\n          <g data-mml-node=\"mo\">\n           <path data-c=\"2211\" d=\"M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(148.2, -1087.9) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(345, 0)\">\n            <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n           </g>\n           <g data-mml-node=\"mn\" transform=\"translate(1123, 0)\">\n            <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n           </g>\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(408, 1150) scale(0.707)\">\n           <path data-c=\"4E\" d=\"M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z\" />\n          </g>\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(9496.8, 0)\">\n          <path data-c=\"4C\" d=\"M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(10177.8, 0)\">\n          <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n         </g>\n         <g data-mml-node=\"msub\" transform=\"translate(10566.8, 0)\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"79\" d=\"M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n           <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(11350.7, 0)\">\n          <path data-c=\"2C\" d=\"M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z\" />\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(11795.4, 0)\">\n          <path data-c=\"63\" d=\"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(12228.4, 0)\">\n          <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n         </g>\n        </g>\n       </g>\n      </svg>\n     </section></span> \n   </section></li>\n  <li>\n   <section style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;\">\n    <p style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">迭代</p> \n    <p style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">i. 对于第2到第m棵回归树，我们要计算出每一棵树的训练目标， 也就是前面结果的残差：</p> \n    <span class=\"span-block-equation\" style=\"cursor:pointer\">\n     <section class=\"block-equation\" role=\"presentation\" data-formula=\"r_{mi}=-[\\frac{\\partial L(y_i, f(x_i))}{\\partial f(x_i)}]_{f(x) = f_{m-1}(x)}\n\" data-formula-type=\"block-equation\" style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; color: rgb(1,1,1); font-weight: 500; display: block; text-align: center; overflow: auto; display: block; -webkit-overflow-scrolling: touch; position: relative;\">\n      <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -1460 14279 2420\" aria-hidden=\"true\" style=\"-webkit-overflow-scrolling: touch; vertical-align: -2.172ex; width: 32.305ex; height: 5.475ex; max-width: 300% !important;\">\n       <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n        <g data-mml-node=\"math\">\n         <g data-mml-node=\"msub\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"72\" d=\"M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(451, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n            <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n           </g>\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(1643.6, 0)\">\n          <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(2699.3, 0)\">\n          <path data-c=\"2212\" d=\"M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(3477.3, 0)\">\n          <path data-c=\"5B\" d=\"M118 -250V750H255V710H158V-210H255V-250H118Z\" />\n         </g>\n         <g data-mml-node=\"mfrac\" transform=\"translate(3755.3, 0)\">\n          <g data-mml-node=\"mrow\" transform=\"translate(220, 710)\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"2202\" d=\"M202 508Q179 508 169 520T158 547Q158 557 164 577T185 624T230 675T301 710L333 715H345Q378 715 384 714Q447 703 489 661T549 568T566 457Q566 362 519 240T402 53Q321 -22 223 -22Q123 -22 73 56Q42 102 42 148V159Q42 276 129 370T322 465Q383 465 414 434T455 367L458 378Q478 461 478 515Q478 603 437 639T344 676Q266 676 223 612Q264 606 264 572Q264 547 246 528T202 508ZM430 306Q430 372 401 400T333 428Q270 428 222 382Q197 354 183 323T150 221Q132 149 132 116Q132 21 232 21Q244 21 250 22Q327 35 374 112Q389 137 409 196T430 306Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(566, 0)\">\n            <path data-c=\"4C\" d=\"M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(1247, 0)\">\n            <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n           </g>\n           <g data-mml-node=\"msub\" transform=\"translate(1636, 0)\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"79\" d=\"M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n            </g>\n            <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n             <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n            </g>\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(2420, 0)\">\n            <path data-c=\"2C\" d=\"M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(2864.6, 0)\">\n            <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(3414.6, 0)\">\n            <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n           </g>\n           <g data-mml-node=\"msub\" transform=\"translate(3803.6, 0)\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n            </g>\n            <g data-mml-node=\"mi\" transform=\"translate(572, -150) scale(0.707)\">\n             <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n            </g>\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(4669.6, 0)\">\n            <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(5058.6, 0)\">\n            <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n           </g>\n          </g>\n          <g data-mml-node=\"mrow\" transform=\"translate(1563.8, -710)\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"2202\" d=\"M202 508Q179 508 169 520T158 547Q158 557 164 577T185 624T230 675T301 710L333 715H345Q378 715 384 714Q447 703 489 661T549 568T566 457Q566 362 519 240T402 53Q321 -22 223 -22Q123 -22 73 56Q42 102 42 148V159Q42 276 129 370T322 465Q383 465 414 434T455 367L458 378Q478 461 478 515Q478 603 437 639T344 676Q266 676 223 612Q264 606 264 572Q264 547 246 528T202 508ZM430 306Q430 372 401 400T333 428Q270 428 222 382Q197 354 183 323T150 221Q132 149 132 116Q132 21 232 21Q244 21 250 22Q327 35 374 112Q389 137 409 196T430 306Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(566, 0)\">\n            <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(1116, 0)\">\n            <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n           </g>\n           <g data-mml-node=\"msub\" transform=\"translate(1505, 0)\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n            </g>\n            <g data-mml-node=\"mi\" transform=\"translate(572, -150) scale(0.707)\">\n             <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n            </g>\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(2371, 0)\">\n            <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n           </g>\n          </g>\n          <rect width=\"5647.6\" height=\"60\" x=\"120\" y=\"220\" />\n         </g>\n         <g data-mml-node=\"msub\" transform=\"translate(9642.9, 0)\">\n          <g data-mml-node=\"mo\">\n           <path data-c=\"5D\" d=\"M22 710V750H159V-250H22V-210H119V710H22Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(278, -176.7) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(550, 0)\">\n            <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(939, 0)\">\n            <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(1511, 0)\">\n            <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(1900, 0)\">\n            <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n           </g>\n           <g data-mml-node=\"msub\" transform=\"translate(2678, 0)\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n            </g>\n            <g data-mml-node=\"TeXAtom\" transform=\"translate(490, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n             <g data-mml-node=\"mi\">\n              <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n             </g>\n             <g data-mml-node=\"mo\" transform=\"translate(878, 0)\">\n              <path data-c=\"2212\" d=\"M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z\" />\n             </g>\n             <g data-mml-node=\"mn\" transform=\"translate(1656, 0)\">\n              <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n             </g>\n            </g>\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(4742.5, 0)\">\n            <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(5131.5, 0)\">\n            <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(5703.5, 0)\">\n            <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n           </g>\n          </g>\n         </g>\n        </g>\n       </g>\n      </svg>\n     </section></span> \n    <p style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">ii. 对于当前第m棵子树而言，我们需要遍历它的可行的切分点以及阈值，找到最优的预测值c对应的参数，使得尽可能逼近残差，我们来写出这段公式：</p> \n    <span class=\"span-block-equation\" style=\"cursor:pointer\">\n     <section class=\"block-equation\" role=\"presentation\" data-formula=\"c_{mj}=\\mathop{\\arg\\min}_{c} \\ \\ \\ \\sum_{x_i\\in R_{mj}}L(y_i, f_{m-1}(x_i) + c)\n\" data-formula-type=\"block-equation\" style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; color: rgb(1,1,1); font-weight: 500; display: block; text-align: center; overflow: auto; display: block; -webkit-overflow-scrolling: touch; position: relative;\">\n      <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -950 17556.9 2358\" aria-hidden=\"true\" style=\"-webkit-overflow-scrolling: touch; vertical-align: -3.186ex; width: 39.722ex; height: 5.335ex; max-width: 300% !important;\">\n       <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n        <g data-mml-node=\"math\">\n         <g data-mml-node=\"msub\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"63\" d=\"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(433, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n            <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n           </g>\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(1672.9, 0)\">\n          <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n         </g>\n         <g data-mml-node=\"munder\" transform=\"translate(2728.7, 0)\">\n          <g data-mml-node=\"TeXAtom\" data-mjx-texclass=\"OP\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"61\" d=\"M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z\" />\n            <path data-c=\"72\" d=\"M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z\" transform=\"translate(500, 0)\" />\n            <path data-c=\"67\" d=\"M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z\" transform=\"translate(892, 0)\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(1392, 0)\">\n            <path data-c=\"2061\" d=\"\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(1558.7, 0)\">\n            <path data-c=\"6D\" d=\"M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z\" />\n            <path data-c=\"69\" d=\"M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z\" transform=\"translate(833, 0)\" />\n            <path data-c=\"6E\" d=\"M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z\" transform=\"translate(1111, 0)\" />\n           </g>\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(1459.7, -806) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"63\" d=\"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z\" />\n           </g>\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(5954.4, 0)\">\n          <path data-c=\"2061\" d=\"\" />\n         </g>\n         <g data-mml-node=\"mtext\" transform=\"translate(6121.1, 0)\">\n          <path data-c=\"A0\" d=\"\" />\n         </g>\n         <g data-mml-node=\"mtext\" transform=\"translate(6371.1, 0)\">\n          <path data-c=\"A0\" d=\"\" />\n         </g>\n         <g data-mml-node=\"mtext\" transform=\"translate(6621.1, 0)\">\n          <path data-c=\"A0\" d=\"\" />\n         </g>\n         <g data-mml-node=\"munder\" transform=\"translate(7037.7, 0)\">\n          <g data-mml-node=\"mo\" transform=\"translate(428.5, 0)\">\n           <path data-c=\"2211\" d=\"M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(0, -1100) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"msub\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n            </g>\n            <g data-mml-node=\"mi\" transform=\"translate(572, -150) scale(0.707)\">\n             <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n            </g>\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(866, 0)\">\n            <path data-c=\"2208\" d=\"M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z\" />\n           </g>\n           <g data-mml-node=\"msub\" transform=\"translate(1533, 0)\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"52\" d=\"M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z\" />\n            </g>\n            <g data-mml-node=\"TeXAtom\" transform=\"translate(759, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n             <g data-mml-node=\"mi\">\n              <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n             </g>\n             <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n              <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n             </g>\n            </g>\n           </g>\n          </g>\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(9505.4, 0)\">\n          <path data-c=\"4C\" d=\"M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(10186.4, 0)\">\n          <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n         </g>\n         <g data-mml-node=\"msub\" transform=\"translate(10575.4, 0)\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"79\" d=\"M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n           <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(11359.4, 0)\">\n          <path data-c=\"2C\" d=\"M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z\" />\n         </g>\n         <g data-mml-node=\"msub\" transform=\"translate(11804, 0)\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(490, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(878, 0)\">\n            <path data-c=\"2212\" d=\"M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z\" />\n           </g>\n           <g data-mml-node=\"mn\" transform=\"translate(1656, 0)\">\n            <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n           </g>\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(13868.5, 0)\">\n          <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n         </g>\n         <g data-mml-node=\"msub\" transform=\"translate(14257.5, 0)\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(572, -150) scale(0.707)\">\n           <path data-c=\"69\" d=\"M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z\" />\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(15123.5, 0)\">\n          <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(15734.7, 0)\">\n          <path data-c=\"2B\" d=\"M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z\" />\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(16734.9, 0)\">\n          <path data-c=\"63\" d=\"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(17167.9, 0)\">\n          <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n         </g>\n        </g>\n       </g>\n      </svg>\n     </section></span> \n    <p style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">这里的<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"R_{mj}\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n       <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -683 1721.2 977.2\" aria-hidden=\"true\" style=\"vertical-align: -0.666ex; width: 3.894ex; height: 2.211ex;\">\n        <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n         <g data-mml-node=\"math\">\n          <g data-mml-node=\"msub\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"52\" d=\"M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z\" />\n           </g>\n           <g data-mml-node=\"TeXAtom\" transform=\"translate(759, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n            </g>\n            <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n             <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n            </g>\n           </g>\n          </g>\n         </g>\n        </g>\n       </svg></span></span>指的是第m棵子树所有的划分方法中叶子节点预测值的集合，也就是<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">第m棵回归树可能达到的预测值</strong>。其中j的范围是1,2,3...J。</p> \n    <p style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">接着，我们更新<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"f_m(x) = f_{m-1}(x) + \\sum_{j=1}^J c_{mj}I(x \\in R_{mj})\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n       <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -960 17141.9 1389.6\" aria-hidden=\"true\" style=\"vertical-align: -0.972ex; width: 38.783ex; height: 3.144ex;\">\n        <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n         <g data-mml-node=\"math\">\n          <g data-mml-node=\"msub\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n            <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n           </g>\n          </g>\n          <g data-mml-node=\"mo\" transform=\"translate(1160.8, 0)\">\n           <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(1549.8, 0)\">\n           <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n          </g>\n          <g data-mml-node=\"mo\" transform=\"translate(2121.8, 0)\">\n           <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n          </g>\n          <g data-mml-node=\"mo\" transform=\"translate(2788.6, 0)\">\n           <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n          </g>\n          <g data-mml-node=\"msub\" transform=\"translate(3844.4, 0)\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n           </g>\n           <g data-mml-node=\"TeXAtom\" transform=\"translate(490, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n            </g>\n            <g data-mml-node=\"mo\" transform=\"translate(878, 0)\">\n             <path data-c=\"2212\" d=\"M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z\" />\n            </g>\n            <g data-mml-node=\"mn\" transform=\"translate(1656, 0)\">\n             <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n            </g>\n           </g>\n          </g>\n          <g data-mml-node=\"mo\" transform=\"translate(5908.9, 0)\">\n           <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(6297.9, 0)\">\n           <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n          </g>\n          <g data-mml-node=\"mo\" transform=\"translate(6869.9, 0)\">\n           <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n          </g>\n          <g data-mml-node=\"mo\" transform=\"translate(7481.1, 0)\">\n           <path data-c=\"2B\" d=\"M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z\" />\n          </g>\n          <g data-mml-node=\"munderover\" transform=\"translate(8481.4, 0)\">\n           <g data-mml-node=\"mo\">\n            <path data-c=\"2211\" d=\"M61 748Q64 750 489 750H913L954 640Q965 609 976 579T993 533T999 516H979L959 517Q936 579 886 621T777 682Q724 700 655 705T436 710H319Q183 710 183 709Q186 706 348 484T511 259Q517 250 513 244L490 216Q466 188 420 134T330 27L149 -187Q149 -188 362 -188Q388 -188 436 -188T506 -189Q679 -189 778 -162T936 -43Q946 -27 959 6H999L913 -249L489 -250Q65 -250 62 -248Q56 -246 56 -239Q56 -234 118 -161Q186 -81 245 -11L428 206Q428 207 242 462L57 717L56 728Q56 744 61 748Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(1056, 477.1) scale(0.707)\">\n            <path data-c=\"4A\" d=\"M447 625Q447 637 354 637H329Q323 642 323 645T325 664Q329 677 335 683H352Q393 681 498 681Q541 681 568 681T605 682T619 682Q633 682 633 672Q633 670 630 658Q626 642 623 640T604 637Q552 637 545 623Q541 610 483 376Q420 128 419 127Q397 64 333 21T195 -22Q137 -22 97 8T57 88Q57 130 80 152T132 174Q177 174 182 130Q182 98 164 80T123 56Q115 54 115 53T122 44Q148 15 197 15Q235 15 271 47T324 130Q328 142 387 380T447 625Z\" />\n           </g>\n           <g data-mml-node=\"TeXAtom\" transform=\"translate(1056, -285.4) scale(0.707)\" data-mjx-texclass=\"ORD\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n            </g>\n            <g data-mml-node=\"mo\" transform=\"translate(412, 0)\">\n             <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n            </g>\n            <g data-mml-node=\"mn\" transform=\"translate(1190, 0)\">\n             <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n            </g>\n           </g>\n          </g>\n          <g data-mml-node=\"msub\" transform=\"translate(10949, 0)\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"63\" d=\"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z\" />\n           </g>\n           <g data-mml-node=\"TeXAtom\" transform=\"translate(433, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n            </g>\n            <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n             <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n            </g>\n           </g>\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(12344.2, 0)\">\n           <path data-c=\"49\" d=\"M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z\" />\n          </g>\n          <g data-mml-node=\"mo\" transform=\"translate(12848.2, 0)\">\n           <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(13237.2, 0)\">\n           <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n          </g>\n          <g data-mml-node=\"mo\" transform=\"translate(14087, 0)\">\n           <path data-c=\"2208\" d=\"M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z\" />\n          </g>\n          <g data-mml-node=\"msub\" transform=\"translate(15031.8, 0)\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"52\" d=\"M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z\" />\n           </g>\n           <g data-mml-node=\"TeXAtom\" transform=\"translate(759, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n            </g>\n            <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n             <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n            </g>\n           </g>\n          </g>\n          <g data-mml-node=\"mo\" transform=\"translate(16752.9, 0)\">\n           <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n          </g>\n         </g>\n        </g>\n       </svg></span></span>，这里的I是一个函数，如果样本落在了<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"R_{mj}\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n       <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -683 1721.2 977.2\" aria-hidden=\"true\" style=\"vertical-align: -0.666ex; width: 3.894ex; height: 2.211ex;\">\n        <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n         <g data-mml-node=\"math\">\n          <g data-mml-node=\"msub\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"52\" d=\"M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z\" />\n           </g>\n           <g data-mml-node=\"TeXAtom\" transform=\"translate(759, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n            <g data-mml-node=\"mi\">\n             <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n            </g>\n            <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n             <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n            </g>\n           </g>\n          </g>\n         </g>\n        </g>\n       </svg></span></span>节点上，那么I=1，否则I=0。</p> \n   </section></li>\n  <li>\n   <section style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;\">\n    <p style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">最后我们得到回归树</p> \n    <span class=\"span-block-equation\" style=\"cursor:pointer\">\n     <section class=\"block-equation\" role=\"presentation\" data-formula=\"F(x) = f_M(x) = \\sum_{m=1}^Mf_m(x)=\\sum_{m=1}^M\\sum_{j=1}^J c_{mj}I(x \\in R_{mj})\n\" data-formula-type=\"block-equation\" style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; color: rgb(1,1,1); font-weight: 500; display: block; text-align: center; overflow: auto; display: block; -webkit-overflow-scrolling: touch; position: relative;\">\n      <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -1733 22429.6 3065.1\" aria-hidden=\"true\" style=\"-webkit-overflow-scrolling: touch; vertical-align: -3.014ex; width: 50.746ex; height: 6.935ex; max-width: 300% !important;\">\n       <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n        <g data-mml-node=\"math\">\n         <g data-mml-node=\"mi\">\n          <path data-c=\"46\" d=\"M48 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H742Q749 676 749 669Q749 664 736 557T722 447Q720 440 702 440H690Q683 445 683 453Q683 454 686 477T689 530Q689 560 682 579T663 610T626 626T575 633T503 634H480Q398 633 393 631Q388 629 386 623Q385 622 352 492L320 363H375Q378 363 398 363T426 364T448 367T472 374T489 386Q502 398 511 419T524 457T529 475Q532 480 548 480H560Q567 475 567 470Q567 467 536 339T502 207Q500 200 482 200H470Q463 206 463 212Q463 215 468 234T473 274Q473 303 453 310T364 317H309L277 190Q245 66 245 60Q245 46 334 46H359Q365 40 365 39T363 19Q359 6 353 0H336Q295 2 185 2Q120 2 86 2T48 1Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(749, 0)\">\n          <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(1138, 0)\">\n          <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(1710, 0)\">\n          <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(2376.8, 0)\">\n          <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n         </g>\n         <g data-mml-node=\"msub\" transform=\"translate(3432.6, 0)\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n           <path data-c=\"4D\" d=\"M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z\" />\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(4715.7, 0)\">\n          <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(5104.7, 0)\">\n          <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(5676.7, 0)\">\n          <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(6343.5, 0)\">\n          <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n         </g>\n         <g data-mml-node=\"munderover\" transform=\"translate(7399.3, 0)\">\n          <g data-mml-node=\"mo\" transform=\"translate(40.3, 0)\">\n           <path data-c=\"2211\" d=\"M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(0, -1087.9) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(878, 0)\">\n            <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n           </g>\n           <g data-mml-node=\"mn\" transform=\"translate(1656, 0)\">\n            <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n           </g>\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(390.7, 1150) scale(0.707)\">\n           <path data-c=\"4D\" d=\"M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z\" />\n          </g>\n         </g>\n         <g data-mml-node=\"msub\" transform=\"translate(9090.5, 0)\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n           <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(10251.3, 0)\">\n          <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(10640.3, 0)\">\n          <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(11212.3, 0)\">\n          <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(11879.1, 0)\">\n          <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n         </g>\n         <g data-mml-node=\"munderover\" transform=\"translate(12934.9, 0)\">\n          <g data-mml-node=\"mo\" transform=\"translate(40.3, 0)\">\n           <path data-c=\"2211\" d=\"M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(0, -1087.9) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(878, 0)\">\n            <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n           </g>\n           <g data-mml-node=\"mn\" transform=\"translate(1656, 0)\">\n            <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n           </g>\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(390.7, 1150) scale(0.707)\">\n           <path data-c=\"4D\" d=\"M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z\" />\n          </g>\n         </g>\n         <g data-mml-node=\"munderover\" transform=\"translate(14626.1, 0)\">\n          <g data-mml-node=\"mo\">\n           <path data-c=\"2211\" d=\"M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(124.5, -1087.9) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n           </g>\n           <g data-mml-node=\"mo\" transform=\"translate(412, 0)\">\n            <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n           </g>\n           <g data-mml-node=\"mn\" transform=\"translate(1190, 0)\">\n            <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n           </g>\n          </g>\n          <g data-mml-node=\"mi\" transform=\"translate(498.2, 1150) scale(0.707)\">\n           <path data-c=\"4A\" d=\"M447 625Q447 637 354 637H329Q323 642 323 645T325 664Q329 677 335 683H352Q393 681 498 681Q541 681 568 681T605 682T619 682Q633 682 633 672Q633 670 630 658Q626 642 623 640T604 637Q552 637 545 623Q541 610 483 376Q420 128 419 127Q397 64 333 21T195 -22Q137 -22 97 8T57 88Q57 130 80 152T132 174Q177 174 182 130Q182 98 164 80T123 56Q115 54 115 53T122 44Q148 15 197 15Q235 15 271 47T324 130Q328 142 387 380T447 625Z\" />\n          </g>\n         </g>\n         <g data-mml-node=\"msub\" transform=\"translate(16236.7, 0)\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"63\" d=\"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(433, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n            <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n           </g>\n          </g>\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(17631.9, 0)\">\n          <path data-c=\"49\" d=\"M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(18135.9, 0)\">\n          <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(18524.9, 0)\">\n          <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(19374.7, 0)\">\n          <path data-c=\"2208\" d=\"M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z\" />\n         </g>\n         <g data-mml-node=\"msub\" transform=\"translate(20319.4, 0)\">\n          <g data-mml-node=\"mi\">\n           <path data-c=\"52\" d=\"M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z\" />\n          </g>\n          <g data-mml-node=\"TeXAtom\" transform=\"translate(759, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n           <g data-mml-node=\"mi\">\n            <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n           </g>\n           <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n            <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n           </g>\n          </g>\n         </g>\n         <g data-mml-node=\"mo\" transform=\"translate(22040.6, 0)\">\n          <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n         </g>\n        </g>\n       </g>\n      </svg>\n     </section></span> \n   </section></li>\n </ol> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">上述的公式看起来有些复杂，其实就是我们借助<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"c_{mj}\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -442 1395.2 736.2\" aria-hidden=\"true\" style=\"vertical-align: -0.666ex; width: 3.156ex; height: 1.666ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"msub\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"63\" d=\"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z\" />\n        </g>\n        <g data-mml-node=\"TeXAtom\" transform=\"translate(433, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n         <g data-mml-node=\"mi\">\n          <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n         </g>\n         <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n          <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n         </g>\n        </g>\n       </g>\n      </g>\n     </g>\n    </svg></span></span>和I把回归树的情况表示了出来而已。因为我们训练模型最终希望得到的其实是模型的参数，对于回归树而言，它的参数表示比较复杂，所以看起来可能会有些迷惑。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">我们可以简单一点理解，GBDT就是利用的加法模型训练多棵回归树，预测的结果是这些回归树的和。而每一棵回归树的训练目标都是之前模型的残差。</p> \n <h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; padding: 0px; font-weight: bold; font-size: 22px; border-bottom: 2px solid rgb(89,89,89); margin-bottom: 30px; color: rgb(89,89,89);\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; display: inline-block; border-bottom: 2px solid rgb(89,89,89);\">Shrinkage</span><span class=\"suffix\"></span></h2> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">Shinkage是一种优化<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">避免GBDT陷入过拟合的方法</strong>，这个方法的本质是<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">减小每一次迭代对于残差的收敛程度</strong>，认为每一次逼近少一些多次收敛的效果好于一次逼近很多，逼近次数较少的结果。具体的表现措施就是给我们的每一棵回归树的结果<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">乘上一个类似于学习率的参数</strong>，通过增大回归树的个数来弥补。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">说白了就和梯度下降的时候我们乘上学习率是一样的，只不过在梯度下降的问题当中，我们明确知道不乘学习率的话会陷入震荡无法收敛的问题。而在GBDT当中，Shrinkage的机制并没有一个明确的证明或者是感性的认识，它的效果<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">更多是基于经验</strong>的。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">我们写一下加上Shrinkage之后的方程来做个对比：</p> \n <span class=\"span-block-equation\" style=\"cursor:pointer\" data-tool=\"mdnice编辑器\">\n  <section class=\"block-equation\" role=\"presentation\" data-formula=\"f_m(x) = f_{m-1}(x) + \\gamma \\sum_{j=1}^J c_{mj}I(x \\in R_{mj})\n\" data-formula-type=\"block-equation\" style=\"display: block; text-align: center; overflow: auto; display: block; -webkit-overflow-scrolling: touch; position: relative;\">\n   <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -1733 16994.6 3065.1\" aria-hidden=\"true\" style=\"-webkit-overflow-scrolling: touch; vertical-align: -3.014ex; width: 38.449ex; height: 6.935ex; max-width: 300% !important;\">\n    <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n     <g data-mml-node=\"math\">\n      <g data-mml-node=\"msub\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(490, -150) scale(0.707)\">\n        <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n       </g>\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(1160.8, 0)\">\n       <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n      </g>\n      <g data-mml-node=\"mi\" transform=\"translate(1549.8, 0)\">\n       <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(2121.8, 0)\">\n       <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(2788.6, 0)\">\n       <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n      </g>\n      <g data-mml-node=\"msub\" transform=\"translate(3844.4, 0)\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"66\" d=\"M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z\" />\n       </g>\n       <g data-mml-node=\"TeXAtom\" transform=\"translate(490, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n        </g>\n        <g data-mml-node=\"mo\" transform=\"translate(878, 0)\">\n         <path data-c=\"2212\" d=\"M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z\" />\n        </g>\n        <g data-mml-node=\"mn\" transform=\"translate(1656, 0)\">\n         <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n        </g>\n       </g>\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(5908.9, 0)\">\n       <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n      </g>\n      <g data-mml-node=\"mi\" transform=\"translate(6297.9, 0)\">\n       <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(6869.9, 0)\">\n       <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(7481.1, 0)\">\n       <path data-c=\"2B\" d=\"M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z\" />\n      </g>\n      <g data-mml-node=\"mi\" transform=\"translate(8481.4, 0)\">\n       <path data-c=\"3B3\" d=\"M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z\" />\n      </g>\n      <g data-mml-node=\"munderover\" transform=\"translate(9191, 0)\">\n       <g data-mml-node=\"mo\">\n        <path data-c=\"2211\" d=\"M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z\" />\n       </g>\n       <g data-mml-node=\"TeXAtom\" transform=\"translate(124.5, -1087.9) scale(0.707)\" data-mjx-texclass=\"ORD\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n        </g>\n        <g data-mml-node=\"mo\" transform=\"translate(412, 0)\">\n         <path data-c=\"3D\" d=\"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z\" />\n        </g>\n        <g data-mml-node=\"mn\" transform=\"translate(1190, 0)\">\n         <path data-c=\"31\" d=\"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z\" />\n        </g>\n       </g>\n       <g data-mml-node=\"mi\" transform=\"translate(498.2, 1150) scale(0.707)\">\n        <path data-c=\"4A\" d=\"M447 625Q447 637 354 637H329Q323 642 323 645T325 664Q329 677 335 683H352Q393 681 498 681Q541 681 568 681T605 682T619 682Q633 682 633 672Q633 670 630 658Q626 642 623 640T604 637Q552 637 545 623Q541 610 483 376Q420 128 419 127Q397 64 333 21T195 -22Q137 -22 97 8T57 88Q57 130 80 152T132 174Q177 174 182 130Q182 98 164 80T123 56Q115 54 115 53T122 44Q148 15 197 15Q235 15 271 47T324 130Q328 142 387 380T447 625Z\" />\n       </g>\n      </g>\n      <g data-mml-node=\"msub\" transform=\"translate(10801.7, 0)\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"63\" d=\"M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z\" />\n       </g>\n       <g data-mml-node=\"TeXAtom\" transform=\"translate(433, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n         <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n        </g>\n       </g>\n      </g>\n      <g data-mml-node=\"mi\" transform=\"translate(12196.9, 0)\">\n       <path data-c=\"49\" d=\"M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(12700.9, 0)\">\n       <path data-c=\"28\" d=\"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z\" />\n      </g>\n      <g data-mml-node=\"mi\" transform=\"translate(13089.9, 0)\">\n       <path data-c=\"78\" d=\"M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z\" />\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(13939.6, 0)\">\n       <path data-c=\"2208\" d=\"M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z\" />\n      </g>\n      <g data-mml-node=\"msub\" transform=\"translate(14884.4, 0)\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"52\" d=\"M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z\" />\n       </g>\n       <g data-mml-node=\"TeXAtom\" transform=\"translate(759, -150) scale(0.707)\" data-mjx-texclass=\"ORD\">\n        <g data-mml-node=\"mi\">\n         <path data-c=\"6D\" d=\"M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z\" />\n        </g>\n        <g data-mml-node=\"mi\" transform=\"translate(878, 0)\">\n         <path data-c=\"6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\" />\n        </g>\n       </g>\n      </g>\n      <g data-mml-node=\"mo\" transform=\"translate(16605.6, 0)\">\n       <path data-c=\"29\" d=\"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z\" />\n      </g>\n     </g>\n    </g>\n   </svg>\n  </section></span> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">这里的<span class=\"span-inline-equation\" style=\"cursor:pointer\"><span class=\"inline-equation\" role=\"presentation\" data-formula=\"\\gamma\" data-formula-type=\"inline-equation\" style=\"position: relative;\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" role=\"img\" focusable=\"false\" viewbox=\"0 -441 543 657\" aria-hidden=\"true\" style=\"vertical-align: -0.489ex; width: 1.229ex; height: 1.486ex;\">\n     <g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\">\n      <g data-mml-node=\"math\">\n       <g data-mml-node=\"mi\">\n        <path data-c=\"3B3\" d=\"M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z\" />\n       </g>\n      </g>\n     </g>\n    </svg></span></span>就是我们的Shrinkage的参数，<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">一般取值在0.001到0.01之间</strong>。</p> \n <h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; padding: 0px; font-weight: bold; font-size: 22px; border-bottom: 2px solid rgb(89,89,89); margin-bottom: 30px; color: rgb(89,89,89);\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; display: inline-block; border-bottom: 2px solid rgb(89,89,89);\">总结</span><span class=\"suffix\"></span></h2> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">到这里，关于GBDT模型的基本原理就算是介绍完了。如果你对于之前关于决策树的相关文章都认真阅读的话，相信理解GBDT对于你来说应该不是一件困难的事。如果你没有读过或者是错过了之前的文章的话，可以看一下文末的相关阅读的部分，回顾一下之前的内容。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">GBDT最大的创新就在于，将传统的调整参数来降低梯度的过程转化成了创建新的树模型来逼近，我第一次看到的时候深深为之惊艳。和传统的模型相比，由于GBDT是综合了多个分类器的结果，所以更加不容易陷入过拟合，并且对于一些复杂的场景的拟合效果会更好。今天我们介绍的只是最基本的回归问题当中的解法，在分类问题当中，公式会稍稍有些不同，这部分内容我们放在下篇文章当中。</p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">今天的文章到这里就结束了，如果喜欢本文的话，请来一波<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">素质三连</strong>，给我一点支持吧（<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">关注、转发、点赞</strong>）。</p> \n <h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; padding: 0px; font-weight: bold; font-size: 22px; border-bottom: 2px solid rgb(89,89,89); margin-bottom: 30px; color: rgb(89,89,89);\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; display: inline-block; border-bottom: 2px solid rgb(89,89,89);\">相关阅读</span><span class=\"suffix\"></span></h2> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\"><a href=\"https://mp.weixin.qq.com/s?__biz=MzUyMTM5OTM2NA==&amp;mid=2247485607&amp;idx=1&amp;sn=185f9f42219c3bec275b3e56fad1a448&amp;chksm=f9daf58ccead7c9a0e43bf08b829736c355bc70e4b1d2e59498561ca9465cdec583f206a3825&amp;scene=21#wechat_redirect\" style=\"text-decoration: none; word-wrap: break-word; font-weight: bold; color: rgb(71, 193, 168); border-bottom: 1px solid rgb(71, 193, 168);\">机器学习——十大数据挖掘之一的决策树CART算法</a></p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\"><a href=\"https://mp.weixin.qq.com/s?__biz=MzUyMTM5OTM2NA==&amp;mid=2247485951&amp;idx=1&amp;sn=c1f753894fadd267558f1f338726acb8&amp;chksm=f9daf4d4cead7dc21aada8e47f074d048082b87742eaab7c4b4ebab518e1bc12b03b30699f1b&amp;scene=21#wechat_redirect\" style=\"text-decoration: none; word-wrap: break-word; font-weight: bold; color: rgb(71, 193, 168); border-bottom: 1px solid rgb(71, 193, 168);\">机器学习——打开集成方法的大门，手把手带你实现AdaBoost模型</a></p> \n <p data-tool=\"mdnice编辑器\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\">GBDT开源代码： https://github.com/RRdmlearning/Machine-Learning-From-Scratch/tree/master/gradient_boosting_decision_tree</p> \n</section> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/ca07dd53-c253-425a-884f-4a73134966be.png\" alt=\"\" loading=\"lazy\"></p>', NULL, '2020-08-06 11:18:01', 0, NULL, NULL, 'https://www.cnblogs.com/techflow/p/13445042.html', 0, NULL);
INSERT INTO `t_blog` VALUES (270, 'Azure DevOps+Docker+Asp.NET Core 实现CI/CD(二.创建CI持续集成管道)', '<div style=\"text-align: center; background-color: #888888;\">\n <span style=\"font-size: 23.9999980926514px; line-height: 40px;\">前言</span>\n</div> \n<p>本文主要是讲解如何使用Azure DevOps+Docker 来实现持续集成Asp.NET Core项目(当然 也可以是任意项目).</p> \n<p>上一篇:</p> \n<h4 class=\"postTitle\"><a id=\"cb_post_title_url\" class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/GuZhenYin/p/13441395.html\">Azure DevOps+Docker+Asp.NET Core 实现CI/CD(一 .简介与创建自己的代理池)</a></h4> \n<p>觉得有帮助的朋友~可以左上角点个关注,右下角点个推荐</p> \n<p>今天我们废话不多说 直接开始正文</p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<div style=\"text-align: center; background-color: #888888;\">\n <span style=\"font-size: 23.9999980926514px; line-height: 40px;\">正文</span>\n</div> \n<p>&nbsp;</p> \n<p>昨天我们创建了自己的代理服务器<span style=\"color: #ff0000;\">(其实也可以用Azure提供的免费代理服务器,就是要排队,而且比较慢,限制比较多..)</span></p> \n<p>今天我们来讲讲如何创建自己的持续集成管道.</p> \n<h2>今天大致的流程图如下:</h2> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/5eef2ccf-2532-4fde-90ff-959666cd0d74.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<h2>&nbsp;</h2> \n<h2>1. 创建私有Docker Registry</h2> \n<p>首先我们需要到自己需要持续集成的服务器上 安装Docker Registry来获取我们的docker image</p> \n<p>安装Docker..我这就不说了.主要讲讲如何安装Docker Registry</p> \n<p>直接拉取registry镜像:</p> \n<div class=\"cnblogs_code\"> \n <pre>docker pull registry</pre> \n</div> \n<p>查看是否存在镜像:</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/2aa8641a-3a32-40ba-9724-0c3c5e76801c.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>拉取到镜像后,我们直接Run 命令:</p> \n<div class=\"cnblogs_code\"> \n <pre>docker run -itd -v /data/registry:/<span style=\"color: #0000ff;\">var</span>/lib/registry -p <span style=\"color: #800080;\">8082</span>:<span style=\"color: #800080;\">5000</span> --restart=always --name registry registry:latest</pre> \n</div> \n<p>这里的8082是你映射外网的端口.</p> \n<p>运行命令查看是否运行成功:</p> \n<div class=\"cnblogs_code\"> \n <pre>curl http:<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">127.0.0.1:8082/v2/_catalog</span></pre> \n</div> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/fd937a0e-ff6f-4feb-a0a7-09e6e62726c9.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>这里显示{}就表示运行成功了,我这个是因为有项目了...所以打码了..</p> \n<p><span style=\"color: #ff0000;\">(注意:正式环境的Docker Registry部署请设置用户密码,毕竟是对外的端口)</span></p> \n<p>&nbsp;</p> \n<h2>2. 创建Service connections(服务连接)</h2> \n<p>点击项目下的配置按钮:</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/57e9c0af-e3f5-41f3-99f6-887499ab5222.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>找到Service connections</p> \n<h2><img src=\"http://localhost:9090/blogImages/2020/08/06/99c3bbc1-c9dc-4e02-941d-57b255e3b35f.png\" alt=\"\" loading=\"lazy\"></h2> \n<p>创建一个新的连接, 这里我们选择上一步创建的Docker Registry</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/b0509725-1c89-40a2-b104-a6014d9c01c9.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;填写刚刚创建好的Docker Registry地址与密码.</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/29245de3-4eca-4723-8467-dd4ae92fabdf.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>这一步就算完成了,下一步我们将来使用它.</p> \n<h2>&nbsp;</h2> \n<h2>3. 创建持续集成管道</h2> \n<p>我们找到Pipelines菜单</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/61a36da3-c3a3-4160-8b4d-12b05f4b4f6f.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;点击创建新的管道</p> \n<p>&nbsp;</p> \n<p>&nbsp;<img src=\"http://localhost:9090/blogImages/2020/08/06/fb2b1b0c-27aa-4215-8bfa-e642b4c37117.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>选择自己的项目代码托管的地方,<strong>这里我们选择上篇文章代码提交的地方Azure Repos Git</strong></p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/52b6d5be-c1c9-4696-930a-1bc085a97d95.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>选中自己需要集成的项目:</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/19e395dc-4359-4b43-a81e-f1ff68cb31fa.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>配置管道,我们选择Docker</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/3cf2ae38-ce96-47de-bf4d-828966b6400e.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>选择项目中的dockerFile文件位置:</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/42339290-14f0-40dd-83af-d23b48e1aa47.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>我测试项目的DockerFile文件如下,大家可自行参考(纯空项目啥也没有):</p> \n<div class=\"cnblogs_code\"> \n <pre>FROM mcr.microsoft.com/dotnet/core/aspnet:<span style=\"color: #800080;\">3.1</span>-buster-slim AS <span style=\"color: #0000ff;\">base</span><span style=\"color: #000000;\">\nWORKDIR </span>/<span style=\"color: #000000;\">app\nEXPOSE </span><span style=\"color: #800080;\">80</span><span style=\"color: #000000;\">\nEXPOSE </span><span style=\"color: #800080;\">443</span><span style=\"color: #000000;\">\n\nFROM mcr.microsoft.com</span>/dotnet/core/sdk:<span style=\"color: #800080;\">3.1</span>-<span style=\"color: #000000;\">buster AS build\nRUN mkdir </span>-p /<span style=\"color: #000000;\">app\nWORKDIR </span>/<span style=\"color: #000000;\">src\nCOPY . .\nRUN dotnet restore </span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">WebApplication1.csproj</span><span style=\"color: #800000;\">\"</span><span style=\"color: #000000;\">\nRUN dotnet build </span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">WebApplication1.csproj</span><span style=\"color: #800000;\">\"</span> -c Release -o /<span style=\"color: #000000;\">app\n\nFROM build AS publish\nRUN dotnet publish </span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">WebApplication1.csproj</span><span style=\"color: #800000;\">\"</span> -c Release -o /<span style=\"color: #000000;\">app\n\nFROM </span><span style=\"color: #0000ff;\">base</span><span style=\"color: #000000;\"> AS final\nWORKDIR </span>/<span style=\"color: #000000;\">app\nCOPY </span>--<span style=\"color: #0000ff;\">from</span>=publish /<span style=\"color: #000000;\">app .\nENTRYPOINT [</span><span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">dotnet</span><span style=\"color: #800000;\">\"</span>, <span style=\"color: #800000;\">\"</span><span style=\"color: #800000;\">WebApplication1.dll</span><span style=\"color: #800000;\">\"</span>]</pre> \n</div> \n<p>&nbsp;</p> \n<p>&nbsp;编辑配置我们的Pipeline YAML(<span style=\"color: #ff0000;\">这里开始,很重要</span>):</p> \n<p>&nbsp;</p> \n<h3><span style=\"color: #ff0000;\"><strong>将默认的Pool名改为我们昨天自行创建配置的Pool</strong></span></h3> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/d981b144-6015-418b-9265-b32aeda59f98.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>修改为<img src=\"http://localhost:9090/blogImages/2020/08/06/15d13c75-f441-45dd-abfe-3e871dc7bd1e.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;创建持续集成的步骤Steps,<span style=\"color: #ff0000;\">点击右边的按钮可以打开图形化配置界面</span></p> \n<p>&nbsp;<img src=\"http://localhost:9090/blogImages/2020/08/06/8ca49ce4-5d13-4880-b9ec-2e608d1878fa.png\" alt=\"\" loading=\"lazy\"></p> \n<div class=\"ci-editor-action-buttons flex-self-end\"> \n <div class=\"bolt-button-group flex-row rhythm-horizontal-8\"> \n  <div class=\"bolt-split-button flex-stretch inline-flex-row\"> \n   <div class=\"bolt-split-button-divider flex-noshrink primary\">\n    &nbsp;这里我们添加三个步骤如下(\n    <span style=\"color: #ff0000;\">这是我自己的配置,各位请通过下面的图形化配置 添加自己的步骤</span>):\n   </div> \n   <div class=\"bolt-split-button-divider flex-noshrink primary\"> \n    <div class=\"cnblogs_code\"> \n     <pre><span style=\"color: #000000;\">    steps:\n\n      </span>- task: Docker@<span style=\"color: #800080;\">2</span><span style=\"color: #000000;\">\n        inputs:\n          containerRegistry: </span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">TestDocker</span><span style=\"color: #800000;\">\'</span><span style=\"color: #000000;\">\n          command: </span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">login</span><span style=\"color: #800000;\">\'</span>\n      - task: Docker@<span style=\"color: #800080;\">2</span><span style=\"color: #000000;\">\n        inputs:\n          containerRegistry: </span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">TestDocker</span><span style=\"color: #800000;\">\'</span><span style=\"color: #000000;\">\n          repository: </span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">$(Build.Repository.Name)</span><span style=\"color: #800000;\">\'</span><span style=\"color: #000000;\">\n          command: </span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">build</span><span style=\"color: #800000;\">\'</span><span style=\"color: #000000;\">\n          Dockerfile: </span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">$(Build.SourcesDirectory)/WebApplication1/WebApplication1/Dockerfile</span><span style=\"color: #800000;\">\'</span>\n      - task: Docker@<span style=\"color: #800080;\">2</span><span style=\"color: #000000;\">\n        inputs:\n          containerRegistry: </span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">TestDocker</span><span style=\"color: #800000;\">\'</span><span style=\"color: #000000;\">\n          repository: </span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">$(Build.Repository.Name)</span><span style=\"color: #800000;\">\'</span><span style=\"color: #000000;\">\n          command: </span><span style=\"color: #800000;\">\'</span><span style=\"color: #800000;\">push</span><span style=\"color: #800000;\">\'</span></pre> \n    </div> \n    <p>登陆,buid 最后Push我们的镜像.</p> \n    <p><img src=\"http://localhost:9090/blogImages/2020/08/06/41849997-cf40-4f66-90ee-84c9224051d4.png\" alt=\"\" loading=\"lazy\"></p> \n    <p>&nbsp;</p> \n    <p>&nbsp;<img src=\"http://localhost:9090/blogImages/2020/08/06/aafe04ea-d017-4b7d-8fbe-052b77c46e85.png\" alt=\"\" loading=\"lazy\"></p> \n    <p>&nbsp;</p> \n    <p>&nbsp;添加好步骤之后,我们直接保存我们的管道.</p> \n    <p>&nbsp;</p> \n    <h2>4. 提交代码查看是否持续集成</h2> \n    <p>我们修改一下首页的代码,并提交到Master主干:</p> \n    <p><img src=\"http://localhost:9090/blogImages/2020/08/06/3a42da43-eb62-4de9-ac47-83a25ed8645e.png\" alt=\"\" loading=\"lazy\"></p> \n    <p>&nbsp;</p> \n    <p>&nbsp;可以发现,我们的管道已经监控到了主干的变化,开始运行</p> \n    <p><img src=\"http://localhost:9090/blogImages/2020/08/06/8f4f6326-db73-4c3c-a4e8-9d3b0acd2949.png\" alt=\"\" loading=\"lazy\"></p> \n    <p>&nbsp;</p> \n    <p>&nbsp;</p> \n   </div> \n   <div class=\"inline-flex-row\">\n    &nbsp;\n    <img src=\"http://localhost:9090/blogImages/2020/08/06/2979dc96-9305-47d1-8a07-a799da625b36.png\" alt=\"\" loading=\"lazy\"> \n    <p>&nbsp;</p> \n    <p>&nbsp;可以看到,管道自动push了版本号为42的镜像.</p> \n    <p>我们上持续集成服务器看看,有没有.</p> \n    <p><img src=\"http://localhost:9090/blogImages/2020/08/06/4c970089-1a5e-4110-af0b-74215dab6d4b.png\" alt=\"\" loading=\"lazy\"></p> \n    <p>&nbsp;</p> \n    <h4>持续集成成功!</h4> \n    <h4>&nbsp;</h4> \n   </div> \n  </div> \n </div> \n</div> \n<div style=\"text-align: center; background-color: #888888;\">\n <span style=\"font-size: 23.9999980926514px; line-height: 40px;\">后记</span>\n</div> \n<p>我们下一篇来讲如何CD&nbsp;持续部署与持续交付.</p>', NULL, '2020-08-06 11:18:06', 0, NULL, NULL, 'https://www.cnblogs.com/GuZhenYin/p/13445009.html', 0, NULL);
INSERT INTO `t_blog` VALUES (271, '前端面试 vue 部分 (5)——VUE组件之间通信的方式有哪些', '<p><img src=\"http://localhost:9090/blogImages/2020/08/06/b37113ab-d75d-4064-a81e-979b50dbc9cb.jpeg\" alt=\"file\" loading=\"lazy\"></p> \n<h4 id=\"vue组件之间通信的方式有哪些（sss）\">VUE组件之间通信的方式有哪些（SSS）</h4> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/c106cc6c-5e4f-44bf-ae58-02754f9dbdf4.png\" alt=\"图片\" loading=\"lazy\"></p> \n<p>常见使用场景可以分为三类：</p> \n<ul> \n <li> <p>父子通信：</p> \n  <ul> \n   <li>null<br> 父向子传递数据是通过 <code>props</code> ，子向父是通过 <code>$emit / $on</code></li> \n   <li><code>$emit / $bus</code></li> \n   <li><code>Vuex</code></li> \n   <li>通过父链 / 子链也可以通信（ <code>$parent</code> / <code>$children</code> ）</li> \n   <li><code>ref</code> 也可以访问组件实例</li> \n  </ul> </li> \n <li> <p>兄弟通信：</p> \n  <ul> \n   <li><code>$emit / $bus</code></li> \n   <li><code>Vuex</code></li> \n  </ul> </li> \n <li> <p>跨级通信：</p> \n  <ul> \n   <li><code>$emit / $bus</code> ；</li> \n   <li><code>Vuex</code> ；</li> \n   <li><code>provide / inject API</code></li> \n   <li><code>$attrs/$listeners</code></li> \n  </ul> </li> \n</ul> \n<p><strong>$emit / $bus</strong></p> \n<pre><code class=\"language-plain\">// main.js \nVue.prototype.$bus = new Vue()&nbsp;// event Bus 用于无关系组件间的通信。 \n</code></pre> \n<p>A触发B</p> \n<pre><code class=\"language-plain\"> //  A \n this.$bus.$emit(\'new-messsage-at-me\', { \n    data: { conversationID: message.conversationID } \n  }) \n          \n</code></pre> \n<pre><code class=\"language-plain\">//  B \n  mounted() { \n    this.$bus.$on(\'new-messsage-at-me\', event =&gt; { \n      if ( \n        event.data.conversationID === this.conversation.conversationID &amp;&amp; \n        this.conversation.conversationID !== \n          this.currentConversation.conversationID \n      ) { \n        this.hasMessageAtMe = true \n      } \n    }) \n  }, \n</code></pre> \n<p><strong>父子组件通信</strong></p> \n<ol> \n <li><strong>父组件向子组件传值（</strong> <strong>props</strong> <strong>）：</strong></li> \n</ol> \n<pre><code class=\"language-javascript\">//App.vue父组件 \n&lt;template&gt; \n  &lt;div id=\"app\"&gt; \n    &lt;users v-bind:users=\"users\"&gt;&lt;/users&gt;//前者自定义名称便于子组件调用，后者要传递数据名 \n  &lt;/div&gt; \n&lt;/template&gt; \n&lt;script&gt; \nimport Users from \"./components/Users\" \nexport default { \n  name: \'App\', \n  data(){ \n    return{ \n      users:[\"Henry\",\"Bucky\",\"Emily\"] \n    } \n  }, \n  components:{ \n    \"users\":Users \n  } \n} \n</code></pre> \n<pre><code class=\"language-plain\">//users子组件  \n// 注：组件中的数据共有三种形式：data、props、computed \n&lt;template&gt; \n  &lt;div class=\"hello\"&gt; \n    &lt;ul&gt; \n      &lt;li v-for=\"user in users\"&gt;{{user}}&lt;/li&gt;//遍历传递过来的值，然后呈现到页面 \n    &lt;/ul&gt; \n  &lt;/div&gt; \n&lt;/template&gt; \n&lt;script&gt; \nexport default { \n  name: \'HelloWorld\', \n  props:{ \n    users:{           //这个就是父组件中子标签自定义名字 \n      type:Array, \n      required:true \n    } \n  } \n} \n&lt;/script&gt; \n</code></pre> \n<ol> \n <li><strong>子组件向父组件传值（B 组件中 $emit, A 组件中 v-on ）：</strong></li> \n</ol> \n<pre><code class=\"language-plain\">// 子组件 \n&lt;template&gt; \n  &lt;header&gt; \n    &lt;h1 @click=\"changeTitle\"&gt;{{title}}&lt;/h1&gt;//绑定一个点击事件 \n  &lt;/header&gt; \n&lt;/template&gt; \n&lt;script&gt; \nexport default { \n  name: \'app-header\', \n  data() { \n    return { \n      title:\"Vue.js Demo\" \n    } \n  }, \n  methods:{ \n    changeTitle() { \n      this.$emit(\"titleChanged\",\"子向父组件传值\");//自定义事件  传递值“子向父组件传值” \n    } \n  } \n} \n&lt;/script&gt; \n</code></pre> \n<pre><code class=\"language-plain\">// 父组件 \n&lt;template&gt; \n  &lt;div id=\"app\"&gt; \n    &lt;app-header v-on:titleChanged=\"updateTitle\" &gt;&lt;/app-header&gt;//与子组件titleChanged自定义事件保持一致 \n   // updateTitle($event)接受传递过来的文字 \n    &lt;h2&gt;{{title}}&lt;/h2&gt; \n  &lt;/div&gt; \n&lt;/template&gt; \n&lt;script&gt; \nimport Header from \"./components/Header\" \nexport default { \n  name: \'App\', \n  data(){ \n    return{ \n      title:\"传递的是一个值\" \n    } \n  }, \n  methods:{ \n    updateTitle(e){   //声明这个函数 \n      this.title = e; \n    } \n  }, \n  components:{ \n   \"app-header\":Header, \n  } \n} \n&lt;/script&gt; \n</code></pre> \n<p><strong>$ref 与 $parent $children</strong></p> \n<ul> \n <li>使用 this.$parent查找当前组件的父组件。</li> \n <li>使用 this.$children查找当前组件的直接子组件，可以遍历全部子组件， 需要注意 $children 并不保证顺序，也不是响应式的。</li> \n <li>使用 this.$root查找根组件，并可以配合$children遍历全部组件。</li> \n <li>使用 this.$refs查找命名子组件（ \n  <firstchild ref=\"one\"></firstchild> ）（ this.$refs.one ）</li> \n</ul> \n<p><strong>$attrs / $listeners</strong></p> \n<ul> \n <li>两者的出现使得组件之间跨组件的通信在不依赖 vuex 和事件总线的情况下变得简洁，业务清晰。</li> \n <li>A-&gt;B-&gt;C 多级组件嵌套需要传递数据时，通常使用的方法是通过vuex。如果仅仅是传递数据，而不做中间处理，使用 vuex 处理，未免有点杀鸡用牛刀。Vue 2.4 版本提供了另一种方法，使用 v-bind=”$attrs”, 将父组件中不被认为 props特性绑定的属性传入子组件中，通常配合 interitAttrs 选项一起使用。</li> \n <li>简单来说：$attrs&nbsp;与&nbsp;$listeners&nbsp;是两个「对象」，$attrs&nbsp;里存放的是父组件中绑定的非 Props 属性, 唯一缺点 没在props定义的属性 会显示在生成的html标签上, 解决办法:通过inheritAttrs:false,避免顶层容器继承属性; $listeners里存放的是父组件中绑定的非原生事件。</li> \n</ul> \n<p>A父组件</p> \n<pre><code class=\"language-plain\">&lt;template&gt; \n &lt;div&gt; \n   &lt;child-dom \n    :foo=\"foo\" \n    :coo=\"coo\" \n     v-on:upRocket=\"reciveRocket\" \n   &gt; \n   &lt;/child-dom&gt; \n &lt;/div&gt; \n&lt;/template&gt; \n&lt;script&gt; \n import childDom from \"@/components/ChildDom.vue\"; \n export default { \n   name:\'demoNo\', \n   data() { \n     return { \n       foo:\"Hello, world\", \n        coo:\"Hello,rui\" \n    } \n  }, \n components:{childDom}, \n methods:{ \n   reciveRocket(){ \n      console.log(\"reciveRocket success\") \n   } \n } \n} \n&lt;/script&gt; \n</code></pre> \n<p>B子组件</p> \n<pre><code class=\"language-plain\">&lt;template&gt; \n   &lt;div&gt; \n     &lt;p&gt;foo:{{foo}}&lt;/p&gt; \n     &lt;p&gt;attrs:{{$attrs}}&lt;/p&gt; \n     &lt;childDomChild v-bind=\"$attrs\" v-on=\"$listeners\"&gt;&lt;/childDomChild&gt; \n   &lt;/div&gt; \n&lt;/template&gt; \n&lt;script&gt; \nimport childDomChild from \'./childDomChild\'; \nexport default { \n   name:\'child-dom\' \n   props:[\"foo\"], \n   inheritAttrs:false, \n} \n&lt;/script&gt; \n</code></pre> \n<p>C子组件的子组件</p> \n<pre><code class=\"language-plain\">&lt;template&gt;  \n   &lt;div&gt; \n       &lt;p&gt;coo:{{coo}}&lt;/p&gt; \n       &lt;button @click=\"startUpRocket\"&gt;我要发射火箭&lt;/button&gt; \n   &lt;/div&gt; \n&lt;/template&gt; \n&lt;script&gt; \n export default { \n   name:\'childDomChild\', \n   props:[\'coo\'], \n   methods:{ \n     startUpRocket(){ \n       this.$emit(\"upRocket\"); \n       console.log(\"startUpRocket\") \n     } \n   } \n } \n&lt;/script&gt; \n</code></pre> \n<p><strong>provide / inject</strong></p> \n<ul> \n <li>适用于 隔代组件通信 祖先组件中通过 provider 来提供变量，然后在子孙组件中通过 inject 来注入变量。 provide / inject API 主要解决了跨级组件间的通信问题，不过它的使用场景，主要是子组件获取上级组件的状态，跨级组件间建立了一种主动提供与依赖注入的关系。</li> \n <li>如果是单一的只是拿数据使用，在父组件定义，则在所有子组件都能为之所用</li> \n <li>官网不建议在应用中直接使用该办法，理由很直接：他怕你\"管不好\"</li> \n</ul> \n<p>1.一般情况使用都是在app.vue配置为：</p> \n<pre><code class=\"language-plain\">provide () { \n  return { \n    isTest: this \n  } \n}, \n</code></pre> \n<p>2.所有子组件都可以引用 拿到app.vue里面的所有数据</p> \n<pre><code class=\"language-plain\"> inject: [\'isTest\'], \n</code></pre> \n<p>欢迎留言~~~</p>', NULL, '2020-08-06 11:18:11', 0, NULL, NULL, 'https://www.cnblogs.com/zhaoduoduo/p/13444879.html', 0, NULL);
INSERT INTO `t_blog` VALUES (272, 'canvas小画板——（2）荧光笔效果', '<p>我们在上一篇文章中讲了如何绘制平滑曲线&nbsp;<a id=\"cb_post_title_url\" class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/fangsmile/p/13427794.html\">canvas小画板——（1）平滑曲线</a>。</p> \n<h3>透明度实现荧光笔</h3> \n<p>现在我们需要加另外一种画笔效果，带透明度的荧光笔。那可能会觉得绘制画笔的时候加上透明度就可以了。我们来在原来代码上设置</p> \n<div>\n ctx.globalAlpha属性为0.3，或者将strokeStyle设置为rgba的形式如rgba(55,55,55,0.3)，代码如下：\n</div> \n<div class=\"cnblogs_code\" onclick=\"cnblogs_code_show(\'ddb3f55f-4558-4b2e-9c85-c6fa12ff50f7\')\">\n <img src=\"http://localhost:9090/blogImages/2020/08/06/ce9d6ee7-9f01-474b-86bb-491ae11ee58e.gif\" id=\"code_img_closed_ddb3f55f-4558-4b2e-9c85-c6fa12ff50f7\" class=\"code_img_closed\">\n <img src=\"http://localhost:9090/blogImages/2020/08/06/e74e187a-8f5f-4f48-8481-ddd0a1c80c1a.gif\" id=\"code_img_opened_ddb3f55f-4558-4b2e-9c85-c6fa12ff50f7\" class=\"code_img_opened\" style=\"display: none\"> \n <div id=\"cnblogs_code_open_ddb3f55f-4558-4b2e-9c85-c6fa12ff50f7\" class=\"cnblogs_code_hide\"> \n  <pre>&lt;!doctype html&gt;\n&lt;html&gt;\n\n&lt;head&gt;\n    &lt;meta charset=utf-8&gt;\n    &lt;style&gt;<span style=\"color: #000000;\">\n        canvas {\n            border: 1px solid #ccc\n        }\n\n        body {\n            margin: </span>0<span style=\"color: #000000;\">;\n        }\n    </span>&lt;/style&gt;\n&lt;/head&gt;\n\n&lt;body style=\"overflow: hidden;background-color: rgb(250, 250, 250);touch-action: none;\"&gt;\n    &lt;canvas id=\"c\" width=\"1920\" height=\"1080\"&gt;&lt;/canvas&gt;\n    &lt;script&gt;\n        <span style=\"color: #0000ff;\">var</span> el = document.getElementById(\'c\'<span style=\"color: #000000;\">);\n        </span><span style=\"color: #0000ff;\">var</span> ctx = el.getContext(\'2d\'<span style=\"color: #000000;\">);\n        </span><span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">设置绘制线条样式</span>\n        ctx.globalAlpha=0.3<span style=\"color: #000000;\">;\n        ctx.strokeStyle </span>= \'red\'<span style=\"color: #000000;\">;\n        ctx.lineWidth </span>= 10<span style=\"color: #000000;\">;\n        ctx.lineJoin </span>= \'round\'<span style=\"color: #000000;\">;\n        ctx.lineCap </span>= \'round\'<span style=\"color: #000000;\">;\n        </span><span style=\"color: #0000ff;\">var</span> isDrawing;<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">标记是否要绘制</span>\n        <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">存储坐标点</span>\n        let points =<span style=\"color: #000000;\"> [];\n        document.body.onpointerdown </span>= <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> (e) {\n            console.log(</span>\'pointerdown\'<span style=\"color: #000000;\">);\n            isDrawing </span>= <span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">;\n            points.push({ x: e.clientX, y: e.clientY });\n        };\n        document.body.onpointermove </span>= <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> (e) {\n            console.log(</span>\'pointermove\'<span style=\"color: #000000;\">);\n            </span><span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (isDrawing) {\n                draw(e.clientX, e.clientY);\n            }\n\n        };\n        document.body.onpointerup </span>= <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> (e) {\n            </span><span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (isDrawing) {\n                draw(e.clientX, e.clientY);\n            }\n            points </span>=<span style=\"color: #000000;\"> [];\n            isDrawing </span>= <span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">;\n        };\n\n        </span><span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> draw(mousex, mousey) {\n            points.push({ x: mousex, y: mousey });\n            ctx.beginPath();\n            let x </span>= (points[points.length - 2].x + points[points.length - 1].x) / 2<span style=\"color: #000000;\">,\n                y </span>= (points[points.length - 2].y + points[points.length - 1].y) / 2<span style=\"color: #000000;\">;\n            </span><span style=\"color: #0000ff;\">if</span> (points.length == 2<span style=\"color: #000000;\">) {\n                ctx.moveTo(points[points.length </span>- 2].x, points[points.length - 2<span style=\"color: #000000;\">].y);\n                ctx.lineTo(x, y);\n            } </span><span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n                let lastX </span>= (points[points.length - 3].x + points[points.length - 2].x) / 2<span style=\"color: #000000;\">,\n                    lastY </span>= (points[points.length - 3].y + points[points.length - 2].y) / 2<span style=\"color: #000000;\">;\n                ctx.moveTo(lastX, lastY);\n                ctx.quadraticCurveTo(points[points.length </span>- 2].x, points[points.length - 2<span style=\"color: #000000;\">].y, x, y);\n            }\n            ctx.stroke();\n            points.slice(</span>0, 1<span style=\"color: #000000;\">);\n\n        }\n    </span>&lt;/script&gt;\n&lt;/body&gt;\n\n&lt;/html&gt;</pre> \n </div> \n <span class=\"cnblogs_code_collapse\">View Code</span>\n</div> \n<p>我们鼠标画线出来的效果如下，可以看到有很多重叠区域：</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/02be614c-c9dd-4421-a5e0-25933abefb1e.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>对canvas有所了解的同学，知道</p> \n<div>\n lineJoin和 \n <div>\n  lineCap的话可能会尝试改变这两个属性，实现之后也有同样重叠的效果。\n </div> \n</div> \n<p>&nbsp;&nbsp;<img src=\"http://localhost:9090/blogImages/2020/08/06/904c0b0c-1751-4b04-9ac5-5823a7ca81e9.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;<img src=\"http://localhost:9090/blogImages/2020/08/06/a232ff59-ebbe-4242-8597-c6277d5305aa.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<h3>解决荧光笔重叠问题&nbsp;</h3> \n<p>为什么会有这种重叠渲染颜色的问题呢？细细品味代码，你会发现是因为每次move的时候绘制的部分是上个鼠标点和当前鼠标点之前的连线，这样就会导致头部和尾部有重叠部分多次被stroke了。（不同连接设置的头部尾部重叠不同）</p> \n<p>为了避免出现上述重叠这种问题下面介绍两种方法。</p> \n<h4>利用globalCompositeOperation</h4> \n<p>现在我们需要用上另外一个api方法</p> \n<div> \n <p>globalCompositeOperation，具体介绍可以看我另外一篇博文讲的比较详细（<a id=\"cb_post_title_url\" class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/fangsmile/p/10132920.html\">Canvas学习：globalCompositeOperation详解</a>）。这个小画板荧光笔效果我们需要使用globalCompositeOperation=‘xor’，另外注意透明度的设置不要使用context.globalAlpha，在设置strokeStyle的时候用rgba设置透明度颜色。这个设置也是我不断尝试得出来的，具体为什么可以我也无法给出说法，有待研究或者知道的博友可以在评论给出答案。</p> \n <div class=\"cnblogs_code\"> \n  <pre><span style=\"color: #008080;\"> 1</span> &lt;!doctype html&gt;\n<span style=\"color: #008080;\"> 2</span> &lt;html&gt;\n<span style=\"color: #008080;\"> 3</span> \n<span style=\"color: #008080;\"> 4</span> &lt;head&gt;\n<span style=\"color: #008080;\"> 5</span>     &lt;meta charset=utf-8&gt;\n<span style=\"color: #008080;\"> 6</span>     &lt;style&gt;\n<span style=\"color: #008080;\"> 7</span> <span style=\"color: #000000;\">        canvas {\n</span><span style=\"color: #008080;\"> 8</span> <span style=\"color: #000000;\">            border: 1px solid #ccc\n</span><span style=\"color: #008080;\"> 9</span> <span style=\"color: #000000;\">        }\n</span><span style=\"color: #008080;\">10</span> \n<span style=\"color: #008080;\">11</span> <span style=\"color: #000000;\">        body {\n</span><span style=\"color: #008080;\">12</span>             margin: 0<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">13</span> <span style=\"color: #000000;\">        }\n</span><span style=\"color: #008080;\">14</span>     &lt;/style&gt;\n<span style=\"color: #008080;\">15</span> &lt;/head&gt;\n<span style=\"color: #008080;\">16</span> \n<span style=\"color: #008080;\">17</span> &lt;body style=\"overflow: hidden;background-color: rgb(250, 250, 250);touch-action: none;\"&gt;\n<span style=\"color: #008080;\">18</span>     &lt;canvas id=\"c\" width=\"1920\" height=\"1080\"&gt;&lt;/canvas&gt;\n<span style=\"color: #008080;\">19</span>     &lt;script&gt;\n<span style=\"color: #008080;\">20</span>         <span style=\"color: #0000ff;\">var</span> el = document.getElementById(\'c\'<span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\">21</span>         <span style=\"color: #0000ff;\">var</span> ctx = el.getContext(\'2d\'<span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\">22</span>         <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">设置绘制线条样式</span>\n<span style=\"color: #008080;\">23</span>         ctx.strokeStyle = \'rgba(253, 58, 43, 0.5)\'<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">24</span>         ctx.lineWidth = 10<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">25</span>         ctx.lineJoin = \'round\'<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">26</span>         ctx.lineCap = \'round\'<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">27</span>         \n<span style=\"color: #008080;\">28</span>         <span style=\"color: #0000ff;\">var</span> isDrawing;<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">标记是否要绘制</span>\n<span style=\"color: #008080;\">29</span>         <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">存储坐标点</span>\n<span style=\"color: #008080;\">30</span>         let points =<span style=\"color: #000000;\"> [];\n</span><span style=\"color: #008080;\">31</span>         document.body.onpointerdown = <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> (e) {\n</span><span style=\"color: #008080;\">32</span>             console.log(\'pointerdown\'<span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\">33</span>             isDrawing = <span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">34</span> <span style=\"color: #000000;\">            points.push({ x: e.clientX, y: e.clientY });\n</span><span style=\"color: #008080;\">35</span> <span style=\"color: #000000;\">        };\n</span><span style=\"color: #008080;\">36</span>         document.body.onpointermove = <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> (e) {\n</span><span style=\"color: #008080;\">37</span>             console.log(\'pointermove\'<span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\">38</span>             <span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (isDrawing) {\n</span><span style=\"color: #008080;\">39</span> <span style=\"color: #000000;\">                draw(e.clientX, e.clientY);\n</span><span style=\"color: #008080;\">40</span> <span style=\"color: #000000;\">            }\n</span><span style=\"color: #008080;\">41</span> \n<span style=\"color: #008080;\">42</span> <span style=\"color: #000000;\">        };\n</span><span style=\"color: #008080;\">43</span>         document.body.onpointerup = <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> (e) {\n</span><span style=\"color: #008080;\">44</span>             <span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (isDrawing) {\n</span><span style=\"color: #008080;\">45</span> <span style=\"color: #000000;\">                draw(e.clientX, e.clientY);\n</span><span style=\"color: #008080;\">46</span> <span style=\"color: #000000;\">            }\n</span><span style=\"color: #008080;\">47</span>             points =<span style=\"color: #000000;\"> [];\n</span><span style=\"color: #008080;\">48</span>             isDrawing = <span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">49</span> <span style=\"color: #000000;\">        };\n</span><span style=\"color: #008080;\">50</span> \n<span style=\"color: #008080;\">51</span>         <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> draw(mousex, mousey) {\n</span><span style=\"color: #008080;\">52</span> <span style=\"color: #000000;\">            points.push({ x: mousex, y: mousey });\n</span><span style=\"color: #008080;\">53</span>             ctx.globalCompositeOperation = \"xor\";<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">使用异或操作对源图像与目标图像进行组合。</span>\n<span style=\"color: #008080;\">54</span> <span style=\"color: #000000;\">            ctx.beginPath();\n</span><span style=\"color: #008080;\">55</span>             let x = (points[points.length - 2].x + points[points.length - 1].x) / 2<span style=\"color: #000000;\">,\n</span><span style=\"color: #008080;\">56</span>                 y = (points[points.length - 2].y + points[points.length - 1].y) / 2<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">57</span>             <span style=\"color: #0000ff;\">if</span> (points.length == 2<span style=\"color: #000000;\">) {\n</span><span style=\"color: #008080;\">58</span>                 ctx.moveTo(points[points.length - 2].x, points[points.length - 2<span style=\"color: #000000;\">].y);\n</span><span style=\"color: #008080;\">59</span> <span style=\"color: #000000;\">                ctx.lineTo(x, y);\n</span><span style=\"color: #008080;\">60</span>             } <span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n</span><span style=\"color: #008080;\">61</span>                 let lastX = (points[points.length - 3].x + points[points.length - 2].x) / 2<span style=\"color: #000000;\">,\n</span><span style=\"color: #008080;\">62</span>                     lastY = (points[points.length - 3].y + points[points.length - 2].y) / 2<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">63</span> <span style=\"color: #000000;\">                ctx.moveTo(lastX, lastY);\n</span><span style=\"color: #008080;\">64</span>                 ctx.quadraticCurveTo(points[points.length - 2].x, points[points.length - 2<span style=\"color: #000000;\">].y, x, y);\n</span><span style=\"color: #008080;\">65</span> <span style=\"color: #000000;\">            }\n</span><span style=\"color: #008080;\">66</span> <span style=\"color: #000000;\">            ctx.stroke();\n</span><span style=\"color: #008080;\">67</span>             points.slice(0, 1<span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\">68</span> \n<span style=\"color: #008080;\">69</span> <span style=\"color: #000000;\">        }\n</span><span style=\"color: #008080;\">70</span>     &lt;/script&gt;\n<span style=\"color: #008080;\">71</span> &lt;/body&gt;\n<span style=\"color: #008080;\">72</span> \n<span style=\"color: #008080;\">73</span> &lt;/html&gt;</pre> \n </div> \n <h4>存储坐标点</h4> \n</div> \n<p>另有一种普遍做法是使用数组points存储每个点的坐标值，每次绘制前先清除画布内容，再循环points数组绘制路径，最后进行一次stroke。</p> \n<p>这种方法每次只能保留一条线条，因为在不断的清除画布内容，如果需要保留住的话，可以扩展下points为二维数组，保留每一条线条的所有鼠标点。清除画布后遍历points数组重绘所有线条。</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: #008080;\"> 1</span> &lt;!doctype html&gt;\n<span style=\"color: #008080;\"> 2</span> &lt;html&gt;\n<span style=\"color: #008080;\"> 3</span> \n<span style=\"color: #008080;\"> 4</span> &lt;head&gt;\n<span style=\"color: #008080;\"> 5</span>     &lt;meta charset=utf-8&gt;\n<span style=\"color: #008080;\"> 6</span>     &lt;style&gt;\n<span style=\"color: #008080;\"> 7</span> <span style=\"color: #000000;\">        canvas {\n</span><span style=\"color: #008080;\"> 8</span> <span style=\"color: #000000;\">            border: 1px solid #ccc\n</span><span style=\"color: #008080;\"> 9</span> <span style=\"color: #000000;\">        }\n</span><span style=\"color: #008080;\">10</span> \n<span style=\"color: #008080;\">11</span> <span style=\"color: #000000;\">        body {\n</span><span style=\"color: #008080;\">12</span>             margin: 0<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">13</span> <span style=\"color: #000000;\">        }\n</span><span style=\"color: #008080;\">14</span>     &lt;/style&gt;\n<span style=\"color: #008080;\">15</span> &lt;/head&gt;\n<span style=\"color: #008080;\">16</span> \n<span style=\"color: #008080;\">17</span> &lt;body style=\"overflow: hidden;background-color: rgb(250, 250, 250);touch-action: none;\"&gt;\n<span style=\"color: #008080;\">18</span>     &lt;canvas id=\"c\" width=\"1920\" height=\"1080\"&gt;&lt;/canvas&gt;\n<span style=\"color: #008080;\">19</span>     &lt;script&gt;\n<span style=\"color: #008080;\">20</span>         <span style=\"color: #0000ff;\">var</span> el = document.getElementById(\'c\'<span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\">21</span>         <span style=\"color: #0000ff;\">var</span> ctx = el.getContext(\'2d\'<span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\">22</span>         <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">设置绘制线条样式</span>\n<span style=\"color: #008080;\">23</span>         ctx.globalAlpha = 0.3<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">24</span>         ctx.strokeStyle = \'red\'<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">25</span>         ctx.lineWidth = 10<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">26</span>         ctx.lineJoin = \'round\'<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">27</span>         ctx.lineCap = \'round\'<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">28</span>         <span style=\"color: #0000ff;\">var</span> isDrawing;<span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">标记是否要绘制</span>\n<span style=\"color: #008080;\">29</span>         <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">存储坐标点</span>\n<span style=\"color: #008080;\">30</span>         let points =<span style=\"color: #000000;\"> [];\n</span><span style=\"color: #008080;\">31</span>         document.body.onpointerdown = <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> (e) {\n</span><span style=\"color: #008080;\">32</span>             console.log(\'pointerdown\'<span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\">33</span>             isDrawing = <span style=\"color: #0000ff;\">true</span><span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">34</span> <span style=\"color: #000000;\">            points.push({ x: e.clientX, y: e.clientY });\n</span><span style=\"color: #008080;\">35</span> <span style=\"color: #000000;\">        };\n</span><span style=\"color: #008080;\">36</span>         document.body.onpointermove = <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> (e) {\n</span><span style=\"color: #008080;\">37</span>             console.log(\'pointermove\'<span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\">38</span>             <span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (isDrawing) {\n</span><span style=\"color: #008080;\">39</span> <span style=\"color: #000000;\">                points.push({ x: e.clientX, y: e.clientY });\n</span><span style=\"color: #008080;\">40</span> <span style=\"color: #000000;\">                draw(e.clientX, e.clientY);\n</span><span style=\"color: #008080;\">41</span> <span style=\"color: #000000;\">            }\n</span><span style=\"color: #008080;\">42</span> \n<span style=\"color: #008080;\">43</span> <span style=\"color: #000000;\">        };\n</span><span style=\"color: #008080;\">44</span>         document.body.onpointerup = <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> (e) {\n</span><span style=\"color: #008080;\">45</span>             <span style=\"color: #0000ff;\">if</span><span style=\"color: #000000;\"> (isDrawing) {\n</span><span style=\"color: #008080;\">46</span> <span style=\"color: #000000;\">                points.push({ x: e.clientX, y: e.clientY });\n</span><span style=\"color: #008080;\">47</span> <span style=\"color: #000000;\">                draw(e.clientX, e.clientY);\n</span><span style=\"color: #008080;\">48</span> <span style=\"color: #000000;\">            }\n</span><span style=\"color: #008080;\">49</span>             points =<span style=\"color: #000000;\"> [];\n</span><span style=\"color: #008080;\">50</span>             isDrawing = <span style=\"color: #0000ff;\">false</span><span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">51</span> <span style=\"color: #000000;\">        };\n</span><span style=\"color: #008080;\">52</span> \n<span style=\"color: #008080;\">53</span>         <span style=\"color: #0000ff;\">function</span><span style=\"color: #000000;\"> draw(mousex, mousey) {\n</span><span style=\"color: #008080;\">54</span>             ctx.clearRect(0, 0, 1920, 1080<span style=\"color: #000000;\">);\n</span><span style=\"color: #008080;\">55</span> <span style=\"color: #000000;\">            ctx.beginPath();\n</span><span style=\"color: #008080;\">56</span>             <span style=\"color: #0000ff;\">for</span> (let i = 0; i &lt; points.length; i++<span style=\"color: #000000;\">) {\n</span><span style=\"color: #008080;\">57</span>                 <span style=\"color: #0000ff;\">if</span> (i == 0<span style=\"color: #000000;\">)\n</span><span style=\"color: #008080;\">58</span> <span style=\"color: #000000;\">                    ctx.moveTo(points[i].x, points[i].y);\n</span><span style=\"color: #008080;\">59</span>                 <span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n</span><span style=\"color: #008080;\">60</span>                     let p0 =<span style=\"color: #000000;\"> points[i];\n</span><span style=\"color: #008080;\">61</span>                     let p1 = points[i + 1<span style=\"color: #000000;\">];\n</span><span style=\"color: #008080;\">62</span> <span style=\"color: #000000;\">                    let c, d;\n</span><span style=\"color: #008080;\">63</span>                     <span style=\"color: #0000ff;\">if</span> (!<span style=\"color: #000000;\">p1) {\n</span><span style=\"color: #008080;\">64</span>                         c =<span style=\"color: #000000;\"> p0.x;\n</span><span style=\"color: #008080;\">65</span>                         d =<span style=\"color: #000000;\"> p0.y;\n</span><span style=\"color: #008080;\">66</span>                     }<span style=\"color: #0000ff;\">else</span><span style=\"color: #000000;\"> {\n</span><span style=\"color: #008080;\">67</span>                         c = (p0.x + p1.x) / 2<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">68</span>                         d = (p0.y + p1.y) / 2<span style=\"color: #000000;\">;\n</span><span style=\"color: #008080;\">69</span> <span style=\"color: #000000;\">                    }\n</span><span style=\"color: #008080;\">70</span>                     ctx.quadraticCurveTo(p0.x, p0.y, c, d); <span style=\"color: #008000;\">//</span><span style=\"color: #008000;\">二次贝塞曲线函数   </span>\n<span style=\"color: #008080;\">71</span> <span style=\"color: #000000;\">                }\n</span><span style=\"color: #008080;\">72</span> <span style=\"color: #000000;\">            }\n</span><span style=\"color: #008080;\">73</span> <span style=\"color: #000000;\">            ctx.stroke();\n</span><span style=\"color: #008080;\">74</span> <span style=\"color: #000000;\">        }\n</span><span style=\"color: #008080;\">75</span>     &lt;/script&gt;\n<span style=\"color: #008080;\">76</span> &lt;/body&gt;\n<span style=\"color: #008080;\">77</span> \n<span style=\"color: #008080;\">78</span> &lt;/html&gt;</pre> \n</div> \n<h4>两种解决方法对比&nbsp;</h4> \n<p>这两种方法都可以实现荧光笔的效果，如下截图：</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/5550fbb6-fad5-46cf-87bc-5dec1bc8db22.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>&nbsp;第一种方法只绘制上个点和当前点，而第二种需要绘制所有线条，所以从流畅性上对比第一种有优势。但如果需要实现橡皮擦的功能第一种就满足不了了，我的一篇博文中具体介绍了橡皮擦的实现可以参看</p> \n<p><a id=\"cb_post_title_url\" class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/fangsmile/p/7171789.html\">清除canvas画布内容--点擦除+线擦除</a></p>', NULL, '2020-08-06 11:18:16', 0, NULL, NULL, 'https://www.cnblogs.com/fangsmile/p/13441493.html', 0, NULL);
INSERT INTO `t_blog` VALUES (273, '《算法笔记》10. 并查集、图相关算法、看完这篇不能再说不会了。', '<p></p>\n<div class=\"toc\">\n <div class=\"toc-container-header\">\n  目录\n </div>\n <ul>\n  <li><a href=\"#1-并查集、图相关算法\">1 并查集、图相关算法</a>\n   <ul>\n    <li><a href=\"#11-并查集\">1.1 并查集</a>\n     <ul>\n      <li><a href=\"#111-并查集基本结构和操作\">1.1.1 并查集基本结构和操作</a></li>\n      <li><a href=\"#112-例题\">1.1.2 例题</a></li>\n     </ul></li>\n    <li><a href=\"#12-图相关算法\">1.2 图相关算法</a>\n     <ul>\n      <li><a href=\"#121-图的概念\">1.2.1 图的概念</a></li>\n      <li><a href=\"#122-图的表示方法\">1.2.2 图的表示方法</a>\n       <ul>\n        <li><a href=\"#1221-邻接表表示法\">1.2.2.1 邻接表表示法</a></li>\n        <li><a href=\"#1222-邻接矩阵表示法\">1.2.2.2 邻接矩阵表示法</a></li>\n       </ul></li>\n      <li><a href=\"#123-图的遍历\">1.2.3 图的遍历</a>\n       <ul>\n        <li><a href=\"#1231-宽度优先遍历\">1.2.3.1 宽度优先遍历</a></li>\n        <li><a href=\"#1232-深度优先遍历\">1.2.3.2 深度优先遍历</a></li>\n       </ul></li>\n      <li><a href=\"#124-图的拓扑排序\">1.2.4 图的拓扑排序</a></li>\n      <li><a href=\"#125-图的最小生成树算法\">1.2.5 图的最小生成树算法</a>\n       <ul>\n        <li><a href=\"#1251-kruskal（克鲁斯卡尔）算法\">1.2.5.1 Kruskal（克鲁斯卡尔）算法</a></li>\n        <li><a href=\"#1252-prim算法\">1.2.5.2 Prim算法</a></li>\n       </ul></li>\n      <li><a href=\"#126-图的最短路径算法\">1.2.6 图的最短路径算法</a>\n       <ul>\n        <li><a href=\"#1261-dijkstra迪杰特斯拉算法\">1.2.6.1 Dijkstra(迪杰特斯拉)算法</a></li>\n        <li><a href=\"#1262-floyd算法\">1.2.6.2 floyd算法</a></li>\n       </ul></li>\n     </ul></li>\n   </ul></li>\n </ul>\n</div>\n<p></p> \n<h1 id=\"1-并查集、图相关算法\">1 并查集、图相关算法</h1> \n<blockquote> \n <p>转载注明出处，源码地址： <a href=\"https://github.com/Dairongpeng/algorithm-note\">https://github.com/Dairongpeng/algorithm-note</a> ，欢迎star</p> \n</blockquote> \n<h2 id=\"11-并查集\">1.1 并查集</h2> \n<h3 id=\"111-并查集基本结构和操作\">1.1.1 并查集基本结构和操作</h3> \n<p>1、有若干个样本a、b、c、d...类型假设是V</p> \n<p>2、在并查集中一开始认为每个样本都在单独的集合里</p> \n<p>3、用户可以在任何时候调用如下两个方法：</p> \n<p>boolean isSameSet(V x, V y)：查询样本x和样本y是否属于一个集合</p> \n<p>void union(V x, V y)：把x和y各自所在集合的所有样本合并成一个集合</p> \n<p>4、isSameSet和union方法的代价越低越好，最好O(1)</p> \n<blockquote> \n <p>思路：isSameSet方法，我们设计为每个元素有一个指向自己的指针，成为代表点。判断两个元素是否在一个集合中，分别调用这两个元素的向上指针，两个元素最上方的指针如果内存地址相同，那么两个元素在一个集合中，反之不在</p> \n</blockquote> \n<blockquote> \n <p>思路：union方法，例如将a所在的集合和e所在的集合合并成一个大的集合union(a,e)。a的代表点指针是a，e的代表点指针是e，我们拿较小的集合挂在大的集合下面，比如e小，那么e放在a的下面。链接的方式为小集合e头结点本来指向自己的代表节点，现在要指向a节点</p> \n</blockquote> \n<blockquote> \n <p>并查集的优化点主要有两个，一个是合并的时候小的集合挂在大的集合下面，第二个优化是找某节点最上方的代表节点，把沿途节点全部拍平，下次再找该沿途节点，都变为O(1)。两种优化的目的都是为了更少的遍历节点。</p> \n</blockquote> \n<blockquote> \n <p>由于我们加入了优化，如果N个节点，我们调用findFather越频繁，我们的时间复杂度越低，因为第一次调用我们加入了优化。如果findFather调用接近N次或者远远超过N次，我们并查集的时间复杂度就是O(1)。该复杂度只需要记住结论，证明无须掌握。该证明从1964年一直研究到1989年，整整25年才得出证明！算法导论23章，英文版接近50页的证明。</p> \n</blockquote> \n<pre><code class=\"language-Java\">package class10;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Stack;\n\npublic class Code01_UnionFind {\n\n        // 并查集结构中的节点类型\n	public static class Node&lt;V&gt; {\n		V value;\n\n		public Node(V v) {\n			value = v;\n		}\n	}\n\n	public static class UnionSet&lt;V&gt; {\n	        // 记录样本到样本代表点的关系\n		public HashMap&lt;V, Node&lt;V&gt;&gt; nodes;\n		// 记录某节点到父亲节点的关系。\n		// 比如b指向a，c指向a，d指向a，a指向自身\n		// map中保存的a-&gt;a b-&gt;a c-&gt;a d-&gt;a\n		public HashMap&lt;Node&lt;V&gt;, Node&lt;V&gt;&gt; parents;\n		// 只有当前点，他是代表点，会在sizeMap中记录该代表点的连通个数\n		public HashMap&lt;Node&lt;V&gt;, Integer&gt; sizeMap;\n\n                // 初始化构造一批样本\n		public UnionSet(List&lt;V&gt; values) {\n		        // 每个样本的V指向自身的代表节点\n		        // 每个样本当前都是独立的，parent是自身\n		        // 每个样本都是代表节点放入sizeMap\n			for (V cur : values) {\n				Node&lt;V&gt; node = new Node&lt;&gt;(cur);\n				nodes.put(cur, node);\n				parents.put(node, node);\n				sizeMap.put(node, 1);\n			}\n		}\n\n		// 从点cur开始，一直往上找，找到不能再往上的代表点，返回\n		// 通过把路径上所有节点指向最上方的代表节点，目的是把findFather优化成O(1)的\n		public Node&lt;V&gt; findFather(Node&lt;V&gt; cur) {\n		        // 在找father的过程中，沿途所有节点加入当前容器，便于后面扁平化处理\n			Stack&lt;Node&lt;V&gt;&gt; path = new Stack&lt;&gt;();\n			// 当前节点的父亲不是指向自己，进行循环\n			while (cur != parents.get(cur)) {\n				path.push(cur);\n				cur = parents.get(cur);\n			}\n			// 循环结束，cur是最上的代表节点\n			// 把沿途所有节点拍平，都指向当前最上方的代表节点\n			while (!path.isEmpty()) {\n				parents.put(path.pop(), cur);\n			}\n			return cur;\n		}\n\n                // isSameSet方法\n		public boolean isSameSet(V a, V b) {\n		        // 先检查a和b有没有登记\n			if (!nodes.containsKey(a) || !nodes.containsKey(b)) {\n				return false;\n			}\n			// 比较a的最上的代表点和b最上的代表点\n			return findFather(nodes.get(a)) == findFather(nodes.get(b));\n		}\n\n                // union方法\n		public void union(V a, V b) {\n		        // 先检查a和b有没有都登记过\n			if (!nodes.containsKey(a) || !nodes.containsKey(b)) {\n				return;\n			}\n			\n			// 找到a的最上面的代表点\n			Node&lt;V&gt; aHead = findFather(nodes.get(a));\n			// 找到b的最上面的代表点\n			Node&lt;V&gt; bHead = findFather(nodes.get(b));\n			\n			// 只有两个最上代表点内存地址不相同，需要union\n			if (aHead != bHead) {\n			\n			        // 由于aHead和bHead都是代表点，那么在sizeMap里可以拿到大小\n				int aSetSize = sizeMap.get(aHead);\n				int bSetSize = sizeMap.get(bHead);\n				\n				// 哪个小，哪个挂在下面\n				Node&lt;V&gt; big = aSetSize &gt;= bSetSize ? aHead : bHead;\n				Node&lt;V&gt; small = big == aHead ? bHead : aHead;\n				// 把小集合直接挂到大集合的最上面的代表节点下面\n				parents.put(small, big);\n				// 大集合的代表节点的size要吸收掉小集合的size\n				sizeMap.put(big, aSetSize + bSetSize);\n				// 把小的记录删除\n				sizeMap.remove(small);\n			}\n		}\n	}\n\n}\n</code></pre> \n<p><mark>并查集用来处理连通性的问题特别方便</mark></p> \n<h3 id=\"112-例题\">1.1.2 例题</h3> \n<p>学生实例有三个属性，身份证信息，B站ID,Github的Id。我们认为，任何两个学生实例，只要身份证一样，或者B站ID一样，或者Github的Id一样，我们都算一个人。给定一大批学生实例，输出实质有几个人？</p> \n<blockquote> \n <p>思路：把实例的三个属性建立三张映射表，每个实例去对比，某个实例属性在表中能查的到，需要联通该实例到之前保存该实例属性的头结点下</p> \n</blockquote> \n<pre><code class=\"language-Java\">package class10;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Stack;\n\npublic class Code07_MergeUsers {\n\n	public static class Node&lt;V&gt; {\n		V value;\n\n		public Node(V v) {\n			value = v;\n		}\n	}\n\n	public static class UnionSet&lt;V&gt; {\n		public HashMap&lt;V, Node&lt;V&gt;&gt; nodes;\n		public HashMap&lt;Node&lt;V&gt;, Node&lt;V&gt;&gt; parents;\n		public HashMap&lt;Node&lt;V&gt;, Integer&gt; sizeMap;\n\n		public UnionSet(List&lt;V&gt; values) {\n			for (V cur : values) {\n				Node&lt;V&gt; node = new Node&lt;&gt;(cur);\n				nodes.put(cur, node);\n				parents.put(node, node);\n				sizeMap.put(node, 1);\n			}\n		}\n\n		// 从点cur开始，一直往上找，找到不能再往上的代表点，返回\n		public Node&lt;V&gt; findFather(Node&lt;V&gt; cur) {\n			Stack&lt;Node&lt;V&gt;&gt; path = new Stack&lt;&gt;();\n			while (cur != parents.get(cur)) {\n				path.push(cur);\n				cur = parents.get(cur);\n			}\n			// cur头节点\n			while (!path.isEmpty()) {\n				parents.put(path.pop(), cur);\n			}\n			return cur;\n		}\n\n		public boolean isSameSet(V a, V b) {\n			if (!nodes.containsKey(a) || !nodes.containsKey(b)) {\n				return false;\n			}\n			return findFather(nodes.get(a)) == findFather(nodes.get(b));\n		}\n\n		public void union(V a, V b) {\n			if (!nodes.containsKey(a) || !nodes.containsKey(b)) {\n				return;\n			}\n			Node&lt;V&gt; aHead = findFather(nodes.get(a));\n			Node&lt;V&gt; bHead = findFather(nodes.get(b));\n			if (aHead != bHead) {\n				int aSetSize = sizeMap.get(aHead);\n				int bSetSize = sizeMap.get(bHead);\n				Node&lt;V&gt; big = aSetSize &gt;= bSetSize ? aHead : bHead;\n				Node&lt;V&gt; small = big == aHead ? bHead : aHead;\n				parents.put(small, big);\n				sizeMap.put(big, aSetSize + bSetSize);\n				sizeMap.remove(small);\n			}\n		}\n		\n		\n		public int getSetNum() {\n			return sizeMap.size();\n		}\n		\n	}\n\n	public static class User {\n		public String a;\n		public String b;\n		public String c;\n\n		public User(String a, String b, String c) {\n			this.a = a;\n			this.b = b;\n			this.c = c;\n		}\n\n	}\n\n	// (1,10,13) (2,10,37) (400,500,37)\n	// 如果两个user，a字段一样、或者b字段一样、或者c字段一样，就认为是一个人\n	// 请合并users，返回合并之后的用户数量\n	public static int mergeUsers(List&lt;User&gt; users) {\n		UnionSet&lt;User&gt; unionFind = new UnionSet&lt;&gt;(users);\n		HashMap&lt;String, User&gt; mapA = new HashMap&lt;&gt;();\n		HashMap&lt;String, User&gt; mapB = new HashMap&lt;&gt;();\n		HashMap&lt;String, User&gt; mapC = new HashMap&lt;&gt;();\n		for(User user : users) {\n			if(mapA.containsKey(user.a)) {\n				unionFind.union(user, mapA.get(user.a));\n			}else {\n				mapA.put(user.a, user);\n			}\n			if(mapB.containsKey(user.b)) {\n				unionFind.union(user, mapB.get(user.b));\n			}else {\n				mapB.put(user.b, user);\n			}\n			if(mapC.containsKey(user.c)) {\n				unionFind.union(user, mapC.get(user.c));\n			}else {\n				mapC.put(user.c, user);\n			}\n		}\n		// 向并查集询问，合并之后，还有多少个集合？\n		return unionFind.getSetNum();\n	}\n\n}\n</code></pre> \n<h2 id=\"12-图相关算法\">1.2 图相关算法</h2> \n<h3 id=\"121-图的概念\">1.2.1 图的概念</h3> \n<p>1、由点的集合和边的集合构成</p> \n<p>2、虽然存在有向图和无向图的概念，但实际上都可以用有向图来表达，无向图可以理解为两个联通点互相指向</p> \n<p>3、边上可能带有权值</p> \n<h3 id=\"122-图的表示方法\">1.2.2 图的表示方法</h3> \n<p>对于下面一张无向图，可以改为有向图：</p> \n<pre><code>graph LR;\nA--&gt;C\nC--&gt;A\nC--&gt;B\nB--&gt;C\nB--&gt;D\nD--&gt;B\nD--&gt;A\nA--&gt;D\n</code></pre> \n<h4 id=\"1221-邻接表表示法\">1.2.2.1 邻接表表示法</h4> \n<p>记录某个节点，直接到达的邻居节点：</p> \n<p>A: C,D</p> \n<p>B: C,D</p> \n<p>C: A,B</p> \n<p>D: B,A</p> \n<p>如果是带有权重的边，可以封装我们的结构，例如A到C的权重是3,那么我们可以表示为A: C(3),D</p> \n<h4 id=\"1222-邻接矩阵表示法\">1.2.2.2 邻接矩阵表示法</h4> \n<p>我们把不存在路径的用正无穷表示，这里用\'-\'表示，例如A到C的边权重是3，可把上图表示为：</p> \n<pre><code>  A  B  C  D\nA 0  0  3  -\nB -  0  0  0\nC 3  0  0  -\nD 0  0  -  0\n</code></pre> \n<blockquote> \n <p>图算法并不难，难点在于图有很多种表示方式，表达一张图的篇幅比较大，coding容易出错。我们的套路就是熟悉一种结构，遇到不同的表达方式，尝试转化成为我们熟悉的结构，进行操作</p> \n</blockquote> \n<p>点结构的描述：</p> \n<pre><code class=\"language-Java\">package class10;\n\nimport java.util.ArrayList;\n\n// 点结构的描述  A  0\npublic class Node {\n        // 点的编号，标识\n	public int value;\n	// 入度，表示有多少个点连向该点\n	public int in;\n	// 出度，表示从该点出发连向别的节点多少\n	public int out;\n	// 直接邻居：表示由自己出发，直接指向哪些节点。nexts.size==out\n	public ArrayList&lt;Node&gt; nexts;\n	// 直接下级边：表示由自己出发的边有多少\n	public ArrayList&lt;Edge&gt; edges;\n\n	public Node(int value) {\n		this.value = value;\n		in = 0;\n		out = 0;\n		nexts = new ArrayList&lt;&gt;();\n		edges = new ArrayList&lt;&gt;();\n	}\n}\n\n</code></pre> \n<p>边结构的描述：</p> \n<pre><code class=\"language-Java\">package class10;\n\n// 由于任何图都可以理解为有向图，我们定义有向的边结构\npublic class Edge {\n        // 边的权重信息\n	public int weight;\n	// 出发的节点\n	public Node from;\n	// 指向的节点\n	public Node to;\n\n	public Edge(int weight, Node from, Node to) {\n		this.weight = weight;\n		this.from = from;\n		this.to = to;\n	}\n\n}\n\n</code></pre> \n<p>图结构的描述：</p> \n<pre><code class=\"language-Java\">package class10;\n\nimport java.util.HashMap;\nimport java.util.HashSet;\n\n// 图结构\npublic class Graph {\n        // 点的集合，编号为1的点是什么，用map\n	public HashMap&lt;Integer, Node&gt; nodes;\n	// 边的集合\n	public HashSet&lt;Edge&gt; edges;\n	\n	public Graph() {\n		nodes = new HashMap&lt;&gt;();\n		edges = new HashSet&lt;&gt;();\n	}\n}\n\n</code></pre> \n<p>任意图结构的描述，向我们上述的图结构转化：</p> \n<p>例如，我们有一种图的描述是，变的权重，从from节点指向to节点</p> \n<pre><code class=\"language-Java\">package class10;\n\npublic class GraphGenerator {\n\n	// matrix 所有的边\n	// N*3 的矩阵\n	// [weight, from节点上面的值，to节点上面的值]\n	public static Graph createGraph(Integer[][] matrix) {\n	        // 定义我们的图结构\n		Graph graph = new Graph();\n		// 遍历给定的图结构进行转换\n		for (int i = 0; i &lt; matrix.length; i++) { \n			// matrix[0][0], matrix[0][1]  matrix[0][2]\n			Integer weight = matrix[i][0];\n			Integer from = matrix[i][1];\n			Integer to = matrix[i][2];\n			\n			// 我们的图结构不包含当前from节点，新建该节点\n			if (!graph.nodes.containsKey(from)) {\n				graph.nodes.put(from, new Node(from));\n			}\n			// 没有to节点，建立该节点\n			if (!graph.nodes.containsKey(to)) {\n				graph.nodes.put(to, new Node(to));\n			}\n			// 拿出我们图结构的from节点\n			Node fromNode = graph.nodes.get(from);\n			// 拿出我们图结构的to节点\n			Node toNode = graph.nodes.get(to);\n			// 建立我们的边结构。权重，from指向to\n			Edge newEdge = new Edge(weight, fromNode, toNode);\n			// 把to节点加入到from节点的直接邻居中\n			fromNode.nexts.add(toNode);\n			// from的出度加1\n			fromNode.out++;\n			// to的入度加1\n			toNode.in++;\n			// 该边需要放到from的直接边的集合中\n			fromNode.edges.add(newEdge);\n			// 把该边加入到我们图结构的边集中\n			graph.edges.add(newEdge);\n		}\n		return graph;\n	}\n\n}\n</code></pre> \n<h3 id=\"123-图的遍历\">1.2.3 图的遍历</h3> \n<p>例如该图：</p> \n<pre><code>graph LR;\nA--&gt;B\nA--&gt;C\nA--&gt;D\nB--&gt;C\nB--&gt;E\nC--&gt;A\nC--&gt;B\nC--&gt;D\nC--&gt;E\n</code></pre> \n<h4 id=\"1231-宽度优先遍历\">1.2.3.1 宽度优先遍历</h4> \n<p>1、利用队列实现</p> \n<p>2、从源节点开始依次按照宽度进队列，然后弹出</p> \n<p>3、每弹出一个点，把该节点所有没有进过队列的邻接点放入队列</p> \n<p>4、直到队列变空</p> \n<blockquote> \n <p>宽度优先的思路：实质先遍历自己，再遍历自己的下一跳节点(同一层节点的顺序无需关心)，再到下跳节点......</p> \n</blockquote> \n<p>我们从A点开始遍历：</p> \n<p>1、A进队列--&gt; Q[A]；A进入Set--&gt; S[A]</p> \n<p>2、A出队：Q[],<strong>打印A</strong>；A直接邻居为BCD,都不在Set中，进入队列Q[D,C,B], 进入S[A,B,C,D]</p> \n<p>3、B出队：Q[D,C], B有CE三个邻居，C已经在Set中, 放入E, S[A,B,C,D,E]，队列放E, Q[E,D,C]</p> \n<p>4、 C出队，周而复始</p> \n<pre><code class=\"language-Java\">package class10;\n\nimport java.util.HashSet;\nimport java.util.LinkedList;\nimport java.util.Queue;\n\npublic class Code02_BFS {\n\n	// 从node出发，进行宽度优先遍历\n	public static void bfs(Node node) {\n		if (node == null) {\n			return;\n		}\n		Queue&lt;Node&gt; queue = new LinkedList&lt;&gt;();\n		// 图需要用set结构，因为图相比于二叉树有可能存在环\n		// 即有可能存在某个点多次进入队列的情况\n		HashSet&lt;Node&gt; set = new HashSet&lt;&gt;();\n		queue.add(node);\n		set.add(node);\n		while (!queue.isEmpty()) {\n			Node cur = queue.poll();\n			System.out.println(cur.value);\n			for (Node next : cur.nexts) {\n			    // 直接邻居，没有进入过Set的进入Set和队列\n			    // 用set限制队列的元素，防止有环队列一直会加入元素\n				if (!set.contains(next)) {\n					set.add(next);\n					queue.add(next);\n				}\n			}\n		}\n	}\n\n}\n</code></pre> \n<h4 id=\"1232-深度优先遍历\">1.2.3.2 深度优先遍历</h4> \n<p>1、利用栈实现</p> \n<p>2、从源节点开始把节点按照深度放入栈，然后弹出</p> \n<p>3、每弹出一个点，把该节点下一个没有进过栈的邻接点放入栈</p> \n<p>4、直到栈变空</p> \n<blockquote> \n <p>深度优先思路：表示从某个节点一直往下深入，直到没有路了，返回。我们的栈实质记录的是我们深度优先遍历的路径</p> \n</blockquote> \n<p>我们从A点开始遍历：</p> \n<p>1、A进栈，Stack[A] <strong>打印A</strong>。弹出A，当前弹出的节点A去枚举它的后代BCD，B没加入过栈中。压入A再压入B,Stack[B,A]。<strong>打印B</strong></p> \n<p>2、弹出B,B的直接后代邻居为CE,C在栈中而E不在栈中。重新压B,压E，Stack[E,B,A]。<strong>打印E</strong></p> \n<p>3、弹出E,E有邻居D,D不在栈中。压回E，再压D,此时Stack[D,E,B,A]。<strong>打印D</strong></p> \n<p>4、 弹出D,D的直接邻居是A,A已经在栈中了。说明A-B-E-D这条路径走到了尽头。弹出D之后，当前循环结束。继续while栈不为空，重复操作</p> \n<pre><code class=\"language-Java\">package class10;\n\nimport java.util.HashSet;\nimport java.util.Stack;\n\npublic class Code02_DFS {\n\n	public static void dfs(Node node) {\n		if (node == null) {\n			return;\n		}\n		Stack&lt;Node&gt; stack = new Stack&lt;&gt;();\n		// Set的作用和宽度优先遍历类似，保证重复的点不要进栈\n		HashSet&lt;Node&gt; set = new HashSet&lt;&gt;();\n		stack.add(node);\n		set.add(node);\n		// 打印实时机是在进栈的时候\n		// 同理该步可以换成其他处理逻辑，表示深度遍历处理某件事情\n		System.out.println(node.value);\n		while (!stack.isEmpty()) {\n			Node cur = stack.pop();\n			// 枚举当前弹出节点的后代\n			for (Node next : cur.nexts) {\n		                // 只要某个后代没进入过栈，进栈\n				if (!set.contains(next)) {\n				        // 把该节点的父亲节点重新压回栈中\n					stack.push(cur);\n					// 再把自己压入栈中\n					stack.push(next);\n					set.add(next);\n				    // 打印当前节点的值\n				    System.out.println(next.value);\n				        // 直接break，此时栈顶是当前next节点，达到深度优先的目的\n					break;\n				}\n			}\n		}\n	}\n\n}\n</code></pre> \n<h3 id=\"124-图的拓扑排序\">1.2.4 图的拓扑排序</h3> \n<p>1、在图中找到所有入度为0的点输出</p> \n<p>2、把所有入度为0的点在图中删掉，且消除这些点的影响边。继续找入度为0的点输出，删除，消边，周而复始</p> \n<p>3、图的所有点都被删除后，依次输出的顺序就是图的拓扑排序</p> \n<p><strong>要求：有向图且其中没有环</strong></p> \n<p><strong>应用：事件安排，编译顺序</strong></p> \n<blockquote> \n <p>在我们的项目中，项目之间互相依赖，就是拓扑排序的一个应用，从最底层依赖的包往上层编译，最终把总的项目编译通过。所以项目中循环依赖是编译不通过的</p> \n</blockquote> \n<p>例如下列的有向无环图：</p> \n<pre><code>graph LR;\nA--&gt;B\nB--&gt;C\nA--&gt;C\nC--&gt;E\nE--&gt;F\nC--&gt;T\nF--&gt;T\n</code></pre> \n<p>图中的字母代表事情，做事情的先后顺序就是按照有向图的描述，请安排事情的先后顺序（拓扑排序）。</p> \n<p>拓扑排序为：A B C E F T</p> \n<pre><code class=\"language-Java\">package class10;\n\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.LinkedList;\nimport java.util.List;\nimport java.util.Queue;\n\npublic class Code03_TopologySort {\n\n	// 有向无环图，返回拓扑排序的顺序list\n	public static List&lt;Node&gt; sortedTopology(Graph graph) {\n		// key：某一个node\n		// value：该节点剩余的入度\n		HashMap&lt;Node, Integer&gt; inMap = new HashMap&lt;&gt;();\n		// 剩余入度为0的点，才能进这个队列\n		Queue&lt;Node&gt; zeroInQueue = new LinkedList&lt;&gt;();\n		\n		// 拿到该图中所有的点集\n		for (Node node : graph.nodes.values()) {\n		        // 初始化每个点，每个点的入度是原始节点的入度信息\n		        // 加入inMap\n			inMap.put(node, node.in);\n			// 由于是有向无环图，则必定有入度为0的起始点。放入到zeroInQueue\n			if (node.in == 0) {\n				zeroInQueue.add(node);\n			}\n		}\n		\n		// 拓扑排序的结果，依次加入result\n		List&lt;Node&gt; result = new ArrayList&lt;&gt;();\n		\n		while (!zeroInQueue.isEmpty()) {\n		        // 该有向无环图初始入度为0的点，直接弹出放入结果集中\n			Node cur = zeroInQueue.poll();\n			result.add(cur);\n			// 该节点的下一层邻居节点，入度减一且加入到入度的map中\n			for (Node next : cur.nexts) {\n				inMap.put(next, inMap.get(next) - 1);\n				// 如果下一层存在入度变为0的节点，加入到0入度的队列中\n				if (inMap.get(next) == 0) {\n					zeroInQueue.add(next);\n				}\n			}\n		}\n		return result;\n	}\n}\n</code></pre> \n<h3 id=\"125-图的最小生成树算法\">1.2.5 图的最小生成树算法</h3> \n<blockquote> \n <p>最小生成树解释，就是在不破坏原有图点与点的连通性基础上，让连通的边的整体权值最小。返回最小权值或者边的集合</p> \n</blockquote> \n<h4 id=\"1251-kruskal（克鲁斯卡尔）算法\">1.2.5.1 Kruskal（克鲁斯卡尔）算法</h4> \n<blockquote> \n <p>连通性借助并查集实现</p> \n</blockquote> \n<p>1、总是从权值最小的边开始考虑，依次考察权值依次变大的边</p> \n<p>2、当前的边要么进入最小生成树的集合，要么丢弃</p> \n<p>3、如果当前的边进入最小生成树的集合中不会形成环，就要当前边</p> \n<p>4、如果当前的边进入最小生成树的集合中会形成环，就不要当前边</p> \n<p>5、考察完所有边之后，最小生成树的集合也就得到了</p> \n<pre><code class=\"language-Java\">package class10;\n\nimport java.util.Collection;\nimport java.util.Comparator;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.PriorityQueue;\nimport java.util.Set;\nimport java.util.Stack;\n\n//undirected graph only\npublic class Code04_Kruskal {\n\n	// Union-Find Set 我们的并查集结构\n	public static class UnionFind {\n		// key 某一个节点， value key节点往上的节点\n		private HashMap&lt;Node, Node&gt; fatherMap;\n		// key 某一个集合的代表节点, value key所在集合的节点个数\n		private HashMap&lt;Node, Integer&gt; sizeMap;\n\n		public UnionFind() {\n			fatherMap = new HashMap&lt;Node, Node&gt;();\n			sizeMap = new HashMap&lt;Node, Integer&gt;();\n		}\n		\n		public void makeSets(Collection&lt;Node&gt; nodes) {\n			fatherMap.clear();\n			sizeMap.clear();\n			for (Node node : nodes) {\n				fatherMap.put(node, node);\n				sizeMap.put(node, 1);\n			}\n		}\n\n		private Node findFather(Node n) {\n			Stack&lt;Node&gt; path = new Stack&lt;&gt;();\n			while(n != fatherMap.get(n)) {\n				path.add(n);\n				n = fatherMap.get(n);\n			}\n			while(!path.isEmpty()) {\n				fatherMap.put(path.pop(), n);\n			}\n			return n;\n		}\n\n		public boolean isSameSet(Node a, Node b) {\n			return findFather(a) == findFather(b);\n		}\n\n		public void union(Node a, Node b) {\n			if (a == null || b == null) {\n				return;\n			}\n			Node aDai = findFather(a);\n			Node bDai = findFather(b);\n			if (aDai != bDai) {\n				int aSetSize = sizeMap.get(aDai);\n				int bSetSize = sizeMap.get(bDai);\n				if (aSetSize &lt;= bSetSize) {\n					fatherMap.put(aDai, bDai);\n					sizeMap.put(bDai, aSetSize + bSetSize);\n					sizeMap.remove(aDai);\n				} else {\n					fatherMap.put(bDai, aDai);\n					sizeMap.put(aDai, aSetSize + bSetSize);\n					sizeMap.remove(bDai);\n				}\n			}\n		}\n	}\n	\n\n	public static class EdgeComparator implements Comparator&lt;Edge&gt; {\n\n		@Override\n		public int compare(Edge o1, Edge o2) {\n			return o1.weight - o2.weight;\n		}\n\n	}\n\n        // K算法\n	public static Set&lt;Edge&gt; kruskalMST(Graph graph) {\n	        // 先拿到并查集结构\n		UnionFind unionFind = new UnionFind();\n		// 该图的所有点加入到并查集结构\n		unionFind.makeSets(graph.nodes.values());\n		// 边按照权值从小到大排序，加入到堆\n		PriorityQueue&lt;Edge&gt; priorityQueue = new PriorityQueue&lt;&gt;(new EdgeComparator());\n		\n		for (Edge edge : graph.edges) { // M 条边\n			priorityQueue.add(edge);  // O(logM)\n		}\n		\n		Set&lt;Edge&gt; result = new HashSet&lt;&gt;();\n		// 堆不为空，弹出小根堆的堆顶\n		while (!priorityQueue.isEmpty()) { \n	    	        // 假设M条边，O(logM)\n			Edge edge = priorityQueue.poll(); \n			\n			// 如果该边的左右两侧不在同一个集合中\n			if (!unionFind.isSameSet(edge.from, edge.to)) { // O(1)\n			        // 要这条边\n				result.add(edge);\n				// 联合from和to\n				unionFind.union(edge.from, edge.to);\n			}\n		}\n		return result;\n	}\n}\n</code></pre> \n<blockquote> \n <p>K算法求无向图的最小生成树，求权值是没问题的，如果纠结最小生成树的连通结构，实质是少了一侧，即A指向B, B指向A只会保留其一。可以手动补齐</p> \n</blockquote> \n<h4 id=\"1252-prim算法\">1.2.5.2 Prim算法</h4> \n<blockquote> \n <p>P算法无需并查集结构，普通set即可满足</p> \n</blockquote> \n<p>1、任意指定一个出发点，比如A, A的直接边被解锁</p> \n<p>2、在A解锁的边里选择一个最小的边，该边两侧有没有新节点，如果有选择该边。没有就舍弃该边</p> \n<p>3、在被选择的新节点中再解锁该节点的直接边</p> \n<p>4、周而复始，直到所有点被解锁</p> \n<pre><code class=\"language-Java\">package class10;\n\nimport java.util.Comparator;\nimport java.util.HashSet;\nimport java.util.PriorityQueue;\nimport java.util.Set;\n\n// undirected graph only\npublic class Code05_Prim {\n\n	public static class EdgeComparator implements Comparator&lt;Edge&gt; {\n\n		@Override\n		public int compare(Edge o1, Edge o2) {\n			return o1.weight - o2.weight;\n		}\n\n	}\n\n	public static Set&lt;Edge&gt; primMST(Graph graph) {\n		// 解锁的边进入小根堆\n		PriorityQueue&lt;Edge&gt; priorityQueue = new PriorityQueue&lt;&gt;(new EdgeComparator());\n\n		// 哪些点被解锁出来了\n		HashSet&lt;Node&gt; nodeSet = new HashSet&lt;&gt;();\n		// 已经考虑过的边，不要重复考虑\n		Set&lt;Edge&gt; result = new HashSet&lt;&gt;();\n		// 依次挑选的的边在result里\n		Set&lt;Edge&gt; result = new HashSet&lt;&gt;(); \n		// 随便挑了一个点,进入循环处理完后直接break\n		for (Node node : graph.nodes.values()) { \n			// node 是开始点\n			if (!nodeSet.contains(node)) {\n			    // 开始节点保留\n				nodeSet.add(node);\n				// 开始节点的所有邻居节点全部放到小根堆\n				// 即由一个点，解锁所有相连的边\n				for (Edge edge : node.edges) {\n				    if (!edgeSet.contains(edge)) {\n				        edgeSet.add(edge);\n				        priorityQueue.add(edge);\n				    }\n				}\n				\n				while (!priorityQueue.isEmpty()) {\n				        // 弹出解锁的边中，最小的边\n					Edge edge = priorityQueue.poll(); \n					 // 可能的一个新的点,from已经被考虑了，只需要看to\n					Node toNode = edge.to;\n					// 不含有的时候，就是新的点\n					if (!nodeSet.contains(toNode)) { \n						nodeSet.add(toNode);\n						result.add(edge);\n						for (Edge nextEdge : toNode.edges) {\n						// 没加过的，放入小根堆\n					        if (!edgeSet.contains(edge)) {\n				                edgeSet.add(edge);\n				                priorityQueue.add(edge);\n				            }\n						}\n					}\n				}\n			}\n			// 直接break意味着我们不用考虑森林的情况\n			// 如果不加break我们可以兼容多个无向图的森林的生成树\n			// break;\n		}\n		return result;\n	}\n\n	// 请保证graph是连通图\n	// graph[i][j]表示点i到点j的距离，如果是系统最大值代表无路\n	// 返回值是最小连通图的路径之和\n	public static int prim(int[][] graph) {\n		int size = graph.length;\n		int[] distances = new int[size];\n		boolean[] visit = new boolean[size];\n		visit[0] = true;\n		for (int i = 0; i &lt; size; i++) {\n			distances[i] = graph[0][i];\n		}\n		int sum = 0;\n		for (int i = 1; i &lt; size; i++) {\n			int minPath = Integer.MAX_VALUE;\n			int minIndex = -1;\n			for (int j = 0; j &lt; size; j++) {\n				if (!visit[j] &amp;&amp; distances[j] &lt; minPath) {\n					minPath = distances[j];\n					minIndex = j;\n				}\n			}\n			if (minIndex == -1) {\n				return sum;\n			}\n			visit[minIndex] = true;\n			sum += minPath;\n			for (int j = 0; j &lt; size; j++) {\n				if (!visit[j] &amp;&amp; distances[j] &gt; graph[minIndex][j]) {\n					distances[j] = graph[minIndex][j];\n				}\n			}\n		}\n		return sum;\n	}\n\n	public static void main(String[] args) {\n		System.out.println(\"hello world!\");\n	}\n\n}\n</code></pre> \n<h3 id=\"126-图的最短路径算法\">1.2.6 图的最短路径算法</h3> \n<h4 id=\"1261-dijkstra迪杰特斯拉算法\">1.2.6.1 Dijkstra(迪杰特斯拉)算法</h4> \n<blockquote> \n <p>Dijkstra算法必须要求边的权值不为负，且必须指定出发点。则可以求出发点到所有节点的最短距离是多少。如果到达不了，为正无穷</p> \n</blockquote> \n<p>1、Dijkstra算法必须指定一个源点</p> \n<p>2、生成一个源点到各个点的最小距离表，一开始只有一条记录，即原点到自己的最小距离为0，源点到其他所有点的最小距离都为正无穷大</p> \n<p>3、从距离表中拿出没拿过记录里的最小记录，通过这个点出发的边，更新源点到各个点的最小距离表，不断重复这一步</p> \n<p>4、源点到所有的点记录如果都被拿过一遍，过程停止，最小距离表得到了</p> \n<pre><code class=\"language-Java\">package class10;\n\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.Map.Entry;\n\n// 没改进之前的版本\npublic class Code06_Dijkstra {\n\n        // 返回的map表就是从from到表中key的各个的最小距离\n        // 某个点不在map中记录，则from到该点位正无穷\n	public static HashMap&lt;Node, Integer&gt; dijkstra1(Node from) {\n		// 从from出发到所有点的最小距离表\n		HashMap&lt;Node, Integer&gt; distanceMap = new HashMap&lt;&gt;();\n		// from到from距离为0\n		distanceMap.put(from, 0);\n		// 已经求过距离的节点，存在selectedNodes中，以后再也不碰\n		HashSet&lt;Node&gt; selectedNodes = new HashSet&lt;&gt;();\n		// from 0 得到没选择过的点的最小距离\n		Node minNode = getMinDistanceAndUnselectedNode(distanceMap, selectedNodes);\n		\n		// 得到minNode之后\n		while (minNode != null) {\n		        // 把minNode对应的距离取出,此时minNode就是桥连点\n			int distance = distanceMap.get(minNode);\n			\n			// 把minNode上所有的邻边拿出来\n			// 这里就是要拿到例如A到C和A到桥连点B再到C哪个距离小的距离\n			for (Edge edge : minNode.edges) {\n			        // 某条边对应的下一跳节点toNode\n				Node toNode = edge.to;\n				\n				// 如果关于from的distencMap中没有去toNode的记录，表示正无穷，直接添加该条\n				if (!distanceMap.containsKey(toNode)) {\n				        // from到minNode的距离加上个minNode到当前to节点的边距离\n					distanceMap.put(toNode, distance + edge.weight);\n					\n				// 如果有，看该距离是否更小，更小就更新\n				} else {\n					distanceMap.put(edge.to, \n							Math.min(distanceMap.get(toNode), distance + edge.weight));\n				}\n			}\n			// 锁上minNode，表示from通过minNode到其他节点的最小值已经找到\n			// minNode将不再使用\n			selectedNodes.add(minNode);\n			// 再在没有选择的节点中挑选MinNode当成from的桥接点\n			minNode = getMinDistanceAndUnselectedNode(distanceMap, selectedNodes);\n		}\n		// 最终distanceMap全部更新，返回\n		return distanceMap;\n	}\n\n        // 得到没选择过的点的最小距离\n	public static Node getMinDistanceAndUnselectedNode(\n			HashMap&lt;Node, Integer&gt; distanceMap, \n			HashSet&lt;Node&gt; touchedNodes) {\n		Node minNode = null;\n		int minDistance = Integer.MAX_VALUE;\n		for (Entry&lt;Node, Integer&gt; entry : distanceMap.entrySet()) {\n			Node node = entry.getKey();\n			int distance = entry.getValue();\n			// 没有被选择过，且距离最小\n			if (!touchedNodes.contains(node) &amp;&amp; distance &lt; minDistance) {\n				minNode = node;\n				minDistance = distance;\n			}\n		}\n		return minNode;\n	}\n	\n	/**\n	* 我们可以借助小根堆来替代之前的distanceMap。达到优化算法的目的\n	* 原因是之前我们要遍历hash表选出最小距离，现在直接是堆顶元素\n	* 但是我们找到通过桥节点更小的距离后，需要临时更该堆结构中元素数据\n	* 所以系统提供的堆我们需要改写\n	**/\n\n	public static class NodeRecord {\n		public Node node;\n		public int distance;\n\n		public NodeRecord(Node node, int distance) {\n			this.node = node;\n			this.distance = distance;\n		}\n	}\n\n        // 自定义小根堆结构\n        // 需要提供add元素的方法，和update元素的方法\n        // 需要提供ignore方法，表示我们已经找到from到某节点的最短路径\n        // 再出现from到该节点的其他路径距离，我们直接忽略\n	public static class NodeHeap {\n		private Node[] nodes; // 实际的堆结构\n		// key 某一个node， value 上面堆中的位置\n		// 如果节点曾经进过堆，现在不在堆上，则node对应-1\n		// 用来找需要ignore的节点\n		private HashMap&lt;Node, Integer&gt; heapIndexMap;\n		// key 某一个节点， value 从源节点出发到该节点的目前最小距离\n		private HashMap&lt;Node, Integer&gt; distanceMap;\n		private int size; // 堆上有多少个点\n\n		public NodeHeap(int size) {\n			nodes = new Node[size];\n			heapIndexMap = new HashMap&lt;&gt;();\n			distanceMap = new HashMap&lt;&gt;();\n			size = 0;\n		}\n\n                // 该堆是否空\n		public boolean isEmpty() {\n			return size == 0;\n		}\n\n		// 有一个点叫node，现在发现了一个从源节点出发到达node的距离为distance\n		// 判断要不要更新，如果需要的话，就更新\n		public void addOrUpdateOrIgnore(Node node, int distance) {\n		        // 如果该节点在堆上，就看是否需要更新\n			if (inHeap(node)) {\n				distanceMap.put(node, Math.min(distanceMap.get(node), distance));\n				// 该节点进堆，判断是否需要调整\n				insertHeapify(node, heapIndexMap.get(node));\n			}\n			// 如果没有进入过堆。新建，进堆\n			if (!isEntered(node)) {\n				nodes[size] = node;\n				heapIndexMap.put(node, size);\n				distanceMap.put(node, distance);\n				insertHeapify(node, size++);\n			}\n			// 如果不在堆上，且进来过堆上，什么也不做，ignore\n		}\n\n                // 弹出from到堆顶节点的元素，获取到该元素的最小距离，再调整堆结构\n		public NodeRecord pop() {\n			NodeRecord nodeRecord = new NodeRecord(nodes[0], distanceMap.get(nodes[0]));\n			// 把最后一个元素放在堆顶，进行heapify\n			swap(0, size - 1);\n			heapIndexMap.put(nodes[size - 1], -1);\n			distanceMap.remove(nodes[size - 1]);\n			// free C++同学还要把原本堆顶节点析构，对java同学不必\n			nodes[size - 1] = null;\n			heapify(0, --size);\n			return nodeRecord;\n		}\n\n		private void insertHeapify(Node node, int index) {\n			while (distanceMap.get(nodes[index]) \n					&lt; distanceMap.get(nodes[(index - 1) / 2])) {\n				swap(index, (index - 1) / 2);\n				index = (index - 1) / 2;\n			}\n		}\n\n		private void heapify(int index, int size) {\n			int left = index * 2 + 1;\n			while (left &lt; size) {\n				int smallest = left + 1 &lt; size &amp;&amp; distanceMap.get(nodes[left + 1]) &lt; distanceMap.get(nodes[left])\n						? left + 1\n						: left;\n				smallest = distanceMap.get(nodes[smallest]) \n						&lt; distanceMap.get(nodes[index]) ? smallest : index;\n				if (smallest == index) {\n					break;\n				}\n				swap(smallest, index);\n				index = smallest;\n				left = index * 2 + 1;\n			}\n		}\n\n                // 判断node是否进来过堆\n		private boolean isEntered(Node node) {\n			return heapIndexMap.containsKey(node);\n		}\n\n                // 判断某个节点是否在堆上\n		private boolean inHeap(Node node) {\n			return isEntered(node) &amp;&amp; heapIndexMap.get(node) != -1;\n		}\n\n		private void swap(int index1, int index2) {\n			heapIndexMap.put(nodes[index1], index2);\n			heapIndexMap.put(nodes[index2], index1);\n			Node tmp = nodes[index1];\n			nodes[index1] = nodes[index2];\n			nodes[index2] = tmp;\n		}\n	}\n\n	// 使用自定义小根堆，改进后的dijkstra算法\n	// 从from出发，所有from能到达的节点，生成到达每个节点的最小路径记录并返回\n	public static HashMap&lt;Node, Integer&gt; dijkstra2(Node from, int size) {\n	        // 申请堆\n		NodeHeap nodeHeap = new NodeHeap(size);\n		// 在堆上添加from节点到from节点距离为0\n		nodeHeap.addOrUpdateOrIgnore(from, 0);\n		// 最终的结果集\n		HashMap&lt;Node, Integer&gt; result = new HashMap&lt;&gt;();\n		while (!nodeHeap.isEmpty()) {\n		        // 每次在小根堆弹出堆顶元素\n			NodeRecord record = nodeHeap.pop();\n			// 拿出的节点\n			Node cur = record.node;\n			// from到该节点的距离\n			int distance = record.distance;\n			// 以此为桥接点，找是否有更小的距离到该节点的其他to节点\n			// addOrUpdateOrIgnore该方法保证如果from到to的节点没有，就add\n			// 如果有,看是否需要Ignore，如果不需要Ignore且更小，就Update\n			for (Edge edge : cur.edges) {\n				nodeHeap.addOrUpdateOrIgnore(edge.to, edge.weight + distance);\n			}\n			result.put(cur, distance);\n		}\n		return result;\n	}\n\n}\n</code></pre> \n<h4 id=\"1262-floyd算法\">1.2.6.2 floyd算法</h4> \n<blockquote> \n <p>图节点的最短路径，处理权值可能为负的情况。三层for循环，比较简单暴力</p> \n</blockquote>', NULL, '2020-08-06 11:18:17', 0, NULL, NULL, 'https://www.cnblogs.com/darope/p/13444839.html', 0, NULL);
INSERT INTO `t_blog` VALUES (274, '算法学习笔记：连通图详解', '<h2 id=\"什么是连通图-？\">什么是连通图 ？</h2> \n<p>在图论中，连通图基于连通的概念。在一个无向图 G 中，若从顶点 <span class=\"math inline\">\\(i\\)</span> 到顶点 <span class=\"math inline\">\\(j\\)</span> 有路径相连（当然从 <span class=\"math inline\">\\(j\\)</span> 到 <span class=\"math inline\">\\(i\\)</span> 也一定有路径），则称 <span class=\"math inline\">\\(i\\)</span> 和 <span class=\"math inline\">\\(j\\)</span> 是连通的。如果 G 是有向图，那么连接 <span class=\"math inline\">\\(i\\)</span> 和j的路径中所有的边都必须同向。如果图中任意两点都是连通的，那么图被称作连通图。如果此图是有向图，则称为强连通图（注意：需要双向都有路径）。</p> \n<p>简单的来讲就是，</p> \n<p>强连通的定义是：有向图 G 强连通是指，G 中任意两个结点连通。</p> \n<p>强连通分量<code>（Strongly Connected Components，SCC）</code>的定义是：极大的强连通子图。</p> \n<p>这里将会介绍的是如何来求强连通分量的算法、割点和桥 以及双连通分量。</p> \n<h2 id=\"tarjan-算法发明人\">Tarjan 算法发明人</h2> \n<p><code>Robert E. Tarjan </code>(1948~) 美国人。</p> \n<p>你是不是感觉Robert E. Tarjan 这个名字很熟悉?</p> \n<p>没错，Robert E. Tarjan和John E. Hopcroft就是发明了深度优先搜索的两个人——1986年的图灵奖得主。</p> \n<p>除此之外 Tarjan 发明了很多算法结构。光 Tarjan 算法就有很多，比如求各种连通分量的 Tarjan 算法，求 LCA（Lowest Common Ancestor，最近公共祖先）的 Tarjan 算法。并查集、Splay、Toptree 也是 Tarjan 发明的。</p> \n<p>你看牛人们从来都不闲着的。他们到处交流，寻找合作伙伴，一起改变世界。</p> \n<p>我们这里要介绍的是他的在有向图中求强连通分量的 Tarjan 算法。</p> \n<p>另外，Tarjan 的名字 <code>j</code> 不发音，中文译为塔扬。</p> \n<h3 id=\"dfs-生成树\">DFS 生成树</h3> \n<p>在介绍该算法之前，先来了解 <strong>DFS 生成树</strong> ，我们以下面的有向图为例：</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/1f513eae-4afb-4b4c-9b9e-a6eec30c33bd.png\" alt=\"scc1.png\" loading=\"lazy\"></p> \n<p>有向图的 DFS 生成树主要有 4 种边（不一定全部出现）：</p> \n<ol> \n <li>树边（tree edge）：绿色边，每次搜索找到一个还没有访问过的结点的时候就形成了一条树边。</li> \n <li>反祖边（back edge）：黄色边，也被叫做回边，即指向祖先结点的边。</li> \n <li>横叉边（cross edge）：红色边，它主要是在搜索的时候遇到了一个已经访问过的结点，但是这个结点 <strong>并不是</strong> 当前结点的祖先时形成的。</li> \n <li>前向边（forward edge）：蓝色边，它是在搜索的时候遇到子树中的结点的时候形成的。</li> \n</ol> \n<p>我们考虑 DFS 生成树与强连通分量之间的关系。</p> \n<p>如果结点 <span class=\"math inline\">\\(u\\)</span> 是某个强连通分量在搜索树中遇到的第一个结点，那么这个强连通分量的其余结点肯定是在搜索树中以 <span class=\"math inline\">\\(u\\)</span> 为根的子树中。 <span class=\"math inline\">\\(u\\)</span> 被称为这个强连通分量的根。</p> \n<p>反证法：假设有个结点 <span class=\"math inline\">\\(v\\)</span> 在该强连通分量中但是不在以 <span class=\"math inline\">\\(u\\)</span> 为根的子树中，那么 <span class=\"math inline\">\\(u\\)</span> 到 <span class=\"math inline\">\\(v\\)</span> 的路径中肯定有一条离开子树的边。但是这样的边只可能是横叉边或者反祖边，然而这两条边都要求指向的结点已经被访问过了，这就和 <span class=\"math inline\">\\(u\\)</span> 是第一个访问的结点矛盾了。得证。</p> \n<h3 id=\"tarjan-算法求强连通分量\">Tarjan 算法求强连通分量</h3> \n<p>在 <code>Tarjan</code> 算法中为每个结点 <span class=\"math inline\">\\(u\\)</span> 维护了以下几个变量：</p> \n<ol> \n <li> <p><span class=\"math inline\">\\(dfn[u]\\)</span> ：深度优先搜索遍历时结点 <span class=\"math inline\">\\(u\\)</span> 被搜索的次序。</p> </li> \n <li> <p><span class=\"math inline\">\\(low[u]\\)</span> ：设以 <span class=\"math inline\">\\(u\\)</span> 为根的子树为 <span class=\"math inline\">\\(Subtree(u)\\)</span> 。 <span class=\"math inline\">\\(low[u]\\)</span> 定义为以下结点的 <span class=\"math inline\">\\(dfn\\)</span> 的最小值： <span class=\"math inline\">\\(Subtree(u)\\)</span> 中的结点；从 <span class=\"math inline\">\\(Subtree(u)\\)</span> 通过一条不在搜索树上的边能到达的结点。</p> \n  <blockquote> \n   <p>ps：每次找到一个新点，这个点<span class=\"math inline\">\\(low\\ ［］＝dfn\\ ［］\\)</span>。</p> \n  </blockquote> </li> \n</ol> \n<p>一个结点的子树内结点的 dfn 都大于该结点的 dfn。</p> \n<p>从根开始的一条路径上的 dfn 严格递增，low 严格非降。</p> \n<p>按照深度优先搜索算法搜索的次序对图中所有的结点进行搜索。在搜索过程中，对于结点 <span class=\"math inline\">\\(u\\)</span> 和与其相邻的结点 <span class=\"math inline\">\\(v\\)</span> （v 不是 u 的父节点）考虑 3 种情况：</p> \n<ol> \n <li><span class=\"math inline\">\\(v\\)</span> 未被访问：继续对 <span class=\"math inline\">\\(v\\)</span> 进行深度搜索。在回溯过程中，用 <span class=\"math inline\">\\(low[v]\\)</span> 更新 <span class=\"math inline\">\\(low[u]\\)</span> 。因为存在从 <span class=\"math inline\">\\(u\\)</span> 到 <span class=\"math inline\">\\(v\\)</span> 的直接路径，所以 <span class=\"math inline\">\\(v\\)</span> 能够回溯到的已经在栈中的结点， <span class=\"math inline\">\\(u\\)</span> 也一定能够回溯到。</li> \n <li><span class=\"math inline\">\\(v\\)</span> 被访问过，已经在栈中：即已经被访问过，根据 <span class=\"math inline\">\\(low\\)</span> 值的定义（能够回溯到的最早的已经在栈中的结点），则用 <span class=\"math inline\">\\(dfn[v]\\)</span> 更新 <span class=\"math inline\">\\(low[u]\\)</span> 。</li> \n <li><span class=\"math inline\">\\(v\\)</span> 被访问过，已不在在栈中：说明 <span class=\"math inline\">\\(v\\)</span> 已搜索完毕，其所在连通分量已被处理，所以不用对其做操作。</li> \n</ol> \n<p>将上述算法写成伪代码：</p> \n<pre><code class=\"language-cpp\">TARJAN_SEARCH(int u)\n    vis[u]=true\n    low[u]=dfn[u]=++dfncnt 		// 为节点u设定次序编号和Low初值\n    push u to the stack 		// 将节点u压入栈中\n    for each (u,v) then do 		// 枚举每一条边\n        if v hasn\'t been search then  // 如果节点v未被访问过\n            TARJAN_SEARCH(v) 	      // 继续向下搜索\n            low[u]=min(low[u],low[v]) // 回溯\n        else if v has been in the stack then // 如果节点u还在栈内\n            low[u]=min(low[u],dfn[v])\n    if (DFN[u] == Low[u]) // 如果节点u是强连通分量的根\n　　 repeat v = S.pop  	// 将v退栈，为该强连通分量中一个顶点\n　　 print v\n　　 until (u== v)\n</code></pre> \n<p>对于一个连通分量图，我们很容易想到，在该连通图中有且仅有一个 <span class=\"math inline\">\\(dfn[u]=low[u]\\)</span> 。该结点一定是在深度遍历的过程中，该连通分量中第一个被访问过的结点，因为它的 DFN 值和 LOW 值最小，不会被该连通分量中的其他结点所影响。</p> \n<p>因此，在回溯的过程中，判定 <span class=\"math inline\">\\(dfn[u]=low[u]\\)</span> 的条件是否成立，如果成立，则栈中从 <span class=\"math inline\">\\(u\\)</span> 后面的结点构成一个 SCC （强连通分量）。</p> \n<h3 id=\"实现\">实现</h3> \n<pre><code class=\"language-cpp\">int dfn[N], low[N], dfncnt, s[N], in_stack[N], tp;\nint scc[N], sc;  // 结点 i 所在 scc 的编号\nint sz[N];       // 强连通 i 的大小\nvoid tarjan(int u) {\n  low[u] = dfn[u] = ++dfncnt, s[++tp] = u, in_stack[u] = 1;\n  for (int i = h[u]; i; i = e[i].nex) {\n    const int &amp;v = e[i].t;\n    if (!dfn[v]) {\n      tarjan(v);\n      low[u] = min(low[u], low[v]);\n    } else if (in_stack[v]) {\n      low[u] = min(low[u], dfn[v]);\n    }\n  }\n  if (dfn[u] == low[u]) {\n    ++sc;\n    while (s[tp] != u) {\n      scc[s[tp]] = sc;\n      sz[sc]++;\n      in_stack[s[tp]] = 0;\n      --tp;\n    }\n    scc[s[tp]] = sc;\n    sz[sc]++;\n    in_stack[s[tp]] = 0;\n    --tp;\n  }\n}\n</code></pre> \n<p>时间复杂度 <span class=\"math inline\">\\(O(n + m)\\)</span> 。</p> \n<blockquote> \n <p><code>Tarjan 算法</code> 有许多用途，<strong>常用的例如求<a href=\"\">强连通分量</a>，缩点，还有求 2-SAT 的用途等。</strong></p> \n <p><strong>缩点：</strong></p> \n <p>缩点就是要将两两之间可以相互到达的点，缩成一个点来表示（即求无向图的连通分量，或者有向图的强连通分量），他们的求法都是相同的，都是将无向图转化为有向图。<br> 基本上都是以Trajan算法写题的。</p> \n</blockquote> \n<h2 id=\"kosaraju-算法\">Kosaraju 算法</h2> \n<p><code>Kosaraju</code> 算法依靠两次简单的 DFS 实现。</p> \n<p>第一次 DFS，选取任意顶点作为起点，遍历所有未访问过的顶点，并在回溯之前给顶点编号，也就是后序遍历。</p> \n<p>第二次 DFS，对于反向后的图，以标号最大的顶点作为起点开始 DFS。这样遍历到的顶点集合就是一个强连通分量。对于所有未访问过的结点，选取标号最大的，重复上述过程。</p> \n<p>两次 DFS 结束后，强连通分量就找出来了，Kosaraju 算法的时间复杂度为 <span class=\"math inline\">\\(O(n+m)\\)</span> 。</p> \n<h3 id=\"实现-2\">实现</h3> \n<pre><code class=\"language-cpp\">// g 是原图，g2 是反图\n\nvoid dfs1(int u) {\n  vis[u] = true;\n  for (int v : g[u])\n    if (!vis[v]) dfs1(v);\n  s.push_back(u);\n}\n\nvoid dfs2(int u) {\n  color[u] = sccCnt;\n  for (int v : g2[u])\n    if (!color[v]) dfs2(v);\n}\n\nvoid kosaraju() {\n  sccCnt = 0;\n  for (int i = 1; i &lt;= n; ++i)\n    if (!vis[i]) dfs1(i);\n  for (int i = n; i &gt;= 1; --i)\n    if (!color[s[i]]) {\n      ++sccCnt;\n      dfs2(s[i]);\n    }\n}\n</code></pre> \n<h2 id=\"garbow-算法\">Garbow 算法</h2> \n<p><span class=\"math inline\">\\(Tarjan\\)</span> 算法和 <span class=\"math inline\">\\(Garbow\\)</span> 算法是同一个思想的不同实现，但是 <span class=\"math inline\">\\(Garbow\\)</span> 算法更加精妙，时间更少，不用频繁更新 $ low $。</p> \n<h2 id=\"应用\">应用</h2> \n<p>我们可以将一张图的每个强连通分量都缩成一个点。</p> \n<p>然后这张图会变成一个 <code>DAG</code>（为什么？）。</p> \n<p>DAG 好啊，能拓扑排序了就能做很多事情了。</p> \n<p>举个简单的例子，求一条路径，可以经过重复结点，要求经过的不同结点数量最多。</p> \n<hr> \n<p>了解完强连通分量的几个算法以后来看看什么是 <strong>割点和桥</strong>。</p> \n<p>割点和桥更严谨的定义参见wiki上 <a href=\"https://zh.wikipedia.org/zh-hans/%E5%9B%BE%E8%AE%BA\">图论相关概念</a> 。</p> \n<h2 id=\"割点\">割点</h2> \n<blockquote> \n <p>对于一个无向图，如果把一个点删除后这个图的极大连通分量数增加了，那么这个点就是这个图的割点（又称割顶）。</p> \n</blockquote> \n<h3 id=\"如何实现？\">如何实现？</h3> \n<p>如果我们尝试删除每个点，并且判断这个图的连通性，那么复杂度会特别的高。所以要先序学会常用的算法：<a href=\"\">Tarjan</a> 。</p> \n<p>首先，我们上一个图：</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/09b59e16-39aa-4023-b303-ec7396b3b251.png\" alt=\"\" loading=\"lazy\"></p> \n<p>很容易的看出割点是 2，而且这个图仅有这一个割点。</p> \n<p>首先，我们按照 DFS 序给他打上时间戳（访问的顺序）。</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/b00b29f3-8367-482d-ba17-7658f9ff486d.png\" alt=\"\" loading=\"lazy\"></p> \n<p>这些信息被我们保存在一个叫做 <code>num</code> 的数组中。</p> \n<p>还需要另外一个数组 <code>low</code> ，用它来存储不经过其父亲能到达的最小的时间戳。</p> \n<p>例如 <code>low[2]</code> 的话是 1， <code>low[5]</code> 和 <code>low[6]</code> 是 3。</p> \n<p>然后我们开始 DFS，我们判断某个点是否是割点的根据是：对于某个顶点 <span class=\"math inline\">\\(u\\)</span> ，如果存在至少一个顶点 <span class=\"math inline\">\\(v\\)</span> （ <span class=\"math inline\">\\(u\\)</span> 的儿子），使得 <span class=\"math inline\">\\(low_v \\geq num_u\\)</span> ，即不能回到祖先，那么 <span class=\"math inline\">\\(u\\)</span> 点为割点。</p> \n<p>另外，如果搜到了自己（在环中），如果他有两个及以上的儿子，那么他一定是割点了，如果只有一个儿子，那么把它删掉，不会有任何的影响。比如下面这个图，此处形成了一个环，从树上来讲它有 2 个儿子：</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/a747ce0d-58a0-4d99-b360-eb0ca3de73da.png\" alt=\"\" loading=\"lazy\"></p> \n<p>我们在访问 1 的儿子时候，假设先 DFS 到了 2，然后标记用过，然后递归往下，来到了 4，4 又来到了 3，当递归回溯的时候，会发现 3 已经被访问过了，所以不是割点。</p> \n<p>更新 <code>low</code> 的伪代码如下：</p> \n<pre><code class=\"language-cpp\">如果 v 是 u 的儿子 low[u] = min(low[u], low[v]);\n否则\nlow[u] = min(low[u], num[v]);\n</code></pre> \n<h3 id=\"例题\">例题</h3> \n<p><a href=\"https://www.luogu.com.cn/problem/P3388\">洛谷 P3388【模板】割点（割顶）</a></p> \n<pre><code class=\"language-cpp\">#include &lt;bits/stdc++.h&gt;\nusing namespace std;\nint n, m;  // n：点数 m：边数\nint num[100001], low[100001], inde, res;\n// num：记录每个点的时间戳\n// low：能不经过父亲到达最小的编号，inde：时间戳，res：答案数量\nbool vis[100001], flag[100001];  // flag: 答案 vis：标记是否重复\nvector&lt;int&gt; edge[100001];        // 存图用的\nvoid Tarjan(int u, int father) {  // u 当前点的编号，father 自己爸爸的编号\n  vis[u] = true;                  // 标记\n  low[u] = num[u] = ++inde;  // 打上时间戳\n  int child = 0;             // 每一个点儿子数量\n  for (auto v : edge[u]) {   // 访问这个点的所有邻居 （C++11）\n\n    if (!vis[v]) {\n      child++;                       // 多了一个儿子\n      Tarjan(v, u);                  // 继续\n      low[u] = min(low[u], low[v]);  // 更新能到的最小节点编号\n      if (father != u &amp;&amp; low[v] &gt;= num[u] &amp;&amp;\n          !flag[u]) // 主要代码\n                    // 如果不是自己，且不通过父亲返回的最小点符合割点的要求，并且没有被标记过\n                    // 要求即为：删了父亲连不上去了，即为最多连到父亲\n      {\n        flag[u] = true;\n        res++;  // 记录答案\n      }\n    } else if (v != father)\n      low[u] = min(low[u], num[v]);  // 如果这个点不是自己，更新能到的最小节点编号\n  }\n  if (father == u &amp;&amp; child &gt;= 2 &amp;&amp; !flag[u]) {  // 主要代码，自己的话需要 2 个儿子才可以\n    flag[u] = true;\n    res++;  // 记录答案\n  }\n}\nint main() {\n  cin &gt;&gt; n &gt;&gt; m;                  // 读入数据\n  for (int i = 1; i &lt;= m; i++) {  // 注意点是从 1 开始的\n    int x, y;\n    cin &gt;&gt; x &gt;&gt; y;\n    edge[x].push_back(y);\n    edge[y].push_back(x);\n  }                             // 使用 vector 存图\n  for (int i = 1; i &lt;= n; i++)  // 因为 Tarjan 图不一定连通\n    if (!vis[i]) {\n      inde = 0;      // 时间戳初始为 0\n      Tarjan(i, i);  // 从第 i 个点开始，父亲为自己\n    }\n  cout &lt;&lt; res &lt;&lt; endl;\n  for (int i = 1; i &lt;= n; i++)\n    if (flag[i]) cout &lt;&lt; i &lt;&lt; \" \";  // 输出结果\n  return 0;\n}\n</code></pre> \n<h2 id=\"割边\">割边</h2> \n<p>和割点差不多，叫做桥。</p> \n<blockquote> \n <p>对于一个无向图，如果删掉一条边后图中的连通分量数增加了，则称这条边为桥或者割边。严谨来说，就是：假设有连通图 <span class=\"math inline\">\\(G=\\{V,E\\}\\)</span> ， <span class=\"math inline\">\\(e\\)</span> 是其中一条边（即 <span class=\"math inline\">\\(e \\in E\\)</span> ），如果 <span class=\"math inline\">\\(G-e\\)</span> 是不连通的，则边 <span class=\"math inline\">\\(e\\)</span> 是图 <span class=\"math inline\">\\(G\\)</span> 的一条割边（桥）。</p> \n</blockquote> \n<p>比如说，下图中，</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/49fdab41-d2b5-4fc7-8fe1-5d756eb5bb8d.png\" alt=\"割边示例图\" loading=\"lazy\"></p> \n<p>红色箭头指向的就是割边。</p> \n<h3 id=\"实现-3\">实现</h3> \n<p>和割点差不多，只要改一处： <span class=\"math inline\">\\(low_v&gt;num_u\\)</span> 就可以了，而且不需要考虑根节点的问题。</p> \n<p>割边是和是不是根节点没关系的，原来我们求割点的时候是指点 <span class=\"math inline\">\\(v\\)</span> 是不可能不经过父节点 <span class=\"math inline\">\\(u\\)</span> 为回到祖先节点（包括父节点），所以顶点 <span class=\"math inline\">\\(u\\)</span> 是割点。如果 <span class=\"math inline\">\\(low_v=num_u\\)</span> 表示还可以回到父节点，如果顶点 <span class=\"math inline\">\\(v\\)</span> 不能回到祖先也没有另外一条回到父亲的路，那么 <span class=\"math inline\">\\(u-v\\)</span> 这条边就是割边。</p> \n<h3 id=\"代码实现\">代码实现</h3> \n<p>下面代码实现了求割边，其中，当 <code>isbridge[x]</code> 为真时， <code>(father[x],x)</code> 为一条割边。</p> \n<pre><code class=\"language-cpp\">int low[MAXN], dfn[MAXN], iscut[MAXN], dfs_clock;\nbool isbridge[MAXN];\nvector&lt;int&gt; G[MAXN];\nint cnt_bridge;\nint father[MAXN];\n\nvoid tarjan(int u, int fa) {\n  father[u] = fa;\n  low[u] = dfn[u] = ++dfs_clock;\n  for (int i = 0; i &lt; G[u].size(); i++) {\n    int v = G[u][i];\n    if (!dfn[v]) {\n      tarjan(v, u);\n      low[u] = min(low[u], low[v]);\n      if (low[v] &gt; dfn[u]) {\n        isbridge[v] = true;\n        ++cnt_bridge;\n      }\n    } else if (dfn[v] &lt; dfn[u] &amp;&amp; v != fa) {\n      low[u] = min(low[u], dfn[v]);\n    }\n  }\n}\n</code></pre> \n<hr> \n<p>理解了基本的Tarjan算法、割点和桥的概念以后就可以开始处理双连通分量问题了。</p> \n<h2 id=\"双连通分量定义\">双连通分量定义</h2> \n<p>在一张连通的无向图中，对于两个点 <span class=\"math inline\">\\(u\\)</span> 和 <span class=\"math inline\">\\(v\\)</span> ，如果无论删去哪条边（只能删去一条）都不能使它们不连通，我们就说 <span class=\"math inline\">\\(u\\)</span> 和 <span class=\"math inline\">\\(v\\)</span> <strong>边双连通</strong> 。</p> \n<p>在一张连通的无向图中，对于两个点 <span class=\"math inline\">\\(u\\)</span> 和 <span class=\"math inline\">\\(v\\)</span> ，如果无论删去哪个点（只能删去一个，且不能删 <span class=\"math inline\">\\(u\\)</span> 和 <span class=\"math inline\">\\(v\\)</span> 自己）都不能使它们不连通，我们就说 <span class=\"math inline\">\\(u\\)</span> 和 <span class=\"math inline\">\\(v\\)</span> <strong>点双连通</strong> 。</p> \n<p>边双连通具有传递性，即，若 <span class=\"math inline\">\\(x,y\\)</span> 边双连通， <span class=\"math inline\">\\(y,z\\)</span> 边双连通，则 <span class=\"math inline\">\\(x,z\\)</span> 边双连通。</p> \n<p>点双连通 <strong>不</strong> 具有传递性，反例如下图， <span class=\"math inline\">\\(A,B\\)</span> 点双连通， <span class=\"math inline\">\\(B,C\\)</span> 点双连通，而 <span class=\"math inline\">\\(A,C\\)</span> <strong>不</strong> 点双连通。</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/de630702-9d7b-45fe-8a62-95c97f80cd46.svg+xml\" alt=\"bcc-counterexample.png\" loading=\"lazy\"></p> \n<h2 id=\"dfs\">DFS</h2> \n<p>对于一张连通的无向图，我们可以从任意一点开始 DFS，得到原图的一棵生成树（以开始 DFS 的那个点为根），这棵生成树上的边称作 <strong>树边</strong> ，不在生成树上的边称作 <strong>非树边</strong> 。</p> \n<p>由于 DFS 的性质，我们可以保证所有非树边连接的两个点在生成树上都满足其中一个是另一个的祖先。</p> \n<p>DFS 的代码如下：</p> \n<pre><code class=\"language-cpp\">void DFS(int p) {\n  visited[p] = true;\n  for (int to : edge[p])\n    if (!visited[to]) DFS(to);\n}\n</code></pre> \n<h2 id=\"dfs-找桥并判断边双连通\">DFS 找桥并判断边双连通</h2> \n<p>首先，对原图进行 DFS。</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/5c58c7af-6e4a-4585-ace3-51a6e1e382cf.svg+xml\" alt=\"bcc-1.png\" loading=\"lazy\"></p> \n<p>如上图所示，黑色与绿色边为树边，红色边为非树边。每一条非树边连接的两个点都对应了树上的一条简单路径，我们说这条非树边 <strong>覆盖</strong> 了这条树上路径上所有的边。绿色的树边 <strong>至少</strong> 被一条非树边覆盖，黑色的树边不被 <strong>任何</strong> 非树边覆盖。</p> \n<p>我们如何判断一条边是不是桥呢？显然，非树边和绿色的树边一定不是桥，黑色的树边一定是桥。</p> \n<p>如何用算法去实现以上过程呢？首先有一个比较暴力的做法，对于每一条非树边，都逐个地将它覆盖的每一条树边置成绿色，这样的时间复杂度为 <span class=\"math inline\">\\(O(nm)\\)</span> 。</p> \n<p>怎么优化呢？可以用差分。对于每一条非树边，在其树上深度较小的点处打上 <code>-1</code> 标记，在其树上深度较大的点处打上 <code>+1</code> 标记。然后 <span class=\"math inline\">\\(O(n)\\)</span> 求出每个点的子树内部的标记之和。对于一个点 <span class=\"math inline\">\\(u\\)</span> ，其子树内部的标记之和等于覆盖了 <span class=\"math inline\">\\(u\\)</span> 和 <span class=\"math inline\">\\(u\\)</span> 的父亲之间的树边的非树边数量。若这个值非 <span class=\"math inline\">\\(0\\)</span> ，则 <span class=\"math inline\">\\(u\\)</span> 和 <span class=\"math inline\">\\(u\\)</span> 的父亲之间的树边不是桥，否则是桥。</p> \n<p>用以上的方法 <span class=\"math inline\">\\(O(n+m)\\)</span> 求出每条边分别是否是桥后，两个点是边双连通的，当且仅当它们的树上路径中 <strong>不</strong> 包含桥。</p> \n<h2 id=\"dfs-找割点并判断点双连通\">DFS 找割点并判断点双连通</h2> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/745e7b9f-c635-46d5-9ea9-c40088fc4288.svg+xml\" alt=\"bcc-2.png\" loading=\"lazy\"></p> \n<p>如上图所示，黑色边为树边，红色边为非树边。每一条非树边连接的两个点都对应了树上的一条简单路径。</p> \n<p>考虑一张新图，新图中的每一个点对应原图中的每一条树边（在上图中用蓝色点表示）。对于原图中的每一条非树边，将这条非树边对应的树上简单路径中的所有边在新图中对应的蓝点连成一个连通块（这在上图中也用蓝色的边体现出来了）。</p> \n<p>这样，一个点不是桥，当且仅当与其相连的所有边在新图中对应的蓝点都属于同一个连通块。两个点点双连通，当且仅当它们在原图的树上路径中的所有边在新图中对应的蓝点都属于同一个连通块。</p> \n<p>蓝点间的连通关系可以用与求边双连通时用到的差分类似的方法维护，时间复杂度 <span class=\"math inline\">\\(O(n+m)\\)</span> 。</p> \n<h2 id=\"reference\">Reference</h2> \n<p>清晰的图示：<a href=\"https://www.byvoid.com/zhs/blog/scc-tarjan\">https://www.byvoid.com/zhs/blog/scc-tarjan</a>,</p> \n<p>可视化过程（英文讲解）：<a href=\"https://www.youtube.com/watch?v=TyWtx7q2D7Y\">https://www.youtube.com/watch?v=TyWtx7q2D7Y</a></p> \n<p><code>Garbow</code>算法：<a href=\"https://blog.csdn.net/zhouzi2018/article/details/81623747\">https://blog.csdn.net/zhouzi2018/article/details/81623747</a></p> \n<h2 id=\"其它\">其它</h2> \n<p>文章开源在 <a href=\"https://github.com/RivTian/blog-articles\">Github - blog-articles</a>，点击 Watch 即可订阅本博客。 若文章有错误，请在 <a href=\"https://github.com/RivTian/blog-articles/issues\">Issues</a> 中提出，我会及时回复，谢谢。</p> \n<p>如果您觉得文章不错，或者在生活和工作中帮助到了您，不妨给个 Star，谢谢。</p> \n<p>(文章完)</p>', '什么是连通图 ？ \n在图论中，连通图基于连通的概念。在一个无向图 G 中，若从顶点 \\(i\\) 到顶点 \\(j\\) 有路径相连（当然从 \\(j\\) 到 \\(i\\) 也一定有路径），则称 \\(i\\) 和 \\(j\\) 是连通的。如果 G 是有向图，那么连接 \\(i\\) 和j的路径中所有的边都必须同向。如果图中任意', '2020-08-06 11:18:19', 1, 7, '算法', 'https://www.cnblogs.com/RioTian/p/13444771.html', 0, NULL);
INSERT INTO `t_blog` VALUES (275, '一个可屏蔽长短链接的网络模块', '<h1 id=\"前言\">前言</h1> \n<p>游戏开发中最复杂的模块，没有之一。其实我也不想写这篇文章，怎奈框架代码卖出去了，得给我的用户一个交代。<br> 网络模块都需要实现哪些功能呢？按我以往的开发经验总结如下：</p> \n<ol> \n <li>消息的正常发送与接收</li> \n <li>长链接的断线重连</li> \n <li>消息发送失败与尝试</li> \n <li>长链接的心跳处理</li> \n <li>适应各种服务器定义的协议格式</li> \n <li>适应各种数据传输格式</li> \n <li>屏蔽长短链接的差异</li> \n <li>长链接支持发送协议号与接收协议号不同的情况。</li> \n <li>让短链接也可以像长链接一样更新数据。</li> \n</ol> \n<h1 id=\"有必要屏蔽长短链接吗？\">有必要屏蔽长短链接吗？</h1> \n<p>这个看需求吧<br> 有没有开发过程中将长链接改成短链接的情况呢？你客户端不支持，服务器可是支持的。<br> 如果一个团队有很多开发人员，作为主程的你是否要屏蔽底层逻辑，提供统一的调用接口给其他开发人员使用呢？<br> 如果你一个人做一款游戏，你就随便来吧，随便什么样的方式只要你开心就好。</p> \n<h1 id=\"类图\">类图</h1> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/4880b51e-493e-4977-bb03-7e218aa48052.png\" alt=\"image.png\" loading=\"lazy\"></p> \n<ol> \n <li>Service 实现ServiceInterface接口负责屏蔽链接类型</li> \n <li>Message 负责封装发送和接收的消息。</li> \n <li>MessageHander 负责编解码处理。</li> \n <li>ServiceInfo 保存服务器信息。例如 ip 端口，协议号映射等信息。</li> \n <li>RemoteProxy 负责调用Service发送消息，接收Service返回的消息并通过事件派发给监听者。</li> \n</ol> \n<h1 id=\"关键代码\">关键代码</h1> \n<ol> \n <li>ServiceInfo<br> <img src=\"http://localhost:9090/blogImages/2020/08/06/6a9b4ae4-ddb0-43c0-9633-f1230dc135a5.png\" alt=\"image.png\" loading=\"lazy\"></li> \n <li>ServiceInterface<br> <img src=\"http://localhost:9090/blogImages/2020/08/06/2ac6b72a-3649-45d1-907c-892da539f511.png\" alt=\"image.png\" loading=\"lazy\"></li> \n <li>Service<br> <img src=\"http://localhost:9090/blogImages/2020/08/06/d963a366-bf2f-4dde-a7d7-4afd588aa788.png\" alt=\"image.png\" loading=\"lazy\"></li> \n <li>MessageHandler<br> <img src=\"http://localhost:9090/blogImages/2020/08/06/7ab91145-b485-4541-82fe-213670e51475.png\" alt=\"image.png\" loading=\"lazy\"></li> \n <li>Message<br> <img src=\"http://localhost:9090/blogImages/2020/08/06/d635a8c5-6651-411e-b403-70b9ecb0a1fa.png\" alt=\"image.png\" loading=\"lazy\"></li> \n <li>RemoteProxy<br> <img src=\"http://localhost:9090/blogImages/2020/08/06/542399b7-4b2e-42a7-8113-7896178ed414.png\" alt=\"image.png\" loading=\"lazy\"></li> \n</ol> \n<h1 id=\"如何使用呢？\">如何使用呢？</h1> \n<ol> \n <li>定义一个类来处理链接的监听<br> <img src=\"http://localhost:9090/blogImages/2020/08/06/d97269ce-ca15-4b13-b907-a5b447b91d8d.png\" alt=\"image.png\" loading=\"lazy\"></li> \n <li>定义一个地址和开发环境相关的数据类<br> <img src=\"http://localhost:9090/blogImages/2020/08/06/2c2d6caa-2406-47a8-b778-2185b5862ca9.png\" alt=\"image.png\" loading=\"lazy\"></li> \n <li>实现编解码处理类<br> <img src=\"http://localhost:9090/blogImages/2020/08/06/0757361d-7d23-48de-bfb7-fa4053c6b8ff.png\" alt=\"image.png\" loading=\"lazy\"></li> \n <li>定义协议号常量类<br> <img src=\"http://localhost:9090/blogImages/2020/08/06/42dd7ebb-1c9f-49da-9427-c9de941d4293.png\" alt=\"image.png\" loading=\"lazy\"></li> \n <li>定义一个链接<br> <img src=\"http://localhost:9090/blogImages/2020/08/06/616ca41a-8c7e-471d-83ee-b7e2cc92501a.png\" alt=\"image.png\" loading=\"lazy\"></li> \n <li>使用方式</li> \n</ol> \n<pre><code>export default class LoginController extends LogicController {\n\n    constructor(){\n        super(LoginProxy.instance());\n    }\n\n    private static ins:LoginController;\n\n    static instance():LoginController{\n        if(!this.ins){\n            this.ins = new LoginController();\n        }\n        return this.ins;\n    }\n\n    //注册协议号与回调函数\n    getProtoList(){\n        return [\n            [NetConfig.OPEN,this.netOpen],\n            [LoginProtocolIDs.LOGIN,this.loginRsp],\n        ];\n    }\n\n    netOpen(){\n        cc.log(\' 链接成功 \')\n        this.pushView(\'Prefab/LoginView\',\'LoginView\',null,ModuleManager.getLoader(),UIIndex.STACK)\n    }\n    //进入模块 先链接服务 当然也可以先弹出界面，再推送链接结果。\n    intoLayer(){\n        ModuleManager.setModuleID(ModuleID.LOGIN)\n        //进入此模块，先进行链接操作，如果链接成功 会走loginRsp 函数\n        this.remoteProxy.connect(new ServiceInfo(NetConfig.HTTP,AddressConfig.getAdress(AddressConfig.LOGIN,0)));\n    }\n\n    // 点击登陆按钮发送请求。\n    loginReq(name:string){\n        cc.log(\" loginReq \",name);\n        this.sendMessage(LoginProtocolIDs.LOGIN,{name:name,channel:\'crazy\'});\n    }\n\n    //登陆成功\n    loginRsp(msg:ReceiveMessage){\n        cc.log(\" loginRsp msg \",msg);\n        //由于服务器已经关闭，所以不会被调用，正常内容返回时会走这里。\n    }\n\n}\n</code></pre> \n<h1 id=\"结语\">结语</h1> \n<p>细节代码太多了，如果都粘贴上来无法忍受。其实网络那些事论坛里已经有人说的很详细了。使用方式也很多，就好像都是用xxgl，每个引擎实现的方式都不同。我只是从框架和封装的角度整理一下具体的使用方式，其实细节的东西，你没有遇到的时候也是没办法理解的，代码里都是经验。有想法的同学留言吧。</p> \n<h1 id=\"欢迎扫码关注公众号《微笑游戏》，浏览更多内容。\">欢迎扫码关注公众号《微笑游戏》，浏览更多内容。</h1> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/f77e6d79-4820-4231-8807-137263a419ad.jpeg\" alt=\"微信图片_20190904220029.jpg\" loading=\"lazy\"></p> \n<p>欢迎扫码关注公众号《微笑游戏》，浏览更多内容。</p>', NULL, '2020-08-06 11:18:27', 0, NULL, NULL, 'https://www.cnblogs.com/cgw0827/p/13444562.html', 0, NULL);
INSERT INTO `t_blog` VALUES (276, '.NetCore 配合 Gitlab CI&CD 实践 - 单体项目', '<h3 id=\"section\">前言</h3> \n<p>上一篇博文 <a href=\"https://gridea.run/post/netcore%E9%85%8Dgitlabci_cd%E5%AE%9E%E8%B7%B5-%E5%BC%80%E7%AF%87/\">.NetCore 配合 Gitlab CI&amp;CD 实践 - 开篇</a>，主要简单的介绍了一下 <code>GitLab CI</code> 的持续集成以及持续部署，这篇将通过 <code>GitLab CI</code> 发布一个 .net core 项目,来带小伙伴们感受一下自动化的魅力，从此告别手动发布。</p> \n<h3 id=\"section-1\">准备工作</h3> \n<p><strong>创建一个空MVC项目来进行演示：</strong></p> \n<pre><code>mkdir hello-world\ncd hello-world\ndotnet new sln -n HelloWorld\nmkdir src\ncd src\ndotnet new mvc -n GitLabCIDemo\ncd ../\ndotnet sln add .\\src\\GitLabCIDemo\\GitLabCIDemo.csproj\n</code></pre> \n<p>完成以上创建后，用 vscode 打开应该是下面这个样子：</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/dbdae633-955b-40d4-8938-520486990130.png\" alt=\"image.png\"></p> \n<p><strong>项目上传至 GitLab</strong></p> \n<p>在 gitlab 上新建一个 <code>hello-world</code> 的项目，将本地的项目上传。这个按照如下提示操作即可：</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/7d7cac18-6dc0-4879-b9f2-05456657eeb0.png\" alt=\"image.png\"></p> \n<p>项目上传成功后，切一个 dev 分支出来，我这里的策略是，代码提交到 dev 分支是自动发布到开发环境进行验证的，生产环境是通过 master 分支打 tag 进行发布的。</p> \n<ul> \n <li>切换到 dev 分支！</li> \n <li>切换到 dev 分支！</li> \n <li>切换到 dev 分支！</li> \n</ul> \n<p><strong>添加相关脚本</strong></p> \n<p>在 <code>hello-world</code> 文件夹内创建 <code>.build/docker</code> 文件夹，并添加如下脚本以及<code>Dockerfile</code>:</p> \n<ul> \n <li>build-image.sh</li> \n</ul> \n<pre><code class=\"language-shell\">docker build -f .build/docker/Dockerfile --build-arg PROJECT=$1 --build-arg ASPNETCORE_ENVIRONMENT=$2 -t $3 .\n</code></pre> \n<ul> \n <li>build-project.sh</li> \n</ul> \n<pre><code class=\"language-shell\">set -e\nfor arg in \"$@\"\ndo\n    target=$(pwd)/src/$arg\n    dotnet restore -v n $target\n    dotnet publish -c Release -o $target/publish $target\ndone\n</code></pre> \n<ul> \n <li>push-image.sh</li> \n</ul> \n<pre><code class=\"language-shell\">NEW_TAG=\"registry.cn-hangzhou.aliyuncs.com/xxx/$1\"; // 这里得用你自己命名空间哦\ndocker tag $1 $NEW_TAG\ndocker push $NEW_TAG\ndocker rmi $NEW_TAG\n</code></pre> \n<ul> \n <li>Dockerfile</li> \n</ul> \n<pre><code class=\"language-Dockerfile\">FROM mcr.microsoft.com/dotnet/core/aspnet:3.1-alpine\nARG PROJECT\nARG ASPNETCORE_ENVIRONMENT\nENV ASPNETCORE_ENVIRONMENT ${ASPNETCORE_ENVIRONMENT}\nWORKDIR /app\nCOPY src/${PROJECT}/publish .\nRUN echo \"#!/bin/bash \\n dotnet ${PROJECT}.dll\" &gt; start.sh &amp;&amp; chmod +x ./start.sh\nENTRYPOINT [\"./start.sh\"]\n</code></pre> \n<p>这里构建镜像所使用 <code>3.1-alpine</code> 构建出来的镜像体积只有其他镜像版本构建出来体积的一半。推荐使用。到此目录结构就成了现在这样：</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/64aaa74f-9e48-4dd4-b271-3b289ad95a38.png\" alt=\"image.png\"></p> \n<p>至此准备工作已经差不多了！我们先简单过一下 CI 的流程：</p> \n<p>提交代码 --&gt; 编译 --&gt; 测试 --&gt; 构建镜像 --&gt; 发布</p> \n<h3 id=\"build\">编译 -- Build</h3> \n<p>在 <code>hello-world</code> 目录下添加 <code>.gitlab-ci.yml</code> 文件，添加 <code>build</code> 任务:</p> \n<pre><code class=\"language-yaml\">stages:\n  - build\n\nhelloworld-build:\n  stage: build\n  tags:\n    - docker\n  image: mcr.microsoft.com/dotnet/core/sdk:3.1\n  script:\n    - .build/docker/build-project.sh GitLabCIDemo\n  artifacts:\n    paths:\n      - src/*/bin\n      - src/*/publish\n</code></pre> \n<p>这里起一个容器来跑编译任务，具体细节可以看 <code>build-project.sh</code> 脚本，用 <code>artifacts</code> 将发布出来的资源上传，给后面的 构建任务使用，不需要重复 build，节约时间。这里执行会出现如下错误：</p> \n<pre><code class=\"language-shell\">/bin/bash: line 89: .build/docker/build-project.sh: Permission denied\n</code></pre> \n<p>这是因为脚本没有执行权限，通过 <code>chmod</code> 命令可以解决：</p> \n<pre><code>chmod +x build-image.sh build-project.sh push-image.sh\n</code></pre> \n<p>重新提交，触发 build 任务。打开 GitLab CI 界面，执行成功，是不是很开心呢？</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/ab1c159f-e67f-4356-ab83-a8449b3aed3b.png\" alt=\"image.png\"></p> \n<h3 id=\"test\">测试 -- Test</h3> \n<p>现在项目里面没有测试代码，那就新建一个吧。在 <code>hello-world</code> 根目录下：</p> \n<pre><code>mkdir test\ncd test\ndotnet new xunit -n GitLabCIDemo.UnitTests\n</code></pre> \n<p>更新 <code>.gitlab-ci.yml</code> 添加 Test 任务：</p> \n<pre><code class=\"language-yaml\">stages:\n  - build\n  - test\n\nhelloworld-build:\n  stage: build\n  tags:\n    - docker\n  image: mcr.microsoft.com/dotnet/core/sdk:3.1\n  script:\n    - .build/docker/build-project.sh GitLabCIDemo\n  artifacts:\n    paths:\n      - src/*/bin\n      - src/*/publish\n\nhelloworld-test:\n  stage: test\n  tags:\n    - docker\n  image: mcr.microsoft.com/dotnet/core/sdk:3.1\n  script:\n    - dotnet test -c Release\n  dependencies:\n    - helloworld-build\n</code></pre> \n<p>等待一会，查看 CI 运行。</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/23c4ff5c-ea11-4513-bd41-ec6e24232091.png\" alt=\"image.png\"></p> \n<h3 id=\"docker-pack\">构建 Docker 镜像 -- Pack</h3> \n<p>我这里使用的是阿里云的镜像仓库，需要现在阿里云上创建对应的命名空间以及镜像名称。我这里给镜像名取名为 <code>hello-world</code>，别忘了修改 <code>push-image.sh</code> 中的命名空间哦！</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/d8d0aeeb-a94c-4dfe-a622-1d88cd59fa84.png\" alt=\"image.png\"></p> \n<p>更新 <code>.gitlab-ci.yml</code> 添加 Pack 任务：</p> \n<pre><code class=\"language-yaml\">stages:\n  - build\n  - test\n  - pack\n\nhelloworld-build:\n  stage: build\n  tags:\n    - docker\n  image: mcr.microsoft.com/dotnet/core/sdk:3.1\n  script:\n    - .build/docker/build-project.sh GitLabCIDemo\n  artifacts:\n    paths:\n      - src/*/bin\n      - src/*/publish\n\nhelloworld-test:\n  stage: test\n  tags:\n    - docker\n  image: mcr.microsoft.com/dotnet/core/sdk:3.1\n  script:\n    - dotnet test -c Release\n  dependencies:\n    - helloworld-build\n\nhelloworld-pack-staging:\n  stage: pack\n  tags:\n    - shell\n  script:\n    - .build/docker/build-image.sh GitLabCIDemo Staging hello-world:beta\n    - .build/docker/push-image.sh hello-world:beta\n  dependencies:\n    - helloworld-build\n  only:\n    - dev\n</code></pre> \n<ul> \n <li><p><code>Staging</code>： 用来设置环境变量 <code>ASPNETCORE_ENVIRONMENT</code>,让 <code>.net core</code> 读取对应的配置文件，可以设置<code>Development</code>,<code>Staging</code>,<code>Production</code> 三种，可以在对应的环境设置对应环境变量，使用不同配置。</p> </li> \n <li><p>beta: 因为是开发环境，就一直使用同一个 tag 去覆盖之前的镜像，每次 pull 最新的镜像就好了，也可以使用 <code>$CI_COMMIT_SHORT_SHA</code> 使用当前 git 提交的 hash 值作为版本号</p> </li> \n</ul> \n<p>CI 应该执行的差不多，再去瞧瞧呗! 又是全绿，真是开心！额，全绿，怪怪的...</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/ff4e5337-0093-4209-a7d2-6ee4a4dc13e2.png\" alt=\"image.png\"></p> \n<p>打开阿里云镜像容器服务，查看一下刚刚上传的容器镜像吧！</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/45953b30-d128-472e-a663-9f4360e54a96.png\" alt=\"image.png\"></p> \n<h3 id=\"deploy\">部署 -- Deploy</h3> \n<blockquote> \n <p>这里我图方便就使用 <code>docker-compose</code> 来做演示了，通常部署环境都是使用集群来部署的，当然单机部署也不是不无可能的，我内网用 k3s 搭建的一个集群，为啥不用 k8s，因为要求资源配置比较高，k3s 刚好够用。但是部署到 k3s 需要写挺多的配置的文件，可以单独写一篇博文介绍。</p> \n</blockquote> \n<p>作为自动化最后一步，无论你是用 <code>k8s</code>,<code>k3s</code>,<code>docker swarm</code>......,都是拉取对应的镜像，进行部署。思路是一样的，只是部署方式略有不同。这里通过 docker-compose 来发布 <code>hello-world</code> 应用咯。</p> \n<p>在部署的 Linux 服务器上创建文件夹 <code>/deploy</code> ，在目录下添加 <code>docker-compose.yml</code> 文件，添加如下内容：</p> \n<pre><code>version: \"3.8\"\nservices:\n  hello-world:\n    image: registry.cn-hangzhou.aliyuncs.com/jd-rd/hello-world:beta\n    container_name: hello-world\n    restart: always\n    ports: \n      - 5013:80\n    networks:\n      - basic_service  \n\nnetworks:\n  basic_service:\n</code></pre> \n<p>更新 <code>.gitlab-ci.yml</code>，添加部署任务：</p> \n<pre><code>stages:\n  - build\n  - test\n  - pack\n  - deploy\n\nhelloworld-build:\n  stage: build\n  tags:\n    - docker\n  image: mcr.microsoft.com/dotnet/core/sdk:3.1\n  script:\n    - .build/docker/build-project.sh GitLabCIDemo\n  artifacts:\n    paths:\n      - src/*/bin\n      - src/*/publish\n\nhelloworld-test:\n  stage: test\n  tags:\n    - docker\n  image: mcr.microsoft.com/dotnet/core/sdk:3.1\n  script:\n    - dotnet test -c Release\n  dependencies:\n    - helloworld-build\n\nhelloworld-pack-staging:\n  stage: pack\n  tags:\n    - shell\n  script:\n    - .build/docker/build-image.sh GitLabCIDemo Staging hello-world:beta\n    - .build/docker/push-image.sh hello-world:beta\n  dependencies:\n    - helloworld-build\n  only:\n    - dev\n\ndeploy-staging:\n  stage: deploy\n  tags:\n    - staging\n  script:\n    - cd /deploy &amp;&amp; docker-compose pull &amp;&amp; docker-compose up --force-recreate -d &amp;&amp; docker ps\n  only:\n    - dev\n</code></pre> \n<p>等待整个CI跑完，查看 CI 运行结果</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/685ef06c-41dd-4eef-a01f-8548a4f3f05f.png\" alt=\"image.png\"></p> \n<p>通过服务器IP + 5013 访问应用了，就可以看到服务更新</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/5a75d29e-5082-4bdc-a333-39809bd3e67e.png\" alt=\"image.png\"></p> \n<p>修改一下 <code>Index.cshtml</code> 将 <code>Welcome</code> 修改为 <code>Hello Devops !</code> ，重新提交一下，稍等片刻，重新访问即可看到变化了。</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/ad6cb3f8-9057-4b1d-9f08-4b2f3dc6762f.png\" alt=\"image.png\"></p> \n<p>至此一个简单的 CI 流程已经走完了，各位看官可以根据自己的需求，继续探索。</p> \n<h3 id=\"section-2\">题外话</h3> \n<p>如果将脚本都放在项目里面的话，将来涉及到脚本变更，需要每个项目都给改过去，这是十分痛苦的事情。这里推荐小伙伴可以通过 <code>git submodule</code> 子模块的方式进行引用，将公共的脚本都给提取出来，项目通过子模块来加载脚本项目，将来脚本变更，每个项目只需要更新一下子模块就好。</p> \n<h3 id=\"section-3\">总结</h3> \n<p>通过以上一个小案例已经带小伙伴了解了一圈 <code>GitLab-CI</code> 如何来发布一个 <code>.net core</code> 应用，感受了一下 <code>GitLab-ci</code> 的魅力。但是以上方案还是有瑕疵的，对于单体应用来说，没有太大问题，但并不适合微服务项目。在微服务项目中，如果多个服务散落在多个仓库中，需要多个项目代码改动其实是很不方便的，所以现在很多的微服务项目都采用 <code>Mono</code> 仓库风格及将所有的服务都放在一个仓库里面，仓库体积虽然大，但是改动起来更方便。本篇就先到这里了，有关于 <code>GitLab-CI</code> 对于 <code>Mono</code> 仓库风格项目 <code>CI&amp;CD</code> 探索实践，且听下回分解。</p>', NULL, '2020-08-06 11:19:01', 0, NULL, NULL, 'https://www.cnblogs.com/hellotim/p/13382579.html', 0, NULL);
INSERT INTO `t_blog` VALUES (277, '打破你的认知！Java空指针居然还能这样玩，90%人不知道…', '<p>相信在座的各位都遇到过空指针异常，不甚其烦，本文不是教你避免空指针，而是一些对空指针其他方面的理解。</p> \n<p>本文可能有点另类，也可能会打破你对空指针的认知。</p> \n<h2 id=\"1、nullmethod-空指针？\">1、null.method() 空指针？</h2> \n<p>我们知道调用一个对象的方法，如果对象为 <code>null</code> 肯定会报空指针错误的，但你确定一定会吗？</p> \n<p>不一定！</p> \n<p>来看下面的示例：</p> \n<pre><code>/**\n * 访问静态方法\n * @from 微信公众号：Java技术栈\n */\nprivate static void test() {\n    NullTest nullTest = null;\n\n    // hello\n    nullTest.test1(\"hello\");\n}\n\n/**\n * @from 微信公众号：Java技术栈\n * 关注获取更多好玩的 Java 技术干货\n */\nprivate static void test1(String text) {\n    System.out.println(text);\n}\n</code></pre> \n<p>如果 <code>null</code> 对象指向该类型的静态方法，不但不会报空指针错误，而且还会运行正常，是不是很6？</p> \n<p>因为静态方法不属于任何对象，它属于类本身的，相当于直接调用类的静态方法。</p> \n<h2 id=\"2、拆箱空指针\">2、拆箱空指针</h2> \n<p>是的，大家要注意拆箱引发的空指针风险，不知道的赶紧往下看，来看下面的例子：</p> \n<pre><code>/**\n * 拆箱\n * @from 微信公众号：Java技术栈\n */\nprivate static void test() {\n    Integer i = null;\n\n    // //NullPointerException\n    int ii = i;\n\n    System.out.println(ii);\n}\n</code></pre> \n<p>拆箱如果为 <code>null</code> 时，引发空指针错误。</p> \n<p>这个在最新的《<a href=\"https://mp.weixin.qq.com/s/lQth5Ft33L_I20vEyOFAMQ\">阿里巴巴开发手册</a>》中也提到了，链接里面举了三目运算符拆箱时的空指针问题，没看过的可以点进去看，这里就不具体展开了。获取这份最新开发手册，请在公众号Java技术栈回复手册。</p> \n<h2 id=\"3、运算符空指针\">3、运算符空指针</h2> \n<p>大家要注意了，运算符使用不当也会引发空指针异常，来看下面的例子：</p> \n<pre><code>/**\n * 运算符\n * @from 微信公众号：Java技术栈\n */\nprivate static void test5() {\n    Integer i = null;\n    Integer j = null;\n\n    // true\n    System.out.println(i == j);\n\n    // false\n    System.out.println(i != j);\n\n    // NullPointerException\n    System.out.println(i &gt; j);\n\n    // NullPointerException\n    System.out.println(i &lt; j);\n\n    //NullPointerException\n    System.out.println(i &amp; j);\n}\n</code></pre> \n<p>例子很明显吧，使用 <code>==</code>、<code>!=</code> 运算符比较是否相等不会有问题，但使用 <code>&gt; &lt; &amp;</code> 等需要计算的运算符就会引起空指针异常。</p> \n<h2 id=\"4、xxx--null引发空指针？\">4、xxx == null引发空指针？</h2> \n<p>经常看博客或者身边的同事说，字符串比较，常量要放前面，为了避免空指针风险，这个对于 <code>equals</code> 来说确实要这样写。</p> \n<p>但是，居然还有人说，甚至也有很多人也是这么在写， <code>==</code> 比较，<code>null</code> 也要放前面，这也是为了避免空指针？还是为了避免啥风险？</p> \n<p><strong>首先要搞清楚为什么有 <code>null == xxx</code> 这个写法？</strong></p> \n<p>这个写法的初衷是 <code>C++</code> 为了避免逻辑错误的，因为 <code>C++</code> 写 <code>if(xxx = NULL)</code> 是不会报编译错误的（变量赋值，永远为真），而写 <code>if(NULL = xxx)</code> 是会有编译错误的。</p> \n<p>所以在 <code>C++</code> 建议把 <code>NULL</code> 放在前面，是为了避免程序员把 <code>==</code> 写成 <code>=</code> 引起的逻辑错误的。</p> \n<p>而在 <code>Java</code> 里面，<code>if(xxx = null)</code> 是有编译错误提示的：</p> \n<p><img src=\"http://localhost:9090/blogImages/2020/08/06/78f56b1f-b91e-45a9-ad1d-b3776e190921.png\" alt=\"\" loading=\"lazy\"></p> \n<p>所以 <code>Java</code> 中不会出现 <code>C++</code> 的没有编译提示而导致的逻辑问题，所以 Java 中的 <code>xxx == null</code> 和 <code>null == xxx</code> 是等价的，<code>null</code> 放前面也是没有任何意义的。</p> \n<p>我们甚至还可以在 Java 中写 <code>null == null</code> 的判断，这也是 OK 的，完全没问题的。</p> \n<p>下面是完整的示例：</p> \n<pre><code>/**\n * 运算符\n * @from 微信公众号：Java技术栈\n */\nprivate static void test() {\n    Integer i = null;\n\n    // i is null\n    if (null == i){\n        System.out.println(\"i is null\");\n    }\n\n    // i is null\n    if (i == null){\n        System.out.println(\"i is null\");\n    }\n    \n    // i == j\n    Integer j = null;\n    if (i == j){\n        System.out.println(\"i == j\");\n    }\n\n    // 编译错误\n    if (i = null){\n        System.out.println(\"i is null\");\n    }\n}\n</code></pre> \n<p>有没有小伙伴也被这个说法迷糊过？</p> \n<h2 id=\"5、null-instanceof-空指针？\">5、null instanceof 空指针？</h2> \n<p>null instanceof 会发生空指针异常么？</p> \n<p>不会！</p> \n<p>来看下面的示例：</p> \n<pre><code>/**\n * instanceof\n * @from 微信公众号：Java技术栈\n */\nprivate static void test() {\n    Integer i = null;\n\n    // false\n    if(i instanceof Number){\n        System.out.println(\"true\");\n    } else {\n        System.out.println(\"false\");\n    }\n    \n    // false\n    if(null instanceof Number){\n        System.out.println(\"true\");\n    } else {\n        System.out.println(\"false\");\n    }\n}\n</code></pre> \n<p>如果为 <code>null</code>, <code>instanceof</code> 右边可以是任意引用类型，但结果始终输出 <code>false</code>，因为 <code>null</code> 不是任何对象的引用。</p> \n<h2 id=\"总结\">总结</h2> \n<p>好了，今天栈长的分享就到这了，又涨姿势了吧？</p> \n<p>另外，之前这篇《<a href=\"https://mp.weixin.qq.com/s/cmkKuhEZl1qx6TXPxvA5pw\">避免空指针的 5 个案例</a>》也不错的，没看过的值得阅读一下。</p> \n<p>大家还知道哪些空指针的骚操作？欢迎留言分享哦！~</p> \n<p>最后，感谢阅读，原创不易，各位老铁们，给个在看、转发下吧！</p> \n<p><strong>推荐去我的博客阅读更多：</strong></p> \n<p>1.<a href=\"http://www.javastack.cn/categories/Java/\">Java JVM、集合、多线程、新特性系列教程</a></p> \n<p>2.<a href=\"http://www.javastack.cn/categories/Spring/\">Spring MVC、Spring Boot、Spring Cloud 系列教程</a></p> \n<p>3.<a href=\"http://www.javastack.cn/categories/%E5%B7%A5%E5%85%B7/\">Maven、Git、Eclipse、Intellij IDEA 系列工具教程</a></p> \n<p>4.<a href=\"http://www.javastack.cn/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/\">Java、后端、架构、阿里巴巴等大厂最新面试题</a></p> \n<p>觉得不错，别忘了点赞+转发哦！</p>', '相信在座的各位都遇到过空指针异常，不甚其烦，本文不是教你避免空指针，而是一些对空指针其他方面的理解。 \n本文可能有点另类，也可能会打破你对空指针的认知。 \n1、null.method() 空指针？ \n我们知道调用一个对象的方法，如果对象为 null 肯定会报空指针错误的，但你确定一定会吗？ \n不一定！ \n来看', '2020-08-06 11:19:06', 5, 1, 'Java 空指针', 'https://www.cnblogs.com/javastack/p/13444370.html', 1, '2020-08-06 15:19:06');
INSERT INTO `t_blog` VALUES (278, 'Edge 浏览器开发工具新增了 3D 视图，你尝试了吗？', '<p>在使用开发者工具的时候，无意间发现了一个3D面板，如下：<img src=\"http://localhost:9090/blogImages/2021/03/27/94beb6fb-e2db-40cd-a293-6b3f30490ff8.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>仔细想想，这应该是之前 Firefox 的特性啊，不过后来去掉了，说是太难维护，没想到 Edge 也添加了这个特性。</p> \n<p>使用该特性，你可以完成如下任务：</p> \n<p>&nbsp;</p> \n<ul class=\"list-paddingleft-2\"> \n <li> <p>以3D视图浏览你的网页</p> </li> \n <li> <p>基于 z-index 堆叠上下文的调试</p> </li> \n <li> <p>从具有合成层的三维视图访问层工具功能</p> </li> \n <li> <p>清除DOM窗格或z-index窗格中的一些杂乱内容&nbsp;</p> </li> \n <li> <p>为调试 DOM&nbsp;问题或者 z-index 问题进行着色，以便调试</p> </li> \n</ul> \n<p>&nbsp;</p> \n<p>如果你想看看 3D 视图项目的早期版本，并自己运行代码，可以参考3D View Sample。</p> \n<p>在开发者工具的左侧，可以看到两个标签页：</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/6a291d51-4a5d-4700-9da7-2c327acb3693.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<ul class=\"list-paddingleft-2\"> \n <li> <p>Z-索引标签页，在应用程序中浏览不同的元素，并在不同的元素间进行导航。本标签页为默认标签页</p> </li> \n <li> <p>DOM 标签页，用于浏览整个网页的 DOM 结构，易于访问每一个元素。要查看本页，点击 DOM 标签页切换。</p> </li> \n</ul> \n<p>&nbsp;</p> \n<p><strong>快捷键</strong></p> \n<p>&nbsp;</p> \n<ul class=\"list-paddingleft-2\"> \n <li> <p>旋转 DOM：要进行水平旋转，请按左右箭头键，如果要进行垂直旋转，请按上下箭头键。</p> </li> \n <li> <p>DOM 元素导航，要选择不同的元素，请选择一个元素，并按上下箭头键。</p> </li> \n</ul> \n<p>&nbsp;</p> \n<p><strong>鼠标操作</strong></p> \n<p>&nbsp;</p> \n<ul class=\"list-paddingleft-2\"> \n <li> <p>旋转 DOM：使用鼠标左键拖动即可。</p> </li> \n <li> <p>平移图像：鼠标右键移动。</p> </li> \n <li> <p>图形缩放：移动右下方的滑块或者使用鼠标上的滚轮进行缩放</p> </li> \n</ul> \n<p>&nbsp;</p> \n<p>接下来看些效果：</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/514f5446-6bc4-4881-85f5-019fe3adfc2b.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;<img src=\"http://localhost:9090/blogImages/2021/03/27/b17da68a-edd8-4c3a-a514-a8ffdfa79b59.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;<img src=\"http://localhost:9090/blogImages/2021/03/27/1880e966-386e-4851-a845-c432f1544e96.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>下次调试的时候可以试试，布局不再愁...</p> \n<p>最近准备发奋了，要多写些东西分享了，欢迎关注下面公众号，更多文章期待与你相遇：</p> \n<p>&nbsp;</p> \n<p><img src=\"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/2wBDAQMEBAUEBQkFBQkUDQsNFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBT/wAARCAFYAVgDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9U6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBpbBpQSQDigjNfysE5NAH9U9FfysUUAf1T0V/KxRQB/VPQc1/KxQOtAH9U4OaWkHSloAQnApAxJxilIzX8rBNAH9UxYg4xSg5FfysA1/VOBigBaQnFLSHpQADNFfysHrRQB/VOSQCcUgbJr+VkHBr+qcDFAC0UUUAISQCcUgbNfysg4Nf1T4xQAm4g4x+NKDkV/Kzmv6pgMUAFBzX8rFA60Af1Tg5paQdKWgBCcCkDEnGKUjNfysE0Af1T0V/KxRQB/VPRX8rFFAH9U9FfysUUAf1UUUUUAFFFFABRRRQAnev5WK/qn71/KxQB/VOTgZNAOaCMiv5Wc8dKAP6p6K/lYz7UZ9qAP6p6/lX9K/qor+Vf0oA/qnHav5WK/qnHav5WKAP6p+lfys+lAI9K/qk2470AOzgUA5GRX8rWeO3Nf1Sr0oA/lY61/VPnrSHp1r+Vw4NADD1opSCaTFAH9U5OBk0ZyKDyOtfyt9qAG4r+qYHIr+VrdikLAnpQAgGTRgg1/VMeR1/Kv5Wzzge9AH9UucYr+VgjBr+qU84py9BzmgD+VigdaKB1oA/qnHav5WK/qnHav5WKAP6qK/lX9K/qor+Vf0oA/qnyAOaAcikK5I57V/K1kelAH9U9FfysZ9qARnpQB/VN1xX8rFf1TgV/KxQB/VRRRRQAUUUUAFFFFACd6/lYr+qfvX8rFAH9VFfyr9q/qor+VftQAUUUUAf1UV/Kv6V/VRX8q/pQB/VOO1fysV/VOO1fysUALgetf1Sbsn+tOIyKMACgBp64/WnDp6V/Kzmv6pgMUAfysjk9fzr+qTv7iv5WgcGjNACniv6psAV/Kx1zX9VFAH8rA69a/qjzz3+tPIyKNo9KAP5WSAT1ox71/VPRQB/KwOvWv6o889KeRkUbR6UAfytgA5r+qRenSjFfysdaAFCgnrQVxiv6piMiv5Wc5xQB/VKWwRx2r+VrA9a/qmwCOaAMCgBa/lX9K/qor+Vf0oA/qnHav5WK/qnHav5WKACgdaKB1oA/qnHav5WK/qnHav5WKAP6qKKKKACiiigAooooATvX8rFf1Tk4r+VggigD+qiiv5WPwo/CgD+qeiv5WPwo/CgD+qYnAr+VnGMUA4PSlJz+FAH9Uo7V/KxX9U2a/lZIIoA/qnJwMmjORQeR1r+Vrt24oAbjJoIwa/qlPrzX8rZHPT8qAP6p6/lX9K/qor+Vf0oA/qnyAOaAcimsOh9ulfytnr0oAQDJowfSv6pyCRjOK/laz2oAbigjBr+qXnOeeO1fytHr/hQB/VOTgZNGRQeR1r+VrtQB/VLuHrQDkU3bk5z+Ffyt5HpQB/VMTgZNGRQ3Sv5WvQe/WgD+qXriv5WK/qmBxX8rJGKAP6qK/lY9K/qmJxX8rPSgD+qYdKWv5WD9KPwoA/qnor+Vj8KPwoA/qmJxX8rBGKdnjGKaeT0oA/qoooooAKKKKACiiigBCM0AAUtFACHgdKbnJxj8acRmv5Wc0Af1TDmjFA6UtACY9hRiv5WKKAP6p8ZoAx2r+ViigAzX9UxGDX8rNf1TnvQAmM9aUDHav5WD1ooA/qnJIGcZr+Vrb0NNBwaMn1oA/qmxkc0oGO1fysUUAf1TkkDOM1/K1jimg4NLkk0AL7009a/qnxmv5WCc0AKOvWv6pF5PenEZFAAHSgA71/KxX9U/ev5WKAP6pyM0hGBTqTrQB/K1nnrSY96/qnooARuh4zTQa/laBwa/qnxigAH0FGPYV/KwetFAH9U+PYUY9hX8rFFAH9UxODjFKOR0r+VgGv6pwMUALRRRQAUUUUAFFFFACEgdaAcikZcnr2r+VrI9KAP6picCv5WSD0oBwelLuz1oAbigjBr+qXBODX8rROTQAda/qnz1obp1r+VokGgBPWv6putMI+tfyuHr0oA/qnr+VftX9VFfyr4zQAAZr+qcHIr+VkHaKCcnpQAgGTX9U+c0jdDz+VIB6GgD+Vv1r+qbrTWBzX8rZ69KAEr+qfvX8rAGa/qnB/CgA71/KxX9U5P41/KwRigD+qiiv5WM+1Gc9qAP6p6K/lZ/AUmfagD+qekPSgnFGcigD+VjBJoIwacOMj361/VIvQc5+tADqQ9K/lZ/CgfSgA9a/qnr+VjrX9UwOaAP5WK/qn6Zr+Viv6pmoAUkV/KwRindeKaetAH9VFFFFABRRRQAUUUUAJ3r+Viv6p+9fysUAf1T4oIpaQ9KAG5IOK/laIwaM4NBOTQB/VOeaQjFfys0DrQB/VKTzzSr0HH50uM1/KwTk0Af1UV/KwK/qnr+VfpigD+qYD8aXHsK/lYooAUdetf1SKef604jIowAKAGk84IpwHHSv5Wc1/VMBigD+VgdacRnnNNBxX9U2AKAP5Ws4NJQetFABQOtFA60Af1TY9zX8rJOa/qnHav5WKAP6p26V/K16H36V/VKRkYNGBQA0mnL0HGKMDp2r+VgnJoA/qnx7Cg/QV/KxQOtAH9U2M0oGKB0paAP5WMD1r+qTdk/wBacRkUYAFADTnOP1r+Vo9f8KM4NBOTQB/VRRRRQAUUUUAFFFFACd6/lYr+qfvX8rFAH9U/Sv5WCKUHnpX9UgBGaAP5WsH0oIwadnt+tf1SL0HOfrQB/Kz1r+qfNDdOtfytkg4oA/qk60tNBwKUHNAATgUAg9K/lZHXpX9Ui8HPP0oAcSB1oByKa3Jzz9K/lbJ56UAAGCM9K+r/AIDf8E0fjP8AHzQLXX7TTrLwtoN2nm2t94hmeD7QhVWV0jVGcowbIbbg/Tml/wCCaPwF0n49ftNafaeILWLUNB0Czk1u7s59pS48t0SNGUgh0MkiblPUA9uv7c32s/21qEyvPc/Z45HijtbNyjtsOGd2XB5bgDIHHfNJuwH5VD/gih8U/wDoefCHX+9df/Ga/ZJRgAVysOmwTLuzeIP9q7l5+nzVmTanpCyyRQXF5eTJ96O1uJpCPyap5khpN7H5VD/gib8U1Of+E58HnHvdf/Ga/Y7GBySK89e/DA+XpWtP6ZuHUfrJXm37QFv4z1b4Va5a+ErDV7DXJLdmiuItSkEiY5IQrJkMR0NT7RFqnJn5+D/gil8UeCPHXg/HXIa6/wDjNfsgv3R3r4P8K/BDXPiD8G/D2qr8UvHNtql1bxtLJZ63dZVj/EwMmeoIP9Oa534KfDH4o/Cr9pHS9I1r4l6/4v0vULC7kih1HUrqWEKmz5nUynacuMEdweeaamnubewdm7nz+/8AwRO+KiqSvjnwczAcAtdDP/kGvG/j3/wTQ+NHwF8P3Wv3enWPinQbOPzbq+8OzNP9nQKWZ3jZVkCqFyW24GevXH7anQNXLgpqUZViAVLXAKDuQfNOfyFXrSK98LXVtJ/aEt7p8sqwywz5ZkLnCurEk/eIBBzwfampXOZqx/Mdgiv6pgcios5Yg9a/lePXpViEAya/qnyOvahuh5xTcelADiRX8rBGKd7AUh5PSgBKOtFKBg0AJiv6p+tNPOK/lbJ56UAf1TE4Ffys4xigHnpSk+vagD+qUdq/lYr+qbNfyskEUAf1UUUUUAFFFFABRRRQA1mwenav5WsD1r+qYgHrQBgUAfysDrTvfP4U0HFf1TgCgBAMilAxR0paAEPT1poPbFOIzX8rOaAFx3zX9Uq9KMZFAGBgUABGe1IRgccV/KzRQA4D0pCOetGT1r+qYDAoA/Gz/gij/wAl+8cev/CMtz/29QV+jGnaZ4wh8Taw+nQRadp80lxifd5u4ieRtwDY2nkfLnHJORXup4m4GflPH5V5PfXN9d6JqcdhqA06eG9nJmiQSEKJnzldwJz7elY1Vpc2pfFbuatt4ZTVrTytT1LUpLiWMGSB5jHgf7o4P6/Wuh0rR7bQrGO0tVKxJ0LHLH6nqa8y0vVoU+J0LPpT3Wp3EKob5rgbEXHWNORj15zyfSvWyQuBx9BXPTnGd32N69OVLlTe+p598RYPEbt5umXKW1iibiyNgkjqCccDrz09cVxunfFnWVk8mVFmkjOyWAplgR616RY+KbqzttUl8TxW+lJbTskTh8rLH/C2OuT/AJ6Vlf8ACDaLeXaa7pkCNbzgSSRIhBl7gjoV78Y5rojUi1sZOk4uz/4H3mJ4V8MTeELO6vdMdP7P1GZ71oViBFkzYZ1GCCyEgnHVT6jgRaj4Zsm+ImnfEC4vZLKLSdPmi2h1WFopNpHmZ7/LkDP+NUfGmqappPhu9XTr6OGKC4a48m5iPMMbDcmRzzyOnUjpXjfxU+IE/iu80fRb22a08FwbLu+unOUuuP3UXHbgkg9SAMevn18TSoO83ZndRpVKsbJXvofZGmX9tqljDeWkyXFtMgkjljOVZT0IPem6uAbNB/08Qf8Ao1K8X+BvxKsbm9GgLPCqSo0kMKkARNn7ijuCvp0K+9ezasf9Gj/6+IP/AEala4XERxNNVInHiKEqE3CRvu2LwL1ymefrVhRwOPzqo/OpJ/uf1NfyyHk16Jyn9U7dK/la7Zr+qUjIwaAMUAfytgZ71/VGOnSl71/Kx1oAUDnrX9UgNO61/Kz6UAL2JyK/qlHI6fnRjIoAwMCgD+VkDnrX9UgPPf604jIowAKAGk84IpwHHSv5Wc1/VMBigBaKKKACiiigAooooAQkDrQDkU1hzn26V/K2evSgD+qYnAr+VgjFKGAPSgncKAEopdtJQAAZr+qbOc1/KyOtOJwMelADcZNBGDX9Up9ea/lbI56flQAnWv6p+9BBI61/K0TkdKAP6pScV/KwRinD0xTT1oA/RT/giaMfHzx1nv4ZP/pVBX6uaLYxyNNJLHHNsnn2s6glSZnPHHHb867HpN+HP6V8/H4v3vhq6v7d7OO8ij1K7TzA+MgTPheM7SAO9Ll59ENHqGqeHbdL6LWLW2Rr6AFtoUfOMYIHocd6ux3b6nDE0MMsBOHDyrjbx6Vwmk/HbRr+SOGS2u4rp/uxRR+aScZ7cnH0r0eC4juYY5Y23RyKHUjuCMis3DlZV29yna6fJCjJPMtySdxLpzn8z7VcchRx2pzMOv61geONeHhvwnqupAF3t4GMajqznhR+JIrKTUE5FRTk1E8p8cNFqWgahdNJJ9kdAgdedq+ect+gJNeeaTbL9i04yRLJA8TWNzC4BUgEhcj8x/wKvRYreS4+GyxzjyH8mXcU5MYByPywfyrxPRvGEWnG90u4kS88qTgK+wqvq5YhQOM5ycV8RnFCvi5U6tGLd4rY+uyxcsZw7M7CLwtb6Awl0zNneW8nnW8y5dkcEEL7g4Ax3FfUN6WOnQFxtczW+4HqD5qf/Xr5/wDgDq+k+MfGup20t/bahfaVBHO1nC29LdmchG3dGOF6jpn6V9CaoMWUff8A0iD/ANGpXtZLg62EpP2z1lrbseTm071eRrY2ZDjUkJ7R5/U1/LKeK/RX/gtiSPj74FI4/wCKZH/pVPX7Ir0619OeEKTgZNGcihulfytcdP1oAaetFBooAAMmggiv6pm6dfyr+Vtjxj360AN7V/VRX8rAFf1TZBoAWv5V/Sv6p81/KzjpQB/VMO1fysV/VNmv5WSMUAf1UUUUUAFFFFABRRRQAhGaAAKWigD+VegdaKB1oA/qmx7mv5WSc1/VOO1fysUAKBz1r+qRck07rX8rBoA/qnxmgDHav5WKKAP6pySB0r+VrAFN6V/VPigBhPPf61/K4Rz1r+qbaPSgDAoA/Gz/AIIo8fH3xwOo/wCEZP8A6VQV9ZeJYLebxTr7SKwkXVLvB3Nk/wCkP79K+3Mfv/8AgJ/pXxZ4ltLeTxNrYlaQyPqd3tVG/wCm71UasaWsi4wc9Eeg/Cc6doug3OoShIJyxjkmZiWfnhc9ST2HevTfC3iizTQdNgnkkjuI7aNZEeNtwYKMg++a8B0SGLQogYfNuLpgW/eklY8+/Yf4flJez6tbOJLbUbmVnJLGIMVHX+HHA/D0rNXrO6djRxUdGfTSaraTW63CXMTwHB8wOCteW/tAeIJIPCMYsrr7MROsj3OzzI1UeozzyRz0Brzaw8W35IS9u7swv8jMybNp/EA8+tdaJ7ASWNvJbb0uIpI/LkBKtwuV5OCMleMDqa48RSc4ypN7m9C0Gqm50XgfT1n8AaFHPc/bvtUcoMxGBJuyRxX5yfGbwf4q8M/EzxjpVtNO6Xk8jeQrELLbyEOgOe3zD9a+m5P2g20rxJa+C3N1FerFnS3tQvloSXXEgyDjABBHOSfavLvjLrs2rSf22SzzJp6WbmVtrNhGJGQcnccjk9WrnoTj9Xhbse1hI1oYtSj1ka3/AATambS/id4lsLm3EN1LpCvyMMAsi8fT5s1+hOqn/RI8d7iD/wBGpX57fsTX72fxE03UL1Wt2mspLcuQf3iiMe3qg/EV9u2/xM8P+ItWvdEsb9X1HT7m2W4hdChUtKu0DdjOfau2m7o4c2VT65U9pvc9Il/5CS/9c/6mv5ZiOetf1MvzqSZ5zH/U1cAwK6TxQboeM03PpX8rQODX9U+B07UAfytEA800jBr+qcgV/KwTmgAzS53daSgdaAHdOhxSfjX9Uw6UtAH8q+a/qmxX8rNf1TnvQB/K0MnJpCOetGcZr+qYDAoAWiiigAooooAKKKKACikJxQCDQB/KxX9U571/KwBmv6pic+tAH8rXrX9U3Wm7ST1r+VskelAH9UxOBk0ZyKDyOtfytdqAE9a/qnr+VjGa/qmzQAtIelfys59qXp2FACetf1TdaYR9a/lcPXpQB+if/BE0gfH3xypPJ8MMcf8Ab1BX3tc+H4ptU1WUxIxfULttxIyP371+Un/BND496T8BP2mtPu/EF3Fp+g6/aSaLd3s20Jb+Y6PG7MSAiiSNNzHoCe3NfqX8bPhdr/h3Wr2/0jTdS1fSL+5NxjTJn8yF3JZ1ZR823ec5Xsx6YrGqm0bUmk9RNQ0zStNZBqN/awtLwiTsMn8/rVrSNO03UJWFheWkpRfnWF1O0fgcivK9c0T4meIrq+0zwjpd54esbUiFr280yZZ7pwMs0ZdCAucgZ4PrVLw5qHjDUdHv9I8b+E/Efn2X7y2u4NEuJHnIBDR5RNvJAwScEMc9MnFJx2OqyfU9lg0PTdFaa7vrmAJktvllCIOPc9cVZstT07xQkLaZcxXMVjcrKxjU5yw469iFPT0r5w8OeAvGvxe1mI+IfCOqaB4Rsrn7OtlLYXCzTDHMr70BYDoMAAcmvaPhtpdzpWp3N7BoOo2EKu6eW2lXKiSNNwjJ3Jkk4/WnrzXZL5UtGfO+r6JJB+07qkjjeltfJHExGMLuLAD6BhVrxDbQnQdVZ3CKtnlmfgBQnJr1Tx14E1N/iydYs9F1m5hluV3yppc+0AYBP3K4n4i+BPEVz8P9cjt/C+uTXUlmY41i0ucsSVxjGzmuWUbLlS2PawtSM3CLla8kZ/wfmNje+GbxpzFGscQM4UsFVo+v65q78MLC++If7SUuueHo1n02zu7ZtUaWdztaO58sEEkkk7QQOfwFN8HeFPEyeAbT7T4W8Qx3i2kasp0m4EisIQvAKYJz29q+iv2S/g9ceEfDUt/f6Re6LqOo3RuNQivSo8xkdmj2LjIHzEnP61vRTWljhxklGrPW+p8Cf8FsRn4+eBfX/hGR/wClU9fnYetfWH/BTD496T8ef2m9Qu/D93FqGg6BZx6LaXkOCk/lu7yOrAkOpkkfDDqAO3NfJ55ruPFCv6pz3r+VjBNf1TZzmgD+Vn1r+qiv5WMV/VNkGgD+VgDJoxSjg9Pzr+qTv7mgD+VvB6V/VMDkV/K2D6U0nk8UAJRX9U5OO9Gc0AfysAZoIwa/qlPJr+Vs8np+VAH9U9FFFABRRRQAUUUUAIRmv5WCSa/qn71/KxQADrTiMjPrTQcV/VNjGaAE3Y7V/K2QPWj1r+qbpQB/KyOT1/Ov6pB1xiv5WgcGgnNAH9Up64xX8rZ4PX8qQHFBOTQAA4r+qYjHrX8rNf1TnvQA0nnBFOA46V/Kzmv6pgMUAfysg4Nf093cmr6UT9kZJoh0jnBOPxBBr+YOv6piinqoP4UAefy+K/E6v8thZEDj7r//ABVflYf+C2HxSB58C+ECR7XX/wAer9kWt4m6xofqoo+zxf8APNP++RQB58PF3ignH9n2PPH3X/8Aiq/LH/h9h8Uuv/CDeEPyuv8A49X7H/Z4j/yzT/vkUGCPr5a59cUAfjgP+C13xRI58DeEPptuv/j1B/4LX/FH/oRfCB/4Ddf/AB6vzr3Hmv6o/s8X/PNP++aAPxvH/Ba/4pAf8iL4Q/K6/wDj1eN/Hz/gpf8AGj486BdeH7vULDwtoV3H5V1Y+HoXg89CpV0eR3ZyjBsMu7Bx0xnP76fZ4s58tcj2r+VzPSgD+pjTbNbKBUUcAVdHIBxS4HFfysE5NAH9U5HHSmg4yMU4jNfys5oAXp3pPxr+qYdKWgBMV/K0Dmv6pq/lY9KAHAA1/VGOnSlx0r+VjrQAo69a/qjGTT+tfysE0APxx2xX9UY5HT86/lZyfWgnJoA/qoooooAKKKKACiiigBCQOtAORTWHOfbpX8rZ69KAEAzX9U2c5r+VocHpSngYx+dACetf1TdaYR9eK/lcJ56UAJ1r+qfPWkPTrX8rhI9KAG+tf1T1/KxjNf1TZoACcV/Kziv6pieOtNA5yDQA4dq/lYr+qYHHrX8rJGKACiv6p8+4pCfxoA/lawelf1TA5FfytbsUhYE9KAP6pulfys+lAPPSv6owCKAHjpS0gpaACiv5WM+1LjnpQB/VL1xX8rFf1TA4r+VkjFAH9U/Sv5WCKUHnpX9Ug4zQB/K3g9K/qmByK/lazjIpCcnpQB/VMTgUZBHFfysjr0r+qQcE/SgD+Vr1r+qiv5WMda/qmBzQB/KxX9U571/KxX9U5oA/lYxk0EYNf1SnOc/pX8rR6/4UAf1UUUUUAFFFFABRRRQA1jzzQvQcfnSkZr+VgnJoA/qmPTpX8rhGO9M6V/VP3oA/laHrmmnrX9U5Ga/lYJzQAoHPWv6pAcnpTutfys+lAH9UhPPSv5Wz161/VNgEUAYFAH8rGSK/qmIxX8rNf1T9c0AfytdOaaetf1TkCv5WCc0AL+NA+ua/qnpD0oA/lYNFB60UAKBz1pSPXvX9UpGRX8rOc4oA/qlztxSgkgHFGM4r+VgnJoAAcV/VMRiv5Wa/qn65oA/la98/hTT1r+qcgV/KwTmgD+qc8DpX8rXYGv6pSMjBowKAG7sdqUcgHFLgdO1fysE5NAH9Ux4HT8q/lc9DTAcGjJ9aAP6pgMilHFfysUUALgetf1SbsnGPxpxGRRtHpQB/K106UmPev6p6KACiiigAooooAKKKKAEJA60A5FIy5PXtX8rWR6UAf1T0V/Kx+FH4UAf1T0V/Kx+FH4UAf1T0V/Kx+FL0PIxQB/VL1xX8rFf1TgV/KxQB/VRRX8rH4UfhQB/VN3r+VjpT1PHSv6ox060AKTiv5WSK/qmIyKbgjn9KAP5WsH0oIwafnjtiv6oxwOv50AL0r+Vg0oPPSv6pBwaAP5WqK/qnooAOlfys+lA69K/qkA60AOz0r+VjpTgwGePyr+qUAgdaAP5WK/qn6Zr+VjFf1TE5NACkiv5WCMU4kDimk5NAH9U5OBk0ZFDdK/layMfTvQB/VL1xX8rFf1TLX8rNAABmv6ps5zX8rI6072xQA3GTQRg1/VL36mv5Wzyen5UAf1T0UUUAFFFFABRRRQAnev5WK/qn71/KxQB/VOeB0pAcnGKUjNfysE0Af1T49hRj2FfysUUAf1T4Br+VnNf1T1/Kv6UAf1TFsEcdq/lawPWv6psAjmgDAoAQ8AnFIGz2r+VoHBr+qfGKAGnr0r+Vs8Hr+VJnBoJyaAP6pycCkBJOKUjNfysE0Af1Sng1/K2eD1/KkBxQTk0Af1THgdPyr+Vs9O3NNBwaMkmgD+qcdKWkHSloAa3Q8flSA+gr+VoHBr+qfA6dqAP5WgoOea/qlBJHSjFfysdaAP6p8V/Kzu4r+qev5V+1AATmiiigD+qc80m2v5WaKAP6piSDiv5WSMGgHFBOTQAoHPWv6pAc5Ht1pxGRRgAcUAfys561/VNiv5WPWv6qKACiiigAooooAKKKKAE71/KxX9U/ev5WKAP6qK/lX7V/VOTiv5WSKAEooxRigD+qiv5V/Sv6qK/lX9KAP6p8gDmgHIprDofbpX8rZ69KAEr+qc96/lYxX9U2eaAP5WfWv6qK/lYNf1T0AfyrgZr+qfOa/lYBwaduHSgBPWv6p6/lY61/VNkGgAJwKMgjiv5WQeelf1SDg9+e1AH8rWCTQRg07OARX9UoBAxnNAH8rFf1T9M1/KxX9U5FABkUA5GRX8rWRgj3r+qUDAoACcCjcPWv5WR16V/VHjnrQA/IoByMiv5WuxFf1SjgdfzoACcCjIIr+Vkdelf1SKOf6UAfyt+tf1TdaaVJPWv5WyR6UAIBk0YwaUDnp+df1SD15oAXOMV/KyRinZ46flTTyelAH9VFFFFABRRRQAUUUUAJ3r+Viv6p+9fysUAf1TnmgDFfysUUAf1T49hRj2FfysUUAf1TkkDOM1/KyRjB96QHBoySaAP6p8ZFAAFA6UtACYr+VoHNf1TV/Kx6UAKQMZr+qUHIoxkUAYGBQB/KwBk0u0YzmkBxX9U4GKAP5WRx0NH41/VPRQB/Kxj3pe/Wv6pqQ9KAP5WTX9U9fysetf1T0Afyr1/VOe9fysV/VOe9AH8rIGcn3r+qYEkZxiv5WMkGgnJoA/qnPA6V/K12ByK/qlIyMGjGBQA3v0Nfytng9fypM4NBOTQB/VORx0pFPOMUpGa/lYJoA/qmLEHpX8rRA9aQV/VP0oARuh4/KheTxX8rIODX9U4GKAEJ2mgcgHFKRmv5WCcmgD+qiiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//2Q==\" alt=\"\"></p> \n<p>&nbsp;</p>', NULL, '2021-03-27 00:18:02', 0, NULL, NULL, 'https://www.cnblogs.com/lee2014/p/14584429.html', 0, NULL);
INSERT INTO `t_blog` VALUES (279, '【算法】位运算技巧', '<p>对于仍然不太清楚位操作符的同学们，可以看看这篇文章：<a href=\"https://www.cnblogs.com/blknemo/p/14141417.html\">位操作符</a></p> \n<h1 id=\"特别注意\">特别注意</h1> \n<blockquote> \n <p><strong>特别注意：</strong>使用按位操作符时要注意，相等（==）与不相等（!=）的优先级在按位运算符之上！！！！<br> 这意味着，位运算符的优先级极小，所以使用位运算符时，最好加上括号()</p> \n</blockquote> \n<h1 id=\"重要技巧\">重要技巧</h1> \n<p>基本的操作我就直接略过了。下面是我认为<strong>必须掌握</strong>的技巧：（注意，我把一些生僻的技巧都已经砍掉了，留下来的，就是我认为应该会的）</p> \n<ol> \n <li><p>使用 x &amp; 1 == 1 判断奇偶数。（注意，一些编辑器底层会把用%判断奇偶数的代码，自动优化成位运算）</p></li> \n <li><p>不使用第三个数，交换两个数。x = x ^ y ， y = x ^ y ， x = x ^ y。（早些年喜欢问到，现在如果谁再问，大家会觉得很low）</p></li> \n <li><p>两个相同的数异或的结果是 0，一个数和 0 异或的结果是它本身。（对于找数这块，异或往往有一些别样的用处。）</p></li> \n <li><p>x &amp; (x - 1) ，可以将最右边的 1 设置为 0。（这个技巧可以用来检测 2的幂，或者检测一个整数二进制中 1 的个数，又或者别人问你一个数变成另一个数其中改变了多少个bit位，统统都是它）</p></li> \n <li><p>i+(~i)=-1，i 取反再与 i 相加，相当于把所有二进制位设为1，其十进制结果为-1。</p></li> \n <li><p>对于int32而言，使用 n &gt;&gt; 31取得 n 的正负号。并且可以通过 (n ^ (n &gt;&gt; 31)) - (n &gt;&gt; 31) 来得到绝对值。（n为正，n &gt;&gt; 31 的所有位等于0。若n为负数，n &gt;&gt; 31 的所有位等于1，其值等于-1）</p></li> \n <li><p>使用 (x ^ y) &gt;= 0 来判断符号是否相同。（如果两个数都是正数,则二进制的第一位均为0,x^y=0；如果两个数都是负数,则二进制的第一位均为1；x^y=0 如果两个数符号相反,则二进制的第一位相反,x^y=1。有0的情况例外，^相同得0，不同得1）</p></li> \n <li><p>“异或”是一个无进位加法，说白了就是把进位砍掉。比如01^01=00。</p></li> \n <li><p>“与”可以用来获取进位，比如01&amp;01=01，然后再把结果左移一位，就可以获取进位结果。</p></li> \n</ol> \n<h1 id=\"使用掩码遍历二进制位\">使用掩码遍历二进制位</h1> \n<p>这个方法比较直接。我们遍历数字的 32 位。如果某一位是 1 ，将计数器加一。</p> \n<p>我们使用 位掩码 来检查数字的第 <span class=\"math inline\">\\(i^{th}\\)</span> 位。一开始，掩码 m=1 因为 1 的二进制表示是</p> \n<p><span class=\"math display\">\\[0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0001\\]</span><br> 0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0001</p> \n<p>显然，任何数字跟掩码 11 进行逻辑与运算，都可以让我们获得这个数字的最低位。检查下一位时，我们将掩码左移一位。</p> \n<p><span class=\"math display\">\\[0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0010\\]</span><br> 0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0010</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/e535fe76-9909-4c5f-8644-ea31f25966b0.png\"></p> \n<p>并重复此过程，我们便可依次遍历所有位。</p> \n<p>Java</p> \n<pre><code>public int hammingWeight(int n) {\n    int bits = 0; // 用来储存 1 的个数\n\n    int mask = 1;  // 掩码，从最低位开始\n\n    for (int i = 0; i &lt; 32; i++) {\n        // 注意这里是不等于0，而不是等于1，因为我们的位数是不断在变化的，可能等于2、4、8...\n        // 使用按位操作符时要注意，相等（==）与不相等（!=）的优先级在按位运算符之上！！！！\n        // 使用按位运算符时，最好加上括号()\n        if ((n &amp; mask) != 0) {\n            bits++;\n        }\n        mask &lt;&lt;= 1;\n    }\n    return bits;\n}</code></pre> \n<blockquote> \n <p><strong>注意：</strong>这里判断 n &amp; mask 的时候，千万不要错写成 (n &amp; mask) == 1，因为这里你对比的是十进制数。（我之前就这么写过，记录一下...）</p> \n</blockquote> \n<h1 id=\"无符号右移遍历二进制位\">无符号右移遍历二进制位</h1> \n<p>逐位判断<br> 根据 与运算 定义，设二进制数字 n ，则有：</p> \n<ul> \n <li>若 <span class=\"math inline\">\\(n \\&amp; 1 = 0\\)</span>，则 n 二进制 最右一位 为 00 ；</li> \n <li>若 <span class=\"math inline\">\\(n \\&amp; 1 = 1\\)</span>，则 n 二进制 最右一位 为 11 。</li> \n</ul> \n<p>根据以上特点，考虑以下 循环判断 ：</p> \n<ol> \n <li>判断 n 最右一位是否为 1 ，根据结果计数。</li> \n <li>将 n 右移一位（本题要求把数字 n 看作无符号数，因此使用 无符号右移 操作）。</li> \n</ol> \n<p>算法流程：</p> \n<ol> \n <li>初始化数量统计变量 res = 0。</li> \n <li>循环逐位判断： 当 n = 0 时跳出。</li> \n <li><code>res += n &amp; 1</code> ： 若 <span class=\"math inline\">\\(n \\&amp; 1 = 1\\)</span> ，则统计数 res 加一。</li> \n <li><code>n &gt;&gt;= 1</code> ： 将二进制数字 n 无符号右移一位（ Java 中无符号右移为 \"&gt;&gt;&gt;\" ） 。</li> \n <li>返回统计数量 res。</li> \n</ol> \n<pre><code>public class Solution {\n    public int hammingWeight(int n) {\n        int res = 0;\n        while(n != 0) {\n            res += n &amp; 1;  // 遍历\n            n &gt;&gt;&gt;= 1;  // 无符号右移\n        }\n        return res;\n    }\n}</code></pre> \n<h1 id=\"反转最后一个-1\">反转最后一个 1</h1> \n<p>对于特定的情况，如 只有 1 对我们有用时，我们不需要遍历每一位，我们可以把前面的算法进行优化。</p> \n<p>我们不再检查数字的每一个位，而是不断把数字最后一个 1 反转，并把答案加一。当数字变成 0 的时候偶，我们就知道它没有 1 的位了，此时返回答案。</p> \n<blockquote> \n <p><strong>注意：</strong>这里我们说的是<strong>最后一个 1</strong>，<strong>而不是最后一位 1</strong>，这个 1 可能在任何位上。</p> \n</blockquote> \n<p>这里关键的想法是对于任意数字 n ，将 n 和 n - 1 做与运算，会把最后一个 1 的位变成 0 。为什么？考虑 n 和 n - 1 的二进制表示。</p> \n<p>巧用 <span class=\"math inline\">\\(n \\&amp; (n - 1)\\)</span><br> <span class=\"math inline\">\\((n - 1)\\)</span> 解析： 二进制数字 n 最右边的 1 变成 0 ，此 1 右边的 0 都变成 1 。<br> <span class=\"math inline\">\\(n \\&amp; (n - 1)\\)</span> 解析： 二进制数字 n 最右边的 1 变成 0 ，其余不变。<br> <img src=\"http://localhost:9090/blogImages/2021/03/27/afc8d4b1-2c38-43bc-88ec-61269b34dd48.png\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/dcec3011-bd72-4b11-a59b-156f31a08312.png\"><br> 图片 1. 将 n 和 n-1 做与运算会将最低位的 1 变成 0</p> \n<p>在二进制表示中，数字 n 中最低位的 1 总是对应 n - 1 中的 0 。因此，将 n 和 n - 1 与运算总是能把 n 中最低位的 1 变成 0 ，并保持其他位不变。</p> \n<p>比如下面这两对数：<br> <img src=\"http://localhost:9090/blogImages/2021/03/27/eee9b52c-5c36-4e5d-8363-ca6c866196b8.png\"></p> \n<p>肯定有人又是看的一脸懵逼，我们拿 11 举个例子：（注意最后一位 1 变成 0 的过程）<br> <img src=\"http://localhost:9090/blogImages/2021/03/27/9ca9839d-66b0-421a-b09e-c0c0840f66fb.png\"></p> \n<p>使用这个小技巧，代码变得非常简单。</p> \n<p>Java</p> \n<pre><code>public int hammingWeight(int n) {\n\n    int sum = 0;  // 用来存放 1 的个数\n\n    while (n != 0) {\n        sum++;\n        n &amp;= (n - 1);\n    }\n    return sum;\n}</code></pre> \n<h1 id=\"java内置函数1-的个数\">Java内置函数：1 的个数</h1> \n<pre><code>public int hammingWeight(int n) {\n    return Integer.bitCount(n);\n}</code></pre> \n<h1 id=\"异或相消异或运算的特性\">异或相消（异或运算的特性）</h1> \n<p>我们先来看下异或的数学性质（数学里异或的符号是 <span class=\"math inline\">\\(\\oplus\\)</span>）：</p> \n<ul> \n <li>交换律：<span class=\"math inline\">\\(p \\oplus q = q \\oplus p\\)</span></li> \n <li>结合律：<span class=\"math inline\">\\(p \\oplus (q \\oplus r) = (p \\oplus q) \\oplus r\\)</span></li> \n <li>恒等率：<span class=\"math inline\">\\(p \\oplus 0 = p\\)</span></li> \n <li>归零率：<span class=\"math inline\">\\(p \\oplus p = 0\\)</span></li> \n</ul> \n<p>异或运算有以下三个性质。</p> \n<ol> \n <li>任何数和 0 做异或运算，结果仍然是原来的数，即 <span class=\"math inline\">\\(a \\oplus 0=a\\)</span>。</li> \n <li>任何数和其自身做异或运算，结果是 0，即 <span class=\"math inline\">\\(a \\oplus a=0\\)</span>。</li> \n <li>异或运算满足交换律和结合律，即 <span class=\"math inline\">\\(a \\oplus b \\oplus a=b \\oplus a \\oplus a=b \\oplus (a \\oplus a)=b \\oplus0=b\\)</span>。</li> \n</ol> \n<p>假设数组中有 2m+1 个数，其中有 m 个数各出现两次，一个数出现一次。令 <span class=\"math inline\">\\(a_{1}\\)</span>、<span class=\"math inline\">\\(a_{2}\\)</span>、<span class=\"math inline\">\\(\\ldots\\)</span>…、<span class=\"math inline\">\\(a_{m}\\)</span> 为出现两次的 m 个数，<span class=\"math inline\">\\(a_{m+1}\\)</span> 为出现一次的数。根据性质 3，数组中的全部元素的异或运算结果总是可以写成如下形式：</p> \n<p><span class=\"math display\">\\[(a_{1} \\oplus a_{1}) \\oplus (a_{2} \\oplus a_{2}) \\oplus \\cdots \\oplus (a_{m} \\oplus a_{m}) \\oplus a_{m+1}\\]</span></p> \n<p>根据性质 2 和性质 1，上式可化简和计算得到如下结果：</p> \n<p><span class=\"math display\">\\[0 \\oplus 0 \\oplus \\cdots \\oplus 0 \\oplus a_{m+1}=a_{m+1}\\]</span></p> \n<p>因此，数组中的全部元素的异或运算结果即为数组中只出现一次的数字。</p> \n<p>下面我们来举个例子吧：<br> 假如我们有 [21,21,26] 三个数，是下面这样：<br> <img src=\"http://localhost:9090/blogImages/2021/03/27/aa651ae4-df1c-42aa-a3bc-d460eb9ce15f.png\"></p> \n<p>回想一下，之所以能用“异或”，其实我们是完成了一个 同一位上有 2 个 1 清零 的过程。上面的图看起来可能容易，如果是这样 (下图应为 26^21)：<br> <img src=\"http://localhost:9090/blogImages/2021/03/27/6600ea40-d94f-440d-873a-fae8efe2c132.png\"></p> \n<p>Java</p> \n<pre><code>class Solution {\n    public int singleNumber(int[] nums) {\n        int single = 0;\n        for (int num : nums) {\n            single ^= num;\n        }\n        return single;\n    }\n}</code></pre> \n<h1 id=\"实例\">实例</h1> \n<h2 id=\"位1的个数\"><a href=\"https://leetcode-cn.com/problems/number-of-1-bits/\">位1的个数</a></h2> \n<p>编写一个函数，输入是一个无符号整数（以二进制串的形式），返回其二进制表达式中数字位数为 \'1\' 的个数（也被称为汉明重量）。</p> \n<p>提示：</p> \n<ul> \n <li>请注意，在某些语言（如 Java）中，没有无符号整数类型。在这种情况下，输入和输出都将被指定为有符号整数类型，并且不应影响您的实现，因为无论整数是有符号的还是无符号的，其内部的二进制表示形式都是相同的。</li> \n <li>在 Java 中，编译器使用二进制补码记法来表示有符号整数。因此，在上面的 示例 3 中，输入表示有符号整数 -3。</li> \n</ul> \n<p>进阶：</p> \n<ul> \n <li>如果多次调用这个函数，你将如何优化你的算法？</li> \n</ul> \n<p>示例 1：</p> \n<pre><code>输入：00000000000000000000000000001011\n输出：3\n解释：输入的二进制串 00000000000000000000000000001011 中，共有三位为 \'1\'。</code></pre> \n<p>示例 2：</p> \n<pre><code>输入：00000000000000000000000010000000\n输出：1\n解释：输入的二进制串 00000000000000000000000010000000 中，共有一位为 \'1\'。</code></pre> \n<p>示例 3：</p> \n<pre><code>输入：11111111111111111111111111111101\n输出：31\n解释：输入的二进制串 11111111111111111111111111111101 中，共有 31 位为 \'1\'。</code></pre> \n<p>提示：<br> 输入必须是长度为 32 的 二进制串。</p> \n<hr> \n<h2 id=\"答案\">答案</h2> \n<h3 id=\"方法-1循环和位移动\">方法 1：循环和位移动</h3> \n<p>算法</p> \n<p>这个方法比较直接。我们遍历数字的 32 位。如果某一位是 1 ，将计数器加一。</p> \n<p>我们使用 位掩码 来检查数字的第 <span class=\"math inline\">\\(i^{th}\\)</span> 位。一开始，掩码 m=1 因为 1 的二进制表示是</p> \n<p><span class=\"math display\">\\[0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0001\\]</span><br> 0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0001</p> \n<p>显然，任何数字跟掩码 11 进行逻辑与运算，都可以让我们获得这个数字的最低位。检查下一位时，我们将掩码左移一位。</p> \n<p><span class=\"math display\">\\[0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0000\\ 0010\\]</span><br> 0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0010</p> \n<p>并重复此过程。</p> \n<p>Java</p> \n<pre><code>public int hammingWeight(int n) {\n    int bits = 0;\n    int mask = 1;\n    for (int i = 0; i &lt; 32; i++) {\n        if ((n &amp; mask) != 0) {\n            bits++;\n        }\n        mask &lt;&lt;= 1;\n    }\n    return bits;\n}</code></pre> \n<p>复杂度分析</p> \n<ul> \n <li><p>时间复杂度：<span class=\"math inline\">\\(O(1)\\)</span>。运行时间依赖于数字 n 的位数。由于这题中 n 是一个 32 位数，所以运行时间是 <span class=\"math inline\">\\(O(1)\\)</span> 的。</p></li> \n <li><p>空间复杂度：<span class=\"math inline\">\\(O(1)\\)</span>。没有使用额外空间。</p></li> \n</ul> \n<hr> \n<p>逐位判断<br> 根据 与运算 定义，设二进制数字 n ，则有：</p> \n<ul> \n <li>若 <span class=\"math inline\">\\(n \\&amp; 1 = 0\\)</span>，则 n 二进制 最右一位 为 00 ；</li> \n <li>若 <span class=\"math inline\">\\(n \\&amp; 1 = 1\\)</span>，则 n 二进制 最右一位 为 11 。</li> \n</ul> \n<p>根据以上特点，考虑以下 循环判断 ：</p> \n<ol> \n <li>判断 n 最右一位是否为 1 ，根据结果计数。</li> \n <li>将 n 右移一位（本题要求把数字 n 看作无符号数，因此使用 无符号右移 操作）。</li> \n</ol> \n<p>算法流程：</p> \n<ol> \n <li>初始化数量统计变量 res = 0。</li> \n <li>循环逐位判断： 当 n = 0 时跳出。</li> \n <li><code>res += n &amp; 1</code> ： 若 <span class=\"math inline\">\\(n \\&amp; 1 = 1\\)</span> ，则统计数 res 加一。</li> \n <li><code>n &gt;&gt;= 1</code> ： 将二进制数字 n 无符号右移一位（ Java 中无符号右移为 \"&gt;&gt;&gt;\" ） 。</li> \n <li>返回统计数量 res。</li> \n</ol> \n<pre><code>public class Solution {\n    public int hammingWeight(int n) {\n        int res = 0;\n        while(n != 0) {\n            res += n &amp; 1;  // 遍历\n            n &gt;&gt;&gt;= 1;  // 无符号右移\n        }\n        return res;\n    }\n}</code></pre> \n<h3 id=\"方法-2位操作的小技巧\">方法 2：位操作的小技巧</h3> \n<p>算法</p> \n<p>我们可以把前面的算法进行优化。我们不再检查数字的每一个位，而是不断把数字最后一个 1 反转，并把答案加一。当数字变成 0 的时候偶，我们就知道它没有 1 的位了，此时返回答案。</p> \n<p>这里关键的想法是对于任意数字 n ，将 n 和 n - 1 做与运算，会把最后一个 1 的位变成 0 。为什么？考虑 n 和 n - 1 的二进制表示。</p> \n<p>巧用 <span class=\"math inline\">\\(n \\&amp; (n - 1)\\)</span><br> <span class=\"math inline\">\\((n - 1)\\)</span> 解析： 二进制数字 n 最右边的 1 变成 0 ，此 1 右边的 0 都变成 1 。<br> <span class=\"math inline\">\\(n \\&amp; (n - 1)\\)</span> 解析： 二进制数字 n 最右边的 1 变成 0 ，其余不变。<br> <img src=\"http://localhost:9090/blogImages/2021/03/27/afc8d4b1-2c38-43bc-88ec-61269b34dd48.png\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/dcec3011-bd72-4b11-a59b-156f31a08312.png\"><br> 图片 1. 将 n 和 n-1 做与运算会将最低位的 1 变成 0</p> \n<p>在二进制表示中，数字 n 中最低位的 1 总是对应 n - 1 中的 0 。因此，将 n 和 n - 1 与运算总是能把 n 中最低位的 1 变成 0 ，并保持其他位不变。</p> \n<p>使用这个小技巧，代码变得非常简单。</p> \n<p>Java</p> \n<pre><code>public int hammingWeight(int n) {\n    int sum = 0;\n    while (n != 0) {\n        sum++;\n        n &amp;= (n - 1);\n    }\n    return sum;\n}</code></pre> \n<p>复杂度分析</p> \n<ul> \n <li><p>时间复杂度：<span class=\"math inline\">\\(O(1)\\)</span>。运行时间与 n 中位为 1 的有关。在最坏情况下，n 中所有位都是 1 。对于 32 位整数，运行时间是 <span class=\"math inline\">\\(O(1)\\)</span> 的。</p></li> \n <li><p>空间复杂度：<span class=\"math inline\">\\(O(1)\\)</span>。没有使用额外空间。</p></li> \n</ul> \n<h2 id=\"只出现一次的数字\"><a href=\"https://leetcode-cn.com/problems/single-number\">只出现一次的数字</a></h2> \n<p>给定一个非空整数数组，除了某个元素只出现一次以外，其余每个元素均出现两次。找出那个只出现了一次的元素。</p> \n<p>说明：</p> \n<p>你的算法应该具有线性时间复杂度。 你可以不使用额外空间来实现吗？</p> \n<p>示例 1:</p> \n<pre><code>输入: [2,2,1]\n输出: 1</code></pre> \n<p>示例&nbsp;2:</p> \n<pre><code>输入: [4,1,2,1,2]\n输出: 4</code></pre> \n<hr> \n<h3 id=\"答案-1\">答案</h3> \n<p>方法一：位运算<br> 如果不考虑时间复杂度和空间复杂度的限制，这道题有很多种解法，可能的解法有如下几种。</p> \n<ul> \n <li><p>使用集合存储数字。遍历数组中的每个数字，如果集合中没有该数字，则将该数字加入集合，如果集合中已经有该数字，则将该数字从集合中删除，最后剩下的数字就是只出现一次的数字。</p></li> \n <li><p>使用哈希表存储每个数字和该数字出现的次数。遍历数组即可得到每个数字出现的次数，并更新哈希表，最后遍历哈希表，得到只出现一次的数字。</p></li> \n <li><p>使用集合存储数组中出现的所有数字，并计算数组中的元素之和。由于集合保证元素无重复，因此计算集合中的所有元素之和的两倍，即为每个元素出现两次的情况下的元素之和。由于数组中只有一个元素出现一次，其余元素都出现两次，因此用集合中的元素之和的两倍减去数组中的元素之和，剩下的数就是数组中只出现一次的数字。</p></li> \n</ul> \n<p>上述三种解法都需要额外使用 <span class=\"math inline\">\\(O(n)\\)</span> 的空间，其中 n 是数组长度。</p> \n<p>如何才能做到线性时间复杂度和常数空间复杂度呢？</p> \n<p>答案是使用位运算。对于这道题，可使用异或运算 <span class=\"math inline\">\\(\\oplus\\)</span>。异或运算有以下三个性质。</p> \n<p>任何数和 0 做异或运算，结果仍然是原来的数，即 <span class=\"math inline\">\\(a \\oplus 0=a\\)</span>。<br> 任何数和其自身做异或运算，结果是 0，即 <span class=\"math inline\">\\(a \\oplus a=0\\)</span>。<br> 异或运算满足交换律和结合律，即 <span class=\"math inline\">\\(a \\oplus b \\oplus a=b \\oplus a \\oplus a=b \\oplus (a \\oplus a)=b \\oplus0=b\\)</span>。</p> \n<p>假设数组中有 2m+1 个数，其中有 m 个数各出现两次，一个数出现一次。令 <span class=\"math inline\">\\(a_{1}\\)</span>、<span class=\"math inline\">\\(a_{2}\\)</span>、<span class=\"math inline\">\\(\\ldots\\)</span>…、<span class=\"math inline\">\\(a_{m}\\)</span> 为出现两次的 m 个数，<span class=\"math inline\">\\(a_{m+1}\\)</span> 为出现一次的数。根据性质 3，数组中的全部元素的异或运算结果总是可以写成如下形式：</p> \n<p><span class=\"math display\">\\[(a_{1} \\oplus a_{1}) \\oplus (a_{2} \\oplus a_{2}) \\oplus \\cdots \\oplus (a_{m} \\oplus a_{m}) \\oplus a_{m+1}\\]</span></p> \n<p>根据性质 2 和性质 1，上式可化简和计算得到如下结果：</p> \n<p><span class=\"math display\">\\[0 \\oplus 0 \\oplus \\cdots \\oplus 0 \\oplus a_{m+1}=a_{m+1}\\]</span></p> \n<p>因此，数组中的全部元素的异或运算结果即为数组中只出现一次的数字。</p> \n<p>Java</p> \n<pre><code>class Solution {\n    public int singleNumber(int[] nums) {\n        int single = 0;\n        for (int num : nums) {\n            single ^= num;\n        }\n        return single;\n    }\n}</code></pre> \n<p>复杂度分析</p> \n<ul> \n <li><p>时间复杂度：<span class=\"math inline\">\\(O(n)\\)</span>，其中 n 是数组长度。只需要对数组遍历一次。</p></li> \n <li><p>空间复杂度：<span class=\"math inline\">\\(O(1)\\)</span>。</p></li> \n</ul> \n<h2 id=\"剑指-offer-56---ii.-数组中数字出现的次数-ii\"><a href=\"https://leetcode-cn.com/problems/shu-zu-zhong-shu-zi-chu-xian-de-ci-shu-ii-lcof/\">剑指 Offer 56 - II. 数组中数字出现的次数 II</a></h2> \n<p>在一个数组 nums 中除一个数字只出现一次之外，其他数字都出现了三次。请找出那个只出现一次的数字。</p> \n<p>示例 1：</p> \n<pre><code>输入：nums = [3,4,3,3]\n输出：4</code></pre> \n<p>示例 2：</p> \n<pre><code>输入：nums = [9,1,7,9,7,9,7]\n输出：1</code></pre> \n<h3 id=\"位运算答案\">位运算答案</h3> \n<pre><code>// 虽然位运算很麻烦，但是我也得试试啊\nclass Solution {\n    public int singleNumber(int[] nums) {\n\n        // 位运算有点麻烦\n\n        // 把所有数的二进制位相加，对每一位取余3，那么剩下来的就是我们需要找的数字了\n        int[] counts = new int[32]; // 用来存储答案数字的32位二进制\n        \n        // 遍历数组中的所有数，将他们的二进制位相加，存起来\n        for(int num : nums) {\n            // 从0到31，从低位到高位\n            for(int j = 0; j &lt; 32; j++) {\n                counts[j] += num &amp; 1;\n                num &gt;&gt;&gt;= 1;\n            }\n        }\n\n        // 从高位开始，把每一位二进制 % 3\n        int res = 0;    // 结果答案\n        for(int i = 31; i &gt;= 0; i--) {\n            // 先移位再加个位，就如 sum += sum * 10 + 个位\n            res &lt;&lt;= 1;\n            res |= counts[i] % 3;\n        }\n        return res;\n\n    }\n}</code></pre> \n<h3 id=\"哈希表答案\">哈希表答案</h3> \n<pre><code>class Solution {\n    public int singleNumber(int[] nums) {\n\n        // 位运算有点麻烦\n\n        // 哈希表\n        Map&lt;Integer, Integer&gt; map = new HashMap&lt;&gt;();\n\n        for (int i = 0; i &lt; nums.length; i++) {\n            \n            int count = map.getOrDefault(nums[i], 0) + 1;\n\n            map.put(nums[i], count);\n        }\n\n        for (int i = 0; i &lt; nums.length; i++) {\n            \n            int count = map.getOrDefault(nums[i], 0);\n            if (count == 1) {\n                return nums[i];\n            }\n        }\n\n        return 0;\n    }\n}</code></pre> \n<h2 id=\"两数之和\">两数之和</h2> \n<p>第268题：不使用运算符 + 和 - ，计算两整数 a 、b 之和。<br> <img src=\"http://localhost:9090/blogImages/2021/03/27/cae4f8fc-6593-4920-86d0-8a1d10e1c892.png\"></p> \n<h2 id=\"答案-2\">答案</h2> \n<blockquote> \n <p>位运算的题，大部分都有一些特别的技巧，只要能掌握这些技巧，对其拼装组合，就可以破解一道道的题目。很多人说那些技巧想不到，我觉得是因为没有认真的去学习和记忆。你要相信，基本上所有人最开始都是不会的，只是后来他们通过努力学会了记住了，而你因为没努力一直停留在不会而已。不要觉得那些一眼看到题就能想到解法的人有多么了不起。“无他，唯手熟尔！”</p> \n</blockquote> \n<p>下面这两个技巧大家需要记住，这也是讲解本题的目的：</p> \n<ul> \n <li><p>“异或”是一个无进位加法，说白了就是把进位砍掉。比如01^01=00。</p></li> \n <li><p>“与”可以用来获取进位，比如01&amp;01=01，然后再把结果左移一位，就可以获取进位结果。</p></li> \n</ul> \n<p>根据上面两个技巧，假设有 12+7：<br> <img src=\"http://localhost:9090/blogImages/2021/03/27/71f27394-448b-4307-b0cb-9af5cee2e815.png\"></p> \n<p>根据分析，完成题解：</p> \n<pre><code>//JAVA\nclass Solution {\n    public int getSum(int a, int b){\n        while(b != 0){\n            int temp = a ^ b;\n            b = (a &amp; b) &lt;&lt; 1;\n            a = temp;\n        }\n        return a;\n    }\n}</code></pre> \n<h2 id=\"剑指-offer-65.-不用加减乘除做加法\"><a href=\"https://leetcode-cn.com/problems/bu-yong-jia-jian-cheng-chu-zuo-jia-fa-lcof/\">剑指 Offer 65. 不用加减乘除做加法</a></h2> \n<p>写一个函数，求两个整数之和，要求在函数体内不得使用 “+”、“-”、“*”、“/” 四则运算符号。</p> \n<p>示例:</p> \n<pre><code>输入: a = 1, b = 1\n输出: 2</code></pre> \n<h3 id=\"答案-3\">答案</h3> \n<pre><code>//JAVA\nclass Solution {\n    public int add(int a, int b) {\n        // 该位都为1，&amp;，则进位\n        // 异或运算，^，非进位加\n\n        // 我们使用temp来记录进位的位数二进制\n        // 每次我们都将 非进位和 与 进位二进制 做非进位加法运算，直到没有进位为止（进位为0）\n        while(b != 0) { // 当进位为 0 时跳出\n            int temp = (a &amp; b) &lt;&lt; 1;  // temp = 进位\n            a ^= b; // a = 非进位和\n            b = temp; // b = 进位\n        }\n        return a;\n    }\n}</code></pre>', NULL, '2021-03-27 00:18:04', 0, NULL, NULL, 'https://www.cnblogs.com/blknemo/p/14470610.html', 0, NULL);
INSERT INTO `t_blog` VALUES (280, 'RepVGG', '<p> </p>\n<center>\n <h1>RepVGG: Making VGG-style ConvNets Great Again</h1>\n</center> \n<br> \n<p name=\"top\" id=\"top\" align=\"center\"> <b>作者：</b><b><a href=\"https://www.cnblogs.com/dan-baishucaizi/\">elfin</a></b>&nbsp;&nbsp; <b>资料来源：<a href=\"https://pytorch.org/docs/1.6.0/data.html\">RepVGG论文解析</a></b> </p> \n<p></p> \n<hr> \n<p></p>\n<div class=\"toc\">\n <div class=\"toc-container-header\">\n  目录\n </div>\n <ul>\n  <li><a href=\"#1、摘要\">1、摘要</a></li>\n  <li><a href=\"#2、背景介绍\">2、背景介绍</a></li>\n  <li><a href=\"#3、相关工作\">3、相关工作</a>\n   <ul>\n    <li><a href=\"#31-单分支到多分支\">3.1 单分支到多分支</a></li>\n    <li><a href=\"#32-单分支模型的高效训练\">3.2 单分支模型的高效训练</a></li>\n    <li><a href=\"#33-模型参数重构\">3.3 模型参数重构</a></li>\n    <li><a href=\"#34-winograd威诺格拉德卷积\">3.4 Winograd(威诺格拉德)卷积</a></li>\n   </ul></li>\n  <li><a href=\"#4、由结构参数重构技术构建repvgg\">4、由结构参数重构技术构建RepVGG</a>\n   <ul>\n    <li><a href=\"#41-简单即快速、内存使用经济、灵活\">4.1 简单即快速、内存使用经济、灵活</a></li>\n    <li><a href=\"#42-训练时的多分支结构\">4.2 训练时的多分支结构</a></li>\n    <li><a href=\"#43-推理时的模型参数重构\">4.3 推理时的模型参数重构</a></li>\n    <li><a href=\"#44-结构规格\">4.4 结构规格</a></li>\n   </ul></li>\n </ul>\n</div>\n<p></p> \n<hr> \n<p align=\"right\"> <b><a href=\"#top\">Top</a></b> &nbsp;<b>---</b>&nbsp; <b><a href=\"#bottom\">Bottom</a></b> </p> \n<h2 id=\"1、摘要\">1、摘要</h2> \n<p>​ 我们提出了一种简单而强大的卷积神经网络结构，它具有类似VGG的推理结构，仅由3×3卷积和ReLU组成，而训练模型具有多分支拓扑结构。这种训练和推理结构的解耦是通过一种<strong>结构参数重构技术</strong>(<em>structural <strong>re-p</strong>arameterization</em>)来实现的，因此该模型被命名为RepVGG。在ImageNet上，RepVGG达到了80%以上的top-1精度，据我们所知，这是第一次使用普通模型。在nvidia1080TI gpu上，RepVGG模型的运行速度<strong>比ResNet-50快83%</strong>，<strong>比ResNet-101快101%</strong>，<strong>精度更高</strong>，与EfficientNet和RegNet等最先进的模型相比，显示出良好的精度-速度折衷。</p> \n<p>​ 项目地址：<a href=\"https://github.com/megvii-model/RepVGG\" target=\"_blank\">https://github.com/megvii-model/RepVGG</a></p> \n<p>​ pytorch版本：<a href=\"https://github.com/DingXiaoH/RepVGG\" target=\"_blank\">https://github.com/DingXiaoH/RepVGG</a></p> \n<hr> \n<p align=\"right\"> <b><a href=\"#top\">Top</a></b> &nbsp;<b>---</b>&nbsp; <b><a href=\"#bottom\">Bottom</a></b> </p> \n<h2 id=\"2、背景介绍\">2、背景介绍</h2> \n<p>​ 卷积神经网络（ConvNets）已成为解决许多问题的主流方法。VGG在图像识别方面取得了巨大的成功，但是它仅使用了一个由conv、ReLU和pooling组成的简单体系结构。随着<strong>Inception</strong>、<strong>ResNet</strong>和<strong>DenseNet</strong>的出现，许多研究兴趣转移到了设计良好的体系结构上，使得模型变得越来越复杂。最近一些强大的架构是通过自动或手动的架构搜索，或者在一个基本架构上搜索一个复合缩放策略来获得的。</p> \n<p>​ 虽然许多复杂的卷积网络比简单的卷积网络提供更高的精度，但缺点是显著的：</p> \n<ul> \n <li>(1) <strong>复杂的多分支设计</strong>（如ResNet中的残差分支 和 Inception中的分支级联）使得模型难以实现和定制，降低了推理速度，降低了内存利用率。</li> \n <li>(2) <strong>一些组件增加了内存访问成本，并且缺乏对各种设备的支持</strong>（例如，Xception和MobileNets 中的depthwise 以及ShuffleNets中的通道shuffle。</li> \n</ul> \n<p>​ 由于影响推理速度的因素很多，浮点运算（FLOPs）的数量并不能准确反映实际速度。尽管一些新的模型比老式的VGG和ResNet有更低的浮点运算，但是他们可以运行速度并不快。下表展示了运行速度的变换：</p> \n<p>​ <img src=\"http://localhost:9090/blogImages/2021/03/27/152dd857-2dab-4b36-af29-fd9c33f631f6.png\" width=\"500\"></p> \n<p>因此，VGG和ResNets的原始版本仍然大量用于学术界和工业界的实际应用。</p> \n<p>​ 在本文中，我们提出了RepVGG，这是一种VGG风格的结构，它优于许多复杂的模型，如图所示：</p> \n<p>​ <img src=\"http://localhost:9090/blogImages/2021/03/27/363f3e99-3e66-421d-8907-ad7acaffb885.png\" width=\"600\"></p> \n<p>RepVGG的优点有：</p> \n<ul> \n <li>该模型有一个类似VGG的拓扑结构，没有任何分支。也就是说，每一层都将其前一层的输出作为输入，并将输出输入到其后一层。</li> \n <li>模型仅使用 <span class=\"math inline\">\\(3 \\times 3\\)</span> 的卷积结构和<span class=\"math inline\">\\(ReLU\\)</span>激活。</li> \n <li>具体的架构（包括特定的深度和层宽度）是没有自动搜索、手动细化、复合缩放，也没有其他繁重设计的实例化。</li> \n</ul> \n<p>​ 普通模型要达到与多分支体系结构相当的性能水平是一个挑战。一种解释是，多分支拓扑（例如ResNet）使模型成为许多较浅模型的隐式集合，因此训练多分支模型可以避免梯度消失问题。</p> \n<p>​ 由于<strong>多分支结构的优点都是用于训练，缺点是不希望用于推理</strong>，因此我们提出通过<strong>结构参数重构</strong>将训练多分支结构和推理结构解耦，即通过参数转换将结构从一个结构转换为另一个结构。具体而言，网络结构与一组参数耦合，例如，conv层由四阶核张量表示。如果某个结构的参数可以转换成另一个结构耦合的另一组参数，就可以等价地用后者代替前者，从而改变整个网络结构。</p> \n<p>​ 具体地说，我们使用identity和1×1分支构造RepVGG的训练结构，这是受ResNet启发的，但不同的方法是通过<strong>结构参数重构</strong>去除分支（如下图所示）。经过训练后，我们用简单代数进行变换，因为一个恒等分支可以看作退化的1×1变换，后者可以进一步看作退化的3×3变换，所以我们可以用原3×3核的训练参数构造一个3×3核，identity分支和1×1分支和批量规范化（BN）层。因此，转换后的模型是一个3×3 conv层的堆栈，可以保存以供测试和部署。</p> \n<p>​ <img src=\"http://localhost:9090/blogImages/2021/03/27/5a5b8a37-0422-4d78-b11d-999b582ac998.png\" width=\"500\"></p> \n<p>​ <img src=\"http://localhost:9090/blogImages/2021/03/27/0a8b4863-8766-4399-8477-890358963d09.png\" width=\"500\"></p> \n<p>​ 值得注意的是，RepVGG的推理主体只涉及一种操作类型：3×3 conv，然后是ReLU，这使得RepVGG在gpu等通用计算设备上运行得很快。更好的是，RepVGG允许专用硬件实现更高的速度，因为考虑到芯片大小和功耗，我们需要的操作类型越少，我们可以集成到芯片上的计算单元就越多。即，专门用于RepVGG的推理芯片可以具有大量的3×3-ReLU单元和更少的存储器单元（因为普通拓扑是存储器经济的，如图3所示）。我们的贡献总结如下：</p> \n<ul> \n <li>我们提出了RepVGG，这是一种简单的体系结构，与现有技术相比，它具有良好的速度精度折衷。</li> \n <li>我们提出使用结构参数重构来将训练多分支拓扑与推理结构解耦。</li> \n <li>我们已经证明了RepVGG在图像分类和语义分割方面的有效性，以及它的效率和易实现性。</li> \n</ul> \n<p>​ <img src=\"http://localhost:9090/blogImages/2021/03/27/1bd59442-5696-4517-87bb-8d9d6bd61622.png\" width=\"500\"></p> \n<hr> \n<p align=\"right\"> <b><a href=\"#top\">Top</a></b> &nbsp;<b>---</b>&nbsp; <b><a href=\"#bottom\">Bottom</a></b> </p> \n<h2 id=\"3、相关工作\">3、相关工作</h2> \n<h3 id=\"31-单分支到多分支\">3.1 单分支到多分支</h3> \n<p>​ VGG网络在ImgNet竞赛中获得最优的性能后，许多新的创新将其精确度进一步提高。如：GoogLeNet、Inception采用多分支结构； ResNet使用了简单的二分支结构；DenseNet通过连接低层和多个高层，使得拓扑结构更加复杂。<strong>神经结构搜索（NAS）</strong>和人工设计空间设计可以产生性能更高的网络，但代价是巨大的计算资源或人力。一些大版本的NAS生成模型甚至不能在普通gpu上训练，因此限制了其应用。除了实现的不便外，复杂模型也会降低并行度，从而降低推理速度。</p> \n<hr> \n<p align=\"right\"> <b><a href=\"#top\">Top</a></b> &nbsp;<b>---</b>&nbsp; <b><a href=\"#bottom\">Bottom</a></b> </p> \n<h3 id=\"32-单分支模型的高效训练\">3.2 单分支模型的高效训练</h3> \n<p>​ 有人试图训练没有分支的网络。然而，以往的工作主要是为了使非常深的模型收敛到合理的精度，但并没有取得比复杂模型更好的性能。因此，这些方法和模型既不简单，也不实用。<strong>例如</strong>，提出了一种初始化方法来训练极深的平面网络。采用基于平均场理论的训练方案，在MNIST上训练了10000层网络，训练精度达到99%，在CIFAR-10上训练精度达到82%。尽管这些模型并不实用（即使LeNet-5在MNIST上的准确率也能达到99.3%，VGG-16在CIFAR-10上的准确率也能达到93%以上），但其理论贡献是深刻的。最近的一项工作[24]结合了几种技术，包括 Leaky ReLU、最大范数和谨慎初始化。在ImageNet上，一个具有147M参数的普通ConvNet可以达到74.6%的top-1精度，比其报告的基线（ResNet-101，76.6%，45M参数）低2%。值得注意的是，本文不仅证明了普通模型可以很好地收敛，而且不打算像resnet那样训练极深的convnet。相反，我们的目标是<strong>建立一个具有合理深度和良好精度-速度权衡的简单模型，该模型可以简单地用最常见的组件（如正则conv和BN）和简单代数实现</strong>。</p> \n<hr> \n<p align=\"right\"> <b><a href=\"#top\">Top</a></b> &nbsp;<b>---</b>&nbsp; <b><a href=\"#bottom\">Bottom</a></b> </p> \n<h3 id=\"33-模型参数重构\">3.3 模型参数重构</h3> \n<p>​ DiracNet[38]是一种与我们相关的参数重构方法。它通过把一个卷积层的卷积核编码为：</p> \n<p></p>\n<div class=\"math display\">\n \\[\\hat{W} = diag(\\vec{a})I + diag(\\vec{b})W_{norm} \\]\n</div>\n<p></p>\n<p>其中<span class=\"math inline\">\\(\\hat{W}\\)</span> 是卷积的最终权重，是一个四阶的张量矩阵；<span class=\"math inline\">\\(W_{norm}\\)</span> 是标准化的kernel，<span class=\"math inline\">\\(\\vec{a}\\)</span>、<span class=\"math inline\">\\(\\vec{b}\\)</span> 是需要学习的向量。与残差神经网络相比，在性能方面，DiracNet在CIFAR-100数据集上要低 <span class=\"math inline\">\\(2.29\\%\\)</span> ，ImageNet数据集上要低<span class=\"math inline\">\\(0.62\\%\\)</span>。</p> \n<p>DiracNet模型与<strong>RepVGG</strong>的差异为：</p> \n<ul> \n <li>我们的<strong>结构参数重构</strong>是通过一个具体结构的实际数据流来实现的，这个具体结构以后可以转换成另一个结构，而DiracNet仅仅使用另一个转换核的数学表达式，以便于优化。也就是说，一个结构参数重构的平面模型是一个实时训练的多分支模型，而DiracNet不是。</li> \n <li>DiracNet的性能高于通常参数化的普通模型，但低于可比较的ResNet，而RepVGG模型的性能远远优于ResNet。</li> \n</ul> \n<p>​ Asym Conv Block（ACB）[9]采用非对称Conv来加强规则Conv的“骨架”，这可以看作是结构参数重构的另一种形式，因为它将训练的块转换为Conv。与我们的方法相比，不同之处在于，ACB是为组件级改进而设计的，并在任何体系结构中用作conv层的替换，而我们的结构重新参数化对于训练普通convnet非常关键，如第4.2节所示。</p> \n<hr> \n<p align=\"right\"> <b><a href=\"#top\">Top</a></b> &nbsp;<b>---</b>&nbsp; <b><a href=\"#bottom\">Bottom</a></b> </p> \n<h3 id=\"34-winograd威诺格拉德卷积\">3.4 Winograd(威诺格拉德)卷积</h3> \n<p>​ RepVGG只使用3×3 conv，因为它在GPU和CPU上都被一些现代计算库（如NVIDIA cuDNN[1]和Intel MKL[16]）高度优化。下表显示了在1080TI GPU上用cudnn7.5.0测试的理论FLOPS、实际运行时间和计算密度（以每秒Tera(兆兆)浮点运算（TFLOPS）为单位）。结果表明，3×3conv的理论计算密度约为4倍，表明理论总的FLOPs数不能代表不同体系结构的实际速度。</p> \n<img src=\"http://localhost:9090/blogImages/2021/03/27/319e2403-374a-46e6-b9f6-8939efb6a364.png\" width=\"500\"> \n<p>加速3×3 conv的一个经典算法是<strong>Winograd算法[18]</strong>（仅当步长为1时），它得到了cuDNN和MKL等库的良好支持（默认情况下启用）。例如，使用标准<span class=\"math inline\">\\(F(2 \\times 2, 3 \\times 3)\\)</span>的Winograd，3×3 conv的乘法量（mul）减少到原来的<span class=\"math inline\">\\(\\frac{4}{9}\\)</span>。由于乘法要比加法耗时得多，所以我们计算Muls来度量Winograd支持下的计算开销(后面会提到)。请注意，特定的计算库和硬件决定是否对每个操作符使用Winograd，因为小规模的卷积可能不会由于内存开销而加速。</p> \n<hr> \n<p align=\"right\"> <b><a href=\"#top\">Top</a></b> &nbsp;<b>---</b>&nbsp; <b><a href=\"#bottom\">Bottom</a></b> </p> \n<h2 id=\"4、由结构参数重构技术构建repvgg\">4、由结构参数重构技术构建RepVGG</h2> \n<h3 id=\"41-简单即快速、内存使用经济、灵活\">4.1 简单即快速、内存使用经济、灵活</h3> \n<p>使用简单convnet至少有三个原因：它们速度快、内存经济且灵活。</p> \n<p><strong>Fast</strong> 许多最近的多分支架构的<strong>理论 FLOPs比VGG低</strong>，<strong>但</strong>可能<strong>运行得不快</strong>。 VGG-16的 FLOPs是EffificientNet-B3的8.4倍，但是运行速度却是其1.8倍，这意味着前者的计算密度为后者的15倍。除了Winograd conv带来的加速外，FLOPs和速度之间的差异可归因于两个重要因素，它们对速度有相当大的影响，但FLOPs没有考虑到这两个因素：内存访问成本（MAC）和并行度[23]。如：虽然所需的分支加法或级联计算可以忽略不计，但MAC是重要的。此外，MAC在分组卷积中占很大一部分时间。另一方面，在相同的FLOPs条件下，一个高并行度的模型比另一个低并行度的模型要快得多。由于多分支拓扑结构被广泛应用于初始和自动生成的体系结构中，因此使用多个小的操作符来代替几个大的操作符。先前的一项工作[23]报告说，NASNET-A[42]中的分段运算符（即单个conv或池操作在一个构建块中的数目）为13，这对GPU等具有强大并行计算能力的设备不友好，并引入额外的开销，如内核启动和同步。相反，在resnet中，这个数字是2或3，我们将它设为1：单个conv。</p> \n<p><strong>Memory-economical</strong> 多分支拓扑的内存效率很低，因为每个分支的结果都需要保留到加法或级联之后，这大大提高了内存占用的峰值。剩余块的输入需要保持，直到添加为止。假设块保持特征图大小，则内存占用峰值为输入的两倍。相反，普通拓扑允许在操作完成时立即释放特定层的输入占用的内存。在设计专用硬件时，一个普通的ConvNet允许深度内存优化并降低内存单元的成本，这样我们就可以将更多的计算单元集成到芯片上。</p> \n<p><strong>Flexible</strong> 多分支拓扑对体系结构规范施加了约束。ResNet要求conv层被组织为<strong>残差块</strong>，这限制了灵活性，因为每个残差块的最后一个conv层必须产生相同形状的张量，否则快捷加法就没有意义。更糟的是，<strong>多分支拓扑限制了channel修剪[20,12]的应用，这是一种去除一些不重要通道的实用技术，一些方法可以通过自动发现每层的适当宽度来优化模型结构[7]</strong>。然而，<strong>多分支模型使得剪枝变得棘手</strong>，并导致性能显著下降或加速比低[6，20，8]。相反，简单的体系结构允许我们根据需求自由配置每个conv层，并进行删减以获得更好的性能效率权衡。</p> \n<hr> \n<p align=\"right\"> <b><a href=\"#top\">Top</a></b> &nbsp;<b>---</b>&nbsp; <b><a href=\"#bottom\">Bottom</a></b> </p> \n<h3 id=\"42-训练时的多分支结构\">4.2 训练时的多分支结构</h3> \n<p>​ 普通网络有很多优点，但有一个致命的缺点：性能差。例如，有了像BN[17]这样的现代组件，VGG-16可以在ImageNet上达到72%以上的top-1精度，这似乎已经过时了。我们的结构参数重构方法受到ResNet的启发，它显式地构造一个快捷分支，将信息流建模为<span class=\"math inline\">\\(y = x + f(x)\\)</span>，并使用一个残差块来学习<span class=\"math inline\">\\(f\\)</span>。当 <span class=\"math inline\">\\(x\\)</span>与<span class=\"math inline\">\\(f(x)\\)</span>的维度不一样时，公式变为<span class=\"math inline\">\\(y=g(x)+f(x)\\)</span>，<span class=\"math inline\">\\(g(x)\\)</span>是一个<span class=\"math inline\">\\(1 \\times 1\\)</span>的卷积。resnet成功的一个解释是，这种多分支架构使模型成为众多较浅模型的隐式集合[35]。特别地，对于n个块，模型可以解释为2n个模型的集合，因为每个块将流分支成两条路径。由于多分支拓扑在推理上有缺陷，但分支似乎有利于训练[35]，我们使用多个分支来对众多模型进行训练的集成。</p> \n<p>​ 为了使大多数成员更浅或更简单，我们使用ResNet-like恒等式（仅当维度匹配时）和<span class=\"math inline\">\\(1×1\\)</span>分支，使得构建块训练时的信息流为</p> \n<p></p>\n<div class=\"math display\">\n \\[y=x+g(x)+f(x) \\]\n</div>\n<p></p>\n<p>我们简单地堆叠几个这样的区块来建构训练时间模型。(注意，这样信息流中的结构在每层都一样，运算的时候就更快了)</p> \n<p>​ 从与[35]相同的角度来看，模型变成了一个由n个block生成的<span class=\"math inline\">\\(3^{n}\\)</span>个成员组成的集合。<strong>训练后等价地转化为<span class=\"math inline\">\\(y=h(x)\\)</span>，其中h由一个conv层实现，其参数通过训练后的一系列代数参数导出。</strong></p> \n<hr> \n<p align=\"right\"> <b><a href=\"#top\">Top</a></b> &nbsp;<b>---</b>&nbsp; <b><a href=\"#bottom\">Bottom</a></b> </p> \n<h3 id=\"43-推理时的模型参数重构\">4.3 推理时的模型参数重构</h3> \n<p>​ 这里我们将介绍把<span class=\"math inline\">\\(y=x+g(x)+f(x)\\)</span>结构转换为<span class=\"math inline\">\\(y=h(x)\\)</span>结构。需要注意的是每一个分支在合并(相加)之前都使用了BN层。</p> \n<p>一般地，我们假设输入channel为<span class=\"math inline\">\\(C_{1}\\)</span>，输出通道为<span class=\"math inline\">\\(C_{2}\\)</span>，则<span class=\"math inline\">\\(3 \\times 3\\)</span>的卷积核的权值矩阵为：</p> \n<p></p>\n<div class=\"math display\">\n \\[W^{(3)} \\in \\mathbb{R}^{C_{2} \\times C_{1} \\times 3 \\times 3} \\]\n</div>\n<p></p>\n<p>对于<span class=\"math inline\">\\(1 \\times 1\\)</span>的分支， <span class=\"math inline\">\\(1 \\times 1\\)</span>的卷积核的权值矩阵为：</p> \n<p></p>\n<div class=\"math display\">\n \\[W^{(1)} \\in \\mathbb{R}^{C_{2} \\times C_{1}} \\]\n</div>\n<p></p>\n<p>我们使用<span class=\"math inline\">\\(\\boldsymbol{\\mu}^{(3)}, \\boldsymbol{\\sigma}^{(3)},\\boldsymbol{\\gamma}^{(3)}, \\boldsymbol{\\beta}^{(3)}\\)</span>分别表示<span class=\"math inline\">\\(3 \\times 3\\)</span>之后BN层的累计均值、标准差、缩放因子、偏置；</p> \n<p>我们使用<span class=\"math inline\">\\(\\boldsymbol{\\mu}^{(1)}, \\boldsymbol{\\sigma}^{(1)},\\boldsymbol{\\gamma}^{(1)}, \\boldsymbol{\\beta}^{(1)}\\)</span>分别表示<span class=\"math inline\">\\(1 \\times 1\\)</span>之后BN层的累计均值、标准差、缩放因子、偏置；</p> \n<p>我们使用<span class=\"math inline\">\\(\\boldsymbol{\\mu}^{(0)}, \\boldsymbol{\\sigma}^{(0)},\\boldsymbol{\\gamma}^{(0)}, \\boldsymbol{\\beta}^{(0)}\\)</span>分别表示identity分支的累计均值、标准差、缩放因子、偏置；</p> \n<p>令<span class=\"math inline\">\\(M^{(1)} \\in \\mathbb{R}^{N\\times C_{1}\\times H_{1}\\times W_{1}}\\)</span>表示输入，<span class=\"math inline\">\\(M^{(2)} \\in \\mathbb{R}^{N\\times C_{2}\\times H_{2}\\times W_{2}}\\)</span>表示输出。<span class=\"math inline\">\\(*\\)</span>表示卷积操作。</p> \n<p>如果<span class=\"math inline\">\\(C_{1}=C_{2}, H_{1}=H_{2}, W_{1}=W_{2}\\)</span>，则有：</p> \n<p></p>\n<div class=\"math display\">\n \\[\\begin{equation} \\begin{aligned} M^{(2)} = BN(M^{(1)} * W^{(3)}, \\boldsymbol{\\mu}^{(3)}, \\boldsymbol{\\sigma}^{(3)},\\boldsymbol{\\gamma}^{(3)}, \\boldsymbol{\\beta}^{(3)}) + BN(M^{(1)} * W^{(1)}, \\boldsymbol{\\mu}^{(1)}, \\boldsymbol{\\sigma}^{(1)},\\boldsymbol{\\gamma}^{(1)}, \\boldsymbol{\\beta}^{(1)}) + BN(M^{(1)}, \\boldsymbol{\\mu}^{(0)}, \\boldsymbol{\\sigma}^{(0)},\\boldsymbol{\\gamma}^{(0)}, \\boldsymbol{\\beta}^{(0)}) \\end{aligned} \\end{equation} \\]\n</div>\n<p></p>\n<p>否则，我们简单地不使用恒等映射分支，因此上面的方程只有前两项。对<span class=\"math inline\">\\(\\forall 1\\leq i\\leq C_{2}\\)</span>:</p> \n<p></p>\n<div class=\"math display\">\n \\[BN(M,\\boldsymbol{\\mu}, \\boldsymbol{\\sigma}, \\boldsymbol{\\gamma}, \\boldsymbol{\\beta})_{:,i,:,:}=(M_{:,i:,:}-\\boldsymbol{\\mu}_{i}) \\frac{\\boldsymbol{\\gamma}_{i}}{\\boldsymbol{\\sigma}_{i}} + \\boldsymbol{\\beta}_{i} \\]\n</div>\n<p></p>\n<p>我们首先将每一个BN及其前一个conv层转换为带有偏置向量的conv。令<span class=\"math inline\">\\(\\left \\{{W}\',{\\boldsymbol{b}}\' \\right \\}\\)</span>表示从<span class=\"math inline\">\\(\\left \\{W,\\boldsymbol{\\mu}, \\boldsymbol{\\sigma}, \\boldsymbol{\\gamma}, \\boldsymbol{\\beta} \\right \\}\\)</span>转换的kernel和bias，则有：</p> \n<p></p>\n<div class=\"math display\">\n \\[W_{i,:,:,:}^{\'}=\\frac{\\boldsymbol{\\gamma}_{i}}{\\boldsymbol{\\sigma}_{i}}W_{i,:,:,:}\\quad, \\quad{\\boldsymbol{b}}\'_{i}= \\frac{\\boldsymbol{-\\boldsymbol{\\mu}_{i}\\gamma}_{i}}{\\boldsymbol{\\sigma}_{i}} + \\boldsymbol{\\beta}_{i} \\]\n</div>\n<p></p>\n<p>因此，容易验证对<span class=\"math inline\">\\(\\forall 1\\leq i\\leq C_{2}\\)</span>:</p> \n<p></p>\n<div class=\"math display\">\n \\[BN(M* W, \\boldsymbol{\\mu}, \\boldsymbol{\\sigma},\\boldsymbol{\\gamma}, \\boldsymbol{\\beta})_{:,i,:,:}= (M*{W}\')_{:,i,:,:} + {\\boldsymbol{b}}\'_{i} \\]\n</div>\n<p></p>\n<p>上述变换也适用于identity分支，因为<strong>identity 特征图</strong>可以看作是以单位矩阵为核的1×1变换。在这样的变换之后，我们将有一个3×3核、两个1×1核和三个偏置向量。然后我们将三个偏差向量相加得到最终偏差，将1×1的核加到3×3核的中心点得到最终的3×3核，这很容易实现，首先将两个1×1核置零到3×3，然后将三个核相加，如下图所示。注意，这种变换的等价性要求3×3和1×1层具有相同的步幅，并且后者的填充配置应比前者少一个像素。例如，对于将输入填充一个像素的3×3层（这是最常见的情况），1×1层的填充应为0。</p> \n<img src=\"http://localhost:9090/blogImages/2021/03/27/1e94b28d-73e3-42d7-8dcd-fa8590d4e1ed.png\" width=\"500\"> \n<hr> \n<p align=\"right\"> <b><a href=\"#top\">Top</a></b> &nbsp;<b>---</b>&nbsp; <b><a href=\"#bottom\">Bottom</a></b> </p> \n<h3 id=\"44-结构规格\">4.4 结构规格</h3> \n<p>​ 下表展示了RepVGG的规格，包括深度和宽度。RepVGG是VGG风格的平面网络，且大量使用<span class=\"math inline\">\\(3 \\times 3\\)</span>的卷积，但是没有像VGG网络那样使用最大池化，因为设计这种网络只使用一种操作，可以加快运行速度。所有的stage都使用Repblock替换了<span class=\"math inline\">\\(3 \\times 3\\)</span>的卷积，每层的第一个卷积操作，进行下采样。对于图像分类，使用全局平均池化接全连接层，作为head。对于其他任务，任务特定的头可以用所有层生成的特征。</p> \n<img src=\"http://localhost:9090/blogImages/2021/03/27/e59dcc26-2590-42e5-ad46-55a253f494e2.png\" width=\"500\"> \n<p>关于每个stage的layer数量，主要由如下的三个原则确定：</p> \n<ul> \n <li>第一级的分辨率很高，非常耗时，因此我们只使用一层来降低延迟。</li> \n <li>最后一级应该有更多的通道，所以我们只使用一层来保存参数。</li> \n <li>我们将大多数层放在倒数第二个stage（在ImageNet上具有<span class=\"math inline\">\\(14 \\times 14\\)</span>的输出分辨率），跟随ResNet及其最新变体。（如，ResNet-101使用了69个layer在<span class=\"math inline\">\\(14 \\times 14\\)</span>的阶段）</li> \n</ul> \n<p>最后，我们对5个stage的层数分配是：[1, 2, 4, 14, 1]，并命名为<strong>RepVGG-A</strong>。我们也构建了一个更深的<strong>RepVGG-B</strong>，在stage2、stage3、stage4都增加了2层。</p> \n<p>​ <strong>RepVGG-A</strong>用于和其他轻量级的模型进行比较；<strong>RepVGG-B</strong>用于和<strong>ResNet-18/34/50</strong>这种中等体量的模型进行比较 。当然<strong>RepVGG-B</strong>取得了更好的性能表现。</p> \n<p>​ 我们通过均匀缩放经典宽度设置[64、128、256、512]来确定层宽度。我们使用乘数a来缩放前四个阶段，b来缩放最后一个阶段，并且通常设置b&gt;a，因为我们希望最后一层对于分类或其他下游任务具有更丰富的特征。<strong>由于RepVGG在最后一个阶段只有一个层，因此较大的b不会显著增加延迟或参数量。具体地 stage2、3、4、5的宽度分别为[64a、128a、256a、512b]</strong>。</p> \n<p>​ 为了避免大特征图上的大卷积，如果<span class=\"math inline\">\\(a &lt; 1\\)</span>，我们缩小stage1，但不放大它，因此stage1的宽度是<span class=\"math inline\">\\(min\\left ( 64, 64a \\right )\\)</span>。</p> \n<p>​ 为了进一步减少参数和计算量，我们可以选择将分组的3×3 conv层与密集的conv层交错，以精度换取效率。具体来说，我们为RepVGG-A的第3、5、7、…、21层以及RepVGG-B的附加第23、25和27层设置groups数目为<span class=\"math inline\">\\(g\\)</span>。为了简单起见，我们将<span class=\"math inline\">\\(g\\)</span>全局设置为1、2或4，没有按层调整。我们不使用相邻的groupwise conv层，因为这将禁用通道间的信息交换并带来副作用：某个通道的输出只能从输入通道的一小部分中导出。注意，1×1分支应具有与3×3 conv相同的groups数目为<span class=\"math inline\">\\(g\\)</span>。</p> \n<hr> \n<p align=\"right\"> <b><a href=\"#top\">Top</a></b> &nbsp;<b>---</b>&nbsp; <b><a href=\"#bottom\">Bottom</a></b> </p> \n<p name=\"bottom\" id=\"bottom\"> <b>完</b> </p>', NULL, '2021-03-27 00:18:06', 0, NULL, NULL, 'https://www.cnblogs.com/dan-baishucaizi/p/14567123.html', 0, NULL);
INSERT INTO `t_blog` VALUES (281, '干掉前端！3分钟纯 Java 注解搭个管理系统', '<p>大家好，我是小富~</p> \n<p>最近接触到个新项目，发现它用了一个比较有意思的框架，可以说实现了我刚入行时候的梦想，所以这里马不停蹄的和大家分享下。</p> \n<p>在我刚开始工作接触的项目都还没做前后端分离，经常需要后端来维护页面，有时候觉得自己好像天生不适合干前端，你要是让我研究研究后端的技术，看个中间件源码啊，分析分析什么框架底层原理啊，这都问题不大，偶尔搞一下<code>JS</code>也可以。你要是让我写个<code>css</code>样式，那简直要命了，一点也提不起兴趣，不知道有没有跟我一样的。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/397e4fa7-6c54-4b61-93f8-50603b330ef9.png\" alt=\"\" loading=\"lazy\"></p> \n<p>今天要介绍的框架直接不用写页面了，话不多说，下边咱们直奔主题</p> \n<p><code>Erupt</code>一个通用后台管理框架，据说有 <strong>超低代码量</strong>、 <strong>零前端代码</strong>、<strong>零 CURD操作</strong>、<strong>无需建表</strong>，<strong>纯Java注解开发</strong>等特色，号称三分钟就可以搭建一个完整的后台管理系统。</p> \n<p>额~ 听着好像还挺流批的，到底是不是有这么魔幻，咱们一起用起来感受下。</p> \n<p>首先来搭建一下环境，目前<code>Erupt</code>支持<code>Java</code>版本<code>1.8.0</code>及以上、<code>Spring Boot</code>版本<code>2.0</code>及其以上。</p> \n<p><strong>搭建easy</strong></p> \n<p><code>pom.xml</code>引入必要的<code>jar</code>包</p> \n<pre><code class=\"language-xml\">    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;mysql&lt;/groupId&gt;\n            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;!--用户权限管理--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;xyz.erupt&lt;/groupId&gt;\n            &lt;artifactId&gt;erupt-upms&lt;/artifactId&gt;\n            &lt;version&gt;1.6.7&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;!--接口数据安全--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;xyz.erupt&lt;/groupId&gt;\n            &lt;artifactId&gt;erupt-security&lt;/artifactId&gt;\n            &lt;version&gt;1.6.7&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;!--后台WEB界面--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;xyz.erupt&lt;/groupId&gt;\n            &lt;artifactId&gt;erupt-web&lt;/artifactId&gt;\n            &lt;version&gt;1.6.7&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;\n            &lt;scope&gt;compile&lt;/scope&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n</code></pre> \n<p><code>application.yml</code> 文件只要简单配置数据源就好，提前准备个数据库，说到数据库这里我说个小插曲。</p> \n<p>我之前在<code>Github</code> 提交案例代码的时候（<code>https://github.com/chengxy-nds/Springboot-Notebook</code> ），由于没太注意没屏蔽敏感信息，导致云数据库账号泄露了，最近我发现已经有小伙伴在数据库上跑项目了，仔细看了看里边的数据结构，发现像是个毕设项目。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/069ed5bf-8c6c-431c-bcc2-f8e2dc32e876.png\" alt=\"\" loading=\"lazy\"></p> \n<p>本身这个库就是我跑<code>demo</code>案例的一个测试库，为的就是让小伙伴能把更多时间放在研究案例的技术点上，减少搭建环境这种没技术含量的琐碎事。</p> \n<p>发现归发现，这里我没改密码，也没删他们的库，如果你要用就继续用着，但玩归玩，闹归闹，<strong>你不能乱动不是你的数据</strong>！影响其他人学习就不好了。</p> \n<pre><code class=\"language-java\">spring:\n  datasource:\n    url: jdbc:mysql://47.93.6.5:3306/erupt2?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai\n    username: root\n    password: 123456\n  jpa:\n    show-sql: true\n    generate-ddl: true\n    database-platform: org.hibernate.dialect.MySQL5InnoDBDialect\n    database: mysql\n  profiles:\n    active: dev\n  mail:\n    username: xxxx@qq.com\n    password: xxxxxxx\n    host: smtp.qq.com\n    properties:\n      mail.smtp.ssl.auth: true\n      mail.smtp.ssl.enable: true\n      mail.smtp.ssl.required: true\nserver:\n  port: 8888\n</code></pre> \n<p>说了点题外话，我们继续搞起~</p> \n<p>其实到这<code>Erupt</code>的环境就搭建完了，额~ ，这就完了？</p> \n<p>咱们什么也没干，项目是个空壳子，一行代码也没写，好像连个表也没建啊！</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/e44023f7-3a2e-4caa-b991-eb41b49ed724.png\" alt=\"\" loading=\"lazy\"></p> \n<p>别着急咱们先启动下项目，看到控制台打印出很多建表语句和插入语句，这是因为<code>Erupt</code>框架底层应用<code>JPA</code>持久化，预置创建了一些系统表和数据。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/49cc147d-bdcb-4a1b-b162-7780b1b6d194.png\" alt=\"\" loading=\"lazy\"></p> \n<p><strong>注意</strong>：<code>Erupt</code>预置表只会随项目第一次启动构建一次，如果想重新创建，需删除<code>.Erupt</code>文件（一般在项目的工作空间内），获取文件位置方式</p> \n<pre><code class=\"language-java\">System.getProperty(\"user.dir\")\n</code></pre> \n<p>再看数据库里创建了16张系统表，其中<code>e_upms_user</code>表是用户表，默认只有一个管理员账号，用户名、密码都是<code>erupt</code>。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/593bc99b-90b2-436f-8551-7471b643cd03.png\" alt=\"\" loading=\"lazy\"></p> \n<p>紧接着我们访问<code>http://127.0.0.1:8888/</code>，看一下是个什么效果，竟然有个完整的登录页面。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/3a946dbc-dac3-4886-ad3d-b50c511547c9.png\" alt=\"\" loading=\"lazy\"></p> \n<p>用上边的用户名、密码直接登录，<code>erupt</code>已经预先实现了完整的权限控等功能，而到这我们几乎是没写过什么代码的，都是框架封装好了的，菜单类数据全部从数据库动态获取，一个基础的后台管理系统就搭建完了，有点哇塞。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/52a4f315-4be5-4ccd-be48-5db1648268b0.png\" alt=\"\" loading=\"lazy\"></p> \n<p><strong>有趣的页面</strong></p> \n<p>那么问题来了？想要自定义页面怎么办？</p> \n<p>开篇我们就说过<code>erupt</code>是零前端代码，全部基于<code>Java</code>注解开发的，接下来用<code>Java</code>注解写个简单页面体验下。</p> \n<p><code>erupt</code>有两个核心注解<code>@Erupt</code>，<code>@EruptField</code></p> \n<ul> \n <li><code>@Erupt</code>注解修饰类，代表定义一个页面</li> \n <li><code>@EruptField</code>注解修饰字段，代表页面上显示的字段名</li> \n <li><code>@Power</code>注解控制是否操作按钮，增、删、改、查、导入、导出等</li> \n <li><code>@Search</code>注解表示字段为搜索条件</li> \n <li><code>@Table</code>注解表示页面取数据对应的表，如果不设置，页面第一次初始化的时候，会根据类字段值自动创建一张和类名一致的表名。</li> \n</ul> \n<blockquote> \n <p>注解类型比较多，不一一列举了，更多的自己到官网瞅：<code>https://www.erupt.xyz</code></p> \n</blockquote> \n<p>下边我们定义一个<code>Student</code>类，加上<code>@Erupt</code>，<code>@EruptField</code>注解，这样页面和元素就算写完了，是不是有点颠覆认知。</p> \n<pre><code class=\"language-java\">/*\n *  @Erupt注解修饰在类上，@EruptField注解修饰在字段上\n *  其他注解均为Jpa注解\n */\n@Getter\n@Setter\n@Erupt(name = \"学生表\",\n        power = @Power(importable = true, export = true)\n)\n@Entity\n//@Table(name = \"t_student\")\npublic class Student extends BaseModel {\n\n    @EruptField(\n            views = @View(title = \"学生姓名\"),\n            edit = @Edit(title = \"学生姓名\", notNull = true, search = @Search(vague = true))\n    )\n    private String studentName;\n\n    @EruptField(\n            views = @View(title = \"所属班级\"),\n            edit = @Edit(title = \"所属班级\", notNull = true)\n    )\n    private String studentClass;\n\n    @EruptField(\n            views = @View(title = \"学生年龄\"),\n            edit = @Edit(title = \"学生年龄\", notNull = true)\n    )\n    private String studentAge;\n\n    @Lob\n    @EruptField(\n            views = @View(title = \"学生性别\"),\n            edit = @Edit(title = \"学生性别\", notNull = true)\n    )\n    private String studentSex;\n\n    @EruptField(\n            views = @View(title = \"考核状态\"),\n            edit = @Edit(title = \"考核状态\", notNull = true, boolType = @BoolType(trueText = \"通过\", falseText = \"挂科\"), search = @Search)\n    )\n    private Boolean status;\n}\n</code></pre> \n<p>但此时新创建的页面不会显示出来，还需要我们手动做一个映射关系，在菜单维护中自定义个菜单，<strong>类型值</strong>一定要为新建的 <strong>类名</strong> <code>Student</code>。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/b83bf19e-f43d-4826-b7b6-cb95b5a6dc6c.png\" alt=\"\" loading=\"lazy\"></p> \n<p>保存刷新后会看到我们的新页面出现了，而且页面的功能很完整，基础操作、查询、导入、导出功能都自动实现了。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/f289000d-5061-4577-821e-a7d6454dc71d.png\" alt=\"\" loading=\"lazy\"></p> \n<p>页面新增一个学生信息，对应的<code>Student</code>表也多了条记录，而这个持久化的过程完全由框架来做。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/4cb1e179-cda7-417e-b489-c24629306158.png\" alt=\"\" loading=\"lazy\"></p> \n<p>尽管<code>Erupt</code> 框架对前后端代码做了深度封装，但它提供了丰富灵活的自定义接口，来满足我们的个性化需求。</p> \n<p>比如我们在录入新学生信息时，希望屏蔽名字为<code>张三</code>的同学，可以对页面按钮功能做代理<code>dataProxy</code>，实现自定义的逻辑，对哪个按钮代理就实现对应方法即可，如<code>beforeAdd</code>、<code>afterAdd</code>是对新增按钮的代理。</p> \n<pre><code class=\"language-java\">@Getter\n@Setter\n@Erupt(name = \"学生表\",dataProxy = {StudentDataProxy.class},\n        power = @Power(importable = true, export = true)\n)\n@Entity\n//@Table(name = \"t_student\")\npublic class Student extends BaseModel {\n\n}\npublic class StudentDataProxy implements DataProxy&lt;Student&gt; {\n\n    @Override\n    public void beforeAdd(Student student) {\n        //后台字段校验\n        if (\"张三\".equals(student.getStudentName())) {\n            throw new EruptApiErrorTip(\"名称禁止为张三！\");\n        }\n    }\n\n    @Override\n    public void afterAdd(Student student) {\n\n    }\n    @Override\n    public void afterUpdate(Student student) {\n\n    }\n\n    @Override\n    public void afterDelete(Student student) {\n    }\n }\n</code></pre> \n<p>当我们在页面录入名字为<code>张三</code>的同学时，成功屏蔽。其他类似的功能还有很多，这里就不一一举例了，看文档看文档~</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/c08e3a79-8f5d-49b8-9a52-d97e0f06289f.png\" alt=\"\" loading=\"lazy\"></p> \n<p>如果我们想要按传统的方式开发接口，不用担心会和<code>Erupt</code>的页面生成规则有冲突，丝毫不会受影响。而且<code>Erupt</code>内部集成了<code>JPA</code>，提供了现成的<code>dao</code>接口，只要调用对应API即可上手开发。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/3400cccb-fc5e-491c-81fc-dbcd914978c1.png\" alt=\"\" loading=\"lazy\"></p> \n<p>如果你不想手写<code>Java</code>代码也没关系，<code>Erupt</code>还提供了代码生成器，自定义<code>Java</code>类名和字段名，可以生成代码，直接<code>copy</code>就行了。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/f76cb204-5d24-48d1-b9b9-adb69c80839b.png\" alt=\"\" loading=\"lazy\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/43f6124a-1da7-45b0-8e64-4024beaa52f9.png\" alt=\"\" loading=\"lazy\"></p> \n<p>说到这我只介绍了<code>Erupt</code>一丢丢的基础特性，主要是想让小伙伴知道有这么个敏捷利器。</p> \n<p>不仅如此它还支持丰富的数据类型，内置了像定时<code>任务管理</code>、<code>多表联合查询</code>、<code>前后端分离部署</code>、<code>接口权限</code>、<code>操作记录</code>、<code>多数据源</code>、<code>邮件系统</code>、<code>黑白名单</code>等等很多实用功能，都直接调用API就可以用。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/ad7968b9-da81-4ff9-82d1-92d9972e79ef.png\" alt=\"\" loading=\"lazy\"></p> \n<p><strong>说在后边</strong></p> \n<p><code>Erupt</code> 框架的优点是显而易见的，快捷、高效、上手容易，对新手相当的友好，但在实际生产环境中我只是用它来做一些配置字典类的数据管理。</p> \n<p>因为它的深度封装虽然让开发变的简单高效，可对于业务相对复杂、高度定制的系统来说，<code>Erupt</code> 框架显得力不从心，更关键的一点，它的社区并不算特别活跃，毕竟是个小众框架。</p> \n<p>不过，技术从来都是服务于业务的，如果你的业务与<code>Erupt</code>的气质相匹配，别犹豫，用它！</p>', NULL, '2021-03-27 00:18:10', 0, NULL, NULL, 'https://www.cnblogs.com/chengxy-nds/p/14583846.html', 0, NULL);
INSERT INTO `t_blog` VALUES (282, 'APK瘦身属性——android:extractNativeLibs', '<p>先描述一下结论：</p> \n<p><code>android:extractNativeLibs = true</code>时，gradle打包时会<code>对工程中的so库进行压缩</code>，最终生成<code>apk包的体积会减小</code>。<br> 但用户在手机端进行apk安装时，系统会对压缩后的so库进行解压，从而造成用户<code>安装apk的时间变长</code>。</p> \n<p>关于<code>android:extractNativeLibs</code>默认值设定方面，若开发人员未对android:extractNativeLibs进行特殊配置：</p> \n<ul> \n <li><code>minSdkVersion &lt; 23 或 Android Gradle plugin &lt; 3.6.0</code>情况下，打包时 <code>android:extractNativeLibs=true</code>；</li> \n <li><code>minSdkVersion &gt;= 23 并且 Android Gradle plugin &gt;= 3.6.0</code>情况下，打包时<code>android:extractNativeLibs=false</code>；</li> \n</ul> \n<h2 id=\"一、起因\">一、起因</h2> \n<p>偶然发现，使用AndroidStudio将同一Module分别打包为<code>aar</code>与<code>apk</code>，两者占用的磁盘空间差距巨大：<br> <code>打包为aar，占用磁盘空间4.4M；打包为apk，占用磁盘空间为11.7M；</code></p> \n<p>使用AndroidStudio中 <a href=\"https://developer.android.com/studio/command-line/apkanalyzer\" target=\"_blank\">apkanalyzer</a> 对比分析，两种打包方式so库 <code>Rwa File Size</code> 差距较大，但两者的<code>Download Size</code> 大小完全一致：<br> <code>打包为aar，so库Rwa File Size为3.4M；打包为apk，so库Rwa File Size为8.2M；</code><br> <code>打包为aar，so库Download Size为3.3M；打包为apk，so库Download Size为3.3M；</code></p> \n<p>两种打包方式 <a href=\"https://developer.android.com/studio/command-line/apkanalyzer\" target=\"_blank\">apkanalyzer</a> 对比分析如下：</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/7dc8563b-97e8-47b6-901c-a43d2f43c404.png\" alt=\"打包为aar\" loading=\"lazy\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/cad2de97-c574-4328-940f-1b1c2bc41013.png\" alt=\"打包为apk\" loading=\"lazy\"></p> \n<p>两种打包方式<code>Rwa File Size</code> 与<code>Download Size</code> 差距较大，那<code>Raw File Size</code>与<code>Download Size</code>又是如何定义的呢？</p> \n<h2 id=\"二、raw-file-size--download-size\">二、Raw File Size &amp; Download Size</h2> \n<p>官方 <a href=\"https://developer.android.com/studio/build/apk-analyzer.html#view_file_and_size_information\" target=\"_blank\">view_file_and_size_information：</a> 描述如下：</p> \n<p><code>APK Analyzer shows raw file size and download file size values for each entity, as shown in figure 1. Raw File Size represents the unzipped size of the entity on disk while Download Size represents the estimated compressed size of the entity as it would be delivered by Google Play. The % of Total Download Size indicates the percentage of the APK\'s total download size the entity represents.</code></p> \n<p>翻译后：</p> \n<p>APK Analyzer 展示每个实体的 <code>Raw File Size</code> 与<code>download file size</code> ：<br> <code>Raw File Size</code> 代表对应实体在磁盘上未进行压缩的大小；<br> <code>Download Size</code> 代表对应实体在Google Play中，预估的压缩后的大小；<br> <code>% of Total Download Size</code> 代表对应模块实体，在Download Size总大小中所占百分比。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/347f9355-bd8e-4126-ae67-9b256255be11.png\" alt=\"View file and size information\" loading=\"lazy\"></p> \n<h4 id=\"看到这里，怀疑：\">看到这里，怀疑：</h4> \n<p><code>打包为aar时，AndroidStudio对Module中的so库进行了压缩；但打包为apk时，未对Module中的so库进行压缩</code>。</p> \n<h2 id=\"三、androidextractnativelibs\">三、android:extractNativeLibs</h2> \n<p>查询相关资料，发现文章<a href=\"https://stackoverflow.com/questions/45024723/android-apk-raw-file-size-vs-download-size-how-to-shrink-the-raw-file-size\" target=\"_blank\">Android APK Raw File Size vs Download Size：</a><br> 文章中提到：<br> 打包APK时，<code>是否对so库进行压缩</code>的控制属性为 <code>android:extractNativeLibs</code>。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/4d362c5e-00b7-4885-9fbe-8a422ea88ab7.png\" alt=\"Android APK Raw File Size vs Download Size\" loading=\"lazy\"></p> \n<p><code>AndroidManifest.xml</code>中<code>extractNativeLibs</code>属性使用方式：</p> \n<pre><code class=\"language-xml\">&lt;application\n    android:extractNativeLibs=\"true\"&gt;\n&lt;/application&gt;\n</code></pre> \n<h3 id=\"31、androidextractnativelibs--true\">3.1、android:extractNativeLibs = true</h3> \n<p>若<code>android:extractNativeLibs = true</code>，进行apk打包时，<code>AndroidStudio会对Module中的so库进行压缩</code>，最终得到的apk体积较小。</p> \n<ul> \n <li><code>好处是：</code>用户在应用市场下载和升级时，因为消耗的流量较小，用户有更强的下载和升级意愿。</li> \n <li><code>缺点是：</code>因为so是压缩存储的，因此用户安装时，系统会将so解压出来，重新存储一份。因此安装时间会变长，占用的用户磁盘存储空间反而会增大。</li> \n</ul> \n<h3 id=\"32、androidextractnativelibs--false\">3.2、android:extractNativeLibs = false</h3> \n<p>若<code>android:extractNativeLibs = false</code>，进行apk打包时，<code>AndroidStudio不会对Module中的so库进行压缩</code>，最终生成的apk体积较大。</p> \n<ul> \n <li><code>好处是：</code>用户安装后，直接使用<code>/data/data/your.app.package/lib</code>路径下的so，没有额外的so复制操作，相对于<code>android:extractNativeLibs = true</code>而言，节省用户磁盘存储空间；</li> \n</ul> \n<h3 id=\"33、结论\">3.3、结论</h3> \n<p><code>android:extractNativeLibs = true的设定还是利大于弊的。</code></p> \n<p><code>设置为true可以工程中的so库进行压缩，最终减小生成的apk包大小。至于安装应用时，因so库解压缩而造成的安装时间增长，相对于带来的好处（提高应用市场用户的下载和升级意愿）而言，我认为是可接受的。</code></p> \n<h2 id=\"四、androidextractnativelibs默认值\">四、android:extractNativeLibs默认值</h2> \n<p><a href=\"https://developer.android.com/guide/topics/manifest/application-element.html#extractNativeLibs\" target=\"_blank\">android:extractNativeLibs官方API描述如下：</a></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/3303c54c-a8c7-4b26-af8b-77aa8bc01861.png\" alt=\"android:extractNativeLibs官方API描述\" loading=\"lazy\"></p> \n<p>从android:extractNativeLibs官方API描述中可以了解到：</p> \n<ul> \n <li>源码中 android:extractNativeLibs默认值为true；</li> \n <li>编译器Android Gradle plugin 3.6.0 或更高版本，android:extractNativeLibs默认值为false；</li> \n</ul> \n<p><code>但真的是这样吗？一起来探究一下。</code></p> \n<h3 id=\"41、源码中extractnativelibs默认设定\">4.1、源码中extractNativeLibs默认设定</h3> \n<p>从Android 6.0（API 23）开始，Android frame源码中<code>PackageParser.java</code>在读取<code>android:extractNativeLibs</code>属性值时，默认值为true；</p> \n<p>对应的源码路径：<code>frameworks/base/core/java/android/content/pm/PackageParser.java</code></p> \n<pre><code class=\"language-java\">if (sa.getBoolean(\n        com.android.internal.R.styleable.AndroidManifestApplication_extractNativeLibs,\n        true)) {\n    ai.flags |= ApplicationInfo.FLAG_EXTRACT_NATIVE_LIBS;\n}\n</code></pre> \n<h3 id=\"42、android-gradle-plugin-360-或更高版本\">4.2、Android Gradle plugin 3.6.0 或更高版本</h3> \n<p>编译器<code>Android Gradle plugin 3.6.0 或更高版本</code>，在构建应用时会默认将 <code>extractNativeLibs 设置为 false</code>。</p> \n<p>通过观察编译后生成的<code>AndroidManifest.xml</code>文件，发现 gradle 插件设置默认值为false，是通过在处理AndroidManifest.xml文件的时，<code>在其中自动插入 android:extractNativeLibs=“false\"来实现的</code>。<br> 由于 <code>android:extractNativeLibs</code> 这个属性是在Android 6.0（API 23）引入的，因此如果项目配置 中<code>minSdkVersion &lt; 23</code> 的话，gradle 插件不会自动插入<code>android:extractNativeLibs=“false\"</code>。</p> \n<h3 id=\"43、结论\">4.3、结论</h3> \n<p>开发人员在进行apk打包时，若未对android:extractNativeLibs进行特殊配置：</p> \n<ul> \n <li>若 <code>minSdkVersion &lt; 23 或 Android Gradle plugin &lt; 3.6.0</code>，打包时 <code>android:extractNativeLibs=true</code>；</li> \n <li>若<code>minSdkVersion &gt;= 23 并且 Android Gradle plugin &gt;= 3.6.0</code>，打包时<code>android:extractNativeLibs=false</code>；</li> \n</ul> \n<h2 id=\"五、参考\">五、参考</h2> \n<p><a href=\"https://developer.android.com/studio/command-line/apkanalyzer\" target=\"_blank\">apkanalyzer：</a><br> <a href=\"https://developer.android.com/studio/command-line/apkanalyzer\" target=\"_blank\">https://developer.android.com/studio/command-line/apkanalyzer</a></p> \n<p><a href=\"https://developer.android.com/studio/build/apk-analyzer.html#view_file_and_size_information\" target=\"_blank\">view_file_and_size_information：</a><br> <a href=\"https://developer.android.com/studio/build/apk-analyzer.html#view_file_and_size_information\" target=\"_blank\">https://developer.android.com/studio/build/apk-analyzer.html#view_file_and_size_information</a></p> \n<p><a href=\"https://stackoverflow.com/questions/45024723/android-apk-raw-file-size-vs-download-size-how-to-shrink-the-raw-file-size\" target=\"_blank\">Android APK Raw File Size vs Download Size：</a><br> <a href=\"https://stackoverflow.com/questions/45024723/android-apk-raw-file-size-vs-download-size-how-to-shrink-the-raw-file-size\" target=\"_blank\">https://stackoverflow.com/questions/45024723/android-apk-raw-file-size-vs-download-size-how-to-shrink-the-raw-file-size</a></p> \n<p><a href=\"https://developer.android.com/guide/topics/manifest/application-element.html#extractNativeLibs\" target=\"_blank\">android:extractNativeLibs：</a><br> <a href=\"https://developer.android.com/guide/topics/manifest/application-element.html#extractNativeLibs\" target=\"_blank\">https://developer.android.com/guide/topics/manifest/application-element.html#extractNativeLibs</a></p> \n<p><a href=\"https://stackoverflow.com/questions/42998083/setting-androidextractnativelibs-false-to-reduce-app-size\" target=\"_blank\">Setting android:extractNativeLibs to reduce app size：</a><br> <a href=\"https://stackoverflow.com/questions/42998083/setting-androidextractnativelibs-false-to-reduce-app-size\" target=\"_blank\">https://stackoverflow.com/questions/42998083/setting-androidextractnativelibs-false-to-reduce-app-size</a></p> \n<h2 id=\"-the-end-\">========== THE END ==========</h2> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/df2d9a4a-7651-4a0b-b232-831c40eda947.png\" alt=\"欢迎关注我的公众号\" loading=\"lazy\"></p>', NULL, '2021-03-27 00:18:11', 0, NULL, NULL, 'https://www.cnblogs.com/xiaxveliang/p/14583802.html', 0, NULL);
INSERT INTO `t_blog` VALUES (283, '翻译 - ASP.NET Core 基本知识 - 配置（Configuration）', '<p>翻译自&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0\" target=\"_blank\">https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0</a></p> \n<p>ASP.NET Core 中的配置使用一个或者多个配置提供程(<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#cp\" data-linktype=\"self-bookmark\">configuration providers</a>)序实现。配置提供程序从多种键值对中的配置源中读取配置数据：</p> \n<ul> \n <li>设置文件，例如 appsetting.json</li> \n <li>环境变量</li> \n <li>Azure 键库</li> \n <li>Azure App 配置</li> \n <li>命令行参数</li> \n <li>自定义提供器，安装的或者创建的</li> \n <li>目录文件</li> \n <li>内存中的 .NET 对象</li> \n</ul> \n<p>本话题提供 ASP.NET Core 中关于配置的信息。更多关于在控制台应用程序中使用配置的信息，查看&nbsp;<a href=\"https://docs.microsoft.com/en-us/dotnet/core/extensions/configuration\" data-linktype=\"absolute-path\">.NET Configuration</a>.</p> \n<h1>默认配置</h1> \n<p>使用&nbsp;<a href=\"https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-new\" data-linktype=\"absolute-path\">dotnet new</a>&nbsp;或者 Visual Studio 创建的 ASP.NET Core web 应用程序生成以下代码：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> Program\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> Main(<span style=\"color: rgba(0, 0, 255, 1)\">string</span><span style=\"color: rgba(0, 0, 0, 1)\">[] args)\n    {\n        CreateHostBuilder(args).Build().Run();\n    }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> IHostBuilder CreateHostBuilder(<span style=\"color: rgba(0, 0, 255, 1)\">string</span>[] args) =&gt;<span style=\"color: rgba(0, 0, 0, 1)\">\n        Host.CreateDefaultBuilder(args)\n            .ConfigureWebHostDefaults(webBuilder </span>=&gt;<span style=\"color: rgba(0, 0, 0, 1)\">\n            {\n                webBuilder.UseStartup</span>&lt;Startup&gt;<span style=\"color: rgba(0, 0, 0, 1)\">();\n            });\n}</span></pre> \n</div> \n<p><a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.hosting.host.createdefaultbuilder\" data-linktype=\"absolute-path\">CreateDefaultBuilder</a>&nbsp;按照以下顺序为应用程序提供默认配置：</p> \n<ol> \n <li><a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.chainedconfigurationsource\" data-linktype=\"absolute-path\">ChainedConfigurationProvider</a>：添加一个现存的 IConfiguration 作为一个源。在一个默认配置例子中，添加主机（<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#hvac\" data-linktype=\"self-bookmark\">host</a>）配置并且设置它作为第一个应用程序配置的源。</li> \n <li><a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#appsettingsjson\" data-linktype=\"self-bookmark\">appsettings.json</a>&nbsp;使用 JSON 配置提供器（<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#file-configuration-provider\" data-linktype=\"self-bookmark\">JSON configuration provider</a>）。</li> \n <li>appsetttings.Environment.json 使用&nbsp;JSON 配置提供器（<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#file-configuration-provider\" data-linktype=\"self-bookmark\">JSON configuration provider</a>）。例如,appsettings.Production.json 和 appsettings.Developments.json。</li> \n <li><a href=\"https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?view=aspnetcore-5.0\" data-linktype=\"relative-path\">App secrets</a>，当应用程序运行在开发 (Development) 环境中。</li> \n <li>环境变量使用&nbsp;&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#evcp\" data-linktype=\"self-bookmark\">Environment Variables configuration provider</a>。</li> \n <li>命令行参数使用&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#command-line\" data-linktype=\"self-bookmark\">Command-line configuration provider</a>。</li> \n</ol> \n<p>后添加的配置提供器会覆盖先前添加的键值设置。例如，如果 MyKey 同事在 appsettings.json 和 环境变量中设置，环境变量的值将会被使用。如果使用默认的配置提供器，命令行配置提供器(<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#clcp\" data-linktype=\"self-bookmark\">Command-line configuration provider</a>) 将会覆盖所有的提供器。</p> \n<p>关于 CreateDefaultBuilder 的更多信息，查看&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-5.0#default-builder-settings\" data-linktype=\"relative-path\">Default builder settings</a>。</p> \n<p>下面的代码展示了使能的配置提供器的添加顺序：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> Index2Model : PageModel\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span><span style=\"color: rgba(0, 0, 0, 1)\"> IConfigurationRoot ConfigRoot;\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> Index2Model(IConfiguration configRoot)\n    {\n        ConfigRoot </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> (IConfigurationRoot)configRoot;\n    }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> ContentResult OnGet()\n    {           \n        </span><span style=\"color: rgba(0, 0, 255, 1)\">string</span> str = <span style=\"color: rgba(128, 0, 0, 1)\">\"\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">foreach</span> (<span style=\"color: rgba(0, 0, 255, 1)\">var</span> provider <span style=\"color: rgba(0, 0, 255, 1)\">in</span><span style=\"color: rgba(0, 0, 0, 1)\"> ConfigRoot.Providers.ToList())\n        {\n            str </span>+= provider.ToString() + <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">\\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\n        }\n\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span><span style=\"color: rgba(0, 0, 0, 1)\"> Content(str);\n    }\n}</span></pre> \n</div> \n<p>appsettings.json</p> \n<p>考虑下面的 appsettings.json 文件：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\">{\n  </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Position</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">: {\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Title</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Editor</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Joe Smith</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n  },\n  </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">MyKey</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>:  <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">My appsettings.json Value</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n  </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Logging</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">: {\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">LogLevel</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">: {\n      </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Default</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Information</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n      </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Microsoft</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Warning</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n      </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Microsoft.Hosting.Lifetime</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Information</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    }\n  },\n  </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">AllowedHosts</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">*</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n}</span></pre> \n</div> \n<p>示例 (<a href=\"https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/configuration/index/samples/3.x/ConfigSample\" data-linktype=\"external\">sample download</a>) 中的代码展示了几个上面的配置设置：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> TestModel : PageModel\n{\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\"> requires using Microsoft.Extensions.Configuration;</span>\n    <span style=\"color: rgba(0, 0, 255, 1)\">private</span> <span style=\"color: rgba(0, 0, 255, 1)\">readonly</span><span style=\"color: rgba(0, 0, 0, 1)\"> IConfiguration Configuration;\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> TestModel(IConfiguration configuration)\n    {\n        Configuration </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> configuration;\n    }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> ContentResult OnGet()\n    {\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> myKeyValue = Configuration[<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">MyKey</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">];\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> title = Configuration[<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Position:Title</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">];\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> name = Configuration[<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Position:Name</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">];\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> defaultLogLevel = Configuration[<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Logging:LogLevel:Default</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">];\n\n\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span> Content($<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">MyKey value: {myKeyValue} \\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                       $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Title: {title} \\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                       $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name: {name} \\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                       $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Default Log Level: {defaultLogLevel}</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n    }\n}</span></pre> \n</div> \n<p>默认的&nbsp;<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.json.jsonconfigurationprovider\" data-linktype=\"absolute-path\">JsonConfigurationProvider</a>&nbsp;按照以下顺序加载配置：</p> \n<p>1. appsettings.json</p> \n<p>2. appsettings.Environment.json：例如，appsettings.Production.json 和 appsettings.Development.json 文件。文件的环境版本基于&nbsp;<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.hosting.ihostingenvironment.environmentname\" data-linktype=\"absolute-path\">IHostingEnvironment.EnvironmentName</a>，更多信息，查看&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-5.0\" data-linktype=\"relative-path\">Use multiple environments in ASP.NET Core</a>.</p> \n<p>appsettings.Environment.json 中的值会覆盖 appsettings.json 中的值。例如，默认的：</p> \n<ul> \n <li>在开发环境中，appsettings.Development.json 配置会覆盖 appsettings.json 中存在的值</li> \n <li>在生产环境中，appsettings.Production.json 的配置会覆盖 appsettings.json 中存在的值，例如，当部署应用程序到 Azure 上的时候。</li> \n</ul> \n<h1>使用选项模型绑定继承配置数据</h1> \n<p>读取相关配置值的推荐方式是使用选项模型 (<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options?view=aspnetcore-5.0\" data-linktype=\"relative-path\">options pattern</a>)。例如，读取下面的配置值：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Position</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">: {\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Title</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Editor</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Joe Smith</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n  }</span></pre> \n</div> \n<p>创建 PositionOptions 类：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> PositionOptions\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">string</span> Position = <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Position</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">string</span> Title { <span style=\"color: rgba(0, 0, 255, 1)\">get</span>; <span style=\"color: rgba(0, 0, 255, 1)\">set</span><span style=\"color: rgba(0, 0, 0, 1)\">; }\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">string</span> Name { <span style=\"color: rgba(0, 0, 255, 1)\">get</span>; <span style=\"color: rgba(0, 0, 255, 1)\">set</span><span style=\"color: rgba(0, 0, 0, 1)\">; }\n}</span></pre> \n</div> \n<p>一个选项类：</p> \n<ul> \n <li>必须是带有公共无参数的构造方法的非抽象类</li> \n <li>所有公共的可读写的属性类型要被绑定</li> \n <li>字段没有绑定。在前面的代码中，Position 没有绑定。使用 Position 属性，因此字符串 \"Position\" 就不用在绑定类到一个配置提供器的时候硬编码在应用程序中</li> \n</ul> \n<p>下面的代码：</p> \n<ul> \n <li>调用&nbsp;<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.configurationbinder.bind\" data-linktype=\"absolute-path\">ConfigurationBinder.Bind</a>&nbsp;绑定 PositionOptions 类到 Position 区域</li> \n <li>展示 Position 配置数据</li> \n</ul> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> Test22Model : PageModel\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span> <span style=\"color: rgba(0, 0, 255, 1)\">readonly</span><span style=\"color: rgba(0, 0, 0, 1)\"> IConfiguration Configuration;\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> Test22Model(IConfiguration configuration)\n    {\n        Configuration </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> configuration;\n    }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> ContentResult OnGet()\n    {\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> positionOptions = <span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> PositionOptions();\n        Configuration.GetSection(PositionOptions.Position).Bind(positionOptions);\n\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span> Content($<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Title: {positionOptions.Title} \\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                       $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name: {positionOptions.Name}</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n    }\n}</span></pre> \n</div> \n<p>在上面的代码中，默认的，在应用程序启动后对于 JSON 配置文件的改变也会被读取到。</p> \n<p><code><a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.configurationbinder.get\" data-linktype=\"absolute-path\">ConfigurationBinder.Get&lt;T&gt;</a>&nbsp;绑定和返回指定的类型。ConfigurationBinder.Get&lt;T&gt; 可能比使用 ConfigurationBinder.Bind 更方便。下面的代码展示了如何使用 ConfigurationBinder.Get&lt;T&gt; 使用 PositionOptions 类：</code></p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> Test21Model : PageModel\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span> <span style=\"color: rgba(0, 0, 255, 1)\">readonly</span><span style=\"color: rgba(0, 0, 0, 1)\"> IConfiguration Configuration;\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> PositionOptions positionOptions { <span style=\"color: rgba(0, 0, 255, 1)\">get</span>; <span style=\"color: rgba(0, 0, 255, 1)\">private</span> <span style=\"color: rgba(0, 0, 255, 1)\">set</span><span style=\"color: rgba(0, 0, 0, 1)\">; }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> Test21Model(IConfiguration configuration)\n    {\n        Configuration </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> configuration;\n    }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> ContentResult OnGet()\n    {            \n        positionOptions </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> Configuration.GetSection(PositionOptions.Position)\n                                                     .Get</span>&lt;PositionOptions&gt;<span style=\"color: rgba(0, 0, 0, 1)\">();\n\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span> Content($<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Title: {positionOptions.Title} \\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                       $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name: {positionOptions.Name}</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n    }\n}</span></pre> \n</div> \n<p>默认的，上面的代码会读取到在应用程序启动后对于 JSON 配置文件的更改。</p> \n<p>使用 options patter 的一种方法是绑定 Position 区域并且添加到依赖注入服务容器 (<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-5.0\" data-linktype=\"relative-path\">dependency injection service container</a>) 中。下面的代码中，PositionOptions 在&nbsp;<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.optionsconfigurationservicecollectionextensions.configure\" data-linktype=\"absolute-path\">Configure</a>&nbsp;中被添加到服务容器中，并绑定到配置：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> ConfigureServices(IServiceCollection services)\n{\n    services.Configure</span>&lt;PositionOptions&gt;<span style=\"color: rgba(0, 0, 0, 1)\">(Configuration.GetSection(\n                                        PositionOptions.Position));\n    services.AddRazorPages();\n}</span></pre> \n</div> \n<p>使用了上面的代码，下面的代码读取 position options:</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> Test2Model : PageModel\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span> <span style=\"color: rgba(0, 0, 255, 1)\">readonly</span><span style=\"color: rgba(0, 0, 0, 1)\"> PositionOptions _options;\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> Test2Model(IOptions&lt;PositionOptions&gt;<span style=\"color: rgba(0, 0, 0, 1)\"> options)\n    {\n        _options </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> options.Value;\n    }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> ContentResult OnGet()\n    {\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span> Content($<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Title: {_options.Title} \\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                       $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name: {_options.Name}</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n    }\n}</span></pre> \n</div> \n<p>上面的代码在应用程序启动后不会读取到对 JSON 配置文件的更改。如果要读取应用程序启动后的更改，可以使用&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options?view=aspnetcore-5.0#ios\" data-linktype=\"relative-path\">IOptionsSnapshot</a>。</p> \n<p>使用默认（<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#default\" data-linktype=\"self-bookmark\">default</a>）的配置，appsettings.json 和 appsettings.Environment.json 文件使能了&nbsp;&nbsp;<a href=\"https://github.com/dotnet/extensions/blob/release/3.1/src/Hosting/Hosting/src/Host.cs#L74-L75\" data-linktype=\"external\">reloadOnChange: true</a>&nbsp;。在应用程序启动后对 appsettings.json 和 appsettings.Environment.json 的更改会被&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#jcp\" data-linktype=\"self-bookmark\">JSON configuration provider</a>&nbsp;读取到。</p> \n<p>查看本文档中&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#jcp\" data-linktype=\"self-bookmark\">JSON configuration provider</a>&nbsp;关于添加更多 JSON 配置文件的信息。</p> \n<h1>合并服务集合</h1> \n<p>考虑下面的 ConfigureServices 方法，其中注册服务和配置选项：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> ConfigureServices(IServiceCollection services)\n{\n    services.Configure</span>&lt;PositionOptions&gt;<span style=\"color: rgba(0, 0, 0, 1)\">(\n        Configuration.GetSection(PositionOptions.Position));\n    services.Configure</span>&lt;ColorOptions&gt;<span style=\"color: rgba(0, 0, 0, 1)\">(\n        Configuration.GetSection(ColorOptions.Color));\n\n    services.AddScoped</span>&lt;IMyDependency, MyDependency&gt;<span style=\"color: rgba(0, 0, 0, 1)\">();\n    services.AddScoped</span>&lt;IMyDependency2, MyDependency2&gt;<span style=\"color: rgba(0, 0, 0, 1)\">();\n\n    services.AddRazorPages();\n}</span></pre> \n</div> \n<p>相关的一组的注册可以被移动到扩展方法中去注册服务。例如，配置服务被添加到下面的类中：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">using</span><span style=\"color: rgba(0, 0, 0, 1)\"> ConfigSample.Options;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">using</span><span style=\"color: rgba(0, 0, 0, 1)\"> Microsoft.Extensions.Configuration;\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">namespace</span><span style=\"color: rgba(0, 0, 0, 1)\"> Microsoft.Extensions.DependencyInjection\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> MyConfigServiceCollectionExtensions\n    {\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span><span style=\"color: rgba(0, 0, 0, 1)\"> IServiceCollection AddConfig(\n             </span><span style=\"color: rgba(0, 0, 255, 1)\">this</span><span style=\"color: rgba(0, 0, 0, 1)\"> IServiceCollection services, IConfiguration config)\n        {\n            services.Configure</span>&lt;PositionOptions&gt;<span style=\"color: rgba(0, 0, 0, 1)\">(\n                config.GetSection(PositionOptions.Position));\n            services.Configure</span>&lt;ColorOptions&gt;<span style=\"color: rgba(0, 0, 0, 1)\">(\n                config.GetSection(ColorOptions.Color));\n\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span><span style=\"color: rgba(0, 0, 0, 1)\"> services;\n        }\n    }\n}</span></pre> \n</div> \n<p>其余的服务在一个相似的类中被注册。下面的 ConfigureServices 方法使用的新的扩展方法注册服务：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> ConfigureServices(IServiceCollection services)\n{\n    services.AddConfig(Configuration)\n            .AddMyDependencyGroup();\n\n    services.AddRazorPages();\n}</span></pre> \n</div> \n<p>备注：每一个 services.Add{GROUP_NAME} 扩展方法添加和潜在的会配置服务。例如，<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.mvcservicecollectionextensions.addcontrollerswithviews\" data-linktype=\"absolute-path\">AddControllersWithViews</a>&nbsp;添加带有视图的 MVC 控制器的服务，<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.mvcservicecollectionextensions.addrazorpages\" data-linktype=\"absolute-path\">AddRazorPages</a>&nbsp;添加带有 Razor Pages 的服务。我们推荐应用程序遵守命名的约定。把扩展方法统一放到命名空间&nbsp;<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection\" data-linktype=\"absolute-path\">Microsoft.Extensions.DependencyInjection</a>&nbsp;中去封装一组服务的注册。</p> \n<h1>安全和用户秘密</h1> \n<p>数据配置指导：</p> \n<ul> \n <li>永远不要把密码或者其他敏感数据使用配置提供器保存在代码中或者保存在文本配置文件中。在开发过程中，可以使用&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?view=aspnetcore-5.0\" data-linktype=\"relative-path\">Secret Manager</a>&nbsp;工具保存秘密数据</li> \n <li>不要在开发环境或者测试环境中使用生产环境的秘密数据</li> \n <li>在工程外部指定秘密数据，以防被意外的提交到源代码仓库中</li> \n</ul> \n<p>默认的，用户秘密配置源是在 JSON 配置源之后注册的。因此，用户秘密的键值会生效，而不是 appsettings.json 和 appsettings.Environment.json 中的键值。</p> \n<p>更多关于存储密码或者其他敏感数据的信息：</p> \n<ul> \n <li><a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-5.0\" data-linktype=\"relative-path\">Use multiple environments in ASP.NET Core</a></li> \n <li><a href=\"https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?view=aspnetcore-5.0\" data-linktype=\"relative-path\">Safe storage of app secrets in development in ASP.NET Core</a>：包含关于使用环境变量存储敏感数据的建议。秘密管理工具使用&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#fcp\" data-linktype=\"self-bookmark\">File configuration provider</a>&nbsp;在本地系统上保存用户密码在一个 JSON 文件</li> \n</ul> \n<p><a href=\"https://azure.microsoft.com/services/key-vault/\" data-linktype=\"external\">Azure Key Vault</a>&nbsp;为 ASP.NET Core 应用程序安全的存储应用程序的秘密。更多信息查看&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/security/key-vault-configuration?view=aspnetcore-5.0\" data-linktype=\"relative-path\">Azure Key Vault Configuration Provider in ASP.NET Core</a>。</p> \n<h1>环境变量</h1> \n<p>使用默认的配置，<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.environmentvariables.environmentvariablesconfigurationprovider\" data-linktype=\"absolute-path\">EnvironmentVariablesConfigurationProvider</a>&nbsp;在读取 appsettings.json，appsettings.Environment.json，和 user secrets 之后从环境变量加载键值对。因此，从环境变量读取到的键值会覆盖从 appsettings.json, appsettings.Environment.json 和 user secrets 中读取到的值。</p> \n<p>: 分隔符在所有平台上对于环境便令分级键都是不工作的。__ 双下换线：</p> \n<ul> \n <li>所有平台都支持。例如，&nbsp;<a href=\"https://linuxhint.com/bash-environment-variables/\" data-linktype=\"external\">Bash</a>&nbsp;不支持 : 分隔符，但是支持 __</li> \n <li>会自动的被一个 : 替换</li> \n</ul> \n<p>下面的设置命令：</p> \n<ul> \n <li>在 Windows 上设置前面示例(<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#appsettingsjson\" data-linktype=\"self-bookmark\">preceding exampl</a>)中的环境键值和值</li> \n <li>使用示例程序(<a href=\"https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/configuration/index/samples/3.x/ConfigSample\" data-linktype=\"external\">sample download</a>)测试设置。dotnet run 命令必须在工程目录中运行</li> \n</ul> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">set</span> MyKey=<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">My key from Environment</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">set</span> Position__Title=<span style=\"color: rgba(0, 0, 0, 1)\">Environment_Editor\n</span><span style=\"color: rgba(0, 0, 255, 1)\">set</span> Position__Name=<span style=\"color: rgba(0, 0, 0, 1)\">Environment_Rick\ndotnet run</span></pre> \n</div> \n<p>上面的环境变量设置：</p> \n<ul> \n <li>仅仅在设置他们的命令行窗口中启动的进程中</li> \n <li>不会被使用 Visual Studio 启动的浏览器读取</li> \n</ul> \n<p>下面的&nbsp;&nbsp;<a href=\"https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/setx\" data-linktype=\"absolute-path\">setx</a>&nbsp;命令可以被用来在 Windows 上设置环境键和值。不同于 set，setx 是持久化的。/M 在系统环境设置变量。如果没有使用 /M 开关，一个用户的环境变量会被设置。</p> \n<div class=\"cnblogs_code\"> \n <pre>setx MyKey <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">My key from setx Environment</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> /<span style=\"color: rgba(0, 0, 0, 1)\">M\nsetx Position__Title Setx_Environment_Editor </span>/<span style=\"color: rgba(0, 0, 0, 1)\">M\nsetx Position__Name Environment_Rick </span>/M</pre> \n</div> \n<p>为了测试上面的命令会覆盖 appsettings.json 和 asppsettings.Environment.json 的配置，需要做以下操作：</p> \n<ul> \n <li>使用 Visual Studio: 退出和重启 Visual Studio</li> \n <li>使用命令行：启动一个新的命令窗口，输入 dotnet run</li> \n</ul> \n<p>调用&nbsp;<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.environmentvariablesextensions.addenvironmentvariables\" data-linktype=\"absolute-path\">AddEnvironmentVariables</a>，使用一个字符串指定环境变量的前缀：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> Program\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> Main(<span style=\"color: rgba(0, 0, 255, 1)\">string</span><span style=\"color: rgba(0, 0, 0, 1)\">[] args)\n    {\n        CreateHostBuilder(args).Build().Run();\n    }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> IHostBuilder CreateHostBuilder(<span style=\"color: rgba(0, 0, 255, 1)\">string</span>[] args) =&gt;<span style=\"color: rgba(0, 0, 0, 1)\">\n        Host.CreateDefaultBuilder(args)\n            .ConfigureAppConfiguration((hostingContext, config) </span>=&gt;<span style=\"color: rgba(0, 0, 0, 1)\">\n            {\n                config.AddEnvironmentVariables(prefix: </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">MyCustomPrefix_</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n            })\n            .ConfigureWebHostDefaults(webBuilder </span>=&gt;<span style=\"color: rgba(0, 0, 0, 1)\">\n            {\n                webBuilder.UseStartup</span>&lt;Startup&gt;<span style=\"color: rgba(0, 0, 0, 1)\">();\n            });\n}</span></pre> \n</div> \n<p>在上面的代码中:</p> \n<ul> \n <li>config.AddEnvironmentVariables(prefix: \"MyCustomPrefix_\") 在默认配置提供器 (<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#default\" data-linktype=\"self-bookmark\">default configuration providers</a>) 之后添加。关于配置提供器顺序的示例，查看 JSON 配置提供器 (<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#jcp\" data-linktype=\"self-bookmark\">JSON configuration provider</a>)。</li> \n <li>使用 MyCustomPrefix_ 前缀设置的环境变量覆盖了默认配置提供器 (<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#default\" data-linktype=\"self-bookmark\">default configuration providers</a>)。这包括没有前缀的环境变量。</li> \n</ul> \n<p>当配置键值对被读取的时候，前缀会被去除。</p> \n<p>下面的命令测试自定义前缀：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">set</span> MyCustomPrefix_MyKey=<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">My key with MyCustomPrefix_ Environment</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">set</span> MyCustomPrefix_Position__Title=<span style=\"color: rgba(0, 0, 0, 1)\">Editor_with_customPrefix\n</span><span style=\"color: rgba(0, 0, 255, 1)\">set</span> MyCustomPrefix_Position__Name=<span style=\"color: rgba(0, 0, 0, 1)\">Environment_Rick_cp\ndotnet run</span></pre> \n</div> \n<p>默认配置 (<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#default\" data-linktype=\"self-bookmark\">default configuration</a>) 加载带有前缀为 DOTNET_ 和 ASPNETCORE_ 的环境变量和命令行参数。DOTNET_ 和 ASPNETCORE_ 前缀被 ASP.NET Core 用来配置主机和应用程序配置 (<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-5.0#host-configuration\" data-linktype=\"relative-path\">host and app configuration</a>)，不能用来作为用户配置。更多关于主机和应用程序的配置，查看&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-5.0\" data-linktype=\"relative-path\">.NET Generic Host</a>。</p> \n<p>关于&nbsp;&nbsp;<a href=\"https://azure.microsoft.com/services/app-service/\" data-linktype=\"external\">Azure App Service</a>，在设置 (Settings) &gt; 配置 (Configuration) 页面选择 新建应用程序设置 (New application setting)。Azure 应用程序服务设置：</p> \n<ul> \n <li>在休息是加密，并通过加密通道传输</li> \n <li>暴露为环境变量</li> \n</ul> \n<p>更多信息，查看&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/azure-apps/?view=aspnetcore-5.0#override-app-configuration-using-the-azure-portal\" data-linktype=\"relative-path\">Azure Apps: Override app configuration using the Azure Portal</a>。</p> \n<p>查看&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#constr\" data-linktype=\"self-bookmark\">Connection string prefixes</a>&nbsp;了解关于 Azure 数据库连接字符串的信息。</p> \n<h1>&nbsp;环境变量命名</h1> \n<p>环境变量的命名反映了 appsettings.json 文件的结构。层级中的每一个元素使用双下划线（推荐的）或者冒号分割开来。当一个元素的结构包含一个数组的时候，数组的索引应该被当做是当前路径中的一个额外的元素名称。考虑下面的 appsettings.json 文件和它在环境变量中等价的值。</p> \n<p>appsettings.json</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\">{\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">SmtpServer</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">smtp.example.com</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Logging</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">: [\n        {\n            </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">ToEmail</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n            </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Level</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Critical</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n            </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Args</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">: {\n                </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">FromAddress</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">MySystem@example.com</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n                </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">ToAddress</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">SRE@example.com</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n            }\n        },\n        {\n            </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">ToConsole</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n            </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Level</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Information</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n        }\n    ]\n}</span></pre> \n</div> \n<p>环境变量 (environment variables)</p> \n<div class=\"cnblogs_code\"> \n <pre>setx SmtpServer=<span style=\"color: rgba(0, 0, 0, 1)\">smtp.example.com\nsetx Logging__0__Name</span>=<span style=\"color: rgba(0, 0, 0, 1)\">ToEmail\nsetx Logging__0__Level</span>=<span style=\"color: rgba(0, 0, 0, 1)\">Critical\nsetx Logging__0__Args__FromAddress</span>=<span style=\"color: rgba(0, 0, 0, 1)\">MySystem@example.com\nsetx Logging__0__Args__ToAddress</span>=<span style=\"color: rgba(0, 0, 0, 1)\">SRE@example.com\nsetx Logging__1__Name</span>=<span style=\"color: rgba(0, 0, 0, 1)\">ToConsole\nsetx Logging__1__Level</span>=Information</pre> \n</div> \n<h1>生成的 launchSettings.json 文件中环境变量的设置</h1> \n<p>在 launchSettings.json 中设置的环境变量会覆盖那些在系统环境中设置的值。例如，ASP.NET Core web 模板会生成一个 lauchSettings.json 文件，文件中设置了</p> \n<p>endpoint 配置：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">applicationUrl</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">https://localhost:5001;http://localhost:5000</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span></pre> \n</div> \n<p>对 applicationUrl 的配置设置环境变量 ASPNETCORE_URLS&nbsp; 并覆盖环境中的值。</p> \n<h1>Escape environment variables on Linux</h1> \n<p>在 linux 上，URL 环境变量的值必须被 escape 后系统才能够解析它。使用 linux systemd-escape 工具生成 http:--localhost:5001</p> \n<div class=\"cnblogs_code\"> \n <pre>groot@terminus:~$ systemd-escape http:<span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">localhost:5001</span>\nhttp:--localhost:<span style=\"color: rgba(128, 0, 128, 1)\">5001</span></pre> \n</div> \n<h1>显示环境变量</h1> \n<p>下面的代码在应用程序启动的时候输出显示了环境变量和对应的值，在调试环境设置的时候非常有用：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> Main(<span style=\"color: rgba(0, 0, 255, 1)\">string</span><span style=\"color: rgba(0, 0, 0, 1)\">[] args)\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> host =<span style=\"color: rgba(0, 0, 0, 1)\"> CreateHostBuilder(args).Build();\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> config = host.Services.GetRequiredService&lt;IConfiguration&gt;<span style=\"color: rgba(0, 0, 0, 1)\">();\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">foreach</span> (<span style=\"color: rgba(0, 0, 255, 1)\">var</span> c <span style=\"color: rgba(0, 0, 255, 1)\">in</span><span style=\"color: rgba(0, 0, 0, 1)\"> config.AsEnumerable())\n    {\n        Console.WriteLine(c.Key </span>+ <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\"> = </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\"> c.Value);\n    }\n    host.Run();\n}</span></pre> \n</div> \n<h1>命令行</h1> \n<p>使用默认的配置，<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.commandline.commandlineconfigurationprovider\" data-linktype=\"absolute-path\">CommandLineConfigurationProvider</a>&nbsp;在下列配置源之后从命令行参数键值对中加载配置：</p> \n<ul> \n <li>appsettings.json 和 appsettings.Environment.json 文件</li> \n <li>开发环境中的&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?view=aspnetcore-5.0\" data-linktype=\"relative-path\">App secrets</a></li> \n <li>环境变量</li> \n</ul> \n<p>默认的，在命令行中配置的值会覆盖其它所有配置提供的值。</p> \n<h1>命令行参数</h1> \n<p>下面的命令使用 = 设置键和值:</p> \n<div class=\"cnblogs_code\"> \n <pre>dotnet run MyKey=<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">My key from command line</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> Position:Title=Cmd Position:Name=Cmd_Rick</pre> \n</div> \n<p>下面的命令使用 / 设置键值：</p> \n<div class=\"cnblogs_code\"> \n <pre>dotnet run /MyKey <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Using /</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> /Position:Title=Cmd_ /Position:Name=Cmd_Rick</pre> \n</div> \n<p>下面的命令使用 -- 设置键值：</p> \n<div class=\"cnblogs_code\"> \n <pre>dotnet run --MyKey <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Using --</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> --Position:Title=Cmd-- --Position:Name=Cmd--Rick</pre> \n</div> \n<p>键值：</p> \n<ul> \n <li>必须紧跟 = ，或当值在一个空格后面的时候，键必须有个 -- 或者 / 前缀</li> \n <li>当使用 = 的时候，值不是必须要有的，例如 MySetting=</li> \n</ul> \n<p>在相同的命令行中，不要把使用 = 的键值对和使用空格的键值对的命令行参数混淆。</p> \n<h1>转换映射</h1> \n<p>切换映射允许键名替换逻辑。可以给&nbsp;<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.commandlineconfigurationextensions.addcommandline\" data-linktype=\"absolute-path\">AddCommandLine</a>&nbsp;方法提供一个切换替换的字典。</p> \n<p>当切换映射字典被用到的时候，字典被用来检查匹配命令行参数提供的键。日过命令行的键在字典中被找到，字典中的值就会被传回用来设置应用程序配置的键值对。切换映射要求任何的命令行键使用一个单独的破折号作为前缀。</p> \n<p>切换映射字典键的规则：</p> \n<ul> \n <li>切换必须以 - 或者 -- 开头</li> \n <li>切换映射字典不能包含重复的键</li> \n</ul> \n<p>&nbsp;</p> \n<p>使用一个切换映射字典，需要把它传递给 AddCommandLine 方法：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> Program\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> Main(<span style=\"color: rgba(0, 0, 255, 1)\">string</span><span style=\"color: rgba(0, 0, 0, 1)\">[] args)\n    {\n        CreateHostBuilder(args).Build().Run();\n    }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> IHostBuilder CreateHostBuilder(<span style=\"color: rgba(0, 0, 255, 1)\">string</span><span style=\"color: rgba(0, 0, 0, 1)\">[] args)\n    {\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> switchMappings = <span style=\"color: rgba(0, 0, 255, 1)\">new</span> Dictionary&lt;<span style=\"color: rgba(0, 0, 255, 1)\">string</span>, <span style=\"color: rgba(0, 0, 255, 1)\">string</span>&gt;<span style=\"color: rgba(0, 0, 0, 1)\">()\n         {\n             { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">-k1</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">key1</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n             { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">-k2</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">key2</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n             { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">--alt3</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">key3</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n             { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">--alt4</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">key4</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n             { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">--alt5</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">key5</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n             { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">--alt6</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">key6</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n         };\n\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span><span style=\"color: rgba(0, 0, 0, 1)\"> Host.CreateDefaultBuilder(args)\n            .ConfigureAppConfiguration((hostingContext, config) </span>=&gt;<span style=\"color: rgba(0, 0, 0, 1)\">\n            {\n                config.AddCommandLine(args, switchMappings);\n            })\n            .ConfigureWebHostDefaults(webBuilder </span>=&gt;<span style=\"color: rgba(0, 0, 0, 1)\">\n            {\n                webBuilder.UseStartup</span>&lt;Startup&gt;<span style=\"color: rgba(0, 0, 0, 1)\">();\n            });\n    }\n}</span></pre> \n</div> \n<p>下面的代码展示了被替换的键的值：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> Test3Model : PageModel\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span> <span style=\"color: rgba(0, 0, 255, 1)\">readonly</span><span style=\"color: rgba(0, 0, 0, 1)\"> IConfiguration Config;\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> Test3Model(IConfiguration configuration)\n    {\n        Config </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> configuration;\n    }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> ContentResult OnGet()\n    {\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span><span style=\"color: rgba(0, 0, 0, 1)\"> Content(\n                $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Key1: \'{Config[</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>Key1<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">]}\'\\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Key2: \'{Config[</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>Key2<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">]}\'\\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Key3: \'{Config[</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>Key3<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">]}\'\\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Key4: \'{Config[</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>Key4<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">]}\'\\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Key5: \'{Config[</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>Key5<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">]}\'\\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Key6: \'{Config[</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>Key6<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">]}\'</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n    }\n}</span></pre> \n</div> \n<p>下面的命令用来测试键替换：</p> \n<div class=\"cnblogs_code\"> \n <pre>dotnet run -k1 value1 -k2 value2 --alt3=value2 /alt4=value3 --alt5 value5 /alt6 value6</pre> \n</div> \n<p>对于使用切换映射的应用程序，调用 CreateDefaultBuilder 不应该传递参数。CreateDefaultBuilder 方法的 AddCommandLine 的调用不包括映射切换，没有方法可以传递切换映射的字典给 CreateDefaultBuilder。解决方法是允许 ConfigurationBuilder 方法的 AddCommandLine 同时处理参数和切换映射字典而不是传递参数给 CreateDefaultBuilder。</p> \n<h1>分层配置数据</h1> \n<p>配置 API 通过使用在配置键中的分界符扁平化分层数据来读取配置数据。</p> \n<p>示例程序 (<a href=\"https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/fundamentals/configuration/index/samples/3.x/ConfigSample\" data-linktype=\"external\">sample download</a>) 包含下面的 appsettings.json 文件：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\">{\n  </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Position</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">: {\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Title</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Editor</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Joe Smith</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n  },\n  </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">MyKey</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>:  <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">My appsettings.json Value</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n  </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Logging</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">: {\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">LogLevel</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">: {\n      </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Default</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Information</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n      </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Microsoft</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Warning</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n      </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Microsoft.Hosting.Lifetime</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Information</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    }\n  },\n  </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">AllowedHosts</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>: <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">*</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n}</span></pre> \n</div> \n<p>下面示例 (<a href=\"https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/fundamentals/configuration/index/samples/3.x/ConfigSample\" data-linktype=\"external\">sample download</a>) 中的代码展示了一些配置设置：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> TestModel : PageModel\n{\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\"> requires using Microsoft.Extensions.Configuration;</span>\n    <span style=\"color: rgba(0, 0, 255, 1)\">private</span> <span style=\"color: rgba(0, 0, 255, 1)\">readonly</span><span style=\"color: rgba(0, 0, 0, 1)\"> IConfiguration Configuration;\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> TestModel(IConfiguration configuration)\n    {\n        Configuration </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> configuration;\n    }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> ContentResult OnGet()\n    {\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> myKeyValue = Configuration[<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">MyKey</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">];\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> title = Configuration[<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Position:Title</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">];\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> name = Configuration[<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Position:Name</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">];\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> defaultLogLevel = Configuration[<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Logging:LogLevel:Default</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">];\n\n\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span> Content($<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">MyKey value: {myKeyValue} \\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                       $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Title: {title} \\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                       $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name: {name} \\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> +<span style=\"color: rgba(0, 0, 0, 1)\">\n                       $</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Default Log Level: {defaultLogLevel}</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n    }\n}</span></pre> \n</div> \n<p>读取分层配置数据的首选方式是使用选项模型。更多信息，查看本文档中的绑定分层配置数据 (<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#optpat\" data-linktype=\"self-bookmark\">Bind hierarchical configuration data</a>)。</p> \n<p><a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.configurationsection.getsection\" data-linktype=\"absolute-path\">GetSection</a>&nbsp;和&nbsp;<a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.iconfiguration.getchildren\" data-linktype=\"absolute-path\">GetChildren</a>&nbsp;方法可以用来分离配置数据中的分区和分区中的子部分。这些方法在之后的&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#getsection\" data-linktype=\"self-bookmark\">GetSection, GetChildren, and Exists</a>&nbsp;中会描述到。</p> \n<h1>配置的键和值</h1> \n<p>配置的键：</p> \n<ul> \n <li>不区分大小写。例如 ConnectionString 和 connectionstring 被认为是等价的键</li> \n <li>如果一个键和值在多个配置提供器中被设置，最后一个提供器的值将会被使用。更多信息，查看默认配置 (<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#default\" data-linktype=\"self-bookmark\">Default configuration</a>)</li> \n <li>分层键<br>- 在配置 API 内部，一个冒号分隔符 (:) 在所有平台都能工作<br>- 在环境变量中，一个冒号分隔符可能不会在所有平台上工作。双下划线 (__) 被所有平台支持，并且会被自动的转换为一个冒号 (:)<br>- 在 Azure 键仓库中，分层的键使用 -- 作为一个分隔符。当秘密数据被加载到应用程序配置的时候，<a href=\"https://docs.microsoft.com/en-us/aspnet/core/security/key-vault-configuration?view=aspnetcore-5.0\" data-linktype=\"relative-path\">Azure Key Vault configuration provider</a>&nbsp;自动使用一个冒号 (:) 替换 (--)。</li> \n <li><a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.configurationbinder\" data-linktype=\"absolute-path\">ConfigurationBinder</a>&nbsp;支持绑定数组到在配置键中使用数组索引的对象。数组绑定在&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#boa\" data-linktype=\"self-bookmark\">Bind an array to a class</a>&nbsp;部分描述。</li> \n</ul> \n<p>配置值：</p> \n<ul> \n <li>是字符串</li> \n <li>Null 值不能存储在配置中或者绑定到对象</li> \n</ul> \n<h1>配置提供器</h1> \n<p>下面的表格中显示了 ASP.NET Core 应用程序中可以使用的配置提供器</p> \n<table style=\"width: 100%\" border=\"0\" align=\"center\"> \n <tbody> \n  <tr> \n   <td>Provider</td> \n   <td>Providers configuration from</td> \n  </tr> \n  <tr> \n   <td><a href=\"https://docs.microsoft.com/en-us/aspnet/core/security/key-vault-configuration?view=aspnetcore-5.0\" data-linktype=\"relative-path\">Azure Key Vault configuration provider</a></td> \n   <td>Azure Key Valut</td> \n  </tr> \n  <tr> \n   <td><a href=\"https://docs.microsoft.com/en-us/azure/azure-app-configuration/quickstart-aspnet-core-app\" data-linktype=\"absolute-path\">Azure App configuration provider</a></td> \n   <td>Azure App Configuration</td> \n  </tr> \n  <tr> \n   <td><a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#clcp\" data-linktype=\"self-bookmark\">Command-line configuration provider</a></td> \n   <td>Command-line parameters</td> \n  </tr> \n  <tr> \n   <td><a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#custom-configuration-provider\" data-linktype=\"self-bookmark\">Custom configuration provider</a></td> \n   <td>Custom source</td> \n  </tr> \n  <tr> \n   <td><a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#evcp\" data-linktype=\"self-bookmark\">Environment Variables configuration provider</a></td> \n   <td>Environment variables</td> \n  </tr> \n  <tr> \n   <td><a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#file-configuration-provider\" data-linktype=\"self-bookmark\">File configuration provider</a></td> \n   <td>INI,JSON,XML 文件</td> \n  </tr> \n  <tr> \n   <td><a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#key-per-file-configuration-provider\" data-linktype=\"self-bookmark\">Key-per-file configuration provider</a></td> \n   <td>字典文件</td> \n  </tr> \n  <tr> \n   <td><a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#memory-configuration-provider\" data-linktype=\"self-bookmark\">Memory configuration provider</a></td> \n   <td>内存中的集合</td> \n  </tr> \n  <tr> \n   <td><a href=\"https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?view=aspnetcore-5.0\" data-linktype=\"relative-path\">User secrets</a></td> \n   <td>用户配置目录中的文件</td> \n  </tr> \n </tbody> \n</table> \n<p>配置源的读取的顺序按照它们的配置提供器被指定的顺序。在代码中对配置提供器排序来满足应用程序要求的配置源的顺序。</p> \n<p>一个典型的配置提供器的顺序是：</p> \n<ol> \n <li>appsettings.json</li> \n <li>appsettings.Environment.json</li> \n <li><a href=\"https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?view=aspnetcore-5.0\" data-linktype=\"relative-path\">User secrets</a></li> \n <li>使用&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#evcp\" data-linktype=\"self-bookmark\">Environment Variables configuration provider</a>&nbsp;的环境变量</li> \n <li>使用&nbsp;<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#command-line-configuration-provider\" data-linktype=\"self-bookmark\">Command-line configuration provider</a>&nbsp;的命令行参数</li> \n</ol> \n<p>一个常用的实践是在一系列的配置提供器的最后添加命令行配置提供器，用来覆盖其它提供器的配置设置</p> \n<p>上面的提供器的顺序在默认配置 (<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#default\" data-linktype=\"self-bookmark\">default configuration</a>) 中使用。</p> \n<h1>连接字符串前缀</h1> \n<p>配置 API 对于四种连接字符串环境变量有特殊的处理规则。这些连接字符串会根据应用程序环境解析来配置 Azure 连接字符串。下面表格中的带有前缀的环境变量在应用程序使用默认配置 （<a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#default\" data-linktype=\"self-bookmark\">default configuration</a>）或者没有前缀没有应用到 AddEnvironmentVariables 的情况下会被加载到应用程序中。</p> \n<table style=\"width: 100%\" border=\"0\" align=\"center\"> \n <tbody> \n  <tr> \n   <td>Connection string prefix</td> \n   <td>Provider</td> \n  </tr> \n  <tr> \n   <td>CUSTOMCONNSTR_</td> \n   <td>自定义提供器</td> \n  </tr> \n  <tr> \n   <td>MYSQLCONNSTR_</td> \n   <td><a href=\"https://www.mysql.com/\" data-linktype=\"external\">MySQL</a></td> \n  </tr> \n  <tr> \n   <td>SQLAZURECONNSTR_</td> \n   <td><a href=\"https://azure.microsoft.com/services/sql-database/\" data-linktype=\"external\">Azure SQL Database</a></td> \n  </tr> \n  <tr> \n   <td>SQLCONNSTR_</td> \n   <td><a href=\"https://www.microsoft.com/sql-server/\" data-linktype=\"external\">SQL Server</a></td> \n  </tr> \n </tbody> \n</table> \n<p>当一个环境变量被发现并且使用表格中四种前缀的任一种被加载到配置中的时候：</p> \n<ul> \n <li>通过移除环境变量的前缀创建配置的键，添加一个配置键的区域（ConnectionStrings）</li> \n <li>一个新的配置的键值对被创建，这个键值对代表了数据库连接提供器 (CUSTOMCONNSTR_ 除外，由于没有固定的提供器)</li> \n</ul> \n<table style=\"width: 100%\" border=\"0\" align=\"center\"> \n <tbody> \n  <tr> \n   <td>环境变量键</td> \n   <td>转换后的配置键</td> \n   <td>提供器配置入口</td> \n  </tr> \n  <tr> \n   <td>CUSTOMCONNSTR_{KEY}</td> \n   <td>ConnectionStrings:{KEY}</td> \n   <td>配置入口没有创建</td> \n  </tr> \n  <tr> \n   <td>MYSQLCONNSTR_{KEY}</td> \n   <td>ConnectionString:{KEY}</td> \n   <td> <p>Key:ConnectionStrings:</p> <p>{KEY}_ProviderName:</p> <p>Value:MySql.DataMySqlClient</p> </td> \n  </tr> \n  <tr> \n   <td>SQLAZURECONNSTR_{KEY}</td> \n   <td>ConnectionStrings:{KEY}</td> \n   <td> <p>Key:ConnectionStrings:</p> <p>{KEY}_ProviderName:</p> <p>Value:System.Data.SqlClient</p> </td> \n  </tr> \n  <tr> \n   <td>SQLCONNSTR_{KEY}</td> \n   <td>ConnectionStrings:{KEY}</td> \n   <td> <p>Key:ConnectionStrings:</p> <p>{KEY}_ProviderName:</p> <p>Value:System.Data.SqlClient</p> </td> \n  </tr> \n </tbody> \n</table> \n<h1>&nbsp;文件配置提供器</h1> \n<p><a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.fileconfigurationprovider\" data-linktype=\"absolute-path\">FileConfigurationProvider</a>&nbsp;是从文件系统加载配置的基类。下面的配置提供器都从 FileConfigurationProvider 类继承而来。</p> \n<ul> \n <li><a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#ini-configuration-provider\" data-linktype=\"self-bookmark\">INI configuration provider</a></li> \n <li><a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#jcp\" data-linktype=\"self-bookmark\">JSON configuration provider</a></li> \n <li><a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0#xml-configuration-provider\" data-linktype=\"self-bookmark\">XML configuration provider</a></li> \n</ul> \n<h2>INI 配置提供器</h2> \n<p><a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.configuration.ini.iniconfigurationprovider\" data-linktype=\"absolute-path\">IniConfigurationProvider</a>&nbsp;在运行时从 INI 文件中加载键值对的配置。</p> \n<p>下面的代码清空了所有配置提供器，添加了一些配置提供器：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> Program\n{\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> Main(<span style=\"color: rgba(0, 0, 255, 1)\">string</span><span style=\"color: rgba(0, 0, 0, 1)\">[] args)\n    {\n        CreateHostBuilder(args).Build().Run();\n    }\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> IHostBuilder CreateHostBuilder(<span style=\"color: rgba(0, 0, 255, 1)\">string</span>[] args) =&gt;<span style=\"color: rgba(0, 0, 0, 1)\">\n        Host.CreateDefaultBuilder(args)\n            .ConfigureAppConfiguration((hostingContext, config) </span>=&gt;<span style=\"color: rgba(0, 0, 0, 1)\">\n            {\n                config.Sources.Clear();\n\n                </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> env =<span style=\"color: rgba(0, 0, 0, 1)\"> hostingContext.HostingEnvironment;\n\n                config.AddIniFile(</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">MyIniConfig.ini</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, optional: <span style=\"color: rgba(0, 0, 255, 1)\">true</span>, reloadOnChange: <span style=\"color: rgba(0, 0, 255, 1)\">true</span><span style=\"color: rgba(0, 0, 0, 1)\">)\n                      .AddIniFile($</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">MyIniConfig.{env.EnvironmentName}.ini</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n                                     optional: </span><span style=\"color: rgba(0, 0, 255, 1)\">true</span>, reloadOnChange: <span style=\"color: rgba(0, 0, 255, 1)\">true</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n\n                config.AddEnvironmentVariables();\n\n                </span><span style=\"color: rgba(0, 0, 255, 1)\">if</span> (args != <span style=\"color: rgba(0, 0, 255, 1)\">null</span><span style=\"color: rgba(0, 0, 0, 1)\">)\n                {\n                    config.AddCommandLine(args);\n                }\n            })\n            .ConfigureWebHostDefaults(webBuilder </span>=&gt;<span style=\"color: rgba(0, 0, 0, 1)\">\n            {\n                webBuilder.UseStartup</span>&lt;Startup&gt;<span style=\"color: rgba(0, 0, 0, 1)\">();\n            });\n}</span></pre> \n</div> \n<p>&nbsp;</p>', NULL, '2021-03-27 00:18:12', 0, NULL, NULL, 'https://www.cnblogs.com/huangzhengguo/p/14356067.html', 0, NULL);
INSERT INTO `t_blog` VALUES (284, 'WPF 反射加载Geometry几何图形数据图标', '<p>相信大家在阅读WPF相关GitHub开源项目源码时都会看见一串串这种数据<br> <img src=\"http://localhost:9090/blogImages/2021/03/27/12c00a01-173a-4078-964a-34fabf8c647a.png\" alt=\"image\" loading=\"lazy\">这种Geometry数据就是几何图形数据</p> \n<h2 id=\"为什么要用geometry数据做图标？\">为什么要用Geometry数据做图标？</h2> \n<p>有一种做法是使用ttf字体文件代替，不过使用ttf字体文件会出现下面几个缺点：<br> 1、团队协作不便于管理<br> 2、需要依赖特定平台<br> 3、无法灵活使用<br> 而使用Geometry的话，我们可以将这些几何图形数据存入资源字典ResourceDictionary<br> 通过反射进行灵活使用，团队开发可共同维护</p> \n<h2 id=\"怎么获取geometry数据？\">怎么获取Geometry数据？</h2> \n<p>我们进入<a href=\"https://www.iconfont.cn/\" title=\"https://www.iconfont.cn/\" target=\"_blank\">https://www.iconfont.cn/</a>官网，找到心仪的图标，点击F12将鼠标放在该图标区域，找到网页元素<br> <img src=\"http://localhost:9090/blogImages/2021/03/27/a6cf46e8-9faf-489b-b36e-936186e5f436.png\" alt=\"image\" loading=\"lazy\"><br> Path标签内的d属性即Geometry数据</p> \n<h2 id=\"如何使用geometry数据\">如何使用Geometry数据</h2> \n<p>创建资源字典,并加入命名空间<br> <img src=\"http://localhost:9090/blogImages/2021/03/27/11bc826f-cb7e-4f54-83f3-bed8ae355c67.png\" alt=\"image\" loading=\"lazy\"><br> 将Geometry数据存入\n <geometry x:key=\"t_Demo\" o:freeze=\"true\"></geometry>标签内<br> t_Demo即资源名称key<br> o:Freeze属性设置Geometry不可修改，随后在App.xaml中加入</p> \n<pre><code class=\"language-csharp\">&lt;ResourceDictionary Source=\"Resources/Themes/BaseStyle.xaml\" /&gt;\n</code></pre> \n<p>这样我们就可以在全局的XAML代码中通过{StaticResource t_Demo}使用Geometry数据</p> \n<p>那么肯定会有小伙伴问了，如果想使用MVVM前后台分离开发怎么办？(在C#代码中动态使用Geometry)<br> 下面是反射加载Geometry的示例<br> 将资源文件存入静态类中</p> \n<pre><code class=\"language-csharp\">namespace Demo.Resources.Themes\n{\n    public static class LocalTheme\n    {\n        public static ResourceDictionary Dic = new ResourceDictionary { Source = new Uri(@\"Resources/Themes/Geometries.xaml\", UriKind.Relative) };\n    }\n}\n</code></pre> \n<p>使用资源字典(Geometry)LocalTheme.Dic[\"t_chart\"]，t_chart即资源字典中的key值</p> \n<pre><code class=\"language-csharp\">var chart = new HandyControl.Controls.TabItem()\n{\n	Header=\"图表\",\n	Content = xamlModel\n};\nchart.SetValue(IconElement.GeometryProperty, (Geometry)LocalTheme.Dic[\"t_chart\"]);\n</code></pre> \n<p>SetValue即设置附加属性<br> public void SetValue(DependencyProperty dp, object value);<br> 中的value为Geometry</p>', NULL, '2021-03-27 00:18:12', 0, NULL, NULL, 'https://www.cnblogs.com/Stay627/p/14583581.html', 0, NULL);
INSERT INTO `t_blog` VALUES (285, 'JDK 16 正式发布，一次性发布 17 个新特性…不服不行！', '<p>上一篇：<a href=\"https://mp.weixin.qq.com/s/fCwOQJxOYiqlnEZjqiFt2Q\" target=\"_blank\">Java 15 正式发布， 14 个新特性</a></p> \n<hr> \n<h2 id=\"jdk-16-正式发布\">JDK 16 正式发布</h2> \n<p>牛逼啊，JDK 15 刚发布半年（2020/09/15），JDK 16 又如期而至（2021/03/16），老铁们，跟上。</p> \n<p><strong>来看下 Oracle Java 支持路线图：</strong></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/5e10359e-0490-4160-bf69-eb44099463b0.png\" alt=\"\" loading=\"lazy\"></p> \n<p>Oracle 继续保持版本半年一发的节奏。。。</p> \n<p><strong>试问：你还能追上 JDK 的发布速度吗？？</strong></p> \n<p>可以看到，JDK 16 也不是一个长期支持的版本，只支持 6 个月到 2021 年 9 月，上一个长期支持版本还是 JDK 11，下一个长期支持版本是 JDK 17，还有半年也要发布了。</p> \n<p>所以千万不要把 JDK 16（非长期支持版本）用于生产，大家了解一下就好。</p> \n<h2 id=\"jdk-16-新特性一览\">JDK 16 新特性一览</h2> \n<table> \n <thead> \n  <tr> \n   <th>ID</th> \n   <th>JEP</th> \n   <th>Feature</th> \n  </tr> \n </thead> \n <tbody> \n  <tr> \n   <td>1</td> \n   <td>394</td> \n   <td>Pattern Matching for instanceof</td> \n  </tr> \n  <tr> \n   <td>2</td> \n   <td>395</td> \n   <td>Records</td> \n  </tr> \n  <tr> \n   <td>3</td> \n   <td>392</td> \n   <td>Packaging Tool</td> \n  </tr> \n  <tr> \n   <td>4</td> \n   <td>387</td> \n   <td>Elastic Metaspace</td> \n  </tr> \n  <tr> \n   <td>5</td> \n   <td>376</td> \n   <td>ZGC: Concurrent Thread-Stack Processing</td> \n  </tr> \n  <tr> \n   <td>6</td> \n   <td>380</td> \n   <td>UNIX-Domain Socket Channels</td> \n  </tr> \n  <tr> \n   <td>7</td> \n   <td>396</td> \n   <td>Strongly Encapsulate JDK Internals by Default</td> \n  </tr> \n  <tr> \n   <td>8</td> \n   <td>390</td> \n   <td>Warnings for Value-Based Classes</td> \n  </tr> \n  <tr> \n   <td>9</td> \n   <td>338</td> \n   <td>Vector API (Incubator)</td> \n  </tr> \n  <tr> \n   <td>10</td> \n   <td>389</td> \n   <td>Foreign Linker API (Incubator)</td> \n  </tr> \n  <tr> \n   <td>11</td> \n   <td>393</td> \n   <td>Foreign-Memory Access API (Third Incubator)</td> \n  </tr> \n  <tr> \n   <td>12</td> \n   <td>397</td> \n   <td>Sealed Classes (Second Preview)</td> \n  </tr> \n  <tr> \n   <td>13</td> \n   <td>347</td> \n   <td>Enable C++14 Language Features (in the JDK source code)</td> \n  </tr> \n  <tr> \n   <td>14</td> \n   <td>357</td> \n   <td>Migrate from Mercurial to Git</td> \n  </tr> \n  <tr> \n   <td>15</td> \n   <td>369</td> \n   <td>Migrate to GitHub</td> \n  </tr> \n  <tr> \n   <td>16</td> \n   <td>386</td> \n   <td>Alpine Linux Port</td> \n  </tr> \n  <tr> \n   <td>17</td> \n   <td>388</td> \n   <td>Windows/Aarch64 Port</td> \n  </tr> \n </tbody> \n</table> \n<p>JDK 16 这个版本提供了 17 个增强功能，包括全新的 Java 语言改进，工具和内存管理，以及还有一些孵化和预览特性，有了这些新功能，Java 会进一步提高开发人员的生产力。</p> \n<p>值得关注的变化是，JDK 14 中提供的预览特性：<a href=\"https://mp.weixin.qq.com/s/Qfni7MQOicfhCOtCMEpaog\" target=\"_blank\">模式匹配</a>和记录（<em><a href=\"https://mp.weixin.qq.com/s/d5dX1ldc-Wse2PT7ODR9xA\" target=\"_blank\">Records</a></em>），经过一年的社区反馈和实际应用，终于在 JDK 16 中完成最终落地了。</p> \n<p>另外，Oracle 还为 Java SE 订阅服务中免费提供 <em>GraalVM</em> 企业版服务，GraalVM 可以帮助提高应用程序的性能并减少资源消耗，尤其是在微服务和云原生架构中。</p> \n<h2 id=\"jdk-16-新特性详细介绍\">JDK 16 新特性详细介绍</h2> \n<p>下面是 JDK 16 中的 17 个新特性详细介绍。</p> \n<h4 id=\"394pattern-matching-for-instanceof\">394:Pattern Matching for instanceof</h4> \n<p>模式匹配 for instanceof，相当于是增强的 instanceof，在 JDK 14 中首次成为预览特性，在 JDK 16 中正式转正。</p> \n<p>模式匹配的到来将使得 instanceof 变得更简洁、更安全，为什么这么说，请看下面的示例。</p> \n<p><strong>正常的 instanceof 写法：</strong></p> \n<pre><code>if (object instanceof Kid) {\n  Kid kid = (Kid) object;\n  // ...\n} else if (object instanceof Kiddle) {\n  Kid kid = (Kid) object;\n  // ...\n}\n</code></pre> \n<p><strong>模式匹配的 instanceof 写法：</strong></p> \n<pre><code>if (object instanceof Kid kid) {\n  // ...\n} else if (object instanceof Kiddle kiddle) {\n  // ...\n}\n</code></pre> \n<p>判断、赋值一步到位，是不是很牛逼？具体这里就不详细介绍了，栈长之前有写过一篇文章，点击<a href=\"https://mp.weixin.qq.com/s/Qfni7MQOicfhCOtCMEpaog\" target=\"_blank\">这个链接</a>进行阅读，或者关注公众号Java技术栈，回复 \"java \" 进行阅读。</p> \n<h4 id=\"395records\">395:Records</h4> \n<p>简单来说，Records 就是一种新的语法糖，目的还是为了简化代码，在 JDK 14 中首次成为预览特性，在 JDK 16 中正式转正。</p> \n<p>Records 可以在一定程度上避免低级冗余的代码，比如：constructors, getters, equals(), hashCode(), toString() 方法等，相当于 Lombok 的 <code>@Data</code> 注解，但又不能完全替代。</p> \n<p>下面来看一个示例：</p> \n<pre><code>public record Student(String name, int id, int age) {}\n</code></pre> \n<p>没错，一行搞定（public 都可以省略），就是这么简单粗暴！！！</p> \n<p>我们再通过 IDEA 反编译 class 类的方式来看下它到底做了什么：</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/0421fe52-202c-446e-b220-4348a9bd15a7.png\" alt=\"\" loading=\"lazy\"></p> \n<p>看完是不是有点 Lombok 的感觉？具体这里就不详细介绍了，栈长之前有写过一篇文章，点击<a href=\"https://mp.weixin.qq.com/s/d5dX1ldc-Wse2PT7ODR9xA\" target=\"_blank\">这个链接</a>进行阅读，或者关注公众号Java技术栈，回复 \"java \" 进行阅读。</p> \n<h4 id=\"392packaging-tool\">392:Packaging Tool</h4> \n<p>提供了 jpackage 打包工具，可用于打包独立的 Java 应用程序。</p> \n<p>jpackage 打包工具是在 JDK 14 中首次作为孵化工具引入的新特性，到了 JDK 15 它仍然还在孵化中，现在它终于转正了。</p> \n<h4 id=\"387elastic-metaspace\">387:Elastic Metaspace</h4> \n<p>弹性的元空间，可以帮助 HotSpot 虚拟机，将元空间中未使用的 class 元数据内存更及时地返回给操作系统，以减少元空间的内存占用空间。</p> \n<p>另外，还简化了元空间的代码，以降低维护成本。</p> \n<h4 id=\"376zgc-concurrent-thread-stack-processing\">376:ZGC: Concurrent Thread-Stack Processing</h4> \n<blockquote> \n <p>ZGC 是一种较新的垃圾回收器，指在解决 HotSpot 虚拟机中的 GC 停顿及可伸缩问题。</p> \n</blockquote> \n<p>ZGC 最早是在 JDK 11 中集成进来的，在 JDK 15 中正式转正。</p> \n<p>这个版本则是为了让 ZGC 支持并发栈处理，解决了最后一个重大瓶颈，把 ZGC 中的线程栈处理从安全点移到了并发阶段。并且还提供了一种机制，使得其他 HotSpot 子系统可以通过该机制延迟处理线程栈。</p> \n<h4 id=\"380unix-domain-socket-channels\">380:UNIX-Domain Socket Channels</h4> \n<p>UNIX 域套接字通道，为 java.nio.channels 包中的套接字通道和服务端套接字通道 APIs 增加 Unix 域套接字通道所有特性支持。</p> \n<p>UNIX 域套接字主要用于同一主机上的进程间通信（IPC），大部分方面与 TCP/IP套接字类似，不同的是 UNIX 域套接字是通过文件系统路径名寻址，而不是通过 IP 地址和端口号。</p> \n<h4 id=\"396strongly-encapsulate-jdk-internals-by-default\">396:Strongly Encapsulate JDK Internals by Default</h4> \n<p>JDK 内部默认强封装，JDK 16 开始对 JDK 内部大部分元素默认进行强封装，sun.misc.Unsafe 之类的关键内部 API 除外，从而限制对它们的访问。</p> \n<p>此外，用户仍然可以选择自 JDK 9 以来的默认的宽松的强封装，这样可以帮助用户毫不费力地升级到未来的 Java 版本。</p> \n<h4 id=\"390warnings-for-value-based-classes\">390:Warnings for Value-Based Classes</h4> \n<p>基于值的类的警告，将基础类型包装类指定为基于值的类，废除其构造函数以进行删除，从而提示新的弃用警告。并且提供了在任何基于值的类的实例上不正常进行同步的警告。</p> \n<p>这个是对基本数据类型的包装类动刀了，只是提供警告，也不用太在意。</p> \n<h4 id=\"338vector-api-incubator\">338:Vector API (Incubator)</h4> \n<p>初步看，还以为是集合中的 Vector，原来不是！</p> \n<p>Vector API 这是一个新的初始迭代孵化器模块，模块包：jdk.incubator.vector，用于表示在运行时可靠地编译到支持的 CPU 架构上的最佳矢量硬件指令的矢量计算。</p> \n<p>很高端，搞不懂，后续有时间再研究。</p> \n<h4 id=\"389foreign-linker-api-incubator\">389:Foreign Linker API (Incubator)</h4> \n<p>引入了一个新的 API，该 API 提供了对本地 native 代码的静态类型访问支持。</p> \n<h4 id=\"393foreign-memory-access-api-third-incubator\">393:Foreign-Memory Access API (Third Incubator)</h4> \n<p>外部内存访问 API（三次孵化中），引入了一个新的 API，可以帮助 Java 应用程序更安全、有效地访问 Java 堆之外的外部内存。</p> \n<p>这个最早在 JDK 14 中成为孵化特性，JDK 15/ JDK 16 中继续二、三次孵化并对其 API 有了一些更新，这个可以在 JDK 17 中好好期待一下转正。</p> \n<h4 id=\"397sealed-classes-second-preview\">397:Sealed Classes (Second Preview)</h4> \n<p>封闭类（二次预览），可以是封闭类和或者封闭接口，用来增强 Java 编程语言，防止其他类或接口扩展或实现它们。</p> \n<p>来看下面这个示例：</p> \n<pre><code>public abstract sealed class Student\n    permits ZhangSan, LiSi, ZhaoLiu {\n    ...\n        \n}\n</code></pre> \n<p>类 Student 被 <code>sealed</code> 修饰，说明它是一个封闭类，并且只允许指定的 3 个子类继承。</p> \n<p>这个牛逼啊，有了这个特性，意味着以后不是你想继承就继承，想实现就实现了，你得经过允许才行，这个也可以在 JDK 17 中好好期待一下转正。</p> \n<h4 id=\"347enable-c14-language-features-in-the-jdk-source-code\">347:Enable C++14 Language Features (in the JDK source code)</h4> \n<p>允许在 JDK 底层的 C ++ 源代码中使用 C ++ 14 的新语言特性，并且提供了在 HotSpot 虚拟机代码中，哪些代码使用了这些新特性的指南。</p> \n<h4 id=\"357migrate-from-mercurial-to-git\">357:Migrate from Mercurial to Git</h4> \n<p>将 OpenJDK 社区的源代码存储库从 Mercurial（hg）迁移到 Git。</p> \n<h4 id=\"369migrate-to-github\">369:Migrate to GitHub</h4> \n<p>在 GitHub 上托管 OpenJDK 社区的 Git 存储库。</p> \n<h4 id=\"386alpine-linux-port\">386:Alpine Linux Port</h4> \n<p>在 x64 和 AArch64 平台体系结构上，将 JDK 移植到 Alpine Linux 以及使用 musl 作为其主要 C 语言库的其他 Linux 发行版中。</p> \n<h4 id=\"388windowsaarch64-port\">388:Windows/Aarch64 Port</h4> \n<p>将 JDK 移植到 Windows/ AArch64 平台系列。</p> \n<h2 id=\"总结\">总结</h2> \n<p>现在的 JDK 真变成了“版本帝”，无力吐槽啊，版本发到了 16，大部分人却都还在用着 JDK 7/8，甚至 6。不过没关系，多了解一下，多掌握一点新东西，对你来说没有坏处。</p> \n<p>虽然更新很快，但话又说回来，更是因为 Java 这种不断的更新、优化和创新，才使得 Java 保持着源源活力，Java 仍然是现在最成功、最主流的开发语言之一。</p> \n<p><strong>如果说 Java 第二，谁敢称第一呢？如果你说 PHP，那我 Respect!</strong></p> \n<p>最后，本文主要介绍了 JDK/Java 16 的 17 个新特性基本面，后面栈长有时间也会继续更新一些 JDK 新特性详细教程，关注公众号Java技术栈第一时间推送哦。如果你想看历史 Java 8+ 系列新特性教程，也可以在公众号菜单中进行阅读。</p> \n<p>往期 Java 教程及示例源码：</p> \n<blockquote> \n <p><a href=\"https://github.com/javastacks/javastack\" target=\"_blank\">https://github.com/javastacks/javastack</a></p> \n</blockquote> \n<p>OracleJDK 16 发布地址：</p> \n<blockquote> \n <p><a href=\"https://www.oracle.com/java/technologies/javase/16-relnotes.html\" target=\"_blank\">https://www.oracle.com/java/technologies/javase/16-relnotes.html</a></p> \n</blockquote> \n<p>OpenJDK 16 发布地址：</p> \n<blockquote> \n <p><a href=\"https://openjdk.java.net/projects/jdk/16/\" target=\"_blank\">https://openjdk.java.net/projects/jdk/16/</a></p> \n</blockquote> \n<p>Oracle JDK 16 下载地址：</p> \n<blockquote> \n <p><a href=\"https://www.oracle.com/java/technologies/javase-downloads.html\" target=\"_blank\">https://www.oracle.com/java/technologies/javase-downloads.html</a></p> \n</blockquote> \n<p>OpenJDK 16 下载地址：</p> \n<blockquote> \n <p><a href=\"https://jdk.java.net/16/\" target=\"_blank\">https://jdk.java.net/16/</a></p> \n</blockquote> \n<p>有兴趣的可以下载尝鲜了！！</p> \n<p>OracleJDK 和 OpenJDK 两者的区别这里不撰述了，不清楚的请点击<a href=\"https://mp.weixin.qq.com/s/FvGwskeFzSyB1n0aPVggAQ\" target=\"_blank\">这里</a>进行查看。</p> \n<p><strong>写了大半天，头发又在掉了。。。</strong></p> \n<p><strong>老铁们，点个在看、转发支持下哦，也欢迎分享给你的更多朋友们~</strong></p> \n<p>关注Java技术栈，持续分享最新、最主流的Java技术~</p> \n<blockquote> \n <p>版权申明：本文系公众号 \"Java技术栈\" 原创，原创实属不易，转载、引用本文内容请注明出处，禁止抄袭、洗稿，请自重，尊重他人劳动成果和知识产权。</p> \n</blockquote>', NULL, '2021-03-27 00:18:13', 0, NULL, NULL, 'https://www.cnblogs.com/javastack/p/14583578.html', 0, NULL);
INSERT INTO `t_blog` VALUES (286, '分布式事物的设计与实践', '<div class=\"index-module_header_3qjZG\"> \n <div class=\"index-module_title_1s0gC\"> \n  <h1 id=\"article-title\" class=\"index-module_articleTitle_2xHPX\">分布式事物设计与实践</h1> \n </div> \n</div> \n<div> \n <div class=\"yuque-doc-content\" data-df=\"lake\"> \n  <div class=\"lake-engine-view lake-typography-traditional\"> \n   <h2 id=\"c4NE5\" data-lake-id=\"e383f5ccc294bdb9dd524507d936ef2c\" data-wording=\"true\">数据一致性定义</h2> \n   <ul data-lake-id=\"a3c3965ff1797463108cae581d3be378\"> \n    <li data-lake-id=\"f53a3fdc9d6325fba75f4bf0d42da961\" data-wording=\"true\">任何人</li> \n    <li data-lake-id=\"d7c59a11687743d132df4ee0b6123133\" data-wording=\"true\">任何时间</li> \n    <li data-lake-id=\"63d57290237144632c0d7aaeaf997f9d\" data-wording=\"true\">任何地点</li> \n    <li data-lake-id=\"f33f59d950510bc6d9fa1eaad8ab9a7f\" data-wording=\"true\">任何接入方式</li> \n    <li data-lake-id=\"ef0cb32ef3c8a75a17345421050603ae\" data-wording=\"true\">任何服务</li> \n    <li data-lake-id=\"566666f9d092c994e0cd00973e85a4e5\" data-wording=\"true\">数据都是一致的</li> \n   </ul> \n   <h2 id=\"wOKom\" data-lake-id=\"9f11a538dd0ad00a37c4bfbbfdd212cf\" data-wording=\"true\">数据不一致产生的原因</h2> \n   <ul data-lake-id=\"b51550be5167fde9f8ee2d5a4ea56477\"> \n    <li data-lake-id=\"93080058b63915ef5136464c58d56b07\" data-wording=\"true\">数据分散在多处</li> \n   </ul> \n   <ul data-lake-id=\"97c72ddc5104bf221d5559724d3a6223\"> \n    <ul data-lake-id=\"08df728ef4537e5ca58bcebc4b3e3503\"> \n     <li data-lake-id=\"1610d957dd99144119c4629c3f51b9dd\" data-wording=\"true\">多个DB</li> \n     <li data-lake-id=\"1b3c847f7f9a6d4862fa75b257f422d4\" data-wording=\"true\">DB和缓存</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"3157b7140867f386a76baf3b065d75c9\"> \n    <li data-lake-id=\"c46b5c39d60228e9c9948949cd618ef8\" data-wording=\"true\">二手交易平台案例</li> \n   </ul> \n   <ul data-lake-id=\"52e7229e516123f190a2ed5f31d3fbba\"> \n    <ul data-lake-id=\"8e8f3008e73170d43f813ae2007826fb\"> \n     <li data-lake-id=\"6b29885aae500aab8871c2088f341cd8\" data-wording=\"true\">用户,交易,商品等功能</li> \n    </ul> \n   </ul> \n   <h2 id=\"B0jxo\" data-lake-id=\"276cc745c7b73a6d4a2102fdfff209ef\" data-wording=\"true\">分布式事物产生的原因</h2> \n   <p data-lake-id=\"f3ea1a7f383d1e9ce7521f27412cf872\" data-wording=\"true\">刚开始是一个单体进程</p> \n   <p data-lake-id=\"3b24a87461733dfa39627e6b0658991c\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616075252838-6f248096-73b3-4918-aefc-cc2698622fac.png%22%2C%22originWidth%22%3A110%2C%22originHeight%22%3A298%2C%22name%22%3A%22image.png%22%2C%22size%22%3A44675%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A26.465834%2C%22y%22%3A10.0314865%2C%22width%22%3A59.436136000000005%2C%22height%22%3A15.8813615%2C%22text%22%3A%22%E5%8D%95%E4%BD%93%E8%BF%9B%E7%A8%8B%22%7D%2C%7B%22x%22%3A24.140753%2C%22y%22%3A42.55392%2C%22width%22%3A66.822037%2C%22height%22%3A15.589832999999999%2C%22text%22%3A%22%E7%94%A8%E6%88%B7%E7%BB%84%E4%BB%B6%22%7D%2C%7B%22x%22%3A23.493446%2C%22y%22%3A77.3149%2C%22width%22%3A67.942688%2C%22height%22%3A16.81226000000001%2C%22text%22%3A%22%E5%95%86%E5%93%81%E7%BB%84%E4%BB%B6%22%7D%2C%7B%22x%22%3A21.857424%2C%22y%22%3A114.80014%2C%22width%22%3A67.10057599999999%2C%22height%22%3A17.759109999999993%2C%22text%22%3A%22%E4%BA%A4%E6%98%93%E7%BB%84%E4%BB%B6%22%7D%2C%7B%22x%22%3A32.45753%2C%22y%22%3A185.51607%2C%22width%22%3A45.499469999999995%2C%22height%22%3A15.390349999999984%2C%22text%22%3A%22%E6%95%B0%E6%8D%AE%E5%BA%93%22%7D%2C%7B%22x%22%3A30.88534%2C%22y%22%3A225.53967%2C%22width%22%3A49.47082%2C%22height%22%3A17.258430000000004%2C%22text%22%3A%22%E7%94%A8%E6%88%B7%E8%A1%A8%22%7D%2C%7B%22x%22%3A30.489603%2C%22y%22%3A247.21742%2C%22width%22%3A49.595946999999995%2C%22height%22%3A17.59172000000001%2C%22text%22%3A%22%E5%95%86%E5%93%81%E8%A1%A8%22%7D%2C%7B%22x%22%3A31.642%2C%22y%22%3A267.99008%2C%22width%22%3A48.439024%2C%22height%22%3A17.271299999999997%2C%22text%22%3A%22%E4%BA%A4%E6%98%93%E8%A1%A8%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22%E5%8D%95%E4%BD%93%E8%BF%9B%E7%A8%8B%20%E7%94%A8%E6%88%B7%E7%BB%84%E4%BB%B6%20%E5%95%86%E5%93%81%E7%BB%84%E4%BB%B6%20%E4%BA%A4%E6%98%93%E7%BB%84%E4%BB%B6%20%E6%95%B0%E6%8D%AE%E5%BA%93%20%E7%94%A8%E6%88%B7%E8%A1%A8%20%E5%95%86%E5%93%81%E8%A1%A8%20%E4%BA%A4%E6%98%93%E8%A1%A8%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A110%2C%22height%22%3A298%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/1e84c7e8-e1e4-4665-bbc5-4c6bc727d9cc.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"298px\"></span></p> \n   <p data-lake-id=\"9112baffd4b98395cd0fd73a8b6d35d1\" data-wording=\"true\">经过演变,单体式服务演变成微服务,每个服务都是单独的进程</p> \n   <p data-lake-id=\"d0cc25f965db874b909d68e0dfd9d3da\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616075313456-7a0893fa-df8a-4e66-b86d-4aa20233e76f.png%22%2C%22originWidth%22%3A351%2C%22originHeight%22%3A294%2C%22name%22%3A%22image.png%22%2C%22size%22%3A77861%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A131.05992%2C%22y%22%3A15.545827%2C%22width%22%3A88.74393%2C%22height%22%3A18.714026%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%22%7D%2C%7B%22x%22%3A21.132671%2C%22y%22%3A74.272484%2C%22width%22%3A77.131863%2C%22height%22%3A19.453005999999988%2C%22text%22%3A%22%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A252.544%2C%22y%22%3A74.28491%2C%22width%22%3A79.31265999999997%2C%22height%22%3A20.649839999999998%2C%22text%22%3A%22%E4%BA%A4%E6%98%93%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A136.77242%2C%22y%22%3A74.60432%2C%22width%22%3A78.06851999999998%2C%22height%22%3A19.9259%2C%22text%22%3A%22%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A262.76248%2C%22y%22%3A259.89108%2C%22width%22%3A59.345920000000035%2C%22height%22%3A20.130560000000003%2C%22text%22%3A%22%E4%BA%A4%E6%98%93%E5%BA%93%22%7D%2C%7B%22x%22%3A146.1447%2C%22y%22%3A262.70724%2C%22width%22%3A59.50801000000001%2C%22height%22%3A19.480140000000006%2C%22text%22%3A%22%E5%95%86%E5%93%81%E5%BA%93%22%7D%2C%7B%22x%22%3A29.985006%2C%22y%22%3A262.64703%2C%22width%22%3A59.714704%2C%22height%22%3A20.50137000000001%2C%22text%22%3A%22%E7%94%A8%E6%88%B7%E5%BA%93%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%20%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%20%E4%BA%A4%E6%98%93%E6%9C%8D%E5%8A%A1%20%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%20%E4%BA%A4%E6%98%93%E5%BA%93%20%E5%95%86%E5%93%81%E5%BA%93%20%E7%94%A8%E6%88%B7%E5%BA%93%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A351%2C%22height%22%3A294%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/9bbe5808-11e6-4de7-9b14-0a015faa853f.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"294px\"></span></p> \n   <p data-lake-id=\"53570634822e785126b4f7bd0a072336\" data-wording=\"true\">在用户请求量大的时候,为了缓解数据库的压力,添加了分布式缓存</p> \n   <p data-lake-id=\"3424809332f8be07e97525953bcd8f6c\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616075400881-a8b11a89-fb07-4aab-9f77-7f4d52e9e356.png%22%2C%22originWidth%22%3A426%2C%22originHeight%22%3A299%2C%22name%22%3A%22image.png%22%2C%22size%22%3A97525%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A169.40422%2C%22y%22%3A10.190427%2C%22width%22%3A87.32234%2C%22height%22%3A17.369996%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%22%7D%2C%7B%22x%22%3A174.37791%2C%22y%22%3A70.61774%2C%22width%22%3A77.72798999999998%2C%22height%22%3A19.81913%2C%22text%22%3A%22%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A58.009235%2C%22y%22%3A70.73649%2C%22width%22%3A77.882655%2C%22height%22%3A20.574640000000002%2C%22text%22%3A%22%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A290.05917%2C%22y%22%3A71.367%2C%22width%22%3A77.95548000000002%2C%22height%22%3A19.001194999999996%2C%22text%22%3A%22%E4%BA%A4%E6%98%93%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A165.61569%2C%22y%22%3A143.12111%2C%22width%22%3A81.70247%2C%22height%22%3A22.897890000000018%2C%22text%22%3A%22%E5%95%86%E5%93%81%E7%BC%93%E5%AD%98%22%7D%2C%7B%22x%22%3A51.849705%2C%22y%22%3A145.93456%2C%22width%22%3A79.163825%2C%22height%22%3A18.927030000000002%2C%22text%22%3A%22%E7%94%A8%E6%88%B7%E7%BC%93%E5%AD%98%22%7D%2C%7B%22x%22%3A288.19684%2C%22y%22%3A146.00017%2C%22width%22%3A80.34987999999998%2C%22height%22%3A19.40440000000001%2C%22text%22%3A%22%E4%BA%A4%E6%98%93%E7%BC%93%E5%AD%98%22%7D%2C%7B%22x%22%3A297.683%2C%22y%22%3A257.6023%2C%22width%22%3A61.9941%2C%22height%22%3A22.835839999999962%2C%22text%22%3A%22%E4%BA%A4%E6%98%93%E5%BA%93%22%7D%2C%7B%22x%22%3A182.89122%2C%22y%22%3A260.6507%2C%22width%22%3A59.13631000000001%2C%22height%22%3A20.11184000000003%2C%22text%22%3A%22%E5%95%86%E5%93%81%E5%BA%93%22%7D%2C%7B%22x%22%3A66.68122%2C%22y%22%3A260.94592%2C%22width%22%3A59.50519%2C%22height%22%3A20.654299999999978%2C%22text%22%3A%22%E7%94%A8%E6%88%B7%E5%BA%93%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%20%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%20%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%20%E4%BA%A4%E6%98%93%E6%9C%8D%E5%8A%A1%20%E5%95%86%E5%93%81%E7%BC%93%E5%AD%98%20%E7%94%A8%E6%88%B7%E7%BC%93%E5%AD%98%20%E4%BA%A4%E6%98%93%E7%BC%93%E5%AD%98%20%E4%BA%A4%E6%98%93%E5%BA%93%20%E5%95%86%E5%93%81%E5%BA%93%20%E7%94%A8%E6%88%B7%E5%BA%93%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A426%2C%22height%22%3A299%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/718a6ead-1c0d-4253-ac7e-b6af499be8cd.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"299px\"></span></p> \n   <h2 id=\"H7QLG\" data-lake-id=\"38c3bcd8b937d177b022fc78aad719d7\" data-wording=\"true\">分布式事物案例</h2> \n   <p data-lake-id=\"686b59ae308d0eb3c61858f73cb21e68\" data-wording=\"true\">电商平台购买商品</p> \n   <p data-lake-id=\"7de1f7e0c8fb66e9cbb51b67b81275aa\" data-wording=\"true\">下单-&gt;减库存-&gt;支付</p> \n   <p data-lake-id=\"233e77c0902816fe117d4c2cb832a806\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616075646956-f112190d-1fcc-4adb-a19b-a8d0b918aecf.png%22%2C%22originWidth%22%3A393%2C%22originHeight%22%3A312%2C%22name%22%3A%22image.png%22%2C%22size%22%3A86187%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A155.81378%2C%22y%22%3A15.031186%2C%22width%22%3A71.12544%2C%22height%22%3A17.067229000000005%2C%22text%22%3A%22APP%E8%AF%B7%E6%B1%82%22%7D%2C%7B%22x%22%3A288.47003%2C%22y%22%3A91.83728%2C%22width%22%3A79.03704999999997%2C%22height%22%3A20.217039999999997%2C%22text%22%3A%22%E6%94%AF%E4%BB%98%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A20.5608%2C%22y%22%3A92.03159%2C%22width%22%3A94.08873%2C%22height%22%3A20.011745000000005%2C%22text%22%3A%22%E4%B8%8B%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A148.75555%2C%22y%22%3A92.50491%2C%22width%22%3A98.19019%2C%22height%22%3A18.996036000000004%2C%22text%22%3A%22%E5%87%8F%E5%BA%93%E5%AD%98%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A298.46014%2C%22y%22%3A271.87592%2C%22width%22%3A59.10795999999999%2C%22height%22%3A20.735479999999995%2C%22text%22%3A%22%E4%BA%A4%E6%98%93%E5%BA%93%22%7D%2C%7B%22x%22%3A36.8448%2C%22y%22%3A272.08725%2C%22width%22%3A60.468610000000005%2C%22height%22%3A20.96069%2C%22text%22%3A%22%E8%AE%A2%E5%8D%95%E5%BA%93%22%7D%2C%7B%22x%22%3A168.14342%2C%22y%22%3A272.57858%2C%22width%22%3A60.41621000000001%2C%22height%22%3A20.200660000000028%2C%22text%22%3A%22%E5%95%86%E5%93%81%E5%BA%93%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22APP%E8%AF%B7%E6%B1%82%20%E6%94%AF%E4%BB%98%E6%9C%8D%E5%8A%A1%20%E4%B8%8B%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%20%E5%87%8F%E5%BA%93%E5%AD%98%E6%9C%8D%E5%8A%A1%20%E4%BA%A4%E6%98%93%E5%BA%93%20%E8%AE%A2%E5%8D%95%E5%BA%93%20%E5%95%86%E5%93%81%E5%BA%93%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A393%2C%22height%22%3A312%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/f55f2f7d-898f-4ef2-ac6d-c6d8fa02a4f7.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"312px\"></span></p> \n   <p data-lake-id=\"9dc564e514f8774dff0b13417d0906e0\" data-wording=\"true\">这就是分布式事物问题,当APP要买东西,这个操作会涉及到多个服务,意味着要操作多个数据库,这样本地事物就无法保证数据的一致性,所以就产生了分布式事物问题.</p> \n   <h2 id=\"A4X2B\" data-lake-id=\"3f68bcfbdeb54c7783950fd7fa9ce707\" data-wording=\"true\">分布式事物场景</h2> \n   <ul data-lake-id=\"19c10fa491c9007177dab532c56db808\"> \n    <li data-lake-id=\"3ecbb2b6798acd94e89d1bc2ecae7079\" data-wording=\"true\">电商下单场景</li> \n   </ul> \n   <ul data-lake-id=\"babdd9614921acba349b9c612a62d589\"> \n    <ul data-lake-id=\"7340bf67d6cc540f122031d992ebdcc1\"> \n     <li data-lake-id=\"83d654867213159f72952384d712c949\" data-wording=\"true\">下单</li> \n     <li data-lake-id=\"4a639de8b3b2eb71a7ab55a77af2b452\" data-wording=\"true\">发送消息到MQ</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"227d3d35fbfe32ea373fd4db37753d45\"> \n    <li data-lake-id=\"2591c9b9755821ddf0fb61b2d1e0d4c4\" data-wording=\"true\">一致性保证</li> \n   </ul> \n   <ul data-lake-id=\"b315cfe88d08efc9cd7a9004f15911b3\"> \n    <ul data-lake-id=\"89318d9cb90e30f2bd63698bd7607557\"> \n     <li data-lake-id=\"c5f3f5b1de4a3fd362031d8a60236587\" data-wording=\"true\">本地事物</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"8bacaf8e4d3eba8acfcc4aa8778a9573\"> \n    <ul data-lake-id=\"31c94eeaacd556a5f4a4b25899d39d7f\"> \n     <ul data-lake-id=\"35a34616b27115ff16a9f9472bed976e\"> \n      <li data-lake-id=\"5647ff89a53bd00fbd776ffbefa35edf\" data-wording=\"true\">下单操作</li> \n      <li data-lake-id=\"513561ec18d900f5e9d2c4ecbb744dee\" data-wording=\"true\">发送MQ消息操作</li> \n      <li data-lake-id=\"9cbfb440e7904fdbcb3aef3c08a51c19\" data-wording=\"true\">放进一个本地事物</li> \n     </ul> \n    </ul> \n   </ul> \n   <p data-lake-id=\"e367ce4e68469ce3631799d0802f9411\" data-wording=\"true\">上述做法有什么问题?</p> \n   <p data-lake-id=\"8fd10dbd8fada6b5bccdd518ace83d66\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616076158657-dece2449-de1c-43ef-b434-77d56e73eb60.png%22%2C%22originWidth%22%3A371%2C%22originHeight%22%3A401%2C%22name%22%3A%22image.png%22%2C%22size%22%3A69390%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A1.6562983%2C%22y%22%3A13.94899%2C%22width%22%3A55.3558057%2C%22height%22%3A12.612329999999998%2C%22text%22%3A%22IJave%E7%A4%BA%E4%BF%9D%E4%BB%A3%E9%AA%A8%22%7D%2C%7B%22x%22%3A0.84462017%2C%22y%22%3A30.572767%2C%22width%22%3A17.11630783%2C%22height%22%3A11.102637000000001%2C%22text%22%3A%22tyl%22%7D%2C%7B%22x%22%3A20.680017%2C%22y%22%3A44.277348%2C%22width%22%3A145.337683%2C%22height%22%3A14.176096999999999%2C%22text%22%3A%22conm-DriverManager-getCornectiord%22%7D%2C%7B%22x%22%3A33.00185%2C%22y%22%3A59.378628%2C%22width%22%3A206.47665%2C%22height%22%3A12.567212000000005%2C%22text%22%3A%22abcmptineampr.3306.xocoanao3omsmoro%22%7D%2C%7B%22x%22%3A249.88222%2C%22y%22%3A60.090008%2C%22width%22%3A118.14511999999999%2C%22height%22%3A12.275692000000006%2C%22text%22%3A%22SOLORDARDASeSMA-ORDO%E5%8D%A1%22%7D%2C%7B%22x%22%3A20.438467%2C%22y%22%3A75.54827%2C%22width%22%3A118.178733%2C%22height%22%3A12.534654000000003%2C%22text%22%3A%22stmtcorncreateStatemente%3A%22%7D%2C%7B%22x%22%3A19.74645%2C%22y%22%3A105.28004%2C%22width%22%3A79.02948%2C%22height%22%3A12.719014000000001%2C%22text%22%3A%22%E6%8D%AE%E5%8D%97%E7%94%9F%E6%88%90%E8%AE%A2%E5%8D%95%E6%8B%9B%E4%BD%9C%22%7D%2C%7B%22x%22%3A20.368753%2C%22y%22%3A119.19038%2C%22width%22%3A306.318717%2C%22height%22%3A15.531939999999992%2C%22text%22%3A%22stmtexeautetpdatelnsertorderTeblluesocerD.estamppice%2Cstate%22%7D%2C%7B%22x%22%3A19.070738%2C%22y%22%3A136.00485%2C%22width%22%3A79.73968199999999%2C%22height%22%3A12.481279999999998%2C%22text%22%3A%22%E6%80%A7%E6%88%90%E5%8F%91%E9%80%81%E7%9A%84%E9%85%92%E6%81%AF%E5%86%85%E5%AE%B9%22%7D%2C%7B%22x%22%3A18.397898%2C%22y%22%3A151.2885%2C%22width%22%3A126.238122%2C%22height%22%3A13.264749999999992%2C%22text%22%3A%22MsgobjectMsgContent(orderiDr%22%7D%2C%7B%22x%22%3A19.877317%2C%22y%22%3A166.71046%2C%22width%22%3A54.727357999999995%2C%22height%22%3A12.11466999999999%2C%22text%22%3A%22%E5%8F%91%E9%80%81%E6%B6%A6%E6%81%AF%E6%8B%9B%E4%BD%9C%22%7D%2C%7B%22x%22%3A18.634485%2C%22y%22%3A182.67775%2C%22width%22%3A125.79787499999999%2C%22height%22%3A12.757370000000009%2C%22text%22%3A%22MOCHentsendMsg(wsgContenth%2C%22%7D%2C%7B%22x%22%3A21.2701%2C%22y%22%3A198.131%2C%22width%22%3A38.056152%2C%22height%22%3A12.03325000000001%2C%22text%22%3A%22%E5%B0%8F%E7%B3%BB%E5%8A%A1%E6%8F%90%E4%BA%A4%22%7D%2C%7B%22x%22%3A18.418547%2C%22y%22%3A213.67827%2C%22width%22%3A58.244507999999996%2C%22height%22%3A11.999140000000011%2C%22text%22%3A%22com.commim%3A%3B%22%7D%2C%7B%22x%22%3A0.8228147%2C%22y%22%3A243.77733%2C%22width%22%3A84.24914530000001%2C%22height%22%3A13.733810000000005%2C%22text%22%3A%22catchErceptonel%22%7D%2C%7B%22x%22%3A17.329597%2C%22y%22%3A258.67715%2C%22width%22%3A80.421479%2C%22height%22%3A13.692049999999995%2C%22text%22%3A%22ecprintStackTrace0%3B%22%7D%2C%7B%22x%22%3A1.5262183%2C%22y%22%3A276.0215%2C%22width%22%3A19.3201767%2C%22height%22%3A11.006899999999973%2C%22text%22%3A%22try(%22%7D%2C%7B%22x%22%3A17.873281%2C%22y%22%3A289.00385%2C%22width%22%3A72.970009%2C%22height%22%3A14.803350000000023%2C%22text%22%3A%22%E6%93%8D%E4%BD%9C%E4%B8%8D%E6%88%90%E5%8A%9F%E5%88%99%E5%9B%9E%E9%80%92%22%7D%2C%7B%22x%22%3A17.070185%2C%22y%22%3A306.00443%2C%22width%22%3A62.03149500000001%2C%22height%22%3A11.302939999999978%2C%22text%22%3A%22comralbac%E5%A6%820%22%7D%2C%7B%22x%22%3A1.4749628%2C%22y%22%3A334.77963%2C%22width%22%3A79.2644172%2C%22height%22%3A14.840239999999994%2C%22text%22%3A%22catchErcepdionejt%22%7D%2C%7B%22x%22%3A19.579523%2C%22y%22%3A352.02994%2C%22width%22%3A74.343607%2C%22height%22%3A11.274159999999995%2C%22text%22%3A%22eprntStacclraceo%3A%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22IJave%E7%A4%BA%E4%BF%9D%E4%BB%A3%E9%AA%A8%20tyl%20conm-DriverManager-getCornectiord%20abcmptineampr.3306.xocoanao3omsmoro%20SOLORDARDASeSMA-ORDO%E5%8D%A1%20stmtcorncreateStatemente%3A%20%E6%8D%AE%E5%8D%97%E7%94%9F%E6%88%90%E8%AE%A2%E5%8D%95%E6%8B%9B%E4%BD%9C%20stmtexeautetpdatelnsertorderTeblluesocerD.estamppice%2Cstate%20%E6%80%A7%E6%88%90%E5%8F%91%E9%80%81%E7%9A%84%E9%85%92%E6%81%AF%E5%86%85%E5%AE%B9%20MsgobjectMsgContent(orderiDr%20%E5%8F%91%E9%80%81%E6%B6%A6%E6%81%AF%E6%8B%9B%E4%BD%9C%20MOCHentsendMsg(wsgContenth%2C%20%E5%B0%8F%E7%B3%BB%E5%8A%A1%E6%8F%90%E4%BA%A4%20com.commim%3A%3B%20catchErceptonel%20ecprintStackTrace0%3B%20try(%20%E6%93%8D%E4%BD%9C%E4%B8%8D%E6%88%90%E5%8A%9F%E5%88%99%E5%9B%9E%E9%80%92%20comralbac%E5%A6%820%20catchErcepdionejt%20eprntStacclraceo%3A%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A371%2C%22height%22%3A401%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/de34ebf0-c46e-478a-af51-95b08747b3db.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"401px\"></span></p> \n   <p data-lake-id=\"746a6597f5aff5edd3c335219da61c77\" data-wording=\"true\">问题:如果发送消息超时了,你是不知道MQ的返回结果是成功和失败的,,timeout这操作不是一个原子的</p> \n   <p data-lake-id=\"2a9131355c1579cd4dad69d315fe5f99\">&nbsp;</p> \n   <h2 id=\"QUeWL\" data-lake-id=\"cb75ad7183fd12e6ad023ae52b663cc3\" data-wording=\"true\">分布式事物分类</h2> \n   <ul data-lake-id=\"e79ad7a088741d2954bdaf4d23d9d355\"> \n    <li data-lake-id=\"7a9ee469df5398eed1f69d0da715b667\" data-wording=\"true\">刚性分布式事物</li> \n   </ul> \n   <ul data-lake-id=\"1a24f58121049ecbb96e1d15f1be46a3\"> \n    <ul data-lake-id=\"813ec382f0c5871406172011e97fb911\"> \n     <li data-lake-id=\"1554bd4622a7a8c08c96cc7531c1923f\" data-wording=\"true\">强一致性</li> \n     <li data-lake-id=\"4ec55a173f7d2f1984a64f30a114d8e4\" data-wording=\"true\">XA模型</li> \n     <li data-lake-id=\"addf159cd1efb80ebecf0ea135d14e60\" data-wording=\"true\">CAP</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"0f8a1c6aec79976ac9e1c8da8e6c5f4b\"> \n    <ul data-lake-id=\"74aaa91bd0c826606bcb0aafd83d05c7\"> \n     <ul data-lake-id=\"0e6e997b0635064180aabcf8cc5295a8\"> \n      <li data-lake-id=\"91bb864f00d79ca95616e76e23465b42\" data-wording=\"true\">CP</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"751b0e82b4493c8ae2817148c968d5d4\"> \n    <li data-lake-id=\"26ad6448c90b68991bb4573df3804e74\" data-wording=\"true\">柔性分布式事物</li> \n   </ul> \n   <ul data-lake-id=\"458f6ae5c50df706cda87a727fb3add9\"> \n    <ul data-lake-id=\"62eaaaec8eb757c739bcaee95990bdbf\"> \n     <li data-lake-id=\"73254dfda7b33f319d1026a5d3ff6137\" data-wording=\"true\">最终一致性</li> \n     <li data-lake-id=\"995b112fc915b307a8b0f666a195de38\" data-wording=\"true\">CAP,BASE理论</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"bdb9009b37c60d6162182e729aea52f9\"> \n    <ul data-lake-id=\"9b7c5e2180a102148dd8315afbb42e6b\"> \n     <ul data-lake-id=\"a70a4d88cd63bf1cc4333afcd00f06ac\"> \n      <li data-lake-id=\"270771d3aa85b9d40c2f37bfb78f0ef9\" data-wording=\"true\">AP</li> \n     </ul> \n    </ul> \n   </ul> \n   <h2 id=\"Ka6cy\" data-lake-id=\"961bdab028cff8d2d9d78ec08c4f82dd\" data-wording=\"true\">刚性分布式事物</h2> \n   <p data-lake-id=\"60c9192a397926f5b004b4f447205323\" data-wording=\"true\">满足传统事物特性</p> \n   <p data-lake-id=\"b656bfb9342c04644d33b2c54bd7884e\" data-wording=\"true\">ACID( Atomicity-原子性, Consistency-一致性,Isolation-隔离性,Durability-持久性)</p> \n   <p data-lake-id=\"bf5649f65264a41d4630622a9615ae59\" data-wording=\"true\">XA模型</p> \n   <ul data-lake-id=\"e0429918a0f1556a8bd5b6053d6d329c\"> \n    <li data-lake-id=\"a2816d4eb305b13156dc255ed6c96aac\" data-wording=\"true\">XA是X/Open CAE Specification(Distributed Transaction Processing)模型中定义,XA规范由AP,RM,TM组成</li> \n    <li data-lake-id=\"b9c67239e918db1031836c4ab596c89f\" data-wording=\"true\">其中应用程序(Application Program简称AP),AP定义事物边界(定义事物开始和结束)并访问边界事物内的资源</li> \n    <li data-lake-id=\"285445630ac17b3bf4614b3c825ce507\" data-wording=\"true\">资源管理器(Resource Manager简称RM),RM管理计算机共享的资源,资源及数据库等</li> \n    <li data-lake-id=\"c027b6f82da28d4f6f64c88e45e9598d\" data-wording=\"true\">事物管理器(Transaction Manager,简称TM),负责管理全局事物,分配事物唯一标识,监控事物的执行进度,并负责事物的提交,,回滚,失败恢复等</li> \n   </ul> \n   <p data-lake-id=\"a648bc65d0cabe47215ba8929f5fd077\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616333026417-8c21b581-5b31-45b8-ba32-25729450bff7.png%22%2C%22originWidth%22%3A725%2C%22originHeight%22%3A285%2C%22name%22%3A%22image.png%22%2C%22size%22%3A91366%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A241.10835%2C%22y%22%3A31.439127%2C%22width%22%3A214.30721000000003%2C%22height%22%3A22.193413%2C%22text%22%3A%22ApplicationProgram(AP)%22%7D%2C%7B%22x%22%3A561.8055%2C%22y%22%3A63.201984%2C%22width%22%3A96.29109999999991%2C%22height%22%3A16.645065999999993%2C%22text%22%3A%22(2)APdefines%22%7D%2C%7B%22x%22%3A47.864613%2C%22y%22%3A76.60089%2C%22width%22%3A81.330307%2C%22height%22%3A18.471129999999988%2C%22text%22%3A%22(1)APuses%22%7D%2C%7B%22x%22%3A569.2146%2C%22y%22%3A83.42721%2C%22width%22%3A77.303%2C%22height%22%3A14.085219999999993%2C%22text%22%3A%22transaction%22%7D%2C%7B%22x%22%3A36.865337%2C%22y%22%3A96.166115%2C%22width%22%3A102.741903%2C%22height%22%3A15.031884999999988%2C%22text%22%3A%22resourcesfrom%22%7D%2C%7B%22x%22%3A568.4886%2C%22y%22%3A100.76617%2C%22width%22%3A78.9307%2C%22height%22%3A14.566810000000004%2C%22text%22%3A%22boundaries%22%7D%2C%7B%22x%22%3A45.42778%2C%22y%22%3A114.18273%2C%22width%22%3A85.64526%2C%22height%22%3A13.820000000000007%2C%22text%22%3A%22asetofRMs%22%7D%2C%7B%22x%22%3A567.2019%2C%22y%22%3A117.90747%2C%22width%22%3A82.33219999999994%2C%22height%22%3A15.189509999999999%2C%22text%22%3A%22throughthe%22%7D%2C%7B%22x%22%3A567.75665%2C%22y%22%3A135.83398%2C%22width%22%3A83.45898999999997%2C%22height%22%3A15.004170000000016%2C%22text%22%3A%22TXinterface%22%7D%2C%7B%22x%22%3A405.26736%2C%22y%22%3A147.70091%2C%22width%22%3A97.28417999999999%2C%22height%22%3A18.52854000000002%2C%22text%22%3A%22Transaction%22%7D%2C%7B%22x%22%3A182.31065%2C%22y%22%3A157.43327%2C%22width%22%3A75.40825000000001%2C%22height%22%3A17.31978000000001%2C%22text%22%3A%22Resource%22%7D%2C%7B%22x%22%3A415.9611%2C%22y%22%3A168.6743%2C%22width%22%3A76.5118%2C%22height%22%3A19.02340000000001%2C%22text%22%3A%22Manager%22%7D%2C%7B%22x%22%3A179.14629%2C%22y%22%3A178.50175%2C%22width%22%3A83.37690999999998%2C%22height%22%3A19.24642%2C%22text%22%3A%22Managers%22%7D%2C%7B%22x%22%3A435.44308%2C%22y%22%3A191.06267%2C%22width%22%3A38.690740000000005%2C%22height%22%3A17.925610000000006%2C%22text%22%3A%22(TM)%22%7D%2C%7B%22x%22%3A197.78786%2C%22y%22%3A198.97054%2C%22width%22%3A45.44775000000001%2C%22height%22%3A17.020870000000002%2C%22text%22%3A%22RMs)%22%7D%2C%7B%22x%22%3A603.73346%2C%22y%22%3A243.75659%2C%22width%22%3A68.27086999999995%2C%22height%22%3A23.563140000000004%2C%22text%22%3A%22XA%E6%A8%A1%E5%9E%8B%22%7D%2C%7B%22x%22%3A169.17384%2C%22y%22%3A247.37097%2C%22width%22%3A340.01829999999995%2C%22height%22%3A16.957769999999982%2C%22text%22%3A%223)TMandRMsexchangetransactionInformation%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22ApplicationProgram(AP)%20(2)APdefines%20(1)APuses%20transaction%20resourcesfrom%20boundaries%20asetofRMs%20throughthe%20TXinterface%20Transaction%20Resource%20Manager%20Managers%20(TM)%20RMs)%20XA%E6%A8%A1%E5%9E%8B%203)TMandRMsexchangetransactionInformation%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A725%2C%22height%22%3A285%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/e5c6b16e-7761-42fe-8df5-092268dba60b.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"285px\"></span></p> \n   <h3 id=\"cGvfH\" data-lake-id=\"c258a904a5a82270912f151fed20475c\" data-wording=\"true\">2PC(两阶段提交-XA规范标准实现)</h3> \n   <ul data-lake-id=\"e55c92c1dfbc6519f705f42a5ff73e78\"> \n    <li data-lake-id=\"262e395f59b78b70216071f711046e44\" data-wording=\"true\">案例</li> \n   </ul> \n   <ul data-lake-id=\"cba7d437871ba74b6844e5b7a17aa382\"> \n    <ul data-lake-id=\"bcec573469bb4e849ecc461ad4f20574\"> \n     <li data-lake-id=\"e6abb326386e6fd187ac9d80815425e7\" data-wording=\"true\">组织爬山</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"7726cfd83f5a52bfadfedc552620f75b\"> \n    <li data-lake-id=\"26b9b4379562508bb6199661cdf00f91\" data-wording=\"true\">过程</li> \n   </ul> \n   <ul data-lake-id=\"bf38a04275c465acf623d6f0d1562494\"> \n    <ul data-lake-id=\"7e7bb78ca3c0edbc94589092f7ae5287\"> \n     <li data-lake-id=\"5b48d6ad29ef54632f0250ba7c3bbfa7\" data-wording=\"true\">二阶段提交,是XA规范的标准实现</li> \n     <li data-lake-id=\"2433eb87c9dfd70b33eb95f65ea2660b\" data-wording=\"true\">TM发起prepare投票</li> \n     <li data-lake-id=\"60a4e6ad9e3c4d3ba3167197ce030e38\" data-wording=\"true\">RM都同意后,TM再发起Commit</li> \n     <li data-lake-id=\"f138f9f47bc18fe044c2fff7f303c89f\" data-wording=\"true\">Commit 过程出现宕机等异常,节点服务重启后,根据XA recover 再次进行commit补偿</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"21040cf8576ecccdd8906eff1440a988\"> \n    <li data-lake-id=\"d13920883af0ad7f88e8342317e0faa3\" data-wording=\"true\">缺点</li> \n   </ul> \n   <ul data-lake-id=\"7cd84a0872030de942e38f7fa4b59b97\"> \n    <ul data-lake-id=\"5d2c17010217bdcf07e8e401ae249fc9\"> \n     <li data-lake-id=\"d598388fc1c22b5ae137b2f6c3fecd98\" data-wording=\"true\">同步阻塞模型</li> \n     <li data-lake-id=\"92b1ae1b00be122c54637bef8be8cfe2\" data-wording=\"true\">数据库资源锁定时间过长</li> \n     <li data-lake-id=\"4f479db61fe1f192a36c175a96584a15\" data-wording=\"true\">全局锁(隔离级别-串行化),并发低</li> \n     <li data-lake-id=\"9926538f4745f116f0969174e88c5630\" data-wording=\"true\">不适合长事物场景</li> \n    </ul> \n   </ul> \n   <p data-lake-id=\"02a05e7ade329d289c79b32fe849a2ba\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616333439659-5c3298f0-5e98-4470-9764-72fceed077ae.png%22%2C%22originWidth%22%3A375%2C%22originHeight%22%3A288%2C%22name%22%3A%22image.png%22%2C%22size%22%3A44961%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A117.20339%2C%22y%22%3A7.7412643%2C%22width%22%3A43.253460000000004%2C%22height%22%3A8.864995699999998%2C%22text%22%3A%22Teanacton%22%7D%2C%7B%22x%22%3A24.133337%2C%22y%22%3A11.7699585%2C%22width%22%3A41.817173%2C%22height%22%3A8.6384275%2C%22text%22%3A%22AOPLKCTON%22%7D%2C%7B%22x%22%3A121.31037%2C%22y%22%3A17.175776%2C%22width%22%3A33.87979999999999%2C%22height%22%3A7.887388000000001%2C%22text%22%3A%22MaN9E%22%7D%2C%7B%22x%22%3A76.38616%2C%22y%22%3A54.131413%2C%22width%22%3A28.536990000000003%2C%22height%22%3A7.868583000000001%2C%22text%22%3A%22ComTt%22%7D%2C%7B%22x%22%3A169.9423%2C%22y%22%3A68.148926%2C%22width%22%3A34.82064%2C%22height%22%3A8.153937999999997%2C%22text%22%3A%22PCparro%22%7D%2C%7B%22x%22%3A170.68593%2C%22y%22%3A117.29413%2C%22width%22%3A34.730999999999995%2C%22height%22%3A8.036190000000005%2C%22text%22%3A%22preDareo%22%7D%2C%7B%22x%22%3A185.61708%2C%22y%22%3A136.66667%2C%22width%22%3A12.382900000000006%2C%22height%22%3A10%2C%22text%22%3A%22oK%22%7D%2C%7B%22x%22%3A170.50175%2C%22y%22%3A160.01576%2C%22width%22%3A34.34525000000002%2C%22height%22%3A8.15589%2C%22text%22%3A%22Com74o%22%7D%2C%7B%22x%22%3A180.86584%2C%22y%22%3A182.8628%2C%22width%22%3A13.212410000000006%2C%22height%22%3A7.4528700000000185%2C%22text%22%3A%220%22%7D%2C%7B%22x%22%3A167.69757%2C%22y%22%3A208.3448%2C%22width%22%3A33.545949999999976%2C%22height%22%3A7.681030000000021%2C%22text%22%3A%22Commito%22%7D%2C%7B%22x%22%3A176.3983%2C%22y%22%3A231.99193%2C%22width%22%3A15.369299999999981%2C%22height%22%3A8.358920000000012%2C%22text%22%3A%22oX%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22Teanacton%20AOPLKCTON%20MaN9E%20ComTt%20PCparro%20preDareo%20oK%20Com74o%200%20Commito%20oX%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A375%2C%22height%22%3A288%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/59b7e5e7-9735-4afc-9afd-960e5ad17f38.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"288px\"></span></p> \n   <h2 id=\"i9IUn\" data-lake-id=\"556eb3b806d35490702a251fa94d2ee1\" data-wording=\"true\">柔性分布式事物</h2> \n   <ul data-lake-id=\"a6c1836a35f7cf0f53d16347d68236c7\"> \n    <li data-lake-id=\"13f44460e2d4db2481e64104431ff550\" data-wording=\"true\">CAP</li> \n   </ul> \n   <ul data-lake-id=\"d5362dc45df845f8985de5401ccde828\"> \n    <ul data-lake-id=\"b553af16e89ff20de789ca89e188d953\"> \n     <li data-lake-id=\"acb9172da79e08d12f4ca81d0dc58c77\" data-wording=\"true\">分布式环境下P一定需要,CA权衡折中</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"9682a317e3c54b229fb8156fd5f53796\"> \n    <li data-lake-id=\"e40c2ddff2204967b2b94d538bf27560\" data-wording=\"true\">BASE理论</li> \n   </ul> \n   <ul data-lake-id=\"00c8e2d081e896f724c32c949b4a325a\"> \n    <ul data-lake-id=\"8d01c6b086b59c8897e2d669e2dfcaa0\"> \n     <li data-lake-id=\"4785289019d4ba7bd1f427215eb6e1b7\" data-wording=\"true\">Basically Available-基本可用</li> \n     <li data-lake-id=\"8fc2d2ed22a123a758b73427e5dff34d\" data-wording=\"true\">Soft state 柔性状态</li> \n     <li data-lake-id=\"8e5cf27fec8b5cb6e49af22a7fd11737\" data-wording=\"true\">Eventual consistency 最终一致性</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"226ba4baacf808de3affc6649ce656d2\"> \n    <li data-lake-id=\"cf83a43cc550b60d319d38e4f52d8c0a\" data-wording=\"true\">架构思考</li> \n   </ul> \n   <ul data-lake-id=\"26781aa3e92cb599ee761787ae04eb05\"> \n    <ul data-lake-id=\"15702c1e2b0b00a0846345d4d9831d00\"> \n     <li data-lake-id=\"4363ffb853615f037a29968397511a8b\" data-wording=\"true\">柔性事物是对XA协议的妥协,他通过降低强一致性要求,从而降低数据库资源锁定时间,提升可用性</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"43595b4e47af17cd541706b025e151c0\"> \n    <li data-lake-id=\"fb5f1e196f716ab648d8cd5c924cdca1\" data-wording=\"true\">架构经典实现</li> \n   </ul> \n   <ul data-lake-id=\"9430939cf7a6b24de80c188e2bf620e5\"> \n    <ul data-lake-id=\"ef3d2567333291e324cd26b24347c9e4\"> \n     <li data-lake-id=\"00a0aa72a54795f35816faa5498b933e\" data-wording=\"true\">TCC模型</li> \n     <li data-lake-id=\"8d0ecab5b9ee4ef7db2ad5277ae12ec6\" data-wording=\"true\">Saga模型</li> \n    </ul> \n   </ul> \n   <p data-lake-id=\"309fc756954ca539e9dbd6373d48988f\">&nbsp;</p> \n   <h3 id=\"sS0zY\" data-lake-id=\"a67bfc9a8cb56cb801e9a1ed3ecd7ab1\" data-wording=\"true\">TCC模型</h3> \n   <ul data-lake-id=\"002c6ea83b3155511041b9b469012218\"> \n    <li data-lake-id=\"8b9570882a56a993ebab254aee6ed2f7\" data-wording=\"true\">Try-confirm-cancel</li> \n    <li data-lake-id=\"8ddf1efeebdfcf1cdc9899514a0d4fe5\" data-wording=\"true\">TCC模型完全交由业务实现,每个子业务都需要实现Try-Confirm-cancel接口,对业务侵入大</li> \n   </ul> \n   <ul data-lake-id=\"6a928e0984f15d1d8f1cec79aaa66f63\"> \n    <ul data-lake-id=\"1a8a0c98d52445fba635335112911bd8\"> \n     <li data-lake-id=\"150a4fb2bc46eee2601ba2743b82201e\" data-wording=\"true\">资源锁定交由业务方</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"a1dbb35fbde8f338e1868b8fadca58a0\"> \n    <li data-lake-id=\"879c192b80dc9667c5afd9a5bb46cd25\" data-wording=\"true\">try</li> \n   </ul> \n   <ul data-lake-id=\"8123862e67f89de186be44f440bebd21\"> \n    <ul data-lake-id=\"6714fb31d71127c27cd46a24d383d958\"> \n     <li data-lake-id=\"cafc6e20d2b1f92e28311c7db0ae08c8\" data-wording=\"true\">尝试执行业务,完成所有检查,预留必要的业务资源</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"cb14e78daae6557b44033b2d6ce0025c\"> \n    <li data-lake-id=\"d6ed2fd94bc276f5ea528e206d4a4596\" data-wording=\"true\">confirm</li> \n   </ul> \n   <ul data-lake-id=\"820c5dee2c93ca7f5086338af1cde2bc\"> \n    <ul data-lake-id=\"ea85a9951bc15a6ac64c1ca82a76e4de\"> \n     <li data-lake-id=\"99154a69130d48d314772b46c199fa60\" data-wording=\"true\">真正执行业务,不再做业务检查</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"77a6312f727320e99f49d97c705a7195\"> \n    <li data-lake-id=\"1f91fa964db8391efa61a3d22f06d272\" data-wording=\"true\">Cancel</li> \n   </ul> \n   <ul data-lake-id=\"66fe831648b3f17247a1cfe846c719b1\"> \n    <ul data-lake-id=\"43a2f9778d0f6d7186d451bef4b4fff5\"> \n     <li data-lake-id=\"9e5c57ad579b8ac9949a7e75c5ae712e\" data-wording=\"true\">释放Try阶段预留的业务资源</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"27d2a5d75b7ee220f19e55536b337acb\"> \n    <li data-lake-id=\"1217e0c376f2a4f46c308fa7f5f0a703\" data-wording=\"true\">案例</li> \n   </ul> \n   <ul data-lake-id=\"52a40518a82813db7ce4f949b196a27b\"> \n    <ul data-lake-id=\"01a8435ca2e788c87a6144eddd96e44b\"> \n     <li data-lake-id=\"5b8d1c431e4d964f9b42c361cd81ccf8\" data-wording=\"true\">汇款服务,收款服务案例</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"fb00f7919542a16789d47aa4d80420e5\"> \n    <ul data-lake-id=\"1cb9d48e720cf861d05c6ab96ba29f9d\"> \n     <ul data-lake-id=\"abe9b706dcc00a67e41e4e3e1726a95a\"> \n      <li data-lake-id=\"ec09dc1aec50fcc0a965ed133dfc0559\" data-wording=\"true\">A用户向B用户汇款500元</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"de2f465134d397c47284e7dcf829a35f\"> \n    <ul data-lake-id=\"fcfd1b0585feb166a7ec4c945d0eba67\"> \n     <li data-lake-id=\"2a9ac2a697deeef02faf46db8e675d12\" data-wording=\"true\">汇款服务</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"884a0879be21e51dfa7f817321422152\"> \n    <ul data-lake-id=\"b0752430bb66991ec718d9b2c44307ec\"> \n     <ul data-lake-id=\"71ad371797f352e69660acad9df25028\"> \n      <li data-lake-id=\"d90536a255bec3d7a174cf8015627e25\" data-wording=\"true\">try</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"3ec46c3eae95cd365cd683e6570aa517\"> \n    <ul data-lake-id=\"4f4bfb4f5202ad351b93306b2917abec\"> \n     <ul data-lake-id=\"ef80efb5d2d51fd07640ea8763e5d0d2\"> \n      <ul data-lake-id=\"174d85b3088b77ffb0b957b414846107\"> \n       <li data-lake-id=\"36290a8c3578cc64d4fee806c6eb6db6\" data-wording=\"true\">检查A账户的有效性,及查看A账户的状态是否为\"转账中\"或者\"冻结\"</li> \n       <li data-lake-id=\"9f805ff545ebf0fd2cfe45ab405cb342\" data-wording=\"true\">检查A账户余额是否充足</li> \n       <li data-lake-id=\"f623cc5c18b0381b725084735e4f4061\" data-wording=\"true\">从A账户中扣减500元,并将状态设置为转账中</li> \n       <li data-lake-id=\"9eed0f4fb02fbaf1ea6c5b6502d90389\" data-wording=\"true\">预留扣减资源,将从A往B账户转账500元这个事件存入消息或者日志中</li> \n      </ul> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"f9066035f0352a0dccd81df7e27dc30b\"> \n    <ul data-lake-id=\"cac4d7f639d5821031734e94eb84700c\"> \n     <ul data-lake-id=\"70e9a6d0d81e5585d86ff510b39b2506\"> \n      <li data-lake-id=\"b31d24e9516fa91768479a7c9ae82c0d\" data-wording=\"true\">confirm</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"fa45299469c6938c8b9a6a1bc4e76692\"> \n    <ul data-lake-id=\"d830f79210ee713005516d386cb4371f\"> \n     <ul data-lake-id=\"bf69fc8d7971c0b54554c1c8f3d8fc48\"> \n      <ul data-lake-id=\"358f5201cc46ea43d79593d1b74cbd68\"> \n       <li data-lake-id=\"2c3bc39289635c2091c717d1b83d4fae\" data-wording=\"true\">不做任何操作</li> \n      </ul> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"f78c0b9bb25aaf7149bc6114095d356d\"> \n    <ul data-lake-id=\"692d1b947cbd213915a7d164f096774b\"> \n     <ul data-lake-id=\"129a68403bfd2bb45ad9b89549e3fe47\"> \n      <li data-lake-id=\"340266e4b86b7c7d6056171e3ce58d28\" data-wording=\"true\">cancel</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"c1190260bbcfc9ad5e47d5ac9278ef5d\"> \n    <ul data-lake-id=\"3c040532afd83f6cbf38edeee6755bc6\"> \n     <ul data-lake-id=\"74d6a1965a06baa622d46db40bf601e7\"> \n      <ul data-lake-id=\"5caf9596e72dfed3ab5e037f63a9b15c\"> \n       <li data-lake-id=\"f7fcbf09c48f2a17772561c0da56be2f\" data-wording=\"true\">A账户增加500元</li> \n       <li data-lake-id=\"2c73b7110f46a61416808297f8115814\" data-wording=\"true\">从日志或者消息中,释放扣减资源</li> \n      </ul> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"751acafde3baec6aeba592c53684428b\"> \n    <ul data-lake-id=\"219cfddb661a1d129589ef9943e028fb\"> \n     <li data-lake-id=\"303941edc8c8d3e1b48047be05ebc665\" data-wording=\"true\">收款服务</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"9bcc80c2b7a7c05569db8adedb906b09\"> \n    <ul data-lake-id=\"4032f7536703e82e142acf1fb51d8cb8\"> \n     <ul data-lake-id=\"72a3ef333d3cecc6e6c70db04fa95535\"> \n      <li data-lake-id=\"002ce1260b9d76518b61801310376e5c\" data-wording=\"true\">try</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"3ba32a892fa9a509dec6ef9f39204671\"> \n    <ul data-lake-id=\"a114f309254ddae4bb5c981852b9d3b8\"> \n     <ul data-lake-id=\"0e57032c1cbe2b62f38dbf56bbdd78ce\"> \n      <ul data-lake-id=\"db76db708bd526d0ed4dc49294f5a8b5\"> \n       <li data-lake-id=\"64229281bedf0696b7f20046276ab10e\" data-wording=\"true\">检查B账户是否有效</li> \n      </ul> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"990954a913e839f3a24db4ef126be2cb\"> \n    <ul data-lake-id=\"d18a59874ecd8da44f6c7d634c0bc181\"> \n     <ul data-lake-id=\"d4f74e869684b207e5471918ba34f0bc\"> \n      <li data-lake-id=\"df4c98435df9bf09cc27392ea0aa4679\" data-wording=\"true\">confirm</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"d6cc55cc87de6797a2c036bf6ed16dbc\"> \n    <ul data-lake-id=\"a5c456e349829e9ab4b499153b680377\"> \n     <ul data-lake-id=\"28fc098d3bf5db1e6b5835b2a8977c49\"> \n      <ul data-lake-id=\"cab1b5caced4d021b7a1b132b38ffdae\"> \n       <li data-lake-id=\"75abd56efe30b7024fa37b12ba7bf79a\" data-wording=\"true\">读取日志或消息,B账户增加500元</li> \n       <li data-lake-id=\"56ef737158237b4188d5bfecbb91284c\" data-wording=\"true\">从日志或者消息中,释放扣减资源</li> \n      </ul> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"a75bb8b3bef59e32b7fc40a4d57ad98c\"> \n    <ul data-lake-id=\"3054f6abbe276dff98c7bbca78b93302\"> \n     <ul data-lake-id=\"a7543be16ec51df758814f4f0b4880e0\"> \n      <li data-lake-id=\"2a8f5ec606442371402d97d8612f8257\" data-wording=\"true\">cancel</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"869a1cce0148c209a6c221e4b84c58c6\"> \n    <ul data-lake-id=\"76c2adebc0fbdc6c86cb08c71763e15a\"> \n     <ul data-lake-id=\"b1fc2bd318ac75d25b717d4d128438b7\"> \n      <ul data-lake-id=\"5156dd6d99a92a02402315016359dff1\"> \n       <li data-lake-id=\"689c857c3a81fc1755a1317c457d1bd0\" data-wording=\"true\">不做任何操作</li> \n      </ul> \n     </ul> \n    </ul> \n   </ul> \n   <h3 id=\"efdQL\" data-lake-id=\"0dff21f499d2942a6a63a58fb19e0881\" data-wording=\"true\">Saga模型</h3> \n   <ul data-lake-id=\"ff50f456e3907424f3b674e21a679f24\"> \n    <li data-lake-id=\"e4623531c4e91170408902e3c483ed01\" data-wording=\"true\">起源于1987年Hector &amp; Kenneth发表的论文Sagas</li> \n    <li data-lake-id=\"34270c4f159e0ad3376f6e66d011bd19\" data-wording=\"true\">Saga模型把一个分布式事物拆分为多个本地事物,每个本地事物都有相应的执行模块和补偿模块(对应TCC中的confirm和cancel)</li> \n    <li data-lake-id=\"301af374657754815d4e85f624283834\" data-wording=\"true\">当Saga事物中任意一个本地事物出错时,可以通过调用相关的补偿方法恢复之前的事物,到达事物最终一致性</li> \n    <li data-lake-id=\"089be3119dc2c7a184603dd5861758eb\" data-wording=\"true\">当每个Saga子事物T1,T2,....TN都有对应的补偿定义C1,C2,....CN-1,那么Saga系统可以保证</li> \n   </ul> \n   <ul data-lake-id=\"e3a58e9ad390d7c4551a1d8a22ace986\"> \n    <ul data-lake-id=\"4c509ec773e2811e440ce264a2910062\"> \n     <li data-lake-id=\"cb2bfd8321df78ca73fcd50a5ffc70a7\" data-wording=\"true\">子事物序列T1,T2,.....TN得以完成(最佳情况)</li> \n     <li data-lake-id=\"f2632c8286aa3735e8dbd72f95d03d15\" data-wording=\"true\">或者序列T1,T2,...TJ,CJ-1,..., C2,C1,0&lt;J&lt;N,得以完成</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"f1d44ff6123f0cb25e82ab35223b4d4b\"> \n    <li data-lake-id=\"4d50dabd52a3d9106e49ab7f48a14787\" data-wording=\"true\">Saga隔离性</li> \n   </ul> \n   <ul data-lake-id=\"dcd0e7c7e8f6b4334ff8039bb08bfc08\"> \n    <ul data-lake-id=\"ea9bf239895bd0fd11be57756c35b980\"> \n     <li data-lake-id=\"d529ecebaafba9186d954dacf65a2461\" data-wording=\"true\">业务层控制并发</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"12004d16ea0d5f18fafad7b7749f12c9\"> \n    <ul data-lake-id=\"13e4b8defdd5fb78d940d783b4712056\"> \n     <ul data-lake-id=\"8aedd508cc39e2fec44da22c25cd40c9\"> \n      <li data-lake-id=\"253546e6ce2cd60d938942f2e8d4fbee\" data-wording=\"true\">在应用层加锁</li> \n      <li data-lake-id=\"a7aee9b129c1632611495894d411fac6\" data-wording=\"true\">应用层预先冻结资源等</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"82f1d53e493a520f4b0244b653e00c56\"> \n    <li data-lake-id=\"63839626d46636eb7f97b473dd59b549\" data-wording=\"true\">Saga恢复方式</li> \n   </ul> \n   <ul data-lake-id=\"8036fc1782d3c1cb3c4b35e7ecd90d8e\"> \n    <ul data-lake-id=\"3738a134726eda5e8186ee9cdb87cd10\"> \n     <li data-lake-id=\"e0c09533692049e189c85d3b20591721\" data-wording=\"true\">向后恢复,补偿所有已完成的事物,如果任意子事物的失败</li> \n     <li data-lake-id=\"1aed255a39b8e41d9e0a24e722cde9d5\" data-wording=\"true\">向前恢复,重试失败的事物,假设每个子事物最终都会成功</li> \n    </ul> \n   </ul> \n   <p data-lake-id=\"1757b8b3485839fc223139482af7b8ab\">&nbsp;</p> \n   <h2 id=\"QSzOf\" data-lake-id=\"3e4921662bf0fa2d41dc9ba4b2d4d0b2\" data-wording=\"true\">刚性分布式事物VS柔性分布式事物</h2> \n   <div id=\"XSSYa\" class=\"lake-card-margin\" data-card-type=\"block\" data-lake-card=\"table\" data-card-value=\"data:%7B%22rows%22%3A7%2C%22cols%22%3A3%2C%22html%22%3A%22%3Ctable%20class%3D%5C%22lake-table%5C%22%20style%3D%5C%22width%3A%20719px%3B%5C%22%3E%3Ccolgroup%3E%3Ccol%20width%3D%5C%22239%5C%22%20%2F%3E%3Ccol%20width%3D%5C%22240%5C%22%20%2F%3E%3Ccol%20width%3D%5C%22240%5C%22%20%2F%3E%3C%2Fcolgroup%3E%3Ctbody%3E%3Ctr%3E%3Ctd%3E%3Cp%20data-lake-id%3D%5C%22ae3c1845a36dc9830aac809e8e6a0e92%5C%22%3E%3Cbr%20%2F%3E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%20data-lake-id%3D%5C%22af2d0b2bed2ddcebbeb2f43473f84bf8%5C%22%3E%E5%88%9A%E6%80%A7%E4%BA%8B%E7%89%A9(XA)%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%20data-lake-id%3D%5C%22e144fa1d0394533c15f7ea2ee4870a7b_p_0%5C%22%3E%E6%9F%94%E6%80%A7%E4%BA%8B%E7%89%A9%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%3E%3Ctd%3E%3Cp%20data-lake-id%3D%5C%22443045cc9aa30dc078d57c32f24d6031_p_0%5C%22%3E%E4%B8%9A%E5%8A%A1%E6%94%B9%E9%80%A0%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%20data-lake-id%3D%5C%22632a814cb2a9000473a4dbb52a2be312_p_0%5C%22%3E%E6%97%A0%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%20data-lake-id%3D%5C%229a662f06ac840a63b8025637620d03e5_p_0%5C%22%3E%E6%9C%89%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%20style%3D%5C%22height%3A%2033px%3B%5C%22%3E%3Ctd%3E%3Cp%20data-lake-id%3D%5C%2207e6f7a564119231e8d105ac72fbde1d_p_0%5C%22%3E%E5%9B%9E%E6%BB%9A%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%20data-lake-id%3D%5C%22f1d46ae5103a9fabd4210c761f139ca3_p_0%5C%22%3E%E6%94%AF%E6%8C%81%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%3E%3Cp%20data-lake-id%3D%5C%22222038ef431b888eff58e4a050c3544f_p_0%5C%22%3E%E5%AE%9E%E7%8E%B0%E8%A1%A5%E5%81%BF%E6%8E%A5%E5%8F%A3%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%22dec3095f8e82c6c25171bd0d7c076442_p_0%5C%22%3E%E4%B8%80%E8%87%B4%E6%80%A7%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%229121a4920d144051bfaaa3f7b956073b_p_0%5C%22%3E%E5%BC%BA%E4%B8%80%E8%87%B4(CP)%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%2239fe2761fe3981aeb6823419322c0ecb_p_0%5C%22%3E%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7(AP)%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%22a20d224c568e48b9d67847a2c66a8c01_p_0%5C%22%3E%E9%9A%94%E7%A6%BB%E6%80%A7%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%226893b15e9818a2b3dfa8cce2ec19fe71_p_0%5C%22%3E%E5%8E%9F%E7%94%9F%E6%94%AF%E6%8C%81%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%22222038ef431b888eff58e4a050c3544f_p_0%5C%22%3E%E5%AE%9E%E7%8E%B0%E8%B5%84%E6%BA%90%E9%94%81%E5%AE%9A%E6%8E%A5%E5%8F%A3%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%22a20d224c568e48b9d67847a2c66a8c01_p_0%5C%22%3E%E5%B9%B6%E5%8F%91%E6%80%A7%E8%83%BD%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%2238faef0a33bccea6a98f1fc600a71610_p_0%5C%22%3E%E4%B8%A5%E9%87%8D%E8%A1%B0%E9%80%80%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%22efa3f07e7fe189a957a4001328310fdd_p_0%5C%22%3E%E7%95%A5%E5%BE%AE%E8%A1%B0%E9%80%80%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3Ctr%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%221b2fcd2ab439174f7cc008f61df34958_p_0%5C%22%3E%E9%80%82%E5%90%88%E5%9C%BA%E6%99%AF%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%229bc80678d5e106e8e0255d0072c7d33b_p_0%5C%22%3E%E7%9F%AD%E4%BA%8B%E7%89%A9%2C%E5%B9%B6%E5%8F%91%E8%BE%83%E4%BD%8E%3C%2Fp%3E%3C%2Ftd%3E%3Ctd%20colspan%3D%5C%221%5C%22%20style%3D%5C%22vertical-align%3A%20top%3B%20background-color%3A%20%23FFFFFF%3B%20color%3A%20%23262626%3B%5C%22%3E%3Cp%20data-lake-id%3D%5C%22f9d202e2962c4198531b56fdc573c828_p_0%5C%22%3E%E9%95%BF%E4%BA%8B%E7%89%A9%2C%E9%AB%98%E5%B9%B6%E5%8F%91%3C%2Fp%3E%3C%2Ftd%3E%3C%2Ftr%3E%3C%2Ftbody%3E%3C%2Ftable%3E%22%2C%22margin%22%3Atrue%2C%22hideBorder%22%3Afalse%2C%22id%22%3A%22XSSYa%22%7D\"> \n    <table class=\"lake-table\">\n     <colgroup>\n      <col width=\"239\">\n      <col width=\"240\">\n      <col width=\"240\">\n     </colgroup> \n     <tbody> \n      <tr> \n       <td> <p data-lake-id=\"ae3c1845a36dc9830aac809e8e6a0e92\">&nbsp;</p> </td> \n       <td> <p data-lake-id=\"af2d0b2bed2ddcebbeb2f43473f84bf8\">刚性事物(XA)</p> </td> \n       <td> <p data-lake-id=\"e144fa1d0394533c15f7ea2ee4870a7b_p_0\">柔性事物</p> </td> \n      </tr> \n      <tr> \n       <td> <p data-lake-id=\"443045cc9aa30dc078d57c32f24d6031_p_0\">业务改造</p> </td> \n       <td> <p data-lake-id=\"632a814cb2a9000473a4dbb52a2be312_p_0\">无</p> </td> \n       <td> <p data-lake-id=\"9a662f06ac840a63b8025637620d03e5_p_0\">有</p> </td> \n      </tr> \n      <tr> \n       <td> <p data-lake-id=\"07e6f7a564119231e8d105ac72fbde1d_p_0\">回滚</p> </td> \n       <td> <p data-lake-id=\"f1d46ae5103a9fabd4210c761f139ca3_p_0\">支持</p> </td> \n       <td> <p data-lake-id=\"222038ef431b888eff58e4a050c3544f_p_0\">实现补偿接口</p> </td> \n      </tr> \n      <tr> \n       <td colspan=\"1\"> <p data-lake-id=\"dec3095f8e82c6c25171bd0d7c076442_p_0\">一致性</p> </td> \n       <td colspan=\"1\"> <p data-lake-id=\"9121a4920d144051bfaaa3f7b956073b_p_0\">强一致(CP)</p> </td> \n       <td colspan=\"1\"> <p data-lake-id=\"39fe2761fe3981aeb6823419322c0ecb_p_0\">最终一致性(AP)</p> </td> \n      </tr> \n      <tr> \n       <td colspan=\"1\"> <p data-lake-id=\"a20d224c568e48b9d67847a2c66a8c01_p_0\">隔离性</p> </td> \n       <td colspan=\"1\"> <p data-lake-id=\"6893b15e9818a2b3dfa8cce2ec19fe71_p_0\">原生支持</p> </td> \n       <td colspan=\"1\"> <p data-lake-id=\"222038ef431b888eff58e4a050c3544f_p_0\">实现资源锁定接口</p> </td> \n      </tr> \n      <tr> \n       <td colspan=\"1\"> <p data-lake-id=\"a20d224c568e48b9d67847a2c66a8c01_p_0\">并发性能</p> </td> \n       <td colspan=\"1\"> <p data-lake-id=\"38faef0a33bccea6a98f1fc600a71610_p_0\">严重衰退</p> </td> \n       <td colspan=\"1\"> <p data-lake-id=\"efa3f07e7fe189a957a4001328310fdd_p_0\">略微衰退</p> </td> \n      </tr> \n      <tr> \n       <td colspan=\"1\"> <p data-lake-id=\"1b2fcd2ab439174f7cc008f61df34958_p_0\">适合场景</p> </td> \n       <td colspan=\"1\"> <p data-lake-id=\"9bc80678d5e106e8e0255d0072c7d33b_p_0\">短事物,并发较低</p> </td> \n       <td colspan=\"1\"> <p data-lake-id=\"f9d202e2962c4198531b56fdc573c828_p_0\">长事物,高并发</p> </td> \n      </tr> \n     </tbody> \n    </table> \n   </div> \n   <h2 id=\"ZmYt3\" data-lake-id=\"011a3ed9e13609b59d37e2929cd34703\" data-wording=\"true\">我们如何实践</h2> \n   <ul data-lake-id=\"ea61e26b4481929a38f88452c9d2b08e\"> \n    <li data-lake-id=\"a5e7d8d836d766d02782ebe461212871\" data-wording=\"true\">问题通用解决思路</li> \n   </ul> \n   <ul data-lake-id=\"fb7ea1681dd1f7caa83dff30d94416c6\"> \n    <ul data-lake-id=\"fcc449d5fe9f23e074e0ab8c556ec67e\"> \n     <li data-lake-id=\"7eeebe7e10b0c80803a19227e34ca920\" data-wording=\"true\">解决这个问题本身</li> \n     <li data-lake-id=\"5b2f6d9f1287202a2e6a5158b67b609e\" data-wording=\"true\">让问题本身消失</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"e1e09e9fe071ab9ca921f67b4b51dd50\"> \n    <ul data-lake-id=\"c51de5e6da67178519547e7f9376a475\"> \n     <ul data-lake-id=\"0b846a03406660b51b64b7a49be9a591\"> \n      <li data-lake-id=\"2c845820f2a4bd70b697a1b265d64c6c\" data-wording=\"true\">圆珠笔笔芯漏油解决</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"1e1f5acbc47884abe50b69eb17fa5840\"> \n    <li data-lake-id=\"9671cbc569a77ca336ada76d5d2986f5\" data-wording=\"true\">圆珠笔笔芯在写2W次就开始漏油,如果要解决这个问题本身,那么就是加入更好的材料,更高端的技术,如果是让问题本身消失呢,就是固定一个次数,让它只能写1.5W次就没油开始丢弃,这样的两种办法</li> \n    <li data-lake-id=\"3b4ab8c904e5ba6c5b5cf35649679053\" data-wording=\"true\">首选是让问题本身消失,次选是解决这个问题本身</li> \n    <li data-lake-id=\"8d11a1f77a317bda7f4e6f611e8bc9c9\" data-wording=\"true\">方案一:从业务场景消除分布式事物</li> \n   </ul> \n   <ul data-lake-id=\"7f5a3b81cb14e876854fb68f256364be\"> \n    <ul data-lake-id=\"d6be97186f2cf59b095ba1deb03fd8e8\"> \n     <li data-lake-id=\"38a9d975370eea7f24b443a430582e20\" data-wording=\"true\">思路:核心业务先处理,其他业务异步处理</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"40a0a5d6f60c4c0f4894cd155049045a\"> \n    <li data-lake-id=\"a5052314a580164d905a45a25e5afad5\" data-wording=\"true\">方案二:柔性分布式事物</li> \n   </ul> \n   <h3 id=\"YzJzM\" data-lake-id=\"16b09ecc8d203d1bab4d3fd762aabc5b\" data-wording=\"true\">柔性分布式事物实践</h3> \n   <ul data-lake-id=\"607dfde71316abadc617dbcf2c90a021\"> \n    <li data-lake-id=\"16164d5f7ad09dc0379c3b66161add49\" data-wording=\"true\">通用处理思路</li> \n   </ul> \n   <ul data-lake-id=\"430601a6a51814742d4644e7c2a0cd0e\"> \n    <ul data-lake-id=\"024a1f2254890435b4661e35e782f384\"> \n     <li data-lake-id=\"abbd82d8302cf7e437719988c7967296\" data-wording=\"true\">本地事物--&gt;短事物</li> \n     <li data-lake-id=\"b0e3d759bc0b83306047c63fa5fdb9ac\" data-wording=\"true\">分布式事物--&gt;长事物</li> \n     <li data-lake-id=\"48bc1d1d48ee36f7f7962e370cf19173\" data-wording=\"true\">转变成多个短事物</li> \n     <li data-lake-id=\"4c40ae0f7790e7b869cbf58c1cc10ccd\" data-wording=\"true\">案例</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"1d52cbbf86c8a8ca5ccef984bed08e32\"> \n    <ul data-lake-id=\"977cea446f937c77b7892a63ff86c352\"> \n     <ul data-lake-id=\"1154377a122868c0afc72cc8998a9222\"> \n      <li data-lake-id=\"a6dfd4cdf5b99d97fd2432575114118a\" data-wording=\"true\">A[下单]-&gt;B[减库存]-&gt;C[支付]</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"3ec9fbbd7a79092877cb5d4aa31f28f8\"> \n    <ul data-lake-id=\"b0e5f6046779530469ac408990df16e3\"> \n     <ul data-lake-id=\"9f67e865318b3b7ff4ce1886424db37d\"> \n      <ul data-lake-id=\"1dd16bd5f934788d944b937ed02db6e7\"> \n       <li data-lake-id=\"00db0102fc2a9dc11f07a3b9a8ecc309\" data-wording=\"true\">A-&gt;DB1</li> \n       <li data-lake-id=\"70948f32fff99a00c4e2dce1918c1889\" data-wording=\"true\">B-&gt;DB2</li> \n       <li data-lake-id=\"1df3c2ddf0a1924f9f9a4f839a7e92a2\" data-wording=\"true\">C-&gt;DB3</li> \n       <li data-lake-id=\"fc96e2cd3d82aa7f5fe86bc9f018a8d5\" data-wording=\"true\">A/B/C都成功</li> \n       <li data-lake-id=\"1453fe4d3d5036923747daef3b7d7b1a\" data-wording=\"true\">A/B成功,C失败</li> \n      </ul> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"3dda5009c3811e8619a2cb8292925746\"> \n    <ul data-lake-id=\"ae296614238821b95d01734fb39c2a95\"> \n     <ul data-lake-id=\"48fa6a27282a7ee6ed6be81b587eea12\"> \n      <ul data-lake-id=\"d6540bb29b7dc130d5095cc91f121715\"> \n       <ul data-lake-id=\"c2757f7b7501d402f071c1c660ea3b1b\"> \n        <li data-lake-id=\"648f63b7ed4fa37b29ca6c90fe0839ce\" data-wording=\"true\">补偿</li> \n       </ul> \n      </ul> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"188ec4f8683759eeb616e6fa6b7cc7c3\"> \n    <li data-lake-id=\"31d9609698670ca5883e94a28cd795f4\" data-wording=\"true\">业务场景</li> \n   </ul> \n   <ul data-lake-id=\"e1d671f5eb07bb1388bb90a220f50dd8\"> \n    <ul data-lake-id=\"73314aedb26590f30edc46393ad18b87\"> \n     <li data-lake-id=\"7d692b84b2026bbee1291a6d63f0f578\" data-wording=\"true\">异步场景</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"c1e1af57952db32fa2696fe0fb293ef1\"> \n    <ul data-lake-id=\"e047b2e56aec50cdc97c0b77431c78b6\"> \n     <ul data-lake-id=\"a10a98c0f4f5ba9d465e7db45a7c87f0\"> \n      <li data-lake-id=\"3d6fad036dfd9c6a7aba815853ce1b2b\" data-wording=\"true\">基于MQ消息驱动分布事物</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"37eb3d0a4a218430f8495bcb04770f91\"> \n    <ul data-lake-id=\"ad2d0f5b588e4b72b36a76d4deb68b27\"> \n     <li data-lake-id=\"d109754afd4e0bc393fca9c75ad3a3ba\" data-wording=\"true\">同步场景</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"e67deb640530dea76937cfc91d2685b8\"> \n    <ul data-lake-id=\"8bb17298cb345ff4065ee39f54f24b01\"> \n     <ul data-lake-id=\"b840bf9c6c0456bed99a549504a209f5\"> \n      <li data-lake-id=\"f320e2e9aa909f724fa5998c5afdf7d8\" data-wording=\"true\">基于异步补偿分布</li> \n     </ul> \n    </ul> \n   </ul> \n   <h3 id=\"pfVau\" data-lake-id=\"d8008b3fe070ac9c4625605580fa9ee2\" data-wording=\"true\">异步场景分布式事物设计</h3> \n   <p data-lake-id=\"a1b0c96b3fdb09b1034fbcb39bb82a6f\" data-wording=\"true\">异步场景</p> \n   <p data-lake-id=\"50e7d9fe5638432b65204a4a2f2ff3bd\" data-wording=\"true\">商品交易</p> \n   <p data-lake-id=\"71f80bd7bc49e02aef526bcc84bedd62\" data-wording=\"true\">下单,支付</p> \n   <p data-lake-id=\"87520fd0dd36ce819827c03aac458929\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616337475671-367e1580-7e52-4587-bc52-b720ea3f144d.png%22%2C%22originWidth%22%3A706%2C%22originHeight%22%3A132%2C%22name%22%3A%22image.png%22%2C%22size%22%3A38111%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A144.94786%2C%22y%22%3A61.283325%2C%22width%22%3A42.57205000000002%2C%22height%22%3A14.176015%2C%22text%22%3A%221%E4%B8%8B%E5%8D%95%22%7D%2C%7B%22x%22%3A234.3197%2C%22y%22%3A62.134563%2C%22width%22%3A101.52499999999998%2C%22height%22%3A14.757867000000005%2C%22text%22%3A%222%E7%94%9F%E4%BA%A7%E8%AE%A2%E5%8D%95%E6%B6%88%E6%81%AF%22%7D%2C%7B%22x%22%3A379.6106%2C%22y%22%3A64.64609%2C%22width%22%3A24.907560000000046%2C%22height%22%3A12.013875999999996%2C%22text%22%3A%22MQ%22%7D%2C%7B%22x%22%3A471.29147%2C%22y%22%3A66.3859%2C%22width%22%3A106.10433%2C%22height%22%3A15.095033999999998%2C%22text%22%3A%223%E6%B6%88%E8%B4%B9%E8%AE%A2%E5%8D%95%E6%B6%88%E6%81%AF%22%7D%2C%7B%22x%22%3A628.8264%2C%22y%22%3A66.5028%2C%22width%22%3A29.25630000000001%2C%22height%22%3A15.715980000000002%2C%22text%22%3A%22%E6%94%AF%E4%BB%98%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%221%E4%B8%8B%E5%8D%95%202%E7%94%9F%E4%BA%A7%E8%AE%A2%E5%8D%95%E6%B6%88%E6%81%AF%20MQ%203%E6%B6%88%E8%B4%B9%E8%AE%A2%E5%8D%95%E6%B6%88%E6%81%AF%20%E6%94%AF%E4%BB%98%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A706%2C%22height%22%3A132%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/2d1d60f9-d64d-4892-beed-7f7d7c037e5f.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"132px\"></span></p> \n   <h4 id=\"w8NZs\" data-lake-id=\"ce3858017e674fb33cfd3d6f5973ee62\" data-wording=\"true\">方案一:业务方提供本地操作成功回查功能</h4> \n   <ul data-lake-id=\"b2bbb609e24e632ab5a0a7cb2a52f86b\"> \n    <ul data-lake-id=\"f02ab024e4c2fc57100ea58b9e5fc1a2\"> \n     <li data-lake-id=\"b2d8964a10930a6697e1959e74fc4cea\" data-wording=\"true\">事物消息:MQ提供类似X/Open XA的分布式事物功能,通过MQ事物消息能达到分布式事物的最终一致</li> \n     <li data-lake-id=\"5d977051b64007bf4e4d28bc99079af9\" data-wording=\"true\">半消息:暂不投递的消息,发送方已将消息成功发送到了MQ服务端,但是服务端未收到生产者对该消息的二次确认,此时该消息被标记成\"暂不能投递\"状态,处于该种状态下的消息即半消息</li> \n     <li data-lake-id=\"4dffce4a87a794ac366347e74efc4344\" data-wording=\"true\">消息回查:由于网络闪断,生产者应用重启等原因,导致某条事物消息的二次确认丢失,MQ服务端通过扫描发现某条消息长期处于半消息时,主要主动向消息生产者询问该消息的最终状态(Commit或Rollback),即消息回查</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"06d786d10b210f62e485efccb6d19a10\"> \n    <li data-lake-id=\"def672961bfa3b9ed96f0456f354eeab\" data-wording=\"true\">MQ分布式事物设计方案</li> \n   </ul> \n   <p data-lake-id=\"485551879eb7949563d50a376ee39cb1\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616338104781-95401a1c-2ce6-4537-a729-f0a1935e81f4.png%22%2C%22originWidth%22%3A881%2C%22originHeight%22%3A222%2C%22name%22%3A%22image.png%22%2C%22size%22%3A77797%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A365.7255%2C%22y%22%3A15.922096%2C%22width%22%3A178.88829999999996%2C%22height%22%3A11.622582000000001%2C%22text%22%3A%22%E6%A0%B9%E6%8D%AE%E4%B8%B0%E5%8A%A1%E7%9A%84%E7%8A%B6%E6%80%81Commit%2FRollback%22%7D%2C%7B%22x%22%3A404.28177%2C%22y%22%3A55.679035%2C%22width%22%3A49.901729999999986%2C%22height%22%3A12.406095000000008%2C%22text%22%3A%220%E5%8F%91%E9%80%81%22%7D%2C%7B%22x%22%3A405.7665%2C%22y%22%3A68.025055%2C%22width%22%3A45.69263999999998%2C%22height%22%3A11.070335%2C%22text%22%3A%22Half%E6%B1%BD%E6%81%AF%22%7D%2C%7B%22x%22%3A245.94635%2C%22y%22%3A90.855736%2C%22width%22%3A101.75922000000003%2C%22height%22%3A19.40612%2C%22text%22%3A%22MQ%E5%8F%91%E9%80%81%E6%96%B9%22%7D%2C%7B%22x%22%3A413.69604%2C%22y%22%3A91.2877%2C%22width%22%3A49.43552%2C%22height%22%3A12.166034999999994%2C%22text%22%3A%22HalF%E8%82%96%E6%81%AF%22%7D%2C%7B%22x%22%3A168.5983%2C%22y%22%3A91.077194%2C%22width%22%3A59.768490000000014%2C%22height%22%3A14.532945999999995%2C%22text%22%3A%220%2C%E6%89%A7%E8%A1%8C%22%7D%2C%7B%22x%22%3A36.904655%2C%22y%22%3A93.12887%2C%22width%22%3A81.29367500000001%2C%22height%22%3A20.34572999999999%2C%22text%22%3A%22%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%22%7D%2C%7B%22x%22%3A649.3861%2C%22y%22%3A93.41782%2C%22width%22%3A49.97129999999993%2C%22height%22%3A9.553139999999999%2C%22text%22%3A%22Commit%22%7D%2C%7B%22x%22%3A511.08453%2C%22y%22%3A93.90391%2C%22width%22%3A107.31506999999999%2C%22height%22%3A19.878470000000007%2C%22text%22%3A%22MQServer%22%7D%2C%7B%22x%22%3A742.3302%2C%22y%22%3A94.39128%2C%22width%22%3A92.75885000000005%2C%22height%22%3A19.23938000000001%2C%22text%22%3A%22MQ%E8%AE%A2%E9%98%85%E6%96%B9%22%7D%2C%7B%22x%22%3A171.71959%2C%22y%22%3A103.24564%2C%22width%22%3A51.44504999999998%2C%22height%22%3A11.89304%2C%22text%22%3A%22%E6%9C%AC%E5%9C%B0%E8%BD%A6%E5%8A%A1%22%7D%2C%7B%22x%22%3A404.18582%2C%22y%22%3A103.69265%2C%22width%22%3A48.930060000000026%2C%22height%22%3A11.352090000000004%2C%22text%22%3A%22%E5%8F%91%E9%80%81%E6%88%90%E5%8A%A8%22%7D%2C%7B%22x%22%3A651.92786%2C%22y%22%3A105.19377%2C%22width%22%3A49.46087%2C%22height%22%3A11.450429999999997%2C%22text%22%3A%22%E6%8A%95%E9%80%92%E6%B6%88%E6%81%AF%22%7D%2C%7B%22x%22%3A407.0333%2C%22y%22%3A121.8746%2C%22width%22%3A69.43624%2C%22height%22%3A11.834919999999997%2C%22text%22%3A%22COMMITOR%22%7D%2C%7B%22x%22%3A650.9824%2C%22y%22%3A130.9053%2C%22width%22%3A58.12549999999999%2C%22height%22%3A11.087589999999977%2C%22text%22%3A%22Rollback%3A%22%7D%2C%7B%22x%22%3A404.3879%2C%22y%22%3A135.36246%2C%22width%22%3A49.69824999999997%2C%22height%22%3A10.232280000000003%2C%22text%22%3A%22Rolback%22%7D%2C%7B%22x%22%3A647.677%2C%22y%22%3A143.85771%2C%22width%22%3A72.79833999999994%2C%22height%22%3A12.385230000000007%2C%22text%22%3A%22%E9%81%87%E6%B6%88%E6%81%AF%E4%B8%8D%E6%8A%95%E9%80%92%22%7D%2C%7B%22x%22%3A147.20859%2C%22y%22%3A177.56772%2C%22width%22%3A107.96123%2C%22height%22%3A13.646649999999994%2C%22text%22%3A%22%E6%A3%80%E7%9C%81%E6%9C%AC%E5%9C%B0%E4%B8%B0%E5%8A%A1%E7%9A%84%E7%8A%B6%E6%80%81%22%7D%2C%7B%22x%22%3A363.1399%2C%22y%22%3A179.63626%2C%22width%22%3A181.9864%2C%22height%22%3A13.806000000000012%2C%22text%22%3A%22%E6%9C%AA%E6%94%B6%E8%BE%88%40%E7%9A%84%E8%AE%A4%E6%97%B6%2C%E5%9B%9E%E6%9F%A5%E4%B8%AD%E5%8A%A1%E7%8A%B6%E6%80%81%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22%E6%A0%B9%E6%8D%AE%E4%B8%B0%E5%8A%A1%E7%9A%84%E7%8A%B6%E6%80%81Commit%2FRollback%200%E5%8F%91%E9%80%81%20Half%E6%B1%BD%E6%81%AF%20MQ%E5%8F%91%E9%80%81%E6%96%B9%20HalF%E8%82%96%E6%81%AF%200%2C%E6%89%A7%E8%A1%8C%20%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%20Commit%20MQServer%20MQ%E8%AE%A2%E9%98%85%E6%96%B9%20%E6%9C%AC%E5%9C%B0%E8%BD%A6%E5%8A%A1%20%E5%8F%91%E9%80%81%E6%88%90%E5%8A%A8%20%E6%8A%95%E9%80%92%E6%B6%88%E6%81%AF%20COMMITOR%20Rollback%3A%20Rolback%20%E9%81%87%E6%B6%88%E6%81%AF%E4%B8%8D%E6%8A%95%E9%80%92%20%E6%A3%80%E7%9C%81%E6%9C%AC%E5%9C%B0%E4%B8%B0%E5%8A%A1%E7%9A%84%E7%8A%B6%E6%80%81%20%E6%9C%AA%E6%94%B6%E8%BE%88%40%E7%9A%84%E8%AE%A4%E6%97%B6%2C%E5%9B%9E%E6%9F%A5%E4%B8%AD%E5%8A%A1%E7%8A%B6%E6%80%81%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A881%2C%22height%22%3A222%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/289b1ca4-0cfe-4025-a04f-0155678e3cd9.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"222px\"></span></p> \n   <ul data-lake-id=\"f910cf3fa2f273ce98fd64d8dcd7d48a\"> \n    <li data-lake-id=\"e88bf42f31edda24f869089cb6e00aea\" data-wording=\"true\">MQ分布式事物消息设计</li> \n   </ul> \n   <ul data-lake-id=\"e59e2930a2cb2195ce3e5785226c65f3\"> \n    <ul data-lake-id=\"61425903a0ddcb657d3a6d5da0612525\"> \n     <li data-lake-id=\"704697903eaae768e643cd429fa9691a\" data-wording=\"true\">MQ事物消息设计事物消息作为一种异步确保型事物,将两个事物分支通过MQ进行异步解耦,MQ事物消息的设计流程同样借鉴了两阶段提交理论,整体交互流程如上图</li> \n    </ul> \n   </ul> \n   <ol data-lake-id=\"68f69f3abc500a6d3862bee0371fa7bf\">\n    <ol data-lake-id=\"2bd27b171c46634aa3f8c17e369f8985\"> \n     <li data-lake-id=\"8f7ce7f87bc7829fd4459fb83282c98b\" data-wording=\"true\">事物发起方首先发送prepare消息到MQ</li> \n     <li data-lake-id=\"be448ef55808a453f0c0f40031d5c274\" data-wording=\"true\">在发送prepare消息成功后执行本地事物</li> \n     <li data-lake-id=\"88bd5e8b4f9b21bda9f712d21858e954\" data-wording=\"true\">根据本地事物执行结果返回commit或rollback</li> \n     <li data-lake-id=\"ac93840f7c30a3955f63d35240fce843\" data-wording=\"true\">如果消息是rollback,MQ将删除该prepare消息,不进行下发,如果是commit消息,MQ会将消息发送给consumer端</li> \n     <li data-lake-id=\"0acf4f48ebfb120b744fceba4d26ee15\" data-wording=\"true\">如果执行本地事物过程中,执行端挂掉,或者超时,,MQ服务器端将不停的询问producer来获取事物状态</li> \n     <li data-lake-id=\"10640f37a5e2a4edfeeb0e05974fa83c\" data-wording=\"true\">consumer端的消费成功机制有MQ保证</li> \n    </ol>\n   </ol> \n   <ul data-lake-id=\"22d7cce51312c79cb2a120a177125278\"> \n    <li data-lake-id=\"9aaae3b1e41f2b8362d9fe0653097aee\" data-wording=\"true\">成本:</li> \n   </ul> \n   <ul data-lake-id=\"48c4eecc5a9c933f8383e25b5f6aa164\"> \n    <ul data-lake-id=\"0742b9a17467b6c8c207390524bf17e6\"> \n     <li data-lake-id=\"29e65d925c0b39d8fa5c11ba000850b5\" data-wording=\"true\">MQ需要支持半消息</li> \n     <li data-lake-id=\"3ccd180b650b691b19ee097ec3895980\" data-wording=\"true\">MQ需要提供消息遍历</li> \n     <li data-lake-id=\"a69e7b712b9e26a9a09ec3c26e1dadb2\" data-wording=\"true\">业务方需要提供回查接口</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"1840b47ada0f5ebc578891b22143830d\"> \n    <li data-lake-id=\"47eebfd7e81461a510d327b20b33aa67\" data-wording=\"true\">业务方接入步骤</li> \n   </ul> \n   <p data-lake-id=\"24c24f129314293872f57b43a7cc58e5\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616339231620-fc1d7778-a896-4c2d-8011-b68e9bf652cf.png%22%2C%22originWidth%22%3A335%2C%22originHeight%22%3A318%2C%22name%22%3A%22image.png%22%2C%22size%22%3A51436%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A218.15529%2C%22y%22%3A10.635663%2C%22width%22%3A34.434290000000004%2C%22height%22%3A11.695668%2C%22text%22%3A%22Broker%22%7D%2C%7B%22x%22%3A24.301575%2C%22y%22%3A11.018613%2C%22width%22%3A45.136168999999995%2C%22height%22%3A10.426598%2C%22text%22%3A%22Producer%22%7D%2C%7B%22x%22%3A101.93424%2C%22y%22%3A55.234447%2C%22width%22%3A73.57260000000001%2C%22height%22%3A12.189328000000003%2C%22text%22%3A%221%3A%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF0%22%7D%2C%7B%22x%22%3A272.1594%2C%22y%22%3A105.1065%2C%22width%22%3A57.684079999999994%2C%22height%22%3A13.36657600000001%2C%22text%22%3A%22%E4%BF%9D%E5%AD%98%E6%B6%88%E6%81%AF0%22%7D%2C%7B%22x%22%3A72.39892%2C%22y%22%3A157.94328%2C%22width%22%3A146.58599%2C%22height%22%3A13.362459999999999%2C%22text%22%3A%223%3A%E8%BF%94%E5%9B%9E%E5%8F%91%E9%80%81%E7%BB%93%E6%9E%9C%2C%E6%98%AF%E5%90%A6oko%22%7D%2C%7B%22x%22%3A86.537964%2C%22y%22%3A201.14886%2C%22width%22%3A144.50663600000001%2C%22height%22%3A13.28291999999999%2C%22text%22%3A%224%3A%E6%89%A7%E8%A1%8C%E6%9C%AC%E5%9C%B0%E6%91%84%E4%BD%9C%2C%E6%98%AF%E5%90%A6oko%22%7D%2C%7B%22x%22%3A76.052216%2C%22y%22%3A240.60992%2C%22width%22%3A123.564364%2C%22height%22%3A13.207650000000001%2C%22text%22%3A%225%3A%E6%8F%90%E4%BA%A4%E6%88%96%E8%80%85%E5%9B%9E%E6%B7%A4%E4%BA%8B%E5%8A%A10%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22Broker%20Producer%201%3A%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF0%20%E4%BF%9D%E5%AD%98%E6%B6%88%E6%81%AF0%203%3A%E8%BF%94%E5%9B%9E%E5%8F%91%E9%80%81%E7%BB%93%E6%9E%9C%2C%E6%98%AF%E5%90%A6oko%204%3A%E6%89%A7%E8%A1%8C%E6%9C%AC%E5%9C%B0%E6%91%84%E4%BD%9C%2C%E6%98%AF%E5%90%A6oko%205%3A%E6%8F%90%E4%BA%A4%E6%88%96%E8%80%85%E5%9B%9E%E6%B7%A4%E4%BA%8B%E5%8A%A10%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A335%2C%22height%22%3A318%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/3e2ce1cb-58b1-4203-83c5-2d68ddda83fa.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"318px\"></span></p> \n   <ul data-lake-id=\"fd5353227536f0ac9d9c51e3ff522430\"> \n    <li data-lake-id=\"52517d5e279b352e50d44af8afc2c99c\" data-wording=\"true\">优点</li> \n   </ul> \n   <ul data-lake-id=\"d5bc17379409d9a56d40c82574e8878a\"> \n    <ul data-lake-id=\"a16979d8bb7bfeef5ede2f9d2d7c7603\"> \n     <li data-lake-id=\"7666e132775488e68867fd07b70639de\" data-wording=\"true\">通用</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"8e72b33eeb2fdb693119f274a1a45e2d\"> \n    <li data-lake-id=\"c3624e29cfffd415d5985799b6b72a8c\" data-wording=\"true\">缺点</li> \n   </ul> \n   <ul data-lake-id=\"aa74a6293c45fd48ae4be8b0f16b7b29\"> \n    <ul data-lake-id=\"11ffdec2432044b13f76762c6b8b0a6b\"> \n     <li data-lake-id=\"49cac4a56f5c15dbf7bc3a3fd5818555\" data-wording=\"true\">业务方需要提供回查接口,对业务侵入大</li> \n     <li data-lake-id=\"dd3b028dc39113bf854e47137a6e500a\" data-wording=\"true\">发送消息非幂等</li> \n     <li data-lake-id=\"137210d800365893aa4dbe1713cdbad2\" data-wording=\"true\">消费端需要处理幂等</li> \n    </ul> \n   </ul> \n   <p data-lake-id=\"8a900bacc2bdec2ab9f84b7a74dbe5b8\">&nbsp;</p> \n   <h4 id=\"KM6sU\" data-lake-id=\"248d61e963c22e5808cef7d64cecd992\" data-wording=\"true\">方案二:本地事物消息表</h4> \n   <ul data-lake-id=\"b05954637b5900c3d5a0082268a79844\"> \n    <li data-lake-id=\"303571c2f0b5f1d43e326dc12953e9a4\" data-wording=\"true\">本地操作和发送消息通过本地事物强一致性</li> \n   </ul> \n   <ul data-lake-id=\"6ad4bd48ed7631058f94d33881669562\"> \n    <ul data-lake-id=\"3847ff9304fb79a22c82ebcaea4aaa5c\"> \n     <li data-lake-id=\"8607501ef827338365841c78f55a18d1\" data-wording=\"true\">本地事物操作表</li> \n     <li data-lake-id=\"f5d8d01cc66f85c6d1d3d8697b5c1533\" data-wording=\"true\">本地事物消息表</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"6665738530c4b56fbbf27a56053fd688\"> \n    <ul data-lake-id=\"8ff3911465a4317f51ec72c258adf663\"> \n     <ul data-lake-id=\"52fe93a238633e6bd4e02a8a27a4ff90\"> \n      <li data-lake-id=\"dd73c867c78f1db9e73901f0bc9a6e86\" data-wording=\"true\">mqMessages(msgid,content,topic,status)</li> \n     </ul> \n    </ul> \n   </ul> \n   <p data-lake-id=\"18a20c4ba8a088194713818c12a4cb84\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616339614578-4e89399e-2d72-4e45-a0dd-88186bdd1717.png%22%2C%22originWidth%22%3A623%2C%22originHeight%22%3A275%2C%22name%22%3A%22image.png%22%2C%22size%22%3A78288%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A404.2959%2C%22y%22%3A5.6474586%2C%22width%22%3A51.96785999999997%2C%22height%22%3A11.1452214%2C%22text%22%3A%225%E5%85%83%E9%99%A4%E6%B6%88%E6%81%AF%22%7D%2C%7B%22x%22%3A131.46799%2C%22y%22%3A51.984528%2C%22width%22%3A34.962890000000016%2C%22height%22%3A11.351989000000003%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A322.69003%2C%22y%22%3A57.922222%2C%22width%22%3A129.50650000000002%2C%22height%22%3A12.753408%2C%22text%22%3A%22-%E5%86%99%E5%85%A5%E4%B8%9A%E5%8A%A1%E6%95%85%E6%8D%AE%E5%92%8C%E6%B6%88%E6%81%AF%E6%95%B0%E6%8D%AE%22%7D%2C%7B%22x%22%3A120.242516%2C%22y%22%3A65.15439%2C%22width%22%3A58.34348400000002%2C%22height%22%3A11.53730999999999%2C%22text%22%3A%22(MQClient)%22%7D%2C%7B%22x%22%3A356.5823%2C%22y%22%3A72.39508%2C%22width%22%3A53.68946%2C%22height%22%3A13.773020000000002%2C%22text%22%3A%22%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%22%7D%2C%7B%22x%22%3A0.6049436%2C%22y%22%3A77.8796%2C%22width%22%3A55.901083400000005%2C%22height%22%3A12.718964%2C%22text%22%3A%224MQ%E5%9B%9E%E6%8A%89%22%7D%2C%7B%22x%22%3A548.5%2C%22y%22%3A101.853424%2C%22width%22%3A26.33979999999997%2C%22height%22%3A11.714416%2C%22text%22%3A%22Msg%22%7D%2C%7B%22x%22%3A487.15024%2C%22y%22%3A102.37726%2C%22width%22%3A23.135400000000004%2C%22height%22%3A10.5214%2C%22text%22%3A%22App%22%7D%2C%7B%22x%22%3A548.6581%2C%22y%22%3A114.81205%2C%22width%22%3A30.211900000000014%2C%22height%22%3A10.792479999999998%2C%22text%22%3A%22Table%22%7D%2C%7B%22x%22%3A485.5906%2C%22y%22%3A115.002106%2C%22width%22%3A30.39677000000006%2C%22height%22%3A10.248903999999996%2C%22text%22%3A%22Table%22%7D%2C%7B%22x%22%3A42.143402%2C%22y%22%3A147.979%2C%22width%22%3A74.312748%2C%22height%22%3A13.223759999999999%2C%22text%22%3A%223%E6%B6%88%E6%81%AF%E5%86%99%E5%85%A5MQ%22%7D%2C%7B%22x%22%3A287.7036%2C%22y%22%3A162.69676%2C%22width%22%3A85.4905%2C%22height%22%3A13.160919999999976%2C%22text%22%3A%222%E4%BB%8E%E6%B6%88%E6%81%AF%E8%A1%A8%E8%AF%BB%E6%B6%88%E6%81%AF%22%7D%2C%7B%22x%22%3A110.906%2C%22y%22%3A229.77708%2C%22width%22%3A56.10503%2C%22height%22%3A11.221559999999982%2C%22text%22%3A%22MQServer%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%225%E5%85%83%E9%99%A4%E6%B6%88%E6%81%AF%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%20-%E5%86%99%E5%85%A5%E4%B8%9A%E5%8A%A1%E6%95%85%E6%8D%AE%E5%92%8C%E6%B6%88%E6%81%AF%E6%95%B0%E6%8D%AE%20(MQClient)%20%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%204MQ%E5%9B%9E%E6%8A%89%20Msg%20App%20Table%20Table%203%E6%B6%88%E6%81%AF%E5%86%99%E5%85%A5MQ%202%E4%BB%8E%E6%B6%88%E6%81%AF%E8%A1%A8%E8%AF%BB%E6%B6%88%E6%81%AF%20MQServer%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A623%2C%22height%22%3A275%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/62e7dfe5-135c-4f05-a830-705f1aa923f4.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"275px\"></span></p> \n   <ul data-lake-id=\"19048cadefd37d0781f7ad18965a6041\"> \n    <li data-lake-id=\"f15d5755054dd986051015533015d954\" data-wording=\"true\">发送端消息不幂等</li> \n   </ul> \n   <ul data-lake-id=\"ed64ad55db8f749737979990c1969d44\"> \n    <ul data-lake-id=\"38ad056b7272c793fc40340ff62dafce\"> \n     <li data-lake-id=\"4beef2bc338c15faa917e9340f069879\" data-wording=\"true\">At least once (最少发一次)</li> \n     <li data-lake-id=\"b58c5fc8047378ade1db544d0ffbca82\" data-wording=\"true\">Once Only (只发一次)</li> \n     <li data-lake-id=\"e960e0608002cc363e051a30f3ae32f8\" data-wording=\"true\">At more once(最多发一次)</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"27f3462171f458d3337d22167ccfd731\"> \n    <li data-lake-id=\"9ee9eecc44cf8fa11373785ceaf62a6e\" data-wording=\"true\">消费端处理消息幂等</li> \n   </ul> \n   <ul data-lake-id=\"8d184ed40065e5cb2cce4040274bf0ed\"> \n    <ul data-lake-id=\"b25815984d802e0550f96c53b4fd460e\"> \n     <li data-lake-id=\"57023a18f81d2e8f69e25aa9ad5f6bca\" data-wording=\"true\">分布式锁</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"32d2d9069c8f2a297071dab2ecb17de1\"> \n    <li data-lake-id=\"554f94a94247e3b4bd43ab6ebdb53f72\" data-wording=\"true\">A-&gt;B-&gt;C</li> \n   </ul> \n   <ul data-lake-id=\"04762fba653167f743761b6122644ab9\"> \n    <ul data-lake-id=\"3b1fcfc7581a9305275c105da4b2b605\"> \n     <li data-lake-id=\"6add8fe89080755add8d21285d493c23\" data-wording=\"true\">A/B成功,C失败</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"23d4afbf8aa148e44757d9d436158b5d\"> \n    <ul data-lake-id=\"75e056c3e743b615ee464cdb575a9870\"> \n     <ul data-lake-id=\"35cb3323842e183a3e745156e2d8ad09\"> \n      <li data-lake-id=\"21abe20f8caf1541a04ecdb8e44a0d20\" data-wording=\"true\">记录错误日志</li> \n      <li data-lake-id=\"46a97121c72f1b79cacf9338a7b73ced\" data-wording=\"true\">报警</li> \n      <li data-lake-id=\"98acc7355983d7b2b861c822ddcc85f9\" data-wording=\"true\">人工介入</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"649e071cfa6ac1eef99043b967dbacda\"> \n    <li data-lake-id=\"4c9eb01b7e3a3c851303583626ec0b6e\" data-wording=\"true\">优点</li> \n   </ul> \n   <ul data-lake-id=\"bb3dd6a200270c3a3b7a6c45a73917b3\"> \n    <ul data-lake-id=\"68940c412d1d93e16b1f191c298e748f\"> \n     <li data-lake-id=\"efc49ecef6faad9f167f5e95d2088e48\" data-wording=\"true\">业务入侵小</li> \n    </ul> \n   </ul> \n   <p data-lake-id=\"980b00fc4bc4b8919c93a3a657c57d97\" data-wording=\"true\">相比于提供消息回查接口(RockectMQ)来说,实际异步场景还是本地消息事物表使用的比较多</p> \n   <p data-lake-id=\"2a40102a9f1f835be8b34a62f61d1c26\">&nbsp;</p> \n   <h3 id=\"iVjUa\" data-lake-id=\"5937bfc3e06e8a579b01d1dc6785a2be\" data-wording=\"true\">同步场景分布式事物设计</h3> \n   <ul data-lake-id=\"ae2ce135d1b240152c292149db6d85b6\"> \n    <li data-lake-id=\"c87739f8b5bf0dc6f013cf7ab9c257b4\" data-wording=\"true\">同步场景</li> \n   </ul> \n   <ul data-lake-id=\"e0d968b9f32de5934d80afeb310c713e\"> \n    <ul data-lake-id=\"379abafe2fe04e84efc667054b02ee5a\"> \n     <li data-lake-id=\"eeaed8ccaa9f1a7b842f85b50b2f191d\" data-wording=\"true\">首页推荐商品列表</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"a15b4f5fa2c232dab229d85d593086f2\"> \n    <ul data-lake-id=\"179f3359688cf0009af2de54255a4e8c\"> \n     <ul data-lake-id=\"5591a042807817e10847d0c5d90a8f71\"> \n      <li data-lake-id=\"dbfde8745391a84fe75e6a89f013d68f\" data-wording=\"true\">商品信息</li> \n      <li data-lake-id=\"ba666a58a42bb271212b7f8af1094660\" data-wording=\"true\">用户信息</li> \n      <li data-lake-id=\"868a60efcf7fc439c12527bde2bfab5f\" data-wording=\"true\">社交信息</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"1c3a3985a80a7bb6168dec04531e0c01\"> \n    <ul data-lake-id=\"bafce553f3c995ec31b31cd4da62ade7\"> \n     <li data-lake-id=\"d703af800f7e481eacb1a52e4b06efc8\" data-wording=\"true\">购买商品</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"3ea9444bfe0645d68b83d5c9c04d22b3\"> \n    <ul data-lake-id=\"3f3967ed84cc02981da7d3ff3e49c564\"> \n     <ul data-lake-id=\"5c65d8ad156f96af76e7d2ef64713cdb\"> \n      <li data-lake-id=\"9e793f078c741329f0cc3397e3085be0\" data-wording=\"true\">下单-&gt;A</li> \n      <li data-lake-id=\"d49316d1bc4ab60d0febbb34e4746cc2\" data-wording=\"true\">减库存-&gt;B</li> \n      <li data-lake-id=\"a3a64085e5c05657fed7062e310c59a0\" data-wording=\"true\">支付-&gt;C</li> \n     </ul> \n    </ul> \n   </ul> \n   <p data-lake-id=\"dbd5f869ba94768cfb392f732fb00598\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616383583662-e25872d8-bff8-431e-bd10-d722449a3715.png%22%2C%22originWidth%22%3A271%2C%22originHeight%22%3A450%2C%22name%22%3A%22image.png%22%2C%22size%22%3A135230%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A86.92002%2C%22y%22%3A20.210077%2C%22width%22%3A92.28756000000001%2C%22height%22%3A12.458933000000002%2C%22text%22%3A%22%E8%BE%85%E5%85%A5%E4%BD%A0%E6%AD%A3%E5%9C%A8%E6%89%BE%E7%9A%84%E5%AE%9D%E8%B4%9D%22%7D%2C%7B%22x%22%3A54.147747%2C%22y%22%3A50.943546%2C%22width%22%3A22.779433000000004%2C%22height%22%3A12.130577000000002%2C%22text%22%3A%22%E6%8E%A8%E9%A6%99%22%7D%2C%7B%22x%22%3A185.98834%2C%22y%22%3A51.307545%2C%22width%22%3A23.91386%2C%22height%22%3A10.889152000000003%2C%22text%22%3A%22%E9%99%84%E8%BF%91%22%7D%2C%7B%22x%22%3A34.575176%2C%22y%22%3A86.94195%2C%22width%22%3A41.467944%2C%22height%22%3A10.530649999999994%2C%22text%22%3A%22%E9%BB%91%E7%99%BD%E8%80%97%E6%9E%97%22%7D%2C%7B%22x%22%3A13.548409%2C%22y%22%3A185.81934%2C%22width%22%3A34.137683%2C%22height%22%3A11.616529999999983%2C%22text%22%3A%222399%22%7D%2C%7B%22x%22%3A8.762954%2C%22y%22%3A201.9872%2C%22width%22%3A244.067386%2C%22height%22%3A11.514690000000002%2C%22text%22%3A%22%E5%A4%A7%E5%A0%A1%E5%BA%97OSM095%E6%96%B0%E8%AE%BE%E5%85%A8%E5%8F%B864G%E9%AB%98%E8%AF%B7120%E4%BA%8B%E8%A3%85%E7%94%B5%E9%85%92%22%7D%2C%7B%22x%22%3A9.130176%2C%22y%22%3A214.91504%2C%22width%22%3A243.770324%2C%22height%22%3A11.152140000000003%2C%22text%22%3A%22%E5%A4%A7%E5%BA%97HOSMO9%E7%B2%BE%E8%AE%BE%E5%85%A8%E9%87%8F%E9%9A%86%E9%99%90%E7%94%B5%E9%85%9264GOSMO%22%7D%2C%7B%22x%22%3A34.18404%2C%22y%22%3A290.2003%2C%22width%22%3A30.713320000000003%2C%22height%22%3A10.406239999999968%2C%22text%22%3A%22%E5%A4%AB%E4%B8%9A%E8%B4%A8%22%7D%2C%7B%22x%22%3A11.922076%2C%22y%22%3A389.3231%2C%22width%22%3A37.947554%2C%22height%22%3A13.075980000000015%2C%22text%22%3A%221.00%E4%B8%87%22%7D%2C%7B%22x%22%3A10.286389%2C%22y%22%3A406.8831%2C%22width%22%3A43.655658%2C%22height%22%3A10.903639999999996%2C%22text%22%3A%22%E6%B8%A9%E6%B0%91%E7%B2%BE%E5%B1%B1%2C%22%7D%2C%7B%22x%22%3A23.199793%2C%22y%22%3A425.10962%2C%22width%22%3A15.725777%2C%22height%22%3A13.182619999999986%2C%22text%22%3A%22a%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22%E8%BE%85%E5%85%A5%E4%BD%A0%E6%AD%A3%E5%9C%A8%E6%89%BE%E7%9A%84%E5%AE%9D%E8%B4%9D%20%E6%8E%A8%E9%A6%99%20%E9%99%84%E8%BF%91%20%E9%BB%91%E7%99%BD%E8%80%97%E6%9E%97%202399%20%E5%A4%A7%E5%A0%A1%E5%BA%97OSM095%E6%96%B0%E8%AE%BE%E5%85%A8%E5%8F%B864G%E9%AB%98%E8%AF%B7120%E4%BA%8B%E8%A3%85%E7%94%B5%E9%85%92%20%E5%A4%A7%E5%BA%97HOSMO9%E7%B2%BE%E8%AE%BE%E5%85%A8%E9%87%8F%E9%9A%86%E9%99%90%E7%94%B5%E9%85%9264GOSMO%20%E5%A4%AB%E4%B8%9A%E8%B4%A8%201.00%E4%B8%87%20%E6%B8%A9%E6%B0%91%E7%B2%BE%E5%B1%B1%2C%20a%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A155%2C%22height%22%3A257%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/2398c334-4f34-4f5b-b179-3831cb84a780.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"257px\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616383834480-848ce0de-ff52-4202-a05e-ba9190b39ad4.png%22%2C%22originWidth%22%3A526%2C%22originHeight%22%3A474%2C%22name%22%3A%22image.png%22%2C%22size%22%3A107503%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A236.69072%2C%22y%22%3A29.316824%2C%22width%22%3A47.81098000000003%2C%22height%22%3A20.590666000000002%2C%22text%22%3A%22APP%22%7D%2C%7B%22x%22%3A184.39276%2C%22y%22%3A106.78799%2C%22width%22%3A152.63867%2C%22height%22%3A24.25315000000002%2C%22text%22%3A%22Microservice%22%7D%2C%7B%22x%22%3A215.95769%2C%22y%22%3A141.67192%2C%22width%22%3A92.16670999999997%2C%22height%22%3A20.940429999999992%2C%22text%22%3A%22Getway%22%7D%2C%7B%22x%22%3A186.45%2C%22y%22%3A209.63219%2C%22width%22%3A153.35826000000003%2C%22height%22%3A24.48872%2C%22text%22%3A%22Microservice%22%7D%2C%7B%22x%22%3A197.07678%2C%22y%22%3A244.60085%2C%22width%22%3A129.78525%2C%22height%22%3A22.340349999999972%2C%22text%22%3A%22Aggregator%22%7D%2C%7B%22x%22%3A82.18812%2C%22y%22%3A321.87622%2C%22width%22%3A23.04875%2C%22height%22%3A23.04875%2C%22text%22%3A%22A%22%7D%2C%7B%22x%22%3A237.23116%2C%22y%22%3A417.15915%2C%22width%22%3A48.76188000000002%2C%22height%22%3A22.75128000000001%2C%22text%22%3A%22DB2%22%7D%2C%7B%22x%22%3A71.50369%2C%22y%22%3A417.68173%2C%22width%22%3A47.53433%2C%22height%22%3A22.57153999999997%2C%22text%22%3A%22DB1%22%7D%2C%7B%22x%22%3A395.04575%2C%22y%22%3A418.0725%2C%22width%22%3A48.11464999999998%2C%22height%22%3A21.67579999999998%2C%22text%22%3A%22DB3%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22APP%20Microservice%20Getway%20Microservice%20Aggregator%20A%20DB2%20DB1%20DB3%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A275%2C%22height%22%3A248%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/4ef35a19-fb3e-431c-9e2f-79cd4a3d21f6.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"248px\"></span></span></p> \n   <p data-lake-id=\"bd08d7ef9cc6ae2c5523026d2be320fa\" data-wording=\"true\">通过业务逻辑层驱动</p> \n   <ul data-lake-id=\"106f63779244bc36911e278ec3c57253\"> \n    <li data-lake-id=\"4a6aa0aa6db51dfaabbcbf8bfae5b639\" data-wording=\"true\">解决方案</li> \n   </ul> \n   <ul data-lake-id=\"d8c15afc42b625ccce09db91941427e8\"> \n    <ul data-lake-id=\"69a1f0e40f3c648ee491a0c41339e573\"> \n     <li data-lake-id=\"48a0ecc7c89e3382b74df470e87d0d6c\" data-wording=\"true\">基于异步补偿的分布式事物</li> \n     <li data-lake-id=\"68d6ad900b1be9cc0800d7482280418b\" data-wording=\"true\">架构设计的三大关键点</li> \n    </ul> \n   </ul> \n   <p data-lake-id=\"1e16ab821c9110daea16be105e4dbd64\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616383948996-2f9fc48a-6d54-46a6-a9ce-890a0cdd6057.png%22%2C%22originWidth%22%3A406%2C%22originHeight%22%3A362%2C%22name%22%3A%22image.png%22%2C%22size%22%3A93122%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A170.34447%2C%22y%22%3A28.304968%2C%22width%22%3A51.42309%2C%22height%22%3A27.541239%2C%22text%22%3A%22%E8%AE%B0%E5%BD%95%22%7D%2C%7B%22x%22%3A169.79065%2C%22y%22%3A60.061596%2C%22width%22%3A52.058719999999994%2C%22height%22%3A26.870573999999998%2C%22text%22%3A%22%E8%AF%B7%E6%B1%82%22%7D%2C%7B%22x%22%3A170.8725%2C%22y%22%3A93.33495%2C%22width%22%3A48.00963999999999%2C%22height%22%3A24.691649999999996%2C%22text%22%3A%22%E8%B0%83%E7%94%A8%22%7D%2C%7B%22x%22%3A170.11739%2C%22y%22%3A125.74854%2C%22width%22%3A48.87423000000001%2C%22height%22%3A24.033579999999986%2C%22text%22%3A%22%E9%93%BE%E6%9D%A1%22%7D%2C%7B%22x%22%3A68.444954%2C%22y%22%3A199.4521%2C%22width%22%3A52.206866000000005%2C%22height%22%3A29.07580999999999%2C%22text%22%3A%22%E6%8F%90%E4%BE%9B%22%7D%2C%7B%22x%22%3A274.3735%2C%22y%22%3A213.1239%2C%22width%22%3A49.72937000000002%2C%22height%22%3A25.44287%2C%22text%22%3A%22%E5%9F%BA%E4%BA%8E%22%7D%2C%7B%22x%22%3A70.50131%2C%22y%22%3A235.8678%2C%22width%22%3A48.36631%2C%22height%22%3A27.829920000000016%2C%22text%22%3A%22%E5%B9%82%E7%AD%89%22%7D%2C%7B%22x%22%3A273.8777%2C%22y%22%3A248.70251%2C%22width%22%3A51.757799999999975%2C%22height%22%3A25.640870000000035%2C%22text%22%3A%22%E8%A1%A5%E5%81%BF%22%7D%2C%7B%22x%22%3A68.22755%2C%22y%22%3A268.75742%2C%22width%22%3A52.39150000000001%2C%22height%22%3A29.640499999999975%2C%22text%22%3A%22%E8%A1%A5%E5%81%BF%22%7D%2C%7B%22x%22%3A272.75708%2C%22y%22%3A283.63803%2C%22width%22%3A51.302250000000015%2C%22height%22%3A23.853639999999984%2C%22text%22%3A%22%E6%9C%BA%E5%88%B6%22%7D%2C%7B%22x%22%3A66.5542%2C%22y%22%3A304.692%2C%22width%22%3A53.35323000000001%2C%22height%22%3A28.71123%2C%22text%22%3A%22%E6%8E%A5%E5%8F%A3%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22%E8%AE%B0%E5%BD%95%20%E8%AF%B7%E6%B1%82%20%E8%B0%83%E7%94%A8%20%E9%93%BE%E6%9D%A1%20%E6%8F%90%E4%BE%9B%20%E5%9F%BA%E4%BA%8E%20%E5%B9%82%E7%AD%89%20%E8%A1%A5%E5%81%BF%20%E8%A1%A5%E5%81%BF%20%E6%9C%BA%E5%88%B6%20%E6%8E%A5%E5%8F%A3%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A281%2C%22height%22%3A251%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/bf0cf161-de97-44c7-8631-0c03ed6807d0.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"251px\"></span></p> \n   <p data-lake-id=\"1d13f37c1e8a99d4fd35f0528cd486d3\" data-wording=\"true\">开始记录调用请求的参数,如果失败后基于参数做补偿接口,接口需要保证幂等性</p> \n   <ul data-lake-id=\"61d55c43ccbe8612befb2928fa3fa59b\"> \n    <li data-lake-id=\"b1555271c14fe31b1c083a6c4a834d78\" data-wording=\"true\">总体架构设计</li> \n   </ul> \n   <p data-lake-id=\"0a44991690e8a93753180c1be02d482e\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616384535142-da02d7a3-c0ac-4612-b3a6-f2735606b5bf.png%22%2C%22originWidth%22%3A779%2C%22originHeight%22%3A517%2C%22name%22%3A%22image.png%22%2C%22size%22%3A242802%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A6.5803876%2C%22y%22%3A1.9137955%2C%22width%22%3A220.0757824%2C%22height%22%3A30.1308705%2C%22text%22%3A%22%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A1%A5%E5%81%BF%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A371.98816%2C%22y%22%3A24.070679%2C%22width%22%3A73.09854000000001%2C%22height%22%3A25.799885000000003%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A606.2557%2C%22y%22%3A24.31301%2C%22width%22%3A72.61609999999996%2C%22height%22%3A25.851600000000005%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A606.1121%2C%22y%22%3A54.303303%2C%22width%22%3A72.35619999999994%2C%22height%22%3A23.611987%2C%22text%22%3A%22%E7%BD%91%E5%85%B3%E5%B1%82%22%7D%2C%7B%22x%22%3A372.33865%2C%22y%22%3A54.862625%2C%22width%22%3A72.60898000000003%2C%22height%22%3A24.105264999999996%2C%22text%22%3A%22%E7%BD%91%E5%85%B3%E5%B1%82%22%7D%2C%7B%22x%22%3A94.93671%2C%22y%22%3A79.2058%2C%22width%22%3A63.07566%2C%22height%22%3A19.693483999999998%2C%22text%22%3A%22tstate%22%7D%2C%7B%22x%22%3A310.60184%2C%22y%22%3A132.07681%2C%22width%22%3A194.7756%2C%22height%22%3A27.38091%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%B1%82%22%7D%2C%7B%22x%22%3A605.47974%2C%22y%22%3A146.18263%2C%22width%22%3A74.56956000000002%2C%22height%22%3A26.358400000000017%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A71.948235%2C%22y%22%3A166.92235%2C%22width%22%3A110.022465%2C%22height%22%3A24.419630000000012%2C%22text%22%3A%22tschedule%22%7D%2C%7B%22x%22%3A582.2233%2C%22y%22%3A176.48625%2C%22width%22%3A120.65053999999998%2C%22height%22%3A24.82067999999998%2C%22text%22%3A%22%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%B1%82%22%7D%2C%7B%22x%22%3A407.08493%2C%22y%22%3A189.93712%2C%22width%22%3A74.32697000000002%2C%22height%22%3A23.405590000000018%2C%22text%22%3A%22proxy%22%7D%2C%7B%22x%22%3A64.86474%2C%22y%22%3A250.86542%2C%22width%22%3A120.18255%2C%22height%22%3A24.449579999999997%2C%22text%22%3A%22deserialize%22%7D%2C%7B%22x%22%3A292.27777%2C%22y%22%3A271.05292%2C%22width%22%3A215.98981000000003%2C%22height%22%3A28.926510000000007%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82%22%7D%2C%7B%22x%22%3A540.664%2C%22y%22%3A271.29828%2C%22width%22%3A215.23663%2C%22height%22%3A28.045020000000022%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82%22%7D%2C%7B%22x%22%3A609.97565%2C%22y%22%3A321.76404%2C%22width%22%3A78.69995000000006%2C%22height%22%3A22.079559999999958%2C%22text%22%3A%22%E5%8E%9F%E5%AD%90%E6%8E%A5%E5%8F%A3%22%7D%2C%7B%22x%22%3A420.44193%2C%22y%22%3A322.29346%2C%22width%22%3A79.27913999999998%2C%22height%22%3A23.287080000000003%2C%22text%22%3A%22%E8%A1%A5%E5%81%BF%E6%8E%A5%E5%8F%A3%22%7D%2C%7B%22x%22%3A304.99356%2C%22y%22%3A322.85715%2C%22width%22%3A81.45639%2C%22height%22%3A22.591790000000003%2C%22text%22%3A%22%E5%8E%9F%E5%AD%90%E6%8E%A5%E5%8F%A3%22%7D%2C%7B%22x%22%3A74.03906%2C%22y%22%3A336.27182%2C%22width%22%3A106.92989%2C%22height%22%3A30.588930000000005%2C%22text%22%3A%22rpcllient%22%7D%2C%7B%22x%22%3A629.12225%2C%22y%22%3A463.17395%2C%22width%22%3A47.785150000000044%2C%22height%22%3A23.544190000000015%2C%22text%22%3A%22DB2%22%7D%2C%7B%22x%22%3A404.18222%2C%22y%22%3A464.69333%2C%22width%22%3A45.97368%2C%22height%22%3A22.02985000000001%2C%22text%22%3A%22DB1%22%7D%2C%7B%22x%22%3A103.4303%2C%22y%22%3A464.97348%2C%22width%22%3A46.672219999999996%2C%22height%22%3A23.05176%2C%22text%22%3A%22TDB%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A1%A5%E5%81%BF%E6%9C%8D%E5%8A%A1%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%20%E7%BD%91%E5%85%B3%E5%B1%82%20%E7%BD%91%E5%85%B3%E5%B1%82%20tstate%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%B1%82%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%20tschedule%20%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%B1%82%20proxy%20deserialize%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82%20%E5%8E%9F%E5%AD%90%E6%8E%A5%E5%8F%A3%20%E8%A1%A5%E5%81%BF%E6%8E%A5%E5%8F%A3%20%E5%8E%9F%E5%AD%90%E6%8E%A5%E5%8F%A3%20rpcllient%20DB2%20DB1%20TDB%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A679%2C%22height%22%3A451%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/592b2e30-4107-48a6-b348-1a3751e1daec.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"451px\"></span></p> \n   <p data-lake-id=\"c1b3d38d81434b0f525d75b7aa816e23\" data-wording=\"true\">场景:A下单,B减库存,C支付,在调用接口的时候,A先走Proxy存入事物ID,状态,参数等信息,然后执行本地事物,接着B,C走同样的流程如果都成功,那么事物状态改成2,也就是成功,如果在C失败的时候可以更具参数,事物ID对A,B进行补偿</p> \n   <h4 id=\"6I6ql\" data-lake-id=\"5c9f87d8d7eff06358d21dd0efe5b55e\" data-wording=\"true\">业务逻辑层Proxy设计(基于AOP实现)</h4> \n   <ul data-lake-id=\"52e77462907a67c7619f6a56539cbc3f\"> \n    <ul data-lake-id=\"c38e289435f24fab63ff0c47a54ac908\"> \n     <li data-lake-id=\"ffab0939f89526b490ae68eb6ebe7a90\" data-wording=\"true\">逻辑层调用上加上事物注解@Around(\"execution(**(..)) &amp;&amp; @annotation(TX)\")</li> \n     <li data-lake-id=\"659666ec3338d3fbdd6768b116d7cd22\" data-wording=\"true\">Proxy在真正业务逻辑被调用之前,生成一个全局唯一TXID标示事务组,TXID保存在ThreadLocal变量中,方法开始前写入,完成后清除,并向远端数据库写入TXID并把事务组制成开始状态</li> \n     <li data-lake-id=\"b2a4e133dfa6bf64ff17b0448b7fb4cc\" data-wording=\"true\">业务逻辑层调用数据访问层之前,通过RPCProxy代理记录,当前调用请求参数</li> \n     <li data-lake-id=\"3358142d5d4e1193c4e736661c426b2a\" data-wording=\"true\">如果业务正常,调用完成后,当前方法的调用记录删除或者存档</li> \n     <li data-lake-id=\"a48dc754df16c86750c8096cf35fccbd\" data-wording=\"true\">如果业务异常,查询调用链反向补偿</li> \n    </ul> \n   </ul> \n   <p data-lake-id=\"3d5eb292795a7c0cb8e01cde86e9ed6c\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616392634079-90ab88b2-c921-491b-9046-7972f53a9f80.png%22%2C%22originWidth%22%3A422%2C%22originHeight%22%3A341%2C%22name%22%3A%22image.png%22%2C%22size%22%3A64429%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A27.357138%2C%22y%22%3A13.043503%2C%22width%22%3A165.327722%2C%22height%22%3A22.314330999999996%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%B1%82%22%7D%2C%7B%22x%22%3A277.96866%2C%22y%22%3A26.624557%2C%22width%22%3A61.92419000000001%2C%22height%22%3A21.021626%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%22%7D%2C%7B%22x%22%3A257.24692%2C%22y%22%3A51.952076%2C%22width%22%3A102.09951999999998%2C%22height%22%3A21.622824%2C%22text%22%3A%22%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%B1%82%22%7D%2C%7B%22x%22%3A109.37704%2C%22y%22%3A62.040787%2C%22width%22%3A63.639880000000005%2C%22height%22%3A19.511172999999992%2C%22text%22%3A%22proxy%22%7D%2C%7B%22x%22%3A24.179321%2C%22y%22%3A120.63361%2C%22width%22%3A41.318939%2C%22height%22%3A13.272719999999993%2C%22text%22%3A%22AOP%22%7D%2C%7B%22x%22%3A53.45171%2C%22y%22%3A138.59058%2C%22width%22%3A25.311280000000004%2C%22height%22%3A13.310480000000013%2C%22text%22%3A%22Try%22%7D%2C%7B%22x%22%3A78.90998%2C%22y%22%3A165.6953%2C%22width%22%3A49.909859999999995%2C%22height%22%3A12.495429999999999%2C%22text%22%3A%22proxy%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%B1%82%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%20%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%B1%82%20proxy%20AOP%20Try%20proxy%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A422%2C%22height%22%3A341%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/c5eaed89-09f5-4cb6-b339-5a546c897b7e.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"341px\"></span></p> \n   <ul data-lake-id=\"25248b70784ccb75668be72a4669e0da\"> \n    <li data-lake-id=\"25e262d3d3941c4e0af983073a9bcb25\" data-wording=\"true\">数据访问层设计</li> \n   </ul> \n   <ul data-lake-id=\"8b9301ffe09272ef8c17906e36be42ad\"> \n    <ul data-lake-id=\"f24e612b7650dd9a3e731612cdd7c38a\"> \n     <li data-lake-id=\"9f584a85a38aae90420037d07c0ec929\" data-wording=\"true\">原子接口</li> \n     <li data-lake-id=\"4c8acfa2fce2dec8e4e8db26f8ec80d7\" data-wording=\"true\">补偿接口</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"0153a09414da3269bcb8f4d20e359f3b\"> \n    <ul data-lake-id=\"618dcc08fd722b3f5deb8aadb4f8bec6\"> \n     <ul data-lake-id=\"4e409d54a5d9b0d15a913c37df20d894\"> \n      <li data-lake-id=\"22f2c0a6d7e2c89aa7dc2f01d53da68a\" data-wording=\"true\">谁来提供?</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"f5acf251be270de7fed938ae3a7f99b2\"> \n    <ul data-lake-id=\"258388f82f8a58e7719ab3db8f025b58\"> \n     <ul data-lake-id=\"e430042e30fc383def9fd606e4016079\"> \n      <ul data-lake-id=\"fbcb0c4f0c0a2f0a5b420482187831a9\"> \n       <li data-lake-id=\"a94334a387f8a04a81d01ed997016f41\" data-wording=\"true\">业务方提供</li> \n      </ul> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"1662370cffe739d1c682c97fbe1dde3c\"> \n    <ul data-lake-id=\"f1019091629a6a88d5c581c39d07dd6d\"> \n     <ul data-lake-id=\"95a21bdace658a5d4b093293c3835000\"> \n      <li data-lake-id=\"bfdf35b7e4d08b85e03f870df129ea92\" data-wording=\"true\">幂等性保证</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"b2ded275578f30a93768b8cd3e1de739\"> \n    <ul data-lake-id=\"f6761436cd08761fb0748189302e8523\"> \n     <ul data-lake-id=\"6010c8e8c2ed6ae665bdd8cd471f5608\"> \n      <ul data-lake-id=\"9a69c80fa87b4190497297476146f162\"> \n       <li data-lake-id=\"2aa7592e9641975b2fbb2a4ee1b6eba6\" data-wording=\"true\">采用本地资源锁,锁定唯一资源</li> \n      </ul> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"6232e371de951d5b6f502b60e828738c\"> \n    <ul data-lake-id=\"dd0a8e63ac2f5f35d8bc70718bb5ce9e\"> \n     <li data-lake-id=\"b80053698ebce56b63bf3af9f8f6a54f\" data-wording=\"true\">基于原则接口方法,在方法名加注解标注补偿方法名</li> \n     <li data-lake-id=\"f3d74c3d2656bfdcc39a482ad8bd1b82\" data-wording=\"true\">@Compensable(cancelMethod = \"cancelRecord\")</li> \n    </ul> \n   </ul> \n   <p data-lake-id=\"c6eb23effc5433a95987e923fd5a6ada\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616393233775-cc5dcfa4-84af-470f-9ff4-dd39b1afd9dd.png%22%2C%22originWidth%22%3A218%2C%22originHeight%22%3A113%2C%22name%22%3A%22image.png%22%2C%22size%22%3A16649%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A16.100945%2C%22y%22%3A17.048182%2C%22width%22%3A183.590155%2C%22height%22%3A26.320534999999996%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82%22%7D%2C%7B%22x%22%3A74.80694%2C%22y%22%3A61.102306%2C%22width%22%3A68.63048%2C%22height%22%3A18.837674000000007%2C%22text%22%3A%22%E5%8E%9F%E5%AD%90%E6%8E%A5%E5%8F%A3%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82%20%E5%8E%9F%E5%AD%90%E6%8E%A5%E5%8F%A3%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A218%2C%22height%22%3A113%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/09f9d3e3-2bbb-4827-a08e-81ea760ca2d1.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"113px\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616393245368-2d049826-1c9e-499d-b920-211f90f58461.png%22%2C%22originWidth%22%3A203%2C%22originHeight%22%3A112%2C%22name%22%3A%22image.png%22%2C%22size%22%3A15884%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A8.373663%2C%22y%22%3A17.364016%2C%22width%22%3A183.444557%2C%22height%22%3A23.949754%2C%22text%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82%22%7D%2C%7B%22x%22%3A65.38003%2C%22y%22%3A59.89993%2C%22width%22%3A70.06099%2C%22height%22%3A18.52867400000001%2C%22text%22%3A%22%E8%A1%A5%E5%81%BF%E6%8E%A5%E5%8F%A3%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82%20%E8%A1%A5%E5%81%BF%E6%8E%A5%E5%8F%A3%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A203%2C%22height%22%3A112%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/fe4d4a68-b61c-4f9c-aadf-b89beb33fcf4.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"112px\"></span></span></p> \n   <ul data-lake-id=\"2161fbae8a8bae89fda1354c35c03288\"> \n    <li data-lake-id=\"cc851e0859f847e7e81b1f3733f44a53\" data-wording=\"true\">分布式事物补偿服务</li> \n   </ul> \n   <ul data-lake-id=\"bf8ebffc09f3487b7f070ae68cd95b5b\"> \n    <ul data-lake-id=\"aa8d0901060a1e5bfe00435482c8a60a\"> \n     <li data-lake-id=\"825264e5b504b56be1f922f08088af23\" data-wording=\"true\">事物组表(数据库表TDB) &nbsp; &nbsp;</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"689e37d6ae282e361ae0537a7e4be663\"> \n    <ul data-lake-id=\"ddab82767cd58c878b39eb55e77c27e4\"> \n     <ul data-lake-id=\"db6cc679cb0cdb19650af466b7f61d7b\"> \n      <li data-lake-id=\"db4ba69974923c0a7e32f2e61ee0e693\" data-wording=\"true\">记录事物组状态</li> \n      <li data-lake-id=\"1912b55268a6727b73af3206b6088d3b\" data-wording=\"true\">txid state timestamp</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"ce8b25ab827dcbfe37f858935ec5f1b0\"> \n    <ul data-lake-id=\"673d2e8c9353ad5bb48006f3b3dd6b5a\"> \n     <li data-lake-id=\"232dc2e7e4f278b75d9052b1b429b4ed\" data-wording=\"true\">事物调用组表(数据库表TDB)</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"192fdef95e8981f8b119d73af1319aa5\"> \n    <ul data-lake-id=\"863d412addb5f523a195d20faba470c4\"> \n     <ul data-lake-id=\"a1631455575bea6e61937af4f5b81124\"> \n      <li data-lake-id=\"f1da1582313285ad614d7ae4e7e82451\" data-wording=\"true\">记录事物组内的每一次调用,以及相关参数</li> \n      <li data-lake-id=\"edc1308ef4f156def9140968b596d1b4\" data-wording=\"true\">txid actionid callmethod pramatype params</li> \n     </ul> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"acfe1ab194068b58037ca17e707c7cbb\"> \n    <ul data-lake-id=\"98f959e7b4a2f700c349fdd8aa65e828\"> \n     <li data-lake-id=\"739a872f7b6444adda98ce3c0d01938c\" data-wording=\"true\">补偿策略</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"bcbb2474b8c0ee0ebc5c45c02e7bc541\"> \n    <ul data-lake-id=\"4ce7a2b15cc72b3ca2c9aed47a650135\"> \n     <ul data-lake-id=\"5da13a7af0becc38af662df3a0866cf3\"> \n      <li data-lake-id=\"2e65c58e067ec3ee9db6401ecdd31efd\" data-wording=\"true\">调用执行失败,修改事物组状态</li> \n      <li data-lake-id=\"30ee34f51806d37d017c388ea4b2a4f7\" data-wording=\"true\">分布式事物补偿服务异步执行补偿</li> \n     </ul> \n    </ul> \n   </ul> \n   <h4 id=\"gmTuf\" data-lake-id=\"cce7b18ddfb2da9f9904d09ac9b32259\" data-wording=\"true\">分布式事物成功案例</h4> \n   <ul data-lake-id=\"93e520669bfc0241297827a1e3b427f4\"> \n    <li data-lake-id=\"807d6371e7184714f72c4bcb6add4ff4\" data-wording=\"true\">二手交易创建订单事务组正常流程</li> \n   </ul> \n   <ul data-lake-id=\"f1e08e43f600f188e886b94b7545edcc\"> \n    <ul data-lake-id=\"942f893f48634801cf6469e9ae7e060e\"> \n     <li data-lake-id=\"6df1941d2b29d635d782f49118790f30\" data-wording=\"true\">锁库存-&gt;减红包-&gt;创建订单</li> \n    </ul> \n   </ul> \n   <ul data-lake-id=\"826ea298a530ae3af592b779f1a75686\"> \n    <li data-lake-id=\"d8336040c8c428170ef0cb4ee978951e\" data-wording=\"true\">代理层透明记录调用请求参数</li> \n   </ul> \n   <ul data-lake-id=\"97ebe51bed74b1b93efbf4aa05fbc1a5\"> \n    <ul data-lake-id=\"1e7dd29cbbc426096bdb2bfa23d6dd48\"> \n     <li data-lake-id=\"fe868f300e5a20260abe6b445d0804c7\" data-wording=\"true\">记录事物域的开始与结束</li> \n     <li data-lake-id=\"876b3813222f7851e145a13e251006a3\" data-wording=\"true\">在所有远程调用成功时</li> \n     <li data-lake-id=\"695a31290a9834760ee3ad43748b27a6\" data-wording=\"true\">对业务逻辑不做侵入</li> \n    </ul> \n   </ul> \n   <p data-lake-id=\"e8f7be7dca717f68b412eedadbe713da\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616396596657-69320af8-21aa-4965-af0d-425d1e579b43.png%22%2C%22originWidth%22%3A451%2C%22originHeight%22%3A475%2C%22name%22%3A%22image.png%22%2C%22size%22%3A80218%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A143.13506%2C%22y%22%3A10.339915%2C%22width%22%3A50.84143999999998%2C%22height%22%3A10.359388000000001%2C%22text%22%3A%22ereateoree%22%7D%2C%7B%22x%22%3A385.14932%2C%22y%22%3A10.479992%2C%22width%22%3A56.11542000000003%2C%22height%22%3A9.520149%2C%22text%22%3A%22oreErSErice%22%7D%2C%7B%22x%22%3A325.4332%2C%22y%22%3A10.218028%2C%22width%22%3A42.016020000000026%2C%22height%22%3A10.246747%2C%22text%22%3A%22rednxaes%22%7D%2C%7B%22x%22%3A267.74875%2C%22y%22%3A10.806603%2C%22width%22%3A39.58661000000001%2C%22height%22%3A9.22591%2C%22text%22%3A%221rtntory%22%7D%2C%7B%22x%22%3A48.175587%2C%22y%22%3A10.975392%2C%22width%22%3A77.47931299999999%2C%22height%22%3A10.444088%2C%22text%22%3A%22trersktieasemt%22%7D%2C%7B%22x%22%3A33.881256%2C%22y%22%3A37.53552%2C%22width%22%3A38.912864000000006%2C%22height%22%3A12.242663%2C%22text%22%3A%22%E5%BE%AE%E6%B8%85%E4%BA%8B%E6%9C%89%E6%81%AF%22%7D%2C%7B%22x%22%3A72.80602%2C%22y%22%3A62.086002%2C%22width%22%3A39.168536%2C%22height%22%3A11.366977999999996%2C%22text%22%3A%22%E9%80%9A%E8%87%AA%E8%A3%85%22%7D%2C%7B%22x%22%3A180.41357%2C%22y%22%3A88.028984%2C%22width%22%3A38.68779000000001%2C%22height%22%3A11.814526%2C%22text%22%3A%22%E6%B8%85%E7%94%B5R%E8%80%B3%E5%85%B7%22%7D%2C%7B%22x%22%3A141.91197%2C%22y%22%3A111.73237%2C%22width%22%3A31.952609999999993%2C%22height%22%3A12.056296000000003%2C%22text%22%3A%22%E5%8F%B2%E6%98%9F%E8%AF%BE%22%7D%2C%7B%22x%22%3A236.12224%2C%22y%22%3A138.00018%2C%22width%22%3A46.19248999999999%2C%22height%22%3A10.766649999999998%2C%22text%22%3A%22%E6%BE%B3%E7%94%B5%E9%9D%A0%E5%95%86%E7%B3%BB%E7%94%B7%22%7D%2C%7B%22x%22%3A200.91887%2C%22y%22%3A162.56487%2C%22width%22%3A54.15091000000001%2C%22height%22%3A11.56574999999998%2C%22text%22%3A%22%E8%96%84%E9%87%8D%E6%B0%B4%E8%82%B2%E5%B9%B4%E9%A6%86%22%7D%2C%7B%22x%22%3A180.12445%2C%22y%22%3A187.89388%2C%22width%22%3A39.070269999999994%2C%22height%22%3A11.802089999999993%2C%22text%22%3A%22%E7%94%A8%E7%94%A8R%E7%90%86%E6%98%9F%22%7D%2C%7B%22x%22%3A142.31697%2C%22y%22%3A212.36006%2C%22width%22%3A32.36804000000001%2C%22height%22%3A11.467379999999991%2C%22text%22%3A%22%E4%BD%A0%E8%9B%8B%E8%B0%83%E9%B8%AD%22%7D%2C%7B%22x%22%3A265.08002%2C%22y%22%3A236.6128%2C%22width%22%3A46.32541000000003%2C%22height%22%3A12.145579999999995%2C%22text%22%3A%22%E6%BE%B3%E6%98%8E%E5%90%90%E7%9B%B4%E6%98%8E%E5%8A%A1%22%7D%2C%7B%22x%22%3A238.09424%2C%22y%22%3A262.66833%2C%22width%22%3A39.04275999999999%2C%22height%22%3A11.475009999999997%2C%22text%22%3A%22%E9%95%BF%E5%8C%85%E9%A3%9E%E8%B4%A8%E6%B2%99%22%7D%2C%7B%22x%22%3A184.78032%2C%22y%22%3A287.06927%2C%22width%22%3A29.91165000000001%2C%22height%22%3A11.743329999999958%2C%22text%22%3A%22%E8%B0%83%E7%94%A8%E4%BB%A3%E5%8F%B8%22%7D%2C%7B%22x%22%3A141.60681%2C%22y%22%3A312.09677%2C%22width%22%3A33.032849999999996%2C%22height%22%3A12.192870000000028%2C%22text%22%3A%22%E5%AE%89%E8%9B%8B%E6%B2%B9%22%7D%2C%7B%22x%22%3A296.91824%2C%22y%22%3A337.78232%2C%22width%22%3A47.31457999999998%2C%22height%22%3A11.023829999999975%2C%22text%22%3A%22%E8%B0%83%E5%95%A1%E8%AE%A2%E6%9E%9C%E7%A0%81%E5%8A%A1%22%7D%2C%7B%22x%22%3A267.29733%2C%22y%22%3A361.77823%2C%22width%22%3A45.94497000000001%2C%22height%22%3A11.41431%2C%22text%22%3A%22%E7%94%A8%E5%80%BC%E5%BA%97%22%7D%2C%7B%22x%22%3A75.910164%2C%22y%22%3A386.95288%2C%22width%22%3A33.20674100000001%2C%22height%22%3A10.963959999999986%2C%22text%22%3A%22%E4%BA%AC%E9%95%87%22%7D%2C%7B%22x%22%3A34.51112%2C%22y%22%3A412.66714%2C%22width%22%3A38.52922%2C%22height%22%3A11.30259000000001%2C%22text%22%3A%22%E9%91%AB%E8%81%9A%E7%94%B5%E5%8D%96%E7%90%86%22%7D%2C%7B%22x%22%3A384.93738%2C%22y%22%3A448.4767%2C%22width%22%3A57.256249999999966%2C%22height%22%3A10.089949999999988%2C%22text%22%3A%22oreersenico%22%7D%2C%7B%22x%22%3A5.209579%2C%22y%22%3A448.77872%2C%22width%22%3A24.6475%2C%22height%22%3A10.527279999999962%2C%22text%22%3A%22oron%22%7D%2C%7B%22x%22%3A267.74164%2C%22y%22%3A448.84384%2C%22width%22%3A40.316280000000006%2C%22height%22%3A10.534490000000005%2C%22text%22%3A%2210reatory%22%7D%2C%7B%22x%22%3A47.045364%2C%22y%22%3A448.9059%2C%22width%22%3A78.79177100000001%2C%22height%22%3A9.740980000000036%2C%22text%22%3A%22tnssxctioasener%22%7D%2C%7B%22x%22%3A143.21764%2C%22y%22%3A449.39017%2C%22width%22%3A51.09588000000002%2C%22height%22%3A9.424730000000011%2C%22text%22%3A%22creatcoreet%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22ereateoree%20oreErSErice%20rednxaes%201rtntory%20trersktieasemt%20%E5%BE%AE%E6%B8%85%E4%BA%8B%E6%9C%89%E6%81%AF%20%E9%80%9A%E8%87%AA%E8%A3%85%20%E6%B8%85%E7%94%B5R%E8%80%B3%E5%85%B7%20%E5%8F%B2%E6%98%9F%E8%AF%BE%20%E6%BE%B3%E7%94%B5%E9%9D%A0%E5%95%86%E7%B3%BB%E7%94%B7%20%E8%96%84%E9%87%8D%E6%B0%B4%E8%82%B2%E5%B9%B4%E9%A6%86%20%E7%94%A8%E7%94%A8R%E7%90%86%E6%98%9F%20%E4%BD%A0%E8%9B%8B%E8%B0%83%E9%B8%AD%20%E6%BE%B3%E6%98%8E%E5%90%90%E7%9B%B4%E6%98%8E%E5%8A%A1%20%E9%95%BF%E5%8C%85%E9%A3%9E%E8%B4%A8%E6%B2%99%20%E8%B0%83%E7%94%A8%E4%BB%A3%E5%8F%B8%20%E5%AE%89%E8%9B%8B%E6%B2%B9%20%E8%B0%83%E5%95%A1%E8%AE%A2%E6%9E%9C%E7%A0%81%E5%8A%A1%20%E7%94%A8%E5%80%BC%E5%BA%97%20%E4%BA%AC%E9%95%87%20%E9%91%AB%E8%81%9A%E7%94%B5%E5%8D%96%E7%90%86%20oreersenico%20oron%2010reatory%20tnssxctioasener%20creatcoreet%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A451%2C%22height%22%3A475%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/f1169412-cb12-4023-a2c7-bcb83b20e148.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"475px\"></span></p> \n   <h4 id=\"NCf6V\" data-lake-id=\"0d68162cfdd1d5694eac494a725d2ba0\" data-wording=\"true\">分布式事物失败案例</h4> \n   <ul data-lake-id=\"a8a537ce315a65b05835a4096976f89f\"> \n    <li data-lake-id=\"21f4b0764b934b7854f8cc8b7039beb8\" data-wording=\"true\">二手交易创建订单事务组异常流程</li> \n   </ul> \n   <ul data-lake-id=\"ebf986c5dd18075c48a8f0e613eb7eba\"> \n    <ul data-lake-id=\"124f8398e767c4f954c0a36d8c3401a4\"> \n     <li data-lake-id=\"f6111a517f409028133f8a4ccd469a84\" data-wording=\"true\">微服务数据访问层失败,代理更改事务组状态</li> \n     <li data-lake-id=\"74d31fda5a84198fb1aae42969efdef7\" data-wording=\"true\">微服务业务正常执行</li> \n     <li data-lake-id=\"845e278b6880cd0001adaa86fec19446\" data-wording=\"true\">事物补偿服务异步执行补偿</li> \n    </ul> \n   </ul> \n   <p data-lake-id=\"6f8ac49ba7ce5d472ef7f86485f5a1cb\" data-wording=\"true\"><span class=\"lake-card-margin-top lake-card-margin-bottom\" data-card-type=\"inline\" data-lake-card=\"image\" data-card-value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1603133%2F1616400804637-530f3fcb-7f74-4c45-9c2e-336689183335.png%22%2C%22originWidth%22%3A456%2C%22originHeight%22%3A502%2C%22name%22%3A%22image.png%22%2C%22size%22%3A99839%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A269.00995%2C%22y%22%3A12.721237%2C%22width%22%3A37.18856999999997%2C%22height%22%3A12.404959%2C%22text%22%3A%22P01%22%7D%2C%7B%22x%22%3A56.874836%2C%22y%22%3A13.68533%2C%22width%22%3A87.119794%2C%22height%22%3A12.635386999999998%2C%22text%22%3A%22trasacttonserwt%22%7D%2C%7B%22x%22%3A396.8646%2C%22y%22%3A14.089374%2C%22width%22%3A49.16005999999999%2C%22height%22%3A11.667792000000002%2C%22text%22%3A%22roooxket%22%7D%2C%7B%22x%22%3A331.1076%2C%22y%22%3A14.8748045%2C%22width%22%3A45.340250000000026%2C%22height%22%3A10.2784625%2C%22text%22%3A%22inwentor%22%7D%2C%7B%22x%22%3A164.84157%2C%22y%22%3A14.670238%2C%22width%22%3A56.88312000000002%2C%22height%22%3A10.496497%2C%22text%22%3A%22creatoorcer%22%7D%2C%7B%22x%22%3A9.798073%2C%22y%22%3A14.928769%2C%22width%22%3A26.304592%2C%22height%22%3A10.327487%2C%22text%22%3A%22oror%22%7D%2C%7B%22x%22%3A39.740643%2C%22y%22%3A42.85336%2C%22width%22%3A44.39659700000001%2C%22height%22%3A13.284971999999996%2C%22text%22%3A%22%E5%88%9B%E5%BB%BA%E4%BA%8B%E5%8A%A1%E7%BB%84%22%7D%2C%7B%22x%22%3A87.07844%2C%22y%22%3A70.31215%2C%22width%22%3A44.55384000000001%2C%22height%22%3A11.803060000000002%2C%22text%22%3A%22%E6%B6%88%E5%9B%AD%E9%80%92%E6%97%97%E5%85%B7%22%7D%2C%7B%22x%22%3A219.76741%2C%22y%22%3A96.767975%2C%22width%22%3A44.04801999999998%2C%22height%22%3A12.083454999999987%2C%22text%22%3A%22%E6%B6%88%E7%94%A8%E4%BB%A3%E9%81%93%E5%B1%82%22%7D%2C%7B%22x%22%3A176.04732%2C%22y%22%3A123.435585%2C%22width%22%3A37.871549999999985%2C%22height%22%3A13.221164999999985%2C%22text%22%3A%22%E6%AD%8C%E8%B0%83%E7%94%A8%22%7D%2C%7B%22x%22%3A295.55157%2C%22y%22%3A149.66576%2C%22width%22%3A53.24154999999996%2C%22height%22%3A13.280119999999982%2C%22text%22%3A%22%E6%BB%A1%E7%94%A8%E5%B0%BE%E5%AD%98%E8%9C%9C%E5%8A%A1%22%7D%2C%7B%22x%22%3A243.43135%2C%22y%22%3A176.40498%2C%22width%22%3A60.703869999999995%2C%22height%22%3A12.176880000000011%2C%22text%22%3A%22%E6%B7%B1%E9%97%BB%E5%87%8F%E6%B0%A7%E6%9C%89%E5%BA%AD%E6%A2%A6%22%7D%2C%7B%22x%22%3A220.10272%2C%22y%22%3A203.33063%2C%22width%22%3A43.64791999999997%2C%22height%22%3A12.017329999999987%2C%22text%22%3A%22%E7%94%A8%E7%94%A8%E4%BB%A3%E7%90%86%E9%9C%9C%22%7D%2C%7B%22x%22%3A175.73576%2C%22y%22%3A230.43962%2C%22width%22%3A38.14716999999999%2C%22height%22%3A12.613190000000003%2C%22text%22%3A%225%E6%99%AF%E8%B0%83%E7%94%A8%22%7D%2C%7B%22x%22%3A328.25195%2C%22y%22%3A256.19287%2C%22width%22%3A53.55526999999995%2C%22height%22%3A13.698369999999954%2C%22text%22%3A%22%E6%BB%A1%E7%94%A8%E7%BA%A2%E5%8C%85%E7%A0%81%E5%8A%A1%22%7D%2C%7B%22x%22%3A328.08835%2C%22y%22%3A284.1613%2C%22width%22%3A54.49628000000001%2C%22height%22%3A11.56468000000001%2C%22text%22%3A%22%E7%BA%A2%E5%8C%85%E7%81%8C%E7%94%A8%E8%88%9E%E8%90%A5%22%7D%2C%7B%22x%22%3A198.00903%2C%22y%22%3A309.9634%2C%22width%22%3A86.68666999999999%2C%22height%22%3A12.262400000000014%2C%22text%22%3A%22%E5%8F%AF%E5%AF%86%E5%8E%BF%E5%AE%9E%2C%E5%87%8C%E9%94%AE%E9%99%90%E5%85%AC%E5%8F%B8%22%7D%2C%7B%22x%22%3A173.01936%2C%22y%22%3A362.4775%2C%22width%22%3A43.936739999999986%2C%22height%22%3A13.090499999999963%2C%22text%22%3A%22%E4%BA%AB%E5%8A%A1%E6%8D%AE%22%7D%2C%7B%22x%22%3A242.2434%2C%22y%22%3A389.7513%2C%22width%22%3A37.351969999999994%2C%22height%22%3A13.01173%2C%22text%22%3A%22%E8%A1%A5%E5%A5%87%E7%BA%A2%E5%8C%85%22%7D%2C%7B%22x%22%3A207.82713%2C%22y%22%3A416.6119%2C%22width%22%3A37.74133999999998%2C%22height%22%3A12.705100000000016%2C%22text%22%3A%22%E5%85%B1%E4%B8%83%E4%B8%93%E5%8D%89%22%7D%2C%7B%22x%22%3A114.89092%2C%22y%22%3A445.41788%2C%22width%22%3A61.08471%2C%22height%22%3A14.67131999999998%2C%22text%22%3A%22%E7%88%B1%26%E4%BA%8B%E5%8A%A1%E6%84%8F%E5%85%B1%E6%80%81%22%7D%2C%7B%22x%22%3A56.64618%2C%22y%22%3A480.68625%2C%22width%22%3A87.22306999999999%2C%22height%22%3A12.103580000000022%2C%22text%22%3A%22traasactionserwc%22%7D%2C%7B%22x%22%3A164.21245%2C%22y%22%3A480.84134%2C%22width%22%3A57.325680000000006%2C%22height%22%3A11.426760000000002%2C%22text%22%3A%22createorder%22%7D%2C%7B%22x%22%3A399.38693%2C%22y%22%3A481.12845%2C%22width%22%3A45.845519999999965%2C%22height%22%3A11.49341000000004%2C%22text%22%3A%22redpxcuer%22%7D%2C%7B%22x%22%3A269.7611%2C%22y%22%3A481.5294%2C%22width%22%3A37.10752000000002%2C%22height%22%3A12.605599999999981%2C%22text%22%3A%22BPOTOY%22%7D%2C%7B%22x%22%3A331.9083%2C%22y%22%3A481.84888%2C%22width%22%3A44.87954000000002%2C%22height%22%3A10.753749999999968%2C%22text%22%3A%22tnweotory%22%7D%2C%7B%22x%22%3A9.134372%2C%22y%22%3A482.1909%2C%22width%22%3A27.665808%2C%22height%22%3A10.486620000000016%2C%22text%22%3A%22orory%22%7D%5D%2C%22style%22%3A%22none%22%2C%22search%22%3A%22P01%20trasacttonserwt%20roooxket%20inwentor%20creatoorcer%20oror%20%E5%88%9B%E5%BB%BA%E4%BA%8B%E5%8A%A1%E7%BB%84%20%E6%B6%88%E5%9B%AD%E9%80%92%E6%97%97%E5%85%B7%20%E6%B6%88%E7%94%A8%E4%BB%A3%E9%81%93%E5%B1%82%20%E6%AD%8C%E8%B0%83%E7%94%A8%20%E6%BB%A1%E7%94%A8%E5%B0%BE%E5%AD%98%E8%9C%9C%E5%8A%A1%20%E6%B7%B1%E9%97%BB%E5%87%8F%E6%B0%A7%E6%9C%89%E5%BA%AD%E6%A2%A6%20%E7%94%A8%E7%94%A8%E4%BB%A3%E7%90%86%E9%9C%9C%205%E6%99%AF%E8%B0%83%E7%94%A8%20%E6%BB%A1%E7%94%A8%E7%BA%A2%E5%8C%85%E7%A0%81%E5%8A%A1%20%E7%BA%A2%E5%8C%85%E7%81%8C%E7%94%A8%E8%88%9E%E8%90%A5%20%E5%8F%AF%E5%AF%86%E5%8E%BF%E5%AE%9E%2C%E5%87%8C%E9%94%AE%E9%99%90%E5%85%AC%E5%8F%B8%20%E4%BA%AB%E5%8A%A1%E6%8D%AE%20%E8%A1%A5%E5%A5%87%E7%BA%A2%E5%8C%85%20%E5%85%B1%E4%B8%83%E4%B8%93%E5%8D%89%20%E7%88%B1%26%E4%BA%8B%E5%8A%A1%E6%84%8F%E5%85%B1%E6%80%81%20traasactionserwc%20createorder%20redpxcuer%20BPOTOY%20tnweotory%20orory%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22width%22%3A456%2C%22height%22%3A502%7D\"><img src=\"http://localhost:9090/blogImages/2021/03/27/993f6d02-704b-4ea0-9dae-fbf6250d753e.png\" alt=\"image.png\" class=\"image lake-drag-image\" title=\"image.png\" data-role=\"image\" data-raw-src=\"\" data-height=\"502px\"></span></p> \n   <p data-lake-id=\"4ace1375ac9f5d56f375e39176342426\" data-wording=\"true\">好了,到这里分布式事物也就写完了..休息一下,,哎,又到了找工作的时候了,有需要可以联系我</p> \n  </div> \n </div> \n</div>', NULL, '2021-03-27 00:18:17', 0, NULL, NULL, 'https://www.cnblogs.com/flower-dance/p/14567024.html', 0, NULL);
INSERT INTO `t_blog` VALUES (287, 'Azure Front Door（三）启用 Web Application Firewall (WAF) 保护Web 应用程序，拒绝恶意攻击', '<h2>一，引言</h2> \n<p>　　上一篇我们利用 Azure Front Door 为后端 VM 部署提供流量的负载均衡。因为是演示实例，也没有实际的后端实例代码，只有一个 “Index.html” 的静态页面，那么我们今天直接在我们项目的根目录放置日志文件，如下图所示</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/890c1556-8393-4092-b46e-81817e1b57e7.png\" alt=\"\" loading=\"lazy\"></p> \n<p>而且我们通过 Azure Front Door frontend host 直接就可以访问到项目的根目录的文件了</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/d73ed541-8094-4076-b26c-e80649c2836d.png\" alt=\"\" loading=\"lazy\"></p> \n<p>这样的话就产生了很多问题，比方说我们的项目程序中没有处理根目录的资源，那么有可能导致其他任何人通过Azure Front Door frontend host 连接加上根目录资源文件的名称就可以直接获取到服务器跟目录的文件，这样是很危险的。同时，我们实际的项目代码中也要防止此类的攻击，例如 “SQL注入”、“跨站脚本攻击”等。这个时候，我们就需要学会利用Web Application Firewall&nbsp;提供集中保护，使其免受常见攻击和漏洞的侵害。</p> \n<p>-------------------- 我是分割线 --------------------</p> \n<h3><a href=\"https://www.cnblogs.com/AllenMaster/p/14482222.html\" target=\"_blank\">1，Azure Front Door（一）为基于.net core 开发的Azure App Service 提供流量转发</a></h3> \n<h3><a href=\"https://www.cnblogs.com/AllenMaster/p/14504616.html\" target=\"_blank\">2，Azure Front Door（二）对后端 VM 进行负载均衡</a></h3> \n<h3><a href=\"https://www.cnblogs.com/AllenMaster/p/14580985.html\" target=\"_blank\">3，Azure Front Door（三）启用 Web Application Firewall (WAF) 保护Web 应用程序，拒绝恶意攻击</a></h3> \n<h2>二，正文</h2> \n<h3>1，创建Azure Web Application Firewall(WAF)</h3> \n<p>Azure Portal 上点击 “Create a resource”，并且在搜索框中输入“ Web Application Firewall (WAF)” 进行搜索</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/effc1c4c-faf2-4fd5-b69f-734a7bdd0702.png\" alt=\"\" loading=\"lazy\"></p> \n<p>点击 “Create”</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/f1af21a9-423c-4995-9fa6-e02ac800d9e2.png\" alt=\"\" loading=\"lazy\"></p> \n<p>添加/选择参数</p> \n<p>Policy For 选择：“Global WAF（Front Door）”</p> \n<p>Front door SKU：“Front Door”</p> \n<p>Resource group：“Web_Test_FD_RG”</p> \n<p>Policy name：“cnbateblogwebwaf”</p> \n<p>点击 “Next：Policy settings &gt;” 进行配置策略设置</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/71393fbf-bee4-4ca8-992c-3bec4ceb0127.png\" alt=\"\" loading=\"lazy\"></p> \n<p>Mode（模式）选择：“Prevention（保护，预防）”</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/9852f659-5653-4a06-93f9-6b5d93725a03.png\" alt=\"\" loading=\"lazy\"></p> \n<p>等待验证完成后，点击 “Create” 进行创建</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/4411bd22-ebb9-46fe-86c7-bdaa470b8111.png\" alt=\"\" loading=\"lazy\"></p> \n<h3>2，配置 \"Web Application Firewall\" 拦截规则</h3> \n<p>首先我们需要添加关联的 Front host 主机，选择 “Setting =》Assocations”，点击 “+ Add frontend host” 添加关联主机</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/9b044a4d-217c-45a7-a11f-a4227507d318.png\" alt=\"\" loading=\"lazy\"></p> \n<p>选择上一篇文章中创建的 Azure Front Door “cnbateblogweb”，选择Azure Front Door 的主机 “cnbateblogweb-azurefd-net”，点击 “Add” 进行添加</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/5a327527-4923-4eee-aa93-17d3ffec4f18.png\" alt=\"\" loading=\"lazy\"></p> \n<p>点击 “Save” 进行保存操作</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/aab99dc3-c297-4c44-9c8e-efa58a6a77c3.png\" alt=\"\" loading=\"lazy\"></p> \n<p>接下来就需要我们进行配置自定义 WAF 规则了，选择 “Settings =》Custom rules”，点击 “+ Add custom rule”</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/29af93b7-dff6-4728-a2e1-745f56a9ff3b.png\" alt=\"\" loading=\"lazy\"></p> \n<p>输入相关参数</p> \n<p>Customer rule name：“ProtectTXTRule”</p> \n<p>Priority（权重）：“100”</p> \n<p><span style=\"color: rgba(255, 0, 0, 1)\"><strong>Priority（权重）：为规则指定唯一的编号，以指定相对于其他自定义规则处理规则的顺序。具有较低值的规则在具有较高值的规则之前进行求值。最佳实践是以100为增量分配数字。</strong></span></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/c40bec64-a1cf-420c-97ea-ebc0f980d1d3.png\" alt=\"\" loading=\"lazy\"></p> \n<p>接下来我们配置自定义规则匹配的条件，当请求的Azure Front Door 的 URL 已 “.txt” 为结尾的时候， 重定向流量到 “https://www.baidu.com”，点击 “Add”</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/2a3400fd-b040-47f6-9f34-daa515d5ab2f.png\" alt=\"\" loading=\"lazy\"></p> \n<p>添加完成后，点击 “Save” 保存当前自定义策略</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/e0300b66-5b00-4e27-8f09-74c93ac6399b.png\" alt=\"\" loading=\"lazy\"></p> \n<h3>3，测试 Web Application Firewall 的拦截威力</h3> \n<p>正常情况下的访问</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/583023c5-e729-4e20-b1d9-9e6865058fc1.png\" alt=\"\" loading=\"lazy\"></p> \n<p>如果我们在请求 Azure Front Door Frontend Host 链接中加上 日志文件呢？ <a href=\"https://cnbateblogweb.azurefd.net/202103261640.txt\" target=\"_blank\">https://cnbateblogweb.azurefd.net/202103261640.txt</a></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/a2ac9f78-4af0-48a4-b4c4-ba9c5ab14a6a.gif\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;ok，我们的目的也达成了！</p> \n<h2>三，结尾</h2> \n<p>　　ok，今天的分享主要是为了演示 Web Application Firewall（WAF）在不需要我们修改任何代码的情况下，截至配置重定向流量，拒绝流量等防护操作，下一篇我们继续讲解 Web Application Firewall (WAF) ，细细分享其中还有那些知识点。本文所分享的内容也存在着很多我自己的一些理解，有理解不到位的，还希望多多包涵，并且指出不足之处。</p> \n<p>参考资料：<a href=\"https://docs.microsoft.com/zh-cn/azure/frontdoor/\" target=\"_blank\">Azure Front Door</a>，<a href=\"https://docs.microsoft.com/zh-cn/azure/web-application-firewall/overview\" target=\"_blank\">Azure Web Application Firewall</a></p> \n<p>作者：<a href=\"https://www.cnblogs.com/AllenMaster\" target=\"_blank\">Allen</a>&nbsp;</p> \n<p>版权：转载请在文章明显位置注明作者及出处。如发现错误，欢迎批评指正。</p>', NULL, '2021-03-27 00:18:20', 0, NULL, NULL, 'https://www.cnblogs.com/AllenMaster/p/14580985.html', 0, NULL);
INSERT INTO `t_blog` VALUES (288, '前端开发：基于cypress的自动化实践', '<p>作为一个伪开发，在一个平台项目中负责前端的开发工作，开发框架为vue，本文我会站在前端开发的角度介绍，我是如何使用cypress的。</p> \n<ul> \n <li>[x] 如何在vue中使用cypress</li> \n <li>[x] 如何运行cypress</li> \n <li>[x] 如何编写测试用例</li> \n <li>[x] 如何解决测试数据的问题</li> \n <li>[x] 遇到的元素定位的问题</li> \n <li>[x] 如何看待cypress</li> \n <li>[x] cypress是否为最佳工具</li> \n <li>[x] 测试怎么办？</li> \n</ul> \n<h2 id=\"如何在vue中使用cypress\">如何在vue中使用cypress</h2> \n<p>vue提供了<code>vue-cli</code> 可以快速的创建vue项目。</p> \n<pre><code class=\"language-shell\">vue create hello-world\n</code></pre> \n<p>在选择安装项里面选择: <code>E2E testing</code> -&gt; <code>cypress</code>。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/c38590bc-f3a3-47fb-bad8-a9724843f052.png\" alt=\"\" loading=\"lazy\"></p> \n<h2 id=\"如何运行测试\">如何运行测试</h2> \n<ol> \n <li>通过命令启动</li> \n</ol> \n<pre><code class=\"language-shell\">&gt; npm run test:e2e\n</code></pre> \n<ol> \n <li>开启cyprss 管理窗口</li> \n</ol> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/aec5be6f-afdb-470f-b7bb-e47eca42655e.png\" alt=\"\" loading=\"lazy\"></p> \n<ol start=\"2\"> \n <li>点击<code>Run all specs</code> 或 某个测试文件运行</li> \n</ol> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/b6b35b2a-778d-4df3-9a97-4fa4fdbf4ee5.png\" alt=\"\" loading=\"lazy\"></p> \n<p>这里以<code>项目管理</code> 模块为例，运行5条用例只需要14s，速度还是非常快的。</p> \n<h2 id=\"如何编写测试用例\">如何编写测试用例</h2> \n<p>站在前端开发的角度上编写UI自动化用例，总体感受还是非常方便的！</p> \n<p>首先，为所有要操作的元素设置统一的属性。</p> \n<pre><code class=\"language-html\">&lt;el-button cy-data=\"create-project\" type=\"primary\" @click=\"showCreate\"&gt;创建&lt;/el-button&gt;\n...\n&lt;el-button cy-data=\"edit-project\" type=\"text\" size=\"small\" @click=\"showEdit(scope.row)\"&gt;编辑&lt;/el-button&gt;\n&lt;el-button cy-data=\"delete-project\" type=\"text\" size=\"small\" @click=\"deleteProject(scope.row)\"&gt;删除&lt;/el-button&gt;\n...\n</code></pre> \n<p>不建议占用HTML提供的的 <code>id</code>、<code>name</code>、<code>class</code>... 这些属性，他们一般都会有指定的用途，比如，<code>class</code> 是用来引用css样式的。 那么通过<code>cy-data=xxxx</code>即可以避免冲突，又更加统一和规范。</p> \n<p>接下来，就是编写 cypress 自动化代码了</p> \n<pre><code class=\"language-js\">describe(\'项目管理\', () =&gt; {\n  it(\'添加项目\', () =&gt; {\n    cy.visit(\'/#/project\')\n    cy.get(\'[cy-data=create-project]\', { timeout: 3000 }).click()\n    cy.wait(1000)\n    cy.get(\'[cy-data=project-name]\', { timeout: 3000 }).type(\'项目名称\')\n    cy.get(\'[cy-data=project-desc]\', { timeout: 3000 }).type(\'项目备注信息\')\n    cy.get(\'[cy-data=save-button]\', { timeout: 3000 }).click()  // 保存项目\n  });\n  // ...\n})\n</code></pre> \n<h2 id=\"如何解决测试数据的问题\">如何解决测试数据的问题</h2> \n<p>我们编写自动化测试用例，不管是接口还是UI都会面临测试数据的问题。比如，我要测试登录，得先去创建一个用户数据，我要测试搜索，先去创建一批可以搜索的数据。</p> \n<p>为此，我们不得不在自动化里面 使用<code>setUp/treaDown</code>这些fixture去写大量的前置或后置动作，来完成这些准备工作。站在测试的角度，这无疑让我们的测试用例变得复杂，然后，也很容易因为测试数据造成自动化用例的失败。</p> \n<p>那么，站在前端开发是如何解决的？在此之前我们要先了解一下开发过程：</p> \n<p>在项目开发过程中。前端为了更顺利的完成开发工作，不能等到后端开发好了接口，再手写前端功能，所以，会和后端定义好接口之后，通过mock来模拟接口数据，--<strong>面向mock开发</strong>。</p> \n<p>那么在面向mock开发的过程中，避免不了，前后端需要调整接口参数的情况，比如，前端需要增加一个字段，或后端说需要把数据结构调整一下。</p> \n<p>我们使用YAPI平台进行接口的定义，他可以根据定义随机的生成mock数据，数据的每个字段都可以随机生成，例如，<code>name</code>，<code>email</code>, <code>datatime</code> 等。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/3f287123-9cce-4b52-aee1-7c6bd5b39942.png\" alt=\"\" loading=\"lazy\"></p> \n<p>你可以直接通过下面的链接来访问mock接口：</p> \n<p><a href=\"https://yapi.baidu.com/mock/40650/api/v1/projects/list\" target=\"_blank\">https://yapi.baidu.com/mock/40650/api/v1/projects/list</a></p> \n<p>如何vue项目当中配置不同的环境？你需要去学习vue开发...</p> \n<h2 id=\"遇到的元素定位问题\">遇到的元素定位问题</h2> \n<p>然而，为每个元素添加定位方式，有时并不是我们想象的那么简单。</p> \n<p>如果你是使用过前端UI（例如 element-ui）库就会发现，并不是所有的页面元素都是通过HTML纯手写的。 例如，下面的弹窗。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/69f4abcd-9cc1-42be-88cf-5fc8d9936d38.png\" alt=\"\" loading=\"lazy\"></p> \n<p>通过 element-UI的实现方式是这样子的。</p> \n<pre><code class=\"language-js\">&lt;template&gt;\n  &lt;el-button type=\"text\" @click=\"open\"&gt;点击打开 Message Box&lt;/el-button&gt;\n&lt;/template&gt;\n\n&lt;script&gt;\n  export default {\n    methods: {\n      open() {\n        this.$confirm(\'此操作将永久删除该文件, 是否继续?\', \'提示\', {\n          confirmButtonText: \'确定\',\n          cancelButtonText: \'取消\',\n          type: \'warning\'\n        }).then(() =&gt; {\n          this.$message({ type: \'success\',  message: \'删除成功!\' });\n        }).catch(() =&gt; {\n          this.$message({ type: \'info\', message: \'已取消删除\' });          \n        });\n      }\n    }\n  }\n&lt;/script&gt;\n</code></pre> \n<p>弹窗完全通过 element-UI 渲染，我们无处给 <code>确定</code>、<code>取消</code> 等按钮加上定位专用属性。 这个时候，前端开发就没什么优势了，必须老老实实的去前端页面上定位元素，写复杂的css定位。</p> \n<p>然而，就算我自定义了定位，有时候元素也不是唯一的。例如</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/cf83802b-a6fa-48b5-90b2-453da9843c1d.png\" alt=\"\" loading=\"lazy\"></p> \n<p>对于上面的列表，通过<code>自定义定位</code>得到的是一组元素。然而，如果只是一组元素的问题就就没必要单独拿出来说了，正如上图，列表中看到的是 4 个元素，通过定位方式得到的是8个元素，前4个是隐藏的，这和使用的 element-UI 库有关，因为数据是YAPI随机生成的，不能写死对第5个显示元素进行操作。 cypress 提供的 <code>force</code> 非常有用，他会强制对隐藏的元素进行操作。</p> \n<pre><code class=\"language-js\">cy.get(\'[cy-data=edit-project]\', { timeout: 3000 }).first().click({ force: true })\n</code></pre> \n<h2 id=\"如何看待cypress\">如何看待cypress</h2> \n<p><strong>前端开发视角</strong></p> \n<p>作为一名前端开发，客观的说，使用cypress的过程并没有遇到太多阻力。我来总结一下。</p> \n<ol> \n <li>因为使用了yapi，不需要考虑测试数据的准备。</li> \n <li>不需要写依赖步骤，主要是目前的业务功能也没有太长的操作过程。</li> \n <li>大部分情况下可以自定义元素属性，在定位上不需要花费过多的时间，也不需要写太长的定位。</li> \n <li>测试运行速度可以接受，28条用例运行耗时80秒左右。</li> \n</ol> \n<p><strong>测试视角</strong></p> \n<p>作为一名自动化测试，如果让我使用cypress。</p> \n<ol> \n <li>为了验证数据的正确性，我不能要求开发使用 yapi 假数据，所以，还是要自己准备数据。</li> \n <li>根据业务的情况，必须要的前置/后置动作不可避免。</li> \n <li>虽然，说服开发统一自定义元素有点难，对来我说并不是不可办到！</li> \n <li>cypress 做UI自动化确实比selenium要快一些，但是他相比selenium，不支持更多的浏览器，不支持Grid远程调用，甚至不能根据自己的熟练度选择语言。所以，cypress 优势并没有压倒性优势，具体还是要看需求。</li> \n</ol> \n<h2 id=\"cypress是否为最佳工具\">cypress是否为最佳工具</h2> \n<p>cypress是否为所有UI自动化的最佳工具？</p> \n<p>在面向前端的开发框架<code>Vue/React</code>中 确实很好的整合cypress，使我们的使用更加方便。</p> \n<p>在我接触到的偏后端的django Web框架中就很好的整合了Selenium，同样可以达到类似的效果。 我之前看过一本《Test-Driven Development with Python》 ，书中就很好的将基于Selenium的UI测试与Django开发很好的结合起来了。</p> \n<p>所以，结论是结合你的开发框架去选择合适的 E2E 测试工具。</p> \n<h2 id=\"测试怎么办？\">测试怎么办？</h2> \n<p>一直以来，我们都天然的认为UI自动化测试就应该是测试来做的，并以能做UI自动化测试为高级目标！但从我上面的实践中，我们会发现其实开发来做UI自动化优势很明显。那么测试怎么办？我们只能老老实实的回去测功能了吗？当然不是。</p> \n<ol> \n <li> <p>并不是每个开发都懂得编写UI自动化测试，虽然，这对他们来并不是特别难，我们完全在这方面成为“教练”，教开发如何编写UI自动化测试，如何设计更全面的测试用例。</p> </li> \n <li> <p>并不是每个团队的开发都有时间编写UI自动化测试，也可能是他们不愿意写，那么我们为何不加入他们？以我前面介绍的方式，深度地参与到项目的自动化测试编写中。而不是现在这样，将项目开发和自动化测试完全割裂开分别进行。</p> </li> \n</ol> \n<p>春节期间重读了《google测试之道》，有了新的感受，在测试开发能力足够的前提下，当团队的目标是提高产品的保证质量时，自动化测试到底由谁来做的问题变得不那么重要了。</p>', NULL, '2021-03-27 00:18:21', 0, NULL, NULL, 'https://www.cnblogs.com/fnng/p/14583259.html', 0, NULL);
INSERT INTO `t_blog` VALUES (289, '【java框架】SpringBoot(4)--SpringBoot实现异步、邮件、定时任务', '<h2>1.SpringBoot整合任务机制</h2> \n<h3>1.1.SpringBoot实现异步方法</h3> \n<p>日常开发中涉及很多界面与后端的交互响应，都不是同步的，基于SpringBoot为我们提供了注解方式实现异步方法。使得前端的请求响应与后端的业务逻辑方法实现异步执行。提升了客户的体验。不由得说一句，SpringBoot的封装的确是精妙强大，以前需要多线程、Ajax实现异步，而SpringBoot底层封装之后，两个注解就Over了！</p> \n<p>①需要在SpringApplication执行类上开启异步，使用@EnableAsync：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\">@SpringBootApplication\n<span style=\"color: rgba(255, 0, 0, 1)\">@EnableAsync  </span></span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">开启异步</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> SpringtestApplication {\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> main(String[] args) {\n        SpringApplication.run(SpringtestApplication.</span><span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\">, args);\n    }\n\n}</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>②同时在执行调用耗时的方法上加上@Async表示该方法是异步方法：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\">@Service\n</span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> AsyncService {\n    @Async\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> execute(){\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">try</span><span style=\"color: rgba(0, 0, 0, 1)\"> {\n            Thread.sleep(</span>3000);  <span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">执行系统耗时任务</span>\n        } <span style=\"color: rgba(0, 0, 255, 1)\">catch</span><span style=\"color: rgba(0, 0, 0, 1)\"> (InterruptedException e) {\n            e.printStackTrace();\n        }\n        System.out.println(</span>\"任务执行成功!\"<span style=\"color: rgba(0, 0, 0, 1)\">);\n    }\n}</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>③那么执行Controller层的调用异步方法时就会异步去执行方法，得到响应“success”返回而同时异步执行后台耗时方法：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\">@RestController\n</span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> AsyncController {\n    @Autowired\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span><span style=\"color: rgba(0, 0, 0, 1)\"> AsyncService service;\n\n    @RequestMapping(</span>\"/execute\"<span style=\"color: rgba(0, 0, 0, 1)\">)\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span><span style=\"color: rgba(0, 0, 0, 1)\"> String executeTask(){\n        service.execute();  </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">异步执行3s</span>\n        <span style=\"color: rgba(0, 0, 255, 1)\">return</span> \"success\";   <span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">异步返回结果</span>\n<span style=\"color: rgba(0, 0, 0, 1)\">    }\n}</span></pre> \n</div> \n<p>&nbsp;</p> \n<h3>1.2.SpringBoot实现邮件发送</h3> \n<p>Spring Boot中发送邮件具体的使用步骤如下</p> \n<p>1、添加Starter模块依赖</p> \n<p>2、添加Spring Boot配置(QQ/网易系/Gmail)</p> \n<p>3、调用JavaMailSender接口发送邮件</p> \n<p>&nbsp;</p> \n<p>①在pom.xml中添加邮件发送starter依赖：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 128, 0, 1)\">&lt;!--</span><span style=\"color: rgba(0, 128, 0, 1)\">邮件发送</span><span style=\"color: rgba(0, 128, 0, 1)\">--&gt;</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">&lt;</span><span style=\"color: rgba(128, 0, 0, 1)\">dependency</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>\n    <span style=\"color: rgba(0, 0, 255, 1)\">&lt;</span><span style=\"color: rgba(128, 0, 0, 1)\">groupId</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>org.springframework.boot<span style=\"color: rgba(0, 0, 255, 1)\">&lt;/</span><span style=\"color: rgba(128, 0, 0, 1)\">groupId</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>\n    <span style=\"color: rgba(0, 0, 255, 1)\">&lt;</span><span style=\"color: rgba(128, 0, 0, 1)\">artifactId</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>spring-boot-starter-mail<span style=\"color: rgba(0, 0, 255, 1)\">&lt;/</span><span style=\"color: rgba(128, 0, 0, 1)\">artifactId</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">&lt;/</span><span style=\"color: rgba(128, 0, 0, 1)\">dependency</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>②对应QQ邮箱发送，去QQ邮箱客户端开启POP3/SMTP服务，获取授权码：</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/1a909b31-b6d9-4752-9c1c-866dc776886d.png\" alt=\"\" width=\"878\" height=\"296\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>③添加配置参数，在application.yml中配置邮箱发送方式：</p> \n<p>QQ邮箱：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\"># QQ邮箱配置\nspring:\n  mail:\n    host: smtp.qq.com #发送邮件服务器\n    username: 241667****@qq.com #发送邮件的邮箱地址\n    password: ************ #客户端授权码，不是邮箱密码，这个在qq邮箱设置里面自动生成的\n    properties.mail.smtp.port: 465 #端口号465或587\n    from: 241667****@qq.com # 发送邮件的地址，和上面username一致\n    protocol: smtps  #如果使用端口为465，将protocol的smtp改为smtps；配置文件端口为587，则可以使用smtp。\n  #开启加密验证\n  properties.mail.smtp.ssl.enable: true</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>网易邮箱：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\">##网易系(126/163/yeah)邮箱配置\nspring:\n  mail:\n    host: smtp.163.com #发送邮件服务器\n    username: hyfmail****@163.com #发送邮件的邮箱地址\n    password: ************ #客户端授权码，不是邮箱密码,网易的是自己设置的\n    properties.mail.smtp.port: 465 #465或者994\n    from: hyfmail****@163.com # 发送邮件的地址，和上面username一致\n    properties.mail.smtp.ssl.enable: true\n    default-encoding: utf-8</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>④编写邮件发送接口，实现类：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">interface</span><span style=\"color: rgba(0, 0, 0, 1)\"> IMailService {\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">/**</span><span style=\"color: rgba(0, 128, 0, 1)\">\n     * 发送文本邮件\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> to 收件人\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> subject 主题\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> content 内容\n     </span><span style=\"color: rgba(0, 128, 0, 1)\">*/</span>\n    <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> sendSimpleMail(String to, String subject, String content);\n\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">/**</span><span style=\"color: rgba(0, 128, 0, 1)\">\n     * 发送HTML邮件\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> to 收件人\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> subject 主题\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> content 内容\n     </span><span style=\"color: rgba(0, 128, 0, 1)\">*/</span>\n    <span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> sendHtmlMail(String to, String subject, String content);\n\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">/**</span><span style=\"color: rgba(0, 128, 0, 1)\">\n     * 发送带附件的邮件\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> to 收件人\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> subject 主题\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> content 内容\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> filePath 附件\n     </span><span style=\"color: rgba(0, 128, 0, 1)\">*/</span>\n    <span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> sendAttachmentsMail(String to, String subject, String content, String filePath);\n}</span></pre> \n</div> \n<p>&nbsp;</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\">@Service\n</span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span> MailServiceImpl <span style=\"color: rgba(0, 0, 255, 1)\">implements</span><span style=\"color: rgba(0, 0, 0, 1)\"> IMailService {\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span> <span style=\"color: rgba(0, 0, 255, 1)\">final</span> Logger logger = LoggerFactory.getLogger(<span style=\"color: rgba(0, 0, 255, 1)\">this</span><span style=\"color: rgba(0, 0, 0, 1)\">.getClass());\n\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">/**</span><span style=\"color: rgba(0, 128, 0, 1)\">\n     * Spring Boot 提供了一个发送邮件的简单抽象，使用的是下面这个接口，这里直接注入即可使用\n     </span><span style=\"color: rgba(0, 128, 0, 1)\">*/</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    @Autowired\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span><span style=\"color: rgba(0, 0, 0, 1)\"> JavaMailSenderImpl mailSender;\n\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">/**</span><span style=\"color: rgba(0, 128, 0, 1)\">\n     * 配置文件中我的qq邮箱\n     </span><span style=\"color: rgba(0, 128, 0, 1)\">*/</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    @Value(</span>\"${spring.mail.from}\"<span style=\"color: rgba(0, 0, 0, 1)\">)\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span><span style=\"color: rgba(0, 0, 0, 1)\"> String from;\n\n    @Override\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> sendSimpleMail(String to, String subject, String content) {\n        </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">创建SimpleMailMessage对象</span>\n        SimpleMailMessage message = <span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> SimpleMailMessage();\n        </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">邮件发送人</span>\n<span style=\"color: rgba(0, 0, 0, 1)\">        message.setFrom(from);\n        </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">邮件接收人</span>\n<span style=\"color: rgba(0, 0, 0, 1)\">        message.setTo(to);\n        </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">邮件主题</span>\n<span style=\"color: rgba(0, 0, 0, 1)\">        message.setSubject(subject);\n        </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">邮件内容</span>\n<span style=\"color: rgba(0, 0, 0, 1)\">        message.setText(content);\n        </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">发送邮件</span>\n<span style=\"color: rgba(0, 0, 0, 1)\">        mailSender.send(message);\n    }\n\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">/**</span><span style=\"color: rgba(0, 128, 0, 1)\">\n     * html邮件\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> to 收件人\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> subject 主题\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> content 内容\n     </span><span style=\"color: rgba(0, 128, 0, 1)\">*/</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    @Override\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> sendHtmlMail(String to, String subject, String content) {\n        </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">获取MimeMessage对象</span>\n        MimeMessage message =<span style=\"color: rgba(0, 0, 0, 1)\"> mailSender.createMimeMessage();\n        MimeMessageHelper messageHelper;\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">try</span><span style=\"color: rgba(0, 0, 0, 1)\"> {\n            messageHelper </span>= <span style=\"color: rgba(0, 0, 255, 1)\">new</span> MimeMessageHelper(message, <span style=\"color: rgba(0, 0, 255, 1)\">true</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n            </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">邮件发送人</span>\n<span style=\"color: rgba(0, 0, 0, 1)\">            messageHelper.setFrom(from);\n            </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">邮件接收人</span>\n<span style=\"color: rgba(0, 0, 0, 1)\">            messageHelper.setTo(to);\n            </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">邮件主题</span>\n<span style=\"color: rgba(0, 0, 0, 1)\">            message.setSubject(subject);\n            </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">邮件内容，html格式</span>\n            messageHelper.setText(content, <span style=\"color: rgba(0, 0, 255, 1)\">true</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n            </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">发送</span>\n<span style=\"color: rgba(0, 0, 0, 1)\">            mailSender.send(message);\n            </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">日志信息</span>\n            logger.info(\"邮件已经发送。\"<span style=\"color: rgba(0, 0, 0, 1)\">);\n        } </span><span style=\"color: rgba(0, 0, 255, 1)\">catch</span><span style=\"color: rgba(0, 0, 0, 1)\"> (MessagingException e) {\n            logger.error(</span>\"发送邮件时发生异常！\"<span style=\"color: rgba(0, 0, 0, 1)\">, e);\n        }\n    }\n\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">/**</span><span style=\"color: rgba(0, 128, 0, 1)\">\n     * 带附件的邮件\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> to 收件人\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> subject 主题\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> content 内容\n     * </span><span style=\"color: rgba(128, 128, 128, 1)\">@param</span><span style=\"color: rgba(0, 128, 0, 1)\"> filePath 附件\n     </span><span style=\"color: rgba(0, 128, 0, 1)\">*/</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    @Override\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> sendAttachmentsMail(String to, String subject, String content, String filePath) {\n        MimeMessage message </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> mailSender.createMimeMessage();\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">try</span><span style=\"color: rgba(0, 0, 0, 1)\"> {\n            MimeMessageHelper helper </span>= <span style=\"color: rgba(0, 0, 255, 1)\">new</span> MimeMessageHelper(message, <span style=\"color: rgba(0, 0, 255, 1)\">true</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n            helper.setFrom(from);\n            helper.setTo(to);\n            helper.setSubject(subject);\n            helper.setText(content, </span><span style=\"color: rgba(0, 0, 255, 1)\">true</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n\n            FileSystemResource file </span>= <span style=\"color: rgba(0, 0, 255, 1)\">new</span> FileSystemResource(<span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> File(filePath));\n            String fileName </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> filePath.substring(filePath.lastIndexOf(File.separator));\n            helper.addAttachment(fileName, file);\n            mailSender.send(message);\n            </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">日志信息</span>\n            logger.info(\"邮件已经发送。\"<span style=\"color: rgba(0, 0, 0, 1)\">);\n        } </span><span style=\"color: rgba(0, 0, 255, 1)\">catch</span><span style=\"color: rgba(0, 0, 0, 1)\"> (MessagingException e) {\n            logger.error(</span>\"发送邮件时发生异常！\"<span style=\"color: rgba(0, 0, 0, 1)\">, e);\n        }\n    }\n}</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>⑤编写测试类：</p> \n<div class=\"cnblogs_code\"> \n <pre>@SpringBootTest(classes = {SendmailApplication.<span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\">})\n@RunWith(SpringRunner.</span><span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\">)\n</span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> MailAppTest {\n\n    @Autowired\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span><span style=\"color: rgba(0, 0, 0, 1)\"> IMailService mailService;\n\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">/**</span><span style=\"color: rgba(0, 128, 0, 1)\">\n     * 测试发送文本邮件\n     </span><span style=\"color: rgba(0, 128, 0, 1)\">*/</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    @Test\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> testSendMail() {\n        mailService.sendSimpleMail(</span>\"hyfmailsave@163.com\",\"主题：你好普通邮件\",\"内容：第一封邮件\"<span style=\"color: rgba(0, 0, 0, 1)\">);\n    }\n\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">/**</span><span style=\"color: rgba(0, 128, 0, 1)\">\n     * 测试发送Html邮件\n     </span><span style=\"color: rgba(0, 128, 0, 1)\">*/</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    @Test\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> sendHtmlMail(){\n        mailService.sendHtmlMail(</span>\"hyfmailsave@163.com\",\"主题：你好html邮件\",\"&lt;h1&gt;内容：第一封html邮件&lt;/h1&gt;\"<span style=\"color: rgba(0, 0, 0, 1)\">);\n    }\n\n    @Test\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> sendMimeContentMail(){\n        mailService.sendAttachmentsMail(</span>\"hyfmailsave@163.com\", \"主题：你好复杂带附件邮件\"<span style=\"color: rgba(0, 0, 0, 1)\">,\n                </span>\"&lt;p style=\'color:red\'&gt;谢谢你的html邮件及问候~&lt;/p&gt;\", \"E:\\\\Workspaces\\\\SpringBoot_Study\\\\springboot_test\\\\src\\\\main\\\\resources\\\\static\\\\1.jpg\"<span style=\"color: rgba(0, 0, 0, 1)\">);\n    }\n}</span></pre> \n</div> \n<p>&nbsp;</p> \n<h3>1.3.定时任务</h3> \n<p>SpringBoot中执行定时任务主要用到有两个重要接口与两个任务调度的注解：</p> \n<ul> \n <li>TaskScheduler&nbsp; &nbsp; 任务调度者</li> \n <li>TaskExecutor&nbsp; &nbsp; 任务执行者</li> \n <li>@EnableScheduling&nbsp; &nbsp; 开启定时功能的注解</li> \n <li>@Scheduled&nbsp; &nbsp; 用于在需要定时执行的方法上，表示在某一时刻定时执行</li> \n</ul> \n<p>&nbsp;</p> \n<p>对应注解使用如下：</p> \n<p>启动类：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\">@SpringBootApplication\n@EnableAsync  </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">开启异步</span>\n<span style=\"color: rgba(255, 0, 0, 1)\">@EnableScheduling</span>  <span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">开启定时功能的注解</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> SpringtestApplication {\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> main(String[] args) {\n        SpringApplication.run(SpringtestApplication.</span><span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\">, args);\n    }\n\n}</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>启动方法：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\">@Service\n</span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">class</span><span style=\"color: rgba(0, 0, 0, 1)\"> ScheduleService {\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">定时执行注解@Scheduled，需要使用cron表达式进行定时任务执行\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">表示每天下午13:43触发</span>\n    <span style=\"color: rgba(255, 0, 0, 1)\">@Scheduled(cron = \"0 43 13 ? * *\")\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> timeExecute(){\n        System.out.println(</span>\"该任务被触发执行了~~~\"<span style=\"color: rgba(0, 0, 0, 1)\">);\n    }\n}</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>启动SpringBoot项目，SpringBoot则会开启定时任务执行并扫描方法上需要定时执行的注解，去定时执行相关的任务。</p> \n<p>&nbsp;</p> \n<p>常用cron表达式如下：</p> \n<div class=\"cnblogs_code\"> \n <pre><span style=\"color: rgba(0, 0, 0, 1)\">0 0 2 1 * ? 表示在每月的1日的凌晨2点调整任务\n\n0 15 10 ? * MON-FRI 表示周一到周五每天上午10:15执行作业\n\n0 15 10 ? 6L 2002-2006 表示2002-2006年的每个月的最后一个星期五上午10:15执行作\n\n0 0 10,14,16 * * ? 每天上午10点，下午2点，4点\n\n0 0/30 9-17 * * ? 朝九晚五工作时间内每半小时\n\n0 0 12 ? * WED 表示每个星期三中午12点\n\n0 0 12 * * ? 每天中午12点触发\n\n0 15 10 ? * * 每天上午10:15触发\n\n0 15 10 * * ? 每天上午10:15触发\n\n0 15 10 * * ? 每天上午10:15触发\n\n0 15 10 * * ? 2005 2005年的每天上午10:15触发\n\n0 * 14 * * ? 在每天下午2点到下午2:59期间的每1分钟触发\n\n0 0/5 14 * * ? 在每天下午2点到下午2:55期间的每5分钟触发\n\n0 0/5 14,18 * * ? 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发\n\n0 0-5 14 * * ? 在每天下午2点到下午2:05期间的每1分钟触发\n\n0 10,44 14 ? 3 WED 每年三月的星期三的下午2:10和2:44触发\n\n0 15 10 ? * MON-FRI 周一至周五的上午10:15触发\n\n0 15 10 15 * ? 每月15日上午10:15触发\n\n0 15 10 L * ? 每月最后一日的上午10:15触发\n\n0 15 10 ? * 6L 每月的最后一个星期五上午10:15触发\n\n0 15 10 ? * 6L 2002-2005 2002年至2005年的每月的最后一个星期五上午10:15触发\n\n0 15 10 ? * 6#3 每月的第三个星期五上午10:15触发</span></pre> \n</div> \n<p>&nbsp;</p> \n<p>更多cron表达式请参阅：</p> \n<p>https://www.jianshu.com/p/b4b8950fb987&nbsp; &nbsp; 《简书--cron表达式》</p> \n<p>https://www.matools.com/cron&nbsp; 《crom在线表达式生成器》</p> \n<p>&nbsp;</p> \n<p>本博客写作参考文档相关：</p> \n<p>https://www.jianshu.com/p/a7097a21b42d</p> \n<p>https://blog.csdn.net/SixthMagnitude/article/details/114173570</p> \n<p>https://www.bilibili.com/video/BV1PE411i7CV?p=52</p> \n<p>https://www.jianshu.com/p/b4b8950fb987&nbsp; &nbsp; 《简书--cron表达式》</p> \n<p>https://www.matools.com/cron&nbsp; 《crom在线表达式生成器》</p> \n<p>&nbsp;</p> \n<p>示例代码已上传至Github地址：</p> \n<p>https://github.com/devyf/SpringBoot_Study/tree/master/helloword_create</p>', NULL, '2021-03-27 00:18:22', 0, NULL, NULL, 'https://www.cnblogs.com/yif0118/p/14560486.html', 0, NULL);
INSERT INTO `t_blog` VALUES (290, '（四）SpringBoot启动过程的分析-预处理ApplicationContext', '<p>-- 以下内容均基于2.1.8.RELEASE版本</p> \n<p>紧接着上一篇<a href=\"https://www.cnblogs.com/lukama/p/14525282.html\" target=\"_blank\">（三）SpringBoot启动过程的分析-创建应用程序上下文</a>，本文将分析上下文创建完毕之后的下一步操作：预处理上下文容器。</p> \n<h2 id=\"预处理上下文容器\">预处理上下文容器</h2> \n<p>预处理上下文容器由prepareContext()方法完成，本篇内容全部都是基于这个方法所涉及的内容进行分析。</p> \n<pre><code>// SpringApplication.java\n\nprivate void prepareContext(ConfigurableApplicationContext context, ConfigurableEnvironment environment, SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments, Banner printedBanner) {\n\n	// 设置环境对象，传入的对象是解析完毕profiles的对象，Context内部则是不完整的对象\n	context.setEnvironment(environment);\n	// 设置上下文参数\n	postProcessApplicationContext(context);\n	// 加载ApplicationContextInitializers\n	applyInitializers(context);\n	// 触发开始准备上下文事件\n	listeners.contextPrepared(context);\n	if (this.logStartupInfo) {\n		logStartupInfo(context.getParent() == null);\n		logStartupProfileInfo(context);\n	}\n	// 将启动参数包装为名为springApplicationArguments的DefaultApplicationArguments对象，并以单例模式注册\n	ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();\n	beanFactory.registerSingleton(\"springApplicationArguments\", applicationArguments);\n	\n	// 设置打印的Banner\n	if (printedBanner != null) {\n		beanFactory.registerSingleton(\"springBootBanner\", printedBanner);\n	}\n	\n	// 设置是否允许覆盖BeanDefinition\n	if (beanFactory instanceof DefaultListableBeanFactory) {\n		((DefaultListableBeanFactory) beanFactory).setAllowBeanDefinitionOverriding(this.allowBeanDefinitionOverriding);\n	}\n	\n	// 加载资源\n	Set&lt;Object&gt; sources = getAllSources();\n	Assert.notEmpty(sources, \"Sources must not be empty\");\n	load(context, sources.toArray(new Object[0]));\n	\n	// 触发上下文加载完毕事件\n	listeners.contextLoaded(context);\n}\n</code></pre> \n<h3 id=\"设置上下文参数\">设置上下文参数</h3> \n<pre><code>// SpringApplication.java\n\nprotected void postProcessApplicationContext(ConfigurableApplicationContext context) {\n\n	// 以单例模式注册beanNameGenerator\n	if (this.beanNameGenerator != null) {\n		context.getBeanFactory().registerSingleton(AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR, this.beanNameGenerator);\n	}\n	\n	// 为上下文设置资源加载器和类加载器\n	if (this.resourceLoader != null) {\n		if (context instanceof GenericApplicationContext) {\n			((GenericApplicationContext) context).setResourceLoader(this.resourceLoader);\n		}\n		if (context instanceof DefaultResourceLoader) {\n			((DefaultResourceLoader) context).setClassLoader(this.resourceLoader.getClassLoader());\n		}\n	}\n	\n	// 为上下文设置转换服务\n	if (this.addConversionService) {\n		context.getBeanFactory().setConversionService(ApplicationConversionService.getSharedInstance());\n	}\n}\n</code></pre> \n<p>将前面步骤初始化的属性赋值给上下文容器，代码中的this代表的是SpringApplication。</p> \n<h3 id=\"加载applicationcontextinitializers\">加载ApplicationContextInitializers</h3> \n<p>在SpringApplication.run()的一开始它就通过SPI获取到所有的ApplicationContextInitializers，在这里他们将被执行。</p> \n<pre><code>protected void applyInitializers(ConfigurableApplicationContext context) {\n	// 调用每一个实现类的initialize方法\n	for (ApplicationContextInitializer initializer : getInitializers()) {\n		Class&lt;?&gt; requiredType = GenericTypeResolver.resolveTypeArgument(initializer.getClass(), ApplicationContextInitializer.class);\n		Assert.isInstanceOf(requiredType, context, \"Unable to call initializer.\");\n		initializer.initialize(context);\n	}\n}\n\n// 将之前获取到的集合进行排序并返回只读集合\npublic Set&lt;ApplicationContextInitializer&lt;?&gt;&gt; getInitializers() {\n	return asUnmodifiableOrderedSet(this.initializers);\n}\n</code></pre> \n<h4 id=\"delegatingapplicationcontextinitializer\">DelegatingApplicationContextInitializer</h4> \n<p>用于初始化配置文件（属性名：context.initializer.classes）中指定的ApplicationContextInitializer实现类</p> \n<pre><code>public void initialize(ConfigurableApplicationContext context) {\n	// 获取环境对象\n	ConfigurableEnvironment environment = context.getEnvironment();\n	// 获取context.initializer.classes属性指定的实现类\n	List&lt;Class&lt;?&gt;&gt; initializerClasses = getInitializerClasses(environment);\n	if (!initializerClasses.isEmpty()) {\n		// 调用其initialize()方法\n		applyInitializerClasses(context, initializerClasses);\n	}\n}\n\nprivate List&lt;Class&lt;?&gt;&gt; getInitializerClasses(ConfigurableEnvironment env) {\n	// 通过指定属性去获取，此处常量属性值为context.initializer.classes\n	String classNames = env.getProperty(PROPERTY_NAME);\n	List&lt;Class&lt;?&gt;&gt; classes = new ArrayList&lt;&gt;();\n	if (StringUtils.hasLength(classNames)) {\n		// 根据代码可以推断出，context.initializer.classes的值可以用逗号拼接\n		for (String className : StringUtils.tokenizeToStringArray(classNames, \",\")) {\n			classes.add(getInitializerClass(className));\n		}\n	}\n	return classes;\n}\n</code></pre> \n<p>这里看起来好像很奇怪，本身当前的类就是一个ApplicationContextInitializer, 它已经被上游代码调用了initializer()方法，在initializer()方法中它又去获取ApplicationContextInitializer，然后接着调用initializer()，好像很绕。不过它的类描述已经说明了问题，它用于加载从配置文件指定<br> 的那些ApplicationContextInitializer。如果阅读过第一篇概览<a href=\"https://www.cnblogs.com/lukama/p/14395340.html#_caption_h3_0\" target=\"_blank\">SpringApplication.java #构造方法</a>的话就会明白，当前对象就是在SpringApplication类的构造方法中通过SPI方式获取到的，而当前方法则是通过配置文件指定的方式<br> 来获取。由此就可以得出一个结论：在SpringBoot中实现ApplicationContextInitializer并确保其被加载有三种方法，一是通过SpringApplication公开的addInitializers()方法直接添加，二是以SPI方式配置，三是以配置文件方式配置。</p> \n<p>在SpringBoot中三种配置ApplicationContextInitializer的方法：</p> \n<blockquote> \n <ol> \n  <li>直接以代码方式添加<br> new SpringApplication(Example.class).addInitializers(new 实现类());</li> \n </ol> \n</blockquote> \n<blockquote> \n <ol start=\"2\"> \n  <li>以SPI方式<br> 在/META-INF/spring.factories文件中配置org.springframework.context.ApplicationContextInitializer=实现类A, 实现类B</li> \n </ol> \n</blockquote> \n<blockquote> \n <ol start=\"3\"> \n  <li>以配置文件方式（语法取决于你使用什么样的配置文件properties or xml or yml or yaml or 配置中心）<br> context.initializer.classes = 实现类A, 实现类B</li> \n </ol> \n</blockquote> \n<h4 id=\"sharedmetadatareaderfactorycontextinitializer\">SharedMetadataReaderFactoryContextInitializer</h4> \n<p>在ConfigurationClassPostProcessor和Spring Boot之间创建共享的CachingMetadataReaderFactory, 干啥的我也不知道，后续debug在研究。</p> \n<h4 id=\"contextidapplicationcontextinitializer\">ContextIdApplicationContextInitializer</h4> \n<p>用于设置SpringApplication.getId()的值，如果配置文件中指定了spring.application.name，则本类不起作用，反之。</p> \n<h4 id=\"configurationwarningsapplicationcontextinitializer\">ConfigurationWarningsApplicationContextInitializer</h4> \n<p>添加BeanFactoryPostProcessor：ConfigurationWarningsPostProcessor用于打印配置错误的日志</p> \n<h4 id=\"serverportinfoapplicationcontextinitializer\">ServerPortInfoApplicationContextInitializer</h4> \n<p>用于设置server.ports属性的值，它是Web服务器实际监听的应用程序端口。同时实现了ApplicationListener接口用于监听WebServerInitializedEvent事件，WebServer初始化完毕之后设置端口。</p> \n<pre><code>// ServerPortInfoApplicationContextInitializer.java\n\n// ①\npublic void initialize(ConfigurableApplicationContext applicationContext) {\n	applicationContext.addApplicationListener(this);\n}\n\n// ②\npublic void onApplicationEvent(WebServerInitializedEvent event) {\n	String propertyName = \"local.\" + getName(event.getApplicationContext()) + \".port\";\n	setPortProperty(event.getApplicationContext(), propertyName, event.getWebServer().getPort());\n}\n\n// ③\nprivate String getName(WebServerApplicationContext context) {\n	String name = context.getServerNamespace();\n	return StringUtils.hasText(name) ? name : \"server\";\n}\n\n// ④\nprivate void setPortProperty(ApplicationContext context, String propertyName, int port) {\n	if (context instanceof ConfigurableApplicationContext) {\n		setPortProperty(((ConfigurableApplicationContext) context).getEnvironment(), propertyName, port);\n	}\n	if (context.getParent() != null) {\n		setPortProperty(context.getParent(), propertyName, port);\n	}\n}\n\n@SuppressWarnings(\"unchecked\")\nprivate void setPortProperty(ConfigurableEnvironment environment, String propertyName, int port) {\n	MutablePropertySources sources = environment.getPropertySources();\n	PropertySource&lt;?&gt; source = sources.get(\"server.ports\");\n	if (source == null) {\n		source = new MapPropertySource(\"server.ports\", new HashMap&lt;&gt;());\n		sources.addFirst(source);\n	}\n	((Map&lt;String, Object&gt;) source.getSource()).put(propertyName, port);\n}\n</code></pre> \n<p>① - 向上下文监听器列表中添加当前类（作为监听器加入）<br> ② - 在监听事件中设置端口，默认属性为local.server.port<br> ③ - 若设置了服务器Namespace，则属性值为local.Namespace的值.port<br> ④ - 将监听端口信息填入server.ports属性下</p> \n<h4 id=\"conditionevaluationreportlogginglistener\">ConditionEvaluationReportLoggingListener</h4> \n<p>用于设置ConditionEvaluationReportListener监听器，此监听器监听ContextRefreshedEvent和ApplicationFailedEvent，分别打印出上下文容器成功刷新和失败的日志报告</p> \n<p>在这一章节中，可以看到ApplicationContextInitializer扩展接口的实际应用。通过Spring框架内置的一些initializer可以实现框架功能，同理我们也可以利用这一特性在上下文容器还未刷新之前做一些扩展功能。</p> \n<h3 id=\"发布applicationcontextinitializedevent事件\">发布ApplicationContextInitializedEvent事件</h3> \n<blockquote> \n <p>由SpringApplicationRunListeners.contextPrepared(ConfigurableApplicationContext context)方法触发。</p> \n</blockquote> \n<p>当上下文容器加载完毕所有的ApplicationContextInitializer之后，触发该事件，通知那些关注了此事件的监听器进行下一步操作。每次发布事件的时候可能已经有新的监听器被加进来，在上一章节中我们就看到会在ApplicationContextInitializer里面添加监听器<br> 但我们只需要关注那些监听了当前事件的监听器即可。这里仅仅作为一个提示，监听器可能在任何地方被加进来。这里并未发现有监听器监听此事件。</p> \n<h3 id=\"记录活动的profiles日志\">记录活动的Profiles日志</h3> \n<p>日志打印的：The following profiles are active: dev,test 这一句就来自于此。代码比较简单一看便知。</p> \n<pre><code>if (this.logStartupInfo) {\n	logStartupInfo(context.getParent() == null);\n	logStartupProfileInfo(context);\n}\n\nprotected void logStartupProfileInfo(ConfigurableApplicationContext context) {\n	Log log = getApplicationLog();\n	if (log.isInfoEnabled()) {\n		String[] activeProfiles = context.getEnvironment().getActiveProfiles();\n		if (ObjectUtils.isEmpty(activeProfiles)) {\n			String[] defaultProfiles = context.getEnvironment().getDefaultProfiles();\n			log.info(\"No active profile set, falling back to default profiles: \" + StringUtils.arrayToCommaDelimitedString(defaultProfiles));\n		}\n		else {\n			log.info(\"The following profiles are active: \"+ StringUtils.arrayToCommaDelimitedString(activeProfiles));\n		}\n	}\n}\n</code></pre> \n<h3 id=\"注册启动springapplication时的参数\">注册启动SpringApplication时的参数</h3> \n<p>将参数对象注册为单例模式</p> \n<pre><code>// SpringApplication.java\n\nConfigurableListableBeanFactory beanFactory = context.getBeanFactory();\nbeanFactory.registerSingleton(\"springApplicationArguments\", applicationArguments);\n</code></pre> \n<h3 id=\"是否允许覆盖bean定义\">是否允许覆盖Bean定义</h3> \n<p>这个是和spring.main.allow-bean-definition-overriding参数有关，默认情况下在DefaultListableBeanFactory中是true，但是SpringBoot在此处给设置成了false。</p> \n<pre><code>if (beanFactory instanceof DefaultListableBeanFactory) {\n	((DefaultListableBeanFactory) beanFactory).setAllowBeanDefinitionOverriding(this.allowBeanDefinitionOverriding);\n}\n</code></pre> \n<h3 id=\"加载bean到上下文中\">加载Bean到上下文中</h3> \n<p>加载需要两个必备条件：谁来加载Bean，从哪加载Bean;此处加载BeanDefinition是由BeanDefinitionLoader来完成。</p> \n<pre><code>// SpringApplication.java#prepareContext()\n\n// 获取当前应用要加载的资源\nSet&lt;Object&gt; sources = getAllSources();\nAssert.notEmpty(sources, \"Sources must not be empty\");\n// 加载Bean\nload(context, sources.toArray(new Object[0]));\n\n// 创建Bean加载器，并加载\nprotected void load(ApplicationContext context, Object[] sources) {\n	if (logger.isDebugEnabled()) {\n		logger.debug(\"Loading source \" + StringUtils.arrayToCommaDelimitedString(sources));\n	}\n	// 创建BeanDefinitionLoader\n	BeanDefinitionLoader loader = createBeanDefinitionLoader(getBeanDefinitionRegistry(context), sources);\n	if (this.beanNameGenerator != null) {\n		loader.setBeanNameGenerator(this.beanNameGenerator);\n	}\n	if (this.resourceLoader != null) {\n		loader.setResourceLoader(this.resourceLoader);\n	}\n	if (this.environment != null) {\n		loader.setEnvironment(this.environment);\n	}\n	loader.load();\n}\n\n\n\n</code></pre> \n<h4 id=\"初始化beandefinitionloader\">初始化BeanDefinitionLoader</h4> \n<p>用于创建BeanDefinitionLoader，并从source加载类，它是对加载Bean的整体功能做了封装，内部由不同的资源加载类来完成不同类型的资源加载，例如从基于注解的类来开始加载，从xml文件开始加载</p> \n<pre><code>// SpringApplication.java\n\nprotected BeanDefinitionLoader createBeanDefinitionLoader(BeanDefinitionRegistry registry, Object[] sources) {\n	return new BeanDefinitionLoader(registry, sources);\n}\n\nclass BeanDefinitionLoader {\n	\n	// 类的来源\n	private final Object[] sources;\n\n	// JavaConfig类读取器\n	private final AnnotatedBeanDefinitionReader annotatedReader;\n\n	// xml文件类读取器\n	private final XmlBeanDefinitionReader xmlReader;\n\n	// groovy类读取器\n	private BeanDefinitionReader groovyReader;\n\n	// classpath类读取器\n	private final ClassPathBeanDefinitionScanner scanner;\n\n	// 资源加载器\n	private ResourceLoader resourceLoader;\n\n	BeanDefinitionLoader(BeanDefinitionRegistry registry, Object... sources) {\n		Assert.notNull(registry, \"Registry must not be null\");\n		Assert.notEmpty(sources, \"Sources must not be empty\");\n		this.sources = sources;\n		this.annotatedReader = new AnnotatedBeanDefinitionReader(registry);\n		this.xmlReader = new XmlBeanDefinitionReader(registry);\n		if (isGroovyPresent()) {\n			this.groovyReader = new GroovyBeanDefinitionReader(registry);\n		}\n		this.scanner = new ClassPathBeanDefinitionScanner(registry);\n		this.scanner.addExcludeFilter(new ClassExcludeFilter(sources));\n	}\n	// ...省略部分代码\n}\n</code></pre> \n<p>通过观察它的内部属性和构造方法可以看出，它支持加载基于编程方式配置的类，支持xml文件配置的类，支持groovy和xml混合定义的类的加载。它使用门面模式封装了这些具体的加载器。此处只需要先知道BeanDefinitionLoader用于加载Bean，且它内部封装了多个类读取器即可<br> 不必深入。先了解大体的功能性即可。后续会开单独篇章介绍。</p> \n<h4 id=\"使用beandefinitionloader加载bean\">使用BeanDefinitionLoader加载Bean</h4> \n<pre><code>// BeanDefinitionLoader.java\n\n// ①\npublic int load() {\n	int count = 0;\n	for (Object source : this.sources) {\n		count += load(source);\n	}\n	return count;\n}\n\n// ②\nprivate int load(Object source) {\n	Assert.notNull(source, \"Source must not be null\");\n	if (source instanceof Class&lt;?&gt;) {\n		return load((Class&lt;?&gt;) source);\n	}\n	if (source instanceof Resource) {\n		return load((Resource) source);\n	}\n	if (source instanceof Package) {\n		return load((Package) source);\n	}\n	if (source instanceof CharSequence) {\n		return load((CharSequence) source);\n	}\n	throw new IllegalArgumentException(\"Invalid source type \" + source.getClass());\n}\n</code></pre> \n<p>① - 记录加载的资源数量<br> ② - 根据传入的资源类型选择不同的加载方式</p> \n<p>此处我们选择SpringBoot典型的资源加载方式Class方式来分析，在应用程序启动入口我们使用的是SpringApplication.run(Example.class, args);而Example.class是我们的main函数所在类，以它作为资源来加载。</p> \n<pre><code>// BeanDefinitionLoader.java\n\nprivate int load(Class&lt;?&gt; source) {\n	// ①\n	if (isGroovyPresent() &amp;&amp; GroovyBeanDefinitionSource.class.isAssignableFrom(source)) {\n		// Any GroovyLoaders added in beans{} DSL can contribute beans here\n		GroovyBeanDefinitionSource loader = BeanUtils.instantiateClass(source, GroovyBeanDefinitionSource.class);\n		load(loader);\n	}\n	// ②\n	if (isComponent(source)) {\n		this.annotatedReader.register(source);\n		return 1;\n	}\n	return 0;\n}\n</code></pre> \n<p>① - 判断是否支持Groovy<br> ② - 判断是否包含@Component注解，如果包含才开始注册</p> \n<pre><code>// BeanDefinitionLoader.java\n\nprivate boolean isComponent(Class&lt;?&gt; type) {\n\n	if (AnnotationUtils.findAnnotation(type, Component.class) != null) {\n		return true;\n	}\n	if (type.getName().matches(\".*\\\\$_.*closure.*\") || type.isAnonymousClass() || type.getConstructors() == null || type.getConstructors().length == 0) {\n		return false;\n	}\n	return true;\n}\n\n// AnnotationUtils.java\n\npublic static &lt;A extends Annotation&gt; A findAnnotation(Class&lt;?&gt; clazz, @Nullable Class&lt;A&gt; annotationType) {\n		return findAnnotation(clazz, annotationType, true);\n}\n\n\n@SuppressWarnings(\"unchecked\")\n@Nullable\nprivate static &lt;A extends Annotation&gt; A findAnnotation(Class&lt;?&gt; clazz, @Nullable Class&lt;A&gt; annotationType, boolean synthesize) {\n\n	Assert.notNull(clazz, \"Class must not be null\");\n	if (annotationType == null) {\n		return null;\n	}\n	\n	// ①\n	AnnotationCacheKey cacheKey = new AnnotationCacheKey(clazz, annotationType);\n	A result = (A) findAnnotationCache.get(cacheKey);\n	if (result == null) {\n		result = findAnnotation(clazz, annotationType, new HashSet&lt;&gt;());\n		if (result != null &amp;&amp; synthesize) {\n			result = synthesizeAnnotation(result, clazz);\n			findAnnotationCache.put(cacheKey, result);\n		}\n	}\n	return result;\n}\n</code></pre> \n<p>① - 从缓存获取被加载的资源类是否有@Component注解的缓存</p> \n<p>默认情况下是没有缓存，此时将会去查找Example.class是否包含@Component注解。那在默认情况下我们的启动类并未直接标明这个注解, 一个典型的SpringBoot Web应用如下：</p> \n<pre><code>\n@RestController\n@SpringBootApplication\npublic class Example {\n\n	@RequestMapping(\"/\")\n	String home() {\n		return \"Hello World!\";\n	}\n\n	public static void main(String[] args) {\n		SpringApplication.run(Example.class, args);\n\n	}\n\n}\n</code></pre> \n<p>实际上@RestController和@SpringBootApplication两个注解都包含了@Component注解。因此Example.class自然也就具有@Component注解，感兴趣的可以亲自点进去看看这两个注解内部。更多细节将来会单独分析。在确定了它支持@Component注解之后，开始加载Bean。</p> \n<pre><code>// BeanDefinitionLoader#load(Class&lt;?&gt; source)\n\nthis.annotatedReader.register(source);\n\n// AnnotatedBeanDefinitionReader.java\n\n&lt;T&gt; void doRegisterBean(Class&lt;T&gt; annotatedClass, @Nullable Supplier&lt;T&gt; instanceSupplier, @Nullable String name,\n			@Nullable Class&lt;? extends Annotation&gt;[] qualifiers, BeanDefinitionCustomizer... definitionCustomizers) {\n\n	// ①\n	AnnotatedGenericBeanDefinition abd = new AnnotatedGenericBeanDefinition(annotatedClass);\n	// ②\n	if (this.conditionEvaluator.shouldSkip(abd.getMetadata())) {\n		return;\n	}\n\n	// ③\n	abd.setInstanceSupplier(instanceSupplier);\n	// ④\n	ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(abd);\n	abd.setScope(scopeMetadata.getScopeName());\n	String beanName = (name != null ? name : this.beanNameGenerator.generateBeanName(abd, this.registry));\n	// ⑤\n	AnnotationConfigUtils.processCommonDefinitionAnnotations(abd);\n	// ⑥\n	if (qualifiers != null) {\n		for (Class&lt;? extends Annotation&gt; qualifier : qualifiers) {\n			if (Primary.class == qualifier) {\n				abd.setPrimary(true);\n			}\n			else if (Lazy.class == qualifier) {\n				abd.setLazyInit(true);\n			}\n			else {\n				abd.addQualifier(new AutowireCandidateQualifier(qualifier));\n			}\n		}\n	}\n	// ⑦\n	for (BeanDefinitionCustomizer customizer : definitionCustomizers) {\n		customizer.customize(abd);\n	}\n\n	// ⑧\n	BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(abd, beanName);\n	definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry);\n	BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, this.registry);\n}\n</code></pre> \n<p>① - 创建一个带注解元数据的类定义。<br> ② - 判断是否有@Conditional注解，以确定是否满足条件需要排除。<br> ③ - 设置一个创建Bean的回调，基本都是空值。<br> ④ - 获取当前Bean的作用域元数据，判断依据是是否包含@Scope注解。ScopeMetadata包含类的作用域描述（singleton | prototype）和代理模式描述ScopedProxyMode，默认为单例模式，不使用代理创建。<br> ⑤ - 处理常用注解，包括@Lazy、@Primary、@Role、@Description、@DependsOn，他们将被设置到BeanDefinition的属性当中。<br> ⑥ - 检查传入的Qualifiers。<br> ⑦ - 暂时不知道干啥的，以后再说<br> ⑧ - 确认好当前Bean的代理模式，并注册。</p> \n<p>在真正将一个类以BeanDefinition来注册的时候需要把可能涉及到的一些特性全部都检查一遍。此处只加载了我们的示例类Example.class，并未加载其他类。</p> \n<h3 id=\"发布applicationpreparedevent事件\">发布ApplicationPreparedEvent事件</h3> \n<blockquote> \n <p>由EventPublishingRunListener.contextLoaded(ConfigurableApplicationContext context)方法触发。</p> \n</blockquote> \n<p>在真正触发事件之前，它处理了ApplicationContextAware实现，为其设置了上下文。</p> \n<h4 id=\"为applicationcontextaware扩展接口设置上下文\">为ApplicationContextAware扩展接口设置上下文</h4> \n<pre><code>public void contextLoaded(ConfigurableApplicationContext context) {\n	for (ApplicationListener&lt;?&gt; listener : this.application.getListeners()) {\n		if (listener instanceof ApplicationContextAware) {\n			((ApplicationContextAware) listener).setApplicationContext(context);\n		}\n		// 将所有监听器赋值给上下文\n		context.addApplicationListener(listener);\n	}\n	this.initialMulticaster.multicastEvent(new ApplicationPreparedEvent(this.application, this.args, context));\n}\n</code></pre> \n<h4 id=\"configfileapplicationlistener\">ConfigFileApplicationListener</h4> \n<p>添加了一个BeanFactoryPostProcessor：PropertySourceOrderingPostProcessor，用于重排序defaultProperties</p> \n<h4 id=\"loggingapplicationlistener\">LoggingApplicationListener</h4> \n<p>以单例模式注册注册当前日志系统</p> \n<h2 id=\"总结\">总结</h2> \n<p>在预处理上下文时将先前加载的一些属性赋值给context，执行了ApplicationContextInitializers的实现类，为ApplicationContextAware接口填充context对象。</p>', NULL, '2021-03-27 00:18:22', 0, NULL, NULL, 'https://www.cnblogs.com/lukama/p/14583241.html', 0, NULL);
INSERT INTO `t_blog` VALUES (291, 'Excel模板导出之动态导出', '<h2>说明</h2> \n<p>目前Magicodes.IE已支持Excel模板导出时使用<code>JObject</code>、<code>Dictionary</code>和<code>ExpandoObject</code>来进行动态导出，具体使用请看本篇教程。</p> \n<p>本功能的想法、部分实现初步源于<a href=\"https://gitee.com/arik\">arik</a>的贡献，这里再次感谢<a href=\"https://gitee.com/arik\">arik</a>！</p> \n<p>在开始本篇教程之前，我们重温一下模板导出的语法：</p> \n<div class=\"white\"> \n <div class=\"highlight\"> \n  <div class=\"cnblogs_code\"> \n   <pre>  {{Company}}  <span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">单元格渲染</span>\n  {{Table&gt;&gt;BookInfos|RowNo}} <span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">表格渲染开始语法</span>\n  {{Remark|&gt;&gt;Table}}<span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">表格渲染结束语法</span>\n  {{Image::ImageUrl?Width=<span style=\"color: rgba(128, 0, 128, 1)\">50</span>&amp;Height=<span style=\"color: rgba(128, 0, 128, 1)\">120</span>&amp;Alt=<span style=\"color: rgba(128, 0, 128, 1)\">404</span>}} <span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">图片渲染</span>\n  {{Image::ImageUrl?w=<span style=\"color: rgba(128, 0, 128, 1)\">50</span>&amp;h=<span style=\"color: rgba(128, 0, 128, 1)\">120</span>&amp;Alt=<span style=\"color: rgba(128, 0, 128, 1)\">404</span>}} <span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">图片渲染</span>\n  {{Image::ImageUrl?Alt=<span style=\"color: rgba(128, 0, 128, 1)\">404</span>}} <span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">图片渲染</span>\n  {{Formula::AVERAGE?<span style=\"color: rgba(0, 0, 255, 1)\">params</span>=G4:G6}}  <span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">公式渲染</span>\n  {{Formula::SUM?<span style=\"color: rgba(0, 0, 255, 1)\">params</span>=G4:G6&amp;G4}}   <span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">公式渲染</span></pre> \n  </div> \n </div> \n</div> \n<p>如果您对Magicodes.IE的模板导出不太了解，请阅读以下教程：</p> \n<p><a href=\"https://gitee.com/magicodes/Magicodes.IE/blob/master/docs/9.Excel%E6%A8%A1%E6%9D%BF%E5%AF%BC%E5%87%BA%E4%B9%8B%E5%AF%BC%E5%87%BA%E6%95%99%E6%9D%90%E8%AE%A2%E8%B4%AD%E8%A1%A8.md\">Excel模板导出之导出教材订购表</a></p> \n<p>接下来，我们开始本篇教程：</p> \n<h2>1.安装包Magicodes.IE.Excel</h2> \n<div class=\"white\"> \n <div class=\"highlight\"> \n  <div class=\"cnblogs_code\"> \n   <pre>Install-Package Magicodes.IE.Excel</pre> \n  </div> \n </div> \n</div> \n<h2>2.准备Excel模板文件</h2> \n<p>参考如图：</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/e284f99a-22df-48e2-a39d-73f922ac2d57.png\" alt=\"模板文件\"></p> \n<p>该文件可以在测试工程中找到，文件名为【DynamicExportTpl.xlsx】。</p> \n<h2>3.使用JObject完成动态导出</h2> \n<p>代码比较简单，如下所示：</p> \n<div class=\"white\"> \n <div class=\"highlight\"> \n  <div class=\"cnblogs_code\"> \n   <pre>    <span style=\"color: rgba(0, 0, 255, 1)\">string</span> json = <span style=\"color: rgba(128, 0, 0, 1)\">@\"</span><span style=\"color: rgba(128, 0, 0, 1)\">{\n      \'Company\': \'雪雁\',\n      \'Address\': \'湖南长沙\',\n      \'Contact\': \'雪雁\',\n      \'Tel\': \'136xxx\',\n      \'BookInfos\': [\n        {\'No\':\'a1\',\'RowNo\':1,\'Name\':\'Docker+Kubernetes应用开发与快速上云\',\'EditorInChief\':\'李文强\',\'PublishingHouse\':\'机械工业出版社\',\'Price\':65,\'PurchaseQuantity\':10000,\'Cover\':\'https://img9.doubanio.com/view/ark_article_cover/retina/public/135025435.jpg?v=1585121965\',\'Remark\':\'备注\'},\n        {\'No\':\'a1\',\'RowNo\':1,\'Name\':\'Docker+Kubernetes应用开发与快速上云\',\'EditorInChief\':\'李文强\',\'PublishingHouse\':\'机械工业出版社\',\'Price\':65,\'PurchaseQuantity\':10000,\'Cover\':\'https://img9.doubanio.com/view/ark_article_cover/retina/public/135025435.jpg?v=1585121965\',\'Remark\':\'备注\'}\n      ]\n    }</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> jobj =<span style=\"color: rgba(0, 0, 0, 1)\"> JObject.Parse(json);\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">模板路径</span>\n    <span style=\"color: rgba(0, 0, 255, 1)\">var</span> tplPath = Path.Combine(Directory.GetCurrentDirectory(), <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">TestFiles</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">ExportTemplates</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n        </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">DynamicExportTpl.xlsx</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">创建Excel导出对象</span>\n    IExportFileByTemplate exporter = <span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> ExcelExporter();\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">导出路径</span>\n    <span style=\"color: rgba(0, 0, 255, 1)\">var</span> filePath = Path.Combine(Directory.GetCurrentDirectory(), nameof(DynamicExportByTemplate_Test) + <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">.xlsx</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">if</span><span style=\"color: rgba(0, 0, 0, 1)\"> (File.Exists(filePath)) File.Delete(filePath);\n\n    </span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">根据模板导出</span>\n    <span style=\"color: rgba(0, 0, 255, 1)\">await</span> exporter.ExportByTemplate(filePath, jobj, tplPath);</pre> \n  </div> \n </div> \n</div> \n<p>上述代码大家可以在单元测试<code>DynamicExportWithJObjectByTemplate_Test</code>中找到。</p> \n<p><strong>值得注意的是，由于此处使用了<code>JObject</code>对象，因此在使用时需要按装包<code>Newtonsoft.Json</code>。但是，<code>Magicodes.IE.Excel</code>本身并不依赖<code>Newtonsoft.Json</code>。</strong></p> \n<p>目前Excel模板动态导出仅支持通过<code>JObject</code>对象，在后续将支持更多动态方式。</p> \n<p>运行后可以看到如下图所示的结果：</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/55f3d40a-268e-45ca-953a-6f50c89f318d.png\" alt=\"动态导出结果\"></p> \n<h2>4.使用Dictionary&lt;string, object&gt;完成动态导出</h2> \n<p>导出的代码和上面是一样的，只是数据结构使用了<code>Dictionary</code>：</p> \n<div class=\"white\"> \n <div class=\"highlight\"> \n  <div class=\"cnblogs_code\"> \n   <pre><span style=\"color: rgba(0, 0, 255, 1)\">var</span> data = <span style=\"color: rgba(0, 0, 255, 1)\">new</span> Dictionary&lt;<span style=\"color: rgba(0, 0, 255, 1)\">string</span>, <span style=\"color: rgba(0, 0, 255, 1)\">object</span>&gt;<span style=\"color: rgba(0, 0, 0, 1)\">()\n{\n    { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Company</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">雪雁</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n    { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Address</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">湖南长沙</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n    { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Contact</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">雪雁</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n    { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Tel</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">136xxx</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n    { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">BookInfos</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(0, 0, 255, 1)\">new</span> List&lt;Dictionary&lt;<span style=\"color: rgba(0, 0, 255, 1)\">string</span>,<span style=\"color: rgba(0, 0, 255, 1)\">object</span>&gt;&gt;<span style=\"color: rgba(0, 0, 0, 1)\">()\n        {\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">new</span> Dictionary&lt;<span style=\"color: rgba(0, 0, 255, 1)\">string</span>, <span style=\"color: rgba(0, 0, 255, 1)\">object</span>&gt;<span style=\"color: rgba(0, 0, 0, 1)\">()\n            {\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">No</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">A1</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">RowNo</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 128, 1)\">1</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Docker+Kubernetes应用开发与快速上云</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">EditorInChief</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">李文强</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">PublishingHouse</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">机械工业出版社</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Price</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 128, 1)\">65</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">PurchaseQuantity</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 128, 1)\">50000</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Cover</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">https://img9.doubanio.com/view/ark_article_cover/retina/public/135025435.jpg?v=1585121965</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Remark</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">买起</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> }\n            },\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">new</span> Dictionary&lt;<span style=\"color: rgba(0, 0, 255, 1)\">string</span>, <span style=\"color: rgba(0, 0, 255, 1)\">object</span>&gt;<span style=\"color: rgba(0, 0, 0, 1)\">()\n            {\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">No</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">A2</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">RowNo</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 128, 1)\">2</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Name</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Docker+Kubernetes应用开发与快速上云</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">EditorInChief</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">李文强</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">PublishingHouse</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">机械工业出版社</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Price</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 128, 1)\">65</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">PurchaseQuantity</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 128, 1)\">50000</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Cover</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">https://img9.doubanio.com/view/ark_article_cover/retina/public/135025435.jpg?v=1585121965</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> },\n                {</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Remark</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">k8s真香</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\"> }\n            }\n        }\n    }\n};\n</span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">模板路径</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">var</span> tplPath = Path.Combine(Directory.GetCurrentDirectory(), <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">TestFiles</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">ExportTemplates</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">DynamicExportTpl.xlsx</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n</span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">创建Excel导出对象</span>\nIExportFileByTemplate exporter = <span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> ExcelExporter();\n</span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">导出路径</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">var</span> filePath = Path.Combine(Directory.GetCurrentDirectory(), nameof(DynamicExportWithDictionaryByTemplate_Test) + <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">.xlsx</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">if</span><span style=\"color: rgba(0, 0, 0, 1)\"> (File.Exists(filePath)) File.Delete(filePath);\n\n</span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">根据模板导出</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">await</span> exporter.ExportByTemplate(filePath, data, tplPath);</pre> \n  </div> \n </div> \n</div> \n<p>具体代码见<code>DynamicExportWithDictionaryByTemplate_Test</code>。</p> \n<h2>5.使用ExpandoObject完成动态导出</h2> \n<p>同上，代码如下所示：</p> \n<div class=\"white\"> \n <div class=\"highlight\"> \n  <div class=\"cnblogs_code\"> \n   <pre><span style=\"color: rgba(0, 0, 255, 1)\">dynamic</span> data = <span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> ExpandoObject();\ndata.Company </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">雪雁</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\ndata.Address </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">湖南长沙</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\ndata.Contact </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">雪雁</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\ndata.Tel </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">136xxx</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\ndata.BookInfos </span>= <span style=\"color: rgba(0, 0, 255, 1)\">new</span> List&lt;ExpandoObject&gt;<span style=\"color: rgba(0, 0, 0, 1)\">() { };\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">dynamic</span> book1 = <span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> ExpandoObject();\nbook1.No </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">A1</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook1.RowNo </span>= <span style=\"color: rgba(128, 0, 128, 1)\">1</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook1.Name </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Docker+Kubernetes应用开发与快速上云</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook1.EditorInChief </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">李文强</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook1.PublishingHouse </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">机械工业出版社</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook1.Price </span>= <span style=\"color: rgba(128, 0, 128, 1)\">65</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook1.PurchaseQuantity </span>= <span style=\"color: rgba(128, 0, 128, 1)\">50000</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook1.Cover </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">https://img9.doubanio.com/view/ark_article_cover/retina/public/135025435.jpg?v=1585121965</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook1.Remark </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">买买买</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\ndata.BookInfos.Add(book1);\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">dynamic</span> book2 = <span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> ExpandoObject();\nbook2.No </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">A2</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook2.RowNo </span>= <span style=\"color: rgba(128, 0, 128, 1)\">2</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook2.Name </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Docker+Kubernetes应用开发与快速上云</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook2.EditorInChief </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">李文强</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook2.PublishingHouse </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">机械工业出版社</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook2.Price </span>= <span style=\"color: rgba(128, 0, 128, 1)\">65</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook2.PurchaseQuantity </span>= <span style=\"color: rgba(128, 0, 128, 1)\">50000</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook2.Cover </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">https://img9.doubanio.com/view/ark_article_cover/retina/public/135025435.jpg?v=1585121965</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\nbook2.Remark </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">买买买</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">;\ndata.BookInfos.Add(book2);\n\n</span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">模板路径</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">var</span> tplPath = Path.Combine(Directory.GetCurrentDirectory(), <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">TestFiles</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">ExportTemplates</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,\n    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">DynamicExportTpl.xlsx</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n</span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">创建Excel导出对象</span>\nIExportFileByTemplate exporter = <span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> ExcelExporter();\n</span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">导出路径</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">var</span> filePath = Path.Combine(Directory.GetCurrentDirectory(), nameof(DynamicExportWithExpandoObjectByTemplate_Test) + <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">.xlsx</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">if</span><span style=\"color: rgba(0, 0, 0, 1)\"> (File.Exists(filePath)) File.Delete(filePath);\n\n</span><span style=\"color: rgba(0, 128, 0, 1)\">//</span><span style=\"color: rgba(0, 128, 0, 1)\">根据模板导出</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">await</span> exporter.ExportByTemplate(filePath, data, tplPath);</pre> \n  </div> \n </div> \n</div> \n<p>具体代码参考<code>DynamicExportWithExpandoObjectByTemplate_Test</code>。</p> \n<h2>最后</h2> \n<p>本教程至此就结束了，如有疑问，麻烦大家多多提交Issue。</p> \n<p><strong>Magicodes.IE：导入导出通用库，支持Dto导入导出、模板导出、花式导出以及动态导出，支持Excel、Csv、Word、Pdf和Html。</strong></p> \n<ul> \n <li>Github：<a href=\"https://github.com/dotnetcore/Magicodes.IE\" rel=\"nofollow\">https://github.com/dotnetcore/Magicodes.IE</a></li> \n <li>码云（手动同步，不维护）：<a href=\"https://gitee.com/magicodes/Magicodes.IE\">https://gitee.com/magicodes/Magicodes.IE</a></li> \n</ul> \n<p><strong>相关库会一直更新，在功能体验上有可能会和本文教程有细微的出入，请以相关具体代码、版本日志、单元测试示例为准。</strong></p>', NULL, '2021-03-27 00:18:23', 0, NULL, NULL, 'https://www.cnblogs.com/codelove/p/14583223.html', 0, NULL);
INSERT INTO `t_blog` VALUES (292, 'C语言之简易了解程序环境', '<h1>C语言之简易了解程序环境</h1> \n<p><strong>大纲：</strong></p> \n<ul> \n <li><strong>程序的翻译环境</strong> \n  <ul> \n   <li><strong>预编译</strong></li> \n   <li><strong>编译</strong></li> \n   <li><strong>汇编</strong></li> \n   <li><strong>链接</strong></li> \n  </ul> </li> \n <li><strong>程序的运行环境</strong></li> \n</ul> \n<p>&nbsp;</p> \n<p>　　在ANSI C的任何一种实现中，存在两个不同的环境。</p> \n<p>　　　　第1种是<strong>翻译环境</strong>，在这个环境中源代码被转换为可执行的机器指令。</p> \n<p>　　　　第2种是<strong>执行环境</strong>，它用于实际执行代码。</p> \n<h2>一.程序的翻译环境</h2> \n<p>　　我们上手的第一个C语言程序大致都是 “Hello World！”吧！</p> \n<p>　　可是，不知道大家想过没有？一个代码文件，是怎么转换成了我们可运行的exe文件呢，而且我们都知道计算机是只能看得懂二进制文件，所以再进一层说：</p> \n<p>　　<strong>一个 .c 文件是怎么转换为 .exe 文件的呢？</strong>这就是通过翻译环境来实现的。而翻译环境又包括编译和链接，编译又分为预编译，编译和汇编。</p> \n<p>　　接下来，我们就来看看它们到底干了什么：</p> \n<h3>&nbsp; 1.预编译</h3> \n<p>　　预编译过程主要处理以 # 开头的语句，如#include，#define 等</p> \n<p>　　而预编译都干了一些什么呢，主要如下：</p> \n<p>　　　　1.头文件的包含</p> \n<p>　　　　2.注释的删除</p> \n<p>　　　　3.#define定义的符号的替换</p> \n<p>　　　　4.处理一些条件预处理指令，如 #if 、 #ifdef&nbsp; 等等（<em><span style=\"font-size: 12px\">这个我们会在后面提到）</span></em></p> \n<p>　　　　5.保留所有的 #pragma 命令</p> \n<p>　　　　6.一些文本操作</p> \n<p>　　假设我们这里有一份代码：</p> \n<div class=\"cnblogs_code\"> \n <pre>#include&lt;stdio.h&gt;\n<span style=\"color: rgba(0, 0, 255, 1)\">#define</span> NUM 10\n\n<span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> main()\n{\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span> i = <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">;\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">for</span>(i=<span style=\"color: rgba(128, 0, 128, 1)\">0</span>;i&lt;NUM;i++<span style=\"color: rgba(0, 0, 0, 1)\">)\n        {\n                printf(</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">%d \\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">,i);\n        }\n\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span> <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">;\n}<br></span></pre> \n</div> \n<p>　　我们来看看它预编译之后产生什么：</p> \n<div class=\"cnblogs_code\">\n <img src=\"http://localhost:9090/blogImages/2021/03/27/8597b981-3076-414c-a755-faa044637c03.gif\" id=\"code_img_closed_5392e8c7-7e71-4a93-b2de-975bb8d67dfd\" class=\"code_img_closed\">\n <img src=\"http://localhost:9090/blogImages/2021/03/27/70c0b34c-4484-4e6f-896b-b2339e1e30ec.gif\" id=\"code_img_opened_5392e8c7-7e71-4a93-b2de-975bb8d67dfd\" class=\"code_img_opened\" style=\"display: none\"> \n <div id=\"cnblogs_code_open_5392e8c7-7e71-4a93-b2de-975bb8d67dfd\" class=\"cnblogs_code_hide\"> \n  <pre># <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">test.c</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">&lt;built-in&gt;</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">&lt;命令行&gt;</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">31</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">&lt;命令行&gt;</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdc-predef.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">32</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">&lt;命令行&gt;</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">test.c</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">27</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/features.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">375</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/features.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/sys/cdefs.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">392</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/sys/cdefs.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/bits/wordsize.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">393</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/sys/cdefs.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">376</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/features.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">399</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/features.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/gnu/stubs.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">10</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/gnu/stubs.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/gnu/stubs-64.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">11</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/gnu/stubs.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">400</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/features.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">28</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n\n\n\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/local/lib/gcc/x86_64-pc-linux-gnu/8.3.0/include/stddef.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">216</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/local/lib/gcc/x86_64-pc-linux-gnu/8.3.0/include/stddef.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">216</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/local/lib/gcc/x86_64-pc-linux-gnu/8.3.0/include/stddef.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> unsigned <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> size_t;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">34</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/bits/types.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">27</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/bits/types.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/bits/wordsize.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">28</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/bits/types.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span><span style=\"color: rgba(0, 0, 0, 1)\"> __u_char;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">short</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __u_short;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __u_int;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __u_long;\n\n\ntypedef signed </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span><span style=\"color: rgba(0, 0, 0, 1)\"> __int8_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span><span style=\"color: rgba(0, 0, 0, 1)\"> __uint8_t;\ntypedef signed </span><span style=\"color: rgba(0, 0, 255, 1)\">short</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __int16_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">short</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __uint16_t;\ntypedef signed </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __int32_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __uint32_t;\n\ntypedef signed </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __int64_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __uint64_t;\n\n\n\n\n\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __quad_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __u_quad_t;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">130</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/bits/types.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/bits/typesizes.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">131</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/bits/types.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __dev_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __uid_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __gid_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __ino_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __ino64_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __mode_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __nlink_t;\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __off_t;\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __off64_t;\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __pid_t;\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span> { <span style=\"color: rgba(0, 0, 255, 1)\">int</span> __val[<span style=\"color: rgba(128, 0, 128, 1)\">2</span><span style=\"color: rgba(0, 0, 0, 1)\">]; } __fsid_t;\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __clock_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __rlim_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __rlim64_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __id_t;\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __time_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __useconds_t;\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __suseconds_t;\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __daddr_t;\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __key_t;\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __clockid_t;\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">void</span> *<span style=\"color: rgba(0, 0, 0, 1)\"> __timer_t;\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __blksize_t;\n\n\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __blkcnt_t;\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __blkcnt64_t;\n\n\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __fsblkcnt_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __fsblkcnt64_t;\n\n\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __fsfilcnt_t;\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __fsfilcnt64_t;\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __fsword_t;\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __ssize_t;\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __syscall_slong_t;\n\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __syscall_ulong_t;\n\n\n\ntypedef __off64_t __loff_t;\ntypedef __quad_t </span>*<span style=\"color: rgba(0, 0, 0, 1)\">__qaddr_t;\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__caddr_t;\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __intptr_t;\n\n\ntypedef unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __socklen_t;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">36</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">44</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_FILE;\n\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_FILE FILE;\n\n\n\n\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">64</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_FILE __FILE;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">74</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">32</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/_G_config.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">15</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/_G_config.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/local/lib/gcc/x86_64-pc-linux-gnu/8.3.0/include/stddef.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">16</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/_G_config.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n\n\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/wchar.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">82</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/wchar.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\">\n{\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __count;\n  union\n  {\n\n    unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __wch;\n\n\n\n    </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span> __wchb[<span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">];\n  } __value;\n} __mbstate_t;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">21</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/_G_config.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\">\n{\n  __off_t __pos;\n  __mbstate_t __state;\n} _G_fpos_t;\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\">\n{\n  __off64_t __pos;\n  __mbstate_t __state;\n} _G_fpos64_t;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">33</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">50</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/local/lib/gcc/x86_64-pc-linux-gnu/8.3.0/include/stdarg.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">40</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/local/lib/gcc/x86_64-pc-linux-gnu/8.3.0/include/stdarg.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\ntypedef __builtin_va_list __gnuc_va_list;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">51</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">145</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">struct</span> _IO_jump_t; <span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_FILE;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">155</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_lock_t;\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_marker {\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span> _IO_marker *<span style=\"color: rgba(0, 0, 0, 1)\">_next;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span> _IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">_sbuf;\n\n\n\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> _pos;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">178</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n};\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">enum</span><span style=\"color: rgba(0, 0, 0, 1)\"> __codecvt_result\n{\n  __codecvt_ok,\n  __codecvt_partial,\n  __codecvt_error,\n  __codecvt_noconv\n};\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">246</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_FILE {\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> _flags;\n\n\n\n\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span>*<span style=\"color: rgba(0, 0, 0, 1)\"> _IO_read_ptr;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span>*<span style=\"color: rgba(0, 0, 0, 1)\"> _IO_read_end;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span>*<span style=\"color: rgba(0, 0, 0, 1)\"> _IO_read_base;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span>*<span style=\"color: rgba(0, 0, 0, 1)\"> _IO_write_base;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span>*<span style=\"color: rgba(0, 0, 0, 1)\"> _IO_write_ptr;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span>*<span style=\"color: rgba(0, 0, 0, 1)\"> _IO_write_end;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span>*<span style=\"color: rgba(0, 0, 0, 1)\"> _IO_buf_base;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span>*<span style=\"color: rgba(0, 0, 0, 1)\"> _IO_buf_end;\n\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">_IO_save_base;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">_IO_backup_base;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">_IO_save_end;\n\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span> _IO_marker *<span style=\"color: rgba(0, 0, 0, 1)\">_markers;\n\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span> _IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">_chain;\n\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> _fileno;\n\n\n\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> _flags2;\n\n  __off_t _old_offset;\n\n\n\n  unsigned </span><span style=\"color: rgba(0, 0, 255, 1)\">short</span><span style=\"color: rgba(0, 0, 0, 1)\"> _cur_column;\n  signed </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span><span style=\"color: rgba(0, 0, 0, 1)\"> _vtable_offset;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span> _shortbuf[<span style=\"color: rgba(128, 0, 128, 1)\">1</span><span style=\"color: rgba(0, 0, 0, 1)\">];\n\n\n\n  _IO_lock_t </span>*<span style=\"color: rgba(0, 0, 0, 1)\">_lock;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">294</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n  __off64_t _offset;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">303</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n  <span style=\"color: rgba(0, 0, 255, 1)\">void</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__pad1;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">void</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__pad2;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">void</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__pad3;\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">void</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__pad4;\n  size_t __pad5;\n\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> _mode;\n\n  </span><span style=\"color: rgba(0, 0, 255, 1)\">char</span> _unused2[<span style=\"color: rgba(128, 0, 128, 1)\">15</span> * <span style=\"color: rgba(0, 0, 255, 1)\">sizeof</span> (<span style=\"color: rgba(0, 0, 255, 1)\">int</span>) - <span style=\"color: rgba(128, 0, 128, 1)\">4</span> * <span style=\"color: rgba(0, 0, 255, 1)\">sizeof</span> (<span style=\"color: rgba(0, 0, 255, 1)\">void</span> *) - <span style=\"color: rgba(0, 0, 255, 1)\">sizeof</span><span style=\"color: rgba(0, 0, 0, 1)\"> (size_t)];\n\n};\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_FILE _IO_FILE;\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_FILE_plus;\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_FILE_plus _IO_2_1_stdin_;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_FILE_plus _IO_2_1_stdout_;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">struct</span><span style=\"color: rgba(0, 0, 0, 1)\"> _IO_FILE_plus _IO_2_1_stderr_;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">339</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\ntypedef __ssize_t __io_read_fn (</span><span style=\"color: rgba(0, 0, 255, 1)\">void</span> *__cookie, <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__buf, size_t __nbytes);\n\n\n\n\n\n\n\ntypedef __ssize_t __io_write_fn (</span><span style=\"color: rgba(0, 0, 255, 1)\">void</span> *__cookie, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__buf,\n     size_t __n);\n\n\n\n\n\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span> __io_seek_fn (<span style=\"color: rgba(0, 0, 255, 1)\">void</span> *__cookie, __off64_t *__pos, <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __w);\n\n\ntypedef </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span> __io_close_fn (<span style=\"color: rgba(0, 0, 255, 1)\">void</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__cookie);\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">391</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> __underflow (_IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> __uflow (_IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> __overflow (_IO_FILE *, <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">435</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> _IO_getc (_IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__fp);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> _IO_putc (<span style=\"color: rgba(0, 0, 255, 1)\">int</span> __c, _IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__fp);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> _IO_feof (_IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__fp) __attribute__ ((__nothrow__ , __leaf__));\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> _IO_ferror (_IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__fp) __attribute__ ((__nothrow__ , __leaf__));\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> _IO_peekc_locked (_IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__fp);\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> _IO_flockfile (_IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">) __attribute__ ((__nothrow__ , __leaf__));\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> _IO_funlockfile (_IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">) __attribute__ ((__nothrow__ , __leaf__));\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> _IO_ftrylockfile (_IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">) __attribute__ ((__nothrow__ , __leaf__));\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">465</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/libio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> _IO_vfscanf (_IO_FILE * __restrict, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\"> __restrict,\n   __gnuc_va_list, </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> _IO_vfprintf (_IO_FILE *__restrict, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict,\n    __gnuc_va_list);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> __ssize_t _IO_padn (_IO_FILE *, <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\">, __ssize_t);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> size_t _IO_sgetn (_IO_FILE *, <span style=\"color: rgba(0, 0, 255, 1)\">void</span> *<span style=\"color: rgba(0, 0, 0, 1)\">, size_t);\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> __off64_t _IO_seekoff (_IO_FILE *, __off64_t, <span style=\"color: rgba(0, 0, 255, 1)\">int</span>, <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> __off64_t _IO_seekpos (_IO_FILE *, __off64_t, <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> _IO_free_backup_area (_IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">) __attribute__ ((__nothrow__ , __leaf__));\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">75</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n\n\n\ntypedef __gnuc_va_list va_list;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">90</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\ntypedef __off_t off_t;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">102</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\ntypedef __ssize_t ssize_t;\n\n\n\n\n\n\n\ntypedef _G_fpos_t fpos_t;\n\n\n\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">164</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/bits/stdio_lim.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">165</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n\n\n\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">struct</span> _IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">stdin;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">struct</span> _IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">stdout;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">struct</span> _IO_FILE *<span style=\"color: rgba(0, 0, 0, 1)\">stderr;\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> remove (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__filename) __attribute__ ((__nothrow__ , __leaf__));\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> rename (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__old, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__new) __attribute__ ((__nothrow__ , __leaf__));\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> renameat (<span style=\"color: rgba(0, 0, 255, 1)\">int</span> __oldfd, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__old, <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __newfd,\n       </span><span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__new) __attribute__ ((__nothrow__ , __leaf__));\n\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> FILE *tmpfile (<span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\">) ;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">209</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *tmpnam (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__s) __attribute__ ((__nothrow__ , __leaf__)) ;\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *tmpnam_r (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__s) __attribute__ ((__nothrow__ , __leaf__)) ;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">227</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *tempnam (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__dir, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__pfx)\n     __attribute__ ((__nothrow__ , __leaf__)) __attribute__ ((__malloc__)) ;\n\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fclose (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fflush (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">252</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fflush_unlocked (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">266</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n\n\n\n\n\n\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> FILE *fopen (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __filename,\n      </span><span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __modes) ;\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> FILE *freopen (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __filename,\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __modes,\n        FILE </span>*<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __stream) ;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">295</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">306</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> FILE *fdopen (<span style=\"color: rgba(0, 0, 255, 1)\">int</span> __fd, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__modes) __attribute__ ((__nothrow__ , __leaf__)) ;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">319</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> FILE *fmemopen (<span style=\"color: rgba(0, 0, 255, 1)\">void</span> *__s, size_t __len, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__modes)\n  __attribute__ ((__nothrow__ , __leaf__)) ;\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> FILE *open_memstream (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> **__bufloc, size_t *<span style=\"color: rgba(0, 0, 0, 1)\">__sizeloc) __attribute__ ((__nothrow__ , __leaf__)) ;\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> setbuf (FILE *__restrict __stream, <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __buf) __attribute__ ((__nothrow__ , __leaf__));\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> setvbuf (FILE *__restrict __stream, <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __buf,\n      </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __modes, size_t __n) __attribute__ ((__nothrow__ , __leaf__));\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> setbuffer (FILE *__restrict __stream, <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __buf,\n         size_t __size) __attribute__ ((__nothrow__ , __leaf__));\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> setlinebuf (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__));\n\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fprintf (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __stream,\n      </span><span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format, ...);\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> printf (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format, ...);\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> sprintf (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __s,\n      </span><span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format, ...) __attribute__ ((__nothrow__));\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vfprintf (FILE *__restrict __s, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format,\n       __gnuc_va_list __arg);\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vprintf (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format, __gnuc_va_list __arg);\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vsprintf (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__restrict __s, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format,\n       __gnuc_va_list __arg) __attribute__ ((__nothrow__));\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> snprintf (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __s, size_t __maxlen,\n       </span><span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format, ...)\n     __attribute__ ((__nothrow__)) __attribute__ ((__format__ (__printf__, </span><span style=\"color: rgba(128, 0, 128, 1)\">3</span>, <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">)));\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vsnprintf (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __s, size_t __maxlen,\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format, __gnuc_va_list __arg)\n     __attribute__ ((__nothrow__)) __attribute__ ((__format__ (__printf__, </span><span style=\"color: rgba(128, 0, 128, 1)\">3</span>, <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">)));\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">412</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vdprintf (<span style=\"color: rgba(0, 0, 255, 1)\">int</span> __fd, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __fmt,\n       __gnuc_va_list __arg)\n     __attribute__ ((__format__ (__printf__, </span><span style=\"color: rgba(128, 0, 128, 1)\">2</span>, <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">)));\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> dprintf (<span style=\"color: rgba(0, 0, 255, 1)\">int</span> __fd, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __fmt, ...)\n     __attribute__ ((__format__ (__printf__, </span><span style=\"color: rgba(128, 0, 128, 1)\">2</span>, <span style=\"color: rgba(128, 0, 128, 1)\">3</span><span style=\"color: rgba(0, 0, 0, 1)\">)));\n\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fscanf (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __stream,\n     </span><span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format, ...) ;\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> scanf (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format, ...) ;\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> sscanf (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __s,\n     </span><span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format, ...) __attribute__ ((__nothrow__ , __leaf__));\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">443</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fscanf (FILE *__restrict __stream, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__restrict __format, ...) __asm__ (<span style=\"color: rgba(128, 0, 0, 1)\">\"\"</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">__isoc99_fscanf</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">)\n\n                               ;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> scanf (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__restrict __format, ...) __asm__ (<span style=\"color: rgba(128, 0, 0, 1)\">\"\"</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">__isoc99_scanf</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">)\n                              ;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> sscanf (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__restrict __s, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__restrict __format, ...) __asm__ (<span style=\"color: rgba(128, 0, 0, 1)\">\"\"</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">__isoc99_sscanf</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">) __attribute__ ((__nothrow__ , __leaf__))\n\n                      ;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">463</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n\n\n\n\n\n\n\n\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vfscanf (FILE *__restrict __s, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format,\n      __gnuc_va_list __arg)\n     __attribute__ ((__format__ (__scanf__, </span><span style=\"color: rgba(128, 0, 128, 1)\">2</span>, <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">))) ;\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vscanf (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format, __gnuc_va_list __arg)\n     __attribute__ ((__format__ (__scanf__, </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span>, <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">))) ;\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vsscanf (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __s,\n      </span><span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __format, __gnuc_va_list __arg)\n     __attribute__ ((__nothrow__ , __leaf__)) __attribute__ ((__format__ (__scanf__, </span><span style=\"color: rgba(128, 0, 128, 1)\">2</span>, <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">)));\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">494</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vfscanf (FILE *__restrict __s, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__restrict __format, __gnuc_va_list __arg) __asm__ (<span style=\"color: rgba(128, 0, 0, 1)\">\"\"</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">__isoc99_vfscanf</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">)\n\n\n\n     __attribute__ ((__format__ (__scanf__, </span><span style=\"color: rgba(128, 0, 128, 1)\">2</span>, <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">))) ;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vscanf (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__restrict __format, __gnuc_va_list __arg) __asm__ (<span style=\"color: rgba(128, 0, 0, 1)\">\"\"</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">__isoc99_vscanf</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">)\n\n     __attribute__ ((__format__ (__scanf__, </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span>, <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">))) ;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vsscanf (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__restrict __s, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__restrict __format, __gnuc_va_list __arg) __asm__ (<span style=\"color: rgba(128, 0, 0, 1)\">\"\"</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">__isoc99_vsscanf</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">) __attribute__ ((__nothrow__ , __leaf__))\n\n\n\n     __attribute__ ((__format__ (__scanf__, </span><span style=\"color: rgba(128, 0, 128, 1)\">2</span>, <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">)));\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">522</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n\n\n\n\n\n\n\n\n\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fgetc (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> getc (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> getchar (<span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">550</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> getc_unlocked (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> getchar_unlocked (<span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">561</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fgetc_unlocked (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n\n\n\n\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fputc (<span style=\"color: rgba(0, 0, 255, 1)\">int</span> __c, FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> putc (<span style=\"color: rgba(0, 0, 255, 1)\">int</span> __c, FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> putchar (<span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __c);\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">594</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fputc_unlocked (<span style=\"color: rgba(0, 0, 255, 1)\">int</span> __c, FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> putc_unlocked (<span style=\"color: rgba(0, 0, 255, 1)\">int</span> __c, FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> putchar_unlocked (<span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __c);\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> getw (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> putw (<span style=\"color: rgba(0, 0, 255, 1)\">int</span> __w, FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *fgets (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__restrict __s, <span style=\"color: rgba(0, 0, 255, 1)\">int</span> __n, FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __stream)\n     ;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">640</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">665</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> __ssize_t __getdelim (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> **<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __lineptr,\n          size_t </span>*__restrict __n, <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __delimiter,\n          FILE </span>*<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __stream) ;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> __ssize_t getdelim (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> **<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __lineptr,\n        size_t </span>*__restrict __n, <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __delimiter,\n        FILE </span>*<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __stream) ;\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> __ssize_t getline (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> **<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __lineptr,\n       size_t </span>*<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __n,\n       FILE </span>*<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __stream) ;\n\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fputs (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__restrict __s, FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __stream);\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> puts (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__s);\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> ungetc (<span style=\"color: rgba(0, 0, 255, 1)\">int</span> __c, FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> size_t fread (<span style=\"color: rgba(0, 0, 255, 1)\">void</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __ptr, size_t __size,\n       size_t __n, FILE </span>*<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __stream) ;\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> size_t fwrite (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __ptr, size_t __size,\n        size_t __n, FILE </span>*<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __s);\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">737</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> size_t fread_unlocked (<span style=\"color: rgba(0, 0, 255, 1)\">void</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __ptr, size_t __size,\n         size_t __n, FILE </span>*<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __stream) ;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> size_t fwrite_unlocked (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __ptr, size_t __size,\n          size_t __n, FILE </span>*<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __stream);\n\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fseek (FILE *__stream, <span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> __off, <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __whence);\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">long</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> ftell (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) ;\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> rewind (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">773</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fseeko (FILE *__stream, __off_t __off, <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> __whence);\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> __off_t ftello (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) ;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">792</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n\n\n\n\n\n\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fgetpos (FILE *__restrict __stream, fpos_t *<span style=\"color: rgba(0, 0, 0, 1)\">__restrict __pos);\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fsetpos (FILE *__stream, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> fpos_t *<span style=\"color: rgba(0, 0, 0, 1)\">__pos);\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">815</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">824</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n\n\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> clearerr (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__));\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> feof (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__)) ;\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> ferror (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__)) ;\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> clearerr_unlocked (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__));\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> feof_unlocked (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__)) ;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> ferror_unlocked (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__)) ;\n\n\n\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> perror (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__s);\n\n\n\n\n\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/bits/sys_errlist.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">1</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">26</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/bits/sys_errlist.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> sys_nerr;\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 255, 1)\">const</span><span style=\"color: rgba(0, 0, 0, 1)\"> sys_errlist[];\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">854</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n\n\n\n\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fileno (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__)) ;\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fileno_unlocked (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__)) ;\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">873</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> FILE *popen (<span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *__command, <span style=\"color: rgba(0, 0, 255, 1)\">const</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__modes) ;\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> pclose (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream);\n\n\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">char</span> *ctermid (<span style=\"color: rgba(0, 0, 255, 1)\">char</span> *<span style=\"color: rgba(0, 0, 0, 1)\">__s) __attribute__ ((__nothrow__ , __leaf__));\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">913</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> flockfile (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__));\n\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">int</span> ftrylockfile (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__)) ;\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> funlockfile (FILE *<span style=\"color: rgba(0, 0, 0, 1)\">__stream) __attribute__ ((__nothrow__ , __leaf__));\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">943</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">/usr/include/stdio.h</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">3</span> <span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">2</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">test.c</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span> <span style=\"color: rgba(128, 0, 128, 1)\">2</span><span style=\"color: rgba(0, 0, 0, 1)\">\n\n\n\n# </span><span style=\"color: rgba(128, 0, 128, 1)\">4</span> <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">test.c</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>\n<span style=\"color: rgba(0, 0, 255, 1)\">int</span> result = <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">;\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">int</span> ADD(<span style=\"color: rgba(0, 0, 255, 1)\">int</span> x, <span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> y)\n{\n </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span> x +<span style=\"color: rgba(0, 0, 0, 1)\"> y;\n}\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> main()\n{\n </span><span style=\"color: rgba(0, 0, 255, 1)\">int</span> a = <span style=\"color: rgba(128, 0, 128, 1)\">10</span><span style=\"color: rgba(0, 0, 0, 1)\">;\n result </span>= ADD(a, <span style=\"color: rgba(128, 0, 128, 1)\">10</span><span style=\"color: rgba(0, 0, 0, 1)\">);\n printf(</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">%d+%d=%d\\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, a, <span style=\"color: rgba(128, 0, 128, 1)\">10</span><span style=\"color: rgba(0, 0, 0, 1)\">, result);\n\n </span><span style=\"color: rgba(0, 0, 255, 1)\">return</span> <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">;\n}</span></pre> \n </div> \n <span class=\"cnblogs_code_collapse\">test.i</span>\n</div> \n<p>　　我们看到test.i文件居然包含了快900行代码，而且我们会看到现在的生成的文件效果跟我们上面所提到的相符，如删除注释，替换#define替换的符号等</p> \n<p><span style=\"font-size: 12px\"><strong>注：</strong></span></p> \n<p><span style=\"font-size: 12px\"><strong>　　可以用 set nu 来查看行数</strong></span></p> \n<p><span style=\"font-size: 12px\"><strong>　　怎么生成 .i文件（即预编译后的文件）呢？</strong></span></p> \n<p><span style=\"font-size: 12px\"><strong>　　　　在gcc编译器下我们可以使用如下指令：</strong></span></p> \n<p><span style=\"font-size: 12px\"><strong>　　　　　　1.&nbsp;<span class=\"cnblogs_code\">gcc -E test.c &gt; test.i</span>&nbsp;</strong></span></p> \n<p><span style=\"font-size: 12px\"><strong>　　　　　　2.&nbsp;<span class=\"cnblogs_code\">gcc -E test.c -o test.i</span>&nbsp;</strong></span></p> \n<p>&nbsp;</p> \n<h3>2.编译</h3> \n<p>　　在预编译之后就是编译了，我们可以用&nbsp;<span class=\"cnblogs_code\">gcc -S test.c &gt; test.s</span>&nbsp;来生成编译后的文件，我们可以用vim test.s来查看其内容，内容如下：</p> \n<div class=\"cnblogs_code\">\n <img src=\"http://localhost:9090/blogImages/2021/03/27/8597b981-3076-414c-a755-faa044637c03.gif\" id=\"code_img_closed_1ebd9376-cd03-4915-82c9-ae4843d269f8\" class=\"code_img_closed\">\n <img src=\"http://localhost:9090/blogImages/2021/03/27/70c0b34c-4484-4e6f-896b-b2339e1e30ec.gif\" id=\"code_img_opened_1ebd9376-cd03-4915-82c9-ae4843d269f8\" class=\"code_img_opened\" style=\"display: none\"> \n <div id=\"cnblogs_code_open_1ebd9376-cd03-4915-82c9-ae4843d269f8\" class=\"cnblogs_code_hide\"> \n  <pre>    .file    <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">test.c</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    .text\n    .globl    result\n    .bss\n    .align </span><span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    .type    result, @object\n    .size    result, </span><span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\nresult:\n    .zero    </span><span style=\"color: rgba(128, 0, 128, 1)\">4</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    .text\n    .globl    ADD\n    .type    ADD, @function\nADD:\n.LFB0:\n    .cfi_startproc\n    pushq    </span>%<span style=\"color: rgba(0, 0, 0, 1)\">rbp\n    .cfi_def_cfa_offset </span><span style=\"color: rgba(128, 0, 128, 1)\">16</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    .cfi_offset </span><span style=\"color: rgba(128, 0, 128, 1)\">6</span>, -<span style=\"color: rgba(128, 0, 128, 1)\">16</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    movq    </span>%rsp, %<span style=\"color: rgba(0, 0, 0, 1)\">rbp\n    .cfi_def_cfa_register </span><span style=\"color: rgba(128, 0, 128, 1)\">6</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    movl    </span>%edi, -<span style=\"color: rgba(128, 0, 128, 1)\">4</span>(%<span style=\"color: rgba(0, 0, 0, 1)\">rbp)\n    movl    </span>%esi, -<span style=\"color: rgba(128, 0, 128, 1)\">8</span>(%<span style=\"color: rgba(0, 0, 0, 1)\">rbp)\n    movl    </span>-<span style=\"color: rgba(128, 0, 128, 1)\">4</span>(%rbp), %<span style=\"color: rgba(0, 0, 0, 1)\">edx\n    movl    </span>-<span style=\"color: rgba(128, 0, 128, 1)\">8</span>(%rbp), %<span style=\"color: rgba(0, 0, 0, 1)\">eax\n    addl    </span>%edx, %<span style=\"color: rgba(0, 0, 0, 1)\">eax\n    popq    </span>%<span style=\"color: rgba(0, 0, 0, 1)\">rbp\n    .cfi_def_cfa </span><span style=\"color: rgba(128, 0, 128, 1)\">7</span>, <span style=\"color: rgba(128, 0, 128, 1)\">8</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    ret\n    .cfi_endproc\n.LFE0:\n    .size    ADD, .</span>-<span style=\"color: rgba(0, 0, 0, 1)\">ADD\n    .section    .rodata\n.LC0:\n    .</span><span style=\"color: rgba(0, 0, 255, 1)\">string</span>    <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">%d+%d=%d\\n</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    .text\n    .globl    main\n    .type    main, @function\nmain:\n.LFB1:\n    .cfi_startproc\n    pushq    </span>%<span style=\"color: rgba(0, 0, 0, 1)\">rbp\n    .cfi_def_cfa_offset </span><span style=\"color: rgba(128, 0, 128, 1)\">16</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    .cfi_offset </span><span style=\"color: rgba(128, 0, 128, 1)\">6</span>, -<span style=\"color: rgba(128, 0, 128, 1)\">16</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    movq    </span>%rsp, %<span style=\"color: rgba(0, 0, 0, 1)\">rbp\n    .cfi_def_cfa_register </span><span style=\"color: rgba(128, 0, 128, 1)\">6</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    subq    $</span><span style=\"color: rgba(128, 0, 128, 1)\">16</span>, %<span style=\"color: rgba(0, 0, 0, 1)\">rsp\n    movl    $</span><span style=\"color: rgba(128, 0, 128, 1)\">10</span>, -<span style=\"color: rgba(128, 0, 128, 1)\">4</span>(%<span style=\"color: rgba(0, 0, 0, 1)\">rbp)\n    movl    </span>-<span style=\"color: rgba(128, 0, 128, 1)\">4</span>(%rbp), %<span style=\"color: rgba(0, 0, 0, 1)\">eax\n    movl    $</span><span style=\"color: rgba(128, 0, 128, 1)\">10</span>, %<span style=\"color: rgba(0, 0, 0, 1)\">esi\n    movl    </span>%eax, %<span style=\"color: rgba(0, 0, 0, 1)\">edi\n    call    ADD\n    movl    </span>%eax, result(%<span style=\"color: rgba(0, 0, 0, 1)\">rip)\n    movl    result(</span>%rip), %<span style=\"color: rgba(0, 0, 0, 1)\">edx\n    movl    </span>-<span style=\"color: rgba(128, 0, 128, 1)\">4</span>(%rbp), %<span style=\"color: rgba(0, 0, 0, 1)\">eax\n    movl    </span>%edx, %<span style=\"color: rgba(0, 0, 0, 1)\">ecx\n    movl    $</span><span style=\"color: rgba(128, 0, 128, 1)\">10</span>, %<span style=\"color: rgba(0, 0, 0, 1)\">edx\n    movl    </span>%eax, %<span style=\"color: rgba(0, 0, 0, 1)\">esi\n    movl    $.LC0, </span>%<span style=\"color: rgba(0, 0, 0, 1)\">edi\n    movl    $</span><span style=\"color: rgba(128, 0, 128, 1)\">0</span>, %<span style=\"color: rgba(0, 0, 0, 1)\">eax\n    call    printf\n    movl    $</span><span style=\"color: rgba(128, 0, 128, 1)\">0</span>, %<span style=\"color: rgba(0, 0, 0, 1)\">eax\n    leave\n    .cfi_def_cfa </span><span style=\"color: rgba(128, 0, 128, 1)\">7</span>, <span style=\"color: rgba(128, 0, 128, 1)\">8</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    ret\n    .cfi_endproc\n.LFE1:\n    .size    main, .</span>-<span style=\"color: rgba(0, 0, 0, 1)\">main\n    .ident    </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">GCC: (GNU) 8.3.0</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n    .section    .note.GNU</span>-stack,<span style=\"color: rgba(128, 0, 0, 1)\">\"\"</span>,@progbits</pre> \n </div> \n <span class=\"cnblogs_code_collapse\">test.s</span>\n</div> \n<p>　　而程序在编译阶段是将我们的c代码转为了汇编代码，包含如下内容：</p> \n<p>　　　　1.词法分析</p> \n<p style=\"margin-left: 60px\">　　首先源代码程序被输入到扫描器（Scanner）,扫描器的任务很简单,它只是简单地进 行词法分析,运用一种类似于有限状态机（Finite State Machine）的算法可以很轻松地将源 代码的字符序列分割成一系列的记号（Token）。</p> \n<p style=\"margin-left: 60px\">　　词法分析产生的记号一般可以分为如下几类：关键字、标识符、字面量（包含数字、字 符串等）和特殊符号（如加号、等号〉。在识别记号的同时，扫描器也完成了其他工作。比如将标识符存放到符号表，将数字、字符串常景存放到文字表等，以备后面的步骤使用。 有一个叫做lex的程序可以实现同法扫描，它会按照用户之前描述好的词法规则将输入的字符串分割成一个个记号。因为这样一个程序的存在，编译器的开发者就无须为每个编译器开发一个独立的词法扫描器，而是根据需要改变词法规则就可以了。</p> \n<p>　　　　　　另外对于一些有预处理的语言，比如C语言，它的宏替换和文件包含等工作一般不归入编译器的范围而交给一个独立的预处理器。</p> \n<p>　　　　2.语法分析</p> \n<p style=\"margin-left: 60px\">　　接下来语法分析器(Grammar Parser)将对由扫描器产生的记号进行语法分析，从而 产生语法树(SyntaxTree)。整个分析过程采用了上下文无关语法(Context-free Grammar) 的分析手段，如果你对上下文无关语法及下推自动机很熟悉，那么应该很好理解。否则，可以参考一些计算理论的资料，一般都会有很详细的介绍。此处不再赘述。简单地讲，由语法分析器生成的语法树就是以表达式(Expression)为节点的树。我们知道，C语言的一个语句是一个表达式，而复杂的语句是很多表达式的组合。</p> \n<p>　　　　上面例子中的语句就是一个由赋值表达式、加法表达式、乘法表达式、数组表达式、括号表达式组成的复杂语句。它在经过语法分析器以后形成如图所示的语法树。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/1edae8be-1eca-4569-9355-d07ad4cc506c.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>&nbsp;　　此例文件：</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/6e2ea132-94ca-48f1-8120-25fad7224ce2.png\" alt=\"\" loading=\"lazy\"></p> \n<p style=\"text-align: left; margin-left: 60px\">　　从图屮我们可以看到，整个语句被看作是一个赋值表达式；赋值表达式的左边是一个数组表达式，它的右边是一个乘法表达式；数组表达式又由两个符号表达式组成，等等。 符号和数字是最小的表达式，它们不是由其他的表达式来组成的，所以它们通常作为整个语法树的叶节点。在语法分析的同时，很多运算符号的优先级和含义也被确定下来了。比如乘法表达式的优先级比加法高，而圆括号表达式的优先级比乘法髙，等等。另外有些符号具有多重含义，比如星号*在C语言中可以表示乘法表达式，也可以表示对指针取内容的表达式， 所以语法分析阶段必须对这些内容进行区分。如果出现了表达式不合法，比如各种括号不匹配、表达式中缺少操作符等，编译器就会报告语法分析阶段的错误。 正如前面词法分析有lex 一样，语法分析也有一个现成的工具叫做yacc (Yet Another CompilerCompiler)。它也像lex 样，可以根据用户给定的语法规则对输入的记号序列进行 解析，从而构建出一棵语法树。对于不同的编程语言，编译器的开发者只须改变语法规则， 而无须为每个编译器编写一个语法分析器，所以它又被称为“编译器编译器(Compiler Compiler)**。</p> \n<p>　　　　3.语义分析</p> \n<p style=\"margin-left: 60px\">　　接下米进行可以看到，每个表达式（包括符号和数字）都被标识了类型。我们的例子中几乎所有的 表达式都是整型的，所以无须做转换，整个分析过程很顺利。语义分析器还对符号表里的符 号类型也做了更新。的是语义分析，由语义分析器(Semantic Analyzer)来完成。语法分析仅 仪是完成了对表达式的语法层面的分析，但是它并不了解这个语句是否真正有意义。比如C 语言里囱两个指针做乘法运算是没有意义的，但是这个语句在语法上是合法的；比如同样一 个指针和一个浮点数做乘法运算是否合法等。编译器所能分析的语义是静态语义(Static Semantic),所谓静态语义是指在编译期可以确定的语义，与之对应的动态语义(DynamicSemantic）就是只有在运行期才能确定的语义。 静态语义通常包括声明和类型的匹配，类型的转换。比如当一个浮点型的表达式赋值给 一个整型的表达式时，其屮隐含了一个浮点型到整型转换的过程，语义分析过程中需要完成 这个步骤。比如将一个浮点型赋值给一个指针的时候，语义分析程序会发现这个类型不匹配， 编译器将会报错。动态语义一般指在运行期出现的语义相关的问题，比如将0作为除数是一个运行期语义错误。 经过语义分析阶段以后，整个语法树的表达式都被标识了类型，如果有些类型需要做隐式转换，语义分析程序会在语法树屮插入相应的转换节点。上面描述的语法树在经过语义分析阶段以后成为如图2-4所示的形式。</p> \n<p style=\"margin-left: 60px\"><img src=\"http://localhost:9090/blogImages/2021/03/27/aca4f526-d7e9-426e-befc-362473961640.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>&nbsp;　　　　　　可以看到，每个表达式（包括符号和数字）都被标识了类型。我们的例子中几乎所有的表达式都是整型的，所以无须做转换，整个分析过程很顺利。语义分析器还对符号表里的符号类型也做了更新。</p> \n<p>　　　　4.符号汇总</p> \n<p>　　　　　　对于符号汇总，我们可以先生成 .o文件来查看一下我们一开始的例子所拥有的符号，命令:&nbsp;<span class=\"cnblogs_code\">gcc -c test.c</span>&nbsp;,然后再用&nbsp;<span class=\"cnblogs_code\">readelf -s test.o</span>&nbsp;来查看所拥有的符号。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/00213788-516f-4a49-ab75-41af884e981b.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>&nbsp;<img src=\"http://localhost:9090/blogImages/2021/03/27/4912bda5-f630-4a00-9e47-f7c931fd75d7.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p style=\"margin-left: 60px\">&nbsp;　　我们再对比源代码，发现符号都是全局变量，以及一个我们使用的库函数，而这些符号都是所参与我们编译文件的符号的一个汇总，如：我现在有两个.c文件，一个是含有add符号，另外一个含有main符号，那么，汇总后就是add，main。</p> \n<h3>3.汇编</h3> \n<p>　　这个阶段的主要工作是将汇编代码转换为二进制指令（包括形成符号表 --- 将汇总的符号与地址联系起来），如果我们不指定阅读器打开，就会显示一堆乱码。命令就是刚刚用来查看符号的第一步：&nbsp;<span class=\"cnblogs_code\">gcc -c test.c</span>&nbsp;然后，我们发现我们的路径底下多了一个test.o文件。（要是你使用的是coldblocks软件来写你的c程序，运行完再相应文件夹都会出现 .o 文件）</p> \n<p>　　<strong>注：</strong></p> \n<p><strong>　　　　形成符号表：</strong></p> \n<p style=\"margin-left: 60px\"><strong>　　</strong>经过这些扫描、语法分析、语义分析、源代码优化、代码生成和目标代码优化，编译器 忙活了这么多个步骤以后，源代码终于被编译成了目标代码。但是这个目标代码中有一个问 题是：一些函数符号的地址还没有确定。如果我们要把目标代码使用汇编器编译成真正能够在机器上执行的指令，那么它们的地址应该从哪儿得到呢？如果它们的定义在跟上面的源代码同一个编译单元里面，那么编译器可以为它们分配空间， 确定它们的地址：那如果是定义在其他的程序模块呢？</p> \n<p style=\"margin-left: 60px\">　　这个看似简单的问题引出了我们一个很大的话题：冃标代码中有变量定义在其他模块， 该怎么办？事实上，定义其他模块的全局变量和函数在最终运行时的绝对地址都要在最终链接的时候才能确定。所以现代的编译器可以将一个源代码文件编译成一个未链接的目标文 件，然后由链接器最终将这些目标文件链接起来形成可执行文件。让我们带着这个问题，走进链接的世界。</p> \n<h3>4.链接</h3> \n<p>　　链接：</p> \n<p style=\"margin-left: 30px\">　　程序没计的模块化是人们一直在追求的目标，因为当一个系统十分复杂的时候，我们不得不将一个复杂的系统逐步分割成小的系统以达到各个突破的目的。一个复杂的软件也如 此，人们把毎个源代码模块独立地编译，然后按照须要将它们“组装”起来，这个组装模块的过程就是链接</p> \n<p style=\"margin-left: 30px\">　　链接的主要内容就是把各个模块之间相互引用的部分都处理好， 使得各个模块之间能够正确地衔接。　　</p> \n<p>　　gcc下的命令是：&nbsp;<span class=\"cnblogs_code\">gcc test.o</span>&nbsp; ,然后我们会发现，路径底下多了一个叫a.out的文件，这就相当于我们的exe文件，我们可以&nbsp;<span class=\"cnblogs_code\">./a.<span style=\"color: rgba(0, 0, 255, 1)\">out</span></span>&nbsp;来运行它，看是否是我们想要的结果。</p> \n<p><img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAf0AAAA+CAYAAAAhx8ImAAAgAElEQVR4Ae2d9XtVR7fH+Vfu/fV9b0sFdycJEAIkRHB3Le6uxWmhSHEo7u7u7hZciruUdt3ns8Ic9tnZxyKQ0JnnOTknW2bPXiPfZbNWnoJV6krBynWkQKVakj8mRfJVTJIfKiTK9+US5LuyNeTb0nHyTckq8t/iMfK/eYsI5fbt29K4RUuZPnOW/p/ZPx06d5WoKlVl/4GDma3K8/5Zc+dLviLFsqy97oecOXdOYmskSNeevdyn7P+WApYClgJhU2D0+AmSv2hxefHiRdj3cOHxk6ckqU5duXz1akT3ZeTi3Xv3SflKVWTgkGEZud3e84UpkMcN+j9WTAwb9Mf/8qvc//NPefL0qfzzzz8hX+XuvXvy8OEj37Xv37+XCxcvStHSZaV+k6Zy7/79kHUEu+DVq1dy6/ZtoV4KbaLO1u07SoFiJeTc+fPBbg/r3OUrV+Tly1e+a9+8fStz5i+QQiVKyZJly33H7Q9LAUuByClw4NAh2bR1a8jPjZs3I688h97BOgXIs5YOGjY8Q6B/NfWajBg1Wlhjs6rQrtRr1+T169e+Kp+/eCHjJv4iBYuXlO07d/qO2x+5hwJ5CqmkXztN0o9OFm/Qr/xR0i+sb2Yk/aoJNaVNh44y8dfJPqAN9uoTJ02WDp27yJgJE2X6jFkybOQoSapTTwqXKCUrVq/2MQPB6gh27tTp09K0ZWsZOvJnmT5jpkyeOk3aduwkxcuUkxGjx2S6fp5dq34D6TNgoEyaMlWmzZipk7RCpSrSrHUbuX3nTrDm2XOWApYCISiA9hDgC/U5ePhIiJpyz2mElEVLl+paWimueoZAPzve9sOHD1KvURPpP3iI/DZtuq53vfsNkLJRMfJT124CA2BL7qOAP+hHJcmP6dT7VeWbkv6g/+7dO0HiPXb8hH74/ffff4d8+zXr1kuj5i2lTMVoKVyytKqIWrZtL7v27JG3b9+GvD/UBdeuX5efunaXmKrVpEipMlK0VBlJrltf5i9cJE+fPQt1e1jnBw0dLvFJKVK8bHllVjBLwGFfuXo1LBqE9RB7kaXAv5QCb968kZevXoX8vP/rr6+GQqydN2/d8q2nJ06eEgD3SxfahYATl5AoxcqUk0LFS6oZc+KkSdrecLS7X/od7PPTU+AT6MfUkvxRifJjxWSfej9v2erybenYj6BfSf43b5qkn74ae8RSwFLAUsBSwFLAUiCnU8AB+imSXyV9C/o5vdNs+ywFLAUsBSwFLAUyQgEH6CdL/ihs+gb04yWveu9bST8jhLX3WApYClgKWApYCuQ0CnwE/VpSIBrQx6YP6NeU78sB+la9n9M6zLbHUsBSwFLAUsBSIKMUUNBnj7436Ff9aNM3+/StTT+jhLb3WQpYClgKWApYCnxpCuQpVIXAPCkeoF9D8pa1oP85O2jjli1SqnxF6dGnb7Y89sHDh1KnYSOp07CxPHz0KFueEUml7969l5q16mgMBQKS5M1fUKrUiI+kii9+7a3bd7T9xIH4sXBR+TZfARk4NHjQkvadOusOk8NHjn7x9jsbgDc2MTeePXtud6I4CRPk9/Pnz3WrXdX4mhojJMil2XrqcwbnydYXyaWVv37zRh49eix85/SSp1AV9uingX4+P/V+dQfos2Xvk/f+y5cvZduOnbJg0WL9bN+xM0dsMcnpxA7Vvq8N9NmGee7CBdm8dZssXb5CFi9bLus3bhLiKbx69VqBZeXqNTJ77nwh0BN7lHMb6BNUhfbz6dqzd64Gfbbisj+e4CuPHj8ONVzteRHJCtBne96Ro8d86+nipcvCintCBzDHzp47J1N/nyHRVePkj8VLdDt1TtpOxzbM3Xv2yukzZ7IkVkpOHHibtmwVmHm+c3rJU6hyGujnj06WfLpljzC8CfJ9uTTQz+uxZc8E52nUrIWMnThRlq1YIX99Rftmv1SnfS2gz/7eM2fPyoDBQzT4UvPWbaRTt+7S7qfOGtyoWs0k6TNgkJw6c8YnUd64eUsaNmue60DfOVZWrV2bq0EfKaV6YrI0at5C7ty563w1+zsABbIC9Fk7iW7HWkrwr3DD8BJtlLC98cm1JDo2Tu8jbgixSX79bYq8ffsuQKs/72GirtKmTVu2fLWg//us2Ur/37MoNH129lCegpVrSYGYZPEH/Xj5vlw1+a5sVUkDfWz6leR/Pu7TN6A/Zfrv8vbdu7C50ux8ka+h7q8F9OHqK1eroSBOAKfHT55omFEWSMwKLHBEYuSa4ydOatdZ0P/yI9iCfuR9kBWgz1MBftbSkWPGhgX6SPi/TP5NiAa6YdMm2b5zl8Qnp8iefftUU5OfXCOzsiY3SuRU8b/j18m/SZsOP2U6zLp/rTnrv9wF+jjxhQT9tIh8btCPNOHOixcvZdbceVIprpoULFZCY+Jv3b5dhv08SiPcrVm/3teTRKgigQTSHxG6nGXVmrXyXYFCep/zOOEsd+7aLQ2aNNUEOxUrx8qkKdNkzrz5anft1b+/83Lp3L2HlK9UWVVPzhOnz5wVbHSx8TWdh/X39Rs3pVffflKibHmNUtWxSzfZvG2bcrIp9er7Xc+7/lCwsKqunSfIEdCzbz+NTEgUQVOcoI+k3PanTlKkZGkpVqasDBo6TGNzm2v5Pnn6tEbIIreAu2B6YeIzGE35ZNNvJBcvXdJwxYTUJAxyi9Zt5fKV9Mk6iHHO4lK7fkMpUa6CLkjQhmNecb7h6om42Ktff3n00W+AhZG44jyfSGqPHz+W8xcuSPtOXSQmrrrakSMBfcxL5DlIql1XY4AXLV1GmrdpqwseKmqv8ur1azVJoXUoUa68jg+SJBFC2vkeLL5Hjx1XesfF19TIjkSP5P0XL1sWNBFKpJL+th070tSysXFSoFhxqVWvvuzZu8+r+drGCb9OUhMIvgNloqKl36DBcv7iRZ+2xHkjNJo9b75KgfgbFCtdVmokpcjoceMFPwRT6N8mLVqpP4LxScibv4D8UKiI71hy3Xpy8dJlc0uGvwGq4ydOqNanbHSMjiUSt/QfNEQuXLyU4XrNjajJiRU/auw4XWOgKfOU+QEj6i4PHjzUUN2xNeJ1PJSqUFHn5emzZz3NlTCsw38eJeWiK2lE0SYtW8u+AwekVbv2ul6Q98NZGIsnT52Sjp27SqkKUfq+jDnCdzMHvFTw4Sbc+fPPPyWxdh1tP+ue26bfrWcvDRVu8pA42/U5fzMOK1evoWGG3c9lHVy7foOGZkdTQTx/X3/t3Zclmgr6AEaoWavWmuOFZ4ArK9esEdrmLJjqGjRtJox3d19u3b5Dvi9YWCO+mntWr13nmyPg0Tc/5ldcYh6ZDyHhc1rJU1BBP0XyRyc51PsuSb9EZflvsZh0kn4koM/CD7hDDKS87r37aLx6OhvnMsLaZgb0mUAbN2/RuNCE4e3Svac6xDExataqrYtYZkH/+o0bqv5kAW3Rpp307j9AmrRspcBVLqaSZBXoM/BQ87FYEVYYDp4BB/A7GaCMgj6LXEq9BpopsXP3nlK/cRqTFBNXTVhMnGXK779rGE7CJcOo8M4ALJOzbsPGcu/epyRJ2IGrxidIq/YdFKRQ85NApd1PnQSVfkrd+rJoyTKp06CRjJvwi2YEI8Tn8J9HS7igzzgiNCiTjMmL0yPMG31esnxFWbp8ubz7mHDJvMfjx0/UuQ4gQ33N9dTRtuNPyjQ5EyXBnDA2YSjadeqs78v/JISiD3r07qtMiqnb+R0J6JeuECW1GzSSBk2aaXZGZUbKlheAx51MBmYJUxrMR+PmLX1tp44aSclqJnG2g4W+e6/eCmR1GzXWd+g/eKi+L2N0995PAEh4avwqyFMBA4QjKXNy5Ogxeozj2JgNA+d8TiS/WWBZL1BdUz8MH2OJGO4JKbWUSYykPve1jLU9+/ZL9cQkKVmugrRo20569Rsg3Xr1lrqNmuh4dd4DgDdr1UaBpmHTZtoW2gQTDFN7+Ih/bH9AAMaP9jPnYfyZB1xfuVr1dKCPHXvO/Pm67jD2MW9169VHGSxChJOR0yvBWLigf/fuPWUAyTECo+oGfS+Gwvn+n+M3bYDJZAw6GWvz7CNHj+q6wNzq1K2H9O4/UOdmQkptZcwXLl4igZh4U0ewb+6FUWetwt+hc7ceul6wbgDQfQcOkmeO8OyRgv6FS5d8c4SxxPrQtFVr3zHmjhezGazNn+OcB+iTZS/rQX/Xnr0Cd49t59LlyyqdABJ/LFqsHZBZ0Geho+4KlWPVWYyJ8NeHD7L/4EEFLTo5M6DPAGbxz1e4qC6IxtGJidutZ299h6wCfQYPmfsAON7j7LnzKl2wODozBWYU9L8rUFAGDB6q0jeLJQsaqZIB0mUrVvqNOzQCJ06d0twF0IAP6vqxEybqAkgSJVMWLFykA//IsWN6CNqzwPfs01d27t6tDn2AKZoAAzxIZWhkkNDCsemj5SEGuJE+ke7o+7379kv5mEp6HObMFNoL2AD4ACZaHHYNUJA0Dhw67CfFklGM92WMsnBT0mh0R1q166DSAupUrxIJ6CNNt2zXXjUutJHxNHTESGWKJ/z6q1/1o8aNlx8LFVHJ/v79+9oHL16+VC0OAAJwOsuVq6m6E4Lxcv36DZ8mgPfF6Qsmwqtkl3qf98Pxl/kfG58gBw4eEjQvFBZm2hRIw+HVTq9jzBV2pZSuGCWAxdOnT/UyxsfNm7dk0ZKlfrehqWKewRTcuXNHaUrfz/9joSbogiE0hfaPnfiLzg+YTBhD02dI/qwtbu99xjeq91r1GqjjKu/JPX8+eKBACAO3fOXKdBqFcEH/yZMnqmFg9wsaI2gKmH2O1LqGLqG+yUdC/hO0jl4FWuw7cFATlRmNBGs2Dn8w5zALaHwzWsg8yJoMY8ZzeAbjgbmNxgUt6qo1a3zVRwr6vhtFdC7CEOYOm75PvW8kfUC/hr9NXyX96AxL+gx4JhnbmUi64yw4m+B8klnQZzEHtJBG2XJkyl9/fVCA41xmQB/HpjJRMYJ0xaJqChN51+49qgbOKtDH5GAAxzyna6/eCpaAmykZBX3MBSRJchbMAGyZGzl6rPNwwN+HDh9RlSVcuikt2rSVxDr1dGKRgat1+w6CVsEswNAKjQFSOROMgpQJcKHeDQX6MEAwXoyjZStXmcfqN+eGjfxZF3IYDFNgymgjC/OJk2n+A+Yc37SJTzhlxarVCsqMZa8SCeijcqc+GApTtmzbrjSFOTEFlXjJ8hWU6Tvkkj5hbng3tGeGxtzHXOB9azdo6JcW1dQZ6Du7QB/tFAwN/RbIu9lJh0DtC3acPmeOkxHOjC3n9Sz2pkBTdoqQRGbv/k/zifN37t5VCR6aAqyUhw8fqjYMmjqZbs6hlUHD5AR96ocZYD7hle8umNFYR/oNHKSMp/N8uKAPvXbu3iNo59AOsYZi8pk8bZqnVO18xuf6PXj4CGX63Wr0UM9///4vGTxshNIIhjCjZcfOXcrsDxkxwm+eUR8aQcYj2ibwifLvAX2fI58B/QQ/0P+2VKz8X4nK8p+iGQf9Z8+fK0cNZw3X7S5devTKNOiTSY9JhkrFvYjPW7BQVZ2ZAX04RcAJDtFd/7nzF1SbkFWg37JtOzeJVLLGrODMYZ1R0Me261bjr9uwUScBC5GzvHn7VrZt3yG0CVs4fcjiCq1ZBFHPU5CSMKUw0SnHjh+XStWqq8ZCD4goM4Cqk4XZFPoL9SiLZyjQf/DggapWee4tlwRAn6AF4NzMOXNN9XL0+HF1GITbD6dQDwA6d/4C1RogkTnfmXcnTbNXiQT0sQtja3QWNCRoPZDQTbl8+bKOXUDFaJfMORhDJFXeGY2FKfQF9SN5YMqAUWQO0pdO8DPXm+/sAn0YL1Jek+LayZyY52bF989jxiqd3BK9V92pqamq8oVGbq0HznRsW4SmmAsoaNqqJSSqls8993mfeo2b+IE+74tWCFDBBOb+YN4sULS4zil39s9wQd+8F1o6TDEAPs/7vkAh1QrBAEcKtqbOrPiGOapSPV7Wb9wYsDoYlzt37ymzjnAATZhffHgX7O9o3TJSqHvWnLnaj6wL7n5DW0MfN2/d1ucr9e8B/XSSftaDPhwz27UATThpdxkyfESmQR/w+LFwEb8F3zwHiYoBlRnQx+EQhzds4e6C1IxqLatA3ys4z7hfflXVMmpSU4KC/sJFQRz50gfnYf88Ew1btylMFPbP897YjgGY4aNGy+hxE9S2zaTEA58CAEGDzj166v979x9QAFu74dOk3/+RcTKq/Xv37inAoX4Px6Z/+84dn9SOU6i7oOZkIiOJm0mOJAeQ0rZwCrZSfBBQ/aFe7NN/oGo/eGfGMMwOC6pXiQT00Xa4g/McPX5CKlaJVYc7Uz+LHlIn6s43b/zTT7OwYZfknYmF4CyoSFu0basSLfMuX5Fi+j7zFy4M6JOQXaCv9vAGDdWhCzV8dpSe/frr/HBrEr2edebcOZXyUb+/fu0fTAWawkBAUxhhCjtMADBMB+4CM4V/j1PSRyXdsGlz7TfO4V/g9SEeghuYIwV90x5s+pjSsKGjYcOcxVx2awzN9dn5jeQ8YdIk9Vcx89DreawH5WMqp/lgtGkrA4cMk1Fjx8uoMeN0nYVpPe6hnfOqy30M5nbSlCnaj84101yHqp8+xleG8UkJDvrblfnHx8qr5Erv/QIxZp9+gvxQ/pN6XyX94pUyJenDzeLIAvAaAjsJh4rFS72fXKeeNGjaXF6+9Pfeh5uHG8Qx0BSkO7hcPGPdhesZQG7Q79Kjpw66XXv2+N1y7MQJBTOn9z7XIPXFJ6X4AMXchGoaZzs36M+el+a9z+R2FuyxOJVg2w7kve+8nt9eoE+QG3Wca9fBfXma01RA7/3wQJ++YpcFjoWo2VgQTQGwUFEa0Gdyd+zSVe2YTB7eC8mfxY5FEG99wJR+23/ggNrVkPhZFIkCFw7oI0ExSZms2AOdhefDuHBu6vQZYhT2Bw8fVnMC2oRQhTrWfPTIHTJiZLqohZgiPjfoIzHhR4Kk6QZMFi7MWbwzJiZ34Xq0BytXr5Yx4ycoMDGG/1i82DOuRnaBPow+YwibvtNxyt3ezPw/eNhwlQyXrfT3SfGqE5su6w2A8/TpM79LMBPhcQ1NDVjAQAHqMILuwtpGXAMn6GMKxFuc64NpVtx18X9mQN/Y9GkTz49LqKnzzus52XkM+uI8iXd7oAKzgxYKQYPAXU7mhx0+Q4aP1DXbbOkNVE+g46xV02bM0H5kXXAXxiF93LRlK4HRp7BuwayhiXHj1LoNG3Tt+qpAH+/9/FGJ8kPFT6Cft0xVyQrQR904YtRo7WBswe4Ckd2gj1SHVz/AQWc4CxPDDfp4SdKJw0aOUjWm83qczlDRukEfZgN72Oat/lGUUKGjDnaCvlkokA4It+gsbPECwN2gj5MiHDfqQmdBJYjHfGZBH4kFCbBeo8bO6vU3XH7gLXvhgT42ZkAOZzsn4POAJctXqAbAgD7HNmzarH08Y/ZsBZWlK1ZKoY9aArzT0cZg/+QemCQmPY6ClFu3bqujHbbJQAVQIuoV/ey2xbK4EjeCc2wDMuVqaqqOIfoBpiFYoQ62xSFZs+vAXQivGwz0WRjc2hJ3HfwfKAyvl6TPWGHrGVKcoZWpE3MH28V4Z7e5w1xjvpG+cJbDkxmGE8bTXaAvph/MLMy/rCq8A74YzNkzZzNuow3WniXLl2vf0H/GRhvoehZ85h47Fdw2Y5xUEVCg6Y0bN7WK27fvqJNw3nwFfKpgUzf2fjzDnaCPPwtbVhkLbL2NpIQL+jDRCDOMAYrbe38aEfpi48TtBxJJWzJyLXOIrcow815aXVMnZt56jZro+mCc+Mw5fCIYgyrpf4zjYc6F+w0DzzpAP/42bXo6QY2tlpzDCdYwHHw3a91G2KrrdAbmmcbnKRDoz5g9R9sL3XN6+ei9T3CeJMlXsab8mA2gDxGQklAxMhmcBW9TiO8GfWxtbTt20v31dx0mARgA7Opu0GegYPNG/e6Untmag2MUz3CDPiABM4CWwIAaAxCVNou7E/Q5n5BcS4HOycHqIJ83T+t3g/7WHTv0nWvVb+gXwAgbIc/NLOjzntgTAVYYK1Pg9FG9Zxb0DSNFZD3nQqrmmo/g6wR9no9qEceztevXK01ZRLGrm33JOFmyEF27dt1PCqK/2SIH4DrfxbyT+Z40Zapeg1aBiW0Kaky2ZkJT6GvKh7//1m06LNgDhwz1u4dr6G/zbvTl5CnTdLHeum27qUK/8TnAJh0M9NEqMM7YyoXEGKhEAvrUwRaxgsVL6BYwZ52oR7FLMx+chffwKuyQAOjYmuZmpLke8wHbKaFj6rXrXlVk6Bj9xM4O5j+SlZlrpjLOG29+cyzSb8YP8x/NF4yeu6CGdxbGGhoUAMFZMKdEVYn1abA4R3vZAgyIz5gzx3m5Cgz0uRP0uYBwuMxLtvl59QfOjV6MV7igz/gsXLKULF+1StvnBH3oiVChuzccO1n8Gp5N/6CVJUIgZiTn/HQ/Dm0I21WhKUyhs7A+MM8yA/rUhyYUp2hMk+75iCaEtYb1xBSYXvCJddOpYWBssruJfg4E+uxQYM3FaTCnF/8te16gXzJW/i+T6n2IwKKJ0wRgjaqayQUnBmjhhOIGffZaMyGR0Oo1biq7du9Wxyfs3UwwN+gzMbHlMlAImINaE7DBaxjpnEHUq/8Av/6AW8ZejScve5HpaGJYM0jwrnaCPjdi10dlh/Pa6nXrdGsJ6sSo2Kra4W7Qh+FAckVFji380OHDgo2bbTbsBMgs6AOOqDWhBbTds3ev7Ni1W4P6AASZBX3qR1pAjT9t5kw5cfKUADRIbdCMSeMGfcAXx0zs6ENH/Kz3wDXD9aMyw//h1Okz6SYhCyP9DTAA6DgC4oUO+DhBgrriU2rpdTgw4R1Nm9p06KjtweTz/Lm/ZoiAQTgQMjbQgKAlwB8C9W3XHr3Ui94MDOoiCBFby7CTnzx1Wp2R0DrF1UwMCvrYh9PiBVSQGbNm6728g9tpMlLQZ/ECrBlL8/5YqHNn0+Yt6qfAeMRRyVkYp2jI2D7EVi7u3713n+4hZiwCwO5FkPs5ZmJpMJfQJGG6grmEqc5MgXHv0LmLjlVMPgQ7oQ/w/eCZoZIUhXo2bZ85Z47Oz+pJyUoT+g4zFHSgX5yFdytdMVqZJph+bMfkEKnToKGCtdsh8OChwz7tAAs8O0GY+2gEC5UomQ700QayDrHuID0SwIv2sAYwzhmPqLXdwBgu6GO6IagRaxtCCoGY8DvAARXplZ0JTodW57uH+xtTKWOOeebFJHrVM2/BH8roOAUvr+voL7S/CD8wtThNQtO5CxZov+Db4gZ9xjHqd9p0MYxgTmhczHgmdgjSPesFO5QAcOYI2/pMYZ1ZumKFri1s/96xc6fOH9ZY5j4MSiDQp14YcDTH+BaBLcwdHAZzWvkE+lEBJP0SWQP6vDjBGAjHiMQEl4rNCekLSZKAGm7bC1vjCGJRtHRZHRzY4Fi0cfxygz71Q2C2yjAoGDB0Al60HON/JomzIOFNnjJVQZvBx55SgiugAWACuUGfCTrvjz+E4BEwC7QZNTWOPwA5XrruwjvBcecvWkwZCRiKSVOnKTBmFvR5FvZGpGukChgkGBDs0epYkkmbPvUDIDi0UT/742kzDm3siGDRdIM+98C5I+lAe7PfFs6afelIwdih0Ua4C4whJhdU0DAUcM68mxtwDh89qv4B2IhhzlB/w4Rg2nGr5cwzABgC63CdvkuJUro9Dh8BFnRTWChmzp4j1WomKj0BVQBjwJChukgHk/SpA4aCrXI8Ax8W3gFG0lkiBX3uhUFG5Vm8bDl9X+on5gELuzNgE9eisobObOdi7tBvtAPVPWBuVMLONvGb8Q2TwtZL+oB5yhxiTji3qbrvC/d/Fljs5dVrJik40yaYfd5j0VL/ffTh1um8jjEF6KE2BvQYG7w/cxmHR3dh+2CTFi2VyWMM0R7mNv3l9j2ANjhqElCpSKnS2r+VqtVQZh4p0C3p8yyYXIANyZe1hfpxqsQcgFkGwSSjoE/9MJN4qDNHmIcwzKwvBLpZvnKVT4Plfu9w/8esBzgyb9z08KoDPxvmCvRzv5fX9cxV5jvzmLajqWE9RfpGSHKDPgwcY5o2se6FU67fvKnAz7w3awWMWofOXQXNnLsgnIBHMNlgDOsdQgwMED5jgUCfNYp8B4w11gwEJeYOAm5OKw7QT0yv3i9dVb71A/1C2n4Tex/wjbTgNMH2IvaYsjihduvZp1+aQ53LGYmBQ8Q37Kvsw1U18ZMnug+VWNOXLvvvNactDE4kUiRegsNgmyTgBlKvM5CMaTcqNrQOtAdOEIcyQAsgcIKBuR4OlZCkbLfCC/38hYs6AJlsOKq5C9wjtlgkLWyqXM8AYZsfW6mcak0mDfW69wJTJypL1O3YEJ0FGrG40HacuXh3gItQq4QkBkhNgcnB/wA6GpW2OQfDhKRD+5yF94Vr37f/gNaH6u3uvftKZwAOSdKrILnTd3Dv0In+Q4omyQ4BZrxUntTD+zEZ6V8kcSQwp6RvngVw8S7US+An6nU7uplrzTemBa6jH7iPRQS7rdumiIaDPoCeStNTpzT2Aypk/D3w7whU6A/Ajb7lWt4BtbqzsGAxNnFgdBZAi3708nuBXvQlc2HHrl3KXKA1cTNE1EefIVkjGdFvzAXag8bDOd6czza/eQ7jibFv+oA+91JFm3si+UaFihSk42n3bn0f5nFWeZnTl4xXs2YwRrGrMyfchXGl73r4sNKUucdcpY1ehb6lL3Wu7dmjGivswNAZenm9A/MMiY8tv8xH7oUBxb+EfnKXcCV9c5/Os/v3ZdXadVI1oab2mYkvYK7J6DfBdRi/zAWvtrrrhaGsULlKRNItbTXzmDFKWGn6kPWOOepkNpgvzBvaFGquO9tG3zPvWT+p8+ixY+mcdM319DFrEN7i4eYAABDnSURBVGsD8wwBg3WZD/MhmI8G44YQzqx3Zu67/XDMc77kt8+mXzDKBfplq8l3pQD9Kp/U+99mHvTdL8tgKhdTWTm8rJAm3PUzsYlRjoQGOGRHoZORvCZP9bcPZsezbJ2WAl8zBfDcZq98qI8XI/g10CVS0Dfv7LTpm2Of85sdOkjTRBK1JWdTwAf6eO77OfL5QN+p3vcHfdS1eC3itR1IcnO+PrZEpG64n2vXbwhb47DRk5QGOwtcVmYKEjjb4+AcqR9OddbcuaqiwaEmKxYKVNPYI69eTVWJAs4Tx6eYqnEqSWWm/fZeS4F/OwUw/2GiCvUh9sbXUgg9i8aMtRSbNWrtcG3oOYEGrP34KdRITE6nNcsJ7bNt8KdAhkAfNQuOI+yz5sNvt4rU/zFp/2Erx+aDXYusU9i5sIEQchGnt8wWtgNht8ROiE0Fhyz8AHAgcoedzeizcOjCzoPNE7sPtkM8ZQnk4VaZZ/QZ9j5LgX8rBTAzsX0z1CerzA05gc6snWz3NOspe9S9zDY5oa1ebSCnA7EfAoVY9rrHHvtyFIgQ9AtnqqXYRfByxCsaxyQkZjzmvWxhGXmQ2lTOnFXbC/UDxNiRscVmVotg2nPpyhX1NEW7wbY0bDepqdfCsnmZOuy3pYClgKWApYClwJegQJ6ClVKkQEyyBuYJrd7PHOh/iRe0z7QUsBSwFLAUsBSwFEijQBrof4zG5wP9cjXk+9LGkc9p07egbweOpYClgKWApYClQG6lQJ6CMSlSIFzQ/+i9n1tf1rbbUsBSwFLAUsBS4N9MAT/Qz28i8gWS9L9J897/NxPMvrulgKWApYClgKVAbqVAOtDPR+z9gKBfMLe+p223pYClgKWApYClwL+eAulBv0KC/FDWy6YfJf/zTWDQJ8gO3vOhvOTZK8/WNjz237x9q79D3ZORXqJOnhFqKyHX0XbaQvvZKsO+2aws7GOlXn3nN2/0nYPFDOAcwUl8179/H5KuWdleW5elgKWApYClwNdJgQCgX93DkS8w6LMVj9jkxEu/ey8tN7EXuQi5uHjpUo1Nzv554kUTT5zEFV6x2L3qCOcYIE64S/bqE6sfQPcqgCtbBon/TDSpctExGruaWP2ELM0KZoRwkqT7rJlSW2PVk4EuuU49DcRBnGf3M9heOHvePEmuW09jDMTExknTlq11+6FXKFGv97LHLAUsBSwFLAUsBbwo4AP9AhUTBZt+PpX000A/r18YXm/QJxY1ySxIbEEihECgT6xkouUR1Ib88iSEWLh4sd5LsgVy3mdFFCriqy9askQZCrIiBQN9kosk1qqjmf7IAb1+40aZNmOGJsggeU6g5C1ehPQ6RsxqsnaVja4ko8eN1wxOfyxaLN1799VsTKTrdMbSf/T4sQwYPFRD+pKoY8Xq1Zrkhax20JckOsHSznq1wR6zFLAUsBSwFLAUMBRID/rlUe+7QL9YjPynSEU/9T7gs2T5cgXIRs1bCJnDAFkv0EeaJRAPkjfgTpIKUwDpwcNHaHS7DRs3mcPpvomb/9vUaemSlDgvJLwvgEpaRgCTzHmBQB9tANm4yKZGwCATRpjjW7Zv19Swrdt3TCeJO58X7DeqeUIM04Yt27apqt5cj8aDjEzE6zfhRP/+5x9ZtHSZRiv8fdYsv8QoT5481brIHuiVBMjUa78tBSwFLAUsBSwFglHAD/QL4r1fPt4H+t+VrCp5SbjjAfoLlyzVFJMNmjYTJNQJkyYHBH1Avv/gwVImKlqzf7kbhISPBgCQDKTmnzv/D1Vz3wtgPgCsCZFLOkOyI8FokGo2EOiTJIfUieRKdqvYUfuT0pckPeQHyEg5e+685swmDa27fuoj+1xs9Xg1LfA/WeNgnMhSZRgQ53PJI4C0//PYsX4MhPMa+9tSwFLAUsBSwFIgGAX8QB/1/g/la3wE/Thflr1vilWS/xb1V++TZx1VtXFII21tIEkf6Z+c0u07ddFUuu4G4WzXoUtXtacDbl6FPNnYtgOBPkBJHuYz5875QDYY6GNiILHFhk3e2oUly5arlI5JggJjQyapUB9S+VIA+ps3b2kaXj3g+kNSIPIQDB0xUs/Qbnwc+vQf4Gu/8xZyE/D+5GqnLbZYClgKWApYClgKREqBdKD/SdJPA30k/W+Kxch/i/iDPmDvlGCDgT4Z70iug50atbe7ANiAa7HSZTW3vfs8/4cCfa5xS8jBQL9Bk2aqXif/sVchnzKOiaj4KbxfUp16klSnbtBPw2YtvKrzO8bugAWLFqkqf+PmzXqO/N+FipeUaTNm+l1r/iHBCCmCS5av6GlCMdfZb0sBSwFLAUsBS4FAFEgD/agkwZGPPfrhgr67wmCgf+VqqqrSucYrEx0MxIzZszXF7uGjR91V6//hgL77xmCgXz0xSYqULC04InoV/APyFSmqkjXnz5w9K1u2bVf7PDb6QB9MC6EKSXvwJSA18YMHD/VyzA2YE9CeeBWYpZ/HjJUfCxWRW7dve11ij1kKWApYClgKWAoEpUCegtEpUiCbQf9q6jWVmkePn+CZMjIN9OcIXvxHjx3TBpeJipES5cr7PgWLlZAfChXWVLbmOClu2e4XqAQD/Zq1akvhkqV1a57X/ZcuX9b2NGjS1Ot0ho+lpqaqWj8uIVHf1WhL9u7br0wP2/W8ioL+2HFSoGhxMSYEr+vsMUsBSwFLAUsBS4FAFEgP+hWMI19w9b67wmCSPrmxK1SqotvzXr565b5V1fJjxk9QJ7wzZ8/p+bHjJ8jPY8b5PuwQqFg5VnNOm+Njxk3QffbpKvx4IBjod+jcRQoWLyn7Dx7yvP3g4cPKqLBdjoKzIdvr2Ecf7PPokbe9/fXrN7J+4yYpGxUj8UkpctzlIHjs+And3TBm/EQ/s4lpHM/HKTE6Nk7IOW6LpYClgKWApYClQKQU+Cyg//jxE2nTvqMk160vOKS5y7t376Vxi5bSuHnLgFJsVqv3FyxcpN797H33Kr/PnqMmCRz6KJOnTtP9/GzzC/Zp0bZduuru3b8vE375VapUryG9+vVXBz/3RcQEqNe4iTRs2twT9AH6WvUbCMzKs+fP3bfb/y0FLAUsBSwFLAVCUiA46H/csuflyOeuOZikz3a6uQsWqGoeu7i7nDx1Ss+xd93L5s/1WQ36f/75QEpXjJLmbdoKEQWdRT3lW7UWzAcmeA6+BgQUCvVZs269sypBc9G6fQfBh2D+wkXy/PkLv/PmH8L0EsOAbXlECXSXbdt3SPGy5WXRkqXpHBbd19r/LQUsBSwFLAUsBbwo8FlAnwdjh0ZFT/hdp2qbLXqxNeIlIaW2XLnivV2P+7Ma9Klz1dq1gq8ApgUTMAjzw8RfJ0vhEqVk1Zq1XjQL6xh+CtxfvlJlDcGL+j5UHgBoUa1mkhCEh33+ppy/cEH9ANiyZ+35hir221LAUsBSwFIgUgqkA/18Tpt+Okm/gNaP5L50xQrp3a+/7xOfnKJheDt17e47xh505xY9tsch8WJLJ/58QkotKVq6jFSoHCuHjhwJ2vYly1ZIp27d5c8A9myC+jjbw2/iBrD3vUfvvnqu74CBGsPePAgQnjj5N906x575Fm3aSZXq8Spt/zJ5SqYkanwCYqrGKU2I64/joNeHbYzOcujoUbX7s8Wxdv2GqtKHXtDq1Bnv7YXO++1vSwFLAUsBSwFLgUAUiAD0CcObBvrv//pLVdUdu3SVYJ9effunixWPKn3OvAUCAPcbNEimz5glJJ7JbHn85EnQttBOmIblq1b5PYpkPGyXGzl6jHTp0VNItrN7z17PXQZ+N4b45+LFSzJw6LCQbZrusS+fYEYzZs3WaH0kAyIvgHXeC0Fwe9pSwFLAUsBSICQF/EA/f8UECSzp+8feD1mzvcBSwFLAUsBSwFLAUiBHUSAw6JeKExN7P82Rz4J+juo52xhLAUsBSwFLAUuBCCmQDvR9Efl8oF9ZvikWLf91ZdmL8Dn2cksBSwFLAUsBSwFLgS9MgTwFo5N9EflIuJOPLHtlqsv3FvS/cNfYx1sKWApYClgKWApkLQVcoJ8QBPT9E+5kbTNsbZYClgKWApYClgKWAtlNAQv62U1hW7+lgKWApYClgKVADqFAmKBvUuumbdnLIW23zbAUsBSwFLAUsBSwFIiAAulA/8dyXjZ9C/oR0NReailgKWApYClgKZAjKRAm6BvvfSvpZ2cvknRn8dJlsmff/mx5zOs3b2T9pk2yYdMmv0iJ2fKwMCr98OFvWbl6jcyZN9/34f/cVF68eOlru77H/AVy4JB35kbzXjt27dIgUffv3zeH7HcupQDJwrbt2Ckr16yRFy9ffrG3ePDgoaxdv0GePn36xdpgH5w7KPAR9BOlQMVEIThPekm/inzap29BPzu7deOWLVKqfEXp0advtjyGlMB1GjaSOg0be2Y7zJaHBqmUMMgkI4pLSBRCFRcoWlyq1IgPckfOO0UGRdrPh7TJhH4mEmOw0r5TZ82lcPjI0WCXffZzHz58kD379smhw0dyBFP42QmQgQc+f/5c2nToKFXja8qt27czUEPW3HL85ClJqlNXLl8NnL8ka55ka8ntFAgD9J379NNAnzCxP3XtpvnfS1eI0t9kibMlcxT42kD/yZMnsmDRYmndvqNUrlZdoqtWk4bNWsj0mbN8YYVfvHgh5E04e+6c1G3UJNeBPomVaD+fhYuX5GrQJ09GSt360qpde7l7917mBvO/5O6sAH3WznETJ/rWUxJuvXr1KiwKPnn6VObMny91GzWWQiVKSat2HVR7xri0xVLAiwIeoF8j5D7927dvS+MWLWXQ0OFy7MQJuXzlithB5kXeyI59LaAPkGOmINkREvyAwUNUBf77zFma34BMi9GxcbJwyVLf4nbj5i1p2Kx5rgN9Zw+TtTE3S/qYf6onJms2zDt3Mp8Pw0mbr/V3VoA+a+fNW7d0Le3Wq7fkL1pcmEPByj///CPHT55U6b5cTCVJqlNPipQsrVk6S5Qrr8ct4xaMgv/ec36gn68C6v3wQR+JLdJy48ZN2bJtu6xZt04z6z169FhOnzkj6zZs0IFv6iPFLbbPPXv3CVn9nAWAwPZ76vQZ52H9/fjxY9m3/4CsXrNWNm3ZKleupsq169dl9dp1cvT4cb/rUa9u3LxZ7t//0+/4kydPtY20011QSZ88dVrWb9woazdskKPHjgtq8527dsuOXbv9Lr985ara+s6d/5Qmlwt4H+5bv3GTnx3QCfqvXr+Ww0ePqp1u3YaNcubsuXR0IMkQbdx/8KDfc/nnauo1TR186fIV3zmnev/Bgwdy7vwFff+169fLwUOH5e3bd75rzQ+kEFL+0g/rNm7UOrFhcgx1sLsAHKPGjlN196QpU4X+cJdbt27L6HHjlSmYMv13ZRgjBX2SNO3avUdWr1un/UD7kXqCFejFdfQdaY+3bt8h9NG7d5/em8X02fPncubcOdm+Y6fSf8269bJ7776QiaEiBX3U6KnXrsnmrdt0PpD4ibHnVRgzMNf0N23fsHmznD5zNl1CK+e9N2/e0jHJ2Mfey3y6cPGSn+qelNI8d8Wq1bJo6VIpF11JVdUzZ8/RYxynv589e+asOsO/kWCPHT+u4w56MUdDvUckD6Mvecct27bpnGfMHjpyVJ4+Td9+xu/V1FTZtn2H0hR/F+Z2ICmbsUGa642bt8ia9etl/8FDgnknmHr/9evXOtfxo6EfGHOsR4GEpNHjJ4QF+s+fv5Duvfsoo4xK36j3eXfmRbnoGE0ZHug5kdDUXvt1UeD/Ae3SdVqn10V1AAAAAElFTkSuQmCC\" alt=\"\"></p> \n<p>　　而它又在这个过程干了什么呢？</p> \n<p>　　　　1.合并段表</p> \n<p>　　　　　　我们在上方提到，汇编之后就会生成相应的 .o 文件，而这个 .o 文件又被分为几个段，在链接过程中就会把相同的段通过某种规则合并起来。</p> \n<p>　　　　2.符号表的合并和定位</p> \n<p>　　　　　　将所有文件的符号汇总在一起，在配上相应的地址。</p> \n<p>　　　　3.重定位</p> \n<p style=\"margin-left: 60px\">　　若不同源文件出现了相同的符号，比如说我们在一个源文件里定义一个函数，在另一个源文件里用extern来声明这个函数，所以在符号表汇总的时候会出现两个此函数的符号，但应其中一个是非法地址（如extern的那个）所以最终只留下一个此符号。</p> \n<p>&nbsp;<img src=\"http://localhost:9090/blogImages/2021/03/27/7cb7a670-ce7d-4c5f-b739-35fe3c7d9925.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;　　　也就是说<strong>，在链接过程中，会把目标文件和链接库（库函数信息）链接起来，最后生成可执行程序。</strong></p> \n<p>&nbsp;　　　注意：</p> \n<p>　　　　　　比如所，我们使用了一个我们并未定义的函数，而编译器就是在这一步才能看到错误。</p> \n<p>&nbsp;</p> \n<h3>5.总结</h3> \n<p>　　这便是程序的翻译环境，再来简练一下：</p> \n<p style=\"margin-left: 60px\">1. 预处理 选项 gcc -E test.c -o test.i 预处理完成之后就停下来，预处理之后产生的结果都放在test.i文件中。</p> \n<p style=\"margin-left: 60px\">2. 编译 选项 gcc -S test.c 编译完成之后就停下来，结果保存在test.s中。</p> \n<p style=\"margin-left: 60px\">3. 汇编 gcc -c test.c 汇编完成之后就停下来，结果保存在test.o中。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/8f8635f5-27bd-4e27-9e1c-d289c33b520f.png\" alt=\"\" loading=\"lazy\"></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<h2>二.程序的运行环境</h2> \n<p><strong>程序执行的过程：</strong></p> \n<p style=\"margin-left: 30px\"><strong>1. 程序必须载入内存中。在有操作系统的环境中：一般这个由操作系统完成。在独立的环境中，程序的载入必须 由手工安排，也可能是通过可执行代码置入只读内存来完成。 </strong></p> \n<p style=\"margin-left: 30px\"><strong>2. 程序的执行便开始。接着便调用main函数。</strong></p> \n<p style=\"margin-left: 30px\"><strong> 3. 开始执行程序代码。这个时候程序将使用一个运行时堆栈（stack），存储函数的局部变量和返回地址。程序同 时也可以使用静态（static）内存，存储于静态内存中的变量在程序的整个执行过程一直保留他们的值。</strong></p> \n<p style=\"margin-left: 30px\"><strong> 4. 终止程序。正常终止main函数；也有可能是意外终止。</strong></p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>&nbsp;</p> \n<p>----参考：《程序员的自我修养——链接、装载与库》</p> \n<p>&nbsp;</p> \n<p><strong>|------------------------------------------------------------------</strong></p> \n<p><strong>到此，对于程序的运行环境的简易了解便到此结束!</strong></p> \n<p><strong>因笔者水平有限，若有错误，还望指正！</strong></p> \n<p>&nbsp;</p> \n<p>词法分析产生的记号一般可以分为如下几类：关键字、标识符、字面量（包含数字、字&nbsp;符串等）和特殊符号（如加号、等号〉。在识别记号的同时，扫描器也完成了其他工作。比&nbsp;如将标识符存放到符号表，将数字、字符串常景存放到文字表等，以备后面的步骤使用。有一个叫做lex的程序可以实现同法扫描，它会按照用户之前描述好的词法规则将输入&nbsp;的字符串分割成一个个记号。因为这样-个程序的存在，编译器的开发者就无须为每个编译&nbsp;器开发•个独立的词法扫描器，而是根据需要改变词法规则就可以了。另外对T一些有预处理的语言，比如C语言，它的宏替换和文件包含等T作一般不归&nbsp;入编译器的范围而交给一个独立的预处理器。</p>', NULL, '2021-03-27 00:18:25', 0, NULL, NULL, 'https://www.cnblogs.com/guguguhuha/p/14575316.html', 0, NULL);
INSERT INTO `t_blog` VALUES (293, 'java集合【12】——— ArrayList，LinkedList，Vector的相同点与区别是什么？', '<p></p>\n<div class=\"toc\">\n <div class=\"toc-container-header\">\n  目录\n </div>\n <ul>\n  <li><a href=\"#特性列举\">特性列举</a></li>\n  <li><a href=\"#底层存储结构不同\">底层存储结构不同</a></li>\n  <li><a href=\"#线程安全性不同\">线程安全性不同</a></li>\n  <li><a href=\"#默认的大小不同\">默认的大小不同</a></li>\n  <li><a href=\"#扩容机制\">扩容机制</a></li>\n  <li><a href=\"#迭代器\">迭代器</a></li>\n  <li><a href=\"#增删改查的效率\">增删改查的效率</a></li>\n  <li><a href=\"#总结一下\">总结一下</a></li>\n </ul>\n</div>\n<br> 要想回答这个问题，可以先把各种都讲特性，然后再从底层存储结构，线程安全，默认大小，扩容机制，迭代器，增删改查效率这几个方向入手。\n<p></p> \n<h2 id=\"特性列举\">特性列举</h2> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/dcea8eca-c3bc-4035-af4e-0c164f7f5c0a.png\" alt=\"\" loading=\"lazy\"></p> \n<ul> \n <li><code>ArrayList</code>：动态数组，使用的时候，只需要操作即可，内部已经实现扩容机制。 \n  <ul> \n   <li>线程不安全</li> \n   <li>有顺序，会按照添加进去的顺序排好</li> \n   <li>基于数组实现，随机访问速度快，插入和删除较慢一点</li> \n   <li>可以插入<code>null</code>元素，且可以重复</li> \n  </ul> </li> \n <li><code>Vector</code>和前面说的<code>ArrayList</code>很是类似，这里说的也是1.8版本，它是一个队列，但是本质上底层也是数组实现的。同样继承<code>AbstractList</code>，实现了<code>List</code>,<code>RandomAcess</code>,<code>Cloneable</code>, <code>java.io.Serializable</code>接口。具有以下特点： \n  <ul> \n   <li>提供随机访问的功能：实现<code>RandomAcess</code>接口，这个接口主要是为<code>List</code>提供快速访问的功能，也就是通过元素的索引，可以快速访问到。</li> \n   <li>可克隆：实现了<code>Cloneable</code>接口</li> \n   <li>是一个支持新增，删除，修改，查询，遍历等功能。</li> \n   <li>可序列化和反序列化</li> \n   <li>容量不够，可以触发自动扩容</li> \n   <li>**最大的特点是：线程安全的*，相当于线程安全的<code>ArrayList</code>。</li> \n  </ul> </li> \n <li>LinkedList：链表结构，继承了<code>AbstractSequentialList</code>，实现了<code>List</code>,<code>Queue</code>,<code>Cloneable</code>,<code>Serializable</code>，既可以当成列表使用，也可以当成队列，堆栈使用。主要特点有： \n  <ul> \n   <li>线程不安全，不同步，如果需要同步需要使用<code>List list = Collections.synchronizedList(new LinkedList());</code></li> \n   <li>实现<code>List</code>接口，可以对它进行队列操作</li> \n   <li>实现<code>Queue</code>接口，可以当成堆栈或者双向队列使用</li> \n   <li>实现Cloneable接口，可以被克隆，浅拷贝</li> \n   <li>实现<code>Serializable</code>，可以被序列化和反序列化</li> \n  </ul> </li> \n</ul> \n<h2 id=\"底层存储结构不同\">底层存储结构不同</h2> \n<p><code>ArrayList</code>和<code>Vector</code>底层都是数组结构,而<code>LinkedList</code>在底层是双向链表结构。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/ddca41a9-254a-4ffd-9d6c-050efe58271f.png\" alt=\"\" loading=\"lazy\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/824faf53-e526-4a9c-9a47-6a105c9fa735.png\" alt=\"\" loading=\"lazy\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/5488001e-a163-4a4e-8c33-b3dfd8114879.png\" alt=\"\" loading=\"lazy\"></p> \n<h2 id=\"线程安全性不同\">线程安全性不同</h2> \n<p>ArrayList和LinkedList都不是线程安全的,但是Vector是线程安全的,其底层是用了大量的synchronized关键字,效率不是很高。</p> \n<p>如果需要ArrayList和LinkedList是线程安全的，可以使用Collections类中的静态方法synchronizedList(），获取线程安全的容器。</p> \n<h2 id=\"默认的大小不同\">默认的大小不同</h2> \n<p>ArrayList如果我们创建的时候不指定大小，那么就会初始化一个默认大小为10,<code>DEFAULT_CAPACITY</code>就是默认大小。</p> \n<pre><code class=\"language-java\">private static final int DEFAULT_CAPACITY = 10;\n</code></pre> \n<p>Vector也一样,如果我们初始化,不传递容量大小,什么都不指定，默认给的容量是10：</p> \n<pre><code class=\"language-java\">    public Vector() {\n        this(10);\n    }\n</code></pre> \n<p>而LinkedList底层是链表结构,是不连续的存储空间,没有默认的大小的说法。</p> \n<h2 id=\"扩容机制\">扩容机制</h2> \n<p>ArrayList和Vector底层都是使用数组<code>Object[]</code>来存储，当向集合中添加元素的时候，容量不够了，会触发扩容机制，ArrayList扩容后的容量是按照1.5倍扩容，而Vector默认是扩容2倍。两种扩容都是申请新的数组空间，然后调用数组复制的native函数，将数组复制过去。</p> \n<p>Vector可以设置每次扩容的增加容量，但是ArrayList不可以。Vector有一个参数capacityIncrement，如果capacityIncrement大于0，那么扩容后的容量，是以前的容量加上扩展系数，如果扩展系数小于等于0，那么，就是以前的容量的两倍。</p> \n<h2 id=\"迭代器\">迭代器</h2> \n<p><code>LinkedList</code>源码中一共定义了三个迭代器：</p> \n<ul> \n <li><code>Itr</code>:实现了<code>Iterator</code>接口，是<code>AbstractList.Itr</code>的优化版本。</li> \n <li><code>ListItr</code>:继承了<code>Itr</code>,实现了<code>ListIterator</code>，是<code>AbstractList.ListItr</code>优化版本。</li> \n <li><code>ArrayListSpliterator</code>:继承于<code>Spliterator</code>,Java 8 新增的迭代器，基于索引，二分的，懒加载器。</li> \n</ul> \n<p><code>Vector</code>和<code>ArrayList</code>基本差不多，都是定义了三个迭代器：</p> \n<ul> \n <li><code>Itr</code>:实现接口<code>Iterator</code>，有简单的功能：判断是否有下一个元素，获取下一个元素，删除，遍历剩下的元素</li> \n <li><code>ListItr</code>:继承<code>Itr</code>，实现<code>ListIterator</code>，在<code>Itr</code>的基础上有了更加丰富的功能。</li> \n <li><code>VectorSpliterator</code>:可以分割的迭代器，主要是为了分割以适应并行处理。和<code>ArrayList</code>里面的<code>ArrayListSpliterator</code>类似。</li> \n</ul> \n<p><code>LinkedList</code>里面定义了三种迭代器，都是以内部类的方式实现，分别是：</p> \n<ul> \n <li><code>ListItr</code>：列表的经典迭代器</li> \n <li><code>DescendingIterator</code>：倒序迭代器</li> \n <li><code>LLSpliterator</code>：可分割迭代器</li> \n</ul> \n<h2 id=\"增删改查的效率\">增删改查的效率</h2> \n<p><strong>理论上</strong>，<code>ArrayList</code>和<code>Vector</code>检索元素，由于是数组，时间复杂度是<code>O(1)</code>，在集合的尾部插入或者删除是<code>O(1)</code>，但是其他的地方增加，删除，都是<code>O(n)</code>，因为涉及到了数组元素的移动。但是<code>LinkedList</code>不一样，<code>LinkedList</code>不管在任何位置，插入，删除都是<code>O(1)</code>的时间复杂度，但是<code>LinkedList</code>在查找的时候，是<code>O(n)</code>的复杂度，即使底层做了优化，可以从头部/尾部开始索引（根据下标在前一半还是后面一半）。</p> \n<p>如果插入删除比较多，那么建议使用<code>LinkedList</code>，但是它并不是线程安全的，如果查找比较多，那么建议使用<code>ArrayList</code>，如果需要线程安全，先考虑使用<code>Collections</code>的<code>api</code>获取线程安全的容器，再考虑使用<code>Vector</code>。</p> \n<p>测试三种结构在头部不断添加元素的结果：</p> \n<pre><code class=\"language-java\">\nimport java.util.ArrayList;\nimport java.util.LinkedList;\nimport java.util.List;\nimport java.util.Vector;\n\npublic class Test {\n    public static void main(String[] args) {\n        addArrayList();\n        addLinkedList();\n        addVector();\n    }\n    public static void addArrayList(){\n        List list = new ArrayList();\n        long startTime = System.nanoTime();\n        for(int i=0;i&lt;100000;i++){\n            list.add(0,i);\n        }\n        long endTime = System.nanoTime();\n        System.out.println((endTime-startTime)/1000/60);\n    }\n\n    public static void addLinkedList(){\n        List list = new LinkedList();\n        long startTime = System.nanoTime();\n        for(int i=0;i&lt;100000;i++){\n            list.add(0,i);\n        }\n        long endTime = System.nanoTime();\n        System.out.println((endTime-startTime)/1000/60);\n    }\n    public static void addVector(){\n        List list = new Vector();\n        long startTime = System.nanoTime();\n        for(int i=0;i&lt;100000;i++){\n            list.add(0,i);\n        }\n        long endTime = System.nanoTime();\n        System.out.println((endTime-startTime)/1000/60);\n    }\n}\n\n</code></pre> \n<p>测出来的结果，LinkedList最小，Vector费时最多，基本验证了结果：</p> \n<pre><code class=\"language-txt\">ArrayList:7715\nLinkedList:111\nVector:8106\n</code></pre> \n<p>测试get的时间性能，往每一个里面初始化10w个数据，然后每次get出来：</p> \n<pre><code class=\"language-java\">\nimport java.util.ArrayList;\nimport java.util.LinkedList;\nimport java.util.List;\nimport java.util.Vector;\n\npublic class Test {\n    public static void main(String[] args) {\n        getArrayList();\n        getLinkedList();\n        getVector();\n    }\n    public static void getArrayList(){\n        List list = new ArrayList();\n        for(int i=0;i&lt;100000;i++){\n            list.add(0,i);\n        }\n        long startTime = System.nanoTime();\n        for(int i=0;i&lt;100000;i++){\n            list.get(i);\n        }\n        long endTime = System.nanoTime();\n        System.out.println((endTime-startTime)/1000/60);\n    }\n\n    public static void getLinkedList(){\n        List list = new LinkedList();\n        for(int i=0;i&lt;100000;i++){\n            list.add(0,i);\n        }\n        long startTime = System.nanoTime();\n        for(int i=0;i&lt;100000;i++){\n            list.get(i);\n        }\n        long endTime = System.nanoTime();\n        System.out.println((endTime-startTime)/1000/60);\n    }\n    public static void getVector(){\n        List list = new Vector();\n        for(int i=0;i&lt;100000;i++){\n            list.add(0,i);\n        }\n        long startTime = System.nanoTime();\n        for(int i=0;i&lt;100000;i++){\n            list.get(i);\n        }\n        long endTime = System.nanoTime();\n        System.out.println((endTime-startTime)/1000/60);\n    }\n}\n</code></pre> \n<p>测出来的时间如下，<code>LinkedList</code> 执行<code>get</code>操作确实耗时巨大，<code>Vector</code>和<code>ArrayList</code>在单线程环境其实差不多，多线程环境会比较明显，这里就不测试了：</p> \n<pre><code class=\"language-txt\">ArrayList ： 18\nLinkedList ： 61480\nVector ： 21\n</code></pre> \n<p>测试删除操作的代码如下，删除的时候我们是不断删除第0个元素：</p> \n<pre><code class=\"language-java\">import java.util.ArrayList;\nimport java.util.LinkedList;\nimport java.util.List;\nimport java.util.Vector;\n\npublic class Test {\n    public static void main(String[] args) {\n        removeArrayList();\n        removeLinkedList();\n        removeVector();\n    }\n    public static void removeArrayList(){\n        List list = new ArrayList();\n        for(int i=0;i&lt;100000;i++){\n            list.add(0,i);\n        }\n        long startTime = System.nanoTime();\n        for(int i=0;i&lt;100000;i++){\n            list.remove(0);\n        }\n        long endTime = System.nanoTime();\n        System.out.println((endTime-startTime)/1000/60);\n    }\n\n    public static void removeLinkedList(){\n        List list = new LinkedList();\n        for(int i=0;i&lt;100000;i++){\n            list.add(0,i);\n        }\n        long startTime = System.nanoTime();\n        for(int i=0;i&lt;100000;i++){\n            list.remove(0);\n        }\n        long endTime = System.nanoTime();\n        System.out.println((endTime-startTime)/1000/60);\n    }\n    public static void removeVector(){\n        List list = new Vector();\n        for(int i=0;i&lt;100000;i++){\n            list.add(i);\n        }\n        long startTime = System.nanoTime();\n        for(int i=0;i&lt;100000;i++){\n            list.remove(0);\n        }\n        long endTime = System.nanoTime();\n        System.out.println((endTime-startTime)/1000/60);\n    }\n}\n</code></pre> \n<p>测试结果，LinkedList确实效率最高，但是<code>Vector</code>比<code>ArrayList</code>效率还要高。因为是单线程的环境，没有触发竞争的关系。</p> \n<pre><code class=\"language-txt\">ArrayList: 7177\nLinkedList: 34\nVector: 6713\n</code></pre> \n<p>下面来测试一下，vector多线程的环境，首先两个线程，每个删除5w元素：</p> \n<pre><code class=\"language-java\">package com.aphysia.offer;\n\nimport java.util.ArrayList;\nimport java.util.LinkedList;\nimport java.util.List;\nimport java.util.Vector;\n\npublic class Test {\n    public static void main(String[] args) {\n        removeVector();\n    }\n\n    public static void removeVector() {\n        List list = new Vector();\n        for (int i = 0; i &lt; 100000; i++) {\n            list.add(i);\n        }\n        Thread thread1 = new Thread(new Runnable() {\n            @Override\n            public void run() {\n                for (int i = 0; i &lt; 50000; i++) {\n                    list.remove(0);\n                }\n            }\n        });\n        Thread thread2 = new Thread(new Runnable() {\n            @Override\n            public void run() {\n                for (int i = 0; i &lt; 50000; i++) {\n                    list.remove(0);\n                }\n            }\n        });\n        long startTime = System.nanoTime();\n        thread1.start();\n        thread2.start();\n        while (!list.isEmpty()) {\n\n        }\n        long endTime = System.nanoTime();\n        System.out.println((endTime - startTime) / 1000 / 60);\n    }\n}\n</code></pre> \n<p>测试时间为：12668</p> \n<p>如果只使用一个线程，测试的时间是：8216，这也从结果说明了确实<code>Vector</code>在多线程的环境下，会竞争锁，导致执行时间变长。</p> \n<h2 id=\"总结一下\">总结一下</h2> \n<ul> \n <li>ArrayList \n  <ul> \n   <li>底层是数组，扩容就是申请新的数组空间，复制</li> \n   <li>线程不安全</li> \n   <li>默认初始化容量是10，扩容是变成之前的1.5倍</li> \n   <li>查询比较快</li> \n  </ul> </li> \n <li>LinkedList \n  <ul> \n   <li>底层是双向链表，可以往前或者往后遍历</li> \n   <li>没有扩容的说法，可以当成双向队列使用</li> \n   <li>增删比较快</li> \n   <li>查找做了优化，index如果在前面一半，从前面开始遍历，index在后面一半，从后往前遍历。</li> \n  </ul> </li> \n <li>Vector \n  <ul> \n   <li>底层是数组，几乎所有方法都加了Synchronize</li> \n   <li>线程安全</li> \n   <li>有个扩容增长系数，如果不设置，默认是增加原来长度的一倍，设置则增长的大小为增长系数的大小。</li> \n  </ul> </li> \n</ul> \n<blockquote> \n <p><strong>【刷题笔记】</strong><br> Github仓库地址：<a href=\"https://github.com/Damaer/codeSolution\" target=\"_blank\">https://github.com/Damaer/codeSolution</a><br> 笔记地址：<a href=\"https://damaer.github.io/codeSolution/\" target=\"_blank\">https://damaer.github.io/codeSolution/</a></p> \n</blockquote> \n<p><strong>【作者简介】</strong>：<br> 秦怀，公众号【<strong>秦怀杂货店</strong>】作者，技术之路不在一时，山高水长，纵使缓慢，驰而不息。个人写作方向：Java源码解析，JDBC，Mybatis，Spring，redis，分布式，剑指Offer，LeetCode等，认真写好每一篇文章，不喜欢标题党，不喜欢花里胡哨，大多写系列文章，不能保证我写的都完全正确，但是我保证所写的均经过实践或者查找资料。遗漏或者错误之处，还望指正。</p> \n<p><a href=\"http://aphysia.cn/archives/2020\" target=\"_blank\">2020年我写了什么？</a></p> \n<p><a href=\"https://damaer.github.io/CodeSolution/#/\" target=\"_blank\">开源刷题笔记</a></p> \n<p>平日时间宝贵，只能使用晚上以及周末时间学习写作，关注我，我们一起成长吧~</p>', '\n\n \n  目录\n \n \n  特性列举\n  底层存储结构不同\n  线程安全性不同\n  默认的大小不同\n  扩容机制\n  迭代器\n  增删改查的效率\n  总结一下\n \n\n 要想回答这个问题，可以先把各种都讲特性，然后再从底层存储结构，线程安全，默认大小，扩容机制，迭代器，增删改查效率这几个方向入手。\n \n特性列', '2021-03-27 00:18:26', 1, 1, '集合 java', 'https://www.cnblogs.com/Damaer/p/14583065.html', 1, '2021-03-27 00:26:20');
INSERT INTO `t_blog` VALUES (294, '【安全研究】Domain fronting域名前置网络攻击技术', '<p><strong><font color=\"#FFA500\">出品｜MS08067实验室（www.ms08067.com)</font></strong></p> \n<h3 id=\"千里百科\">千里百科</h3> \n<p>Domain Fronting基于HTTPS通用规避技术，也被称为域前端网络攻击技术。这是一种用来隐藏Metasploit，Cobalt Strike等团队控制服务器流量，以此来一定程度绕过检查器或防火墙检测的技术，如Amazon ,Google，Akamai 等大型厂商会提供一些域前端技术服务。</p> \n<p>下列将会使用Amazon 提供CloudFront (CDN)服务举例。</p> \n<h3 id=\"背景\">背景</h3> \n<p>在虚拟主机中搭建多个网站服务，为了方便我们区分它们，可以 IP+Port名称 等方式去访问它们,但是如果是SSL/TLS的话。根据HTTPS的工作原理，浏览器在访问一个HTTPS站点时，先与服务器建立SSL连接。</p> \n<p>建立连接的第一步就是请求服务器的证书。而服务器在发送证书时，是不知道浏览器访问的是哪个域名的，所以不能根据不同域名发送不同的证书。因此就引入一个扩展叫SNI，SNI是为了解决一个服务器使用多个域名和证书的SSL/TLS扩展，做法就是在 Client Hello 中补上 Host 信息。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/ef1b55d7-7343-4a8f-bc51-ad687ae09119.png\" alt=\"\" loading=\"lazy\"></p> \n<p>域前端的关键思想是在不同的通信层使用不同的域名，是一种隐藏连接真实端点来规避互联网审查的技术。在应用层上运作时，域前置使用户能通过HTTPS连接到被屏蔽的服务，而表面上像在与另一个完全不同的站点通信。</p> \n<p><strong>此技术的原理为在不同通信层使用不同的域名</strong>。在明文的DNS请求和TLS服务器名称指示（SNI）中使用无害的域名来初始化连接，而实际要连接的被封锁域名仅在创建加密的HTTPS连接后发出，在Host头中携带了另一个恶意C2域名（Host头对于检查器是不可见的，但是对于接收HTTPS请求的前端服务器是可见的）。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/76b95c1d-9b8a-47db-ab46-1e245e216790.png\" alt=\"\" loading=\"lazy\"></p> \n<h3 id=\"演示\">演示</h3> \n<p>在Amazon CloudFront是一种内容交付网络服务。它为用户提供了一个全局分布式缓存，用于托管在其服务器上的文件。这减少了客户服务器上的负载，并允许CDN提供来自与请求者数据中心的缓存内容，当客户端连接到CloudFront的时候，其根据HOST头来判断客户端想要请求的域名，在做域前置攻击时候，只要在CloudFront中挑选一个受信任域名，如\"<a href=\"https://docs.telemetry.mozilla.org\" target=\"_blank\">https://docs.telemetry.mozilla.org</a>\"，看起来是一个合法白名单域名，将他做为前置域名来躲避防火墙审查。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/ad2920d7-b27a-4111-bd85-2c11c8e41faa.png\" alt=\"\" loading=\"lazy\"></p> \n<p>在Amazon CloudFront申请一个账户并建立一个CloudFront，在\"Origin Domain Name\"写入自己的C&amp;C控制器域名如Godsong.test，其他设置按自己需求来。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/dce34fba-0bf4-4db6-9537-97cc2feb3501.png\" alt=\"\" loading=\"lazy\"></p> \n<p>申请完毕之后会自动分发一个随机域名 xxx.cloudfront.net样式，将颁发的随机域名指向真实C2服务器，用户访问此域名时候会解析到真实的C&amp;C服务器。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/34850274-19b9-4c0b-aa3b-8056d324b778.png\" alt=\"\" loading=\"lazy\"></p> \n<p><strong>域名前置因为使用了合法前置域名做诱饵，在使用HTTPS链接时，DNS请求的也都是合法域名，而在HOST中请求修改请求指向为我们C&amp;C服务器，相当于请求合法域名之后把流量转发到了中转web上。</strong></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/0aed2543-983a-42b9-8dcd-27df9af8ffc8.png\" alt=\"\" loading=\"lazy\"></p> \n<p>在CloudFront为我分配了一个域名，此域名转发到我的C&amp;C地址上，在原始C&amp;C服务器Web存放了一个名为6.txt记事本，地址为https://www.godsong.test/6.txt。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/548dde17-7504-4217-8c0e-9f57358d16f6.png\" alt=\"\" loading=\"lazy\"></p> \n<p>访问Aws颁发的域名https://d305blu4121c3m.cloudfront.net/6.txt，能返回原始流量转发说明测试成功。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/24528e5a-188b-4142-9654-58f6d423b6d4.png\" alt=\"\" loading=\"lazy\"></p> \n<p>使用合法白名单作为前置域名，修改Host指向为我们的C&amp;C域名。</p> \n<pre><code>wget -U demo -q -O- docs.telemetry.mozilla.org/6.txt --header  \n\"Host:d305blu4121c3m.cloudfront.net\"\n</code></pre> \n<p>如下图就成功利用Mozilla白名单域名技术来隐藏真实恶意流量。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/5defe204-77f4-4939-b417-c16296d26c58.png\" alt=\"\" loading=\"lazy\"></p> \n<p>在实际应用中，可以使用Cobalt Strike ，Empire， Metasploit等工具修改其配置文件来控制流量传输，下文使用Cobalt Strike演示，设置一个Profile扩展并且指定Host头为d305blu4121c3m.cloudfront.net。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/f9f8bcb0-9e60-4912-96c7-c469ed8f1a4f.png\" alt=\"\" loading=\"lazy\"></p> \n<p>创建一个监听器，主机写Cloudfront.net分发域名，监听80端口。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/40477d14-7c0a-45ce-ba4e-74fa9ff21817.png\" alt=\"\" loading=\"lazy\"></p> \n<p>Beacon传输器使用白名单域名如下：</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/7df95f63-271a-4286-9b89-2f05d3fd1a26.png\" alt=\"\" loading=\"lazy\"></p> \n<p>在恶意程序运行后，使用Wireshark 抓取传输流量数据包。如图所示，可以看到相关请求如下，以此方法来隐藏真实C&amp;C服务器地址，在Wireshark 中查看传输流量包Host头也同样指向我们Cloudfront服务器，一定程度上隐蔽了真实攻击机地址。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/015516f4-eee4-4fae-b363-3e2aa7debd03.png\" alt=\"\" loading=\"lazy\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/288e3cc7-09d5-4239-9bfc-54111afa4249.png\" alt=\"\" loading=\"lazy\"></p> \n<p><strong>总结</strong>：Domain Fronting技术因为我们看到的域只是前端服务器域，很难区分那个是正常域名或恶意域名，但实际上恶意流量都要进入被控端服务器，这样的话就会在被控服务器上产生一些恶意指纹，网络数据包的大小和时间，以此方法来观察恶意特征检测等等。</p> \n<h3 id=\"参考文献\">参考文献</h3> \n<p>[1]<a href=\"https://www.sans.org/cyber-security-summit/archives/file/summit-archive-1542139101.pdf\" target=\"_blank\">https://www.sans.org/cyber-security-summit/archives/file/summit-archive-1542139101.pdf</a><br> 图2，图6引用此文<br> [2]<a href=\"http://www.ert7.com/service/knowledge/3999.html\" target=\"_blank\">http://www.ert7.com/service/knowledge/3999.html</a></p> \n<p><strong><font color=\"red\">转载请联系作者并注明出处！</font></strong></p> \n<p>Ms08067安全实验室专注于网络安全知识的普及和培训。团队已出版《Web安全攻防：渗透测试实战指南》，《内网安全攻防：渗透测试实战指南》，《Python安全攻防：渗透测试实战指南》，《Java代码安全审计（入门篇）》等书籍。<br> 团队公众号定期分享关于CTF靶场、内网渗透、APT方面技术干货，从零开始、以实战落地为主，致力于做一个实用的干货分享型公众号。<br> 官方网站：<a href=\"https://www.ms08067.com/\" target=\"_blank\">https://www.ms08067.com/</a></p> \n<p>扫描下方二维码加入实验室VIP社区<br> 加入后邀请加入内部VIP群，内部微信群永久有效！</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/2cbd9ad0-745b-428d-bc50-3e1bf7bb3f0d.jpeg\" width=\"30%\" height=\"30%\"> <img src=\"http://localhost:9090/blogImages/2021/03/27/f3cc89f6-fab9-4ec7-a401-da119e21c40f.jpeg\" width=\"30%\" height=\"30%\"> <img src=\"http://localhost:9090/blogImages/2021/03/27/5cc5712f-9fca-4859-aa96-2279690defab.jpeg\" width=\"30%\" height=\"30%\"></p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/8aed8c22-120a-444b-9e1c-13d547be31cd.jpeg\" width=\"30%\" height=\"30%\"> <img src=\"http://localhost:9090/blogImages/2021/03/27/2aa95f66-89e5-4dac-8455-a3b70da55f52.jpeg\" width=\"30%\" height=\"30%\"> <img src=\"http://localhost:9090/blogImages/2021/03/27/1f6a415e-4e45-4e9d-9145-e04c39d253e0.jpeg\" width=\"30%\" height=\"30%\"></p>', NULL, '2021-03-27 00:18:30', 0, NULL, NULL, 'https://www.cnblogs.com/ms08067/p/14581457.html', 0, NULL);
INSERT INTO `t_blog` VALUES (295, '2021年的UWP(6)——长生命周期Desktop Extension向UWP的反向通知', '<p>上一篇我们讨论了UWP和Desktop Extension间的双向通讯，适用于Desktop Extension中存在用户交互的场景。本篇我们讨论最后一种情况，与前者不同的是，Desktop Extension和UWP保持相同的生命周期，同时规避AppServiceConnection可能被Windows回收的限制，在任意时刻能够反向通知UWP的场景。<br>首先回顾之前总结的四个场景分类：</p> \n<ul> \n <li>执行后立即退出</li> \n <li>等待request，处理完后退出</li> \n <li>一或多个request/response周期</li> \n <li>与UWP相同生命周期，且保持由Desktop Extension发起通知的能力</li> \n</ul> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/17588988-077d-445b-9835-54a294c0b85e.png\" alt=\"\" width=\"535\" height=\"323\" loading=\"lazy\"></p> \n<p>在长生命周期Desktop Extension向UWP的反向通知场景中，有以下特征：</p> \n<ol> \n <li>通知发起方是Desktop Extension</li> \n <li>通过request传递参数</li> \n <li>不关心返回结果</li> \n <li>Desktop Extension和UWP相同生命周期</li> \n</ol> \n<p>示意图如下：</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/89687a56-3477-4057-a224-2dbcb72be2d3.png\" alt=\"\" width=\"542\" height=\"530\" loading=\"lazy\"></p> \n<p>在我们接下来的Sample工程中，将通过Desktop Extension来监听全局键盘事件。在用户按下W, A, S, D四个键时打印在UWP的界面上。其实UWP程序在前台运行的状态下，也是可以捕获键盘事件的。但在最小化的状态下，就只能依靠Desktop Extension来实现了。<br>在上一篇《<a href=\"https://www.cnblogs.com/manupstairs/p/14178931.html\" target=\"_blank\">2020年的UWP(5)——UWP和Desktop Extension的双向交互</a>》中，我们提到了AppServiceConnection在UWP程序处于最小化时，会被Windows回收导致失去连接。而在长生命周期的Desktop Extension中，我们规避该限制的方式，是在每次从Desktop Extension发起通知时，均创建新的AppConnection对象，这一点非常重要。<br>整体的工程结构和之前的三篇保持一致，分为ReverseNotification.FrontUWP，ReverseNotification.Desktop以及打包用的ReverseNotification.Package工程。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/21c74ea3-d9d0-45e1-b1ab-de355831e241.png\" alt=\"\" width=\"540\" height=\"450\" loading=\"lazy\"></p> \n<p>我们先从FrontUWP工程讲起，AppServiceHandler.cs是我创建的帮助Class，用来处理AppServiceConnectoin的Connected和RequestReceived事件。</p> \n<div class=\"cnblogs_code\"> \n <pre>        <span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> OnBackgroundActivated(AppServiceTriggerDetails details)\n        {\n            Connected</span>?.Invoke(<span style=\"color: rgba(0, 0, 255, 1)\">this</span>, <span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> AppServiceConnectionConnectedEventArgs(details.AppServiceConnection));\n            Connection </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> details.AppServiceConnection;\n            Connection.RequestReceived </span>+=<span style=\"color: rgba(0, 0, 0, 1)\"> Connection_RequestReceived;\n        }\n\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> Connection_RequestReceived(AppServiceConnection sender, AppServiceRequestReceivedEventArgs args)\n        {\n            RequestReceived</span>?.Invoke(<span style=\"color: rgba(0, 0, 255, 1)\">this</span><span style=\"color: rgba(0, 0, 0, 1)\">, args);\n        }</span></pre> \n</div> \n<p>而OnBackgroundActivated事件则是在App.xaml.cs中，通过override UWP Application对象的OnBackgroundActivated方法来触发。这里是AppServiceConnection连接的起点，即源头。</p> \n<div class=\"cnblogs_code\"> \n <pre>        <span style=\"color: rgba(0, 0, 255, 1)\">protected</span> <span style=\"color: rgba(0, 0, 255, 1)\">override</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> OnBackgroundActivated(BackgroundActivatedEventArgs args)\n        {\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">base</span><span style=\"color: rgba(0, 0, 0, 1)\">.OnBackgroundActivated(args);\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">if</span> (args.TaskInstance.TriggerDetails <span style=\"color: rgba(0, 0, 255, 1)\">is</span><span style=\"color: rgba(0, 0, 0, 1)\"> AppServiceTriggerDetails details)\n            {\n                </span><span style=\"color: rgba(0, 0, 255, 1)\">if</span> (details.CallerPackageFamilyName ==<span style=\"color: rgba(0, 0, 0, 1)\"> Package.Current.Id.FamilyName)\n                {\n                    </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> deferral =<span style=\"color: rgba(0, 0, 0, 1)\"> args.TaskInstance.GetDeferral();\n                    args.TaskInstance.Canceled </span>+= (sender, e) =&gt; { deferral?<span style=\"color: rgba(0, 0, 0, 1)\">.Complete(); };\n                    AppServiceHandler.Instance.OnBackgroundActivated(details);\n                }\n            }\n        }</span></pre> \n</div> \n<p>以上这些在前面几篇中都有提及，这里不再赘述。在UWP工程的MainPage中，我们记录了UWP进程的process id，Desktop Extension段会读取该值，用以检测UWP process的Exit事件，在UWP被关闭时释放资源。同时通过RequestReceived事件来将Desktop Extension反向通知的HotKey的值，通过HotKeyList绑定显示到UWP的界面上。</p> \n<div class=\"cnblogs_code\"> \n <pre>        <span style=\"color: rgba(0, 0, 255, 1)\">protected</span> <span style=\"color: rgba(0, 0, 255, 1)\">async</span> <span style=\"color: rgba(0, 0, 255, 1)\">override</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span><span style=\"color: rgba(0, 0, 0, 1)\"> OnNavigatedTo(NavigationEventArgs e)\n        {\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">base</span><span style=\"color: rgba(0, 0, 0, 1)\">.OnNavigatedTo(e);\n            Process process </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> Process.GetCurrentProcess();\n            ApplicationData.Current.LocalSettings.Values[</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">processId</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>] =<span style=\"color: rgba(0, 0, 0, 1)\"> process.Id;\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">if</span> (ApiInformation.IsApiContractPresent(<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">Windows.ApplicationModel.FullTrustAppContract</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(128, 0, 128, 1)\">1</span>, <span style=\"color: rgba(128, 0, 128, 1)\">0</span><span style=\"color: rgba(0, 0, 0, 1)\">))\n            {\n                </span><span style=\"color: rgba(0, 0, 255, 1)\">await</span><span style=\"color: rgba(0, 0, 0, 1)\"> FullTrustProcessLauncher.LaunchFullTrustProcessForCurrentAppAsync();\n            }\n            AppServiceHandler.Instance.RequestReceived </span>+=<span style=\"color: rgba(0, 0, 0, 1)\"> Instance_RequestReceived;\n        }\n\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">private</span> <span style=\"color: rgba(0, 0, 255, 1)\">async</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> Instance_RequestReceived(<span style=\"color: rgba(0, 0, 255, 1)\">object</span><span style=\"color: rgba(0, 0, 0, 1)\"> sender, Windows.ApplicationModel.AppService.AppServiceRequestReceivedEventArgs e)\n        {\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> message =<span style=\"color: rgba(0, 0, 0, 1)\"> e.Request.Message;\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">if</span> (message.TryGetValue(<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">HotKey</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span>, <span style=\"color: rgba(0, 0, 255, 1)\">out</span> <span style=\"color: rgba(0, 0, 255, 1)\">object</span><span style=\"color: rgba(0, 0, 0, 1)\"> keyCode))\n            {\n                </span><span style=\"color: rgba(0, 0, 255, 1)\">await</span> Dispatcher.RunAsync(Windows.UI.Core.CoreDispatcherPriority.High, () =&gt;<span style=\"color: rgba(0, 0, 0, 1)\"> { HotKeyList.Add(keyCode.ToString()); });\n            }\n        }</span></pre> \n</div> \n<p>最后不要忘记给FrontUWP工程添加对Windows Desktop Extension for the UWP的引用。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/6b526114-baa1-4e60-b0a9-2574f83c220d.png\" alt=\"\" width=\"527\" height=\"306\" loading=\"lazy\"></p> \n<p>我们转到Desktop这一边，ReverseNotificatio.Desktop是一个WinForms的程序，通过RegisterHotKey这个Win32的API来监听热键。如何实现监听热键我不做过多介绍，具体请参考示例代码。</p> \n<div class=\"cnblogs_code\"> \n <pre>        [DllImport(<span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">user32.dll</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">)]\n        </span><span style=\"color: rgba(0, 0, 255, 1)\">public</span> <span style=\"color: rgba(0, 0, 255, 1)\">static</span> <span style=\"color: rgba(0, 0, 255, 1)\">extern</span> <span style=\"color: rgba(0, 0, 255, 1)\">bool</span> RegisterHotKey(IntPtr hWnd, <span style=\"color: rgba(0, 0, 255, 1)\">int</span> id, <span style=\"color: rgba(0, 0, 255, 1)\">int</span> fsModifiers, <span style=\"color: rgba(0, 0, 255, 1)\">int</span> vlc);</pre> \n</div> \n<p>同时为了使用AppServiceConnection，添加了对Win10 API的引用，主要是WindowsRuntime和Windows.winmd这两个文件。前者通过Nuget添加，后者请参考《<a href=\"https://www.cnblogs.com/manupstairs/p/10150464.html\" target=\"_blank\">迁移桌面程序到MS Store（4）——桌面程序调用Win10 API</a>》。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/394d1a89-7d6f-4c80-bd0e-60ef03bb35d7.png\" alt=\"\" width=\"551\" height=\"179\" loading=\"lazy\"></p> \n<p>我想强调的是，不要在长生命周期的Desktop Extension进程中，去维护一个全局的AppServiceConnection，某软的文档并没有提到细节，但也明确指出AppServiceConnection在UWP进入suspended状态时，可能被释放。我们要做的事情，是在每一次的热键响应事件中，创建新的AppServiceConnection去发送消息。</p> \n<div class=\"cnblogs_code\"> \n <pre>        <span style=\"color: rgba(0, 0, 255, 1)\">private</span> <span style=\"color: rgba(0, 0, 255, 1)\">async</span> <span style=\"color: rgba(0, 0, 255, 1)\">void</span> hotkeys_HotkeyPressed(<span style=\"color: rgba(0, 0, 255, 1)\">int</span><span style=\"color: rgba(0, 0, 0, 1)\"> ID)\n        {\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> key = Enum.GetName(<span style=\"color: rgba(0, 0, 255, 1)\">typeof</span><span style=\"color: rgba(0, 0, 0, 1)\">(VirtualKey), ID);\n\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> message = <span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> ValueSet\n            {\n                { </span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">HotKey</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">, key }\n            };\n\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> connection = <span style=\"color: rgba(0, 0, 255, 1)\">new</span><span style=\"color: rgba(0, 0, 0, 1)\"> AppServiceConnection\n            {\n                PackageFamilyName </span>=<span style=\"color: rgba(0, 0, 0, 1)\"> Package.Current.Id.FamilyName,\n                AppServiceName </span>= <span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(128, 0, 0, 1)\">ReverseNotificationAppService</span><span style=\"color: rgba(128, 0, 0, 1)\">\"</span><span style=\"color: rgba(0, 0, 0, 1)\">\n            };\n            connection.ServiceClosed </span>+=<span style=\"color: rgba(0, 0, 0, 1)\"> Connection_ServiceClosed;\n\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> status = <span style=\"color: rgba(0, 0, 255, 1)\">await</span><span style=\"color: rgba(0, 0, 0, 1)\"> connection.OpenAsync();\n            </span><span style=\"color: rgba(0, 0, 255, 1)\">if</span> (status ==<span style=\"color: rgba(0, 0, 0, 1)\"> AppServiceConnectionStatus.Success)\n            {\n                </span><span style=\"color: rgba(0, 0, 255, 1)\">var</span> response = <span style=\"color: rgba(0, 0, 255, 1)\">await</span><span style=\"color: rgba(0, 0, 0, 1)\"> connection.SendMessageAsync(message);\n            }\n        }</span></pre> \n</div> \n<p>不能保存已创建的AppServiceConnection来重复使用，有时会造成不便。但这也正是我将Desktop Extension分为4个场景的原因，针对不同的用途来创建特定类型的background process。</p> \n<p>ReverseNotification.Package作为打包工程，我们需要注意添加对FrontUWP和Desktop的引用。以及编辑Package.appxmanifest文件，提供对AppService和Desktop Extension的支持。</p> \n<div class=\"cnblogs_code\"> \n <pre>    <span style=\"color: rgba(0, 0, 255, 1)\">&lt;</span><span style=\"color: rgba(128, 0, 0, 1)\">Application </span><span style=\"color: rgba(255, 0, 0, 1)\">Id</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"App\"</span><span style=\"color: rgba(255, 0, 0, 1)\">\n      Executable</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"$targetnametoken$.exe\"</span><span style=\"color: rgba(255, 0, 0, 1)\">\n      EntryPoint</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"$targetentrypoint$\"</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>\n      <span style=\"color: rgba(0, 0, 255, 1)\">&lt;</span><span style=\"color: rgba(128, 0, 0, 1)\">uap:VisualElements\n        </span><span style=\"color: rgba(255, 0, 0, 1)\">DisplayName</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"ReverseNotification.Package\"</span><span style=\"color: rgba(255, 0, 0, 1)\">\n        Description</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"ReverseNotification.Package\"</span><span style=\"color: rgba(255, 0, 0, 1)\">\n        BackgroundColor</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"transparent\"</span><span style=\"color: rgba(255, 0, 0, 1)\">\n        Square150x150Logo</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"Images\\Square150x150Logo.png\"</span><span style=\"color: rgba(255, 0, 0, 1)\">\n        Square44x44Logo</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"Images\\Square44x44Logo.png\"</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>\n        <span style=\"color: rgba(0, 0, 255, 1)\">&lt;</span><span style=\"color: rgba(128, 0, 0, 1)\">uap:DefaultTile </span><span style=\"color: rgba(255, 0, 0, 1)\">Wide310x150Logo</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"Images\\Wide310x150Logo.png\"</span> <span style=\"color: rgba(0, 0, 255, 1)\">/&gt;</span>\n        <span style=\"color: rgba(0, 0, 255, 1)\">&lt;</span><span style=\"color: rgba(128, 0, 0, 1)\">uap:SplashScreen </span><span style=\"color: rgba(255, 0, 0, 1)\">Image</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"Images\\SplashScreen.png\"</span> <span style=\"color: rgba(0, 0, 255, 1)\">/&gt;</span>\n      <span style=\"color: rgba(0, 0, 255, 1)\">&lt;/</span><span style=\"color: rgba(128, 0, 0, 1)\">uap:VisualElements</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>\n      <span style=\"color: rgba(0, 0, 255, 1)\">&lt;</span><span style=\"color: rgba(128, 0, 0, 1)\">Extensions</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>\n        <span style=\"color: rgba(0, 0, 255, 1)\">&lt;</span><span style=\"color: rgba(128, 0, 0, 1)\">uap:Extension </span><span style=\"color: rgba(255, 0, 0, 1)\">Category</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"windows.appService\"</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>\n          <span style=\"color: rgba(0, 0, 255, 1)\">&lt;</span><span style=\"color: rgba(128, 0, 0, 1)\">uap:AppService </span><span style=\"color: rgba(255, 0, 0, 1)\">Name</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"ReverseNotificationAppService\"</span> <span style=\"color: rgba(0, 0, 255, 1)\">/&gt;</span>\n        <span style=\"color: rgba(0, 0, 255, 1)\">&lt;/</span><span style=\"color: rgba(128, 0, 0, 1)\">uap:Extension</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>\n        <span style=\"color: rgba(0, 0, 255, 1)\">&lt;</span><span style=\"color: rgba(128, 0, 0, 1)\">desktop:Extension </span><span style=\"color: rgba(255, 0, 0, 1)\">Category</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"windows.fullTrustProcess\"</span><span style=\"color: rgba(255, 0, 0, 1)\"> Executable</span><span style=\"color: rgba(0, 0, 255, 1)\">=\"ReverseNotification.Desktop\\ReverseNotification.Desktop.exe\"</span><span style=\"color: rgba(0, 0, 255, 1)\">/&gt;</span>\n      <span style=\"color: rgba(0, 0, 255, 1)\">&lt;/</span><span style=\"color: rgba(128, 0, 0, 1)\">Extensions</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span>\n    <span style=\"color: rgba(0, 0, 255, 1)\">&lt;/</span><span style=\"color: rgba(128, 0, 0, 1)\">Application</span><span style=\"color: rgba(0, 0, 255, 1)\">&gt;</span></pre> \n</div> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/1e5fe033-498a-41f6-9cb0-14eb9edd3ac4.png\" alt=\"\" width=\"550\" height=\"242\" loading=\"lazy\"></p> \n<p>至此对Desktop Extension的一系列讨论告一段落。牵涉的内容较多，很难在一篇文章中解释清楚，我将之前的链接罗列在下方，供各位参考：<br>《<a href=\"https://www.cnblogs.com/manupstairs/p/11121697.html\" target=\"_blank\">迁移桌面程序到MS Store（9）——APPX With Desktop Extension</a>》对Desktop Extension做了基础介绍。<br>《<a href=\"https://www.cnblogs.com/manupstairs/p/13853418.html\" target=\"_blank\">2020年的UWP(2)——In Process App Service</a>》详细介绍了如何使用AppService。<br>《<a href=\"https://www.cnblogs.com/manupstairs/p/13956235.html\" target=\"_blank\">2020年的UWP(3)——UWP和desktop extension的简单交互</a>》介绍了单向的一次性使用场景。<br>《<a href=\"https://www.cnblogs.com/manupstairs/p/14065673.html\" target=\"_blank\">2020年的UWP(4)——UWP和等待Request的Desktop Extension</a>》background process会有一个较短的生命周期，等待Reqeust执行完成后退出。<br>《<a href=\"https://www.cnblogs.com/manupstairs/p/14178931.html\" target=\"_blank\">2020年的UWP(5)——UWP和Desktop Extension的双向交互</a>》通常用在同时展现UWP和WPF界面时使用。<br>Github：<br><a href=\"https://github.com/manupstairs/UWPSamples/tree/master/UWPSamples/DataExchangeUWP/ReverseNotification\" target=\"_blank\">https://github.com/manupstairs/UWPSamples/tree/master/UWPSamples/DataExchangeUWP/ReverseNotification</a></p> \n<p>&nbsp;</p>', NULL, '2021-03-27 00:18:31', 0, NULL, NULL, 'https://www.cnblogs.com/manupstairs/p/14582794.html', 0, NULL);
INSERT INTO `t_blog` VALUES (296, 'cadence Virtuoso ADE原理图AnalogLib库中的switch使用', '<h3 id=\"symbol-switch\">Symbol: switch</h3> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/629b7e37-3220-4543-9c36-3374f48cf7f8.png\" alt=\"switch_symbol\" loading=\"lazy\"></p> \n<p>A,B:等效于一个电阻;<br> C,D:等效于控制开关(CD间的控制电压控制AB的断开或闭合);<br> open switch resistance:开关断开状态下的等效电阻(AB之间);<br> close switch resistance:开关闭合状态下的等效电阻(AB之间);<br> open voltage:断开开关所需的电压值(CD间电压低于该值，则AB间处于断开状态);<br> closed voltage:闭合开关所需的电压值(CD间电压高于该值，则AB间处于闭合状态);</p> \n<ul> \n <li>有W标记的是正端，正负端不要接错</li> \n <li>open voltage 和 closed voltage设置的值不能相同<br> （Relay on and off thresholds (\'vt2\' and \'vt1\') must not be the same value</li> \n <li>一般设置open voltage 小于 closed voltage的值</li> \n</ul> \n<p><strong>使用spectre对switch的进行仿真，下图为设置的仿真原理图。</strong></p> \n<p>open voltage: 0.5V<br> closed voltage: 0.6V<br> open switch resistance: 1T Ohms<br> close switch resistance: 1 Ohms</p> \n<p>VDD:1.2 V<br> VSS: 0 V<br> C,D间的控制电压:Vctrl</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/ad253185-4527-4aca-9742-9bdcea7abd88.png\" alt=\"switch_仿真原理图.png\" loading=\"lazy\"></p> \n<p>仿真波形如下图，当V<sub>ctrl</sub>大于0.6V，开关switch导通，即A点与VSS相连，所以V<sub>A</sub>=0。<br> 当V<sub>ctrl</sub>小于0.5V，开关switch断开，即A点浮空，所以V<sub>A</sub>=VDD。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/74f88df9-7b8c-4361-a4a5-80279d78396b.png\" alt=\"switch_仿真波形图\" loading=\"lazy\"></p> \n<hr> \n<hr> \n<p>如果设置switch的参数为open voltage 大于 closed voltage（open voltage: 0.6V ; closed voltage: 0.5V），即V<sub>ctrl</sub>大于0.5V，开关switch导通（闭合）；V<sub>ctrl</sub>小于0.6V，开关switch断开。再次对电路进行仿真，仿真波形图如下图。</p> \n<p><img src=\"http://localhost:9090/blogImages/2021/03/27/c9336401-6020-4c32-8361-9ccd4ecf82c7.png\" alt=\"switch_仿真波形图2\" loading=\"lazy\"></p> \n<p>因为V<sub>ctrl</sub>大于0.5V，开关switch导通（闭合）；V<sub>ctrl</sub>小于0.6V，开关switch断开。如果<span class=\"math inline\">\\(0.5\\lt V_{ctrl}\\lt 0.6\\)</span>，开关是断开还是闭合？这样设置参数，会产生矛盾，导致上图波形输出有误，具体什么原因可以一起探讨交流。</p> \n<p>欢迎评论交流，一起进步！</p>', NULL, '2021-03-27 00:18:32', 0, NULL, NULL, 'https://www.cnblogs.com/icDesigner/p/14582490.html', 0, NULL);

-- ----------------------------
-- Table structure for t_blog_type
-- ----------------------------
DROP TABLE IF EXISTS `t_blog_type`;
CREATE TABLE `t_blog_type`  (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `type_name` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT '类型名称',
  `order_no` int(11) DEFAULT NULL COMMENT '排序',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 8 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- Records of t_blog_type
-- ----------------------------
INSERT INTO `t_blog_type` VALUES (1, 'Java', 1);
INSERT INTO `t_blog_type` VALUES (3, 'Web', 3);
INSERT INTO `t_blog_type` VALUES (4, 'Python', 2);
INSERT INTO `t_blog_type` VALUES (5, 'Android', 4);
INSERT INTO `t_blog_type` VALUES (6, 'BigData', 5);
INSERT INTO `t_blog_type` VALUES (7, '算法', 6);

-- ----------------------------
-- Table structure for t_link
-- ----------------------------
DROP TABLE IF EXISTS `t_link`;
CREATE TABLE `t_link`  (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `name` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT '超链接名称',
  `url` varchar(200) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT '超链接URL',
  `order_no` int(11) DEFAULT NULL COMMENT '超链接排序',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 9 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- Records of t_link
-- ----------------------------
INSERT INTO `t_link` VALUES (1, '178魔兽', 'http://wow.178.com', 2);
INSERT INTO `t_link` VALUES (3, 'layui', 'https://www.layui.com', 3);
INSERT INTO `t_link` VALUES (4, '博客园', 'https://www.cnblogs.com', 4);
INSERT INTO `t_link` VALUES (8, 'csdn', 'https://www.csdn.net/', 1);

-- ----------------------------
-- Table structure for t_user
-- ----------------------------
DROP TABLE IF EXISTS `t_user`;
CREATE TABLE `t_user`  (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `user_name` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT '用户名',
  `password` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT '密码',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 2 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- Records of t_user
-- ----------------------------
INSERT INTO `t_user` VALUES (1, 'admin', 'e5d70dfe6c888820227164d2841776b0');

SET FOREIGN_KEY_CHECKS = 1;
